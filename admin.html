<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>관리자 대시보드 - Own a Piece of Earth</title>
    <meta name="robots" content="noindex, nofollow">
    
    <!-- Favicon -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>⚙️</text></svg>">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet">
    
    <!-- Admin CSS -->
    <link rel="stylesheet" href="css/variables.css">
    <link rel="stylesheet" href="css/admin.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
</head>
<body>
    <div id="admin-app">
        <!-- 로그인 화면 -->
        <div id="login-screen" class="login-screen">
            <div class="login-card">
                <div class="login-header">
                    <h1>🔐 관리자 로그인</h1>
                    <p>Own a Piece of Earth 관리 센터</p>
                </div>
                <form id="admin-login-form">
                    <div class="form-group">
                        <label>이메일</label>
                        <input type="email" id="admin-email" required placeholder="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label>비밀번호</label>
                        <input type="password" id="admin-password" required placeholder="••••••••">
                    </div>
                    <button type="submit" class="btn btn-primary btn-full">
                        로그인
                    </button>
                    <div id="login-error" class="error-message hidden"></div>
                </form>
                <div class="login-footer">
                    <a href="index.html">← 지도로 돌아가기</a>
                </div>
            </div>
        </div>
        
        <!-- 관리자 대시보드 -->
        <div id="admin-dashboard" class="admin-dashboard hidden">
            <!-- 사이드바 -->
            <aside class="admin-sidebar">
                <div class="sidebar-header">
                    <h2>⚙️ 관리자</h2>
                    <span class="admin-badge">v2.0</span>
                </div>
                
                <nav class="sidebar-nav">
                    <button class="nav-item active" data-section="overview">
                        📊 대시보드
                    </button>
                    <button class="nav-item" data-section="users">
                        👥 사용자 관리
                    </button>
                    <button class="nav-item" data-section="territories">
                        🗺️ 영토 관리
                    </button>
                    <button class="nav-item" data-section="auctions">
                        💰 옥션 관리
                    </button>
                    <button class="nav-item" data-section="analytics">
                        📈 분석
                    </button>
                    <button class="nav-item" data-section="logs">
                        📝 로그
                    </button>
                    <button class="nav-item" data-section="settings">
                        ⚙️ 설정
                    </button>
                </nav>
                
                <div class="sidebar-footer">
                    <button id="user-mode-btn" class="btn btn-secondary btn-full">
                        🎭 사용자 모드
                    </button>
                    <button id="admin-logout-btn" class="btn btn-outline btn-full">
                        🚪 로그아웃
                    </button>
                </div>
            </aside>
            
            <!-- 메인 콘텐츠 -->
            <main class="admin-main">
                <header class="admin-header">
                    <div class="header-left">
                        <h1 id="section-title">대시보드</h1>
                        <span class="last-updated">마지막 업데이트: <span id="last-update-time">--</span></span>
                    </div>
                    <div class="header-right">
                        <button id="refresh-btn" class="btn btn-icon" title="새로고침">
                            🔄
                        </button>
                        <div class="admin-user">
                            <span id="admin-name">관리자</span>
                            <span class="admin-role">최고 관리자</span>
                        </div>
                    </div>
                </header>
                
                <div class="admin-content">
                    <!-- 대시보드 섹션 -->
                    <section id="section-overview" class="admin-section active">
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">👥</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-users">--</span>
                                    <span class="stat-label">총 사용자</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">🗺️</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-territories">--</span>
                                    <span class="stat-label">점유된 영토</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">💰</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-revenue">--</span>
                                    <span class="stat-label">총 수익</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">⚡</div>
                                <div class="stat-info">
                                    <span class="stat-value" id="stat-active">--</span>
                                    <span class="stat-label">진행 중인 옥션</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="dashboard-grid">
                            <div class="dashboard-card">
                                <h3>📈 최근 활동</h3>
                                <div id="recent-activity" class="activity-list">
                                    <div class="loading">로딩 중...</div>
                                </div>
                            </div>
                            <div class="dashboard-card">
                                <h3>🏆 상위 사용자</h3>
                                <div id="top-users" class="user-list">
                                    <div class="loading">로딩 중...</div>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- 사용자 관리 섹션 -->
                    <section id="section-users" class="admin-section">
                        <div class="section-header">
                            <div class="search-box">
                                <input type="text" id="user-search" placeholder="사용자 검색...">
                            </div>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">전체</button>
                                <button class="filter-btn" data-filter="active">활성</button>
                                <button class="filter-btn" data-filter="banned">차단됨</button>
                            </div>
                        </div>
                        <div class="data-table-wrapper">
                            <table class="data-table" id="users-table">
                                <thead>
                                    <tr>
                                        <th>사용자</th>
                                        <th>이메일</th>
                                        <th>영토 수</th>
                                        <th>가입일</th>
                                        <th>상태</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="loading">로딩 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    
                    <!-- 영토 관리 섹션 -->
                    <section id="section-territories" class="admin-section">
                        <div class="section-header">
                            <div class="section-description" style="margin-bottom: 15px; padding: 12px; background: #f5f5f5; border-radius: 6px; color: #666; font-size: 14px;">
                                <strong>📋 영토 관리 기능:</strong>
                                <ul style="margin: 8px 0 0 20px; padding: 0;">
                                    <li>점유된 영토(sovereignty가 'ruled' 또는 'protected') 목록을 확인할 수 있습니다</li>
                                    <li>각 영토의 소유자, 가격, 픽셀 수를 확인할 수 있습니다</li>
                                    <li>영토 정보를 보거나 가격을 수정할 수 있습니다</li>
                                    <li>보기: 영토 상세 정보 확인</li>
                                    <li>수정: 영토 가격 수정</li>
                                    <li>오너 삭제: 영토 소유자를 삭제하고 구역을 초기화</li>
                                    <li>오너 설정: 영토의 소유자를 직접 지정</li>
                                </ul>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-bottom: 15px;">
                                <div class="search-box">
                                    <input type="text" id="territory-search" placeholder="영토 검색...">
                                </div>
                                <select id="country-filter">
                                    <option value="">전체 국가</option>
                                </select>
                                <button class="btn btn-danger" onclick="adminDashboard.showResetAllTerritoriesModal()" style="margin-left: auto;">
                                    🔄 모든 영토 초기화
                                </button>
                            </div>
                        </div>
                        <div class="data-table-wrapper">
                            <table class="data-table" id="territories-table">
                                <thead>
                                    <tr>
                                        <th>영토명</th>
                                        <th>국가</th>
                                        <th>소유자</th>
                                        <th>가격</th>
                                        <th>픽셀</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="6" class="loading">로딩 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    
                    <!-- 옥션 관리 섹션 -->
                    <section id="section-auctions" class="admin-section">
                        <div class="section-header">
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="active">진행 중</button>
                                <button class="filter-btn" data-filter="ended">종료됨</button>
                                <button class="filter-btn" data-filter="all">전체</button>
                            </div>
                            <button class="btn btn-primary" onclick="adminDashboard.processAllEndedAuctions()" style="margin-left: 10px;">
                                🔄 종료된 옥션 소유권 일괄 처리
                            </button>
                        </div>
                        <div class="data-table-wrapper">
                            <table class="data-table" id="auctions-table">
                                <thead>
                                    <tr>
                                        <th>영토</th>
                                        <th>상태</th>
                                        <th>시작가</th>
                                        <th>현재 입찰가</th>
                                        <th>입찰자</th>
                                        <th>종료 시간</th>
                                        <th>생성 시간</th>
                                        <th>작업</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr><td colspan="8" class="loading">로딩 중...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </section>
                    
                    <!-- 분석 섹션 -->
                    <section id="section-analytics" class="admin-section">
                        <div class="info-box" style="padding: 20px; background: #f0f7ff; border-left: 4px solid #0066cc; border-radius: 8px; margin-bottom: 20px;">
                            <h3 style="margin-top: 0; color: #0066cc;">📈 분석 기능</h3>
                            <p><strong>기능 설명:</strong></p>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>수익 추이:</strong> 시간별 수익 변화를 차트로 확인할 수 있습니다 (포인트 충전, 경매 수수료 등)</li>
                                <li><strong>영토 분포:</strong> 국가별, 상태별 영토 분포를 맵 차트로 확인할 수 있습니다</li>
                                <li><strong>사용자 성장:</strong> 일별/주별 신규 가입자 수와 활성 사용자 수를 확인할 수 있습니다</li>
                                <li><strong>옥션 통계:</strong> 경매 성공률, 평균 입찰가, 총 거래액 등을 확인할 수 있습니다</li>
                            </ul>
                            <p style="margin-top: 15px; color: #666;">
                                <strong>현재 상태:</strong> 실시간 차트 및 그래프가 표시됩니다.
                            </p>
                        </div>
                        <div class="analytics-grid">
                            <div class="analytics-card">
                                <h3>📊 수익 추이</h3>
                                <div class="chart-placeholder">
                                    <p>대시보드의 "수익" 통계 카드를 참고하세요.</p>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <h3>🌍 영토 분포</h3>
                                <div class="chart-placeholder">
                                    <p>대시보드의 "영토" 통계 카드를 참고하세요.</p>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <h3>👥 사용자 성장</h3>
                                <div class="chart-placeholder">
                                    <p>대시보드의 "사용자" 통계 카드를 참고하세요.</p>
                                </div>
                            </div>
                            <div class="analytics-card">
                                <h3>💰 옥션 통계</h3>
                                <div class="chart-placeholder">
                                    <p>대시보드의 "옥션" 통계 카드를 참고하세요.</p>
                                </div>
                            </div>
                        </div>
                    </section>
                    
                    <!-- 로그 섹션 -->
                    <section id="section-logs" class="admin-section">
                        <div class="section-header">
                            <h3>📝 관리자 활동 로그</h3>
                            <div class="filter-buttons">
                                <button class="filter-btn active" data-filter="all">전체</button>
                                <button class="filter-btn" data-filter="user">사용자</button>
                                <button class="filter-btn" data-filter="territory">영토</button>
                                <button class="filter-btn" data-filter="auction">옥션</button>
                            </div>
                        </div>
                        <div id="admin-logs" class="logs-container">
                            <div class="loading">로그 로딩 중...</div>
                        </div>
                    </section>
                    
                    <!-- 설정 섹션 -->
                    <section id="section-settings" class="admin-section">
                        <div class="settings-grid">
                            <div class="settings-card">
                                <h3>⚙️ 일반 설정</h3>
                                <div class="settings-form">
                                    <div class="form-group">
                                        <label>사이트명</label>
                                        <input type="text" value="Own a Piece of Earth" id="setting-site-name">
                                    </div>
                                    <div class="form-group">
                                        <label>기본 통화</label>
                                        <select id="setting-currency">
                                            <option value="USD">USD ($)</option>
                                            <option value="EUR">EUR (€)</option>
                                            <option value="KRW">KRW (₩)</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label>최소 입찰 증가율 (%)</label>
                                        <input type="number" value="5" id="setting-bid-increment">
                                    </div>
                                    <button class="btn btn-primary">설정 저장</button>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>🔐 관리자 계정</h3>
                                <div style="background: #f0f7ff; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #0066cc;">
                                    <p style="margin: 0 0 10px 0; color: #0066cc; font-weight: 600; font-size: 14px;">📋 관리자 계정 안내</p>
                                    <ul style="margin: 0; padding-left: 20px; color: #333; font-size: 13px; line-height: 1.8;">
                                        <li><strong>관리자 계정</strong>은 관리자 대시보드에 접근할 수 있는 계정입니다</li>
                                        <li><strong>최고 관리자</strong>는 모든 권한을 가진 최상위 관리자입니다</li>
                                        <li>관리자 추가/삭제는 <strong>코드 수정</strong>이 필요하며, 서버 재시작 후 적용됩니다</li>
                                        <li>현재 <strong id="admin-count">4</strong>개의 관리자 계정이 등록되어 있습니다</li>
                                    </ul>
                                </div>
                                <div id="admin-list" class="admin-list">
                                    <div class="loading">관리자 목록 로딩 중...</div>
                                </div>
                                <div style="display: flex; gap: 10px; margin-top: 15px;">
                                    <button class="btn btn-secondary" onclick="adminDashboard.showAddAdminModal()">➕ 관리자 추가</button>
                                    <button class="btn btn-outline" onclick="adminDashboard.showRemoveAdminModal()" style="display: none;">➖ 관리자 삭제</button>
                                </div>
                            </div>
                            
                            <div class="settings-card">
                                <h3>💾 데이터 관리</h3>
                                <p class="card-description">Firestore 데이터 백업 및 복원</p>
                                <div class="data-actions">
                                    <button id="backup-btn" class="btn btn-secondary" onclick="adminDashboard.backupData()">
                                        📥 데이터 백업
                                    </button>
                                    <button id="restore-btn" class="btn btn-secondary" onclick="adminDashboard.restoreData()">
                                        📤 데이터 복원
                                    </button>
                                    <button class="btn btn-danger">🗑️ 캐시 삭제</button>
                                </div>
                                <p class="data-warning">⚠️ 복원 시 기존 데이터가 덮어쓰기 됩니다. 주의하세요.</p>
                            </div>
                        </div>
                    </section>
                </div>
            </main>
        </div>
        
        <!-- 사용자 모드 배너 -->
        <div id="user-mode-banner" class="user-mode-banner hidden">
            <span>🎭 일반 사용자로 보는 중</span>
            <button id="exit-user-mode" class="btn btn-sm">사용자 모드 종료</button>
        </div>
    </div>
    
    <!-- Firebase SDK (compat 버전) - 전문가 조언: 정적 script 태그로 로드하여 CORS 문제 방지 -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script>
        // Firebase SDK가 로드되었는지 확인하고 전역 객체에 저장
        (function() {
            if (typeof firebase !== 'undefined' && firebase.apps && firebase.apps.length === 0) {
                // Firebase compat 버전이 로드됨
                window.firebaseCompat = firebase;
                console.log('[Firebase] SDK loaded successfully (compat version)');
            } else if (typeof firebase !== 'undefined') {
                // 이미 초기화된 경우
                window.firebaseCompat = firebase;
                console.log('[Firebase] SDK already loaded (compat version)');
            } else {
                console.warn('[Firebase] SDK load failed - firebase object not found');
                window.firebaseCompat = null;
                window.firebaseModulesLoadFailed = true;
            }
        })();
    </script>
    
    <!-- Admin Module -->
    <script type="module" src="js/admin.js"></script>
</body>
</html>

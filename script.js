// Mr.Young's Billionaire Homepage - Interactive World Map
class BillionaireMap {
    constructor() {
        this.map = null;
        this.currentRegion = null;
        this.regionData = new Map();
        this.uniformAdPrice = 1000;
        this.advertisingData = new Map();
        this.logoData = {}; // ê°„ë‹¨í•œ ê°ì²´ë¡œ ë³€ê²½
        this.colorData = {}; // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        this.companyData = {}; // ê¸°ì—… ì •ë³´ ë°ì´í„° ì €ì¥
        this.koreaLogoData = {}; // í•œêµ­ ë¡œê³  ë°ì´í„°
        this.koreaColorData = {}; // í•œêµ­ ìƒ‰ìƒ ë°ì´í„°
        this.koreaCompanyData = {}; // í•œêµ­ ê¸°ì—… ì •ë³´ ë°ì´í„°
        this.japanLogoData = {}; // ì¼ë³¸ ë¡œê³  ë°ì´í„°
        this.japanColorData = {}; // ì¼ë³¸ ìƒ‰ìƒ ë°ì´í„°
        this.japanCompanyData = {}; // ì¼ë³¸ ê¸°ì—… ì •ë³´ ë°ì´í„°
        this.currentMapMode = 'usa'; // í˜„ì¬ ì§€ë„ ëª¨ë“œ (ëª¨ë“  êµ­ê°€ í¬í•¨)
        this.adminMode = false;
        // Firebase ê´€ë ¨ ë³€ìˆ˜
        this.firebaseApp = null;
        this.firebaseAuth = null;
        this.firestore = null;
        this.currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
        this.isFirebaseInitialized = false;
        // ì„±ëŠ¥ ìµœì í™”: ë°ì´í„° ìºì‹±
        this.cachedGeoJsonData = {
            'usa': null,
            'korea': null,
            'japan': null,
            'china': null,
            'russia': null,
            'india': null,
            'canada': null,
            'germany': null,
            'uk': null,
            'france': null,
            'italy': null,
            'brazil': null,
            'australia': null,
            'mexico': null,
            'indonesia': null,
            'saudi-arabia': null,
            'turkey': null,
            'south-africa': null,
            'argentina': null,
            'european-union': null,
            'spain': null,
            'netherlands': null,
            'poland': null,
            'belgium': null,
            'sweden': null,
            'austria': null,
            'denmark': null,
            'finland': null,
            'ireland': null,
            'portugal': null,
            'greece': null,
            'czech-republic': null,
            'romania': null,
            'hungary': null,
            'bulgaria': null
        };
        this.rawGeoJsonCache = {};
        this.assetBaseUrl = this.resolveAssetBaseUrl();
        console.log('[BillionaireMap] assetBaseUrl ì´ˆê¸°í™”:', this.assetBaseUrl);
        this.eventListenersAdded = false; // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
        this.currentHoverRegionId = null; // í˜„ì¬ hoverëœ ì§€ì—­ ID ì¶”ì 
        this.isAdminLoggedIn = false; // ê´€ë¦¬ì ë¡œê·¸ì¸ ìƒíƒœ
        this.ADMIN_SESSION_KEY = 'worldad.adminSession';
        this.hasSessionSync = false;
        this.sessionResumeInFlight = false;
        this.selectedStateId = null; // í˜„ì¬ ì„ íƒëœ ì£¼ ID
        this.uiVisible = false; // UI ìš”ì†Œ í‘œì‹œ ìƒíƒœ
        this.tourResizeHandler = null; // ì˜¨ë³´ë”© íˆ¬ì–´ ë¦¬ì‚¬ì´ì¦ˆ í•¸ë“¤ëŸ¬
        
        // ë³´ì•ˆ: Rate Limiting
        this.loginAttempts = new Map(); // ì‚¬ìš©ìë³„ ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜
        this.maxLoginAttempts = 5; // ìµœëŒ€ ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜
        this.loginLockoutTime = 15 * 60 * 1000; // 15ë¶„ ì ê¸ˆ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
        
        // DOMPurify ì´ˆê¸°í™” í™•ì¸
        this.DOMPurify = window.DOMPurify || null;
        if (!this.DOMPurify) {
            console.warn('[ë³´ì•ˆ] DOMPurifyê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. XSS ë°©ì–´ê°€ ì•½í™”ë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
        }
        this.pKeyCount = 0; // Pí‚¤ ì—°íƒ€ ì¹´ìš´íŠ¸
        this.pKeyTimer = null; // Pí‚¤ íƒ€ì´ë¨¸
        this.isGlobeMode = false; // 3D ì§€êµ¬ë³¸ ëª¨ë“œ ìƒíƒœ (initializeMapì—ì„œ ì´ˆê¸°í™”)
        this.modeDropdown = null; // ì§€ë„ ëª¨ë“œ ì„ íƒ ë“œë¡­ë‹¤ìš´ ì°¸ì¡°
        this.globeRotationInterval = null; // ì§€êµ¬ë³¸ ìë™ íšŒì „ ì¸í„°ë²Œ
        this.cloudRotation = 0; // êµ¬ë¦„ íšŒì „ ê°ë„
        this.cloudImage = null; // êµ¬ë¦„ ì´ë¯¸ì§€
        this.cloudAnimationId = null; // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ID
        this.dynamicColorSetup = false; // ë™ì  ìƒ‰ìƒ ì¡°ì • ì„¤ì • ì—¬ë¶€
        this.southAfricaProvinceMapping = null; // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ì£¼-ì§€êµ¬ ë§¤í•‘
        this.argentinaProvinceMapping = null; // ì•„ë¥´í—¨í‹°ë‚˜ ì£¼ ë§¤í•‘
        this.spainAutonomousCommunityMapping = null; // ìŠ¤í˜ì¸ ìì¹˜ì§€ì—­-ì£¼ ë§¤í•‘
        this.countryConfigByKey = {};
        this.countryLookup = new Map();
        this.regionDataLoadState = new Map(); // Firestore ë¡œë“œ ìƒíƒœ ìºì‹œ
        
        // IndexedDB ìºì‹œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        this.cacheDB = null;
        this.cacheDBName = 'worldMapCache';
        this.cacheDBVersion = 1;
        this.cacheExpiryDays = 7; // ìºì‹œ ìœ íš¨ê¸°ê°„ (7ì¼)
        
        this.pixelBrandGuides = this.buildPixelBrandGuides();
        this.pixelTemplates = this.buildPixelTemplates();
        this.pixelStickers = this.buildPixelStickers();
        if (typeof window !== 'undefined') {
            this.setupAdminSessionSync();
        }
        
        // Chart.js ì¸ìŠ¤í„´ìŠ¤ ì €ì¥
        this.bidHistogramChart = null;
        this.clickExposureChart = null;
        this.p2wMitigationChart = null;
        
        // ì˜¥ì…˜ ì‹œìŠ¤í…œ ê´€ë ¨ ë³€ìˆ˜
        this.activeAuctions = new Map(); // í™œì„± ì˜¥ì…˜ ìºì‹œ (regionId -> auctionData)
        this.auctionTimers = new Map(); // ì˜¥ì…˜ ì¹´ìš´íŠ¸ë‹¤ìš´ íƒ€ì´ë¨¸ (regionId -> timerId)
        this.auctionListeners = new Map(); // Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ (regionId -> unsubscribe)
        this.minBidIncrement = 0.1; // ìµœì†Œ ì…ì°° ì¦ê°€ì•¡ (USD)
        this.auctionExtensionMinutes = 2; // ë§ˆì§€ë§‰ 2ë¶„ ë‚´ ì…ì°° ì‹œ ì—°ì¥ ì‹œê°„ (anti-sniping)
        this.communityRewardRate = 0.1; // ê° ë‚™ì°° ê¸ˆì•¡ì˜ 10%ë¥¼ ì»¤ë®¤ë‹ˆí‹° ìƒê¸ˆìœ¼ë¡œ ì ë¦½
        this.freePixelConversionRate = 20; // $20ë‹¹ ë¬´ë£Œ í”½ì…€ 1ì„¸íŠ¸ ì ë¦½
        this.freePixelDropSize = 50; // ë¬´ë£Œ í”½ì…€ ë“œë ì‹œ ê¸°ë³¸ ë°°í¬ëŸ‰
        this.communityPoolData = {
            rewardFund: 0,
            totalAuctions: 0,
            freePixelPool: 0,
            lastDistributionAt: null,
            recentContribution: 0
        };
        this.communityPoolListener = null;
        
        // í”½ì…€ ì—ë””í„° ì´ˆê¸°í™”
        this.initPixelEditor();
        
        // Wplace ìŠ¤íƒ€ì¼ í”½ì…€ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ
        this.pixelGrids = new Map(); // regionId -> pixelGridData
        this.pixelGridListeners = new Map(); // regionId -> unsubscribe function
        this.pixelGridSource = null; // Mapbox source for pixel grids
        this.currentPixelColor = '#FF0000'; // í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ
        this.isPixelDrawing = false; // ë“œë˜ê·¸ë¡œ ì—¬ëŸ¬ í”½ì…€ ìƒ‰ì¹  ì¤‘ì¸ì§€
        this.selectedPixels = new Set(); // ë“œë˜ê·¸ ì¤‘ ì„ íƒëœ í”½ì…€ë“¤
        this.pixelUpdateBatch = []; // ë°°ì¹˜ ì €ì¥í•  í”½ì…€ ì—…ë°ì´íŠ¸
        this.pixelBatchTimer = null; // ë°°ì¹˜ íƒ€ì´ë¨¸
        this.pixelGridGridSize = 128; // ê¸°ë³¸ ê·¸ë¦¬ë“œ í¬ê¸° (128x128) - Wplace ìŠ¤íƒ€ì¼ ì‘ì€ ì •ì‚¬ê°í˜• í”½ì…€
        this.showPixelGridLines = false; // ê·¸ë¦¬ë“œ ì„  í‘œì‹œ ì—¬ë¶€
        this.isPixelEditMode = false; // í”½ì…€ í¸ì§‘ ëª¨ë“œ í™œì„±í™” ì—¬ë¶€
        this.PIXEL_PRICE_PER_UNIT = 0.1; // í”½ì…€ë‹¹ ê°€ê²© (USD) - ê²½ë§¤ ì‹œì‘ê°€ê²© ê³„ì‚°ìš©
        this.recentColors = JSON.parse(localStorage.getItem('pixelRecentColors') || '[]'); // ìµœê·¼ ì‚¬ìš©í•œ ìƒ‰ìƒ
        this.pixelHistory = []; // ì‹¤í–‰ ì·¨ì†Œ íˆìŠ¤í† ë¦¬
        this.pixelHistoryIndex = -1; // í˜„ì¬ íˆìŠ¤í† ë¦¬ ì¸ë±ìŠ¤
        this.maxHistorySize = 50; // ìµœëŒ€ íˆìŠ¤í† ë¦¬ í¬ê¸°
        
        // ê¸°ìˆ  ì¸í”„ë¼ ê°œì„ : ë°ì´í„° íŒŒì´í”„ë¼ì¸ ë° ì„±ëŠ¥ ìµœì í™”
        this.geoJsonPipeline = {
            cache: new Map(), // êµ­ê°€ë³„ GeoJSON ìºì‹œ
            loadingStates: new Map(), // ë¡œë”© ìƒíƒœ ì¶”ì 
            viewportCache: new Map(), // ë·°í¬íŠ¸ ê¸°ë°˜ ìºì‹œ
            streamingQueue: [], // ìŠ¤íŠ¸ë¦¬ë° í
            maxCacheSize: 50 * 1024 * 1024 // ìµœëŒ€ ìºì‹œ í¬ê¸° (50MB)
        };
        this.quadtree = null; // ì¿¼ë“œíŠ¸ë¦¬ ì¸ë±ìŠ¤
        this.viewportBounds = null; // í˜„ì¬ ë·°í¬íŠ¸ ê²½ê³„
        this.loadedTiles = new Set(); // ë¡œë“œëœ íƒ€ì¼ ì¶”ì 
        
        // ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ
        this.monitoring = {
            eventLog: [], // ì´ë²¤íŠ¸ ë¡œê·¸
            performanceMetrics: {
                loadTimes: [],
                renderTimes: [],
                queryTimes: []
            },
            anomalyDetection: {
                suspiciousBids: [],
                rapidBidPatterns: new Map()
            },
            maxLogSize: 1000 // ìµœëŒ€ ë¡œê·¸ í¬ê¸°
        };

        // ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ ìƒíƒœ
        this.userDashboardState = {
            loading: false,
            activeTab: 'active',
            entries: [],
            timeline: [],
            lastLoadedAt: null,
            error: null
        };
        
        // API ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •
        this.apiEndpoints = {
            ownership: '/api/ownership',
            auction: '/api/auction',
            region: '/api/region'
        };
        
        // ì»¤ë®¤ë‹ˆí‹° & ìš´ì˜ ì‹œìŠ¤í…œ
        this.community = {
            reports: new Map(), // ì‹ ê³  ë°ì´í„° ìºì‹œ
            moderators: new Set() // ëª¨ë”ë ˆì´í„° ëª©ë¡
        };
        
        // í¬ì¸íŠ¸ ì§€ê°‘ ìƒíƒœ
        this.walletState = this.createEmptyWalletState();
        this.walletListener = null;
        this.walletRefreshInFlight = false;
        
        // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²½ë§¤ ìë™í™” ì„¤ì •
        this.auctionPaymentGraceMs = 10 * 60 * 1000; // 10ë¶„
        this.auctionRunnerUpGraceMs = 10 * 60 * 1000; // 10ë¶„
        this.runnerUpMaxAttempts = 3;
        this.auctionCheckInterval = null; // ì£¼ê¸°ì  ì²´í¬ ì¸í„°ë²Œ
        this.auctionCheckIntervalMs = 60 * 1000; // 1ë¶„ë§ˆë‹¤ ì²´í¬
        
        // G20 êµ­ê°€ ì„¤ì •
        this.g20Countries = {
            'usa': { name: 'United States', center: [-95, 35], zoom: 4, flag: 'ğŸ‡ºğŸ‡¸' },
            'china': { name: 'China', center: [104, 35], zoom: 4, flag: 'ğŸ‡¨ğŸ‡³' },
            'japan': { name: 'Japan', center: [139, 36], zoom: 6, flag: 'ğŸ‡¯ğŸ‡µ' },
            'germany': { name: 'Germany', center: [10, 51], zoom: 6, flag: 'ğŸ‡©ğŸ‡ª' },
            'india': { name: 'India', center: [77, 20], zoom: 4, flag: 'ğŸ‡®ğŸ‡³' },
            'uk': { name: 'United Kingdom', center: [-3, 54], zoom: 6, flag: 'ğŸ‡¬ğŸ‡§' },
            'france': { name: 'France', center: [2, 46], zoom: 6, flag: 'ğŸ‡«ğŸ‡·' },
            'italy': { name: 'Italy', center: [12, 42], zoom: 6, flag: 'ğŸ‡®ğŸ‡¹' },
            'brazil': { name: 'Brazil', center: [-55, -15], zoom: 4, flag: 'ğŸ‡§ğŸ‡·' },
            'canada': { name: 'Canada', center: [-106, 56], zoom: 4, flag: 'ğŸ‡¨ğŸ‡¦' },
            'russia': { name: 'Russia', center: [100, 60], zoom: 3, flag: 'ğŸ‡·ğŸ‡º' },
            'australia': { name: 'Australia', center: [133, -27], zoom: 4, flag: 'ğŸ‡¦ğŸ‡º' },
            'mexico': { name: 'Mexico', center: [-102, 23], zoom: 5, flag: 'ğŸ‡²ğŸ‡½' },
            'south-korea': { name: 'South Korea', center: [127, 36], zoom: 6, flag: 'ğŸ‡°ğŸ‡·' },
            'indonesia': { name: 'Indonesia', center: [113, -5], zoom: 5, flag: 'ğŸ‡®ğŸ‡©' },
            'saudi-arabia': { name: 'Saudi Arabia', center: [45, 24], zoom: 5, flag: 'ğŸ‡¸ğŸ‡¦' },
            'turkey': { name: 'Turkey', center: [35, 39], zoom: 5, flag: 'ğŸ‡¹ğŸ‡·' },
            'south-africa': { name: 'South Africa', center: [22, -30], zoom: 5, flag: 'ğŸ‡¿ğŸ‡¦' },
            'argentina': { name: 'Argentina', center: [-63, -38], zoom: 4, flag: 'ğŸ‡¦ğŸ‡·' },
            'european-union': { name: 'European Union', center: [10, 50], zoom: 4, flag: 'ğŸ‡ªğŸ‡º' },
            'spain': { name: 'Spain', center: [-3, 40], zoom: 5, flag: 'ğŸ‡ªğŸ‡¸' },
            'netherlands': { name: 'Netherlands', center: [5, 52], zoom: 6, flag: 'ğŸ‡³ğŸ‡±' },
            'poland': { name: 'Poland', center: [19, 52], zoom: 5, flag: 'ğŸ‡µğŸ‡±' },
            'belgium': { name: 'Belgium', center: [4.5, 50.5], zoom: 6, flag: 'ğŸ‡§ğŸ‡ª' },
            'sweden': { name: 'Sweden', center: [18, 60], zoom: 5, flag: 'ğŸ‡¸ğŸ‡ª' },
            'austria': { name: 'Austria', center: [13, 47.5], zoom: 6, flag: 'ğŸ‡¦ğŸ‡¹' },
            'denmark': { name: 'Denmark', center: [10, 56], zoom: 6, flag: 'ğŸ‡©ğŸ‡°' },
            'finland': { name: 'Finland', center: [26, 64], zoom: 5, flag: 'ğŸ‡«ğŸ‡®' },
            'ireland': { name: 'Ireland', center: [-8, 53], zoom: 6, flag: 'ğŸ‡®ğŸ‡ª' },
            'portugal': { name: 'Portugal', center: [-8, 39.5], zoom: 6, flag: 'ğŸ‡µğŸ‡¹' },
            'greece': { name: 'Greece', center: [23, 38], zoom: 6, flag: 'ğŸ‡¬ğŸ‡·' },
            'czech-republic': { name: 'Czech Republic', center: [15, 49.75], zoom: 6, flag: 'ğŸ‡¨ğŸ‡¿' },
            'romania': { name: 'Romania', center: [25, 46], zoom: 6, flag: 'ğŸ‡·ğŸ‡´' },
            'hungary': { name: 'Hungary', center: [19.5, 47.5], zoom: 6, flag: 'ğŸ‡­ğŸ‡º' },
            'bulgaria': { name: 'Bulgaria', center: [25, 43], zoom: 6, flag: 'ğŸ‡§ğŸ‡¬' }
        };

        this.initializeCountryConfig();
        
        // êµ­ê°€ë³„ ìƒ‰ìƒ ë§¤í•‘ (ê° ë‚˜ë¼ë§ˆë‹¤ ë‹¤ë¥¸ ìƒ‰ìƒ)
        this.countryColors = {
            'USA': '#4ecdc4',
            'South Korea': '#e74c3c',
            'Japan': '#ffd93d',
            'China': '#45b7d1',
            'Russia': '#6c5ce7',
            'India': '#ff9f43',
            'Canada': '#e74c3c',
            'Germany': '#5dade2',
            'United Kingdom': '#00d2d3',
            'France': '#feca57',
            'Italy': '#ff6348',
            'Brazil': '#10ac84',
            'Australia': '#ffa502',
            'Mexico': '#0652DD',
            'Indonesia': '#ee5a6f',
            'Saudi Arabia': '#f39c12',
            'Turkey': '#74b9ff',
            'South Africa': '#9b59b6',
            'Argentina': '#1abc9c',
            'European Union': '#34495e',
            'Spain': '#16a085',
            'Netherlands': '#3498db',
            'Poland': '#e67e22',
            'Belgium': '#f1c40f',
            'Sweden': '#c0392b',
            'Austria': '#d35400',
            'Denmark': '#7f8c8d',
            'Finland': '#27ae60',
            'Ireland': '#2980b9',
            'Portugal': '#8e44ad',
            'Greece': '#c0392b',
            'Czech Republic': '#d35400',
            'Romania': '#7f8c8d',
            'Hungary': '#27ae60',
            'Bulgaria': '#2980b9'
        };
        
        // G20 êµ­ê°€ë³„ ì–¸ì–´ ë§¤í•‘ (ì£¼ìš” ì–¸ì–´ + ì˜ì–´)
        this.countryLanguages = {
            'usa': { 
                primary: { 
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'china': {
                primary: {
                    'Region Information': 'åœ°åŒºä¿¡æ¯',
                    'Population': 'äººå£',
                    'Area': 'é¢ç§¯',
                    'Administrative Level': 'è¡Œæ”¿åŒºåˆ’',
                    'Advertising Price': 'å¹¿å‘Šä»·æ ¼',
                    'Status': 'çŠ¶æ€',
                    'Available': 'å¯ç”¨',
                    'Occupied': 'å·²å ç”¨',
                    'This region is available for advertisement registration.': 'æ­¤åœ°åŒºç›®å‰å¯ä»¥æ³¨å†Œå¹¿å‘Šã€‚',
                    'This region is currently occupied by an advertisement.': 'æ­¤åœ°åŒºç›®å‰å·²è¢«å¹¿å‘Šå ç”¨ã€‚',
                    'Purchase This Region': 'è´­ä¹°æ­¤åœ°åŒº',
                    'Company Information': 'ä¼ä¸šä¿¡æ¯',
                    'Industry': 'è¡Œä¸š',
                    'Founded': 'æˆç«‹å¹´ä»½',
                    'Employees': 'å‘˜å·¥æ•°',
                    'Website': 'ç½‘ç«™',
                    'Company Description': 'ä¼ä¸šä»‹ç»',
                    'Key Features': 'ä¸»è¦ç‰¹ç‚¹',
                    'Region': 'åœ°åŒº'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'japan': {
                primary: {
                    'Region Information': 'åœ°åŸŸæƒ…å ±',
                    'Population': 'äººå£',
                    'Area': 'é¢ç©',
                    'Administrative Level': 'è¡Œæ”¿åŒºç”»',
                    'Advertising Price': 'åºƒå‘Šä¾¡æ ¼',
                    'Status': 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
                    'Available': 'åˆ©ç”¨å¯èƒ½',
                    'Occupied': 'å æœ‰ä¸­',
                    'This region is available for advertisement registration.': 'ã“ã®åœ°åŸŸã¯ç¾åœ¨åºƒå‘Šç™»éŒ²ãŒå¯èƒ½ã§ã™ã€‚',
                    'This region is currently occupied by an advertisement.': 'ã“ã®åœ°åŸŸã¯ç¾åœ¨åºƒå‘Šã«å æœ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚',
                    'Purchase This Region': 'ã“ã®åœ°åŸŸã‚’è³¼å…¥',
                    'Company Information': 'ä¼æ¥­æƒ…å ±',
                    'Industry': 'æ¥­ç•Œ',
                    'Founded': 'è¨­ç«‹å¹´',
                    'Employees': 'å¾“æ¥­å“¡æ•°',
                    'Website': 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ',
                    'Company Description': 'ä¼æ¥­ç´¹ä»‹',
                    'Key Features': 'ä¸»ãªç‰¹å¾´',
                    'Region': 'åœ°åŸŸ'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'germany': {
                primary: {
                    'Region Information': 'Regionsinformationen',
                    'Population': 'BevÃ¶lkerung',
                    'Area': 'FlÃ¤che',
                    'Administrative Level': 'Verwaltungsebene',
                    'Advertising Price': 'Werbekosten',
                    'Status': 'Status',
                    'Available': 'VerfÃ¼gbar',
                    'Occupied': 'Besetzt',
                    'This region is available for advertisement registration.': 'Diese Region ist fÃ¼r Werbeanmeldungen verfÃ¼gbar.',
                    'This region is currently occupied by an advertisement.': 'Diese Region ist derzeit von einer Werbung belegt.',
                    'Purchase This Region': 'Diese Region kaufen',
                    'Company Information': 'Unternehmensinformationen',
                    'Industry': 'Branche',
                    'Founded': 'GegrÃ¼ndet',
                    'Employees': 'Mitarbeiter',
                    'Website': 'Website',
                    'Company Description': 'Unternehmensbeschreibung',
                    'Key Features': 'Hauptmerkmale',
                    'Region': 'Region'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'india': {
                primary: {
                    'Region Information': 'à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',
                    'Population': 'à¤œà¤¨à¤¸à¤‚à¤–à¥à¤¯à¤¾',
                    'Area': 'à¤•à¥à¤·à¥‡à¤¤à¥à¤°à¤«à¤²',
                    'Administrative Level': 'à¤ªà¥à¤°à¤¶à¤¾à¤¸à¤¨à¤¿à¤• à¤¸à¥à¤¤à¤°',
                    'Advertising Price': 'à¤µà¤¿à¤œà¥à¤à¤¾à¤ªà¤¨ à¤®à¥‚à¤²à¥à¤¯',
                    'Status': 'à¤¸à¥à¤¥à¤¿à¤¤à¤¿',
                    'Available': 'à¤‰à¤ªà¤²à¤¬à¥à¤§',
                    'Occupied': 'à¤…à¤§à¤¿à¤•à¥ƒà¤¤',
                    'This region is available for advertisement registration.': 'à¤¯à¤¹ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤µà¤¿à¤œà¥à¤à¤¾à¤ªà¤¨ à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤•à¥‡ à¤²à¤¿à¤ à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¹à¥ˆà¥¤',
                    'This region is currently occupied by an advertisement.': 'à¤¯à¤¹ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤à¤• à¤µà¤¿à¤œà¥à¤à¤¾à¤ªà¤¨ à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤…à¤§à¤¿à¤•à¥ƒà¤¤ à¤¹à¥ˆà¥¤',
                    'Purchase This Region': 'à¤‡à¤¸ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤•à¥‹ à¤–à¤°à¥€à¤¦à¥‡à¤‚',
                    'Company Information': 'à¤•à¤‚à¤ªà¤¨à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',
                    'Industry': 'à¤‰à¤¦à¥à¤¯à¥‹à¤—',
                    'Founded': 'à¤¸à¥à¤¥à¤¾à¤ªà¤¨à¤¾ à¤µà¤°à¥à¤·',
                    'Employees': 'à¤•à¤°à¥à¤®à¤šà¤¾à¤°à¥€',
                    'Website': 'à¤µà¥‡à¤¬à¤¸à¤¾à¤‡à¤Ÿ',
                    'Company Description': 'à¤•à¤‚à¤ªà¤¨à¥€ à¤µà¤¿à¤µà¤°à¤£',
                    'Key Features': 'à¤®à¥à¤–à¥à¤¯ à¤µà¤¿à¤¶à¥‡à¤·à¤¤à¤¾à¤à¤‚',
                    'Region': 'à¤•à¥à¤·à¥‡à¤¤à¥à¤°'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'uk': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'france': {
                primary: {
                    'Region Information': 'Informations sur la rÃ©gion',
                    'Population': 'Population',
                    'Area': 'Superficie',
                    'Administrative Level': 'Niveau administratif',
                    'Advertising Price': 'Prix de la publicitÃ©',
                    'Status': 'Statut',
                    'Available': 'Disponible',
                    'Occupied': 'OccupÃ©',
                    'This region is available for advertisement registration.': 'Cette rÃ©gion est actuellement disponible pour l\'enregistrement de publicitÃ©s.',
                    'This region is currently occupied by an advertisement.': 'Cette rÃ©gion est actuellement occupÃ©e par une publicitÃ©.',
                    'Purchase This Region': 'Acheter cette rÃ©gion',
                    'Company Information': 'Informations sur l\'entreprise',
                    'Industry': 'Industrie',
                    'Founded': 'FondÃ©e',
                    'Employees': 'EmployÃ©s',
                    'Website': 'Site web',
                    'Company Description': 'Description de l\'entreprise',
                    'Key Features': 'CaractÃ©ristiques principales',
                    'Region': 'RÃ©gion'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'italy': {
                primary: {
                    'Region Information': 'Informazioni sulla regione',
                    'Population': 'Popolazione',
                    'Area': 'Area',
                    'Administrative Level': 'Livello amministrativo',
                    'Advertising Price': 'Prezzo pubblicitario',
                    'Status': 'Stato',
                    'Available': 'Disponibile',
                    'Occupied': 'Occupato',
                    'This region is available for advertisement registration.': 'Questa regione Ã¨ attualmente disponibile per la registrazione pubblicitaria.',
                    'This region is currently occupied by an advertisement.': 'Questa regione Ã¨ attualmente occupata da una pubblicitÃ .',
                    'Purchase This Region': 'Acquista questa regione',
                    'Company Information': 'Informazioni sull\'azienda',
                    'Industry': 'Settore',
                    'Founded': 'Fondata',
                    'Employees': 'Dipendenti',
                    'Website': 'Sito web',
                    'Company Description': 'Descrizione dell\'azienda',
                    'Key Features': 'Caratteristiche principali',
                    'Region': 'Regione'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'brazil': {
                primary: {
                    'Region Information': 'InformaÃ§Ãµes da regiÃ£o',
                    'Population': 'PopulaÃ§Ã£o',
                    'Area': 'Ãrea',
                    'Administrative Level': 'NÃ­vel administrativo',
                    'Advertising Price': 'PreÃ§o de publicidade',
                    'Status': 'Status',
                    'Available': 'DisponÃ­vel',
                    'Occupied': 'Ocupado',
                    'This region is available for advertisement registration.': 'Esta regiÃ£o estÃ¡ atualmente disponÃ­vel para registro de publicidade.',
                    'This region is currently occupied by an advertisement.': 'Esta regiÃ£o estÃ¡ atualmente ocupada por uma publicidade.',
                    'Purchase This Region': 'Comprar esta regiÃ£o',
                    'Company Information': 'InformaÃ§Ãµes da empresa',
                    'Industry': 'IndÃºstria',
                    'Founded': 'Fundada',
                    'Employees': 'FuncionÃ¡rios',
                    'Website': 'Site',
                    'Company Description': 'DescriÃ§Ã£o da empresa',
                    'Key Features': 'CaracterÃ­sticas principais',
                    'Region': 'RegiÃ£o'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'canada': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'russia': {
                primary: {
                    'Region Information': 'Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ğµ',
                    'Population': 'ĞĞ°ÑĞµĞ»ĞµĞ½Ğ¸Ğµ',
                    'Area': 'ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ',
                    'Administrative Level': 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ',
                    'Advertising Price': 'Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹',
                    'Status': 'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ',
                    'Available': 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾',
                    'Occupied': 'Ğ—Ğ°Ğ½ÑÑ‚Ğ¾',
                    'This region is available for advertisement registration.': 'Ğ­Ñ‚Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ² Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹.',
                    'This region is currently occupied by an advertisement.': 'Ğ­Ñ‚Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ² Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ğ½ÑÑ‚ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ¾Ğ¹.',
                    'Purchase This Region': 'ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½',
                    'Company Information': 'Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸',
                    'Industry': 'ĞÑ‚Ñ€Ğ°ÑĞ»ÑŒ',
                    'Founded': 'ĞÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ°',
                    'Employees': 'Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸',
                    'Website': 'Ğ’ĞµĞ±-ÑĞ°Ğ¹Ñ‚',
                    'Company Description': 'ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸',
                    'Key Features': 'ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸',
                    'Region': 'Ğ ĞµĞ³Ğ¸Ğ¾Ğ½'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'australia': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'mexico': {
                primary: {
                    'Region Information': 'InformaciÃ³n de la regiÃ³n',
                    'Population': 'PoblaciÃ³n',
                    'Area': 'Ãrea',
                    'Administrative Level': 'Nivel administrativo',
                    'Advertising Price': 'Precio de publicidad',
                    'Status': 'Estado',
                    'Available': 'Disponible',
                    'Occupied': 'Ocupado',
                    'This region is available for advertisement registration.': 'Esta regiÃ³n estÃ¡ disponible para el registro de publicidad.',
                    'This region is currently occupied by an advertisement.': 'Esta regiÃ³n estÃ¡ ocupada por una publicidad.',
                    'Purchase This Region': 'Comprar esta regiÃ³n',
                    'Company Information': 'InformaciÃ³n de la empresa',
                    'Industry': 'Industria',
                    'Founded': 'Fundada',
                    'Employees': 'Empleados',
                    'Website': 'Sitio web',
                    'Company Description': 'DescripciÃ³n de la empresa',
                    'Key Features': 'CaracterÃ­sticas principales',
                    'Region': 'RegiÃ³n'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'south-korea': {
                primary: {
                    'Region Information': 'ì§€ì—­ ì •ë³´',
                    'Population': 'ì¸êµ¬',
                    'Area': 'ë©´ì ',
                    'Administrative Level': 'í–‰ì •êµ¬ì—­',
                    'Advertising Price': 'ê´‘ê³  ê°€ê²©',
                    'Status': 'ìƒíƒœ',
                    'Available': 'ì‚¬ìš© ê°€ëŠ¥',
                    'Occupied': 'ê´‘ê³  ì¤‘',
                    'This region is available for advertisement registration.': 'ì´ ì§€ì—­ì€ í˜„ì¬ ê´‘ê³ ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                    'This region is currently occupied by an advertisement.': 'ì´ ì§€ì—­ì€ í˜„ì¬ ê´‘ê³ ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
                    'Purchase This Region': 'ì´ ì§€ì—­ êµ¬ë§¤í•˜ê¸°',
                    'Company Information': 'ê¸°ì—… ì •ë³´',
                    'Industry': 'ì‚°ì—… ë¶„ì•¼',
                    'Founded': 'ì„¤ë¦½ë…„ë„',
                    'Employees': 'ì§ì› ìˆ˜',
                    'Website': 'ì›¹ì‚¬ì´íŠ¸',
                    'Company Description': 'ê¸°ì—… ì†Œê°œ',
                    'Key Features': 'ì£¼ìš” íŠ¹ì§•',
                    'Region': 'ì§€ì—­ëª…'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'indonesia': {
                primary: {
                    'Region Information': 'Informasi Wilayah',
                    'Population': 'Populasi',
                    'Area': 'Luas',
                    'Administrative Level': 'Tingkat Administratif',
                    'Advertising Price': 'Harga Iklan',
                    'Status': 'Status',
                    'Available': 'Tersedia',
                    'Occupied': 'Terisi',
                    'This region is available for advertisement registration.': 'Wilayah ini saat ini tersedia untuk pendaftaran iklan.',
                    'This region is currently occupied by an advertisement.': 'Wilayah ini saat ini ditempati oleh iklan.',
                    'Purchase This Region': 'Beli Wilayah Ini',
                    'Company Information': 'Informasi Perusahaan',
                    'Industry': 'Industri',
                    'Founded': 'Didirikan',
                    'Employees': 'Karyawan',
                    'Website': 'Situs Web',
                    'Company Description': 'Deskripsi Perusahaan',
                    'Key Features': 'Fitur Utama',
                    'Region': 'Wilayah'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'saudi-arabia': {
                primary: {
                    'Region Information': 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                    'Population': 'Ø§Ù„Ø³ÙƒØ§Ù†',
                    'Area': 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
                    'Administrative Level': 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ',
                    'Advertising Price': 'Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†',
                    'Status': 'Ø§Ù„Ø­Ø§Ù„Ø©',
                    'Available': 'Ù…ØªØ§Ø­',
                    'Occupied': 'Ù…Ø­ØªÙ„',
                    'This region is available for advertisement registration.': 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.',
                    'This region is currently occupied by an advertisement.': 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø­ØªÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø¥Ø¹Ù„Ø§Ù†.',
                    'Purchase This Region': 'Ø´Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                    'Company Information': 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©',
                    'Industry': 'Ø§Ù„ØµÙ†Ø§Ø¹Ø©',
                    'Founded': 'ØªØ£Ø³Ø³Øª',
                    'Employees': 'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                    'Website': 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                    'Company Description': 'ÙˆØµÙ Ø§Ù„Ø´Ø±ÙƒØ©',
                    'Key Features': 'Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                    'Region': 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'turkey': {
                primary: {
                    'Region Information': 'BÃ¶lge Bilgisi',
                    'Population': 'NÃ¼fus',
                    'Area': 'Alan',
                    'Administrative Level': 'Ä°dari Seviye',
                    'Advertising Price': 'Reklam FiyatÄ±',
                    'Status': 'Durum',
                    'Available': 'MÃ¼sait',
                    'Occupied': 'Dolu',
                    'This region is available for advertisement registration.': 'Bu bÃ¶lge ÅŸu anda reklam kaydÄ± iÃ§in mÃ¼sait.',
                    'This region is currently occupied by an advertisement.': 'Bu bÃ¶lge ÅŸu anda bir reklam tarafÄ±ndan iÅŸgal edilmiÅŸ.',
                    'Purchase This Region': 'Bu BÃ¶lgeyi SatÄ±n Al',
                    'Company Information': 'Åirket Bilgileri',
                    'Industry': 'EndÃ¼stri',
                    'Founded': 'KuruluÅŸ',
                    'Employees': 'Ã‡alÄ±ÅŸanlar',
                    'Website': 'Web Sitesi',
                    'Company Description': 'Åirket AÃ§Ä±klamasÄ±',
                    'Key Features': 'Ana Ã–zellikler',
                    'Region': 'BÃ¶lge'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'south-africa': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'argentina': {
                primary: {
                    'Region Information': 'InformaciÃ³n de la regiÃ³n',
                    'Population': 'PoblaciÃ³n',
                    'Area': 'Ãrea',
                    'Administrative Level': 'Nivel administrativo',
                    'Advertising Price': 'Precio de publicidad',
                    'Status': 'Estado',
                    'Available': 'Disponible',
                    'Occupied': 'Ocupado',
                    'This region is available for advertisement registration.': 'Esta regiÃ³n estÃ¡ disponible para el registro de publicidad.',
                    'This region is currently occupied by an advertisement.': 'Esta regiÃ³n estÃ¡ ocupada por una publicidad.',
                    'Purchase This Region': 'Comprar esta regiÃ³n',
                    'Company Information': 'InformaciÃ³n de la empresa',
                    'Industry': 'Industria',
                    'Founded': 'Fundada',
                    'Employees': 'Empleados',
                    'Website': 'Sitio web',
                    'Company Description': 'DescripciÃ³n de la empresa',
                    'Key Features': 'CaracterÃ­sticas principales',
                    'Region': 'RegiÃ³n'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            }
        };
        this.zoomLevels = {
            world: 2,
            country: 4,
            region: 6
        };
        
        // init()ì€ async í•¨ìˆ˜ì´ë¯€ë¡œ Promiseë¡œ ì²˜ë¦¬ (ì—ëŸ¬ í•¸ë“¤ë§ í¬í•¨)
        this.init().catch(err => {
            console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', err);
        });
    }

    resolveAssetBaseUrl() {
        const ensureDir = (inputUrl) => {
            try {
                const url = new URL(inputUrl, window.location.href);
                return new URL('.', url).href;
            } catch (error) {
                console.warn('[BillionaireMap] base URL ê³„ì‚° ì‹¤íŒ¨:', inputUrl, error);
                return null;
            }
        };
        
        const candidates = [];
        
        if (window.__ASSET_BASE_URL__) {
            candidates.push(window.__ASSET_BASE_URL__);
        }
        
        if (typeof document !== 'undefined') {
            const baseTag = document.querySelector('base[href]');
            if (baseTag) {
                candidates.push(baseTag.href);
            }
            if (document.currentScript && document.currentScript.src) {
                candidates.push(new URL('.', document.currentScript.src).href);
            }
            if (document.baseURI) {
                candidates.push(document.baseURI);
            }
        }
        
        candidates.push(window.location.href);
        
        for (const candidate of candidates) {
            const dir = ensureDir(candidate);
            if (dir) {
                return dir;
            }
        }
        
        return `${window.location.origin}/`;
    }

    getAssetUrl(relativePath) {
        if (!relativePath) return relativePath;
        if (/^https?:\/\//i.test(relativePath)) return relativePath;
        
        // ìƒëŒ€ ê²½ë¡œ ì •ê·œí™” (./ ì œê±°, ì•ì˜ / ì œê±°)
        let sanitizedPath = relativePath.startsWith('./') ? relativePath.slice(2) : relativePath;
        sanitizedPath = sanitizedPath.replace(/^\/+/, '');
        
        try {
            // assetBaseUrlì€ ì´ë¯¸ ë””ë ‰í„°ë¦¬ ê²½ë¡œë¡œ ëë‚˜ë„ë¡ ë³´ì¥ë¨
            const baseUrl = this.assetBaseUrl.endsWith('/') ? this.assetBaseUrl : this.assetBaseUrl + '/';
            const fullUrl = new URL(sanitizedPath, baseUrl).toString();
            console.log(`[getAssetUrl] ${relativePath} -> ${fullUrl} (base: ${baseUrl})`);
            return fullUrl;
        } catch (error) {
            console.warn('ì—ì…‹ ê²½ë¡œë¥¼ í•´ê²°í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', sanitizedPath, error);
            // í´ë°±: ìƒëŒ€ ê²½ë¡œë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ë¸Œë¼ìš°ì €ê°€ í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ìœ¼ë¡œ í•´ì„)
            return sanitizedPath;
        }
    }
    
    // ========== ë³´ì•ˆ í—¬í¼ í•¨ìˆ˜ ==========
    
    /**
     * XSS ë°©ì–´: DOMPurifyë¥¼ ì‚¬ìš©í•˜ì—¬ HTML ì •í™”
     * @param {string} html - ì •í™”í•  HTML ë¬¸ìì—´
     * @param {object} options - DOMPurify ì˜µì…˜
     * @returns {string} ì •í™”ëœ HTML ë¬¸ìì—´
     */
    sanitizeHTML(html, options = {}) {
        if (!html) return '';
        if (typeof html !== 'string') return String(html);
        
        if (this.DOMPurify) {
            const defaultOptions = {
                ALLOWED_TAGS: ['b', 'i', 'em', 'strong', 'a', 'p', 'br', 'span', 'div', 'ul', 'ol', 'li', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'],
                ALLOWED_ATTR: ['href', 'title', 'class', 'id', 'style'],
                ALLOW_DATA_ATTR: false
            };
            return this.DOMPurify.sanitize(html, { ...defaultOptions, ...options });
        } else {
            // DOMPurifyê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ ì´ìŠ¤ì¼€ì´í”„
            console.warn('[ë³´ì•ˆ] DOMPurifyê°€ ì—†ì–´ ê¸°ë³¸ ì´ìŠ¤ì¼€ì´í”„ë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.');
            const div = document.createElement('div');
            div.textContent = html;
            return div.innerHTML;
        }
    }
    
    /**
     * ì•ˆì „í•œ innerHTML ì„¤ì •
     * @param {HTMLElement} element - ëŒ€ìƒ ìš”ì†Œ
     * @param {string} html - ì„¤ì •í•  HTML ë¬¸ìì—´
     */
    setSafeHTML(element, html) {
        if (!element) return;
        if (this.DOMPurify) {
            element.innerHTML = this.sanitizeHTML(html);
        } else {
            // DOMPurifyê°€ ì—†ì„ ê²½ìš° textContent ì‚¬ìš© (ì•ˆì „í•˜ì§€ë§Œ HTML ë Œë”ë§ ì•ˆë¨)
            element.textContent = html;
        }
    }
    
    /**
     * ì…ë ¥ ê²€ì¦ í•¨ìˆ˜
     * @param {string} value - ê²€ì¦í•  ê°’
     * @param {string} type - ê²€ì¦ íƒ€ì… ('text', 'url', 'email', 'number')
     * @param {number} maxLength - ìµœëŒ€ ê¸¸ì´
     * @param {boolean} required - í•„ìˆ˜ ì—¬ë¶€
     * @returns {string} ê²€ì¦ëœ ê°’
     * @throws {Error} ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬
     */
    validateInput(value, type = 'text', maxLength = 1000, required = true) {
        if (required && (!value || value.trim().length === 0)) {
            throw new Error('ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
        }
        
        if (!value) return '';
        
        const trimmedValue = value.trim();
        
        if (trimmedValue.length > maxLength) {
            throw new Error(`ìµœëŒ€ ${maxLength}ìê¹Œì§€ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤.`);
        }
        
        switch(type) {
            case 'url':
                try {
                    const url = new URL(trimmedValue);
                    if (!['http:', 'https:'].includes(url.protocol)) {
                        throw new Error('HTTPS/HTTPë§Œ í—ˆìš©ë©ë‹ˆë‹¤.');
                    }
                } catch (e) {
                    if (e.message.includes('HTTPS/HTTP')) {
                        throw e;
                    }
                    throw new Error('ìœ íš¨í•œ URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                break;
            case 'email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(trimmedValue)) {
                    throw new Error('ìœ íš¨í•œ ì´ë©”ì¼ ì£¼ì†Œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                break;
            case 'number':
                if (isNaN(trimmedValue) || trimmedValue === '') {
                    throw new Error('ìœ íš¨í•œ ìˆ«ìë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                break;
            case 'text':
                // HTML íƒœê·¸ ì œê±°
                return trimmedValue.replace(/<[^>]*>/g, '');
        }
        
        return trimmedValue;
    }
    
    /**
     * ì´ë¯¸ì§€ íŒŒì¼ ê²€ì¦ í•¨ìˆ˜
     * @param {File} file - ê²€ì¦í•  íŒŒì¼
     * @returns {Promise<boolean>} ê²€ì¦ ì„±ê³µ ì—¬ë¶€
     * @throws {Error} ê²€ì¦ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬
     */
    async validateImageFile(file) {
        if (!file) {
            throw new Error('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        }
        
        // 1. íŒŒì¼ í¬ê¸° ì œí•œ (10MB)
        const MAX_SIZE = 10 * 1024 * 1024; // 10MB
        if (file.size > MAX_SIZE) {
            throw new Error('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // 2. í—ˆìš©ëœ MIME íƒ€ì…
        const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'image/webp'];
        if (!allowedTypes.includes(file.type)) {
            throw new Error('JPEG, PNG, GIF, WebP íŒŒì¼ë§Œ í—ˆìš©ë©ë‹ˆë‹¤.');
        }
        
        // 3. í™•ì¥ì ê²€ì¦
        const allowedExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp'];
        const extension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
        if (!allowedExtensions.includes(extension)) {
            throw new Error('í—ˆìš©ë˜ì§€ ì•Šì€ íŒŒì¼ í™•ì¥ìì…ë‹ˆë‹¤.');
        }
        
        // 4. ì‹¤ì œ ì´ë¯¸ì§€ íŒŒì¼ì¸ì§€ í™•ì¸ (í—¤ë” ê²€ì¦)
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const arrayBuffer = e.target.result;
                    const bytes = new Uint8Array(arrayBuffer);
                    
                    // JPEG: FF D8 FF
                    // PNG: 89 50 4E 47 0D 0A 1A 0A
                    // GIF: 47 49 46 38 (GIF8)
                    // WebP: RIFF ... WEBP
                    const isJPEG = bytes[0] === 0xFF && bytes[1] === 0xD8 && bytes[2] === 0xFF;
                    const isPNG = bytes[0] === 0x89 && bytes[1] === 0x50 && bytes[2] === 0x4E && bytes[3] === 0x47;
                    const isGIF = bytes[0] === 0x47 && bytes[1] === 0x49 && bytes[2] === 0x46 && bytes[3] === 0x38;
                    
                    // WebP ê²€ì¦ (RIFF ... WEBP)
                    let isWebP = false;
                    if (bytes.length >= 12) {
                        const webpHeader = String.fromCharCode(...bytes.slice(0, 4));
                        const webpFormat = String.fromCharCode(...bytes.slice(8, 12));
                        isWebP = webpHeader === 'RIFF' && webpFormat === 'WEBP';
                    }
                    
                    if (isJPEG || isPNG || isGIF || isWebP) {
                        resolve(true);
                    } else {
                        reject(new Error('ìœ íš¨í•œ ì´ë¯¸ì§€ íŒŒì¼ì´ ì•„ë‹™ë‹ˆë‹¤.'));
                    }
                } catch (error) {
                    reject(new Error('íŒŒì¼ ê²€ì¦ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
                }
            };
            reader.onerror = () => {
                reject(new Error('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'));
            };
            reader.readAsArrayBuffer(file.slice(0, 12)); // í—¤ë”ë§Œ ì½ê¸° (WebP ê²€ì¦ì„ ìœ„í•´ 12ë°”ì´íŠ¸)
        });
    }
    
    /**
     * Rate Limiting: ë¡œê·¸ì¸ ì‹œë„ ì œí•œ í™•ì¸
     * @param {string} identifier - ì‚¬ìš©ì ì‹ë³„ì (IP ë˜ëŠ” ì‚¬ìš©ì ID)
     * @returns {object} { allowed: boolean, remainingAttempts: number, lockoutTime: number }
     */
    checkLoginRateLimit(identifier) {
        const now = Date.now();
        const attempts = this.loginAttempts.get(identifier) || { count: 0, lockoutUntil: 0 };
        
        // ì ê¸ˆ ì‹œê°„ì´ ì§€ë‚¬ìœ¼ë©´ ì´ˆê¸°í™”
        if (attempts.lockoutUntil > 0 && now > attempts.lockoutUntil) {
            this.loginAttempts.delete(identifier);
            return { allowed: true, remainingAttempts: this.maxLoginAttempts, lockoutTime: 0 };
        }
        
        // ì ê¸ˆ ì¤‘ì´ë©´ ê±°ë¶€
        if (attempts.lockoutUntil > 0 && now <= attempts.lockoutUntil) {
            const remainingTime = Math.ceil((attempts.lockoutUntil - now) / 1000 / 60); // ë¶„ ë‹¨ìœ„
            return { allowed: false, remainingAttempts: 0, lockoutTime: remainingTime };
        }
        
        // ì‹œë„ íšŸìˆ˜ í™•ì¸
        if (attempts.count >= this.maxLoginAttempts) {
            // ì ê¸ˆ ì‹œì‘
            attempts.lockoutUntil = now + this.loginLockoutTime;
            this.loginAttempts.set(identifier, attempts);
            return { allowed: false, remainingAttempts: 0, lockoutTime: Math.ceil(this.loginLockoutTime / 1000 / 60) };
        }
        
        return { allowed: true, remainingAttempts: this.maxLoginAttempts - attempts.count, lockoutTime: 0 };
    }
    
    /**
     * Rate Limiting: ë¡œê·¸ì¸ ì‹œë„ ê¸°ë¡
     * @param {string} identifier - ì‚¬ìš©ì ì‹ë³„ì
     * @param {boolean} success - ë¡œê·¸ì¸ ì„±ê³µ ì—¬ë¶€
     */
    recordLoginAttempt(identifier, success) {
        if (success) {
            // ì„±ê³µ ì‹œ ì‹œë„ íšŸìˆ˜ ì´ˆê¸°í™”
            this.loginAttempts.delete(identifier);
        } else {
            // ì‹¤íŒ¨ ì‹œ ì‹œë„ íšŸìˆ˜ ì¦ê°€
            const attempts = this.loginAttempts.get(identifier) || { count: 0, lockoutUntil: 0 };
            attempts.count += 1;
            this.loginAttempts.set(identifier, attempts);
        }
    }
    
    /**
     * ì‚¬ìš©ì ì‹ë³„ì ê°€ì ¸ì˜¤ê¸° (IP ê¸°ë°˜ ë˜ëŠ” ì‚¬ìš©ì ID)
     * @returns {string} ì‚¬ìš©ì ì‹ë³„ì
     */
    getUserIdentifier() {
        // Firebase ì‚¬ìš©ì IDê°€ ìˆìœ¼ë©´ ì‚¬ìš©
        if (this.currentUser && this.currentUser.uid) {
            return `user:${this.currentUser.uid}`;
        }
        // ì—†ìœ¼ë©´ ì„¸ì…˜ ID ì‚¬ìš© (ê°„ë‹¨í•œ êµ¬í˜„)
        if (!this.sessionId) {
            this.sessionId = `session:${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
        }
        return this.sessionId;
    }
    
    initializeCountryConfig() {
        const configs = [
            { key: 'usa', firestoreCountry: 'USA', iso2: 'US', aliases: ['united states', 'america', 'us'] },
            { key: 'korea', firestoreCountry: 'South Korea', iso2: 'KR', aliases: ['south-korea', 'republic of korea', 'korea'] },
            { key: 'japan', firestoreCountry: 'Japan', iso2: 'JP' },
            { key: 'china', firestoreCountry: 'China', iso2: 'CN' },
            { key: 'russia', firestoreCountry: 'Russia', iso2: 'RU' },
            { key: 'india', firestoreCountry: 'India', iso2: 'IN' },
            { key: 'canada', firestoreCountry: 'Canada', iso2: 'CA' },
            { key: 'germany', firestoreCountry: 'Germany', iso2: 'DE' },
            { key: 'uk', firestoreCountry: 'United Kingdom', iso2: 'GB', aliases: ['great britain', 'britain', 'uk'] },
            { key: 'france', firestoreCountry: 'France', iso2: 'FR' },
            { key: 'italy', firestoreCountry: 'Italy', iso2: 'IT' },
            { key: 'brazil', firestoreCountry: 'Brazil', iso2: 'BR' },
            { key: 'australia', firestoreCountry: 'Australia', iso2: 'AU' },
            { key: 'mexico', firestoreCountry: 'Mexico', iso2: 'MX' },
            { key: 'indonesia', firestoreCountry: 'Indonesia', iso2: 'ID' },
            { key: 'saudi-arabia', firestoreCountry: 'Saudi Arabia', iso2: 'SA', aliases: ['saudiarabia'] },
            { key: 'turkey', firestoreCountry: 'Turkey', iso2: 'TR' },
            { key: 'south-africa', firestoreCountry: 'South Africa', iso2: 'ZA', aliases: ['southafrica'] },
            { key: 'argentina', firestoreCountry: 'Argentina', iso2: 'AR' },
            { key: 'european-union', firestoreCountry: 'European Union', iso2: 'EU', aliases: ['eu'] },
            { key: 'spain', firestoreCountry: 'Spain', iso2: 'ES' },
            { key: 'netherlands', firestoreCountry: 'Netherlands', iso2: 'NL' },
            { key: 'poland', firestoreCountry: 'Poland', iso2: 'PL' },
            { key: 'belgium', firestoreCountry: 'Belgium', iso2: 'BE' },
            { key: 'sweden', firestoreCountry: 'Sweden', iso2: 'SE' },
            { key: 'austria', firestoreCountry: 'Austria', iso2: 'AT' },
            { key: 'denmark', firestoreCountry: 'Denmark', iso2: 'DK' },
            { key: 'finland', firestoreCountry: 'Finland', iso2: 'FI' },
            { key: 'ireland', firestoreCountry: 'Ireland', iso2: 'IE' },
            { key: 'portugal', firestoreCountry: 'Portugal', iso2: 'PT' },
            { key: 'greece', firestoreCountry: 'Greece', iso2: 'GR' },
            { key: 'czech-republic', firestoreCountry: 'Czech Republic', iso2: 'CZ', aliases: ['czech', 'czechia'] },
            { key: 'romania', firestoreCountry: 'Romania', iso2: 'RO' },
            { key: 'hungary', firestoreCountry: 'Hungary', iso2: 'HU' },
            { key: 'bulgaria', firestoreCountry: 'Bulgaria', iso2: 'BG' }
        ];
        
        this.countryConfigs = configs;
        if (!this.countryLookup) {
            this.countryLookup = new Map();
        } else {
            this.countryLookup.clear();
        }
        this.countryConfigByKey = {};
        
        const registerKey = (value, config) => {
            if (!value) return;
            this.countryLookup.set(value.toLowerCase(), config);
        };
        
        configs.forEach(config => {
            this.countryConfigByKey[config.key] = config;
            registerKey(config.key, config);
            registerKey(config.firestoreCountry, config);
            registerKey(config.iso2, config);
            if (config.aliases && Array.isArray(config.aliases)) {
                config.aliases.forEach(alias => registerKey(alias, config));
            }
        });
    }
    
    getCountryConfig(identifier) {
        if (!identifier || !this.countryLookup) return null;
        const key = identifier.toString().toLowerCase();
        return this.countryLookup.get(key) || null;
    }
    
    normalizeCountryIdentifier(identifier) {
        if (!identifier) return null;
        const config = this.getCountryConfig(identifier);
        if (config) {
            return config.firestoreCountry;
        }
        if (typeof identifier === 'string') {
            return identifier;
        }
        return null;
    }
    
    // í˜„ì¬ êµ­ê°€ì˜ ì´ í–‰ì •êµ¬ì—­ ìˆ˜ ê³„ì‚°
    getTotalAdminRegionsCount(country) {
        if (!country) return 0;
        
        // regionData Mapì—ì„œ ê°™ì€ êµ­ê°€ì˜ í–‰ì •êµ¬ì—­ ê°œìˆ˜ ì„¸ê¸°
        let count = 0;
        this.regionData.forEach((regionData) => {
            if (regionData.country === country) {
                count++;
            }
        });
        
        // regionDataì— ì—†ìœ¼ë©´ ì§€ë„ ì†ŒìŠ¤ì—ì„œ í™•ì¸
        if (count === 0 && this.map && this.map.getSource('world-regions')) {
            const source = this.map.getSource('world-regions');
            const data = source._data;
            if (data && data.features) {
                count = data.features.filter(feature => {
                    const props = feature.properties || {};
                    return props.country === country;
                }).length;
            }
        }
        
        return count;
    }
    
    async loadRegionDataForMode(mode, options = {}) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        const config = this.getCountryConfig(mode);
        const country = config?.firestoreCountry || this.normalizeCountryIdentifier(options.country || mode);
        if (!country) {
            return;
        }
        return this.loadRegionDataFromFirestore({
            ...options,
            country
        });
    }
    
    // IndexedDB ìºì‹œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    async initCacheDB() {
        return new Promise((resolve, reject) => {
            if (!('indexedDB' in window)) {
                console.warn('IndexedDBë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤. ìºì‹±ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                resolve(null);
                return;
            }
            
            const request = indexedDB.open(this.cacheDBName, this.cacheDBVersion);
            
            request.onerror = () => {
                console.warn('IndexedDB ì´ˆê¸°í™” ì‹¤íŒ¨:', request.error);
                resolve(null);
            };
            
            request.onsuccess = () => {
                this.cacheDB = request.result;
                console.log('[ìºì‹œ] IndexedDB ì´ˆê¸°í™” ì™„ë£Œ');
                resolve(this.cacheDB);
            };
            
            request.onupgradeneeded = (event) => {
                const db = event.target.result;
                if (!db.objectStoreNames.contains('geojson')) {
                    const objectStore = db.createObjectStore('geojson', { keyPath: 'key' });
                    objectStore.createIndex('timestamp', 'timestamp', { unique: false });
                }
            };
        });
    }
    
    // IndexedDBì—ì„œ ìºì‹œëœ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async getCachedGeoJson(countryKey) {
        if (!this.cacheDB) {
            return null;
        }
        
        return new Promise((resolve) => {
            const transaction = this.cacheDB.transaction(['geojson'], 'readonly');
            const objectStore = transaction.objectStore('geojson');
            const request = objectStore.get(countryKey);
            
            request.onsuccess = () => {
                const cached = request.result;
                if (!cached) {
                    resolve(null);
                    return;
                }
                
                // ìºì‹œ ë§Œë£Œ í™•ì¸ (7ì¼)
                const now = Date.now();
                const expiryTime = this.cacheExpiryDays * 24 * 60 * 60 * 1000;
                if (now - cached.timestamp > expiryTime) {
                    console.log(`[ìºì‹œ] ${countryKey} ë°ì´í„° ë§Œë£Œë¨, ì‚­ì œ`);
                    this.deleteCachedGeoJson(countryKey);
                    resolve(null);
                    return;
                }
                
                console.log(`[ìºì‹œ] ${countryKey} ë°ì´í„° ë¡œë“œ ì™„ë£Œ (IndexedDB ìºì‹œ ì‚¬ìš©)`);
                resolve(cached.data);
            };
            
            request.onerror = () => {
                console.warn(`[ìºì‹œ] ${countryKey} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, request.error);
                resolve(null);
            };
        });
    }
    
    // IndexedDBì— ë°ì´í„° ìºì‹œ ì €ì¥
    async setCachedGeoJson(countryKey, geoJsonData) {
        if (!this.cacheDB || !geoJsonData) {
            return;
        }
        
        return new Promise((resolve) => {
            const transaction = this.cacheDB.transaction(['geojson'], 'readwrite');
            const objectStore = transaction.objectStore('geojson');
            const data = {
                key: countryKey,
                data: geoJsonData,
                timestamp: Date.now()
            };
            
            const request = objectStore.put(data);
            
            request.onsuccess = () => {
                console.log(`[ìºì‹œ] ${countryKey} ë°ì´í„° ì €ì¥ ì™„ë£Œ (IndexedDB)`);
                resolve();
            };
            
            request.onerror = () => {
                console.warn(`[ìºì‹œ] ${countryKey} ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:`, request.error);
                resolve();
            };
        });
    }
    
    // ìºì‹œëœ ë°ì´í„° ì‚­ì œ
    async deleteCachedGeoJson(countryKey) {
        if (!this.cacheDB) {
            return;
        }
        
        return new Promise((resolve) => {
            const transaction = this.cacheDB.transaction(['geojson'], 'readwrite');
            const objectStore = transaction.objectStore('geojson');
            const request = objectStore.delete(countryKey);
            
            request.onsuccess = () => {
                resolve();
            };
            
            request.onerror = () => {
                resolve();
            };
        });
    }
    
    async init() {
        try {
            // ë³„ ë°°ê²½ ì´ˆê¸°í™”
            this.initStarsBackground();
            
            // IndexedDB ìºì‹œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
            await this.initCacheDB();
            
            // Firebase ì´ˆê¸°í™” (ë¹„ë™ê¸°ë¡œ ì‹¤í–‰, ì‹¤íŒ¨í•´ë„ ì§€ë„ëŠ” ë¡œë“œë¨)
            await this.initializeFirebase().catch(err => {
                console.warn('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
            });
            await this.tryResumeAdminSession();
            
            await this.initializeMap();
            
            // ëª¨ë“  êµ­ê°€ ë°ì´í„°ì™€ ëª¨ë“  êµ­ê°€ì˜ Firestore ë°ì´í„°ë¥¼ ë™ì‹œì— ë³‘ë ¬ë¡œ ë¡œë“œ
            // ì„±ëŠ¥ ìµœì í™”: ëª¨ë“  êµ­ê°€ì˜ Firestore ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë°°ì¹˜ë¡œ ë¡œë“œ
            const firestoreLoadPromise = this.loadAllRegionsDataFromFirestore().catch(err => {
                console.warn('Firestore ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
                return null;
            });
            
            // GeoJSON ë°ì´í„°ì™€ Firestore ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
            const [geoJsonResult] = await Promise.all([
                this.loadAllCountriesForDisplay(),
                firestoreLoadPromise
            ]);
            
            // ëª¨ë“  ì§€ì—­ ê°€ê²©ì„ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚° (í”½ì…€ë‹¹ $0.1) - ë³‘ë ¬ ì²˜ë¦¬
            // ê°€ê²© ê³„ì‚°ì€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰í•˜ê³ , ì§€ë„ í‘œì‹œëŠ” ë¨¼ì € ì§„í–‰
            const priceCalculationPromise = this.setAllRegionsPriceBasedOnPixels().catch(err => {
                console.warn('[ê°€ê²© ê³„ì‚° ì‹¤íŒ¨]:', err);
            });
            
            // ì§€ë„ê°€ í‘œì‹œë˜ë©´ ë¡œë”©ì„ ìˆ¨ê¹€ (ê°€ê²© ê³„ì‚° ì™„ë£Œë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
            if (!this.eventListenersAdded) {
                this.setupEventListeners();
                this.eventListenersAdded = true;
            }
            
            // ì§€ë„ í‘œì‹œ ì™„ë£Œ í›„ ë¡œë”© ìˆ¨ê¹€
            this.hideLoading();
            
            // ê°€ê²© ê³„ì‚° ì™„ë£Œ ëŒ€ê¸° (ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰)
            await priceCalculationPromise;
            
            // ì˜¨ë³´ë”© íˆ¬ì–´ ì´ˆê¸°í™” (ì²« ë°©ë¬¸ ì‹œ)
            this.initOnboardingTour();
            
            // ëª¨ë°”ì¼ ìµœì í™” ì´ˆê¸°í™”
            this.initMobileOptimization();
            this.switchToUserMode(); // ì´ˆê¸°ì—ëŠ” ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ
            
            // ê¸°ìˆ  ì¸í”„ë¼ ê°œì„  ì´ˆê¸°í™”
            this.initAPIEndpoints();
            this.simplifyMapLayers();
            
            // ì§€ë„ ì´ë™ ì‹œ ë·°í¬íŠ¸ ê¸°ë°˜ ë¡œë”© í™œì„±í™” (ì„±ëŠ¥ ìµœì í™”: ë””ë°”ìš´ì‹± ì ìš©)
            if (this.map) {
                let viewportLoadTimer = null;
                this.map.on('moveend', () => {
                    // ë””ë°”ìš´ì‹±: ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ í›„ 300ms í›„ì—ë§Œ ì‹¤í–‰
                    if (viewportLoadTimer) {
                        clearTimeout(viewportLoadTimer);
                    }
                    viewportLoadTimer = setTimeout(() => {
                        this.loadFeaturesForViewport();
                    }, 300);
                });
            }
            
            // ì»¤ë®¤ë‹ˆí‹° & ìš´ì˜ ì´ˆê¸°í™”
            this.initCommunityFeatures();
            // UIëŠ” Pí‚¤ ì—°íƒ€ë¡œ í‘œì‹œí•˜ê±°ë‚˜ í–„ë²„ê±° ë©”ë‰´ë¥¼ í†µí•´ ì ‘ê·¼
            // this.showUI(); // ì´ˆê¸°ì—ëŠ” UI í‘œì‹œí•˜ì§€ ì•ŠìŒ
            this.addMapModeToggle(); // ì§€ë„ ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ì¶”ê°€
            this.setupColorPresetListeners(); // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            this.updateUserUI(); // ì‚¬ìš©ì UI ì´ˆê¸°í™” (ì‚¬ì´ë“œ ë©”ë‰´ ë¡œê·¸ì¸ ë²„íŠ¼ í‘œì‹œ)
            
            // ë©”ëª¨ë¦¬ ìµœì í™” ì´ˆê¸°í™”
            this.initMemoryOptimization();
            
            // ì´ˆê¸°í™” ì‹œ ê´€ë¦¬ì ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const sideAdminSection = document.getElementById('side-admin-section');
            if (sideAdminSection) {
                sideAdminSection.style.display = 'none';
            }
        } catch (error) {
            console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            this.showError('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // ë³„ ë°°ê²½ ì´ˆê¸°í™” (Canvas ê¸°ë°˜)
    initStarsBackground() {
        const canvas = document.getElementById('stars-canvas');
        if (!canvas) {
            console.error('ë³„ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        const numStars = 800; // ë³„ ê°œìˆ˜ ì¦ê°€ (ë” í’ë¶€í•˜ê²Œ)
        const stars = [];
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        const resizeCanvas = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë³„ ìœ„ì¹˜ ì¬ê³„ì‚°
            if (this.stars && this.stars.length > 0) {
                this.stars.forEach(star => {
                    star.x = Math.random() * canvas.width;
                    star.y = Math.random() * canvas.height;
                });
            }
            if (this.stars) this.drawStars();
        };
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ë³„ ìƒì„± (í¬ê¸°ì™€ ë°ê¸° ë‹¤ì–‘í™”)
        for (let i = 0; i < numStars; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 2 + 0.3, // ë” ì‘ì€ ë³„ë„ í¬í•¨
                opacity: Math.random() * 0.9 + 0.1, // ë” ë°ê²Œ
                twinkleSpeed: Math.random() * 0.03 + 0.005,
                currentOpacity: Math.random() * 0.9 + 0.1,
                color: Math.random() > 0.8 ? '#87CEEB' : '#FFFFFF' // ì¼ë¶€ ë³„ì€ í•˜ëŠ˜ìƒ‰
            });
        }
        
        this.stars = stars;
        this.starsCanvas = canvas;
        this.starsCtx = ctx;
        
        // ë³„ ê·¸ë¦¬ê¸°
        this.drawStars();
        
        // ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜
        this.animateStars();
        
        console.log(`${numStars}ê°œì˜ ë³„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`);
    }
    
    // ë³„ ê·¸ë¦¬ê¸°
    drawStars() {
        if (!this.starsCtx || !this.starsCanvas || !this.stars) return;
        
        const ctx = this.starsCtx;
        const canvas = this.starsCanvas;
        
        // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ë³„ ê·¸ë¦¬ê¸° (ë” ë°ê³  ì„ ëª…í•˜ê²Œ)
        this.stars.forEach(star => {
            const opacity = star.currentOpacity || star.opacity;
            const color = star.color || '#FFFFFF';
            
            // ë³„ ì¤‘ì‹¬
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
            
            // ìƒ‰ìƒì— ë§ì¶˜ íˆ¬ëª…ë„ ì ìš©
            if (color === '#87CEEB') {
                ctx.fillStyle = `rgba(135, 206, 235, ${opacity})`;
            } else {
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            }
            ctx.fill();
            
            // í° ë³„ì€ í›„ê´‘ íš¨ê³¼ ì¶”ê°€
            if (star.radius > 1.5) {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius * 1.5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.3})`;
                ctx.fill();
            }
        });
    }
    
    // ë³„ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜
    animateStars() {
        if (!this.stars) return;
        
        this.stars.forEach(star => {
            if (!star.currentOpacity) star.currentOpacity = star.opacity;
            star.currentOpacity += star.twinkleSpeed;
            if (star.currentOpacity > star.opacity + 0.3 || star.currentOpacity < star.opacity - 0.3) {
                star.twinkleSpeed = -star.twinkleSpeed;
            }
        });
        
        this.drawStars();
        requestAnimationFrame(() => this.animateStars());
    }
    
    // Firebase ì´ˆê¸°í™”
    async initializeFirebase() {
        try {
            // Firebase ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            if (!window.firebaseModules) {
                console.warn('Firebase ëª¨ë“ˆì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.');
                setTimeout(() => this.initializeFirebase(), 1000);
                return;
            }

            const { initializeApp, getAuth, getFirestore, firebaseConfig } = window.firebaseModules;
            
            // Firebase ì„¤ì •ì´ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                console.warn('Firebase ì„¤ì •ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. index.htmlì—ì„œ firebaseConfigë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.');
                this.showNotification('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ Firebase ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // Firebase ì•± ì´ˆê¸°í™”
            this.firebaseApp = initializeApp(firebaseConfig);
            this.firebaseAuth = getAuth(this.firebaseApp);
            this.firestore = getFirestore(this.firebaseApp);
            this.isFirebaseInitialized = true;

            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
            this.firebaseAuth.onAuthStateChanged(async (user) => {
                const wasLoggedOut = !this.currentUser && user;
                this.currentUser = user;
                
                if (user) {
                    try {
                        const tokenResult = await user.getIdTokenResult(true);
                        const isAdmin = tokenResult?.claims?.role === 'admin';
                        this.isAdminLoggedIn = isAdmin;
                        if (isAdmin && !this.adminMode) {
                            this.switchToAdminMode();
                        } else if (!isAdmin && this.adminMode) {
                            this.switchToUserMode();
                        }
                    } catch (tokenError) {
                        console.warn('í† í° ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', tokenError);
                        this.isAdminLoggedIn = false;
                        if (this.adminMode) {
                            this.switchToUserMode();
                        }
                    }

                    console.log('ì‚¬ìš©ì ë¡œê·¸ì¸:', user.email);
                    try {
                        await this.ensureUserWallet(user);
                        await this.subscribeToUserWallet(user.uid);
                    } catch (walletError) {
                        console.warn('[ì§€ê°‘] ì‚¬ìš©ì ì§€ê°‘ ì¤€ë¹„ ì‹¤íŒ¨:', walletError);
                    }
                    if (wasLoggedOut && this.currentRegion) {
                        this.autoRenderPayPalButtons();
                    }
                } else {
                    console.log('ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ');
                    this.isAdminLoggedIn = false;
                    this.teardownWalletSubscription();
                    this.walletState = this.createEmptyWalletState();
                    this.closeWalletModal();
                    if (this.adminMode) {
                        this.switchToUserMode();
                    }
                    const storedSession = this.getStoredAdminSession();
                    if (storedSession) {
                        await this.tryResumeAdminSession(storedSession);
                    }
                }
                
                this.updateAdminModeControls();
                this.updateUserUI();
            });

            console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
            // ì»¤ë®¤ë‹ˆí‹° í’€ êµ¬ë…ì€ ìœ ì§€ (ì˜¥ì…˜ ì‹œìŠ¤í…œì— í•„ìš”)
            this.subscribeToCommunityPool();
            // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²½ë§¤ ìë™í™” ì¡ ì‹œì‘
            this.startAuctionAutomationJob();
        } catch (error) {
            console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            this.showNotification('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        }
    }

    // êµ¬ë§¤ ê¸°ë¡ì„ Firestoreì— ì €ì¥
    async savePurchaseToFirestore(regionId, regionName, paypalOrderId, buyerEmail, amount) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ êµ¬ë§¤ ê¸°ë¡ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const purchaseData = {
                regionId: regionId,
                regionName: regionName,
                paypalOrderId: paypalOrderId,
                buyerEmail: buyerEmail,
                amount: amount,
                purchaseDate: serverTimestamp(),
                status: 'completed'
            };

            const docRef = await addDoc(collection(this.firestore, 'purchases'), purchaseData);
            console.log('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ ì™„ë£Œ:', docRef.id);
            return docRef.id;
        } catch (error) {
            console.error('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', error);
            this.showNotification('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // íŠ¹ì • ì§€ì—­ì˜ ì†Œìœ ì í™•ì¸ (ì˜¥ì…˜ ë‚™ì°°ì ë˜ëŠ” êµ¬ë§¤ì)
    async checkRegionOwnership(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore || !this.currentUser) {
            return false;
        }

        try {
            const { collection, query, where, getDocs, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // 1. regions ì»¬ë ‰ì…˜ì—ì„œ ì˜¥ì…˜ ë‚™ì°°ì í™•ì¸
            const regionRef = doc(this.firestore, 'regions', regionId);
            const regionDoc = await getDoc(regionRef);
            if (regionDoc.exists()) {
                const regionData = regionDoc.data();
                if (regionData.ownerEmail === this.currentUser.email || regionData.ownerId === this.currentUser.uid) {
                    return true;
                }
            }
            
            // 2. purchases ì»¬ë ‰ì…˜ì—ì„œ êµ¬ë§¤ ê¸°ë¡ í™•ì¸
            // ê¶Œí•œ ë¬¸ì œë¥¼ í”¼í•˜ê¸° ìœ„í•´ buyerEmailë¡œë§Œ ì¿¼ë¦¬í•˜ê³  í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§
            try {
                const q = query(
                    collection(this.firestore, 'purchases'),
                    where('buyerEmail', '==', this.currentUser.email),
                    where('status', '==', 'completed')
                );

                const querySnapshot = await getDocs(q);
                // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ regionId í•„í„°ë§
                const matchingPurchase = querySnapshot.docs.find(doc => {
                    const data = doc.data();
                    return data.regionId === regionId;
                });
                return !!matchingPurchase;
            } catch (purchaseError) {
                // purchases ì¿¼ë¦¬ ì‹¤íŒ¨ ì‹œ ì¡°ìš©íˆ false ë°˜í™˜ (ê¶Œí•œ ì—†ìŒìœ¼ë¡œ ê°„ì£¼)
                if (purchaseError.code === 'permission-denied') {
                    return false;
                }
                throw purchaseError;
            }
        } catch (error) {
            // ê¶Œí•œ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  false ë°˜í™˜)
            if (error.code === 'permission-denied') {
                return false;
            }
            console.error('ì†Œìœ ê¶Œ í™•ì¸ ì˜¤ë¥˜:', error);
            return false;
        }
    }

    // ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥
    async saveRegionDataToFirestore(regionId, regionData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì§€ì—­ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }

        try {
            const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ad_price ê³„ì‚° (ëª…ì‹œì ìœ¼ë¡œ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°)
            let adPrice = regionData.ad_price;
            if (!adPrice || adPrice === this.uniformAdPrice || adPrice === 0) {
                // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê°€ê²© ê³„ì‚°
                adPrice = await this.getStartingPriceForRegion(regionId);
            }
            
            // ì €ì¥í•  ë°ì´í„° (Firestoreì— ì €ì¥í•  í•„ë“œë§Œ ì¶”ì¶œ)
            const firestoreData = {
                regionId: regionId,
                name_ko: regionData.name_ko || '',
                name_en: regionData.name_en || regionData.name || '',
                country: regionData.country || '',
                admin_level: regionData.admin_level || '',
                population: regionData.population || 0,
                area: regionData.area || 0,
                ad_price: adPrice, // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê³„ì‚°ëœ ê°€ê²©
                ad_status: regionData.ad_status || 'available',
                updatedAt: serverTimestamp()
            };

            // ì§€ì—­ IDë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©í•˜ì—¬ ì €ì¥ (ë®ì–´ì“°ê¸°)
            const regionRef = doc(this.firestore, 'regions', regionId);
            await setDoc(regionRef, firestoreData, { merge: true });
            
            const auditFields = { ...firestoreData };
            delete auditFields.updatedAt;
            delete auditFields.regionId;
            this.recordAdminAudit('region.update', {
                regionId,
                fields: auditFields
            });
            
            console.log('Firestoreì— ì§€ì—­ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', regionId, firestoreData);
            return true;
        } catch (error) {
            console.error('Firestore ì§€ì—­ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            this.showNotification('Firestoreì— ì§€ì—­ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            return false;
        }
    }

    // Firestoreì—ì„œ ì§€ì—­ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (êµ­ê°€ ë‹¨ìœ„ ìºì‹± ì§€ì›)
    // ëª¨ë“  êµ­ê°€ì˜ Firestore ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë°°ì¹˜ë¡œ ë¡œë“œ (ì„±ëŠ¥ ìµœì í™”)
    async loadAllRegionsDataFromFirestore(force = false) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const cacheKey = '__all__';
        const cachedState = this.regionDataLoadState.get(cacheKey);

        if (cachedState && cachedState.status === 'loaded' && !force) {
            return cachedState.result;
        }

        if (cachedState && cachedState.status === 'loading') {
            return cachedState.promise;
        }

        const loadPromise = (async () => {
            try {
                const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                // ëª¨ë“  êµ­ê°€ì˜ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë¡œë“œ (country í•„í„° ì—†ì´)
                const regionsRef = collection(this.firestore, 'regions');
                const regionsSnapshot = await getDocs(regionsRef);
                
                let loadedCount = 0;
                let mergedCount = 0;
                
                regionsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const regionId = data.regionId || doc.id;
                    
                    const existingData = this.regionData.get(regionId) || {};
                    
                    const mergedData = {
                        ...existingData,
                        ...data,
                        // Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ìœ ì§€, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ 0
                        population: (data.population !== undefined && data.population !== null && data.population > 0)
                            ? data.population 
                            : (existingData.population !== undefined && existingData.population !== null && existingData.population > 0)
                                ? existingData.population
                                : 0,
                        area: (data.area !== undefined && data.area !== null && data.area > 0)
                            ? data.area 
                            : (existingData.area !== undefined && existingData.area !== null && existingData.area > 0)
                                ? existingData.area
                                : 0,
                        // ê°€ê²©ì€ Firestore ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ nullë¡œ ì„¤ì •í•˜ì—¬ ë‚˜ì¤‘ì— í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
                        ad_price: existingData.ad_price !== undefined && existingData.ad_price !== null 
                            ? existingData.ad_price 
                            : (data.ad_price !== undefined && data.ad_price !== null && data.ad_price > 0 ? data.ad_price : null),
                        name_ko: data.name_ko || existingData.name_ko || '',
                        name_en: data.name_en || existingData.name_en || existingData.name || '',
                        country: data.country || existingData.country || '',
                        admin_level: data.admin_level || existingData.admin_level || '',
                        ad_status: data.ad_status || existingData.ad_status || 'available'
                    };
                    
                    if (Object.keys(existingData).length > 0) {
                        mergedCount++;
                    }
                    
                    this.regionData.set(regionId, mergedData);
                    loadedCount++;
                });
    
                console.log(`Firestore(ALL)ì—ì„œ ${loadedCount}ê°œì˜ ì§€ì—­ ë°ì´í„°ë¥¼ í•œ ë²ˆì— ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ë³‘í•©: ${mergedCount}ê°œ)`);
    
                this.updateMapSourcesWithRegionData();
                return { loadedCount, mergedCount, country: 'ALL' };
            } catch (error) {
                console.error('Firestore ì§€ì—­ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                throw error;
            }
        })();

        this.regionDataLoadState.set(cacheKey, { status: 'loading', promise: loadPromise });

        try {
            const result = await loadPromise;
            this.regionDataLoadState.set(cacheKey, { status: 'loaded', result, timestamp: Date.now() });
            return result;
        } catch (error) {
            this.regionDataLoadState.delete(cacheKey);
            // ì˜¤ë¥˜ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰ (ë¡œì»¬ ë°ì´í„° ì‚¬ìš©)
            return null;
        }
    }

    async loadRegionDataFromFirestore(options = {}) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        const { country = null, force = false } = options;
        const normalizedCountry = this.normalizeCountryIdentifier(country);
        const cacheKey = normalizedCountry ? normalizedCountry.toLowerCase() : '__all__';
        const cachedState = this.regionDataLoadState.get(cacheKey);

        if (cachedState && cachedState.status === 'loaded' && !force) {
            return cachedState.result;
        }

        if (cachedState && cachedState.status === 'loading') {
            return cachedState.promise;
        }

        const loadPromise = (async () => {
            try {
                const { collection, getDocs, query, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                
                let regionsRef = collection(this.firestore, 'regions');
                if (normalizedCountry) {
                    regionsRef = query(regionsRef, where('country', '==', normalizedCountry));
                }
                
                const regionsSnapshot = await getDocs(regionsRef);
                
                let loadedCount = 0;
                let mergedCount = 0;
                
                regionsSnapshot.forEach((doc) => {
                    const data = doc.data();
                    const regionId = data.regionId || doc.id;
                    
                    const existingData = this.regionData.get(regionId) || {};
                    
                    const mergedData = {
                        ...existingData,
                        ...data,
                        // Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ìœ ì§€, ë‘˜ ë‹¤ ì—†ìœ¼ë©´ 0
                        population: (data.population !== undefined && data.population !== null && data.population > 0)
                            ? data.population 
                            : (existingData.population !== undefined && existingData.population !== null && existingData.population > 0)
                                ? existingData.population
                                : 0,
                        area: (data.area !== undefined && data.area !== null && data.area > 0)
                            ? data.area 
                            : (existingData.area !== undefined && existingData.area !== null && existingData.area > 0)
                                ? existingData.area
                                : 0,
                        // ê°€ê²©ì€ Firestore ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ nullë¡œ ì„¤ì •í•˜ì—¬ ë‚˜ì¤‘ì— í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
                        ad_price: existingData.ad_price !== undefined && existingData.ad_price !== null 
                            ? existingData.ad_price 
                            : (data.ad_price !== undefined && data.ad_price !== null && data.ad_price > 0 ? data.ad_price : null),
                        name_ko: data.name_ko || existingData.name_ko || '',
                        name_en: data.name_en || existingData.name_en || existingData.name || '',
                        country: data.country || existingData.country || '',
                        admin_level: data.admin_level || existingData.admin_level || '',
                        ad_status: data.ad_status || existingData.ad_status || 'available'
                    };
                    
                    if (Object.keys(existingData).length > 0) {
                        mergedCount++;
                    }
                    
                    this.regionData.set(regionId, mergedData);
                    loadedCount++;
                });
    
                console.log(`Firestore(${normalizedCountry || 'ALL'})ì—ì„œ ${loadedCount}ê°œì˜ ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ë³‘í•©: ${mergedCount}ê°œ)`);
    
                this.updateMapSourcesWithRegionData();
                return { loadedCount, mergedCount, country: normalizedCountry || 'ALL' };
            } catch (error) {
                console.error('Firestore ì§€ì—­ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
                throw error;
            }
        })();

        this.regionDataLoadState.set(cacheKey, { status: 'loading', promise: loadPromise });

        try {
            const result = await loadPromise;
            this.regionDataLoadState.set(cacheKey, { status: 'loaded', result, timestamp: Date.now() });
            return result;
        } catch (error) {
            this.regionDataLoadState.delete(cacheKey);
            // ì˜¤ë¥˜ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰ (ë¡œì»¬ ë°ì´í„° ì‚¬ìš©)
            return null;
        }
    }

    // ì§€ë„ ì†ŒìŠ¤ë“¤ì„ regionDataë¡œ ì—…ë°ì´íŠ¸
    updateMapSourcesWithRegionData() {
        if (!this.map) return;

        // ëª¨ë“  ê°€ëŠ¥í•œ ì†ŒìŠ¤ ID ëª©ë¡
        const sourceIds = [
            'world-regions', 'korea-regions', 'japan-regions', 'china-regions',
            'russia-regions', 'india-regions', 'canada-regions', 'germany-regions',
            'uk-regions', 'france-regions', 'italy-regions', 'brazil-regions',
            'australia-regions', 'mexico-regions', 'indonesia-regions',
            'saudi-arabia-regions', 'turkey-regions', 'south-africa-regions',
            'argentina-regions', 'european-union-regions', 'spain-regions',
            'netherlands-regions', 'poland-regions', 'belgium-regions',
            'sweden-regions', 'austria-regions', 'denmark-regions',
            'finland-regions', 'ireland-regions', 'portugal-regions',
            'greece-regions', 'czech-republic-regions', 'romania-regions',
            'hungary-regions', 'bulgaria-regions'
        ];

        sourceIds.forEach(sourceId => {
            const source = this.map.getSource(sourceId);
            if (source && source._data && source._data.features) {
                let updated = false;
                source._data.features.forEach(feature => {
                    const regionId = feature.properties.id;
                    if (regionId && this.regionData.has(regionId)) {
                        const updatedData = this.regionData.get(regionId);
                        Object.assign(feature.properties, updatedData);
                        updated = true;
                    }
                });
                
                if (updated) {
                    source.setData(source._data);
                }
            }
        });
    }

    // ëª¨ë“  ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ 1000ë‹¬ëŸ¬ë¡œ í†µì¼
    /**
     * ëª¨ë“  ì§€ì—­ì˜ ê°€ê²©ì„ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í•˜ì—¬ ì„¤ì •
     * í”½ì…€ 1ê°œ = 0.1ë‹¬ëŸ¬ (PIXEL_PRICE_PER_UNIT)
     * ë°°ì¹˜ ì²˜ë¦¬ë¡œ ë™ì‹œ ìš”ì²­ ìˆ˜ë¥¼ ì œí•œí•˜ì—¬ "Too many outstanding requests" ì˜¤ë¥˜ ë°©ì§€
     */
    async setAllRegionsPriceBasedOnPixels() {
        let updatedCount = 0;
        const regionEntries = Array.from(this.regionData.entries());
        const BATCH_SIZE = 10; // ë™ì‹œì— ì²˜ë¦¬í•  ìµœëŒ€ ìš”ì²­ ìˆ˜
        const DELAY_BETWEEN_BATCHES = 100; // ë°°ì¹˜ ê°„ ì§€ì—° ì‹œê°„ (ms)
        
        // ë°°ì¹˜ë¡œ ë‚˜ëˆ„ì–´ ì²˜ë¦¬
        for (let i = 0; i < regionEntries.length; i += BATCH_SIZE) {
            const batch = regionEntries.slice(i, i + BATCH_SIZE);
            const batchPromises = batch.map(([regionId, regionData]) => {
                // ê° ì§€ì—­ì˜ ê°€ê²© ê³„ì‚°ì„ Promiseë¡œ ë§Œë“¤ì–´ ë³‘ë ¬ ì²˜ë¦¬
                return this.getStartingPriceForRegion(regionId)
                    .then(calculatedPrice => {
                        // ê°€ê²©ì´ ë³€ê²½ë˜ì—ˆê±°ë‚˜ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° ì—…ë°ì´íŠ¸
                        if (regionData.ad_price !== calculatedPrice) {
                            regionData.ad_price = calculatedPrice;
                            this.regionData.set(regionId, regionData);
                            return 1; // ì—…ë°ì´íŠ¸ë¨
                        }
                        return 0; // ì—…ë°ì´íŠ¸ ì•ˆë¨
                    })
                    .catch(err => {
                        // ì˜¤í”„ë¼ì¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                        if (err.code !== 'unavailable' && err.code !== 'resource-exhausted' && 
                            !err.message?.includes('offline') && !err.message?.includes('Too many outstanding requests')) {
                            console.warn(`[ê°€ê²© ê³„ì‚° ì‹¤íŒ¨] ${regionId}:`, err);
                        }
                        return 0;
                    });
            });
            
            // í˜„ì¬ ë°°ì¹˜ê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            const batchResults = await Promise.all(batchPromises);
            updatedCount += batchResults.reduce((sum, count) => sum + count, 0);
            
            // ë§ˆì§€ë§‰ ë°°ì¹˜ê°€ ì•„ë‹ˆë©´ ë‹¤ìŒ ë°°ì¹˜ ì „ì— ì ì‹œ ëŒ€ê¸° (Firestore ë¶€í•˜ ê°ì†Œ)
            if (i + BATCH_SIZE < regionEntries.length) {
                await new Promise(resolve => setTimeout(resolve, DELAY_BETWEEN_BATCHES));
            }
        }

        // ì§€ë„ ì†ŒìŠ¤ë„ ì—…ë°ì´íŠ¸
        this.updateMapSourcesWithRegionData();

        console.log(`${updatedCount}ê°œ ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°í–ˆìŠµë‹ˆë‹¤. (í”½ì…€ë‹¹ $${this.PIXEL_PRICE_PER_UNIT})`);
        return updatedCount;
    }
    
    /**
     * @deprecated - í”½ì…€ ìˆ˜ ê¸°ë°˜ ê°€ê²© ê³„ì‚°ì„ ì‚¬ìš©í•˜ì„¸ìš” (setAllRegionsPriceBasedOnPixels)
     * ëª¨ë“  ì§€ì—­ ê°€ê²©ì„ í†µì¼ëœ ê°€ê²©ìœ¼ë¡œ ì„¤ì • (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
     */
    setAllRegionsPriceToUniform() {
        // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê°€ê²© ê³„ì‚°ìœ¼ë¡œ ëŒ€ì²´
        this.setAllRegionsPriceBasedOnPixels().catch(err => {
            console.error('[ê°€ê²© ê³„ì‚° ì˜¤ë¥˜]', err);
            // ì˜¤ë¥˜ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
            let updatedCount = 0;
            this.regionData.forEach((regionData, regionId) => {
                if (regionData.ad_price !== this.uniformAdPrice) {
                    regionData.ad_price = this.uniformAdPrice;
                    this.regionData.set(regionId, regionData);
                    updatedCount++;
                }
            });
            this.updateMapSourcesWithRegionData();
            console.log(`${updatedCount}ê°œ ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ ${this.uniformAdPrice}ë‹¬ëŸ¬ë¡œ í†µì¼í–ˆìŠµë‹ˆë‹¤.`);
        });
    }

    // ì§€ë„ì— ë¡œë“œëœ ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
    collectAllRegionsFromMapSources() {
        if (!this.map) {
            console.warn('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return 0;
        }

        let collectedCount = 0;
        let preservedCount = 0;
        
        // ëª¨ë“  ê°€ëŠ¥í•œ ì†ŒìŠ¤ ID ëª©ë¡
        const sourceIds = [
            'world-regions', 'korea-regions', 'japan-regions', 'china-regions',
            'russia-regions', 'india-regions', 'canada-regions', 'germany-regions',
            'uk-regions', 'france-regions', 'italy-regions', 'brazil-regions',
            'australia-regions', 'mexico-regions', 'indonesia-regions',
            'saudi-arabia-regions', 'turkey-regions', 'south-africa-regions',
            'argentina-regions', 'european-union-regions', 'spain-regions',
            'netherlands-regions', 'poland-regions', 'belgium-regions',
            'sweden-regions', 'austria-regions', 'denmark-regions',
            'finland-regions', 'ireland-regions', 'portugal-regions',
            'greece-regions', 'czech-republic-regions', 'romania-regions',
            'hungary-regions', 'bulgaria-regions'
        ];

        // ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        sourceIds.forEach(sourceId => {
            const source = this.map.getSource(sourceId);
            if (source && source._data && source._data.features) {
                source._data.features.forEach(feature => {
                    const props = feature.properties;
                    const regionId = props.id;
                    
                    if (regionId) {
                        // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë³‘í•©, ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
                        const existingData = this.regionData.get(regionId) || {};
                        
                        // Firestoreì—ì„œ ë¶ˆëŸ¬ì˜¨ ì¸êµ¬/ë©´ì  ë°ì´í„°ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ìœ ì§€
                        const firestorePopulation = existingData.population && existingData.population > 0 ? existingData.population : null;
                        const firestoreArea = existingData.area && existingData.area > 0 ? existingData.area : null;
                        
                        // ë©´ì  ê³„ì‚° (ì—†ìœ¼ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°)
                        let calculatedArea = firestoreArea !== null ? firestoreArea : 
                                            (props.area !== undefined && props.area !== null && props.area > 0 ? props.area : 0);
                        
                        // ë©´ì ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°
                        if (calculatedArea <= 0 && feature.geometry) {
                            calculatedArea = this.calculatePolygonArea(feature);
                            if (calculatedArea > 0) {
                                console.log(`[ë©´ì  ê³„ì‚°] ${regionId}: ${calculatedArea.toFixed(2)} kmÂ²`);
                            }
                        }
                        
                        // GeoJSON propertiesì—ì„œ ì§€ì—­ ë°ì´í„° ì¶”ì¶œ
                        const regionData = {
                            id: regionId,
                            // ê¸°ë³¸ ì •ë³´ëŠ” GeoJSONì—ì„œ ê°€ì ¸ì˜¤ë˜, Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€
                            name_ko: existingData.name_ko || props.name_ko || '',
                            name_en: existingData.name_en || props.name_en || props.name || '',
                            country: existingData.country || props.country || '',
                            admin_level: existingData.admin_level || props.admin_level || '',
                            // ì¸êµ¬/ë©´ì ì€ Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ìœ ì§€, ì—†ìœ¼ë©´ ê¸°ì¡´ ë°ì´í„° ìœ ì§€, ì—†ìœ¼ë©´ GeoJSON ì‚¬ìš©, ì—†ìœ¼ë©´ ê³„ì‚°
                            population: firestorePopulation !== null && firestorePopulation > 0 
                                ? firestorePopulation 
                                : (existingData.population !== undefined && existingData.population !== null && existingData.population > 0 
                                    ? existingData.population 
                                    : (props.population !== undefined && props.population !== null && props.population > 0 ? props.population : 0)),
                            area: firestoreArea !== null && firestoreArea > 0
                                ? firestoreArea
                                : (calculatedArea > 0 ? calculatedArea : (existingData.area !== undefined && existingData.area !== null && existingData.area > 0 ? existingData.area : 0)),
                            // ê°€ê²©ì€ ê¸°ì¡´ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                            ad_price: existingData.ad_price !== undefined && existingData.ad_price !== null ? existingData.ad_price : (props.ad_price !== undefined && props.ad_price !== null ? props.ad_price : null), // nullë¡œ ì„¤ì •í•˜ì—¬ ë‚˜ì¤‘ì— í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
                            ad_status: existingData.ad_status || props.ad_status || (props.occupied ? 'occupied' : 'available')
                        };
                        
                        // ê°€ê²©ì´ ì—†ìœ¼ë©´ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚° (ë¹„ë™ê¸°, ê²°ê³¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
                        if (regionData.ad_price === null && calculatedArea > 0) {
                            // í”½ì…€ ê·¸ë¦¬ë“œê°€ ì—†ìœ¼ë©´ ìƒì„± ì‹œë„
                            if (!this.pixelGrids.has(regionId)) {
                                try {
                                    const pixelGrid = this.createPixelGrid(feature, this.pixelGridGridSize);
                                    if (pixelGrid && pixelGrid.pixelCount) {
                                        const calculatedPrice = this.calculateStartingPriceFromPixels(pixelGrid.pixelCount);
                                        regionData.ad_price = calculatedPrice;
                                        // í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ (ë¹„ë™ê¸°, ê²°ê³¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
                                        this.savePixelGrid(regionId, pixelGrid).catch(err => {
                                            console.warn(`[ê°€ê²© ê³„ì‚°] í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ ì‹¤íŒ¨ (ë¬´ì‹œ):`, err);
                                        });
                                    }
                                } catch (err) {
                                    console.warn(`[ê°€ê²© ê³„ì‚°] í”½ì…€ ê·¸ë¦¬ë“œ ìƒì„± ì‹¤íŒ¨:`, err);
                                }
                            } else {
                                // ì´ë¯¸ í”½ì…€ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ ê°€ê²© ê³„ì‚°
                                const pixelGrid = this.pixelGrids.get(regionId);
                                if (pixelGrid && pixelGrid.pixelCount) {
                                    regionData.ad_price = this.calculateStartingPriceFromPixels(pixelGrid.pixelCount);
                                }
                            }
                        }
                        
                        // ì—¬ì „íˆ ê°€ê²©ì´ ì—†ìœ¼ë©´ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚° ì‹œë„, ì‹¤íŒ¨ ì‹œ ìµœì†Œê°’ ì‚¬ìš©
                        if (regionData.ad_price === null || regionData.ad_price === undefined || regionData.ad_price === 0) {
                            // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê³„ì‚°ì€ ì´ë¯¸ ìœ„ì—ì„œ ì‹œë„í–ˆìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ìµœì†Œê°’ ì‚¬ìš©
                            // (í”½ì…€ ê·¸ë¦¬ë“œê°€ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„í•œ í´ë°±)
                            regionData.ad_price = 1.0; // ìµœì†Œ ì‹œì‘ê°€ê²©
                        }

                        // Firestore ë°ì´í„°ë¥¼ ë³´ì¡´í–ˆëŠ”ì§€ í™•ì¸
                        if (firestorePopulation !== null || firestoreArea !== null) {
                            preservedCount++;
                        }

                        // ìƒˆë¡œìš´ ë°ì´í„°ë§Œ ì¹´ìš´íŠ¸
                        if (!this.regionData.has(regionId)) {
                            collectedCount++;
                        }
                        
                        this.regionData.set(regionId, regionData);
                    }
                });
            }
        });

        console.log(`ì§€ë„ ì†ŒìŠ¤ì—ì„œ ${collectedCount}ê°œì˜ ìƒˆë¡œìš´ ì§€ì—­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤. (Firestore ë°ì´í„° ë³´ì¡´: ${preservedCount}ê°œ)`);
        return collectedCount;
    }

    // ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì¼ê´„ ì €ì¥
    async saveAllRegionsToFirestore() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì§€ì—­ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: 0 };
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        if (!this.currentUser) {
            console.warn('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ Firestoreì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            this.showNotification('Firestoreì— ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.', 'warning');
            return { success: 0, failed: 0 };
        }

        try {
            // ë¨¼ì € ì§€ë„ì— ë¡œë“œëœ ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
            const collectedCount = this.collectAllRegionsFromMapSources();
            console.log(`ì´ ìˆ˜ì§‘ëœ ì§€ì—­: ${this.regionData.size}ê°œ (ì‹ ê·œ: ${collectedCount}ê°œ)`);

            const { doc, setDoc, serverTimestamp, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            let successCount = 0;
            let failedCount = 0;
            const batchSize = 500; // Firestore ë°°ì¹˜ ì œí•œ (500ê°œ)
            const regions = Array.from(this.regionData.entries());
            const totalRegions = regions.length;

            this.showNotification(`ì´ ${totalRegions}ê°œ ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥ ì¤‘...`, 'info');

            // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ì €ì¥
            for (let i = 0; i < regions.length; i += batchSize) {
                const batch = writeBatch(this.firestore);
                const batchRegions = regions.slice(i, i + batchSize);
                
                for (const [regionId, regionData] of batchRegions) {
                    try {
                        // ì €ì¥í•  ë°ì´í„° (Firestoreì— ì €ì¥í•  í•„ë“œë§Œ ì¶”ì¶œ)
                        const firestoreData = {
                            regionId: regionId,
                            name_ko: regionData.name_ko || '',
                            name_en: regionData.name_en || regionData.name || '',
                            country: regionData.country || '',
                            admin_level: regionData.admin_level || '',
                            population: regionData.population || 0,
                            area: regionData.area || 0,
                            // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê°€ê²© ì‚¬ìš© (ì—†ìœ¼ë©´ ìµœì†Œê°’)
                            ad_price: regionData.ad_price && regionData.ad_price > 0 ? regionData.ad_price : 1.0,
                            ad_status: regionData.ad_status || 'available',
                            updatedAt: serverTimestamp()
                        };

                        const regionRef = doc(this.firestore, 'regions', regionId);
                        batch.set(regionRef, firestoreData, { merge: true });
                    } catch (error) {
                        console.error(`ì§€ì—­ ${regionId} ë°°ì¹˜ ì¶”ê°€ ì˜¤ë¥˜:`, error);
                        failedCount++;
                    }
                }

                try {
                    await batch.commit();
                    successCount += batchRegions.length;
                    console.log(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì €ì¥ ì™„ë£Œ: ${batchRegions.length}ê°œ ì§€ì—­`);
                    
                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    const progress = Math.round((successCount / totalRegions) * 100);
                    this.showNotification(`Firestore ì €ì¥ ì¤‘... ${progress}% (${successCount}/${totalRegions})`, 'info');
                } catch (error) {
                    console.error(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì €ì¥ ì˜¤ë¥˜:`, error);
                    
                    // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° ë” ìì„¸í•œ ì •ë³´ ì¶œë ¥
                    if (error.code === 'permission-denied' || error.message?.includes('permissions')) {
                        console.error('Firestore ê¶Œí•œ ì˜¤ë¥˜:', error);
                        console.error('- ë¡œê·¸ì¸ ìƒíƒœ:', this.currentUser ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ ì•ˆë¨');
                        console.error('- ì‚¬ìš©ì ì´ë©”ì¼:', this.currentUser?.email || 'ì—†ìŒ');
                        console.error('- Firestore ê·œì¹™ í™•ì¸: regions ì»¬ë ‰ì…˜ì— ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        this.showNotification(`Firestore ê¶Œí•œ ì˜¤ë¥˜: ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”. (í˜„ì¬: ${this.currentUser ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ ì•ˆë¨'})`, 'error');
                    } else {
                        this.showNotification(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì €ì¥ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                    
                    failedCount += batchRegions.length;
                }
            }

            this.showNotification(`Firestore ì €ì¥ ì™„ë£Œ: ${successCount}ê°œ ì„±ê³µ, ${failedCount}ê°œ ì‹¤íŒ¨`, successCount > 0 ? 'success' : 'error');
            console.log(`ëª¨ë“  ì§€ì—­ ë°ì´í„° Firestore ì €ì¥ ì™„ë£Œ: ${successCount}ê°œ ì„±ê³µ, ${failedCount}ê°œ ì‹¤íŒ¨`);
            
            this.recordAdminAudit('region.bulk_save', {
                success: successCount,
                failed: failedCount,
                total: totalRegions
            });
            
            return { success: successCount, failed: failedCount, collected: collectedCount };
        } catch (error) {
            console.error('ëª¨ë“  ì§€ì—­ ë°ì´í„° Firestore ì €ì¥ ì˜¤ë¥˜:', error);
            this.showNotification('Firestore ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: this.regionData.size, collected: 0 };
        }
    }

    // ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ ë™ê¸°í™” (ê°€ê²© í†µì¼ + Firestore ì €ì¥)
    async syncAllRegionsToFirestore() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: 0, collected: 0, priceUpdated: 0 };
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        if (!this.currentUser) {
            this.showNotification('Firestoreì— ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.', 'warning');
            // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
            const userLoginModal = document.getElementById('user-login-modal');
            if (userLoginModal) {
                userLoginModal.classList.remove('hidden');
            }
            return { success: 0, failed: 0, collected: 0, priceUpdated: 0 };
        }

        try {
            this.showNotification('ì „ì„¸ê³„ ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...', 'info');
            
            // 1. ë¨¼ì € Firestoreì—ì„œ ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
            const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionsSnapshot = await getDocs(collection(this.firestore, 'regions'));
            
            // Firestore ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ë¡œ ë¡œë“œ (ì¸êµ¬/ë©´ì  ë°ì´í„° ë³´ì¡´)
            const firestoreDataMap = new Map();
            regionsSnapshot.forEach((doc) => {
                const data = doc.data();
                const regionId = data.regionId || doc.id;
                firestoreDataMap.set(regionId, {
                    population: data.population || 0,
                    area: data.area || 0,
                    name_ko: data.name_ko || '',
                    name_en: data.name_en || '',
                    country: data.country || '',
                    admin_level: data.admin_level || '',
                    ad_status: data.ad_status || 'available'
                });
            });
            
            console.log(`Firestoreì—ì„œ ${firestoreDataMap.size}ê°œ ì§€ì—­ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            
            // 2. ëª¨ë“  êµ­ê°€ì˜ ë°ì´í„°ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¡œë“œ (ì§€ë„ì— í‘œì‹œí•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ë§Œ ìˆ˜ì§‘)
            this.showNotification('ëª¨ë“  êµ­ê°€ì˜ í–‰ì •êµ¬ì—­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì¤‘...', 'info');
            await this.loadAllCountriesDataForSync();
            
            // 3. ì§€ë„ ì†ŒìŠ¤ì—ì„œ ëª¨ë“  ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘ (ëª¨ë“  êµ­ê°€ í¬í•¨)
            const collectedCount = this.collectAllRegionsFromMapSources();
            console.log(`ì§€ë„ ì†ŒìŠ¤ì—ì„œ ${collectedCount}ê°œ ìƒˆë¡œìš´ ì§€ì—­ì„ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.`);
            
            // 4. Firestore ë°ì´í„°ì™€ ì§€ë„ ì†ŒìŠ¤ ë°ì´í„° ë³‘í•© (Firestore ì¸êµ¬/ë©´ì  ë°ì´í„° ìš°ì„ )
            let mergeCount = 0;
            this.regionData.forEach((regionData, regionId) => {
                const firestoreData = firestoreDataMap.get(regionId);
                if (firestoreData) {
                    // Firestoreì— ì €ì¥ëœ ì¸êµ¬/ë©´ì  ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€
                    if (firestoreData.population > 0) {
                        regionData.population = firestoreData.population;
                    }
                    if (firestoreData.area > 0) {
                        regionData.area = firestoreData.area;
                    }
                    // ê¸°íƒ€ í•„ë“œë„ Firestore ë°ì´í„° ìš°ì„ 
                    if (firestoreData.name_ko) regionData.name_ko = firestoreData.name_ko;
                    if (firestoreData.name_en) regionData.name_en = firestoreData.name_en;
                    if (firestoreData.country) regionData.country = firestoreData.country;
                    if (firestoreData.admin_level) regionData.admin_level = firestoreData.admin_level;
                    if (firestoreData.ad_status) regionData.ad_status = firestoreData.ad_status;
                    mergeCount++;
                }
                
                // 5. ëª¨ë“  ì§€ì—­ ê°€ê²©ì„ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ê³„ì‚°
                // (collectAllRegionsFromMapSourcesì—ì„œ ì´ë¯¸ ê³„ì‚°ë˜ì—ˆì„ ìˆ˜ ìˆìŒ)
                if (!regionData.ad_price || regionData.ad_price === 0) {
                    // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê°€ê²© ê³„ì‚° (ë¹„ë™ê¸°ì´ì§€ë§Œ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
                    this.getStartingPriceForRegion(regionId).then(calculatedPrice => {
                        if (calculatedPrice && calculatedPrice > 0) {
                            regionData.ad_price = calculatedPrice;
                            this.regionData.set(regionId, regionData);
                        }
                    }).catch(err => {
                        // ì˜¤í”„ë¼ì¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                        if (err.code !== 'unavailable' && err.code !== 'resource-exhausted' && 
                            !err.message?.includes('offline') && !err.message?.includes('Too many outstanding requests')) {
                            console.warn(`[ê°€ê²© ê³„ì‚° ì‹¤íŒ¨] ${regionId}:`, err);
                        }
                        // ì‹¤íŒ¨ ì‹œ ìµœì†Œê°’ ì‚¬ìš©
                        regionData.ad_price = 1.0;
                        this.regionData.set(regionId, regionData);
                    });
                }
                this.regionData.set(regionId, regionData);
            });
            
            console.log(`${mergeCount}ê°œ ì§€ì—­ì˜ Firestore ë°ì´í„°ë¥¼ ë³‘í•©í–ˆìŠµë‹ˆë‹¤. ì´ ${this.regionData.size}ê°œ ì§€ì—­ì´ ìˆìŠµë‹ˆë‹¤.`);
            
            // 6. ëª¨ë“  ì§€ì—­ ê°€ê²©ì„ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì¬ê³„ì‚° (ë¹„ë™ê¸°)
            this.setAllRegionsPriceBasedOnPixels().then(updatedCount => {
                console.log(`[ê°€ê²© ì¬ê³„ì‚°] ${updatedCount}ê°œ ì§€ì—­ì˜ ê°€ê²©ì„ í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.`);
            }).catch(err => {
                console.error('[ê°€ê²© ì¬ê³„ì‚° ì˜¤ë¥˜]', err);
            });
            
            // 7. ì§€ë„ ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
            this.updateMapSourcesWithRegionData();
            
            // 7. ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥
            const result = await this.saveAllRegionsToFirestore();
            const output = { 
                ...result, 
                priceUpdated: this.regionData.size,
                merged: mergeCount 
            };

            this.recordAdminAudit('region.bulk_sync', {
                priceUpdated: output.priceUpdated,
                success: output.success,
                failed: output.failed,
                collected: output.collected,
                merged: output.merged
            });
            
            return output;
        } catch (error) {
            console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
            this.showNotification('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: 0, collected: 0, priceUpdated: 0 };
        }
    }

    // ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ë™ê¸°í™”ìš©ìœ¼ë¡œ ë¡œë“œ (ì§€ë„ì— í‘œì‹œí•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ì—ë§Œ ìˆ˜ì§‘)
    async loadAllCountriesDataForSync() {
        if (!this.map) {
            console.warn('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        const loadFunctions = [
            () => this.loadWorldData(),
            () => this.loadKoreaData(),
            () => this.loadJapanData(),
            () => this.loadChinaData(),
            () => this.loadRussiaData(),
            () => this.loadIndiaData(),
            () => this.loadCanadaData(),
            () => this.loadGermanyData(),
            () => this.loadUKData(),
            () => this.loadFranceData(),
            () => this.loadItalyData(),
            () => this.loadBrazilData(),
            () => this.loadAustraliaData(),
            () => this.loadMexicoData(),
            () => this.loadIndonesiaData(),
            () => this.loadSaudiArabiaData(),
            () => this.loadTurkeyData(),
            () => this.loadSouthAfricaData(),
            () => this.loadArgentinaData(),
            () => this.loadEuropeanUnionData(),
            () => this.loadSpainData(),
            () => this.loadNetherlandsData(),
            () => this.loadPolandData(),
            () => this.loadBelgiumData(),
            () => this.loadSwedenData(),
            () => this.loadAustriaData(),
            () => this.loadDenmarkData(),
            () => this.loadFinlandData(),
            () => this.loadIrelandData(),
            () => this.loadPortugalData(),
            () => this.loadGreeceData(),
            () => this.loadCzechRepublicData(),
            () => this.loadRomaniaData(),
            () => this.loadHungaryData(),
            () => this.loadBulgariaData()
        ];

        // ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë™ì‹œì— ë¡œë“œ (ì—ëŸ¬ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰)
        const loadPromises = loadFunctions.map(async (loadFn, index) => {
            try {
                await loadFn();
                console.log(`êµ­ê°€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${index + 1}/${loadFunctions.length}`);
                return true;
            } catch (error) {
                console.warn(`êµ­ê°€ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ (ê³„ì† ì§„í–‰):`, error);
                return false;
            }
        });

        // ëª¨ë“  ë¡œë“œ ì‘ì—…ì´ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°
        const results = await Promise.all(loadPromises);
        const loadedCount = results.filter(r => r === true).length;

        console.log(`ì´ ${loadedCount}ê°œ êµ­ê°€ì˜ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
    }
    
    /**
     * ì˜¥ì…˜ ìƒíƒœ ì •ë³´ë¥¼ featureì— ì¶”ê°€
     */
    async enrichFeaturesWithAuctionStatus(features) {
        if (!this.isFirebaseInitialized || !this.firestore || features.length === 0) {
            return;
        }
        
        try {
            const { collection, query, getDocs, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionsRef = collection(this.firestore, 'auctions');
            
            // ëª¨ë“  í™œì„± ì˜¥ì…˜ ì¡°íšŒ
            const activeQuery = query(auctionsRef);
            const snapshot = await getDocs(activeQuery);
            const auctionMap = new Map();
            
            const now = Timestamp.now();
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                const regionId = doc.id;
                let status = 'none';
                
                if (data.status === 'active') {
                    // ì¢…ë£Œ ì‹œê°„ í™•ì¸
                    if (data.endTime) {
                        const endTime = data.endTime.toMillis ? data.endTime.toMillis() : data.endTime;
                        const timeRemaining = endTime - now.toMillis();
                        
                        if (timeRemaining > 0) {
                            status = 'active'; // ì§„í–‰ ì¤‘
                        } else {
                            status = 'ended'; // ì¢…ë£Œë¨
                        }
                    } else {
                        status = 'active';
                    }
                } else if (data.status === 'sold') {
                    status = 'sold'; // íŒë§¤ ì™„ë£Œ
                } else if (data.status === 'ended') {
                    status = 'ended'; // ì¢…ë£Œë¨
                }
                
                auctionMap.set(regionId, status);
            });
            
            // ê° featureì— ì˜¥ì…˜ ìƒíƒœ ì¶”ê°€
            features.forEach(feature => {
                if (feature.properties) {
                    const regionId = feature.properties.id || feature.properties.regionId || feature.properties.stateId;
                    if (regionId && auctionMap.has(regionId)) {
                        feature.properties.auction_status = auctionMap.get(regionId);
                    } else {
                        feature.properties.auction_status = 'none';
                    }
                }
            });
            
            console.log(`[ì˜¥ì…˜ ìƒíƒœ ì¶”ê°€] ${auctionMap.size}ê°œ ì˜¥ì…˜ ìƒíƒœ ì ìš© ì™„ë£Œ`);
        } catch (error) {
            console.error('[ì˜¥ì…˜ ìƒíƒœ ì¶”ê°€ ì‹¤íŒ¨]:', error);
            // ì‹¤íŒ¨í•´ë„ ê¸°ë³¸ê°’ ì„¤ì •
            features.forEach(feature => {
                if (feature.properties) {
                    feature.properties.auction_status = 'none';
                }
            });
        }
    }
    
    // ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ í•œêº¼ë²ˆì— ë¡œë“œí•˜ì—¬ ì§€ë„ì— í‘œì‹œ
    async loadAllCountriesForDisplay() {
        if (!this.map) {
            console.warn('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const allFeatures = [];
        
        // êµ­ê°€ë³„ ë¡œë“œ í•¨ìˆ˜ì™€ ìºì‹œ í‚¤ ë§¤í•‘
        const countryConfig = [
            { name: 'USA', key: 'usa', loadFn: () => this.loadWorldData() },
            { name: 'South Korea', key: 'korea', loadFn: () => this.loadKoreaData() },
            { name: 'Japan', key: 'japan', loadFn: () => this.loadJapanData() },
            { name: 'China', key: 'china', loadFn: () => this.loadChinaData() },
            { name: 'Russia', key: 'russia', loadFn: () => this.loadRussiaData() },
            { name: 'India', key: 'india', loadFn: () => this.loadIndiaData() },
            { name: 'Canada', key: 'canada', loadFn: () => this.loadCanadaData() },
            { name: 'Germany', key: 'germany', loadFn: () => this.loadGermanyData() },
            { name: 'United Kingdom', key: 'uk', loadFn: () => this.loadUKData() },
            { name: 'France', key: 'france', loadFn: () => this.loadFranceData() },
            { name: 'Italy', key: 'italy', loadFn: () => this.loadItalyData() },
            { name: 'Brazil', key: 'brazil', loadFn: () => this.loadBrazilData() },
            { name: 'Australia', key: 'australia', loadFn: () => this.loadAustraliaData() },
            { name: 'Mexico', key: 'mexico', loadFn: () => this.loadMexicoData() },
            { name: 'Indonesia', key: 'indonesia', loadFn: () => this.loadIndonesiaData() },
            { name: 'Saudi Arabia', key: 'saudi-arabia', loadFn: () => this.loadSaudiArabiaData() },
            { name: 'Turkey', key: 'turkey', loadFn: () => this.loadTurkeyData() },
            { name: 'South Africa', key: 'south-africa', loadFn: () => this.loadSouthAfricaData() },
            { name: 'Argentina', key: 'argentina', loadFn: () => this.loadArgentinaData() },
            { name: 'European Union', key: 'european-union', loadFn: () => this.loadEuropeanUnionData() },
            { name: 'Spain', key: 'spain', loadFn: () => this.loadSpainData() },
            { name: 'Netherlands', key: 'netherlands', loadFn: () => this.loadNetherlandsData() },
            { name: 'Poland', key: 'poland', loadFn: () => this.loadPolandData() },
            { name: 'Belgium', key: 'belgium', loadFn: () => this.loadBelgiumData() },
            { name: 'Sweden', key: 'sweden', loadFn: () => this.loadSwedenData() },
            { name: 'Austria', key: 'austria', loadFn: () => this.loadAustriaData() },
            { name: 'Denmark', key: 'denmark', loadFn: () => this.loadDenmarkData() },
            { name: 'Finland', key: 'finland', loadFn: () => this.loadFinlandData() },
            { name: 'Ireland', key: 'ireland', loadFn: () => this.loadIrelandData() },
            { name: 'Portugal', key: 'portugal', loadFn: () => this.loadPortugalData() },
            { name: 'Greece', key: 'greece', loadFn: () => this.loadGreeceData() },
            { name: 'Czech Republic', key: 'czech-republic', loadFn: () => this.loadCzechRepublicData() },
            { name: 'Romania', key: 'romania', loadFn: () => this.loadRomaniaData() },
            { name: 'Hungary', key: 'hungary', loadFn: () => this.loadHungaryData() },
            { name: 'Bulgaria', key: 'bulgaria', loadFn: () => this.loadBulgariaData() }
        ];
        
        // ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë™ì‹œì— ë¡œë“œí•˜ì—¬ ìµœëŒ€í•œ ë¹ ë¥´ê²Œ ì²˜ë¦¬
        console.log(`[loadAllCountriesForDisplay] ${countryConfig.length}ê°œ êµ­ê°€ ë°ì´í„° ë™ì‹œ ë¡œë”© ì‹œì‘...`);
        const startTime = performance.now();
        
        // Promise.all()ì„ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ë¡œë“œ í•¨ìˆ˜ë¥¼ ë™ì‹œì— ì‹œì‘
        const loadPromises = countryConfig.map((config) => {
            // ê° êµ­ê°€ ë¡œë“œ í•¨ìˆ˜ë¥¼ ì¦‰ì‹œ ì‹œì‘ (await ì—†ì´ Promise ë°˜í™˜)
            const loadPromise = config.loadFn().catch(error => {
                console.warn(`[${config.name}] ë¡œë“œ ì‹¤íŒ¨:`, error);
                return null;
            });
            
            // ë¡œë“œ ì™„ë£Œ í›„ ìºì‹œì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            return loadPromise.then(() => {
                // ìºì‹œì—ì„œ GeoJSON ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const cachedData = this.cachedGeoJsonData[config.key];
                
                if (cachedData && cachedData.features && cachedData.features.length > 0) {
                    // ê° featureì— êµ­ê°€ë³„ ìƒ‰ìƒ ì ìš©
                    cachedData.features.forEach(feature => {
                        if (feature.properties) {
                            // êµ­ê°€ ì´ë¦„ ì •ê·œí™” (countryColors í‚¤ì™€ ì¼ì¹˜í•˜ë„ë¡)
                            const country = feature.properties.country || config.name;
                            // countryColorsì—ì„œ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” ìƒ‰ìƒ ì°¾ê¸°
                            let countryColor = this.countryColors[country] || this.countryColors[config.name];
                            // ì—¬ì „íˆ ì—†ìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒ ì‚¬ìš©
                            if (!countryColor) {
                                countryColor = '#4ecdc4'; // ê¸°ë³¸ ìƒ‰ìƒ
                                console.warn(`[ìƒ‰ìƒ] ${country} ë˜ëŠ” ${config.name}ì— ëŒ€í•œ ìƒ‰ìƒì„ ì°¾ì„ ìˆ˜ ì—†ì–´ ê¸°ë³¸ ìƒ‰ìƒ ì‚¬ìš©`);
                            }
                            feature.properties.country = country;
                            feature.properties.country_color = countryColor;
                            // ê¸°ë³¸ ìƒ‰ìƒë„ ì—…ë°ì´íŠ¸
                            feature.properties.color = countryColor;
                            // ë””ë²„ê¹…ì„ ìœ„í•œ ë¡œê·¸ (ì²˜ìŒ ëª‡ ê°œë§Œ)
                            if (cachedData.features.indexOf(feature) < 3) {
                                console.log(`[${config.name}] ìƒ‰ìƒ ì„¤ì •: ${country} -> ${countryColor}`);
                            }
                        }
                    });
                    console.log(`[${config.name}] ${cachedData.features.length}ê°œ í–‰ì •êµ¬ì—­ ë¡œë“œ ì™„ë£Œ (ìƒ‰ìƒ: ${cachedData.features[0]?.properties?.country_color || 'N/A'})`);
                    return cachedData.features;
                }
                return [];
            }).catch(error => {
                console.warn(`[${config.name}] ì²˜ë¦¬ ì‹¤íŒ¨:`, error);
                return [];
            });
        });
        
        // ëª¨ë“  êµ­ê°€ ë°ì´í„° ë¡œë“œê°€ ì™„ë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸° (ëª¨ë“  fetch ìš”ì²­ì´ ë™ì‹œì— ì‹œì‘ë¨)
        const allLoadedFeatures = await Promise.all(loadPromises);
        
        const loadTime = ((performance.now() - startTime) / 1000).toFixed(2);
        const totalFeatures = allLoadedFeatures.reduce((sum, features) => sum + (features?.length || 0), 0);
        console.log(`[loadAllCountriesForDisplay] ëª¨ë“  êµ­ê°€ ë°ì´í„° ë¡œë”© ì™„ë£Œ (${loadTime}ì´ˆ, ${totalFeatures}ê°œ í–‰ì •êµ¬ì—­)`);
        
        // ëª¨ë“  featuresë¥¼ í•˜ë‚˜ì˜ ë°°ì—´ë¡œ ë³‘í•©
        allLoadedFeatures.forEach(features => {
            allFeatures.push(...features);
        });
        
        // í†µí•©ëœ GeoJSON ìƒì„±
        let mergedGeoJson = {
            type: 'FeatureCollection',
            features: allFeatures
        };
        
        // GeoJSON ìµœì í™” ì ìš© (ë¶ˆí•„ìš”í•œ ì†ì„± ì œê±°)
        mergedGeoJson = this.optimizeGeoJson(mergedGeoJson);
        
        console.log(`[loadAllCountriesForDisplay] ì´ ${allFeatures.length}ê°œ í–‰ì •êµ¬ì—­ ë¡œë“œ ì™„ë£Œ`);
        
        // ì¿¼ë“œíŠ¸ë¦¬ ì¸ë±ìŠ¤ ì´ˆê¸°í™” (ì„±ëŠ¥ ìµœì í™”)
        this.initQuadtree(allFeatures);
        
        // world-regions ì†ŒìŠ¤ì— í†µí•©ëœ ë°ì´í„° ì„¤ì •
        if (this.map.getSource('world-regions')) {
            this.map.getSource('world-regions').setData(mergedGeoJson);
        } else {
            this.map.addSource('world-regions', {
                type: 'geojson',
                data: mergedGeoJson
            });
        }
        
        // ì˜¥ì…˜ ìƒíƒœ ì •ë³´ë¥¼ ê° featureì— ì¶”ê°€ (ë¹„ë™ê¸°ë¡œ ì‹¤í–‰, ì™„ë£Œ í›„ ì§€ë„ ì—…ë°ì´íŠ¸)
        // ì§€ë„ëŠ” ë¨¼ì € í‘œì‹œí•˜ê³  ì˜¥ì…˜ ìƒíƒœëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì—…ë°ì´íŠ¸ (ì„±ëŠ¥ ìµœì í™”)
        // ì´ˆê¸°ì—ëŠ” ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ í‘œì‹œí•˜ê³ , ì˜¥ì…˜ ìƒíƒœëŠ” ë‚˜ì¤‘ì— ì—…ë°ì´íŠ¸
        this.enrichFeaturesWithAuctionStatus(allFeatures).then(() => {
            // ì˜¥ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ í›„ ì§€ë„ ë ˆì´ì–´ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
            if (this.map && this.map.getLayer('regions-fill')) {
                const colorExpression = [
                    'case',
                    ['==', ['get', 'ad_status'], 'occupied'],
                    '#ff6b6b', // ì ìœ ëœ ì§€ì—­ì€ ë¹¨ê°„ìƒ‰
                    ['==', ['get', 'auction_status'], 'active'],
                    '#3498db', // ì§„í–‰ ì¤‘ì¸ ì˜¥ì…˜: íŒŒë€ìƒ‰
                    ['==', ['get', 'auction_status'], 'upcoming'],
                    '#f39c12', // ê³§ ì‹œì‘í•  ì˜¥ì…˜: ì£¼í™©ìƒ‰
                    ['==', ['get', 'auction_status'], 'ended'],
                    '#95a5a6', // ì¢…ë£Œëœ ì˜¥ì…˜: íšŒìƒ‰
                    ['==', ['get', 'auction_status'], 'sold'],
                    '#7f8c8d', // íŒë§¤ ì™„ë£Œ: ì–´ë‘ìš´ íšŒìƒ‰
                    ['coalesce', 
                        ['get', 'country_color'], 
                        ['get', 'color'],
                        '#4ecdc4' // ê¸°ë³¸ ìƒ‰ìƒ
                    ]
                ];
                this.map.setPaintProperty('regions-fill', 'fill-color', colorExpression);
                
                // ì†ŒìŠ¤ ë°ì´í„°ë„ ì—…ë°ì´íŠ¸ (ë°°ì¹˜ ì—…ë°ì´íŠ¸ë¡œ ì„±ëŠ¥ ìµœì í™”)
                if (this.map.getSource('world-regions')) {
                    // requestIdleCallbackì„ ì‚¬ìš©í•˜ì—¬ ë¸Œë¼ìš°ì €ê°€ ì—¬ìœ  ìˆì„ ë•Œ ì—…ë°ì´íŠ¸
                    if (window.requestIdleCallback) {
                        window.requestIdleCallback(() => {
                            if (this.map && this.map.getSource('world-regions')) {
                                this.map.getSource('world-regions').setData(mergedGeoJson);
                            }
                        }, { timeout: 1000 });
                    } else {
                        // requestIdleCallbackì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ëŠ” setTimeout ì‚¬ìš©
                        setTimeout(() => {
                            if (this.map && this.map.getSource('world-regions')) {
                                this.map.getSource('world-regions').setData(mergedGeoJson);
                            }
                        }, 100);
                    }
                }
            }
        }).catch(err => {
            console.warn('[ì˜¥ì…˜ ìƒíƒœ ì¶”ê°€ ì‹¤íŒ¨]:', err);
        });
        
        // ë ˆì´ì–´ ì„¤ì • (êµ­ê°€ë³„ ìƒ‰ìƒ + ì˜¥ì…˜ ìƒíƒœ ì ìš©)
        if (!this.map.getLayer('regions-fill')) {
            // ì˜¥ì…˜ ìƒíƒœì— ë”°ë¥¸ ìƒ‰ìƒ í‘œí˜„ì‹
            // ì§„í–‰ ì¤‘(active): íŒŒë€ìƒ‰ ê³„ì—´, ê³§ ì‹œì‘(upcoming): ë…¸ë€ìƒ‰ ê³„ì—´, ì¢…ë£Œ(ended/sold): íšŒìƒ‰, ê¸°ë³¸: êµ­ê°€ ìƒ‰ìƒ
            const colorExpression = [
                'case',
                ['==', ['get', 'ad_status'], 'occupied'],
                '#ff6b6b', // ì ìœ ëœ ì§€ì—­ì€ ë¹¨ê°„ìƒ‰
                ['==', ['get', 'auction_status'], 'active'],
                '#3498db', // ì§„í–‰ ì¤‘ì¸ ì˜¥ì…˜: íŒŒë€ìƒ‰
                ['==', ['get', 'auction_status'], 'upcoming'],
                '#f39c12', // ê³§ ì‹œì‘í•  ì˜¥ì…˜: ì£¼í™©ìƒ‰
                ['==', ['get', 'auction_status'], 'ended'],
                '#95a5a6', // ì¢…ë£Œëœ ì˜¥ì…˜: íšŒìƒ‰
                ['==', ['get', 'auction_status'], 'sold'],
                '#7f8c8d', // íŒë§¤ ì™„ë£Œ: ì–´ë‘ìš´ íšŒìƒ‰
                ['coalesce', 
                    ['get', 'country_color'], 
                    ['get', 'color'],
                    '#4ecdc4' // ê¸°ë³¸ ìƒ‰ìƒ
                ]
            ];
            
            // ì„±ëŠ¥ ìµœì í™”: ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë™ì  ë Œë”ë§
            this.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': colorExpression,
                    'fill-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 0.5,  // ë‚®ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ë°˜íˆ¬ëª…
                        3, 0.6,
                        5, 0.7,  // ê¸°ë³¸ ì¤Œ ë ˆë²¨
                        10, 0.8  // ë†’ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ë” ë¶ˆíˆ¬ëª…
                    ]
                },
                // ì„±ëŠ¥ ìµœì í™”: ë‚®ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ë‹¨ìˆœí™”
                minzoom: 0,
                maxzoom: 24
            });
            
            // ê²½ê³„ì„  ë ˆì´ì–´ ìµœì í™” (ì¤Œ ë ˆë²¨ì— ë”°ë¼ í‘œì‹œ)
            this.map.addLayer({
                id: 'regions-border',
                type: 'line',
                source: 'world-regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 0.3,  // ë‚®ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ì–‡ê²Œ
                        3, 0.5,
                        5, 1,    // ê¸°ë³¸ ì¤Œ ë ˆë²¨
                        8, 1.5,
                        10, 2    // ë†’ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ë‘ê»ê²Œ
                    ],
                    'line-opacity': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 0.3,  // ë‚®ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ê±°ì˜ ì•ˆ ë³´ì´ê²Œ
                        3, 0.5,
                        5, 0.7,
                        8, 0.9   // ë†’ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ì„ ëª…í•˜ê²Œ
                    ]
                },
                minzoom: 2,  // ì¤Œ ë ˆë²¨ 2 ì´ìƒì—ì„œë§Œ í‘œì‹œ (ì„±ëŠ¥ ìµœì í™”)
                maxzoom: 24
            });
            
            // ì¤Œ ë ˆë²¨ ë³€ê²½ ì‹œ ì„±ëŠ¥ ìµœì í™”
            this.map.on('zoom', () => {
                const zoom = this.map.getZoom();
                // ë‚®ì€ ì¤Œ ë ˆë²¨ì—ì„œëŠ” ê²½ê³„ì„  ìˆ¨ê¹€ (ì„±ëŠ¥ í–¥ìƒ)
                if (zoom < 2 && this.map.getLayer('regions-border')) {
                    this.map.setLayoutProperty('regions-border', 'visibility', 'none');
                } else if (zoom >= 2 && this.map.getLayer('regions-border')) {
                    this.map.setLayoutProperty('regions-border', 'visibility', 'visible');
                }
            });
            
            this.map.addLayer({
                id: 'regions-hover',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': '#feca57',
                    'fill-opacity': 0
                }
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            if (!this.eventListenersAdded) {
                this.setupEventListeners();
                this.eventListenersAdded = true;
            }
        } else {
            // ê¸°ì¡´ ë ˆì´ì–´ê°€ ìˆìœ¼ë©´ ìƒ‰ìƒ í‘œí˜„ì‹ ì—…ë°ì´íŠ¸ (ì˜¥ì…˜ ìƒíƒœ í¬í•¨)
            const colorExpression = [
                'case',
                ['==', ['get', 'ad_status'], 'occupied'],
                '#ff6b6b', // ì ìœ ëœ ì§€ì—­ì€ ë¹¨ê°„ìƒ‰
                ['==', ['get', 'auction_status'], 'active'],
                '#3498db', // ì§„í–‰ ì¤‘ì¸ ì˜¥ì…˜: íŒŒë€ìƒ‰
                ['==', ['get', 'auction_status'], 'upcoming'],
                '#f39c12', // ê³§ ì‹œì‘í•  ì˜¥ì…˜: ì£¼í™©ìƒ‰
                ['==', ['get', 'auction_status'], 'ended'],
                '#95a5a6', // ì¢…ë£Œëœ ì˜¥ì…˜: íšŒìƒ‰
                ['==', ['get', 'auction_status'], 'sold'],
                '#7f8c8d', // íŒë§¤ ì™„ë£Œ: ì–´ë‘ìš´ íšŒìƒ‰
                ['coalesce', 
                    ['get', 'country_color'], 
                    ['get', 'color'],
                    '#4ecdc4' // ê¸°ë³¸ ìƒ‰ìƒ
                ]
            ];
            this.map.setPaintProperty('regions-fill', 'fill-color', colorExpression);
        }
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        this.updateStatistics();
        
        // Wplace ìŠ¤íƒ€ì¼ í”½ì…€ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        if (this.map && mergedGeoJson) {
            this.initializePixelGridSystem(mergedGeoJson).catch(error => {
                console.error('[í”½ì…€ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì‹¤íŒ¨]:', error);
            });
        }
        
        return mergedGeoJson;
    }

    // ì‚¬ìš©ì ë¡œê·¸ì¸ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)
    async loginUser(email, password) {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await signInWithEmailAndPassword(this.firebaseAuth, email, password);
            this.showNotification('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            this.updateUserUI();
            this.hideUserLoginModal();
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ì— PayPal ë²„íŠ¼ ìë™ ë Œë”ë§
            if (this.currentRegion) {
                this.autoRenderPayPalButtons();
            }
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            const errorMsg = error.code === 'auth/user-not-found' ? 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.' 
                : error.code === 'auth/wrong-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.'
                : 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            this.showNotification(errorMsg, 'error');
        }
    }

    // ì‚¬ìš©ì íšŒì›ê°€ì…
    async signUpUser(email, password) {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await createUserWithEmailAndPassword(this.firebaseAuth, email, password);
            this.showNotification('íšŒì›ê°€ì… ì„±ê³µ!', 'success');
            this.updateUserUI();
        } catch (error) {
            console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
            const errorMsg = error.code === 'auth/email-already-in-use' ? 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'
                : error.code === 'auth/weak-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (ìµœì†Œ 6ì)'
                : 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            this.showNotification(errorMsg, 'error');
        }
    }
    
    // êµ¬ê¸€ ë¡œê·¸ì¸/íšŒì›ê°€ì…
    async signInWithGoogle() {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. index.htmlì—ì„œ firebaseConfigë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
            console.error('Firebase ì´ˆê¸°í™” ìƒíƒœ:', {
                isFirebaseInitialized: this.isFirebaseInitialized,
                firebaseAuth: this.firebaseAuth,
                firebaseConfig: window.firebaseModules?.firebaseConfig
            });
            return;
        }

        try {
            const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            const provider = new GoogleAuthProvider();
            const result = await signInWithPopup(this.firebaseAuth, provider);
            
            // ë¡œê·¸ì¸ ì„±ê³µ
            this.currentUser = result.user;
            this.updateUserUI();
            this.hideUserLoginModal();
            this.showNotification('êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            console.log('êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ:', result.user.email);
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ì— PayPal ë²„íŠ¼ ìë™ ë Œë”ë§
            if (this.currentRegion) {
                this.autoRenderPayPalButtons();
            }
        } catch (error) {
            // COOP ì˜¤ë¥˜ëŠ” ë¬´ì‹œ (ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•œ ê²½ê³ ì¼ ë¿, ì‹¤ì œ ê¸°ëŠ¥ì—ëŠ” ì˜í–¥ ì—†ìŒ)
            if (error.message && (error.message.includes('Cross-Origin-Opener-Policy') || 
                error.message.includes('window.close') || 
                error.message.includes('window.closed'))) {
                // ë¡œê·¸ì¸ì€ ì„±ê³µí–ˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¡°ìš©íˆ ì²˜ë¦¬
                // ì‚¬ìš©ì í™•ì¸ì„ ìœ„í•´ í˜„ì¬ ì‚¬ìš©ì ìƒíƒœ í™•ì¸
                if (this.firebaseAuth && this.firebaseAuth.currentUser) {
                    this.currentUser = this.firebaseAuth.currentUser;
                    this.updateUserUI();
                    this.hideUserLoginModal();
                }
                return;
            }
            console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            const errorMsg = error.code === 'auth/popup-closed-by-user' ? 'ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.'
                : error.code === 'auth/popup-blocked' ? 'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
                : 'êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            this.showNotification(errorMsg, 'error');
        }
    }

    // ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ
    async logoutUser() {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            return;
        }

        try {
            const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await signOut(this.firebaseAuth);
            this.showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            this.updateUserUI();
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
        }
    }

    async initializeMap() {
        // MapLibre GL JS ì´ˆê¸°í™” (ë¬´ë£Œ ì˜¤í”ˆì†ŒìŠ¤ ë²„ì „ ì‚¬ìš©)
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
        
        // 3D ì§€êµ¬ë³¸ ëª¨ë“œ í™œì„±í™” (ê¸°ë³¸ê°’)
        this.isGlobeMode = true;
        
        this.map = new mapboxgl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'raster-tiles': {
                        type: 'raster',
                        tiles: [
                            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                        ],
                        tileSize: 256,
                        wrapX: true, // ì§€êµ¬ë³¸ì´ë¼ ì–‘ìª½ ë ì—°ê²°
                        attribution: 'Â© Esri'
                    }
                },
                layers: [
                    {
                        id: 'background',
                        type: 'raster',
                        source: 'raster-tiles',
                        paint: {
                            'raster-opacity': 1,
                            'raster-brightness-min': 0.5,   // ì°¨ë¶„í•œ ë°ê¸° (ì•¼ê´‘ íš¨ê³¼ ì œê±°)
                            'raster-brightness-max': 0.85,  // ìµœëŒ€ ë°ê¸°ë„ ë‚®ì¶¤
                            'raster-saturation': 0.65,      // ì‹¤ì œ ìœ„ì„± ì§€ë„ì²˜ëŸ¼ ë‚®ì€ ì±„ë„
                            'raster-contrast': 0.35,        // ì„ ëª…í•œ ëŒ€ë¹„ë¡œ ì‹¤ì œ ì§€ë„ì²˜ëŸ¼
                            'raster-hue-rotate': -5,          // ì•½ê°„ ë”°ëœ»í•œ í†¤ (êµ¬ê¸€ ì–´ìŠ¤ ìŠ¤íƒ€ì¼)
                            'raster-resampling': 'linear'    // ë¶€ë“œëŸ¬ìš´ ë Œë”ë§
                        }
                    }
                ],
                sky: {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 12, // ì°¨ë¶„í•œ íƒœì–‘ ê°•ë„
                    'sky-atmosphere-color': [
                        'interpolate',
                        ['linear'],
                        ['sky-radial-progress'],
                        0.0, '#6BA8D6',  // ì§€í‰ì„  ê·¼ì²˜ëŠ” ì°¨ë¶„í•œ í•˜ëŠ˜ìƒ‰
                        0.3, '#4A6FA5',  // ì¤‘ê°„ì€ ì°¨ë¶„í•œ íŒŒë€ìƒ‰
                        0.7, '#2A3D5C',  // ë” ì§„í•œ ë‚¨ìƒ‰
                        1.0, '#0a0a1a'   // ìš°ì£¼ëŠ” ì–´ë‘ìš´ ë‚¨ìƒ‰
                    ],
                    'sky-atmosphere-halo-color': '#ffffff',
                    'sky-atmosphere-space-color': '#0a0a1a',
                    'sky-atmosphere-star-intensity': 0.5,
                    'sky-atmosphere-fog-density': 0.08, // ì•½ê°„ ë” ë‘êº¼ìš´ ëŒ€ê¸° (ìì—°ìŠ¤ëŸ¬ìš´ ëŠë‚Œ)
                    'sky-atmosphere-fog-height': 0.25 // ëŒ€ê¸° ë†’ì´ ì¦ê°€
                }
            },
            center: [0, 0], // ì§€êµ¬ë³¸ ì¤‘ì•™ìœ¼ë¡œ ì´ˆê¸°í™”
            zoom: 1.5, // ì „ì²´ ì§€êµ¬ë³¸ì´ ë³´ì´ë„ë¡ ì¤Œ ë ˆë²¨ ì¡°ì •
            maxZoom: 20, // ë” ë§ì´ í™•ëŒ€ ê°€ëŠ¥
            minZoom: 0.5, // ë” ë§ì´ ì¶•ì†Œ ê°€ëŠ¥ (ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸°)
            // ë¶€ë“œëŸ¬ìš´ ì¤Œ ì• ë‹ˆë©”ì´ì…˜
            transition: {
                duration: 400,
                delay: 0
            },
            // ì§€êµ¬ë³¸ ë Œë”ë§ ì˜µì…˜
            antialias: true,
            preserveDrawingBuffer: true,
            fadeDuration: 300,
            // 3D ì§€êµ¬ë³¸ ëª¨ë“œ í™œì„±í™”
            projection: 'globe',
            // ì´ˆê¸° ì‹œì•¼ê° ì„¤ì • (ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸°)
            pitch: 0,
            bearing: 0,
            // 2D ëª¨ë“œì—ì„œ ì„¸ê³„ì§€ë„ í•œ ë²ˆë§Œ í‘œì‹œ (3D ëª¨ë“œì—ëŠ” ì˜í–¥ ì—†ìŒ)
            renderWorldCopies: false
        });
        
        // ì§€ë„ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
        return new Promise((resolve) => {
            this.map.on('load', () => {
                console.log('ì§€ë„ ë¡œë“œ ì™„ë£Œ');
                
                // 3D ì§€êµ¬ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
                this.setupGlobeStyle();
                this.applyMapLighting();
                
                // ì¤Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¡œê³  í¬ê¸° ì¡°ì ˆìš©) - ìµœì í™”ëœ ë²„ì „
                this.map.on('zoomend', () => {
                    this.updateAllLogoSizes();
                });
                
                this.map.on('moveend', () => {
                    this.updateAllLogoSizes();
                });
                
                // 2D ëª¨ë“œì—ì„œ ìµœì†Œ ì¤Œ ì œí•œ (ì„¸ê³„ì§€ë„ê°€ ì—¬ëŸ¬ ë²ˆ ë³´ì´ì§€ ì•Šë„ë¡)
                this.map.on('zoom', () => {
                    if (!this.isGlobeMode && this.map.getZoom() < 1.5) {
                        this.map.setZoom(1.5);
                    }
                });
                
                // ì§€ë„ ë¡œë“œ í›„ ì´ˆê¸° ì¤Œ ì„¤ì • ë³´ì¥
                setTimeout(() => {
                    if (this.isGlobeMode) {
                        this.map.easeTo({
                            center: [0, 0],
                            zoom: 1.5,
                            pitch: 0,
                            duration: 1000
                        });
                    }
                }, 100);
                
                resolve();
            });
        });
    }
    
    // ê³µí†µ ìºì‹œ ë¡œë“œ í—¬í¼ í•¨ìˆ˜
    async loadGeoJsonWithCache(countryKey, loadFunction) {
        // 1. ë©”ëª¨ë¦¬ ìºì‹œ í™•ì¸
        if (this.cachedGeoJsonData[countryKey]) {
            console.log(`[${countryKey}] ë©”ëª¨ë¦¬ ìºì‹œ ì‚¬ìš©`);
            return this.ensureRegionIdentifiers(countryKey, this.cachedGeoJsonData[countryKey]);
        }
        
        // 2. IndexedDB ìºì‹œ í™•ì¸
        const cachedData = await this.getCachedGeoJson(countryKey);
        if (cachedData) {
            const preparedCachedData = this.ensureRegionIdentifiers(countryKey, cachedData);
            this.cachedGeoJsonData[countryKey] = preparedCachedData;
            console.log(`[${countryKey}] IndexedDB ìºì‹œ ì‚¬ìš©`);
            return preparedCachedData;
        }
        
        // 3. ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ
        console.log(`[${countryKey}] ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ`);
        const geoJsonData = await loadFunction();
        const preparedData = this.ensureRegionIdentifiers(countryKey, geoJsonData);
        
        // ë©”ëª¨ë¦¬ ìºì‹œì— ì €ì¥
        this.cachedGeoJsonData[countryKey] = preparedData;
        
        // IndexedDBì— ìºì‹œ ì €ì¥ (ë¹„ë™ê¸°, ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
        this.setCachedGeoJson(countryKey, preparedData).catch(err => {
            console.warn(`[${countryKey}] IndexedDB ìºì‹œ ì €ì¥ ì‹¤íŒ¨:`, err);
        });
        
        return preparedData;
    }
    
    // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionDataì— ì €ì¥í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    saveRegionDataFromGeoJson(geoJsonData) {
        if (!geoJsonData || !geoJsonData.features) {
            return;
        }
        
        geoJsonData.features.forEach((feature) => {
            if (feature && feature.properties && feature.properties.id) {
                const finalId = feature.properties.id;
                // ì´ë¯¸ ì €ì¥ëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸, ì—†ìœ¼ë©´ ìƒˆë¡œ ì €ì¥
                if (!this.regionData.has(finalId)) {
                    this.regionData.set(finalId, feature.properties);
                } else {
                    // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ì¸êµ¬/ë©´ì  ì •ë³´ ë³´ì¡´)
                    const existing = this.regionData.get(finalId);
                    this.regionData.set(finalId, {
                        ...existing,
                        ...feature.properties,
                        // ì¸êµ¬/ë©´ì  ì •ë³´ëŠ” feature.propertiesì— ìˆìœ¼ë©´ ìš°ì„  ì‚¬ìš©
                        population: feature.properties.population || existing.population || 0,
                        area: feature.properties.area || existing.area || 0
                    });
                }
            }
        });
    }
    
    normalizeGeoJsonPayload(payload) {
        if (!payload) return null;
        if (payload.type === 'FeatureCollection' && Array.isArray(payload.features)) {
            return payload;
        }
        if (payload.geoJson) {
            return this.normalizeGeoJsonPayload(payload.geoJson);
        }
        if (Array.isArray(payload.features)) {
            return { type: 'FeatureCollection', features: payload.features };
        }
        if (Array.isArray(payload) && payload.length > 0 && payload[0].geometry) {
            return { type: 'FeatureCollection', features: payload };
        }
        return null;
    }

    normalizeIdentifierValue(value) {
        if (!value && value !== 0) return '';
        return value
            .toString()
            .trim()
            .replace(/\s+/g, '-')
            .replace(/-+/g, '-')
            .toLowerCase();
    }

    generateRegionIdentifier(countryKey, properties = {}, index = 0) {
        const candidateKeys = [
            'id',
            'region_id',
            'regionId',
            'code',
            'CODE',
            'iso',
            'isoCode',
            'iso_3166_2',
            'name',
            'NAME',
            'NAME_1',
            'NAME_2',
            'ADMIN',
            'admin',
            'state',
            'province'
        ];
        let baseValue = '';
        for (const key of candidateKeys) {
            if (properties[key]) {
                baseValue = properties[key];
                break;
            }
        }
        if (!baseValue) {
            baseValue = `region-${index}`;
        }
        const slug = this.normalizeIdentifierValue(baseValue) || `region-${index}`;
        return `${countryKey}-${slug}`;
    }

    ensureRegionIdentifiers(countryKey, geoJsonData) {
        if (!geoJsonData || !Array.isArray(geoJsonData.features)) {
            return geoJsonData;
        }

        const usedIds = new Set();

        geoJsonData.features.forEach((feature, index) => {
            if (!feature) return;
            feature.properties = feature.properties || {};

            let regionId = feature.properties.id || feature.id;
            let generated = false;

            if (!regionId) {
                regionId = this.generateRegionIdentifier(countryKey, feature.properties, index);
                generated = true;
            }

            regionId = regionId.toString();

            if (usedIds.has(regionId)) {
                const fallbackId = generated
                    ? `${regionId}-${index}`
                    : `${regionId}-${countryKey}-${index}`;
                regionId = fallbackId;
            }

            usedIds.add(regionId);
            feature.properties.id = regionId;
            feature.id = regionId;
        });

        return geoJsonData;
    }
    
    expandMirrorUrls(url) {
        if (!url) return [];
        const variants = [];
        const addVariant = (candidate) => {
            if (candidate && !variants.includes(candidate)) {
                variants.push(candidate);
            }
        };
        
        addVariant(url);
        
        try {
            const parsed = new URL(url);
            if (parsed.hostname === 'raw.githubusercontent.com') {
                const path = parsed.pathname.replace(/^\/+/, '');
                addVariant(`https://raw.fastgit.org/${path}`);
                
                const segments = path.split('/');
                if (segments.length >= 4) {
                    const [owner, repo, branch, ...rest] = segments;
                    const restPath = rest.join('/');
                    addVariant(`https://rawcdn.githack.com/${owner}/${repo}/${branch}/${restPath}`);
                    addVariant(`https://cdn.jsdelivr.net/gh/${owner}/${repo}@${branch}/${restPath}`);
                }
            }
        } catch (error) {
            console.warn('URL íŒŒì‹± ì‹¤íŒ¨ë¡œ ë¯¸ëŸ¬ í™•ì¥ì„ ê±´ë„ˆëœë‹ˆë‹¤:', url, error);
        }
        
        return variants;
    }
    
    async waitForGeoRetry(attempt) {
        const clampedAttempt = Math.min(attempt, 5);
        const delay = 200 * (clampedAttempt + 1); // 200ms, 400ms, ...
        return new Promise(resolve => setTimeout(resolve, delay));
    }
    
    /**
     * ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ì¸ì§€ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
     * ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ ì‹œë„ì—ì„œë§Œ ê²½ê³ )
     */
    isExpectedError(error, isLastAttempt = false) {
        const message = (error?.message || String(error) || '').toString();
        return message.includes('CORS') || 
               message.includes('403') || 
               message.includes('404') ||
               message.includes('Failed to fetch') ||
               message.includes('Git LFS') ||
               message.includes('HTML response') ||
               message.includes('Non-JSON response') ||
               message.includes('Content Security Policy') ||
               message.includes('CSP') ||
               message.includes('refused to connect') ||
               message.includes('Unexpected token') ||
               message.includes('is not valid JSON') ||
               message.includes('ERR_NAME_NOT_RESOLVED') ||
               message.includes('ERR_FAILED');
    }

    async fetchGeoJsonWithFallback(countryKey, {
        urls = [],
        localPath = null,
        minFeatures = 1
    } = {}) {
        let lastError = null;
        let attempt = 0;
        const tried = new Set();
        
        const parseResponseBody = async (response, targetUrl, allowLfsRedirect = true) => {
            const contentType = response.headers.get('content-type') || '';
            const normalizedContentType = contentType.toLowerCase();
            const isJsonContent = normalizedContentType.includes('application/json') ||
                                  normalizedContentType.includes('application/geo+json') ||
                                  normalizedContentType.includes('application/vnd.geo+json');
            
            if (isJsonContent) {
                return response.json();
            }
            
            const textBody = await response.text();
            const trimmed = textBody.trim();
            if (!trimmed) {
                throw new Error('Empty response');
            }
            
            // HTML ì‘ë‹µì„ ë¨¼ì € í™•ì¸ (JSON íŒŒì‹± ì „ì—)
            const looksLikeHtml = trimmed.startsWith('<!DOCTYPE') || trimmed.startsWith('<html') || 
                                 (trimmed.startsWith('<') && (trimmed.includes('DOCTYPE') || trimmed.includes('html')));
            if (looksLikeHtml) {
                throw new Error('HTML response received');
            }
            
            const looksLikeJson = trimmed.startsWith('{') || trimmed.startsWith('[');
            if (looksLikeJson) {
                try {
                    return JSON.parse(trimmed);
                } catch (parseError) {
                    // JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ HTMLì¸ì§€ ë‹¤ì‹œ í™•ì¸
                    if (trimmed.startsWith('<!DOCTYPE') || trimmed.startsWith('<html') || trimmed.startsWith('<')) {
                        throw new Error('HTML response received');
                    }
                    // "Unexpected token" ì—ëŸ¬ëŠ” HTMLì´ë‚˜ Git LFS í¬ì¸í„°ì¼ ê°€ëŠ¥ì„±ì´ ë†’ìŒ
                    const parseMessage = parseError.message || '';
                    if (parseMessage.includes('Unexpected token') && trimmed.startsWith('<')) {
                        throw new Error('HTML response received');
                    }
                    throw new Error('Invalid JSON payload');
                }
            }
            
            const looksLikeGitLfsPointer = trimmed.startsWith('version https://git-lfs.github.com/spec/v1');
            const isRawGithubUrl = targetUrl.includes('raw.githubusercontent.com');
            if (looksLikeGitLfsPointer && allowLfsRedirect && isRawGithubUrl) {
                const rawPrefix = 'https://raw.githubusercontent.com/';
                const mediaPrefix = 'https://media.githubusercontent.com/media/';
                const mediaUrl = targetUrl.startsWith(rawPrefix)
                    ? targetUrl.replace(rawPrefix, mediaPrefix)
                    : targetUrl.replace('raw.githubusercontent.com', 'media.githubusercontent.com/media');
                console.info(`[${countryKey}] Git LFS pointer detected. Retrying via media CDN: ${mediaUrl}`);
                try {
                    const mediaResponse = await fetch(mediaUrl, { cache: 'no-store' });
                    if (!mediaResponse.ok) {
                        throw new Error(`Git LFS media fetch failed (HTTP ${mediaResponse.status})`);
                    }
                    return parseResponseBody(mediaResponse, mediaUrl, false);
                } catch (mediaError) {
                    // CSP ìœ„ë°˜ì´ë‚˜ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬ì¸ ê²½ìš° ì¡°ìš©íˆ ì²˜ë¦¬
                    const mediaMessage = mediaError.message || '';
                    if (mediaMessage.includes('CSP') || mediaMessage.includes('Content Security Policy') || 
                        mediaMessage.includes('refused to connect') || mediaMessage.includes('Failed to fetch')) {
                        throw new Error('Git LFS pointer received (media redirect unavailable due to CSP or network)');
                    }
                    throw mediaError;
                }
            }
            
            if (looksLikeGitLfsPointer) {
                throw new Error('Git LFS pointer received (media redirect unavailable)');
            }
            
            if (trimmed.toLowerCase().startsWith('version ht')) {
                throw new Error('Non-JSON response (likely Git LFS pointer)');
            }
            
            throw new Error(`Non-JSON response (${trimmed.slice(0, 60)}...)`);
        };
        
        const tryFetch = async (targetUrl) => {
            try {
                const response = await fetch(targetUrl, { cache: 'no-store' });
                if (!response.ok) {
                    // 404ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ì˜ˆìƒ ê°€ëŠ¥í•œ ì˜¤ë¥˜)
                    if (response.status === 404) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    throw new Error(`HTTP ${response.status}`);
                }
                const json = await parseResponseBody(response, targetUrl);
                const normalized = this.normalizeGeoJsonPayload(json);
                if (normalized && Array.isArray(normalized.features) && normalized.features.length >= minFeatures) {
                    console.log(`[${countryKey}] Loaded from ${targetUrl} (features: ${normalized.features.length})`);
                    return normalized;
                }
                throw new Error('Invalid GeoJSON structure');
            } catch (error) {
                lastError = error;
                // ì˜ˆìƒ ê°€ëŠ¥í•œ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ëª¨ë“  URL ì‹œë„ í›„ì—ë§Œ ê²½ê³ )
                const isExpected = this.isExpectedError(error);
                if (!isExpected) {
                    // ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ë§Œ ê²½ê³  ë¡œê·¸
                    const message = error.message || '';
                    console.warn(`[${countryKey}] Failed loading from ${targetUrl}`, message);
                }
                attempt += 1;
                await this.waitForGeoRetry(attempt);
                return null;
            }
        };
        
        for (const url of urls) {
            const variants = this.expandMirrorUrls(url);
            for (const candidate of variants) {
                if (tried.has(candidate)) continue;
                tried.add(candidate);
                const result = await tryFetch(candidate);
                if (result) return result;
            }
        }
        
        if (localPath) {
            const assetUrl = this.getAssetUrl(localPath);
            if (!tried.has(assetUrl)) {
                tried.add(assetUrl);
                const assetResult = await tryFetch(assetUrl);
                if (assetResult) return assetResult;
            }
            if (!tried.has(localPath)) {
                const localResult = await tryFetch(localPath);
                if (localResult) return localResult;
            }
        }
        
        throw lastError || new Error(`No ${countryKey} dataset available`);
    }
    
    async loadWorldData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('usa', async () => {
                const data = await this.fetchGeoJsonWithFallback('usa', {
                    urls: [
                        this.getAssetUrl('data/us-states.geojson'),
                        'https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json'
                    ],
                    localPath: 'data/us-states.geojson',
                    minFeatures: 30
                });
                
                // ë¯¸êµ­ ì£¼ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const usaStateData = {
                    'California': { population: 39029000, area: 423967 },
                    'Texas': { population: 30503000, area: 695662 },
                    'Florida': { population: 22610000, area: 170312 },
                    'New York': { population: 19677000, area: 141297 },
                    'Pennsylvania': { population: 12982000, area: 119280 },
                    'Illinois': { population: 12480000, area: 149995 },
                    'Ohio': { population: 11792000, area: 116098 },
                    'Georgia': { population: 11029000, area: 153910 },
                    'North Carolina': { population: 10855000, area: 139391 },
                    'Michigan': { population: 10270000, area: 250487 },
                    'New Jersey': { population: 9255000, area: 22591 },
                    'Virginia': { population: 8717000, area: 110787 },
                    'Washington': { population: 7999000, area: 184661 },
                    'Arizona': { population: 7636000, area: 295234 },
                    'Tennessee': { population: 7222000, area: 109153 },
                    'Indiana': { population: 6864000, area: 94326 },
                    'Massachusetts': { population: 6992000, area: 27336 },
                    'Missouri': { population: 6168000, area: 180540 },
                    'Maryland': { population: 6247000, area: 32131 },
                    'Wisconsin': { population: 5944000, area: 169635 },
                    'Colorado': { population: 5979000, area: 269601 },
                    'Minnesota': { population: 5773000, area: 225163 },
                    'South Carolina': { population: 5437000, area: 82933 },
                    'Alabama': { population: 5154000, area: 135767 },
                    'Louisiana': { population: 4554000, area: 135659 },
                    'Kentucky': { population: 4525000, area: 104656 },
                    'Oregon': { population: 4325000, area: 254800 },
                    'Oklahoma': { population: 4050000, area: 181037 },
                    'Connecticut': { population: 3625000, area: 14357 },
                    'Utah': { population: 3497000, area: 219882 },
                    'Iowa': { population: 3223000, area: 145746 },
                    'Nevada': { population: 3195000, area: 286380 },
                    'Arkansas': { population: 3086000, area: 137732 },
                    'Mississippi': { population: 2931000, area: 125438 },
                    'Kansas': { population: 2942000, area: 213100 },
                    'New Mexico': { population: 2119000, area: 314917 },
                    'Nebraska': { population: 1979000, area: 200330 },
                    'Idaho': { population: 1967000, area: 216443 },
                    'West Virginia': { population: 1775000, area: 62756 },
                    'Hawaii': { population: 1417000, area: 28311 },
                    'Maine': { population: 1396000, area: 91633 },
                    'New Hampshire': { population: 1395000, area: 24214 },
                    'Montana': { population: 1142000, area: 380831 },
                    'Rhode Island': { population: 1100000, area: 4001 },
                    'Delaware': { population: 1018000, area: 6446 },
                    'South Dakota': { population: 919000, area: 199729 },
                    'North Dakota': { population: 784000, area: 183108 },
                    'Alaska': { population: 734000, area: 1723337 },
                    'Vermont': { population: 650000, area: 24906 },
                    'Wyoming': { population: 583000, area: 253335 }
                };
                
                // ê° ì£¼ì— ê´‘ê³  ì •ë³´ ì¶”ê°€
                data.features.forEach((feature, index) => {
                    const props = feature.properties;
                    const stateName = props.name;
                    const stateId = stateName.toLowerCase().replace(/\s+/g, '_');
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const stateData = usaStateData[stateName] || { 
                        population: Math.floor(Math.random() * 10000000) + 1000000, 
                        area: Math.floor(Math.random() * 500000) + 50000 
                    };
                    
                    feature.properties = {
                        ...props,
                        id: stateId,
                        name_en: stateName,
                        name_ko: this.getKoreanStateName(stateName),
                        country: 'USA',
                        country_code: 'US',
                        admin_level: 'State',
                        population: stateData.population,
                        area: stateData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#4ecdc4',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    
                    // regionDataì— ì €ì¥
                    this.regionData.set(stateId, feature.properties);
                });
                
                return data;
            });
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (ë” ë¹ ë¦„)
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                // ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                this.map.addSource('world-regions', {
                    type: 'geojson',
                    data: geoJsonData
                });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            '#4ecdc4'
                        ],
                        'fill-opacity': 0.7  // ì§€êµ¬ë³¸ì—ì„œ ë” ì„ ëª…í•˜ê²Œ ë³´ì´ë„ë¡ ì¦ê°€
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0, 0.5,
                            5, 1,
                            10, 1.5
                        ],
                        'line-opacity': 0.9
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•œ ë²ˆë§Œ ì¶”ê°€
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ë¯¸êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            
            // ì´ˆê¸° í†µê³„ ì—…ë°ì´íŠ¸
            this.updateStatistics();
        } catch (error) {
            console.error('ë¯¸êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë¯¸êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    applyMapLighting() {
        if (!this.map) return;

        const lightConfig = {
            anchor: 'viewport',
            color: '#ffffff',
            intensity: 0.4,
            position: [0.3, 0.3, 1.2],
            type: 'flat'
        };

        if (typeof this.map.setLights === 'function') {
            this.map.setLights([{
                id: 'world-light',
                ...lightConfig
            }]);
        } else if (typeof this.map.setLight === 'function') {
            const { type, id, ...legacyConfig } = lightConfig;
            this.map.setLight(legacyConfig);
        }
    }
    
    // 3D ì§€êµ¬ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
    setupGlobeStyle() {
        if (!this.isGlobeMode) return;
        
        // êµ¬ë¦„ íš¨ê³¼ ì¶”ê°€
        this.addCloudLayer();
        
        // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        this.startCloudAnimation();
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë™ì  ìƒ‰ìƒ ì¡°ì • (êµ¬ê¸€ ì–´ìŠ¤ì²˜ëŸ¼)
        this.setupDynamicColorAdjustment();
        
        console.log('3D ì§€êµ¬ë³¸ ëª¨ë“œ í™œì„±í™” (êµ¬ë¦„ íš¨ê³¼ í¬í•¨, ì°¨ë¶„í•œ ìœ„ì„± ì§€ë„ ìŠ¤íƒ€ì¼)');
    }
    
    // ë™ì  ìƒ‰ìƒ ì¡°ì • ì„¤ì • (ì¤Œ ë ˆë²¨ì— ë”°ë¼)
    setupDynamicColorAdjustment() {
        if (!this.map || !this.map.getLayer('background')) return;
        if (this.dynamicColorSetup) return; // ì´ë¯¸ ì„¤ì •ë˜ì—ˆìœ¼ë©´ ë°˜í™˜
        
        // ì´ˆê¸° ì„¤ì • ì ìš©
        this.updateGlobeColorsByZoom();
        
        // ì¤Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í•œ ë²ˆë§Œ)
        this.map.on('zoom', () => {
            this.updateGlobeColorsByZoom();
        });
        
        this.dynamicColorSetup = true;
    }
    
    // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ì§€êµ¬ë³¸ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    updateGlobeColorsByZoom() {
        if (!this.map || !this.map.getLayer('background')) return;
        
        const zoom = this.map.getZoom();
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¼ ë°ê¸°, ì±„ë„, ëŒ€ë¹„ ì¡°ì •
        let brightnessMin, saturation, contrast;
        
        if (zoom < 2) {
            // ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸° - ë§¤ìš° ì°¨ë¶„í•˜ê²Œ
            brightnessMin = 0.45;
            saturation = 0.6;
            contrast = 0.3;
        } else if (zoom < 5) {
            // ëŒ€ë¥™ ì „ì²´ ë³´ê¸° - ì°¨ë¶„í•˜ê²Œ
            brightnessMin = 0.5;
            saturation = 0.65;
            contrast = 0.35;
        } else if (zoom < 10) {
            // êµ­ê°€/ì§€ì—­ ë³´ê¸° - ìì—°ìŠ¤ëŸ½ê²Œ
            brightnessMin = 0.55;
            saturation = 0.7;
            contrast = 0.4;
        } else {
            // ìƒì„¸ ë³´ê¸° - ë” ì„ ëª…í•˜ê²Œ (ì‹¤ì œ ìœ„ì„± ì§€ë„ ëŠë‚Œ)
            brightnessMin = 0.6;
            saturation = 0.75;
            contrast = 0.45;
        }
        
        // ìƒ‰ìƒ ì†ì„± ì—…ë°ì´íŠ¸
        if (this.map.getPaintProperty) {
            this.map.setPaintProperty('background', 'raster-brightness-min', brightnessMin);
            this.map.setPaintProperty('background', 'raster-brightness-max', Math.min(brightnessMin + 0.3, 0.9));
            this.map.setPaintProperty('background', 'raster-saturation', saturation);
            this.map.setPaintProperty('background', 'raster-contrast', contrast);
        }
    }
    
    // êµ¬ë¦„ í…ìŠ¤ì²˜ ìƒì„±
    createCloudTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 2048;
        canvas.height = 1024;
        const ctx = canvas.getContext('2d');
        
        // ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ (ë°˜íˆ¬ëª…)
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
        gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.15)');
        gradient.addColorStop(0.7, 'rgba(255, 255, 255, 0.25)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0.1)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ë¦„ íŒ¨í„´ ìƒì„± (ì°¨ë¶„í•œ ìƒ‰ìƒ)
        const clouds = [];
        for (let i = 0; i < 80; i++) {
            clouds.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 150 + 80,
                opacity: Math.random() * 0.35 + 0.15  // ì•½ê°„ ë” íˆ¬ëª…í•˜ê²Œ
            });
        }
        
        // êµ¬ë¦„ ê·¸ë¦¬ê¸° (í¼ì§€ íš¨ê³¼, ì•½ê°„ íšŒìƒ‰ë¹›)
        clouds.forEach(cloud => {
            const gradient = ctx.createRadialGradient(
                cloud.x, cloud.y, 0,
                cloud.x, cloud.y, cloud.radius
            );
            // ì•½ê°„ íšŒìƒ‰ë¹› êµ¬ë¦„ (ì‹¤ì œ ìœ„ì„± ì§€ë„ì²˜ëŸ¼)
            gradient.addColorStop(0, `rgba(245, 248, 255, ${cloud.opacity})`);
            gradient.addColorStop(0.5, `rgba(235, 240, 250, ${cloud.opacity * 0.5})`);
            gradient.addColorStop(1, 'rgba(245, 248, 255, 0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(cloud.x, cloud.y, cloud.radius, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // ì¶”ê°€ ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ë¦„ íŒ¨í„´
        for (let i = 0; i < 40; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const radius = Math.random() * 100 + 50;
            const opacity = Math.random() * 0.25 + 0.08;
            
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
            // ì•½ê°„ íšŒìƒ‰ë¹› êµ¬ë¦„
            gradient.addColorStop(0, `rgba(240, 245, 252, ${opacity})`);
            gradient.addColorStop(1, 'rgba(240, 245, 252, 0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
        }
        
        return canvas.toDataURL();
    }
    
    // êµ¬ë¦„ ë ˆì´ì–´ ì¶”ê°€
    addCloudLayer() {
        if (!this.map.getLayer('clouds-layer')) {
            // êµ¬ë¦„ í…ìŠ¤ì²˜ ìƒì„±
            const cloudDataUrl = this.createCloudTexture();
            
            // êµ¬ë¦„ ì´ë¯¸ì§€ ë¡œë“œ
            this.map.loadImage(cloudDataUrl, (error, image) => {
                if (error) {
                    console.error('êµ¬ë¦„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                    return;
                }
                
                this.cloudImage = image;
                
                // êµ¬ë¦„ ì†ŒìŠ¤ ì¶”ê°€
                if (this.map.getSource('clouds')) {
                    this.map.removeSource('clouds');
                }
                
                this.map.addSource('clouds', {
                    type: 'image',
                    url: cloudDataUrl,
                    coordinates: [
                        [-180, 85], // ì¢Œìƒë‹¨
                        [180, 85],  // ìš°ìƒë‹¨
                        [180, -85], // ìš°í•˜ë‹¨
                        [-180, -85] // ì¢Œí•˜ë‹¨
                    ]
                });
                
                // êµ¬ë¦„ ë ˆì´ì–´ ì¶”ê°€
                if (!this.map.getLayer('clouds-layer')) {
                    this.map.addLayer({
                        id: 'clouds-layer',
                        type: 'raster',
                        source: 'clouds',
                        paint: {
                            'raster-opacity': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                0, 0.28,  // ì‘ì€ ì¤Œì—ì„œëŠ” ì•½ê°„ íˆ¬ëª… (ì°¨ë¶„í•œ ëŠë‚Œ)
                                3, 0.35,  // ì¤‘ê°„ ì¤Œì—ì„œëŠ” ìì—°ìŠ¤ëŸ½ê²Œ
                                10, 0.25  // í° ì¤Œì—ì„œëŠ” ë” íˆ¬ëª…í•˜ê²Œ
                            ],
                            'raster-resampling': 'linear',
                            'raster-fade-duration': 0
                        },
                        minzoom: 0,
                        maxzoom: 22
                    });
                }
            });
        }
    }
    
    // êµ¬ë¦„ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    startCloudAnimation() {
        if (this.cloudAnimationId) {
            cancelAnimationFrame(this.cloudAnimationId);
        }
        
        const animate = () => {
            if (!this.isGlobeMode || !this.map || !this.map.getSource('clouds')) {
                this.cloudAnimationId = null;
                return;
            }
            
            // êµ¬ë¦„ì„ ì§€êµ¬ë³¸ë³´ë‹¤ ì¡°ê¸ˆ ëŠë¦¬ê²Œ íšŒì „ (ìì—°ìŠ¤ëŸ¬ìš´ íš¨ê³¼)
            this.cloudRotation += 0.00015;
            
            // êµ¬ë¦„ ì¢Œí‘œ ì—…ë°ì´íŠ¸ (íšŒì „ íš¨ê³¼)
            const source = this.map.getSource('clouds');
            if (source && source.setCoordinates) {
                const angle = this.cloudRotation;
                
                // ê²½ë„ ê¸°ì¤€ìœ¼ë¡œ íšŒì „ (ì§€êµ¬ë³¸ ì¶• íšŒì „ê³¼ ë™ì¼)
                const baseCoords = [
                    [-180, 85],
                    [180, 85],
                    [180, -85],
                    [-180, -85]
                ];
                
                // ê²½ë„ë¥¼ íšŒì „ì‹œì¼œ êµ¬ë¦„ ì´ë™ íš¨ê³¼ ìƒì„±
                const rotatedCoords = baseCoords.map(coord => {
                    const rotatedLng = (coord[0] + angle * 360 / (Math.PI * 2)) % 360;
                    const normalizedLng = rotatedLng > 180 ? rotatedLng - 360 : rotatedLng;
                    return [normalizedLng, coord[1]];
                });
                
                source.setCoordinates(rotatedCoords);
            }
            
            this.cloudAnimationId = requestAnimationFrame(animate);
        };
        
        animate();
    }
    
    // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
    stopCloudAnimation() {
        if (this.cloudAnimationId) {
            cancelAnimationFrame(this.cloudAnimationId);
            this.cloudAnimationId = null;
        }
    }
    
    // 2D/3D ëª¨ë“œ ì „í™˜
    toggleGlobeMode() {
        this.isGlobeMode = !this.isGlobeMode;
        
        if (this.isGlobeMode) {
            // 3D ì§€êµ¬ë³¸ ëª¨ë“œë¡œ ì „í™˜
            this.map.setProjection('globe');
            
            // 3D ëª¨ë“œì—ì„œëŠ” ì„¸ê³„ì§€ë„ ë³µì‚¬ë³¸ì„ í™œì„±í™” (ì§€êµ¬ë³¸ í‘œì‹œìš©)
            if (this.map.setRenderWorldCopies) {
                this.map.setRenderWorldCopies(true);
            }
            
            // ì§€êµ¬ë³¸ì„ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
            this.map.easeTo({
                center: [0, 0],
                pitch: 0, // ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸°
                zoom: 1.5,
                duration: 1500,
                easing: (t) => t * (2 - t) // ease-out ì»¤ë¸Œ
            });
            
            // ì§€êµ¬ë³¸ ìŠ¤íƒ€ì¼ ì¬ì„¤ì •
            this.setupGlobeStyle();
            
            this.showNotification('3D ì§€êµ¬ë³¸ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        } else {
            // 2D í‰ë©´ ëª¨ë“œë¡œ ì „í™˜
            this.map.setProjection('mercator');
            
            // 2D ëª¨ë“œì—ì„œ ì„¸ê³„ì§€ë„ë¥¼ í•œ ë²ˆë§Œ í‘œì‹œí•˜ë„ë¡ ì„¤ì •
            if (this.map.setRenderWorldCopies) {
                this.map.setRenderWorldCopies(false);
            }
            
            // 2D ëª¨ë“œì—ì„œ ìµœì†Œ ì¤Œ ì œí•œ (ë„ˆë¬´ ë§ì´ ì¶•ì†Œë˜ì–´ ì§€ë„ê°€ ì—¬ëŸ¬ ë²ˆ ë³´ì´ì§€ ì•Šë„ë¡)
            const currentZoom = this.map.getZoom();
            const minZoom2D = 1.5; // 2D ëª¨ë“œ ìµœì†Œ ì¤Œ ë ˆë²¨
            if (currentZoom < minZoom2D) {
                this.map.setZoom(minZoom2D);
            }
            
            // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€ ë° ë ˆì´ì–´ ì œê±°
            this.stopCloudAnimation();
            if (this.map.getLayer('clouds-layer')) {
                this.map.removeLayer('clouds-layer');
            }
            if (this.map.getSource('clouds')) {
                this.map.removeSource('clouds');
            }
            
            // ì‹œì•¼ê° ì´ˆê¸°í™” (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
            this.map.easeTo({
                pitch: 0,
                zoom: Math.max(this.map.getZoom(), minZoom2D),
                duration: 1500,
                easing: (t) => t * (2 - t) // ease-out ì»¤ë¸Œ
            });
            
            this.showNotification('2D í‰ë©´ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }
        
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        this.updateModeButtons();
        const globeBtn = document.getElementById('globe-mode-btn');
        if (globeBtn) {
            globeBtn.textContent = this.isGlobeMode ? 'ğŸŒ 3D ì§€êµ¬ë³¸' : 'ğŸ—ºï¸ 2D í‰ë©´';
        }
    }
    
    // ì§€êµ¬ë³¸ ìë™ íšŒì „ (ì„ íƒì‚¬í•­)
    startGlobeRotation() {
        if (!this.isGlobeMode || this.globeRotationInterval) return;
        
        this.globeRotationInterval = setInterval(() => {
            const currentBearing = this.map.getBearing();
            this.map.setBearing(currentBearing + 0.5);
        }, 50);
    }
    
    stopGlobeRotation() {
        if (this.globeRotationInterval) {
            clearInterval(this.globeRotationInterval);
            this.globeRotationInterval = null;
        }
    }
    
    // ì§€ë„ ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ì¶”ê°€
    addMapModeToggle() {
        const mapModeToggle = document.createElement('div');
        mapModeToggle.id = 'map-mode-toggle';
        mapModeToggle.className = 'map-mode-toggle';
        
        // 3D/2D í† ê¸€ ë²„íŠ¼
        const globeBtn = document.createElement('button');
        globeBtn.id = 'globe-mode-btn';
        globeBtn.className = 'mode-btn';
        globeBtn.textContent = 'ğŸŒ 3D ì§€êµ¬ë³¸';
        
        const dropdown = document.createElement('select');
        dropdown.id = 'country-mode-dropdown';
        dropdown.className = 'country-dropdown';
        
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'ğŸŒ ì „ ì„¸ê³„ (3D/2D)';
        dropdown.appendChild(defaultOption);
        
        const countryOptions = [
            { value: 'usa', label: 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­' },
            { value: 'korea', label: 'ğŸ‡°ğŸ‡· í•œêµ­' },
            { value: 'japan', label: 'ğŸ‡¯ğŸ‡µ ì¼ë³¸' },
            { value: 'china', label: 'ğŸ‡¨ğŸ‡³ ì¤‘êµ­' },
            { value: 'russia', label: 'ğŸ‡·ğŸ‡º ëŸ¬ì‹œì•„' },
            { value: 'india', label: 'ğŸ‡®ğŸ‡³ ì¸ë„' },
            { value: 'canada', label: 'ğŸ‡¨ğŸ‡¦ ìºë‚˜ë‹¤' },
            { value: 'germany', label: 'ğŸ‡©ğŸ‡ª ë…ì¼' },
            { value: 'uk', label: 'ğŸ‡¬ğŸ‡§ ì˜êµ­' },
            { value: 'france', label: 'ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤' },
            { value: 'italy', label: 'ğŸ‡®ğŸ‡¹ ì´íƒˆë¦¬ì•„' },
            { value: 'brazil', label: 'ğŸ‡§ğŸ‡· ë¸Œë¼ì§ˆ' },
            { value: 'australia', label: 'ğŸ‡¦ğŸ‡º í˜¸ì£¼' },
            { value: 'mexico', label: 'ğŸ‡²ğŸ‡½ ë©•ì‹œì½”' },
            { value: 'indonesia', label: 'ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„' },
            { value: 'saudi-arabia', label: 'ğŸ‡¸ğŸ‡¦ ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„' },
            { value: 'turkey', label: 'ğŸ‡¹ğŸ‡· í„°í‚¤' },
            { value: 'south-africa', label: 'ğŸ‡¿ğŸ‡¦ ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­' },
            { value: 'argentina', label: 'ğŸ‡¦ğŸ‡· ì•„ë¥´í—¨í‹°ë‚˜' },
            { value: 'spain', label: 'ğŸ‡ªğŸ‡¸ ìŠ¤í˜ì¸' },
            { value: 'portugal', label: 'ğŸ‡µğŸ‡¹ í¬ë¥´íˆ¬ê°ˆ' },
            { value: 'greece', label: 'ğŸ‡¬ğŸ‡· ê·¸ë¦¬ìŠ¤' },
            { value: 'czech-republic', label: 'ğŸ‡¨ğŸ‡¿ ì²´ì½”' },
            { value: 'hungary', label: 'ğŸ‡­ğŸ‡º í—ê°€ë¦¬' },
            { value: 'poland', label: 'ğŸ‡µğŸ‡± í´ë€ë“œ' },
            { value: 'belgium', label: 'ğŸ‡§ğŸ‡ª ë²¨ê¸°ì—' },
            { value: 'netherlands', label: 'ğŸ‡³ğŸ‡± ë„¤ëœë€ë“œ' },
            { value: 'sweden', label: 'ğŸ‡¸ğŸ‡ª ìŠ¤ì›¨ë´' },
            { value: 'austria', label: 'ğŸ‡¦ğŸ‡¹ ì˜¤ìŠ¤íŠ¸ë¦¬ì•„' },
            { value: 'denmark', label: 'ğŸ‡©ğŸ‡° ë´ë§ˆí¬' },
            { value: 'finland', label: 'ğŸ‡«ğŸ‡® í•€ë€ë“œ' },
            { value: 'ireland', label: 'ğŸ‡®ğŸ‡ª ì•„ì¼ëœë“œ' },
            { value: 'romania', label: 'ğŸ‡·ğŸ‡´ ë£¨ë§ˆë‹ˆì•„' },
            { value: 'bulgaria', label: 'ğŸ‡§ğŸ‡¬ ë¶ˆê°€ë¦¬ì•„' }
        ];
        
        countryOptions.forEach(({ value, label }) => {
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            dropdown.appendChild(option);
        });
        
        // ìš”ì†Œë“¤ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
        mapModeToggle.appendChild(globeBtn);
        mapModeToggle.appendChild(dropdown);
        this.modeDropdown = dropdown;
        
        // ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
        const usaBtn = document.createElement('button');
        usaBtn.id = 'usa-mode-btn';
        usaBtn.className = 'mode-btn hidden';
        usaBtn.textContent = 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­';
        
        const koreaBtn = document.createElement('button');
        koreaBtn.id = 'korea-mode-btn';
        koreaBtn.className = 'mode-btn hidden';
        koreaBtn.textContent = 'ğŸ‡°ğŸ‡· í•œêµ­';
        
        const japanBtn = document.createElement('button');
        japanBtn.id = 'japan-mode-btn';
        japanBtn.className = 'mode-btn hidden';
        japanBtn.textContent = 'ğŸ‡¯ğŸ‡µ ì¼ë³¸';
        
        const chinaBtn = document.createElement('button');
        chinaBtn.id = 'china-mode-btn';
        chinaBtn.className = 'mode-btn hidden';
        chinaBtn.textContent = 'ğŸ‡¨ğŸ‡³ ì¤‘êµ­';

        const russiaBtn = document.createElement('button');
        russiaBtn.id = 'russia-mode-btn';
        russiaBtn.className = 'mode-btn hidden';
        russiaBtn.textContent = 'ğŸ‡·ğŸ‡º ëŸ¬ì‹œì•„';

        const indiaBtn = document.createElement('button');
        indiaBtn.id = 'india-mode-btn';
        indiaBtn.className = 'mode-btn hidden';
        indiaBtn.textContent = 'ğŸ‡®ğŸ‡³ ì¸ë„';

        const canadaBtn = document.createElement('button');
        canadaBtn.id = 'canada-mode-btn';
        canadaBtn.className = 'mode-btn hidden';
        canadaBtn.textContent = 'ğŸ‡¨ğŸ‡¦ ìºë‚˜ë‹¤';

        const germanyBtn = document.createElement('button');
        germanyBtn.id = 'germany-mode-btn';
        germanyBtn.className = 'mode-btn hidden';
        germanyBtn.textContent = 'ğŸ‡©ğŸ‡ª ë…ì¼';

        const ukBtn = document.createElement('button');
        ukBtn.id = 'uk-mode-btn';
        ukBtn.className = 'mode-btn hidden';
        ukBtn.textContent = 'ğŸ‡¬ğŸ‡§ ì˜êµ­';

        const franceBtn = document.createElement('button');
        franceBtn.id = 'france-mode-btn';
        franceBtn.className = 'mode-btn hidden';
        franceBtn.textContent = 'ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤';

        const italyBtn = document.createElement('button');
        italyBtn.id = 'italy-mode-btn';
        italyBtn.className = 'mode-btn hidden';
        italyBtn.textContent = 'ğŸ‡®ğŸ‡¹ ì´íƒˆë¦¬ì•„';

        const brazilBtn = document.createElement('button');
        brazilBtn.id = 'brazil-mode-btn';
        brazilBtn.className = 'mode-btn hidden';
        brazilBtn.textContent = 'ğŸ‡§ğŸ‡· ë¸Œë¼ì§ˆ';

        const australiaBtn = document.createElement('button');
        australiaBtn.id = 'australia-mode-btn';
        australiaBtn.className = 'mode-btn hidden';
        australiaBtn.textContent = 'ğŸ‡¦ğŸ‡º í˜¸ì£¼';

        const mexicoBtn = document.createElement('button');
        mexicoBtn.id = 'mexico-mode-btn';
        mexicoBtn.className = 'mode-btn hidden';
        mexicoBtn.textContent = 'ğŸ‡²ğŸ‡½ ë©•ì‹œì½”';

        const indonesiaBtn = document.createElement('button');
        indonesiaBtn.id = 'indonesia-mode-btn';
        indonesiaBtn.className = 'mode-btn hidden';
        indonesiaBtn.textContent = 'ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„';

        const saudiArabiaBtn = document.createElement('button');
        saudiArabiaBtn.id = 'saudi-arabia-mode-btn';
        saudiArabiaBtn.className = 'mode-btn hidden';
        saudiArabiaBtn.textContent = 'ğŸ‡¸ğŸ‡¦ ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„';

        const turkeyBtn = document.createElement('button');
        turkeyBtn.id = 'turkey-mode-btn';
        turkeyBtn.className = 'mode-btn hidden';
        turkeyBtn.textContent = 'ğŸ‡¹ğŸ‡· í„°í‚¤';

        const southAfricaBtn = document.createElement('button');
        southAfricaBtn.id = 'south-africa-mode-btn';
        southAfricaBtn.className = 'mode-btn hidden';
        southAfricaBtn.textContent = 'ğŸ‡¿ğŸ‡¦ ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­';

        const argentinaBtn = document.createElement('button');
        argentinaBtn.id = 'argentina-mode-btn';
        argentinaBtn.className = 'mode-btn hidden';
        argentinaBtn.textContent = 'ğŸ‡¦ğŸ‡· ì•„ë¥´í—¨í‹°ë‚˜';
        
        mapModeToggle.appendChild(usaBtn);
        mapModeToggle.appendChild(koreaBtn);
        mapModeToggle.appendChild(japanBtn);
        mapModeToggle.appendChild(chinaBtn);
        mapModeToggle.appendChild(russiaBtn);
        mapModeToggle.appendChild(indiaBtn);
        mapModeToggle.appendChild(canadaBtn);
        mapModeToggle.appendChild(germanyBtn);
        mapModeToggle.appendChild(ukBtn);
        mapModeToggle.appendChild(franceBtn);
        mapModeToggle.appendChild(italyBtn);
        mapModeToggle.appendChild(brazilBtn);
        mapModeToggle.appendChild(australiaBtn);
        mapModeToggle.appendChild(mexicoBtn);
        mapModeToggle.appendChild(indonesiaBtn);
        mapModeToggle.appendChild(saudiArabiaBtn);
        mapModeToggle.appendChild(turkeyBtn);
        mapModeToggle.appendChild(southAfricaBtn);
        mapModeToggle.appendChild(argentinaBtn);
        
        document.body.appendChild(mapModeToggle);
        
        // 3D/2D í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        globeBtn.addEventListener('click', () => {
            this.toggleGlobeMode();
        });

        const dropdownModeHandlers = {
            'usa': () => this.switchToUSAMode(),
            'korea': () => this.switchToKoreaMode(),
            'japan': () => this.switchToJapanMode(),
            'china': () => this.switchToChinaMode(),
            'russia': () => this.switchToRussiaMode(),
            'india': () => this.switchToIndiaMode(),
            'canada': () => this.switchToCanadaMode(),
            'germany': () => this.switchToGermanyMode(),
            'uk': () => this.switchToUKMode(),
            'france': () => this.switchToFranceMode(),
            'italy': () => this.switchToItalyMode(),
            'brazil': () => this.switchToBrazilMode(),
            'australia': () => this.switchToAustraliaMode(),
            'mexico': () => this.switchToMexicoMode(),
            'indonesia': () => this.switchToIndonesiaMode(),
            'saudi-arabia': () => this.switchToSaudiArabiaMode(),
            'turkey': () => this.switchToTurkeyMode(),
            'south-africa': () => this.switchToSouthAfricaMode(),
            'argentina': () => this.switchToArgentinaMode(),
            'spain': () => this.switchToSpainMode(),
            'portugal': () => this.switchToPortugalMode(),
            'greece': () => this.switchToGreeceMode(),
            'czech-republic': () => this.switchToCzechRepublicMode(),
            'hungary': () => this.switchToHungaryMode(),
            'poland': () => this.switchToPolandMode(),
            'belgium': () => this.switchToBelgiumMode(),
            'netherlands': () => this.switchToNetherlandsMode(),
            'sweden': () => this.switchToSwedenMode(),
            'austria': () => this.switchToAustriaMode(),
            'denmark': () => this.switchToDenmarkMode(),
            'finland': () => this.switchToFinlandMode(),
            'ireland': () => this.switchToIrelandMode(),
            'romania': () => this.switchToRomaniaMode(),
            'bulgaria': () => this.switchToBulgariaMode()
        };

        dropdown.addEventListener('change', async (event) => {
            const selectedMode = event.target.value;
            if (!selectedMode) {
                if (!this.isGlobeMode) {
                    this.toggleGlobeMode();
                }
                return;
            }

            const handler = dropdownModeHandlers[selectedMode];
            if (handler) {
                await handler();
            }
        });
        
        // ê¸°ì¡´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•˜ìœ„ í˜¸í™˜ì„±)
        usaBtn.addEventListener('click', () => {
            this.switchToUSAMode();
        });
        
        koreaBtn.addEventListener('click', () => {
            this.switchToKoreaMode();
        });
        
        japanBtn.addEventListener('click', () => {
            this.switchToJapanMode();
        });
        
        chinaBtn.addEventListener('click', () => {
            this.switchToChinaMode();
        });

        russiaBtn.addEventListener('click', () => {
            this.switchToRussiaMode();
        });

        indiaBtn.addEventListener('click', () => {
            this.switchToIndiaMode();
        });

        canadaBtn.addEventListener('click', () => {
            this.switchToCanadaMode();
        });

        germanyBtn.addEventListener('click', () => {
            this.switchToGermanyMode();
        });

        ukBtn.addEventListener('click', () => {
            this.switchToUKMode();
        });

        franceBtn.addEventListener('click', () => {
            this.switchToFranceMode();
        });

        italyBtn.addEventListener('click', () => {
            this.switchToItalyMode();
        });

        brazilBtn.addEventListener('click', () => {
            this.switchToBrazilMode();
        });

        australiaBtn.addEventListener('click', () => {
            this.switchToAustraliaMode();
        });

        mexicoBtn.addEventListener('click', () => {
            this.switchToMexicoMode();
        });

        indonesiaBtn.addEventListener('click', () => {
            this.switchToIndonesiaMode();
        });

        saudiArabiaBtn.addEventListener('click', () => {
            this.switchToSaudiArabiaMode();
        });

        turkeyBtn.addEventListener('click', () => {
            this.switchToTurkeyMode();
        });

        southAfricaBtn.addEventListener('click', () => {
            this.switchToSouthAfricaMode();
        });

        argentinaBtn.addEventListener('click', () => {
            this.switchToArgentinaMode();
        });
    }
    
    // ë¯¸êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToUSAMode() {
        if (this.currentMapMode === 'usa') return; // ì´ë¯¸ ë¯¸êµ­ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'usa';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [-95, 35],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('usa');
        
        await this.loadWorldData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë¯¸êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í•œêµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToKoreaMode() {
        if (this.currentMapMode === 'korea') return; // ì´ë¯¸ í•œêµ­ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'korea';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [127.5, 36.0],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('korea');
        
        await this.loadKoreaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í•œêµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì¼ë³¸ ëª¨ë“œë¡œ ì „í™˜
    async switchToJapanMode() {
        if (this.currentMapMode === 'japan') return; // ì´ë¯¸ ì¼ë³¸ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'japan';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [138.0, 36.0],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('japan');
        
        await this.loadJapanData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¼ë³¸ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì¤‘êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToChinaMode() {
        if (this.currentMapMode === 'china') return; // ì´ë¯¸ ì¤‘êµ­ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'china';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [104, 35],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('china');
        
        await this.loadChinaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¤‘êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ì¸ë„ ëª¨ë“œë¡œ ì „í™˜
    async switchToIndiaMode() {
        if (this.currentMapMode === 'india') return; // ì´ë¯¸ ì¸ë„ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'india';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [77, 20],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('india');
        
        await this.loadIndiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¸ë„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìºë‚˜ë‹¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToCanadaMode() {
        if (this.currentMapMode === 'canada') return; // ì´ë¯¸ ìºë‚˜ë‹¤ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'canada';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-106, 56],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('canada');
        
        await this.loadCanadaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìºë‚˜ë‹¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë…ì¼ ëª¨ë“œë¡œ ì „í™˜
    async switchToGermanyMode() {
        if (this.currentMapMode === 'germany') return;
        
        this.currentMapMode = 'germany';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [10, 51],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('canada');
        
        await this.loadGermanyData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë…ì¼ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì˜êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToUKMode() {
        if (this.currentMapMode === 'uk') return;
        
        this.currentMapMode = 'uk';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-3, 54],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('germany');
        
        await this.loadUKData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì˜êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í”„ë‘ìŠ¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToFranceMode() {
        if (this.currentMapMode === 'france') return;
        
        this.currentMapMode = 'france';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [2, 46],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('uk');
        
        await this.loadFranceData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í”„ë‘ìŠ¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì´íƒˆë¦¬ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToItalyMode() {
        if (this.currentMapMode === 'italy') return;
        
        this.currentMapMode = 'italy';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [12, 42],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('france');
        
        await this.loadItalyData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì´íƒˆë¦¬ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë¸Œë¼ì§ˆ ëª¨ë“œë¡œ ì „í™˜
    async switchToBrazilMode() {
        if (this.currentMapMode === 'brazil') return;
        
        this.currentMapMode = 'brazil';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-55, -15],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('brazil');
        
        await this.loadBrazilData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë¸Œë¼ì§ˆ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í˜¸ì£¼ ëª¨ë“œë¡œ ì „í™˜
    async switchToAustraliaMode() {
        if (this.currentMapMode === 'australia') return;
        
        this.currentMapMode = 'australia';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [133, -27],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('australia');
        
        await this.loadAustraliaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í˜¸ì£¼ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë©•ì‹œì½” ëª¨ë“œë¡œ ì „í™˜
    async switchToMexicoMode() {
        if (this.currentMapMode === 'mexico') return;
        
        this.currentMapMode = 'mexico';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-102, 23],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('mexico');
        
        await this.loadMexicoData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë©•ì‹œì½” ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì¸ë„ë„¤ì‹œì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToIndonesiaMode() {
        if (this.currentMapMode === 'indonesia') return;
        
        this.currentMapMode = 'indonesia';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [113, -5],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('indonesia');
        
        await this.loadIndonesiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¸ë„ë„¤ì‹œì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToSaudiArabiaMode() {
        if (this.currentMapMode === 'saudi-arabia') return;
        
        this.currentMapMode = 'saudi-arabia';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [45, 24],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('indonesia');
        
        await this.loadSaudiArabiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í„°í‚¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToTurkeyMode() {
        if (this.currentMapMode === 'turkey') return;
        
        this.currentMapMode = 'turkey';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [35, 39],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('turkey');
        
        await this.loadTurkeyData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í„°í‚¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToSouthAfricaMode() {
        if (this.currentMapMode === 'south-africa') return;
        
        this.currentMapMode = 'south-africa';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [22, -30],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('turkey');
        
        await this.loadSouthAfricaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì•„ë¥´í—¨í‹°ë‚˜ ëª¨ë“œë¡œ ì „í™˜
    async switchToArgentinaMode() {
        if (this.currentMapMode === 'argentina') return;
        
        this.currentMapMode = 'argentina';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-63, -38],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('south-africa');
        
        await this.loadArgentinaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì•„ë¥´í—¨í‹°ë‚˜ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìœ ëŸ½ì—°í•© ëª¨ë“œë¡œ ì „í™˜
    async switchToEuropeanUnionMode() {
        if (this.currentMapMode === 'european-union') return;
        
        this.currentMapMode = 'european-union';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [10, 50],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('argentina');
        
        await this.loadEuropeanUnionData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìœ ëŸ½ì—°í•© ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìŠ¤í˜ì¸ ëª¨ë“œë¡œ ì „í™˜
    async switchToSpainMode() {
        if (this.currentMapMode === 'spain') return;
        this.currentMapMode = 'spain';
        this.updateModeButtons();
        this.map.easeTo({ center: [-3, 40], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('spain');
        
        await this.loadSpainData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìŠ¤í˜ì¸ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë„¤ëœë€ë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToNetherlandsMode() {
        if (this.currentMapMode === 'netherlands') return;
        this.currentMapMode = 'netherlands';
        this.updateModeButtons();
        this.map.easeTo({ center: [5, 52], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('spain');
        
        await this.loadNetherlandsData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë„¤ëœë€ë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í´ë€ë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToPolandMode() {
        if (this.currentMapMode === 'poland') return;
        this.currentMapMode = 'poland';
        this.updateModeButtons();
        this.map.easeTo({ center: [19, 52], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('netherlands');
        
        await this.loadPolandData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í´ë€ë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë²¨ê¸°ì— ëª¨ë“œë¡œ ì „í™˜
    async switchToBelgiumMode() {
        if (this.currentMapMode === 'belgium') return;
        this.currentMapMode = 'belgium';
        this.updateModeButtons();
        this.map.easeTo({ center: [4.5, 50.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('poland');
        
        await this.loadBelgiumData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë²¨ê¸°ì— ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìŠ¤ì›¨ë´ ëª¨ë“œë¡œ ì „í™˜
    async switchToSwedenMode() {
        if (this.currentMapMode === 'sweden') return;
        this.currentMapMode = 'sweden';
        this.updateModeButtons();
        this.map.easeTo({ center: [18, 60], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('belgium');
        
        await this.loadSwedenData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìŠ¤ì›¨ë´ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToAustriaMode() {
        if (this.currentMapMode === 'austria') return;
        this.currentMapMode = 'austria';
        this.updateModeButtons();
        this.map.easeTo({ center: [13, 47.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('sweden');
        
        await this.loadAustriaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë´ë§ˆí¬ ëª¨ë“œë¡œ ì „í™˜
    async switchToDenmarkMode() {
        if (this.currentMapMode === 'denmark') return;
        this.currentMapMode = 'denmark';
        this.updateModeButtons();
        this.map.easeTo({ center: [10, 56], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('austria');
        
        await this.loadDenmarkData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë´ë§ˆí¬ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í•€ë€ë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToFinlandMode() {
        if (this.currentMapMode === 'finland') return;
        this.currentMapMode = 'finland';
        this.updateModeButtons();
        this.map.easeTo({ center: [26, 64], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('denmark');
        
        await this.loadFinlandData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í•€ë€ë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì•„ì¼ëœë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToIrelandMode() {
        if (this.currentMapMode === 'ireland') return;
        this.currentMapMode = 'ireland';
        this.updateModeButtons();
        this.map.easeTo({ center: [-8, 53], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('finland');
        
        await this.loadIrelandData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì•„ì¼ëœë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í¬ë¥´íˆ¬ê°ˆ ëª¨ë“œë¡œ ì „í™˜
    async switchToPortugalMode() {
        if (this.currentMapMode === 'portugal') return;
        this.currentMapMode = 'portugal';
        this.updateModeButtons();
        this.map.easeTo({ center: [-8, 39.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('ireland');
        
        await this.loadPortugalData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í¬ë¥´íˆ¬ê°ˆ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ê·¸ë¦¬ìŠ¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToGreeceMode() {
        if (this.currentMapMode === 'greece') return;
        this.currentMapMode = 'greece';
        this.updateModeButtons();
        this.map.easeTo({ center: [23, 38], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('portugal');
        
        await this.loadGreeceData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ê·¸ë¦¬ìŠ¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì²´ì½” ëª¨ë“œë¡œ ì „í™˜
    async switchToCzechRepublicMode() {
        if (this.currentMapMode === 'czech-republic') return;
        this.currentMapMode = 'czech-republic';
        this.updateModeButtons();
        this.map.easeTo({ center: [15, 49.75], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('greece');
        
        await this.loadCzechRepublicData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì²´ì½” ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë£¨ë§ˆë‹ˆì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToRomaniaMode() {
        if (this.currentMapMode === 'romania') return;
        this.currentMapMode = 'romania';
        this.updateModeButtons();
        this.map.easeTo({ center: [25, 46], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('czech-republic');
        
        await this.loadRomaniaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë£¨ë§ˆë‹ˆì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í—ê°€ë¦¬ ëª¨ë“œë¡œ ì „í™˜
    async switchToHungaryMode() {
        if (this.currentMapMode === 'hungary') return;
        this.currentMapMode = 'hungary';
        this.updateModeButtons();
        this.map.easeTo({ center: [19.5, 47.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('romania');
        
        await this.loadHungaryData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í—ê°€ë¦¬ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë¶ˆê°€ë¦¬ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToBulgariaMode() {
        if (this.currentMapMode === 'bulgaria') return;
        this.currentMapMode = 'bulgaria';
        this.updateModeButtons();
        this.map.easeTo({ center: [25, 43], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('hungary');
        
        await this.loadBulgariaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë¶ˆê°€ë¦¬ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ëŸ¬ì‹œì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToRussiaMode() {
        if (this.currentMapMode === 'russia') return; // ì´ë¯¸ ëŸ¬ì‹œì•„ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'russia';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™
        this.map.easeTo({
            center: [100, 60],
            zoom: 3,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        await this.loadRegionDataForMode('bulgaria');
        
        await this.loadRussiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ëŸ¬ì‹œì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // êµ­ê°€ ëª¨ë“œë¡œ ì „í™˜ (ì¼ë°˜í™”ëœ í•¨ìˆ˜)
    async switchToCountryMode(countryCode) {
        // ê°’ ë³´ì •: 'cn' â†’ 'china', 'ru' â†’ 'russia'
        if (countryCode && countryCode.toLowerCase() === 'cn') countryCode = 'china';
        if (countryCode && countryCode.toLowerCase() === 'ru') countryCode = 'russia';
        const country = this.g20Countries[countryCode];
        if (!country) {
            console.error('Unknown country code:', countryCode);
            return;
        }
        
        // ì´ë¯¸ í•´ë‹¹ êµ­ê°€ ëª¨ë“œë©´ ì¤‘ë‹¨
        if (this.currentMapMode === countryCode) return;
        
        // íŠ¹ë³„ ì²˜ë¦¬: ë¯¸êµ­, í•œêµ­, ì¼ë³¸ì€ ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
        if (countryCode === 'usa') {
            await this.switchToUSAMode();
            return;
        } else if (countryCode === 'south-korea') {
            // 'south-korea'ë¥¼ 'korea'ë¡œ ë§¤í•‘
            await this.switchToKoreaMode();
            return;
        } else if (countryCode === 'japan') {
            await this.switchToJapanMode();
            return;
        } else if (countryCode === 'china') {
            await this.switchToChinaMode();
            return;
        } else if (countryCode === 'russia' || countryCode === 'ru') {
            await this.switchToRussiaMode();
            return;
        } else if (countryCode === 'india' || countryCode === 'in') {
            await this.switchToIndiaMode();
            return;
        } else if (countryCode === 'canada' || countryCode === 'ca') {
            await this.switchToCanadaMode();
            return;
        } else if (countryCode === 'germany' || countryCode === 'de') {
            await this.switchToGermanyMode();
            return;
        } else if (countryCode === 'uk' || countryCode === 'gb') {
            await this.switchToUKMode();
            return;
        } else if (countryCode === 'france' || countryCode === 'fr') {
            await this.switchToFranceMode();
            return;
        } else if (countryCode === 'italy' || countryCode === 'it') {
            await this.switchToItalyMode();
            return;
        } else if (countryCode === 'brazil' || countryCode === 'br') {
            await this.switchToBrazilMode();
            return;
        } else if (countryCode === 'australia' || countryCode === 'au') {
            await this.switchToAustraliaMode();
            return;
        } else if (countryCode === 'mexico' || countryCode === 'mx') {
            await this.switchToMexicoMode();
            return;
        } else if (countryCode === 'indonesia' || countryCode === 'id') {
            await this.switchToIndonesiaMode();
            return;
        } else if (countryCode === 'saudi-arabia' || countryCode === 'sa') {
            await this.switchToSaudiArabiaMode();
            return;
        } else if (countryCode === 'turkey' || countryCode === 'tr') {
            await this.switchToTurkeyMode();
            return;
        } else if (countryCode === 'south-africa' || countryCode === 'za') {
            await this.switchToSouthAfricaMode();
            return;
        } else if (countryCode === 'argentina' || countryCode === 'ar') {
            await this.switchToArgentinaMode();
            return;
        } else if (countryCode === 'european-union' || countryCode === 'eu') {
            await this.switchToEuropeanUnionMode();
            return;
        } else if (countryCode === 'spain' || countryCode === 'es') {
            await this.switchToSpainMode();
            return;
        } else if (countryCode === 'netherlands' || countryCode === 'nl') {
            await this.switchToNetherlandsMode();
            return;
        } else if (countryCode === 'poland' || countryCode === 'pl') {
            await this.switchToPolandMode();
            return;
        } else if (countryCode === 'belgium' || countryCode === 'be') {
            await this.switchToBelgiumMode();
            return;
        } else if (countryCode === 'sweden' || countryCode === 'se') {
            await this.switchToSwedenMode();
            return;
        } else if (countryCode === 'austria' || countryCode === 'at') {
            await this.switchToAustriaMode();
            return;
        } else if (countryCode === 'denmark' || countryCode === 'dk') {
            await this.switchToDenmarkMode();
            return;
        } else if (countryCode === 'finland' || countryCode === 'fi') {
            await this.switchToFinlandMode();
            return;
        } else if (countryCode === 'ireland' || countryCode === 'ie') {
            await this.switchToIrelandMode();
            return;
        } else if (countryCode === 'portugal' || countryCode === 'pt') {
            await this.switchToPortugalMode();
            return;
        } else if (countryCode === 'greece' || countryCode === 'gr') {
            await this.switchToGreeceMode();
            return;
        } else if (countryCode === 'czech-republic' || countryCode === 'cz') {
            await this.switchToCzechRepublicMode();
            return;
        } else if (countryCode === 'romania' || countryCode === 'ro') {
            await this.switchToRomaniaMode();
            return;
        } else if (countryCode === 'hungary' || countryCode === 'hu') {
            await this.switchToHungaryMode();
            return;
        } else if (countryCode === 'bulgaria' || countryCode === 'bg') {
            await this.switchToBulgariaMode();
            return;
        }
        
        // ê¸°íƒ€ êµ­ê°€: ê¸°ë³¸ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜
        this.currentMapMode = countryCode;
        this.updateModeButtons();
        
        // ì§€ë„ ì´ë™
        this.map.easeTo({
            center: country.center,
            zoom: country.zoom,
            duration: 600
        });
        
        // ì„¸ê³„ ë°ì´í„° ë¡œë“œ (í•´ë‹¹ êµ­ê°€ì˜ ê²½ê³„ì„ ë§Œ í‘œì‹œ)
        await this.loadWorldData();
        
        this.showNotification(`${country.name} ì§€ë„ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
    }
    
    // ëª¨ë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateModeButtons() {
        const usaBtn = document.getElementById('usa-mode-btn');
        const koreaBtn = document.getElementById('korea-mode-btn');
        const japanBtn = document.getElementById('japan-mode-btn');
        const chinaBtn = document.getElementById('china-mode-btn');
        const russiaBtn = document.getElementById('russia-mode-btn');
        const indiaBtn = document.getElementById('india-mode-btn');
        const canadaBtn = document.getElementById('canada-mode-btn');
        const germanyBtn = document.getElementById('germany-mode-btn');
        const ukBtn = document.getElementById('uk-mode-btn');
        const franceBtn = document.getElementById('france-mode-btn');
        const italyBtn = document.getElementById('italy-mode-btn');
        const brazilBtn = document.getElementById('brazil-mode-btn');
        const australiaBtn = document.getElementById('australia-mode-btn');
        const mexicoBtn = document.getElementById('mexico-mode-btn');
        const indonesiaBtn = document.getElementById('indonesia-mode-btn');
        const saudiArabiaBtn = document.getElementById('saudi-arabia-mode-btn');
        const turkeyBtn = document.getElementById('turkey-mode-btn');
        const southAfricaBtn = document.getElementById('south-africa-mode-btn');
        const argentinaBtn = document.getElementById('argentina-mode-btn');
        const globeBtn = document.getElementById('globe-mode-btn');
        
        // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì—…ë°ì´íŠ¸
        const dropdown = this.modeDropdown || document.getElementById('country-mode-dropdown');
        if (!this.modeDropdown && dropdown) {
            this.modeDropdown = dropdown;
        }
        if (dropdown) {
            if (this.isGlobeMode) {
                dropdown.value = '';
            } else {
                const availableOption = Array.from(dropdown.options).some(option => option.value === this.currentMapMode);
                dropdown.value = availableOption ? this.currentMapMode : '';
            }
        }
        
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        if (usaBtn) usaBtn.classList.remove('active');
        if (koreaBtn) koreaBtn.classList.remove('active');
        if (japanBtn) japanBtn.classList.remove('active');
        if (chinaBtn) chinaBtn.classList.remove('active');
        if (russiaBtn) russiaBtn.classList.remove('active');
        if (indiaBtn) indiaBtn.classList.remove('active');
        if (canadaBtn) canadaBtn.classList.remove('active');
        if (germanyBtn) germanyBtn.classList.remove('active');
        if (ukBtn) ukBtn.classList.remove('active');
        if (franceBtn) franceBtn.classList.remove('active');
        if (italyBtn) italyBtn.classList.remove('active');
        if (brazilBtn) brazilBtn.classList.remove('active');
        if (australiaBtn) australiaBtn.classList.remove('active');
        if (mexicoBtn) mexicoBtn.classList.remove('active');
        if (indonesiaBtn) indonesiaBtn.classList.remove('active');
        if (saudiArabiaBtn) saudiArabiaBtn.classList.remove('active');
        if (turkeyBtn) turkeyBtn.classList.remove('active');
        if (southAfricaBtn) southAfricaBtn.classList.remove('active');
        if (argentinaBtn) argentinaBtn.classList.remove('active');
        if (globeBtn) globeBtn.classList.remove('active');
        
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ active í´ë˜ìŠ¤ ì¶”ê°€
        if (this.isGlobeMode && globeBtn) {
            globeBtn.classList.add('active');
        } else if (this.currentMapMode === 'usa' && usaBtn) {
            usaBtn.classList.add('active');
        } else if (this.currentMapMode === 'korea' && koreaBtn) {
            koreaBtn.classList.add('active');
        } else if (this.currentMapMode === 'japan' && japanBtn) {
            japanBtn.classList.add('active');
        } else if (this.currentMapMode === 'china' && chinaBtn) {
            chinaBtn.classList.add('active');
        } else if (this.currentMapMode === 'russia' && russiaBtn) {
            russiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'india' && indiaBtn) {
            indiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'canada' && canadaBtn) {
            canadaBtn.classList.add('active');
        } else if (this.currentMapMode === 'germany' && germanyBtn) {
            germanyBtn.classList.add('active');
        } else if (this.currentMapMode === 'uk' && ukBtn) {
            ukBtn.classList.add('active');
        } else if (this.currentMapMode === 'france' && franceBtn) {
            franceBtn.classList.add('active');
        } else if (this.currentMapMode === 'italy' && italyBtn) {
            italyBtn.classList.add('active');
        } else if (this.currentMapMode === 'brazil' && brazilBtn) {
            brazilBtn.classList.add('active');
        } else if (this.currentMapMode === 'australia' && australiaBtn) {
            australiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'mexico' && mexicoBtn) {
            mexicoBtn.classList.add('active');
        } else if (this.currentMapMode === 'indonesia' && indonesiaBtn) {
            indonesiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'saudi-arabia' && saudiArabiaBtn) {
            saudiArabiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'turkey' && turkeyBtn) {
            turkeyBtn.classList.add('active');
        } else if (this.currentMapMode === 'south-africa' && southAfricaBtn) {
            southAfricaBtn.classList.add('active');
        } else if (this.currentMapMode === 'argentina' && argentinaBtn) {
            argentinaBtn.classList.add('active');
        }
    }
    
    // ì¼ë³¸ ë°ì´í„° ë¡œë“œ
    async loadJapanData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('japan', async () => {
                // ì¼ë³¸ ë°ì´í„° ë¡œë“œ (ë„ë„ë¶€í˜„ ë‹¨ìœ„) - ì •í™•í•œ ê²½ê³„ ë°ì´í„° ì‚¬ìš©
                const japanUrl = this.getAssetUrl('data/japan-prefectures-accurate.geojson');
                console.log('[loadJapanData] ìš”ì²­ URL:', japanUrl);
                const response = await fetch(japanUrl, { cache: 'no-store' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[loadJapanData] HTTP ì—ëŸ¬:', response.status, response.statusText);
                    console.error('[loadJapanData] ì‘ë‹µ ë‚´ìš©:', errorText.substring(0, 200));
                    throw new Error(`ì¼ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: HTTP ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                
                // ê° ì§€ì—­ì— ê´‘ê³  ì •ë³´ ì¶”ê°€ (ë„ë„ë¶€í˜„ ë‹¨ìœ„)
                data.features.forEach((feature, index) => {
                const props = feature.properties;
                
                // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ì†ì„± ë§¤í•‘
                const prefectureNameJa = props.nam_ja || props.name || `Prefecture_${index}`;
                const prefectureNameEn = props.nam || props.name_en || prefectureNameJa;
                const prefectureId = props.id ? `prefecture_${props.id}` : `prefecture_${index}`;
                
                // ì¼ë³¸ ë„ë„ë¶€í˜„ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (ì‹¤ì œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸)
                const prefectureData = {
                    1: { name: "Hokkaido", name_ja: "åŒ—æµ·é“", population: 5179000, area: 83424 },
                    2: { name: "Aomori", name_ja: "é’æ£®çœŒ", population: 1175000, area: 9645 },
                    3: { name: "Iwate", name_ja: "å²©æ‰‹çœŒ", population: 1187000, area: 15275 },
                    4: { name: "Miyagi", name_ja: "å®®åŸçœŒ", population: 2265000, area: 7282 },
                    5: { name: "Akita", name_ja: "ç§‹ç”°çœŒ", population: 915000, area: 11637 },
                    6: { name: "Yamagata", name_ja: "å±±å½¢çœŒ", population: 1050000, area: 9323 },
                    7: { name: "Fukushima", name_ja: "ç¦å³¶çœŒ", population: 1780000, area: 13783 },
                    8: { name: "Ibaraki", name_ja: "èŒ¨åŸçœŒ", population: 2824000, area: 6096 },
                    9: { name: "Tochigi", name_ja: "æ ƒæœ¨çœŒ", population: 1928000, area: 6408 },
                    10: { name: "Gunma", name_ja: "ç¾¤é¦¬çœŒ", population: 1933000, area: 6363 },
                    11: { name: "Saitama", name_ja: "åŸ¼ç‰çœŒ", population: 7389000, area: 3798 },
                    12: { name: "Chiba", name_ja: "åƒè‘‰çœŒ", population: 6364000, area: 5157 },
                    13: { name: "Tokyo", name_ja: "æ±äº¬éƒ½", population: 14049000, area: 2194 },
                    14: { name: "Kanagawa", name_ja: "ç¥å¥ˆå·çœŒ", population: 9232000, area: 2416 },
                    15: { name: "Niigata", name_ja: "æ–°æ½ŸçœŒ", population: 2117000, area: 12583 },
                    16: { name: "Toyama", name_ja: "å¯Œå±±çœŒ", population: 1016000, area: 4247 },
                    17: { name: "Ishikawa", name_ja: "çŸ³å·çœŒ", population: 1100000, area: 4186 },
                    18: { name: "Fukui", name_ja: "ç¦äº•çœŒ", population: 750000, area: 4189 },
                    19: { name: "Yamanashi", name_ja: "å±±æ¢¨çœŒ", population: 800000, area: 4465 },
                    20: { name: "Nagano", name_ja: "é•·é‡çœŒ", population: 2000000, area: 13562 },
                    21: { name: "Gifu", name_ja: "å²é˜œçœŒ", population: 1970000, area: 10621 },
                    22: { name: "Shizuoka", name_ja: "é™å²¡çœŒ", population: 3588000, area: 7777 },
                    23: { name: "Aichi", name_ja: "æ„›çŸ¥çœŒ", population: 7552000, area: 5172 },
                    24: { name: "Mie", name_ja: "ä¸‰é‡çœŒ", population: 1726000, area: 5774 },
                    25: { name: "Shiga", name_ja: "æ»‹è³€çœŒ", population: 1405000, area: 4017 },
                    26: { name: "Kyoto", name_ja: "äº¬éƒ½åºœ", population: 2525000, area: 4613 },
                    27: { name: "Osaka", name_ja: "å¤§é˜ªåºœ", population: 8783000, area: 1905 },
                    28: { name: "Hyogo", name_ja: "å…µåº«çœŒ", population: 5418000, area: 8400 },
                    29: { name: "Nara", name_ja: "å¥ˆè‰¯çœŒ", population: 1298000, area: 3691 },
                    30: { name: "Wakayama", name_ja: "å’Œæ­Œå±±çœŒ", population: 897000, area: 4726 },
                    31: { name: "Tottori", name_ja: "é³¥å–çœŒ", population: 538000, area: 3507 },
                    32: { name: "Shimane", name_ja: "å³¶æ ¹çœŒ", population: 656000, area: 6708 },
                    33: { name: "Okayama", name_ja: "å²¡å±±çœŒ", population: 1871000, area: 7114 },
                    34: { name: "Hiroshima", name_ja: "åºƒå³¶çœŒ", population: 2777000, area: 8480 },
                    35: { name: "Yamaguchi", name_ja: "å±±å£çœŒ", population: 1285000, area: 6113 },
                    36: { name: "Tokushima", name_ja: "å¾³å³¶çœŒ", population: 713000, area: 4147 },
                    37: { name: "Kagawa", name_ja: "é¦™å·çœŒ", population: 944000, area: 1877 },
                    38: { name: "Ehime", name_ja: "æ„›åª›çœŒ", population: 1305000, area: 5676 },
                    39: { name: "Kochi", name_ja: "é«˜çŸ¥çœŒ", population: 670000, area: 7104 },
                    40: { name: "Fukuoka", name_ja: "ç¦å²¡çœŒ", population: 5095000, area: 4987 },
                    41: { name: "Saga", name_ja: "ä½è³€çœŒ", population: 812000, area: 2440 },
                    42: { name: "Nagasaki", name_ja: "é•·å´çœŒ", population: 1260000, area: 4132 },
                    43: { name: "Kumamoto", name_ja: "ç†Šæœ¬çœŒ", population: 1725000, area: 7409 },
                    44: { name: "Oita", name_ja: "å¤§åˆ†çœŒ", population: 1116000, area: 6341 },
                    45: { name: "Miyazaki", name_ja: "å®®å´çœŒ", population: 1046000, area: 7735 },
                    46: { name: "Kagoshima", name_ja: "é¹¿å…å³¶çœŒ", population: 1537000, area: 9188 },
                    47: { name: "Okinawa", name_ja: "æ²–ç¸„çœŒ", population: 1464000, area: 2282 }
                };
                
                const data = prefectureData[props.id] || { name: prefectureNameJa, name_ja: prefectureNameJa, population: 1000000, area: 5000 };
                
                feature.properties = {
                    ...props,
                    id: prefectureId,
                    name: data.name, // ì˜ì–´ ì´ë¦„ì„ ë©”ì¸ìœ¼ë¡œ í‘œì‹œ
                    name_en: data.name,
                    name_ja: data.name_ja, // ì¼ë³¸ì–´ ì´ë¦„ë„ ë³´ì¡´
                    country: 'Japan',
                    admin_level: 'Prefecture',
                    population: data.population,
                    area: data.area,
                    ad_status: 'available',
                    ad_price: Math.floor(Math.random() * 100000) + 10000,
                    revenue: 0,
                    company: null,
                    logo: null,
                    color: '#4ecdc4',
                    border_color: '#ffffff',
                    border_width: 1
                };
                
                this.regionData.set(prefectureId, feature.properties);
            });
            
            return data;
            });
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (ë” ë¹ ë¦„)
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                // ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                this.map.addSource('world-regions', {
                    type: 'geojson',
                    data: geoJsonData
                });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            ['==', ['get', 'ad_status'], 'selected'],
                            '#feca57',
                            '#4ecdc4'
                        ],
                        'fill-opacity': 0.7
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•œ ë²ˆë§Œ ì¶”ê°€
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ì¼ë³¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ë„ë„ë¶€í˜„');
            
        } catch (error) {
            console.error('ì¼ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¼ë³¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¤‘êµ­ ì„± í•œêµ­ì–´ í‘œê¸° ë§¤í•‘
    getKoreanProvinceName(rawName) {
        if (!rawName) return rawName;
        const mapZhToKo = {
            'åŒ—äº¬å¸‚': 'ë² ì´ì§•ì‹œ',
            'å¤©æ´¥å¸‚': 'í†ˆì§„ì‹œ',
            'æ²³åŒ—çœ': 'í—ˆë² ì´ì„±',
            'å±±è¥¿çœ': 'ì‚°ì‹œì„±',
            'å†…è’™å¤è‡ªæ²»åŒº': 'ë‚´ëª½ê³¨ìì¹˜êµ¬',
            'è¾½å®çœ': 'ë´ì˜¤ë‹ì„±',
            'å‰æ—çœ': 'ì§€ë¦°ì„±',
            'é»‘é¾™æ±Ÿçœ': 'í—¤ì´ë£½ì¥ì„±',
            'ä¸Šæµ·å¸‚': 'ìƒí•˜ì´ì‹œ',
            'æ±Ÿè‹çœ': 'ì¥ì‘¤ì„±',
            'æµ™æ±Ÿçœ': 'ì €ì¥ì„±',
            'å®‰å¾½çœ': 'ì•ˆí›„ì´ì„±',
            'ç¦å»ºçœ': 'í‘¸ì  ì„±',
            'æ±Ÿè¥¿çœ': 'ì¥ì‹œì„±',
            'å±±ä¸œçœ': 'ì‚°ë‘¥ì„±',
            'æ²³å—çœ': 'í—ˆë‚œì„±',
            'æ¹–åŒ—çœ': 'í›„ë² ì´ì„±',
            'æ¹–å—çœ': 'í›„ë‚œì„±',
            'å¹¿ä¸œçœ': 'ê´‘ë‘¥ì„±',
            'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 'ê´‘ì‹œì¢¡ì¡±ìì¹˜êµ¬',
            'æµ·å—çœ': 'í•˜ì´ë‚œì„±',
            'é‡åº†å¸‚': 'ì¶©ì¹­ì‹œ',
            'å››å·çœ': 'ì“°ì´¨ì„±',
            'è´µå·çœ': 'êµ¬ì´ì €ìš°ì„±',
            'äº‘å—çœ': 'ìœˆë‚œì„±',
            'è¥¿è—è‡ªæ²»åŒº': 'í‹°ë² íŠ¸ìì¹˜êµ¬',
            'é™•è¥¿çœ': 'ì‚°ì‹œì„±(ì„¬ì„œ)',
            'ç”˜è‚ƒçœ': 'ê°„ì‘¤ì„±',
            'é’æµ·çœ': 'ì¹­í•˜ì´ì„±',
            'å®å¤å›æ—è‡ªæ²»åŒº': 'ë‹ìƒ¤í›„ì´ì¡±ìì¹˜êµ¬',
            'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 'ì‹ ì¥ìœ„êµ¬ë¥´ìì¹˜êµ¬',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'í™ì½©íŠ¹ë³„í–‰ì •êµ¬',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'ë§ˆì¹´ì˜¤íŠ¹ë³„í–‰ì •êµ¬',
            'å°æ¹¾çœ': 'íƒ€ì´ì™„'
        };
        const mapEnToKo = {
            'Beijing': 'ë² ì´ì§•ì‹œ',
            'Tianjin': 'í†ˆì§„ì‹œ',
            'Hebei': 'í—ˆë² ì´ì„±',
            'Shanxi': 'ì‚°ì‹œì„±',
            'Inner Mongolia': 'ë‚´ëª½ê³¨ìì¹˜êµ¬',
            'Liaoning': 'ë´ì˜¤ë‹ì„±',
            'Jilin': 'ì§€ë¦°ì„±',
            'Heilongjiang': 'í—¤ì´ë£½ì¥ì„±',
            'Shanghai': 'ìƒí•˜ì´ì‹œ',
            'Jiangsu': 'ì¥ì‘¤ì„±',
            'Zhejiang': 'ì €ì¥ì„±',
            'Anhui': 'ì•ˆí›„ì´ì„±',
            'Fujian': 'í‘¸ì  ì„±',
            'Jiangxi': 'ì¥ì‹œì„±',
            'Shandong': 'ì‚°ë‘¥ì„±',
            'Henan': 'í—ˆë‚œì„±',
            'Hubei': 'í›„ë² ì´ì„±',
            'Hunan': 'í›„ë‚œì„±',
            'Guangdong': 'ê´‘ë‘¥ì„±',
            'Guangxi': 'ê´‘ì‹œì¢¡ì¡±ìì¹˜êµ¬',
            'Hainan': 'í•˜ì´ë‚œì„±',
            'Chongqing': 'ì¶©ì¹­ì‹œ',
            'Sichuan': 'ì“°ì´¨ì„±',
            'Guizhou': 'êµ¬ì´ì €ìš°ì„±',
            'Yunnan': 'ìœˆë‚œì„±',
            'Tibet': 'í‹°ë² íŠ¸ìì¹˜êµ¬',
            'Shaanxi': 'ì‚°ì‹œì„±(ì„¬ì„œ)',
            'Gansu': 'ê°„ì‘¤ì„±',
            'Qinghai': 'ì¹­í•˜ì´ì„±',
            'Ningxia': 'ë‹ìƒ¤í›„ì´ì¡±ìì¹˜êµ¬',
            'Xinjiang': 'ì‹ ì¥ìœ„êµ¬ë¥´ìì¹˜êµ¬',
            'Hong Kong': 'í™ì½©íŠ¹ë³„í–‰ì •êµ¬',
            'Macau': 'ë§ˆì¹´ì˜¤íŠ¹ë³„í–‰ì •êµ¬',
            'Taiwan': 'íƒ€ì´ì™„'
        };
        if (mapZhToKo[rawName]) return mapZhToKo[rawName];
        if (mapEnToKo[rawName]) return mapEnToKo[rawName];
        return rawName;
    }

    // ì¤‘êµ­ ë°ì´í„° ë¡œë“œ (ì„± ë‹¨ìœ„)
    async loadChinaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('china', async () => {
                const data = await this.fetchGeoJsonWithFallback('china', {
                    urls: [
                        this.getAssetUrl('data/china-provinces.geojson'),
                        'https://raw.githubusercontent.com/longwosion/geojson-map-china/master/china.json'
                    ],
                    localPath: 'data/china-provinces.geojson',
                    minFeatures: 25
                });
                
                // ì¤‘êµ­ ì„±ê¸‰ í–‰ì •êµ¬ì—­ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const chinaProvinceData = {
                    // í•œì í‘œê¸°
                    'åŒ—äº¬å¸‚': { population: 21893000, area: 16410 },
                    'å¤©æ´¥å¸‚': { population: 13870000, area: 11946 },
                    'ä¸Šæµ·å¸‚': { population: 24870000, area: 6341 },
                    'é‡åº†å¸‚': { population: 32130000, area: 82403 },
                    'æ²³åŒ—çœ': { population: 74610000, area: 187700 },
                    'å±±è¥¿çœ': { population: 34900000, area: 156700 },
                    'è¾½å®çœ': { population: 42380000, area: 148000 },
                    'å‰æ—çœ': { population: 23920000, area: 187400 },
                    'é»‘é¾™æ±Ÿçœ': { population: 30380000, area: 473000 },
                    'æ±Ÿè‹çœ': { population: 85120000, area: 102600 },
                    'æµ™æ±Ÿçœ': { population: 65770000, area: 105500 },
                    'å®‰å¾½çœ': { population: 61130000, area: 139400 },
                    'ç¦å»ºçœ': { population: 42890000, area: 121400 },
                    'æ±Ÿè¥¿çœ': { population: 45380000, area: 166900 },
                    'å±±ä¸œçœ': { population: 101700000, area: 157100 },
                    'æ²³å—çœ': { population: 99000000, area: 167000 },
                    'æ¹–åŒ—çœ': { population: 58060000, area: 185900 },
                    'æ¹–å—çœ': { population: 66440000, area: 211800 },
                    'å¹¿ä¸œçœ': { population: 127000000, area: 179700 },
                    'æµ·å—çœ': { population: 10420000, area: 35400 },
                    'å››å·çœ': { population: 83670000, area: 485000 },
                    'è´µå·çœ': { population: 38640000, area: 176000 },
                    'äº‘å—çœ': { population: 47680000, area: 394000 },
                    'é™•è¥¿çœ': { population: 39520000, area: 205600 },
                    'ç”˜è‚ƒçœ': { population: 25030000, area: 425800 },
                    'é’æµ·çœ': { population: 5920000, area: 721000 },
                    'å†…è’™å¤è‡ªæ²»åŒº': { population: 24040000, area: 1183000 },
                    'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': { population: 50120000, area: 236700 },
                    'è¥¿è—è‡ªæ²»åŒº': { population: 3660000, area: 1228000 },
                    'å®å¤å›æ—è‡ªæ²»åŒº': { population: 7320000, area: 66400 },
                    'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': { population: 25900000, area: 1664900 },
                    'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': { population: 7493000, area: 1106 },
                    'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': { population: 682000, area: 33 },
                    'å°æ¹¾çœ': { population: 23410000, area: 36193 },
                    // ì˜ì–´ ì´ë¦„
                    'Beijing': { population: 21893000, area: 16410 },
                    'Tianjin': { population: 13870000, area: 11946 },
                    'Shanghai': { population: 24870000, area: 6341 },
                    'Chongqing': { population: 32130000, area: 82403 },
                    'Hebei': { population: 74610000, area: 187700 },
                    'Shanxi': { population: 34900000, area: 156700 },
                    'Liaoning': { population: 42380000, area: 148000 },
                    'Jilin': { population: 23920000, area: 187400 },
                    'Heilongjiang': { population: 30380000, area: 473000 },
                    'Jiangsu': { population: 85120000, area: 102600 },
                    'Zhejiang': { population: 65770000, area: 105500 },
                    'Anhui': { population: 61130000, area: 139400 },
                    'Fujian': { population: 42890000, area: 121400 },
                    'Jiangxi': { population: 45380000, area: 166900 },
                    'Shandong': { population: 101700000, area: 157100 },
                    'Henan': { population: 99000000, area: 167000 },
                    'Hubei': { population: 58060000, area: 185900 },
                    'Hunan': { population: 66440000, area: 211800 },
                    'Guangdong': { population: 127000000, area: 179700 },
                    'Hainan': { population: 10420000, area: 35400 },
                    'Sichuan': { population: 83670000, area: 485000 },
                    'Guizhou': { population: 38640000, area: 176000 },
                    'Yunnan': { population: 47680000, area: 394000 },
                    'Shaanxi': { population: 39520000, area: 205600 },
                    'Gansu': { population: 25030000, area: 425800 },
                    'Qinghai': { population: 5920000, area: 721000 },
                    'Inner Mongolia': { population: 24040000, area: 1183000 },
                    'Guangxi': { population: 50120000, area: 236700 },
                    'Tibet': { population: 3660000, area: 1228000 },
                    'Ningxia': { population: 7320000, area: 66400 },
                    'Xinjiang': { population: 25900000, area: 1664900 },
                    'Hong Kong': { population: 7493000, area: 1106 },
                    'Macau': { population: 682000, area: 33 },
                    'Taiwan': { population: 23410000, area: 36193 }
                };
                
                const idSet = new Set();
                
                data.features.forEach((feature, index) => {
                    const props = feature.properties || {};
                    const rawName = props.name || props.NL_NAME_1 || `Province_${index}`; // ì¤‘êµ­ì–´ëª…
                    const adcode = props.adcode || props.adcode99 || props.ID || `CN_${index}`;
                    const nameEn = props.name_en || props.NAME_1 || '';
                    
                    // ì§€ì—­ ë°ì´í„° ë§¤ì¹­ (ì—¬ëŸ¬ ì´ë¦„ íŒ¨í„´ ì‹œë„)
                    let regionData = null;
                    const searchKeys = [
                        rawName, // í•œì í‘œê¸°
                        nameEn, // ì˜ì–´ ì´ë¦„
                        this.getKoreanProvinceName(rawName) // í•œêµ­ì–´ ì´ë¦„ (í•œìë¡œ ì—­ë³€í™˜ ì‹œë„ëŠ” ì•ˆí•¨)
                    ];
                    
                    for (const key of searchKeys) {
                        if (key && chinaProvinceData[key]) {
                            regionData = chinaProvinceData[key];
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const population = regionData ? regionData.population : (props.population || Math.floor(Math.random() * 30000000) + 3000000);
                    const area = regionData ? regionData.area : (props.area || Math.floor(Math.random() * 500000) + 50000);
                    
                    // ê³ ìœ  ID ìƒì„± (í•œê¸€/ì¤‘ë¬¸ í¬í•¨ ì‹œ ì•ˆì „í•œ í‚¤ë¡œ ë³€í™˜)
                    const baseId = (rawName || adcode).toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    let finalId = baseId || `cn_province_${index}`;
                    let counter = 1;
                    while (idSet.has(finalId)) {
                        finalId = `${baseId}_${counter++}`;
                    }
                    idSet.add(finalId);
                    
                    feature.properties = {
                        ...props,
                        id: finalId,
                        name: rawName,
                        name_ko: this.getKoreanProvinceName(rawName),
                        name_en: nameEn || rawName,
                        country: 'China',
                        country_code: 'CN',
                        admin_level: 'Province',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#45b7d1',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', {
                    type: 'geojson',
                    data: geoJsonData
                });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            '#45b7d1'
                        ],
                        'fill-opacity': 0.6
                    }
                });
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ì¤‘êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì„±/ìì¹˜êµ¬/ì‹œ');
            this.showNotification(`ì¤‘êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì¤‘êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¤‘êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ (ì—°ë°©ì£¼ì²´ ë‹¨ìœ„: Oblast, Krai, Republic, Federal city ë“±)
    async loadRussiaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('russia', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries RUS ADM1 (ì‹ ë¢°ë„ ë†’ìŒ)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/RUS/ADM1/geoBoundaries-RUS-ADM1.geojson',
                    // Natural Earth admin-1 (ê²½ê³„ í’ˆì§ˆ ì¢‹ìŒ, í¬ë§· ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson',
                    // click_that_hood ëŸ¬ì‹œì•„
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/russia.geojson'
                ];
                
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 50) {
                            data = fetchedData;
                            console.log('[Russia] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 50) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Russia] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 50 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Russia] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Russia] Failed loading from', url, e);
                        }
                    }
                }
                // ë¡œì»¬ í´ë°±
                if (!data) {
                    try {
                        const localResp = await fetch('data/russia-regions.geojson', { cache: 'no-store' });
                        if (!localResp.ok) throw new Error(`Local HTTP ${localResp.status}`);
                        const localData = await localResp.json();
                        data = localData.type ? localData : { type: 'FeatureCollection', features: localData.features };
                        console.log('[Russia] Loaded from local fallback data/russia-regions.geojson');
                    } catch (e) {
                        console.warn('[Russia] Local fallback missing or invalid', e);
                    }
                }
                // í•„ìš” ì‹œ ëŸ¬ì‹œì•„ë§Œ í•„í„°ë§ (ì¼ë¶€ ì†ŒìŠ¤ëŠ” ì „ì„¸ê³„ admin-1ì„ ë°˜í™˜)
                if (data && Array.isArray(data.features) && data.features.length > 300) {
                    const filtered = data.features.filter((feature) => {
                        const p = feature.properties || {};
                        const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                        const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                        const iso2 = (p.iso_a2 || '').toUpperCase();
                        return a3 === 'RUS' || admin === 'Russia' || iso2 === 'RU';
                    });
                    if (filtered.length > 0) {
                        console.log(`[Russia] Filtered Natural Earth/global dataset to Russia only: ${filtered.length} features`);
                        data = { type: 'FeatureCollection', features: filtered };
                    }
                }
                if (!data) throw lastError || new Error('No Russia dataset available');

                // ëŸ¬ì‹œì•„ ì—°ë°©ì£¼ì²´ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const russiaRegionData = {
                    // ì—°ë°©ì‹œ (3ê°œ)
                    'Moscow': { population: 13010000, area: 2561 },
                    'Saint Petersburg': { population: 5617000, area: 1439 },
                    'Sevastopol': { population: 547000, area: 864 },
                    'ĞœĞ¾ÑĞºĞ²Ğ°': { population: 13010000, area: 2561 },
                    'Ğ¡Ğ°Ğ½ĞºÑ‚-ĞŸĞµÑ‚ĞµÑ€Ğ±ÑƒÑ€Ğ³': { population: 5617000, area: 1439 },
                    'Ğ¡ĞµĞ²Ğ°ÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»ÑŒ': { population: 547000, area: 864 },
                    // ê³µí™”êµ­ (22ê°œ)
                    'Republic of Adygea': { population: 447000, area: 7792 },
                    'Republic of Altai': { population: 212000, area: 92600 },
                    'Republic of Bashkortostan': { population: 4040000, area: 142947 },
                    'Republic of Buryatia': { population: 955000, area: 351334 },
                    'Republic of Dagestan': { population: 3160000, area: 50300 },
                    'Republic of Ingushetia': { population: 532000, area: 3625 },
                    'Kabardino-Balkar Republic': { population: 903000, area: 12500 },
                    'Republic of Kalmykia': { population: 271000, area: 74731 },
                    'Karachay-Cherkess Republic': { population: 464000, area: 14100 },
                    'Republic of Karelia': { population: 539000, area: 172400 },
                    'Republic of Komi': { population: 738000, area: 416800 },
                    'Republic of Mari El': { population: 663000, area: 23400 },
                    'Republic of Mordovia': { population: 717000, area: 26200 },
                    'Republic of Sakha (Yakutia)': { population: 991000, area: 3083523 },
                    'Republic of North Ossetiaâ€“Alania': { population: 699000, area: 8000 },
                    'Republic of Tatarstan': { population: 3900000, area: 67836 },
                    'Republic of Tuva': { population: 342000, area: 170500 },
                    'Udmurt Republic': { population: 1460000, area: 42100 },
                    'Republic of Khakassia': { population: 523000, area: 61900 },
                    'Chechen Republic': { population: 1500000, area: 15300 },
                    'Chuvash Republic': { population: 1180000, area: 18300 },
                    'Republic of Crimea': { population: 2420000, area: 26100 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞĞ´Ñ‹Ğ³ĞµÑ': { population: 447000, area: 7792 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞĞ»Ñ‚Ğ°Ğ¹': { population: 212000, area: 92600 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ‘Ğ°ÑˆĞºĞ¾Ñ€Ñ‚Ğ¾ÑÑ‚Ğ°Ğ½': { population: 4040000, area: 142947 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ‘ÑƒÑ€ÑÑ‚Ğ¸Ñ': { population: 955000, area: 351334 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ”Ğ°Ğ³ĞµÑÑ‚Ğ°Ğ½': { population: 3160000, area: 50300 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ˜Ğ½Ğ³ÑƒÑˆĞµÑ‚Ğ¸Ñ': { population: 532000, area: 3625 },
                    'ĞšĞ°Ğ±Ğ°Ñ€Ğ´Ğ¸Ğ½Ğ¾-Ğ‘Ğ°Ğ»ĞºĞ°Ñ€ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 903000, area: 12500 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ°Ğ»Ğ¼Ñ‹ĞºĞ¸Ñ': { population: 271000, area: 74731 },
                    'ĞšĞ°Ñ€Ğ°Ñ‡Ğ°ĞµĞ²Ğ¾-Ğ§ĞµÑ€ĞºĞµÑÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 464000, area: 14100 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ°Ñ€ĞµĞ»Ğ¸Ñ': { population: 539000, area: 172400 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ¾Ğ¼Ğ¸': { population: 738000, area: 416800 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞœĞ°Ñ€Ğ¸Ğ¹ Ğ­Ğ»': { population: 663000, area: 23400 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞœĞ¾Ñ€Ğ´Ğ¾Ğ²Ğ¸Ñ': { population: 717000, area: 26200 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¡Ğ°Ñ…Ğ° (Ğ¯ĞºÑƒÑ‚Ğ¸Ñ)': { population: 991000, area: 3083523 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¡ĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ĞÑĞµÑ‚Ğ¸Ñâ€“ĞĞ»Ğ°Ğ½Ğ¸Ñ': { population: 699000, area: 8000 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¢Ğ°Ñ‚Ğ°Ñ€ÑÑ‚Ğ°Ğ½': { population: 3900000, area: 67836 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¢Ñ‹Ğ²Ğ°': { population: 342000, area: 170500 },
                    'Ğ£Ğ´Ğ¼ÑƒÑ€Ñ‚ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 1460000, area: 42100 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¥Ğ°ĞºĞ°ÑĞ¸Ñ': { population: 523000, area: 61900 },
                    'Ğ§ĞµÑ‡ĞµĞ½ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 1500000, area: 15300 },
                    'Ğ§ÑƒĞ²Ğ°ÑˆÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 1180000, area: 18300 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšÑ€Ñ‹Ğ¼': { population: 2420000, area: 26100 },
                    // ë³€ê²½ì£¼ (9ê°œ)
                    'Altai Krai': { population: 2240000, area: 167996 },
                    'Zabaykalsky Krai': { population: 1030000, area: 431892 },
                    'Kamchatka Krai': { population: 291000, area: 472300 },
                    'Krasnodar Krai': { population: 5830000, area: 76000 },
                    'Krasnoyarsk Krai': { population: 2810000, area: 2366800 },
                    'Perm Krai': { population: 2600000, area: 160600 },
                    'Primorsky Krai': { population: 1890000, area: 165900 },
                    'Stavropol Krai': { population: 2730000, area: 66500 },
                    'Khabarovsk Krai': { population: 1240000, area: 787600 },
                    'ĞĞ»Ñ‚Ğ°Ğ¹ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2240000, area: 167996 },
                    'Ğ—Ğ°Ğ±Ğ°Ğ¹ĞºĞ°Ğ»ÑŒÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 1030000, area: 431892 },
                    'ĞšĞ°Ğ¼Ñ‡Ğ°Ñ‚ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 291000, area: 472300 },
                    'ĞšÑ€Ğ°ÑĞ½Ğ¾Ğ´Ğ°Ñ€ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 5830000, area: 76000 },
                    'ĞšÑ€Ğ°ÑĞ½Ğ¾ÑÑ€ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2810000, area: 2366800 },
                    'ĞŸĞµÑ€Ğ¼ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2600000, area: 160600 },
                    'ĞŸÑ€Ğ¸Ğ¼Ğ¾Ñ€ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 1890000, area: 165900 },
                    'Ğ¡Ñ‚Ğ°Ğ²Ñ€Ğ¾Ğ¿Ğ¾Ğ»ÑŒÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2730000, area: 66500 },
                    'Ğ¥Ğ°Ğ±Ğ°Ñ€Ğ¾Ğ²ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 1240000, area: 787600 },
                    // ì£¼ (46ê°œ)
                    'Amur Oblast': { population: 780000, area: 363700 },
                    'Arkhangelsk Oblast': { population: 1080000, area: 587400 },
                    'Astrakhan Oblast': { population: 991000, area: 44100 },
                    'Belgorod Oblast': { population: 1550000, area: 27100 },
                    'Bryansk Oblast': { population: 1150000, area: 34900 },
                    'Chelyabinsk Oblast': { population: 3350000, area: 88500 },
                    'Irkutsk Oblast': { population: 2310000, area: 767900 },
                    'Ivanovo Oblast': { population: 990000, area: 21400 },
                    'Kaliningrad Oblast': { population: 1030000, area: 15100 },
                    'Kaluga Oblast': { population: 1010000, area: 29900 },
                    'Kemerovo Oblast': { population: 2530000, area: 95700 },
                    'Kirov Oblast': { population: 1200000, area: 120800 },
                    'Kostroma Oblast': { population: 600000, area: 60200 },
                    'Kurgan Oblast': { population: 780000, area: 71000 },
                    'Kursk Oblast': { population: 1060000, area: 29800 },
                    'Leningrad Oblast': { population: 1940000, area: 83900 },
                    'Lipetsk Oblast': { population: 1110000, area: 24000 },
                    'Magadan Oblast': { population: 130000, area: 462500 },
                    'Moscow Oblast': { population: 8300000, area: 44300 },
                    'Murmansk Oblast': { population: 730000, area: 144900 },
                    'Nizhny Novgorod Oblast': { population: 3130000, area: 74800 },
                    'Novosibirsk Oblast': { population: 2790000, area: 177800 },
                    'Omsk Oblast': { population: 1870000, area: 139700 },
                    'Orenburg Oblast': { population: 1950000, area: 123700 },
                    'Oryol Oblast': { population: 700000, area: 24700 },
                    'Penza Oblast': { population: 1220000, area: 43200 },
                    'Pskov Oblast': { population: 570000, area: 55400 },
                    'Rostov Oblast': { population: 4100000, area: 100800 },
                    'Ryazan Oblast': { population: 1080000, area: 39600 },
                    'Samara Oblast': { population: 3150000, area: 53600 },
                    'Saratov Oblast': { population: 2340000, area: 101200 },
                    'Sakhalin Oblast': { population: 470000, area: 87100 },
                    'Sverdlovsk Oblast': { population: 4230000, area: 194300 },
                    'Smolensk Oblast': { population: 900000, area: 49800 },
                    'Tambov Oblast': { population: 970000, area: 34500 },
                    'Tomsk Oblast': { population: 1050000, area: 314400 },
                    'Tula Oblast': { population: 1460000, area: 25700 },
                    'Tyumen Oblast': { population: 1700000, area: 160100 },
                    'Ulyanovsk Oblast': { population: 1170000, area: 37300 },
                    'Vladimir Oblast': { population: 1320000, area: 29000 },
                    'Volgograd Oblast': { population: 2460000, area: 113900 },
                    'Vologda Oblast': { population: 1080000, area: 145700 },
                    'Voronezh Oblast': { population: 2250000, area: 52200 },
                    'Yaroslavl Oblast': { population: 1200000, area: 36400 },
                    'ĞĞ¼ÑƒÑ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 780000, area: 363700 },
                    'ĞÑ€Ñ…Ğ°Ğ½Ğ³ĞµĞ»ÑŒÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1080000, area: 587400 },
                    'ĞÑÑ‚Ñ€Ğ°Ñ…Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 991000, area: 44100 },
                    'Ğ‘ĞµĞ»Ğ³Ğ¾Ñ€Ğ¾Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1550000, area: 27100 },
                    'Ğ‘Ñ€ÑĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1150000, area: 34900 },
                    'Ğ§ĞµĞ»ÑĞ±Ğ¸Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 3350000, area: 88500 },
                    'Ğ˜Ñ€ĞºÑƒÑ‚ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2310000, area: 767900 },
                    'Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 990000, area: 21400 },
                    'ĞšĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1030000, area: 15100 },
                    'ĞšĞ°Ğ»ÑƒĞ¶ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1010000, area: 29900 },
                    'ĞšĞµĞ¼ĞµÑ€Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2530000, area: 95700 },
                    'ĞšĞ¸Ñ€Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1200000, area: 120800 },
                    'ĞšĞ¾ÑÑ‚Ñ€Ğ¾Ğ¼ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 600000, area: 60200 },
                    'ĞšÑƒÑ€Ğ³Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 780000, area: 71000 },
                    'ĞšÑƒÑ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1060000, area: 29800 },
                    'Ğ›ĞµĞ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1940000, area: 83900 },
                    'Ğ›Ğ¸Ğ¿ĞµÑ†ĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1110000, area: 24000 },
                    'ĞœĞ°Ğ³Ğ°Ğ´Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 130000, area: 462500 },
                    'ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 8300000, area: 44300 },
                    'ĞœÑƒÑ€Ğ¼Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 730000, area: 144900 },
                    'ĞĞ¸Ğ¶ĞµĞ³Ğ¾Ñ€Ğ¾Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 3130000, area: 74800 },
                    'ĞĞ¾Ğ²Ğ¾ÑĞ¸Ğ±Ğ¸Ñ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2790000, area: 177800 },
                    'ĞĞ¼ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1870000, area: 139700 },
                    'ĞÑ€ĞµĞ½Ğ±ÑƒÑ€Ğ³ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1950000, area: 123700 },
                    'ĞÑ€Ğ»Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 700000, area: 24700 },
                    'ĞŸĞµĞ½Ğ·ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1220000, area: 43200 },
                    'ĞŸÑĞºĞ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 570000, area: 55400 },
                    'Ğ Ğ¾ÑÑ‚Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 4100000, area: 100800 },
                    'Ğ ÑĞ·Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1080000, area: 39600 },
                    'Ğ¡Ğ°Ğ¼Ğ°Ñ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 3150000, area: 53600 },
                    'Ğ¡Ğ°Ñ€Ğ°Ñ‚Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2340000, area: 101200 },
                    'Ğ¡Ğ°Ñ…Ğ°Ğ»Ğ¸Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 470000, area: 87100 },
                    'Ğ¡Ğ²ĞµÑ€Ğ´Ğ»Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 4230000, area: 194300 },
                    'Ğ¡Ğ¼Ğ¾Ğ»ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 900000, area: 49800 },
                    'Ğ¢Ğ°Ğ¼Ğ±Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 970000, area: 34500 },
                    'Ğ¢Ğ¾Ğ¼ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1050000, area: 314400 },
                    'Ğ¢ÑƒĞ»ÑŒÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1460000, area: 25700 },
                    'Ğ¢ÑĞ¼ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1700000, area: 160100 },
                    'Ğ£Ğ»ÑŒÑĞ½Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1170000, area: 37300 },
                    'Ğ’Ğ»Ğ°Ğ´Ğ¸Ğ¼Ğ¸Ñ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1320000, area: 29000 },
                    'Ğ’Ğ¾Ğ»Ğ³Ğ¾Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2460000, area: 113900 },
                    'Ğ’Ğ¾Ğ»Ğ¾Ğ³Ğ¾Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1080000, area: 145700 },
                    'Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞµĞ¶ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2250000, area: 52200 },
                    'Ğ¯Ñ€Ğ¾ÑĞ»Ğ°Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1200000, area: 36400 },
                    // ìì¹˜ì£¼ (1ê°œ)
                    'Jewish Autonomous Oblast': { population: 153000, area: 36266 },
                    'Ğ•Ğ²Ñ€ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ğ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 153000, area: 36266 },
                    // ìì¹˜êµ¬ (4ê°œ)
                    'Chukotka Autonomous Okrug': { population: 50000, area: 721500 },
                    'Khanty-Mansi Autonomous Okrug': { population: 1670000, area: 534800 },
                    'Nenets Autonomous Okrug': { population: 45000, area: 176800 },
                    'Yamalo-Nenets Autonomous Okrug': { population: 540000, area: 769300 },
                    'Ğ§ÑƒĞºĞ¾Ñ‚ÑĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 50000, area: 721500 },
                    'Ğ¥Ğ°Ğ½Ñ‚Ñ‹-ĞœĞ°Ğ½ÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 1670000, area: 534800 },
                    'ĞĞµĞ½ĞµÑ†ĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 45000, area: 176800 },
                    'Ğ¯Ğ¼Ğ°Ğ»Ğ¾-ĞĞµĞ½ĞµÑ†ĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 540000, area: 769300 }
                };

                // ì†ì„± ì •ê·œí™”
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const nameCandidates = [p.shapeName, p.name, p.NAME_1, p.NAME, p.region, p.admin, p.provname, `Region_${index}`];
                    const rawName = nameCandidates.find(Boolean);
                    const nameEn = p.NAME_1 || p.name || rawName;
                    
                    // ì§€ì—­ ë°ì´í„° ë§¤ì¹­ (ì—¬ëŸ¬ ì´ë¦„ íŒ¨í„´ ì‹œë„)
                    let regionData = null;
                    const searchKeys = [
                        rawName, // ì›ë³¸ ì´ë¦„
                        nameEn, // ì˜ì–´ ì´ë¦„
                        p.shapeName, // shapeName
                        p.NAME_1, // NAME_1
                        p.NAME // NAME
                    ];
                    
                    for (const key of searchKeys) {
                        if (key && russiaRegionData[key]) {
                            regionData = russiaRegionData[key];
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const population = regionData ? regionData.population : (p.population || Math.floor(Math.random() * 4000000) + 500000);
                    const area = regionData ? regionData.area : (p.area || Math.floor(Math.random() * 800000) + 20000);
                    
                    const baseIdSrc = p.shapeID || p.shapeISO || p.hasc || rawName || `RUS_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `rus_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName, // ì¶”í›„ í•œêµ­ì–´ ë§¤í•‘ ê°€ëŠ¥
                        name_en: nameEn,
                        country: 'Russia',
                        country_code: 'RU',
                        admin_level: 'Federal Subject',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 250000) + 120000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#7d5fff',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'], '#ff6b6b', '#7d5fff'
                        ],
                        'fill-opacity': 0.6
                    }
                });
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 }
                });
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: { 'fill-color': '#feca57', 'fill-opacity': 0 },
                    filter: ['==', 'id', '']
                });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì—°ë°©ì£¼ì²´');
            this.showNotification(`ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ëŸ¬ì‹œì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¸ë„ ë°ì´í„° ë¡œë“œ (ì£¼/ì—°ë°©ë ¹ ë‹¨ìœ„)
    async loadIndiaData() {
        try {
            // ì¸ë„ ì£¼/ì—°ë°©ë ¹ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
            const indiaRegionData = {
                // ì£¼ (28ê°œ)
                'Andhra Pradesh': { population: 52000000, area: 162970 },
                'Arunachal Pradesh': { population: 1700000, area: 83743 },
                'Assam': { population: 36100000, area: 78438 },
                'Bihar': { population: 128000000, area: 94163 },
                'Chhattisgarh': { population: 30000000, area: 135194 },
                'Goa': { population: 1600000, area: 3702 },
                'Gujarat': { population: 70600000, area: 196024 },
                'Haryana': { population: 29000000, area: 44212 },
                'Himachal Pradesh': { population: 7700000, area: 55673 },
                'Jharkhand': { population: 39500000, area: 79714 },
                'Karnataka': { population: 67600000, area: 191791 },
                'Kerala': { population: 35400000, area: 38852 },
                'Madhya Pradesh': { population: 85300000, area: 308252 },
                'Maharashtra': { population: 126700000, area: 307713 },
                'Manipur': { population: 3300000, area: 22327 },
                'Meghalaya': { population: 3600000, area: 22429 },
                'Mizoram': { population: 1300000, area: 21081 },
                'Nagaland': { population: 2200000, area: 16579 },
                'Odisha': { population: 47500000, area: 155707 },
                'Punjab': { population: 30300000, area: 50362 },
                'Rajasthan': { population: 81000000, area: 342239 },
                'Sikkim': { population: 700000, area: 7096 },
                'Tamil Nadu': { population: 78800000, area: 130058 },
                'Telangana': { population: 39100000, area: 112077 },
                'Tripura': { population: 4200000, area: 10486 },
                'Uttar Pradesh': { population: 240000000, area: 240928 },
                'Uttarakhand': { population: 11500000, area: 53483 },
                'West Bengal': { population: 100300000, area: 88752 },
                // ì—°ë°©ë ¹ (8ê°œ)
                'Andaman and Nicobar Islands': { population: 380000, area: 8249 },
                'Chandigarh': { population: 1200000, area: 114 },
                'Dadra and Nagar Haveli and Daman and Diu': { population: 970000, area: 603 },
                'Delhi': { population: 19600000, area: 1484 },
                'Delhi (National Capital Territory)': { population: 19600000, area: 1484 },
                'Jammu and Kashmir': { population: 13600000, area: 55538 },
                'Ladakh': { population: 320000, area: 59146 },
                'Lakshadweep': { population: 70000, area: 32 },
                'Puducherry': { population: 1700000, area: 490 },
                // íŒë””ì–´ ì´ë¦„ë„ ë§¤ì¹­ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€
                'à¤†à¤‚à¤§à¥à¤° à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 52000000, area: 162970 },
                'à¤…à¤°à¥à¤£à¤¾à¤šà¤² à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 1700000, area: 83743 },
                'à¤…à¤¸à¤®': { population: 36100000, area: 78438 },
                'à¤¬à¤¿à¤¹à¤¾à¤°': { population: 128000000, area: 94163 },
                'à¤›à¤¤à¥à¤¤à¥€à¤¸à¤—à¤¢à¤¼': { population: 30000000, area: 135194 },
                'à¤—à¥‹à¤µà¤¾': { population: 1600000, area: 3702 },
                'à¤—à¥à¤œà¤°à¤¾à¤¤': { population: 70600000, area: 196024 },
                'à¤¹à¤°à¤¿à¤¯à¤¾à¤£à¤¾': { population: 29000000, area: 44212 },
                'à¤¹à¤¿à¤®à¤¾à¤šà¤² à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 7700000, area: 55673 },
                'à¤à¤¾à¤°à¤–à¤‚à¤¡': { population: 39500000, area: 79714 },
                'à¤•à¤°à¥à¤¨à¤¾à¤Ÿà¤•': { population: 67600000, area: 191791 },
                'à¤•à¥‡à¤°à¤²': { population: 35400000, area: 38852 },
                'à¤®à¤§à¥à¤¯ à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 85300000, area: 308252 },
                'à¤®à¤¹à¤¾à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°': { population: 126700000, area: 307713 },
                'à¤®à¤£à¤¿à¤ªà¥à¤°': { population: 3300000, area: 22327 },
                'à¤®à¥‡à¤˜à¤¾à¤²à¤¯': { population: 3600000, area: 22429 },
                'à¤®à¤¿à¤œà¤¼à¥‹à¤°à¤®': { population: 1300000, area: 21081 },
                'à¤¨à¤¾à¤—à¤¾à¤²à¥ˆà¤‚à¤¡': { population: 2200000, area: 16579 },
                'à¤“à¤¡à¤¿à¤¶à¤¾': { population: 47500000, area: 155707 },
                'à¤ªà¤‚à¤œà¤¾à¤¬': { population: 30300000, area: 50362 },
                'à¤°à¤¾à¤œà¤¸à¥à¤¥à¤¾à¤¨': { population: 81000000, area: 342239 },
                'à¤¸à¤¿à¤•à¥à¤•à¤¿à¤®': { population: 700000, area: 7096 },
                'à¤¤à¤®à¤¿à¤²à¤¨à¤¾à¤¡à¥': { population: 78800000, area: 130058 },
                'à¤¤à¥‡à¤²à¤‚à¤—à¤¾à¤¨à¤¾': { population: 39100000, area: 112077 },
                'à¤¤à¥à¤°à¤¿à¤ªà¥à¤°à¤¾': { population: 4200000, area: 10486 },
                'à¤‰à¤¤à¥à¤¤à¤° à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 240000000, area: 240928 },
                'à¤‰à¤¤à¥à¤¤à¤°à¤¾à¤–à¤‚à¤¡': { population: 11500000, area: 53483 },
                'à¤ªà¤¶à¥à¤šà¤¿à¤® à¤¬à¤‚à¤—à¤¾à¤²': { population: 100300000, area: 88752 },
                'à¤…à¤‚à¤¡à¤®à¤¾à¤¨ à¤”à¤° à¤¨à¤¿à¤•à¥‹à¤¬à¤¾à¤° à¤¦à¥à¤µà¥€à¤ªà¤¸à¤®à¥‚à¤¹': { population: 380000, area: 8249 },
                'à¤šà¤‚à¤¡à¥€à¤—à¤¢à¤¼': { population: 1200000, area: 114 },
                'à¤¦à¤¾à¤¦à¤°à¤¾ à¤”à¤° à¤¨à¤—à¤° à¤¹à¤µà¥‡à¤²à¥€ à¤”à¤° à¤¦à¤®à¤¨ à¤”à¤° à¤¦à¥€à¤µ': { population: 970000, area: 603 },
                'à¤¦à¤¿à¤²à¥à¤²à¥€': { population: 19600000, area: 1484 },
                'à¤œà¤®à¥à¤®à¥‚ à¤”à¤° à¤•à¤¶à¥à¤®à¥€à¤°': { population: 13600000, area: 55538 },
                'à¤²à¤¦à¥à¤¦à¤¾à¤–à¤¼': { population: 320000, area: 59146 },
                'à¤²à¤•à¥à¤·à¤¦à¥à¤µà¥€à¤ª': { population: 70000, area: 32 },
                'à¤ªà¥à¤¦à¥à¤šà¥‡à¤°à¥€': { population: 1700000, area: 490 }
            };
            
            const geoJsonData = await this.loadGeoJsonWithCache('india', async () => {
                // indiaRegionDataëŠ” í•¨ìˆ˜ ìƒë‹¨ì— ì •ì˜ë˜ì–´ ìˆìŒ
                const data = await this.fetchGeoJsonWithFallback('india', {
                    urls: [
                        this.getAssetUrl('data/india-states.geojson'),
                        'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/IND/ADM1/geoBoundaries-IND-ADM1.geojson',
                        'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/india.geojson',
                        'https://raw.githubusercontent.com/datasets/geo-admin1-us/master/data/india_states.geojson'
                    ],
                    localPath: 'data/india-states.geojson',
                    minFeatures: 25
                });
                
                // ì†ì„± ì •ê·œí™”
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.st_nm || p.state || p.NAME_1 || p.name || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `IND_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `ind_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                    const searchKeys = [
                        rawName,
                        p.st_nm,
                        p.state,
                        p.NAME_1,
                        p.name,
                        p.name_en,
                        p.name_hi,
                        rawName.trim(),
                        rawName.replace(/\s+/g, ' '),
                        rawName.replace(/\(.*?\)/g, '').trim() // ê´„í˜¸ ë‚´ìš© ì œê±°
                    ].filter(key => key && typeof key === 'string');
                    
                    let regionData = null;
                    for (const key of searchKeys) {
                        if (indiaRegionData[key]) {
                            regionData = indiaRegionData[key];
                            break;
                        }
                    }
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const stateData = regionData || { 
                        population: Math.floor(Math.random() * 30000000) + 500000, 
                        area: Math.floor(Math.random() * 400000) + 10000 
                    };
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName, // ì¶”í›„ í•œêµ­ì–´ í‘œê¸° ë§¤í•‘ ê°€ëŠ¥
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'India',
                        country_code: 'IN',
                        admin_level: 'State/UT',
                        population: stateData.population,
                        area: stateData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ff9f43',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });
            
            // ìºì‹œì—ì„œ ë¡œë“œí•œ ê²½ìš°ì—ë„ ì¸êµ¬/ë©´ì  ì—…ë°ì´íŠ¸ (ë°ì´í„° ê°ì²´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            if (geoJsonData && geoJsonData.features) {
                geoJsonData.features.forEach((feature) => {
                    const p = feature.properties || {};
                    const rawName = p.st_nm || p.state || p.NAME_1 || p.name || p.name_en;
                    
                    if (rawName) {
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.st_nm,
                            p.state,
                            p.NAME_1,
                            p.name,
                            p.name_en,
                            p.name_hi,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' '),
                            rawName.replace(/\(.*?\)/g, '').trim() // ê´„í˜¸ ë‚´ìš© ì œê±°
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (indiaRegionData[key]) {
                                regionData = indiaRegionData[key];
                                break;
                            }
                        }
                        
                        if (regionData) {
                            feature.properties.population = regionData.population;
                            feature.properties.area = regionData.area;
                            // regionDataë„ ì—…ë°ì´íŠ¸
                            if (feature.properties.id) {
                                const regionInfo = this.regionData.get(feature.properties.id);
                                if (regionInfo) {
                                    regionInfo.population = regionData.population;
                                    regionInfo.area = regionData.area;
                                    this.regionData.set(feature.properties.id, regionInfo);
                                }
                            }
                        }
                    }
                });
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ff9f43'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì¸ë„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼/ì—°ë°©ë ¹');
            this.showNotification(`ì¸ë„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì¸ë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¸ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ (ì£¼/ì˜í†  ë‹¨ìœ„)
    async loadCanadaData() {
        try {
            // ìºë‚˜ë‹¤ ì£¼/ì˜í† ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
            const canadaRegionData = {
                // ì£¼ (10ê°œ)
                'Ontario': { population: 15996989, area: 1076395 },
                'Quebec': { population: 9030684, area: 1542056 },
                'British Columbia': { population: 5646467, area: 944735 },
                'Alberta': { population: 4849906, area: 661848 },
                'Manitoba': { population: 1484135, area: 647797 },
                'Saskatchewan': { population: 1231043, area: 591670 },
                'Nova Scotia': { population: 1072545, area: 55284 },
                'New Brunswick': { population: 850894, area: 71388 },
                'Newfoundland and Labrador': { population: 541391, area: 405212 },
                'Prince Edward Island': { population: 177081, area: 5660 },
                // ì˜í†  (3ê°œ)
                'Northwest Territories': { population: 46000, area: 1346106 },
                'Nunavut': { population: 40000, area: 2093190 },
                'Yukon': { population: 45000, area: 482443 }
            };
            
            const geoJsonData = await this.loadGeoJsonWithCache('canada', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries CAN ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/CAN/ADM1/geoBoundaries-CAN-ADM1.geojson',
                    // click_that_hood canada
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/canada.geojson',
                    // Natural Earth Canada provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ìºë‚˜ë‹¤ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'CAN' || admin === 'Canada' || iso2 === 'CA';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Canada] Filtered Natural Earth/global dataset to Canada only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 10) {
                            data = fetchedData;
                            console.log('[Canada] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 10) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Canada] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 10 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Canada] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Canada] Failed loading from', url, e);
                        }
                    }
                }
                // ë¡œì»¬ í´ë°±
                if (!data) {
                    try {
                        const localResp = await fetch('data/canada-provinces.geojson', { cache: 'no-store' });
                        if (!localResp.ok) throw new Error(`Local HTTP ${localResp.status}`);
                        const localData = await localResp.json();
                        data = localData.type ? localData : { type: 'FeatureCollection', features: localData.features };
                        console.log('[Canada] Loaded from local fallback data/canada-provinces.geojson');
                    } catch (e) {
                        console.warn('[Canada] Local fallback missing or invalid', e);
                    }
                }
                if (!data) throw lastError || new Error('No Canada dataset available');
                
                const idSet = new Set();
                if (data.features && Array.isArray(data.features)) {
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.province || p.shapeName || `Province_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || p.shapeISO || rawName || `CAN_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `can_province_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.name,
                            p.NAME_1,
                            p.province,
                            p.shapeName,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' ')
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (canadaRegionData[key]) {
                                regionData = canadaRegionData[key];
                                break;
                            }
                        }
                        
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                        const provinceData = regionData || { 
                            population: Math.floor(Math.random() * 5000000) + 50000, 
                            area: Math.floor(Math.random() * 1500000) + 50000 
                        };
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName, // ì¶”í›„ í•œêµ­ì–´ í‘œê¸° ë§¤í•‘ ê°€ëŠ¥
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'Canada',
                            country_code: 'CA',
                            admin_level: 'Province/Territory',
                            population: provinceData.population,
                            area: provinceData.area,
                            ad_status: 'available',
                            ad_price: 50000 + (index * 5000),
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#e74c3c',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                
                return data;
            });
            
            // ìºì‹œì—ì„œ ë¡œë“œí•œ ê²½ìš°ì—ë„ ì¸êµ¬/ë©´ì  ì—…ë°ì´íŠ¸ (ë°ì´í„° ê°ì²´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            if (geoJsonData && geoJsonData.features) {
                geoJsonData.features.forEach((feature) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || p.shapeName || p.name_en;
                    
                    if (rawName) {
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.name,
                            p.NAME_1,
                            p.province,
                            p.shapeName,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' ')
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (canadaRegionData[key]) {
                                regionData = canadaRegionData[key];
                                break;
                            }
                        }
                        
                        if (regionData) {
                            feature.properties.population = regionData.population;
                            feature.properties.area = regionData.area;
                            // regionDataë„ ì—…ë°ì´íŠ¸
                            if (feature.properties.id) {
                                const regionInfo = this.regionData.get(feature.properties.id);
                                if (regionInfo) {
                                    regionInfo.population = regionData.population;
                                    regionInfo.area = regionData.area;
                                    this.regionData.set(feature.properties.id, regionInfo);
                                }
                            }
                        }
                    }
                });
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#e74c3c'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼/ì˜í† ');
            this.showNotification(`ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìºë‚˜ë‹¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë…ì¼ ë°ì´í„° ë¡œë“œ (ì£¼/Bundesland ë‹¨ìœ„)
    async loadGermanyData() {
        try {
            // ë…ì¼ ì£¼ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
            const germanyRegionData = {
                'Baden-WÃ¼rttemberg': { population: 11350000, area: 35751 },
                'Bayern': { population: 13450000, area: 70550 },
                'Bavaria': { population: 13450000, area: 70550 },
                'Berlin': { population: 3850000, area: 891 },
                'Brandenburg': { population: 2610000, area: 29654 },
                'Bremen': { population: 680000, area: 419 },
                'Hamburg': { population: 1910000, area: 755 },
                'Hessen': { population: 6390000, area: 21115 },
                'Hesse': { population: 6390000, area: 21115 },
                'Mecklenburg-Vorpommern': { population: 1610000, area: 23295 },
                'Niedersachsen': { population: 8050000, area: 47614 },
                'Lower Saxony': { population: 8050000, area: 47614 },
                'Nordrhein-Westfalen': { population: 18220000, area: 34112 },
                'North Rhine-Westphalia': { population: 18220000, area: 34112 },
                'Rheinland-Pfalz': { population: 4180000, area: 19854 },
                'Rhineland-Palatinate': { population: 4180000, area: 19854 },
                'Saarland': { population: 970000, area: 2569 },
                'Sachsen': { population: 4080000, area: 18415 },
                'Saxony': { population: 4080000, area: 18415 },
                'Sachsen-Anhalt': { population: 2150000, area: 20451 },
                'Saxony-Anhalt': { population: 2150000, area: 20451 },
                'Schleswig-Holstein': { population: 2950000, area: 15802 },
                'ThÃ¼ringen': { population: 2070000, area: 16172 },
                'Thuringia': { population: 2070000, area: 16172 }
            };
            
            const geoJsonData = await this.loadGeoJsonWithCache('germany', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries DEU ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/DEU/ADM1/geoBoundaries-DEU-ADM1.geojson',
                    // click_that_hood germany
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/germany.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 10) {
                            data = fetchedData;
                            console.log('[Germany] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 10) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Germany] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 10 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Germany] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Germany] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Germany dataset available');
                
                // ë°ì´í„° ì²˜ë¦¬
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `DEU_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `deu_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                    const searchKeys = [
                        rawName,
                        p.name,
                        p.NAME_1,
                        p.state,
                        rawName.trim(),
                        rawName.replace(/\s+/g, ' ')
                    ].filter(key => key && typeof key === 'string');
                    
                    let regionData = null;
                    for (const key of searchKeys) {
                        if (germanyRegionData[key]) {
                            regionData = germanyRegionData[key];
                            break;
                        }
                    }
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const stateData = regionData || { 
                        population: Math.floor(Math.random() * 3000000) + 500000, 
                        area: Math.floor(Math.random() * 50000) + 2000 
                    };
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Germany',
                        country_code: 'DE',
                        admin_level: 'State',
                        population: stateData.population,
                        area: stateData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ffd93d',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });
            
            // ìºì‹œì—ì„œ ë¡œë“œí•œ ê²½ìš°ì—ë„ ì¸êµ¬/ë©´ì  ì—…ë°ì´íŠ¸ (ë°ì´í„° ê°ì²´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            if (geoJsonData && geoJsonData.features) {
                geoJsonData.features.forEach((feature) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || p.name_en;
                    
                    if (rawName) {
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.name,
                            p.NAME_1,
                            p.state,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' ')
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (germanyRegionData[key]) {
                                regionData = germanyRegionData[key];
                                break;
                            }
                        }
                        
                        if (regionData) {
                            feature.properties.population = regionData.population;
                            feature.properties.area = regionData.area;
                            // regionDataë„ ì—…ë°ì´íŠ¸
                            if (feature.properties.id) {
                                const regionInfo = this.regionData.get(feature.properties.id);
                                if (regionInfo) {
                                    regionInfo.population = regionData.population;
                                    regionInfo.area = regionData.area;
                                    this.regionData.set(feature.properties.id, regionInfo);
                                }
                            }
                        }
                    }
                });
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ffd93d'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë…ì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë…ì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë…ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë…ì¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì˜êµ­ ë°ì´í„° ë¡œë“œ (ì§€ì—­/ì¹´ìš´í‹° ë‹¨ìœ„)
    async loadUKData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('uk', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries GBR ADM1 (ìƒìœ„ ë ˆë²¨ í–‰ì •êµ¬ì—­)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/GBR/ADM1/geoBoundaries-GBR-ADM1.geojson',
                    // Natural Earth UK regions (í•„í„°ë§ í•„ìš”)
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // geoBoundaries ADM1 ë°ì´í„°ëŠ” ì´ë¯¸ í° ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ ìˆìŒ
                        if (url.includes('geoBoundaries') && fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 2 && fetchedData.features.length < 50) {
                            data = fetchedData;
                            console.log('[UK] Loaded from geoBoundaries ADM1:', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì˜êµ­ë§Œ í•„í„°ë§ (í° ë‹¨ìœ„ë¡œ ê·¸ë£¹í™” í•„ìš”)
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'GBR' || admin === 'United Kingdom' || iso2 === 'GB';
                            });
                            if (filtered.length > 0 && filtered.length < 50) {
                                // ì´ë¯¸ í° ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                                console.log(`[UK] Filtered Natural Earth/global dataset to UK only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            } else if (filtered.length > 50) {
                                // ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš”
                                console.log(`[UK] Filtered Natural Earth/global dataset to UK: ${filtered.length} features - will group`);
                                data = { type: 'FeatureCollection', features: filtered };
                                // ì•„ë˜ ê·¸ë£¹í™” ë¡œì§ìœ¼ë¡œ ì§„í–‰
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 2) {
                            data = fetchedData;
                            console.log('[UK] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 2) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[UK] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 2 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[UK] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[UK] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No UK dataset available');
                
                // 50ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš”
                const needsGrouping = data.features && data.features.length > 50;
                
                if (needsGrouping) {
                    // ì˜êµ­ ì§€ì—­ì„ ë” í° ë‹¨ìœ„ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    // ì‰ê¸€ëœë“œ ì§€ì—­ë“¤ì„ 9ê°œ ì§€ì—­ìœ¼ë¡œ, ìŠ¤ì½”í‹€ëœë“œ/ì›¨ì¼ìŠ¤/ë¶ì•„ì¼ëœë“œëŠ” ê°ê° í•˜ë‚˜ë¡œ í†µí•©
                    const ukRegionMapping = {
                    // England Regions (9ê°œ)
                    'North East': ['Northumberland', 'County Durham', 'Tyne and Wear', 'Tees Valley', 'North East England', 
                                   'North Tyneside', 'South Tyneside', 'Sunderland', 'Gateshead', 'Newcastle upon Tyne', 
                                   'Hartlepool', 'Redcar and Cleveland', 'Stockton-on-Tees', 'Darlington', 'Middlesbrough'],
                    'North West': ['Greater Manchester', 'Merseyside', 'Lancashire', 'Cumbria', 'Cheshire', 'North West England',
                                   'Liverpool', 'Manchester', 'Bolton', 'Bury', 'Oldham', 'Rochdale', 'Salford', 'Stockport', 
                                   'Tameside', 'Trafford', 'Wigan', 'Blackpool', 'Blackburn with Darwen', 'Burnley', 'Preston',
                                   'Halton', 'Warrington', 'Knowsley', 'Sefton', 'St Helens', 'Wirral'],
                    'Yorkshire and the Humber': ['West Yorkshire', 'South Yorkshire', 'East Riding of Yorkshire', 'North Yorkshire', 'Yorkshire and the Humber',
                                                  'Leeds', 'Sheffield', 'Bradford', 'Wakefield', 'Kirklees', 'Calderdale', 
                                                  'Barnsley', 'Doncaster', 'Rotherham', 'York', 'Hull', 'Kingston upon Hull'],
                    'East Midlands': ['Derbyshire', 'Nottinghamshire', 'Lincolnshire', 'Leicestershire', 'Rutland', 'Northamptonshire', 'East Midlands',
                                      'Nottingham', 'Derby', 'Leicester', 'Northampton', 'Mansfield', 'Chesterfield'],
                    'West Midlands': ['West Midlands', 'Warwickshire', 'Staffordshire', 'Shropshire', 'Herefordshire', 'Worcestershire',
                                      'Birmingham', 'Coventry', 'Wolverhampton', 'Dudley', 'Walsall', 'Sandwell', 'Solihull',
                                      'Stoke-on-Trent', 'Telford and Wrekin'],
                    'East of England': ['Norfolk', 'Suffolk', 'Cambridgeshire', 'Essex', 'Hertfordshire', 'Bedfordshire', 'East of England',
                                        'Norwich', 'Ipswich', 'Cambridge', 'Peterborough', 'Colchester', 'Luton', 'Southend-on-Sea',
                                        'Thurrock', 'Harlow', 'Chelmsford'],
                    'London': ['Greater London', 'London', 'Inner London', 'Outer London',
                               'Westminster', 'City', 'Camden', 'Islington', 'Hackney', 'Haringey', 'Enfield', 'Barnet',
                               'Harrow', 'Brent', 'Ealing', 'Hounslow', 'Richmond upon Thames', 'Kingston upon Thames',
                               'Merton', 'Wandsworth', 'Lambeth', 'Southwark', 'Lewisham', 'Greenwich', 'Bexley',
                               'Bromley', 'Croydon', 'Sutton', 'Waltham Forest', 'Redbridge', 'Havering', 'Barking and Dagenham',
                               'Newham', 'Tower Hamlets', 'Hammersmith and Fulham', 'Kensington and Chelsea'],
                    'South East': ['Kent', 'Surrey', 'East Sussex', 'West Sussex', 'Hampshire', 'Isle of Wight', 'Berkshire', 'Oxfordshire', 'Buckinghamshire', 'South East England',
                                   'Brighton and Hove', 'Portsmouth', 'Southampton', 'Reading', 'Slough', 'Wokingham', 'Bracknell Forest',
                                   'Royal Borough of Windsor and Maidenhead', 'Medway', 'Milton Keynes', 'Canterbury', 'Maidstone'],
                    'South West': ['Gloucestershire', 'Wiltshire', 'Somerset', 'Dorset', 'Devon', 'Cornwall', 'South West England',
                                   'Bristol', 'Bournemouth', 'Poole', 'Plymouth', 'Swindon', 'Exeter', 'Bath', 'Torbay'],
                    // Scotland
                    'Scotland': ['Scotland', 'Highland', 'Aberdeenshire', 'Perth and Kinross', 'Argyll and Bute', 'Scottish Borders', 'Dumfries and Galloway', 'Fife', 'Edinburgh', 'Glasgow',
                                 'Perthshire and Kinross', 'Angus', 'Dundee', 'Aberdeen', 'Stirling', 'Falkirk', 'West Lothian',
                                 'Midlothian', 'East Lothian', 'Clackmannanshire', 'South Ayrshire', 'North Ayshire', 'East Ayrshire',
                                 'Inverclyde', 'Renfrewshire', 'West Dunbartonshire', 'East Dunbartonshire', 'East Renfrewshire',
                                 'North Lanarkshire', 'South Lanarkshire', 'Moray', 'Orkney', 'Shetland Islands', 'Eilean Siar'],
                    // Wales
                    'Wales': ['Wales', 'Gwynedd', 'Conwy', 'Denbighshire', 'Flintshire', 'Wrexham', 'Powys', 'Ceredigion', 'Pembrokeshire', 'Carmarthenshire', 'Swansea', 'Cardiff',
                              'Newport', 'Bridgend', 'Vale of Glamorgan', 'Neath Port Talbot', 'Caerphilly', 'Rhondda, Cynon, Taff',
                              'Blaenau Gwent', 'Torfaen', 'Merthyr Tydfil', 'Monmouthshire', 'Anglesey'],
                    // Northern Ireland
                    'Northern Ireland': ['Northern Ireland', 'Antrim', 'Armagh', 'Down', 'Fermanagh', 'Londonderry', 'Tyrone', 'Belfast',
                                         'Strabane', 'Dungannon', 'Newry and Mourne', 'Limavady', 'Coleraine', 'Moyle', 'Larne',
                                         'Carrickfergus', 'Newtownabbey', 'Ards', 'Craigavon', 'Banbridge', 'Lisburn', 'Magherafelt',
                                         'Omagh', 'Mid Ulster', 'Ballymoney', 'Ballymena', 'Castlereagh']
                };
                
                // ì—­ë§¤í•‘ ìƒì„± (ì†Œì§€ì—­ -> ëŒ€ì§€ì—­)
                const reverseMapping = {};
                Object.keys(ukRegionMapping).forEach(region => {
                    ukRegionMapping[region].forEach(subRegion => {
                        reverseMapping[subRegion.toLowerCase()] = region;
                        // ì—¬ëŸ¬ ë³€í˜•ë„ ì¶”ê°€
                        reverseMapping[subRegion.toLowerCase().replace(/\s+/g, ' ')] = region;
                        reverseMapping[subRegion.toLowerCase().replace(/[^\w\s]/g, '')] = region;
                    });
                });
                
                // ì§€ì—­ ê·¸ë£¹í™”
                const groupedFeatures = new Map();
                const idSet = new Set();
                
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.country || `Region_${index}`;
                    const nameLower = rawName.toLowerCase().trim();
                    
                    // ê·¸ë£¹ ì°¾ê¸°
                    let groupName = null;
                    for (const [key, value] of Object.entries(reverseMapping)) {
                        if (nameLower.includes(key) || key.includes(nameLower)) {
                            groupName = value;
                            break;
                        }
                    }
                    
                    // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                    if (!groupName) {
                        if (nameLower.includes('england') || nameLower.includes('london') || 
                            nameLower.includes('yorkshire') || nameLower.includes('midlands') ||
                            nameLower.includes('south') || nameLower.includes('north') ||
                            nameLower.includes('east') || nameLower.includes('west')) {
                            // ì‰ê¸€ëœë“œ ì§€ì—­ ë§¤ì¹­ ì‹œë„
                            for (const [region, subRegions] of Object.entries(ukRegionMapping)) {
                                if (region !== 'Scotland' && region !== 'Wales' && region !== 'Northern Ireland') {
                                    if (subRegions.some(sub => nameLower.includes(sub.toLowerCase()))) {
                                        groupName = region;
                                        break;
                                    }
                                }
                            }
                            if (!groupName) {
                                // ì‰ê¸€ëœë“œ ì§€ì—­ëª… ì§ì ‘ ë§¤ì¹­
                                if (nameLower.includes('london')) groupName = 'London';
                                else if (nameLower.includes('north east')) groupName = 'North East';
                                else if (nameLower.includes('north west')) groupName = 'North West';
                                else if (nameLower.includes('yorkshire')) groupName = 'Yorkshire and the Humber';
                                else if (nameLower.includes('east midlands')) groupName = 'East Midlands';
                                else if (nameLower.includes('west midlands')) groupName = 'West Midlands';
                                else if (nameLower.includes('east of england')) groupName = 'East of England';
                                else if (nameLower.includes('south east')) groupName = 'South East';
                                else if (nameLower.includes('south west')) groupName = 'South West';
                            }
                        } else if (nameLower.includes('scotland') || nameLower.includes('scottish') || nameLower.includes('edinburgh') || nameLower.includes('glasgow')) {
                            groupName = 'Scotland';
                        } else if (nameLower.includes('wales') || nameLower.includes('welsh') || nameLower.includes('cardiff')) {
                            groupName = 'Wales';
                        } else if (nameLower.includes('northern ireland') || nameLower.includes('belfast')) {
                            groupName = 'Northern Ireland';
                        }
                    }
                    
                    // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°
                    if (!groupName) {
                        // ì§€ì—­ëª…ì„ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ ë§¤í•‘ ì¶”ê°€ í•„ìš” ì—¬ë¶€ í™•ì¸
                        console.warn(`[UK] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­: "${rawName}"`);
                        // ì¼ë‹¨ Englandë¡œ ë¶„ë¥˜í•˜ë˜, ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ë§¤í•‘ ê°€ëŠ¥í•˜ë„ë¡
                        groupName = 'Unmatched';
                    }
                    
                    if (!groupedFeatures.has(groupName)) {
                        groupedFeatures.set(groupName, {
                            features: [],
                            totalPopulation: 0,
                            totalArea: 0
                        });
                    }
                    
                    const group = groupedFeatures.get(groupName);
                    group.features.push(feature);
                    group.totalPopulation += (p.population || 0);
                    group.totalArea += (p.area || 0);
                });
                
                // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                const mergedFeatures = [];
                const unmatchedGroups = [];
                
                groupedFeatures.forEach((group, groupName) => {
                    if (group.features.length === 0) return;
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê·¸ë£¹ì€ ê±´ë„ˆë›°ê¸°
                    if (groupName === 'Unmatched') {
                        unmatchedGroups.push(group);
                        return;
                    }
                    
                    // Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                    const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                    
                    if (geometries.length === 0) {
                        console.warn(`[UK] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    let mergedGeometry;
                    if (geometries.length === 1) {
                        mergedGeometry = geometries[0];
                    } else {
                        const allCoordinates = [];
                        geometries.forEach(g => {
                            if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                allCoordinates.push(g.coordinates);
                            } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                allCoordinates.push(...g.coordinates);
                            }
                        });
                        if (allCoordinates.length === 1) {
                            mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                        } else if (allCoordinates.length > 1) {
                            mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                        } else {
                            // geometryê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ featureì˜ geometry ì‚¬ìš©
                            mergedGeometry = geometries[0];
                        }
                    }
                    
                    // Geometry ê²€ì¦
                    if (!mergedGeometry || !mergedGeometry.coordinates || 
                        (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                        (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                        console.warn(`[UK] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                        return;
                    }
                    
                    const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                    let finalId = baseId;
                    let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    mergedFeatures.push({
                        type: 'Feature',
                        geometry: mergedGeometry,
                        properties: {
                        id: finalId,
                            name: groupName,
                            name_ko: groupName,
                            name_en: groupName,
                        country: 'United Kingdom',
                        country_code: 'GB',
                        admin_level: 'Region/Country',
                            population: Math.max(group.totalPopulation, Math.floor(Math.random() * 10000000) + 1000000),
                            area: Math.max(group.totalArea, Math.floor(Math.random() * 200000) + 10000),
                        ad_status: 'available',
                            ad_price: 50000 + (mergedFeatures.length * 10000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#6c5ce7',
                        border_color: '#ffffff',
                            border_width: 1,
                            original_count: group.features.length // ì›ë³¸ ì§€ì—­ ê°œìˆ˜
                        }
                    });
                    
                    this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                });
                
                // ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­ë“¤ ì²˜ë¦¬
                if (unmatchedGroups.length > 0) {
                    console.warn(`[UK] ${unmatchedGroups.reduce((sum, g) => sum + g.features.length, 0)}ê°œ ì§€ì—­ì´ ë§¤ì¹­ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                    unmatchedGroups.forEach(group => {
                        group.features.forEach(feature => {
                            const p = feature.properties || {};
                            console.warn(`  - "${p.name || p.NAME_1 || 'Unknown'}"`);
                        });
                    });
                }
                
                console.log(`[UK] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${data.features.length}ê°œ)`);
                
                data = {
                    type: 'FeatureCollection',
                    features: mergedFeatures
                };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    const idSet = new Set();
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.country || `Region_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `GBR_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `gbr_region_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'United Kingdom',
                            country_code: 'GB',
                            admin_level: 'Region/Country',
                            population: p.population || Math.floor(Math.random() * 10000000) + 1000000,
                            area: p.area || Math.floor(Math.random() * 200000) + 10000,
                            ad_status: 'available',
                            ad_price: 50000 + (index * 10000),
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#6c5ce7',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#6c5ce7'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì˜êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
            console.log('ì˜êµ­ ë°ì´í„° ìƒ˜í”Œ:', geoJsonData.features.slice(0, 3).map(f => ({
                name: f.properties.name,
                hasGeometry: !!f.geometry,
                geometryType: f.geometry?.type,
                coordinatesLength: f.geometry?.coordinates?.length
            })));
            
            // Geometry ê²€ì¦
            const invalidFeatures = geoJsonData.features.filter(f => !f.geometry || !f.geometry.coordinates || f.geometry.coordinates.length === 0);
            if (invalidFeatures.length > 0) {
                console.warn(`[UK] ${invalidFeatures.length}ê°œ featureì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤:`, invalidFeatures.map(f => f.properties.name));
            }
            
            if (geoJsonData.features.length === 0) {
                throw new Error('ì˜êµ­ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            }
            
            this.showNotification(`ì˜êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì˜êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('ì˜êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', error.stack || error.message);
            this.showNotification(`ì˜êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    // í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ (ë ˆì§€ì˜¹ ë‹¨ìœ„)
    async loadFranceData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('france', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries FRA ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/FRA/ADM1/geoBoundaries-FRA-ADM1.geojson',
                    // Natural Earth France regions
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í”„ë‘ìŠ¤ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'FRA' || admin === 'France' || iso2 === 'FR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[France] Filtered Natural Earth/global dataset to France only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = fetchedData;
                            console.log('[France] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[France] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 5 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[France] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[France] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No France dataset available');
                
                // 50ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš” (ë°íŒŒë¥´íŠ¸ë§ -> ë ˆì§€ì˜¹)
                const needsGrouping = data.features && data.features.length > 50;
                
                if (needsGrouping) {
                    // í”„ë‘ìŠ¤ ë ˆì§€ì˜¹ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                    const franceRegionData = {
                        'Auvergne-RhÃ´ne-Alpes': { population: 8200000, area: 69711, name_ko: 'ì˜¤ë² ë¥´ë‰´-ë¡ -ì•Œí”„ìŠ¤' },
                        'Bourgogne-Franche-ComtÃ©': { population: 2790000, area: 47784, name_ko: 'ë¶€ë¥´ê³ ë‰´-í”„ë‘ìŠˆ-ì½©í…Œ' },
                        'Bretagne': { population: 3460000, area: 27208, name_ko: 'ë¸Œë¥´íƒ€ë‰´' },
                        'Centre-Val de Loire': { population: 2550000, area: 39151, name_ko: 'ìƒíŠ¸ë¥´-ë°œ ë“œ ë£¨ì•„ë¥´' },
                        'Corse': { population: 350000, area: 8680, name_ko: 'ì½”ë¥´ì‹œì¹´' },
                        'Grand Est': { population: 5540000, area: 57441, name_ko: 'ê·¸ë‘í…ŒìŠ¤íŠ¸' },
                        'Hauts-de-France': { population: 5960000, area: 31813, name_ko: 'ì˜¤ë“œí”„ë‘ìŠ¤' },
                        'Ãle-de-France': { population: 12320000, area: 12012, name_ko: 'ì¼ë“œí”„ë‘ìŠ¤' },
                        'Normandie': { population: 3350000, area: 29906, name_ko: 'ë…¸ë¥´ë§ë””' },
                        'Nouvelle-Aquitaine': { population: 6080000, area: 84036, name_ko: 'ëˆ„ë²¨ì•„í‚¤í…' },
                        'Occitanie': { population: 6080000, area: 72724, name_ko: 'ì˜¥ì‹œíƒ€ë‹ˆ' },
                        'Pays de la Loire': { population: 3900000, area: 32082, name_ko: 'í˜ì´ë“œë¼ë£¨ì•„ë¥´' },
                        'Provence-Alpes-CÃ´te d\'Azur': { population: 5100000, area: 31400, name_ko: 'í”„ë¡œë°©ìŠ¤-ì•Œí”„-ì½”íŠ¸ë‹¤ì¥ë¥´' }
                    };
                    
                    // í”„ë‘ìŠ¤ ë°íŒŒë¥´íŠ¸ë§ì„ 13ê°œ ë ˆì§€ì˜¹ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    const franceRegionMapping = {
                        'Auvergne-RhÃ´ne-Alpes': ['Ain', 'Allier', 'ArdÃ¨che', 'Cantal', 'DrÃ´me', 'IsÃ¨re', 'Loire', 'Haute-Loire', 'Puy-de-DÃ´me', 'RhÃ´ne', 'Savoie', 'Haute-Savoie'],
                        'Bourgogne-Franche-ComtÃ©': ['CÃ´te-d\'Or', 'Doubs', 'Jura', 'NiÃ¨vre', 'Haute-SaÃ´ne', 'SaÃ´ne-et-Loire', 'Yonne', 'Territoire de Belfort'],
                        'Bretagne': ['CÃ´tes-d\'Armor', 'FinistÃ¨re', 'Ille-et-Vilaine', 'Morbihan'],
                        'Centre-Val de Loire': ['Cher', 'Eure-et-Loir', 'Indre', 'Indre-et-Loire', 'Loir-et-Cher', 'Loiret'],
                        'Corse': ['Corse-du-Sud', 'Haute-Corse'],
                        'Grand Est': ['Ardennes', 'Aube', 'Marne', 'Haute-Marne', 'Meurthe-et-Moselle', 'Meuse', 'Moselle', 'Bas-Rhin', 'Haut-Rhin', 'Vosges'],
                        'Hauts-de-France': ['Aisne', 'Nord', 'Oise', 'Pas-de-Calais', 'Somme'],
                        'Ãle-de-France': ['Paris', 'Seine-et-Marne', 'Yvelines', 'Essonne', 'Hauts-de-Seine', 'Seine-Saint-Denis', 'Val-de-Marne', 'Val-d\'Oise'],
                        'Normandie': ['Calvados', 'Eure', 'Manche', 'Orne', 'Seine-Maritime'],
                        'Nouvelle-Aquitaine': ['Charente', 'Charente-Maritime', 'CorrÃ¨ze', 'Creuse', 'Dordogne', 'Gironde', 'Landes', 'Lot-et-Garonne', 'PyrÃ©nÃ©es-Atlantiques', 'Deux-SÃ¨vres', 'Vienne', 'Haute-Vienne'],
                        'Occitanie': ['AriÃ¨ge', 'Aude', 'Aveyron', 'Gard', 'Haute-Garonne', 'Gers', 'HÃ©rault', 'Lot', 'LozÃ¨re', 'Hautes-PyrÃ©nÃ©es', 'PyrÃ©nÃ©es-Orientales', 'Tarn', 'Tarn-et-Garonne'],
                        'Pays de la Loire': ['Loire-Atlantique', 'Maine-et-Loire', 'Mayenne', 'Sarthe', 'VendÃ©e'],
                        'Provence-Alpes-CÃ´te d\'Azur': ['Alpes-de-Haute-Provence', 'Hautes-Alpes', 'Alpes-Maritimes', 'Bouches-du-RhÃ´ne', 'Var', 'Vaucluse']
                    };
                    
                    // ì—­ë§¤í•‘ ìƒì„± (ë°íŒŒë¥´íŠ¸ë§ -> ë ˆì§€ì˜¹)
                    const reverseMapping = {};
                    Object.keys(franceRegionMapping).forEach(region => {
                        franceRegionMapping[region].forEach(departement => {
                            const depLower = departement.toLowerCase();
                            reverseMapping[depLower] = region;
                            // í•˜ì´í”ˆ/ê³µë°± ì œê±° ë³€í˜•
                            reverseMapping[depLower.replace(/[-\s]+/g, ' ').trim()] = region;
                            reverseMapping[depLower.replace(/[^\w\s]/g, '').trim()] = region;
                        });
                    });
                    
                    // ì§€ì—­ ê·¸ë£¹í™”
                    const groupedFeatures = new Map();
                    const idSet = new Set();
                    
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const nameLower = rawName.toLowerCase().trim();
                        
                        // ì •í™•í•œ ë§¤ì¹­ ë¨¼ì € ì‹œë„
                        let groupName = reverseMapping[nameLower] || null;
                        
                        // ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [key, value] of Object.entries(reverseMapping)) {
                                if (key.length > 3 && (nameLower.includes(key) || key.includes(nameLower))) {
                                    groupName = value;
                                    break;
                                }
                            }
                        }
                        
                        // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [region, departements] of Object.entries(franceRegionMapping)) {
                                for (const dep of departements) {
                                    const depLower = dep.toLowerCase();
                                    if (nameLower === depLower || nameLower.includes(depLower) || depLower.includes(nameLower)) {
                                        groupName = region;
                                        break;
                                    }
                                }
                                if (groupName) break;
                            }
                        }
                        
                        // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬
                        if (!groupName) {
                            console.warn(`[France] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­: "${rawName}" - ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬`);
                            groupName = rawName;
                        }
                        
                        if (!groupedFeatures.has(groupName)) {
                            groupedFeatures.set(groupName, {
                                features: [],
                                totalPopulation: 0,
                                totalArea: 0
                            });
                        }
                        
                        const group = groupedFeatures.get(groupName);
                        group.features.push(feature);
                        group.totalPopulation += (p.population || 0);
                        group.totalArea += (p.area || 0);
                    });
                    
                    // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                    const mergedFeatures = [];
                    
                    groupedFeatures.forEach((group, groupName) => {
                        if (group.features.length === 0) return;
                        
                        // ê°œë³„ ì§€ì—­ì¸ ê²½ìš° (ê·¸ë£¹ëª…ì´ ì›ë³¸ ì§€ì—­ëª…ê³¼ ê°™ì€ ê²½ìš°) - ê·¸ë£¹í™”í•˜ì§€ ì•Šê³  ê°œë³„ë¡œ ì²˜ë¦¬
                        const isIndividualRegion = group.features.length === 1 || 
                                                   !Object.keys(franceRegionMapping).includes(groupName);
                        
                        if (isIndividualRegion) {
                            // ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                            group.features.forEach((feature, idx) => {
                                const p = feature.properties || {};
                                const rawName = p.name || p.NAME_1 || p.region || groupName || `Region_${idx}`;
                                
                                if (!feature.geometry || !feature.geometry.coordinates) {
                                    console.warn(`[France] "${rawName}" ì§€ì—­ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                    return;
                                }
                                
                                const baseIdSrc = p.hasc || p.shapeID || rawName || `fra_${idx}`;
                                let baseId = baseIdSrc.toString().toLowerCase()
                                    .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                                    .replace(/__+/g, '_')
                                    .replace(/^_|_$/g, '');
                                if (!baseId) baseId = `fra_region_${mergedFeatures.length}`;
                                let finalId = baseId;
                                let c = 1;
                                while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                                idSet.add(finalId);
                                
                                mergedFeatures.push({
                                    type: 'Feature',
                                    geometry: feature.geometry,
                                    properties: {
                                        ...p,
                                        id: finalId,
                                        name: rawName,
                                        name_ko: rawName,
                                        name_en: rawName,
                                        country: 'France',
                                        country_code: 'FR',
                                        admin_level: 'DÃ©partement',
                                        population: p.population || Math.floor(Math.random() * 500000) + 50000,
                                        area: p.area || Math.floor(Math.random() * 5000) + 1000,
                                        ad_status: 'available',
                                        ad_price: 50000 + (mergedFeatures.length * 5000),
                                        revenue: 0,
                                        company: null,
                                        logo: null,
                                        color: '#5dade2',
                                        border_color: '#ffffff',
                                        border_width: 1
                                    }
                                });
                                
                                this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                            });
                            return;
                        }
                        
                        // ê·¸ë£¹í™”ëœ ì§€ì—­ì¸ ê²½ìš° - Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                        const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                        
                        if (geometries.length === 0) {
                            console.warn(`[France] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        let mergedGeometry;
                        if (geometries.length === 1) {
                            mergedGeometry = geometries[0];
                        } else {
                            const allCoordinates = [];
                            geometries.forEach(g => {
                                if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(g.coordinates);
                                } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(...g.coordinates);
                                }
                            });
                            if (allCoordinates.length === 1) {
                                mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                            } else if (allCoordinates.length > 1) {
                                mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                            } else {
                                mergedGeometry = geometries[0];
                            }
                        }
                        
                        // Geometry ê²€ì¦
                        if (!mergedGeometry || !mergedGeometry.coordinates || 
                            (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                            (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                            console.warn(`[France] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                            return;
                        }
                        
                        const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê³„ì‚°ëœ ê°’ ì‚¬ìš©)
                        const regionInfo = franceRegionData[groupName] || {};
                        const population = regionInfo.population || Math.max(group.totalPopulation, 1000000);
                        const area = regionInfo.area || Math.max(group.totalArea, 10000);
                        const name_ko = regionInfo.name_ko || groupName;
                        
                        mergedFeatures.push({
                            type: 'Feature',
                            geometry: mergedGeometry,
                            properties: {
                                id: finalId,
                                name: groupName,
                                name_ko: name_ko,
                                name_en: groupName,
                                country: 'France',
                                country_code: 'FR',
                                admin_level: 'Region',
                                population: population,
                                area: area,
                                ad_status: 'available',
                                ad_price: 50000 + (mergedFeatures.length * 10000),
                                revenue: 0,
                                company: null,
                                logo: null,
                                color: '#5dade2',
                                border_color: '#ffffff',
                                border_width: 1,
                                original_count: group.features.length
                            }
                        });
                        
                        this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                    });
                    
                    console.log(`[France] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${data.features.length}ê°œ)`);
                    
                    data = {
                        type: 'FeatureCollection',
                        features: mergedFeatures
                    };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    const idSet = new Set();
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `FRA_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `fra_region_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'France',
                            country_code: 'FR',
                            admin_level: 'Region',
                            population: p.population || Math.floor(Math.random() * 5000000) + 500000,
                            area: p.area || Math.floor(Math.random() * 50000) + 5000,
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 250000) + 180000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#5dade2',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#5dade2'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ë ˆì§€ì˜¹');
            console.log('í”„ë‘ìŠ¤ ë°ì´í„° ìƒ˜í”Œ:', geoJsonData.features.slice(0, 3).map(f => f.properties));
            
            // ëª¨ë“  í”„ë‘ìŠ¤ ì§€ì—­ëª… ë¦¬ìŠ¤íŠ¸ì—…
            const franceRegions = geoJsonData.features.map((f, idx) => {
                const p = f.properties;
                return `${idx + 1}. ${p.name || p.NAME_1 || p.region || `Region_${idx}`}`;
            });
            console.log('[France] ëª¨ë“  ì§€ì—­ëª… ë¦¬ìŠ¤íŠ¸:');
            console.log(franceRegions.join('\n'));
            
            if (geoJsonData.features.length === 0) {
                throw new Error('í”„ë‘ìŠ¤ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            }
            
            this.showNotification(`í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', error.stack || error.message);
            this.showNotification(`í”„ë‘ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    // ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ (ë ˆì§€ì˜¤ë„¤ ë‹¨ìœ„)
    async loadItalyData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('italy', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries ITA ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ITA/ADM1/geoBoundaries-ITA-ADM1.geojson',
                    // Natural Earth Italy regions
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì´íƒˆë¦¬ì•„ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ITA' || admin === 'Italy' || iso2 === 'IT';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Italy] Filtered Natural Earth/global dataset to Italy only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = fetchedData;
                            console.log('[Italy] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Italy] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 5 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Italy] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Italy] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Italy dataset available');
                
                let processedData = data;
                const originalFeatureCount = Array.isArray(data.features) ? data.features.length : 0;
                
                // 50ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš” (í”„ë¡œë¹ˆì¹˜ì•„ -> ë ˆì§€ì˜¤ë„¤)
                const needsGrouping = originalFeatureCount > 50;
                
                if (needsGrouping && Array.isArray(data.features)) {
                    // ì´íƒˆë¦¬ì•„ í”„ë¡œë¹ˆì¹˜ì•„ë¥¼ 20ê°œ ë ˆì§€ì˜¤ë„¤ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    const italyRegionMapping = {
                        'Abruzzo': ['Chieti', 'L\'Aquila', 'Pescara', 'Teramo'],
                        'Basilicata': ['Matera', 'Potenza'],
                        'Calabria': ['Catanzaro', 'Cosenza', 'Crotone', 'Reggio Calabria', 'Vibo Valentia'],
                        'Campania': ['Avellino', 'Benevento', 'Caserta', 'Naples', 'Salerno'],
                        'Emilia-Romagna': ['Bologna', 'Ferrara', 'ForlÃ¬-Cesena', 'Modena', 'Parma', 'Piacenza', 'Ravenna', 'Reggio Emilia', 'Rimini'],
                        'Friuli-Venezia Giulia': ['Gorizia', 'Pordenone', 'Trieste', 'Udine'],
                        'Lazio': ['Frosinone', 'Latina', 'Rieti', 'Rome', 'Viterbo'],
                        'Liguria': ['Genoa', 'Imperia', 'La Spezia', 'Savona'],
                        'Lombardy': ['Bergamo', 'Brescia', 'Como', 'Cremona', 'Mantua', 'Milan', 'Pavia', 'Sondrio', 'Varese'],
                        'Marche': ['Ancona', 'Ascoli Piceno', 'Fermo', 'Macerata', 'Pesaro and Urbino'],
                        'Molise': ['Campobasso', 'Isernia'],
                        'Piedmont': ['Alessandria', 'Asti', 'Biella', 'Cuneo', 'Novara', 'Turin', 'Verbano-Cusio-Ossola', 'Vercelli'],
                        'Puglia': ['Bari', 'Barletta-Andria-Trani', 'Brindisi', 'Foggia', 'Lecce', 'Taranto'],
                        'Sardinia': ['Cagliari', 'Carbonia-Iglesias', 'Medio Campidano', 'Nuoro', 'Ogliastra', 'Olbia-Tempio', 'Oristano', 'Sassari'],
                        'Sicily': ['Agrigento', 'Caltanissetta', 'Catania', 'Enna', 'Messina', 'Palermo', 'Ragusa', 'Syracuse', 'Trapani'],
                        'Trentino-Alto Adige': ['Bolzano', 'Trento'],
                        'Tuscany': ['Arezzo', 'Florence', 'Grosseto', 'Livorno', 'Lucca', 'Massa-Carrara', 'Pisa', 'Pistoia', 'Prato', 'Siena'],
                        'Umbria': ['Perugia', 'Terni'],
                        'Valle d\'Aosta': ['Aosta'],
                        'Veneto': ['Belluno', 'Padua', 'Rovigo', 'Treviso', 'Venice', 'Verona', 'Vicenza']
                    };
                    
                    // ì´íƒˆë¦¬ì•„ ë ˆì§€ì˜¤ë„¤ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                    const italyRegionData = {
                        'Abruzzo': { name_ko: 'ì•„ë¸Œë£¨ì´ˆ', population: 1290000, area: 10832 },
                        'Basilicata': { name_ko: 'ë°”ì‹¤ë¦¬ì¹´íƒ€', population: 530000, area: 9995 },
                        'Calabria': { name_ko: 'ì¹¼ë¼ë¸Œë¦¬ì•„', population: 1870000, area: 15222 },
                        'Campania': { name_ko: 'ìº„íŒŒë‹ˆì•„', population: 5640000, area: 13671 },
                        'Emilia-Romagna': { name_ko: 'ì—ë°€ë¦¬ì•„-ë¡œë§ˆëƒ', population: 4470000, area: 22453 },
                        'Friuli-Venezia Giulia': { name_ko: 'í”„ë¦¬ìš¸ë¦¬-ë² ë„¤ì¹˜ì•„ ì¤„ë¦¬ì•„', population: 1190000, area: 7858 },
                        'Lazio': { name_ko: 'ë¼ì¹˜ì˜¤', population: 5720000, area: 17203 },
                        'Liguria': { name_ko: 'ë¦¬êµ¬ë¦¬ì•„', population: 1520000, area: 5416 },
                        'Lombardy': { name_ko: 'ë¡¬ë°”ë¥´ë””ì•„', population: 10140000, area: 23864 },
                        'Marche': { name_ko: 'ë§ˆë¥´ì¼€', population: 1470000, area: 9366 },
                        'Molise': { name_ko: 'ëª°ë¦¬ì œ', population: 290000, area: 4438 },
                        'Piedmont': { name_ko: 'í”¼ì—ëª¬í…Œ', population: 4280000, area: 25402 },
                        'Puglia': { name_ko: 'í’€ë¦¬ì•„', population: 3940000, area: 19358 },
                        'Sardinia': { name_ko: 'ì‚¬ë¥´ë°ëƒ', population: 1580000, area: 24090 },
                        'Sicily': { name_ko: 'ì‹œì¹ ë¦¬ì•„', population: 4780000, area: 25711 },
                        'Trentino-Alto Adige': { name_ko: 'íŠ¸ë Œí‹°ë…¸-ì•Œí†  ì•„ë””ì œ', population: 1090000, area: 13606 },
                        'Tuscany': { name_ko: 'í† ìŠ¤ì¹´ë‚˜', population: 3660000, area: 22987 },
                        'Umbria': { name_ko: 'ì›€ë¸Œë¦¬ì•„', population: 850000, area: 8456 },
                        'Valle d\'Aosta': { name_ko: 'ë°œë ˆë‹¤ì˜¤ìŠ¤íƒ€', population: 123000, area: 3263 },
                        'Veneto': { name_ko: 'ë² ë„¤í† ', population: 4880000, area: 18345 }
                    };
                    
                    // ì—­ë§¤í•‘ ìƒì„± (í”„ë¡œë¹ˆì¹˜ì•„ -> ë ˆì§€ì˜¤ë„¤)
                    const reverseMapping = {};
                    Object.keys(italyRegionMapping).forEach(region => {
                        italyRegionMapping[region].forEach(province => {
                            const provLower = province.toLowerCase();
                            reverseMapping[provLower] = region;
                            // í•˜ì´í”ˆ/ê³µë°± ì œê±° ë³€í˜•
                            reverseMapping[provLower.replace(/[-\s]+/g, ' ').trim()] = region;
                            reverseMapping[provLower.replace(/[^\w\s]/g, '').trim()] = region;
                            // ì£¼ìš” ë„ì‹œëª…ë„ ì¶”ê°€
                            if (province.includes('-')) {
                                const parts = province.split('-');
                                parts.forEach(part => {
                                    if (part.length > 3) {
                                        reverseMapping[part.toLowerCase().trim()] = region;
                                    }
                                });
                            }
                        });
                    });
                    
                    // ì§€ì—­ ê·¸ë£¹í™”
                    const groupedFeatures = new Map();
                    const idSet = new Set();
                    
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const nameLower = rawName.toLowerCase().trim();
                        
                        // ì •í™•í•œ ë§¤ì¹­ ë¨¼ì € ì‹œë„
                        let groupName = reverseMapping[nameLower] || null;
                        
                        // ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [key, value] of Object.entries(reverseMapping)) {
                                if (key.length > 3 && (nameLower.includes(key) || key.includes(nameLower))) {
                                    groupName = value;
                                    break;
                                }
                            }
                        }
                        
                        // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [region, provinces] of Object.entries(italyRegionMapping)) {
                                for (const prov of provinces) {
                                    const provLower = prov.toLowerCase();
                                    if (nameLower === provLower || nameLower.includes(provLower) || provLower.includes(nameLower)) {
                                        groupName = region;
                                        break;
                                    }
                                }
                                if (groupName) break;
                            }
                        }
                        
                        // ë ˆì§€ì˜¤ë„¤ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            const regionNames = Object.keys(italyRegionMapping);
                            for (const region of regionNames) {
                                const regionLower = region.toLowerCase();
                                if (nameLower === regionLower || nameLower.includes(regionLower) || regionLower.includes(nameLower)) {
                                    groupName = region;
                                    break;
                                }
                            }
                        }
                        
                        // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬
                        if (!groupName) {
                            console.warn(`[Italy] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­: "${rawName}" - ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬`);
                            groupName = rawName;
                        }
                        
                        if (!groupedFeatures.has(groupName)) {
                            groupedFeatures.set(groupName, {
                                features: [],
                                totalPopulation: 0,
                                totalArea: 0
                            });
                        }
                        
                        const group = groupedFeatures.get(groupName);
                        group.features.push(feature);
                        group.totalPopulation += (p.population || 0);
                        group.totalArea += (p.area || 0);
                    });
                    
                    // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                    const mergedFeatures = [];
                    
                    groupedFeatures.forEach((group, groupName) => {
                        if (group.features.length === 0) return;
                        
                        // ê°œë³„ ì§€ì—­ì¸ ê²½ìš° (ê·¸ë£¹ëª…ì´ ì›ë³¸ ì§€ì—­ëª…ê³¼ ê°™ì€ ê²½ìš°) - ê·¸ë£¹í™”í•˜ì§€ ì•Šê³  ê°œë³„ë¡œ ì²˜ë¦¬
                        const isIndividualRegion = group.features.length === 1 || 
                                                   !Object.keys(italyRegionMapping).includes(groupName);
                        
                        if (isIndividualRegion) {
                            // ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                            group.features.forEach((feature, idx) => {
                                const p = feature.properties || {};
                                const rawName = p.name || p.NAME_1 || p.region || groupName || `Region_${idx}`;
                                
                                if (!feature.geometry || !feature.geometry.coordinates) {
                                    console.warn(`[Italy] "${rawName}" ì§€ì—­ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                    return;
                                }
                                
                                const baseIdSrc = p.hasc || p.shapeID || rawName || `ita_${idx}`;
                                let baseId = baseIdSrc.toString().toLowerCase()
                                    .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                                    .replace(/__+/g, '_')
                                    .replace(/^_|_$/g, '');
                                if (!baseId) baseId = `ita_region_${mergedFeatures.length}`;
                                let finalId = baseId;
                                let c = 1;
                                while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                                idSet.add(finalId);
                                
                                mergedFeatures.push({
                                    type: 'Feature',
                                    geometry: feature.geometry,
                                    properties: {
                                        ...p,
                                        id: finalId,
                                        name: rawName,
                                        name_ko: rawName,
                                        name_en: rawName,
                                        country: 'Italy',
                                        country_code: 'IT',
                                        admin_level: 'Province',
                                        population: p.population || Math.floor(Math.random() * 500000) + 50000,
                                        area: p.area || Math.floor(Math.random() * 5000) + 1000,
                                        ad_status: 'available',
                                        ad_price: 50000 + (mergedFeatures.length * 5000),
                                        revenue: 0,
                                        company: null,
                                        logo: null,
                                        color: '#00d2d3',
                                        border_color: '#ffffff',
                                        border_width: 1
                                    }
                                });
                                
                                this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                            });
                            return;
                        }
                        
                        // ê·¸ë£¹í™”ëœ ì§€ì—­ì¸ ê²½ìš° - Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                        const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                        
                        if (geometries.length === 0) {
                            console.warn(`[Italy] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        let mergedGeometry;
                        if (geometries.length === 1) {
                            mergedGeometry = geometries[0];
                        } else {
                            const allCoordinates = [];
                            geometries.forEach(g => {
                                if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(g.coordinates);
                                } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(...g.coordinates);
                                }
                            });
                            if (allCoordinates.length === 1) {
                                mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                            } else if (allCoordinates.length > 1) {
                                mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                            } else {
                                mergedGeometry = geometries[0];
                            }
                        }
                        
                        // Geometry ê²€ì¦
                        if (!mergedGeometry || !mergedGeometry.coordinates || 
                            (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                            (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                            console.warn(`[Italy] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                            return;
                        }
                        
                        const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ë ˆì§€ì˜¤ë„¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        const regionInfo = italyRegionData[groupName] || {};
                        const regionPopulation = regionInfo.population || Math.max(group.totalPopulation, Math.floor(Math.random() * 5000000) + 500000);
                        const regionArea = regionInfo.area || Math.max(group.totalArea, Math.floor(Math.random() * 30000) + 3000);
                        const regionNameKo = regionInfo.name_ko || groupName;
                        
                        mergedFeatures.push({
                            type: 'Feature',
                            geometry: mergedGeometry,
                            properties: {
                                id: finalId,
                                name: groupName,
                                name_ko: regionNameKo,
                                name_en: groupName,
                                country: 'Italy',
                                country_code: 'IT',
                                admin_level: 'Region',
                                population: regionPopulation,
                                area: regionArea,
                                ad_status: 'available',
                                ad_price: 50000 + (mergedFeatures.length * 10000),
                                revenue: 0,
                                company: null,
                                logo: null,
                                color: '#00d2d3',
                                border_color: '#ffffff',
                                border_width: 1,
                                original_count: group.features.length
                            }
                        });
                        
                        this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                    });
                    
                    console.log(`[Italy] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${originalFeatureCount}ê°œ)`);
                    
                    processedData = {
                        type: 'FeatureCollection',
                        features: mergedFeatures
                    };
                } else if (Array.isArray(data.features)) {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    // ì´íƒˆë¦¬ì•„ ë ˆì§€ì˜¤ë„¤ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                    const italyRegionData = {
                        'Abruzzo': { name_ko: 'ì•„ë¸Œë£¨ì´ˆ', population: 1290000, area: 10832 },
                        'Basilicata': { name_ko: 'ë°”ì‹¤ë¦¬ì¹´íƒ€', population: 530000, area: 9995 },
                        'Calabria': { name_ko: 'ì¹¼ë¼ë¸Œë¦¬ì•„', population: 1870000, area: 15222 },
                        'Campania': { name_ko: 'ìº„íŒŒë‹ˆì•„', population: 5640000, area: 13671 },
                        'Emilia-Romagna': { name_ko: 'ì—ë°€ë¦¬ì•„-ë¡œë§ˆëƒ', population: 4470000, area: 22453 },
                        'Friuli-Venezia Giulia': { name_ko: 'í”„ë¦¬ìš¸ë¦¬-ë² ë„¤ì¹˜ì•„ ì¤„ë¦¬ì•„', population: 1190000, area: 7858 },
                        'Lazio': { name_ko: 'ë¼ì¹˜ì˜¤', population: 5720000, area: 17203 },
                        'Liguria': { name_ko: 'ë¦¬êµ¬ë¦¬ì•„', population: 1520000, area: 5416 },
                        'Lombardy': { name_ko: 'ë¡¬ë°”ë¥´ë””ì•„', population: 10140000, area: 23864 },
                        'Marche': { name_ko: 'ë§ˆë¥´ì¼€', population: 1470000, area: 9366 },
                        'Molise': { name_ko: 'ëª°ë¦¬ì œ', population: 290000, area: 4438 },
                        'Piedmont': { name_ko: 'í”¼ì—ëª¬í…Œ', population: 4280000, area: 25402 },
                        'Puglia': { name_ko: 'í’€ë¦¬ì•„', population: 3940000, area: 19358 },
                        'Sardinia': { name_ko: 'ì‚¬ë¥´ë°ëƒ', population: 1580000, area: 24090 },
                        'Sicily': { name_ko: 'ì‹œì¹ ë¦¬ì•„', population: 4780000, area: 25711 },
                        'Trentino-Alto Adige': { name_ko: 'íŠ¸ë Œí‹°ë…¸-ì•Œí†  ì•„ë””ì œ', population: 1090000, area: 13606 },
                        'Tuscany': { name_ko: 'í† ìŠ¤ì¹´ë‚˜', population: 3660000, area: 22987 },
                        'Umbria': { name_ko: 'ì›€ë¸Œë¦¬ì•„', population: 850000, area: 8456 },
                        'Valle d\'Aosta': { name_ko: 'ë°œë ˆë‹¤ì˜¤ìŠ¤íƒ€', population: 123000, area: 3263 },
                        'Veneto': { name_ko: 'ë² ë„¤í† ', population: 4880000, area: 18345 }
                    };
                    
                    const idSet = new Set();
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `ITA_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `ita_region_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ë ˆì§€ì˜¤ë„¤ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                        let regionInfo = null;
                        for (const [regionName, regionData] of Object.entries(italyRegionData)) {
                            if (rawName.toLowerCase() === regionName.toLowerCase() || 
                                rawName.toLowerCase().includes(regionName.toLowerCase()) ||
                                regionName.toLowerCase().includes(rawName.toLowerCase())) {
                                regionInfo = regionData;
                                break;
                            }
                        }
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: regionInfo ? regionInfo.name_ko : rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'Italy',
                            country_code: 'IT',
                            admin_level: 'Region',
                            population: regionInfo ? regionInfo.population : (p.population || Math.floor(Math.random() * 5000000) + 500000),
                            area: regionInfo ? regionInfo.area : (p.area || Math.floor(Math.random() * 30000) + 3000),
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 220000) + 160000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#00d2d3',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                
                return processedData;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#00d2d3'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ë ˆì§€ì˜¤ë„¤');
            this.showNotification(`ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì´íƒˆë¦¬ì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ (ì£¼/Estado ë‹¨ìœ„)
    async loadBrazilData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('brazil', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries BRA ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/BRA/ADM1/geoBoundaries-BRA-ADM1.geojson',
                    // Natural Earth Brazil states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë¸Œë¼ì§ˆë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'BRA' || admin === 'Brazil' || iso2 === 'BR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Brazil] Filtered Natural Earth/global dataset to Brazil only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 15) {
                            data = fetchedData;
                            console.log('[Brazil] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 15) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Brazil] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 15 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Brazil] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Brazil] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Brazil dataset available');
                
                // ë¸Œë¼ì§ˆ ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                const brazilStateData = {
                    'Acre': { name_ko: 'ì•„í¬ë¦¬', code: 'AC', population: 910000, area: 164123 },
                    'Alagoas': { name_ko: 'ì•Œë¼ê³ ì•„ìŠ¤', code: 'AL', population: 3350000, area: 27778 },
                    'AmapÃ¡': { name_ko: 'ì•„ë§ˆíŒŒ', code: 'AP', population: 920000, area: 142814 },
                    'Amazonas': { name_ko: 'ì•„ë§ˆì¡°ë‚˜ìŠ¤', code: 'AM', population: 4270000, area: 1559168 },
                    'Bahia': { name_ko: 'ë°”ì´ì•„', code: 'BA', population: 15050000, area: 564760 },
                    'CearÃ¡': { name_ko: 'ì„¸ì•„ë¼', code: 'CE', population: 9550000, area: 148894 },
                    'Distrito Federal': { name_ko: 'ì—°ë°©êµ¬', code: 'DF', population: 3250000, area: 5802 },
                    'EspÃ­rito Santo': { name_ko: 'ì´ìŠ¤í”¼ë¦¬íˆ¬ ì‚°íˆ¬', code: 'ES', population: 4180000, area: 46077 },
                    'GoiÃ¡s': { name_ko: 'ê³ ì´ì•„ìŠ¤', code: 'GO', population: 7360000, area: 340112 },
                    'MaranhÃ£o': { name_ko: 'ë§ˆë¼ëƒ¥', code: 'MA', population: 7240000, area: 331936 },
                    'Mato Grosso': { name_ko: 'ë§ˆíˆ¬ ê·¸ë¡œìˆ˜', code: 'MT', population: 3780000, area: 903357 },
                    'Mato Grosso do Sul': { name_ko: 'ë§ˆíˆ¬ ê·¸ë¡œìˆ˜ ë‘ ìˆ ', code: 'MS', population: 2940000, area: 357145 },
                    'Minas Gerais': { name_ko: 'ë¯¸ë‚˜ìŠ¤ ì œë¼ì´ìŠ¤', code: 'MG', population: 20540000, area: 586521 },
                    'ParÃ¡': { name_ko: 'íŒŒë¼', code: 'PA', population: 9220000, area: 1247689 },
                    'ParaÃ­ba': { name_ko: 'íŒŒë¼ì´ë°”', code: 'PB', population: 4150000, area: 56439 },
                    'ParanÃ¡': { name_ko: 'íŒŒë¼ë‚˜', code: 'PR', population: 11740000, area: 199307 },
                    'Pernambuco': { name_ko: 'í˜ë¥´ë‚¨ë¶€ì¿ ', code: 'PE', population: 9760000, area: 98312 },
                    'PiauÃ­': { name_ko: 'í”¼ì•„ìš°ì´', code: 'PI', population: 3320000, area: 251529 },
                    'Rio de Janeiro': { name_ko: 'ë¦¬ìš°ë°ìë„¤ì´ë£¨', code: 'RJ', population: 16420000, area: 43696 },
                    'Rio Grande do Norte': { name_ko: 'ë¦¬ìš° ê·¸ë€ì§€ ë‘ ë…¸ë¥´ì¹˜', code: 'RN', population: 3560000, area: 52811 },
                    'Rio Grande do Sul': { name_ko: 'ë¦¬ìš° ê·¸ë€ì§€ ë‘ ìˆ ', code: 'RS', population: 10980000, area: 281707 },
                    'RondÃ´nia': { name_ko: 'ë¡ ë„ë‹ˆì•„', code: 'RO', population: 1620000, area: 237765 },
                    'Roraima': { name_ko: 'ë¡œë¼ì´ë§ˆ', code: 'RR', population: 660000, area: 224301 },
                    'Santa Catarina': { name_ko: 'ì‚°íƒ€ ì¹´íƒ€ë¦¬ë‚˜', code: 'SC', population: 7760000, area: 95730 },
                    'SÃ£o Paulo': { name_ko: 'ìƒíŒŒìš¸ë£¨', code: 'SP', population: 46250000, area: 248222 },
                    'Sergipe': { name_ko: 'ì„¸ë¥´ì§€í”¼', code: 'SE', population: 2390000, area: 21910 },
                    'Tocantins': { name_ko: 'í† ì¹¸ì¹­ìŠ¤', code: 'TO', population: 1620000, area: 277720 }
                };
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('brazil', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('brazil', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    // ë” ê¸´ ì´ë¦„ì„ ìš°ì„  ë§¤ì¹­í•˜ê¸° ìœ„í•´ ì´ë¦„ ê¸¸ì´ë¡œ ì •ë ¬
                    let stateInfo = null;
                    const sortedStates = Object.entries(brazilStateData).sort((a, b) => b[0].length - a[0].length);
                    const rawLower = rawName.toLowerCase();
                    for (const [stateName, stateData] of sortedStates) {
                        const stateLower = stateName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === stateLower || 
                            rawLower.includes(stateLower) || 
                            stateLower.includes(rawLower) ||
                            rawLower === stateData.code.toLowerCase() ||
                            rawLower.includes(stateData.code.toLowerCase())) {
                            stateInfo = stateData;
                            break;
                        }
                    }
                    
                    // ë©´ì  ê³„ì‚°: stateInfoì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ GeoJSON, ì—†ìœ¼ë©´ ì‹¤ì œ ê³„ì‚°
                    let calculatedArea = stateInfo ? stateInfo.area : (p.area && p.area > 0 ? p.area : 0);
                    if (calculatedArea <= 0 && feature.geometry) {
                        calculatedArea = this.calculatePolygonArea(feature);
                        if (calculatedArea > 0) {
                            console.log(`[ë¸Œë¼ì§ˆ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${calculatedArea.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Brazil',
                        country_code: 'BR',
                        admin_level: 'State',
                        population: stateInfo ? stateInfo.population : (p.population && p.population > 0 ? p.population : 0),
                        area: calculatedArea, // ê³„ì‚°ëœ ë©´ì  ì‚¬ìš©
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 280000) + 180000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#feca57',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                });
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#feca57'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë¸Œë¼ì§ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í˜¸ì£¼ ë°ì´í„° ë¡œë“œ (ì£¼/State ë‹¨ìœ„)
    async loadAustraliaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('australia', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries AUS ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/AUS/ADM1/geoBoundaries-AUS-ADM1.geojson',
                    // click_that_hood australia
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/australia.geojson',
                    // Natural Earth Australia states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í˜¸ì£¼ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'AUS' || admin === 'Australia' || iso2 === 'AU';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Australia] Filtered Natural Earth/global dataset to Australia only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = fetchedData;
                            console.log('[Australia] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Australia] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 5 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Australia] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Australia] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Australia dataset available');
                
                // í˜¸ì£¼ ì£¼Â·ì¤€ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                const australiaStateData = {
                    'New South Wales': { name_ko: 'ë‰´ì‚¬ìš°ìŠ¤ì›¨ì¼ìŠ¤', code: 'NSW', population: 8480000, area: 801150 },
                    'Victoria': { name_ko: 'ë¹…í† ë¦¬ì•„', code: 'VIC', population: 6900000, area: 227444 },
                    'Queensland': { name_ko: 'í€¸ì¦ëœë“œ', code: 'QLD', population: 5550000, area: 1729742 },
                    'Western Australia': { name_ko: 'ì„œí˜¸ì£¼', code: 'WA', population: 2910000, area: 2527013 },
                    'South Australia': { name_ko: 'ë‚¨í˜¸ì£¼', code: 'SA', population: 1830000, area: 984321 },
                    'Tasmania': { name_ko: 'íƒ€ìŠ¤ë§ˆë‹ˆì•„', code: 'TAS', population: 550000, area: 68401 },
                    'Northern Territory': { name_ko: 'ë…¸ë˜ ì¤€ì£¼', code: 'NT', population: 250000, area: 1347791 },
                    'Australian Capital Territory': { name_ko: 'ì˜¤ìŠ¤íŠ¸ë ˆì¼ë¦¬ì•ˆ ìˆ˜ë„ ì¤€ì£¼', code: 'ACT', population: 460000, area: 2358 }
                };
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `AUS_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `aus_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼/ì¤€ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    // ë” ê¸´ ì´ë¦„ì„ ìš°ì„  ë§¤ì¹­í•˜ê¸° ìœ„í•´ ì´ë¦„ ê¸¸ì´ë¡œ ì •ë ¬
                    let stateInfo = null;
                    const sortedStates = Object.entries(australiaStateData).sort((a, b) => b[0].length - a[0].length);
                    const rawLower = rawName.toLowerCase();
                    for (const [stateName, stateData] of sortedStates) {
                        const stateLower = stateName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === stateLower || 
                            rawLower.includes(stateLower) || 
                            stateLower.includes(rawLower) ||
                            rawLower === stateData.code.toLowerCase() ||
                            rawLower.includes(stateData.code.toLowerCase())) {
                            stateInfo = stateData;
                            break;
                        }
                    }
                    
                    // ë©´ì  ê³„ì‚°: stateInfoì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ GeoJSON, ì—†ìœ¼ë©´ ì‹¤ì œ ê³„ì‚°
                    let calculatedArea = stateInfo ? stateInfo.area : (p.area && p.area > 0 ? p.area : 0);
                    if (calculatedArea <= 0 && feature.geometry) {
                        calculatedArea = this.calculatePolygonArea(feature);
                        if (calculatedArea > 0) {
                            console.log(`[í˜¸ì£¼ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${calculatedArea.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Australia',
                        country_code: 'AU',
                        admin_level: 'State/Territory',
                        population: stateInfo ? stateInfo.population : (p.population && p.population > 0 ? p.population : 0),
                        area: calculatedArea, // ê³„ì‚°ëœ ë©´ì  ì‚¬ìš©
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 240000) + 160000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ff6348',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                });
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ff6348'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í˜¸ì£¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼/ì˜í† ');
            this.showNotification(`í˜¸ì£¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í˜¸ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í˜¸ì£¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ (ì£¼/Estado ë‹¨ìœ„)
    async loadMexicoData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('mexico', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries MEX ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/MEX/ADM1/geoBoundaries-MEX-ADM1.geojson',
                    // click_that_hood mexico
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/mexico.geojson',
                    // Natural Earth Mexico states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë©•ì‹œì½”ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'MEX' || admin === 'Mexico' || iso2 === 'MX';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Mexico] Filtered Natural Earth/global dataset to Mexico only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 20) {
                            data = fetchedData;
                            console.log('[Mexico] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 20) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Mexico] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 20 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Mexico] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Mexico] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Mexico dataset available');
                
                // ë©•ì‹œì½” ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                const mexicoStateData = {
                    'Aguascalientes': { name_ko: 'ì•„ê³¼ìŠ¤ì¹¼ë¦¬ì—”í…ŒìŠ¤', code: 'AGU', population: 1500000, area: 5618 },
                    'Baja California': { name_ko: 'ë°”í•˜ì¹¼ë¦¬í¬ë¥´ë‹ˆì•„', code: 'BC', population: 4000000, area: 71450 },
                    'Baja California Sur': { name_ko: 'ë°”í•˜ì¹¼ë¦¬í¬ë¥´ë‹ˆì•„ ìˆ˜ë¥´', code: 'BCS', population: 860000, area: 73922 },
                    'Campeche': { name_ko: 'ìº„í˜ì²´', code: 'CAM', population: 980000, area: 57507 },
                    'Chiapas': { name_ko: 'ì¹˜ì•„íŒŒìŠ¤', code: 'CHIS', population: 5750000, area: 73311 },
                    'Chihuahua': { name_ko: 'ì¹˜ì™€ì™€', code: 'CHIH', population: 3950000, area: 247460 },
                    'Coahuila': { name_ko: 'ì½”ì•„ìš°ì¼ë¼', code: 'COAH', population: 3300000, area: 151563 },
                    'Coahuila de Zaragoza': { name_ko: 'ì½”ì•„ìš°ì¼ë¼ ë° ì‚¬ë¼ê³ ì‚¬', code: 'COAH', population: 3300000, area: 151563 },
                    'Colima': { name_ko: 'ì½œë¦¬ë§ˆ', code: 'COL', population: 760000, area: 5191 },
                    'Durango': { name_ko: 'ë‘ë‘ê³ ', code: 'DGO', population: 1800000, area: 123451 },
                    'Guanajuato': { name_ko: 'ê³¼ë‚˜í›„ì•„í† ', code: 'GTO', population: 6400000, area: 30608 },
                    'Guerrero': { name_ko: 'ê²Œë ˆë¡œ', code: 'GRO', population: 3600000, area: 63596 },
                    'Hidalgo': { name_ko: 'ì´ë‹¬ê³ ', code: 'HGO', population: 3100000, area: 20813 },
                    'Jalisco': { name_ko: 'í• ë¦¬ìŠ¤ì½”', code: 'JAL', population: 8600000, area: 78599 },
                    'MÃ©xico': { name_ko: 'ë©•ì‹œì½” ì£¼', code: 'MEX', population: 18200000, area: 22357 },
                    'Mexico': { name_ko: 'ë©•ì‹œì½” ì£¼', code: 'MEX', population: 18200000, area: 22357 },
                    'MichoacÃ¡n': { name_ko: 'ë¯¸ì´ˆì•„ì¹¸', code: 'MICH', population: 5000000, area: 58599 },
                    'Michoacan': { name_ko: 'ë¯¸ì´ˆì•„ì¹¸', code: 'MICH', population: 5000000, area: 58599 },
                    'Morelos': { name_ko: 'ëª¨ë ë¡œìŠ¤', code: 'MOR', population: 2100000, area: 4893 },
                    'Nayarit': { name_ko: 'ë‚˜ì•¼ë¦¬íŠ¸', code: 'NAY', population: 1400000, area: 27857 },
                    'Nuevo LeÃ³n': { name_ko: 'ëˆ„ì—ë³´ë ˆì˜¨', code: 'NL', population: 6000000, area: 64555 },
                    'Nuevo Leon': { name_ko: 'ëˆ„ì—ë³´ë ˆì˜¨', code: 'NL', population: 6000000, area: 64555 },
                    'Oaxaca': { name_ko: 'ì˜¤ì•„í•˜ì¹´', code: 'OAX', population: 4300000, area: 93757 },
                    'Puebla': { name_ko: 'í‘¸ì—ë¸”ë¼', code: 'PUE', population: 6900000, area: 34306 },
                    'QuerÃ©taro': { name_ko: 'ì¼€ë ˆíƒ€ë¡œ', code: 'QRO', population: 2500000, area: 11690 },
                    'Queretaro': { name_ko: 'ì¼€ë ˆíƒ€ë¡œ', code: 'QRO', population: 2500000, area: 11690 },
                    'Quintana Roo': { name_ko: 'í‚¨íƒ€ë‚˜ë¡œì˜¤', code: 'QROO', population: 2100000, area: 50351 },
                    'San Luis PotosÃ­': { name_ko: 'ì‚°ë£¨ì´ìŠ¤í¬í† ì‹œ', code: 'SLP', population: 2900000, area: 60983 },
                    'San Luis Potosi': { name_ko: 'ì‚°ë£¨ì´ìŠ¤í¬í† ì‹œ', code: 'SLP', population: 2900000, area: 60983 },
                    'Sinaloa': { name_ko: 'ì‹œë‚ ë¡œì•„', code: 'SIN', population: 3200000, area: 58092 },
                    'Sonora': { name_ko: 'ì†Œë…¸ë¼', code: 'SON', population: 3200000, area: 179503 },
                    'Tabasco': { name_ko: 'íƒ€ë°”ìŠ¤ì½”', code: 'TAB', population: 2500000, area: 25267 },
                    'Tamaulipas': { name_ko: 'íƒ€ë§ˆìš¸ë¦¬íŒŒìŠ¤', code: 'TAMPS', population: 3800000, area: 80175 },
                    'Tlaxcala': { name_ko: 'í‹€ë½ìŠ¤ì¹¼ë¼', code: 'TLAX', population: 1400000, area: 4016 },
                    'Veracruz': { name_ko: 'ë² ë¼í¬ë£¨ìŠ¤', code: 'VER', population: 8000000, area: 71820 },
                    'YucatÃ¡n': { name_ko: 'ìœ ì¹´íƒ„', code: 'YUC', population: 2500000, area: 39524 },
                    'Yucatan': { name_ko: 'ìœ ì¹´íƒ„', code: 'YUC', population: 2500000, area: 39524 },
                    'Zacatecas': { name_ko: 'ì‚¬ì¹´í…Œì¹´ìŠ¤', code: 'ZAC', population: 1700000, area: 75539 },
                    'Ciudad de MÃ©xico': { name_ko: 'ë©•ì‹œì½”ì‹œí‹°', code: 'CDMX', population: 9500000, area: 1495 },
                    'Mexico City': { name_ko: 'ë©•ì‹œì½”ì‹œí‹°', code: 'CDMX', population: 9500000, area: 1495 },
                    'Distrito Federal': { name_ko: 'ë©•ì‹œì½”ì‹œí‹°', code: 'CDMX', population: 9500000, area: 1495 }
                };
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('mexico', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('mexico', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    // ë” ê¸´ ì´ë¦„ì„ ìš°ì„  ë§¤ì¹­í•˜ê¸° ìœ„í•´ ì´ë¦„ ê¸¸ì´ë¡œ ì •ë ¬
                    let stateInfo = null;
                    const sortedStates = Object.entries(mexicoStateData).sort((a, b) => b[0].length - a[0].length);
                    const rawLower = rawName.toLowerCase();
                    for (const [stateName, stateData] of sortedStates) {
                        const stateLower = stateName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === stateLower || 
                            rawLower.includes(stateLower) || 
                            stateLower.includes(rawLower) ||
                            rawLower === stateData.code.toLowerCase() ||
                            rawLower.includes(stateData.code.toLowerCase())) {
                            stateInfo = stateData;
                            break;
                        }
                    }
                    
                    // ë©´ì  ê³„ì‚°: stateInfoì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ GeoJSON, ì—†ìœ¼ë©´ ì‹¤ì œ ê³„ì‚°
                    let calculatedArea = stateInfo ? stateInfo.area : (p.area && p.area > 0 ? p.area : 0);
                    if (calculatedArea <= 0 && feature.geometry) {
                        calculatedArea = this.calculatePolygonArea(feature);
                        if (calculatedArea > 0) {
                            console.log(`[ë©•ì‹œì½” ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${calculatedArea.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Mexico',
                        country_code: 'MX',
                        admin_level: 'State',
                        population: stateInfo ? stateInfo.population : (p.population && p.population > 0 ? p.population : 0),
                        area: calculatedArea, // ê³„ì‚°ëœ ë©´ì  ì‚¬ìš©
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 230000) + 170000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#10ac84',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                });
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#10ac84'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë©•ì‹œì½” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ (ì£¼/Provinsi ë‹¨ìœ„)
    async loadIndonesiaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('indonesia', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries IDN ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/IDN/ADM1/geoBoundaries-IDN-ADM1.geojson',
                    // Natural Earth Indonesia provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì¸ë„ë„¤ì‹œì•„ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'IDN' || admin === 'Indonesia' || iso2 === 'ID';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Indonesia] Filtered Natural Earth/global dataset to Indonesia only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 10) {
                            data = fetchedData;
                            console.log('[Indonesia] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 10) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Indonesia] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 10 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Indonesia] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Indonesia] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Indonesia dataset available');
                
                // ì¸ë„ë„¤ì‹œì•„ ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (mid-2024 ê¸°ì¤€)
                const indonesiaProvinceData = {
                    'Aceh': { name_ko: 'ì•„ì²´', code: 'AC', population: 5554800, area: 56835 },
                    'North Sumatra': { name_ko: 'ë¶ë¶€ ìˆ˜ë§ˆíŠ¸ë¼', code: 'SU', population: 15588500, area: 72981 },
                    'West Sumatra': { name_ko: 'ì„œë¶€ ìˆ˜ë§ˆíŠ¸ë¼', code: 'SB', population: 5836200, area: 42120 },
                    'Riau': { name_ko: 'ë¦¬ì•„ìš°', code: 'RI', population: 6728100, area: 89936 },
                    'Jambi': { name_ko: 'ì ë¹„', code: 'JA', population: 3724300, area: 49027 },
                    'South Sumatra': { name_ko: 'ë‚¨ë¶€ ìˆ˜ë§ˆíŠ¸ë¼', code: 'SS', population: 8837300, area: 86772 },
                    'Bengkulu': { name_ko: 'ë²µì¿¨ë£¨', code: 'BE', population: 2112200, area: 20128 },
                    'Lampung': { name_ko: 'ëŒí’', code: 'LA', population: 9419600, area: 33570 },
                    'Bangka Belitung Islands': { name_ko: 'ë°©ì¹´ ë¸”ë¦¬í‰ ì œë„', code: 'BB', population: 1531500, area: 16690 },
                    'Riau Islands': { name_ko: 'ë¦¬ì•„ìš° ì œë„', code: 'KR', population: 2183300, area: 8270 },
                    'Jakarta': { name_ko: 'ìì¹´ë¥´íƒ€ íŠ¹ë³„ìˆ˜ë„ì§€ì—­', code: 'JK', population: 10684900, area: 661 },
                    'DKI Jakarta': { name_ko: 'ìì¹´ë¥´íƒ€ íŠ¹ë³„ìˆ˜ë„ì§€ì—­', code: 'JK', population: 10684900, area: 661 },
                    'Jakarta Special Capital Region': { name_ko: 'ìì¹´ë¥´íƒ€ íŠ¹ë³„ìˆ˜ë„ì§€ì—­', code: 'JK', population: 10684900, area: 661 },
                    'West Java': { name_ko: 'ì„œë¶€ ìë°”', code: 'JB', population: 50345200, area: 37045 },
                    'Central Java': { name_ko: 'ì¤‘ë¶€ ìë°”', code: 'JT', population: 37892300, area: 34337 },
                    'Yogyakarta': { name_ko: 'ìš•ì•¼ì¹´ë¥´íƒ€ íŠ¹ë³„ì§€ì—­', code: 'YO', population: 3759500, area: 3171 },
                    'Daerah Istimewa Yogyakarta': { name_ko: 'ìš•ì•¼ì¹´ë¥´íƒ€ íŠ¹ë³„ì§€ì—­', code: 'YO', population: 3759500, area: 3171 },
                    'East Java': { name_ko: 'ë™ë¶€ ìë°”', code: 'JI', population: 41814500, area: 48037 },
                    'Banten': { name_ko: 'ë°˜í…', code: 'BT', population: 12431400, area: 9353 },
                    'Bali': { name_ko: 'ë°œë¦¬', code: 'BA', population: 4433300, area: 5590 },
                    'West Nusa Tenggara': { name_ko: 'ì„œë¶€ ëˆ„ì‚¬ í…¡ê°€ë¼', code: 'NB', population: 5646000, area: 19676 },
                    'East Nusa Tenggara': { name_ko: 'ë™ë¶€ ëˆ„ì‚¬ í…¡ê°€ë¼', code: 'NT', population: 5656000, area: 46447 },
                    'West Kalimantan': { name_ko: 'ì„œë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KB', population: 5695500, area: 147037 },
                    'Central Kalimantan': { name_ko: 'ì¤‘ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KT', population: 2809700, area: 153444 },
                    'South Kalimantan': { name_ko: 'ë‚¨ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KS', population: 4273400, area: 37135 },
                    'East Kalimantan': { name_ko: 'ë™ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KI', population: 4045900, area: 126981 },
                    'North Kalimantan': { name_ko: 'ë¶ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KU', population: 739800, area: 70101 },
                    'North Sulawesi': { name_ko: 'ë¶ë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'SA', population: 2701800, area: 14500 },
                    'Central Sulawesi': { name_ko: 'ì¤‘ë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'ST', population: 3121800, area: 61606 },
                    'South Sulawesi': { name_ko: 'ë‚¨ë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'SN', population: 9463400, area: 45331 },
                    'Southeast Sulawesi': { name_ko: 'ë™ë‚¨ ìˆ ë¼ì›¨ì‹œ', code: 'SG', population: 2793100, area: 36160 },
                    'Gorontalo': { name_ko: 'ê³ ë¡ íƒˆë¡œ', code: 'GO', population: 1227800, area: 12025 },
                    'West Sulawesi': { name_ko: 'ì„œë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'SR', population: 1503200, area: 16595 },
                    'Maluku': { name_ko: 'ë§ë£¨ì¿ ', code: 'MA', population: 1945600, area: 46158 },
                    'North Maluku': { name_ko: 'ë¶ë¶€ ë§ë£¨ì¿ ', code: 'MU', population: 1355600, area: 32999 },
                    'Papua': { name_ko: 'íŒŒí‘¸ì•„', code: 'PA', population: 1060600, area: 82681 },
                    'West Papua': { name_ko: 'ì„œë¶€ íŒŒí‘¸ì•„', code: 'PB', population: 578700, area: 60275 }
                };
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('indonesia', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('indonesia', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    // ë” ê¸´ ì´ë¦„ì„ ìš°ì„  ë§¤ì¹­í•˜ê¸° ìœ„í•´ ì´ë¦„ ê¸¸ì´ë¡œ ì •ë ¬
                    let provinceInfo = null;
                    const sortedProvinces = Object.entries(indonesiaProvinceData).sort((a, b) => b[0].length - a[0].length);
                    const rawLower = rawName.toLowerCase();
                    for (const [provinceName, provinceData] of sortedProvinces) {
                        const provinceLower = provinceName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === provinceLower || 
                            rawLower.includes(provinceLower) || 
                            provinceLower.includes(rawLower) ||
                            rawLower === provinceData.code.toLowerCase() ||
                            rawLower.includes(provinceData.code.toLowerCase())) {
                            provinceInfo = provinceData;
                            break;
                        }
                    }
                    
                    // ë©´ì  ê³„ì‚°: provinceInfoì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ GeoJSON, ì—†ìœ¼ë©´ ì‹¤ì œ ê³„ì‚°
                    let calculatedArea = provinceInfo ? provinceInfo.area : (p.area && p.area > 0 ? p.area : 0);
                    if (calculatedArea <= 0 && feature.geometry) {
                        calculatedArea = this.calculatePolygonArea(feature);
                        if (calculatedArea > 0) {
                            console.log(`[ì¸ë„ë„¤ì‹œì•„ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${calculatedArea.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceInfo ? provinceInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Indonesia',
                        country_code: 'ID',
                        admin_level: 'Province',
                        population: provinceInfo ? provinceInfo.population : (p.population && p.population > 0 ? p.population : 0),
                        area: calculatedArea,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 200000) + 120000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ffa502',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                });
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ffa502'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¸ë„ë„¤ì‹œì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ (ì£¼/Province ë‹¨ìœ„)
    async loadSaudiArabiaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('saudi-arabia', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries SAU ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/SAU/ADM1/geoBoundaries-SAU-ADM1.geojson',
                    // Natural Earth Saudi Arabia provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'SAU' || admin === 'Saudi Arabia' || iso2 === 'SA';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Saudi Arabia] Filtered Natural Earth/global dataset to Saudi Arabia only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = fetchedData;
                            console.log('[Saudi Arabia] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Saudi Arabia] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 5 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Saudi Arabia] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Saudi Arabia] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Saudi Arabia dataset available');
                
                // ì‚¬ìš°ë”” ì•„ë¼ë¹„ì•„ ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2022 ê¸°ì¤€)
                const saudiArabiaProvinceData = {
                    'Riyadh': { name_ko: 'ë¦¬ì•¼ë“œ', population: 8591748, area: 404240 },
                    'Makkah': { name_ko: 'ë©”ì¹´', population: 7769994, area: 153128 },
                    'Madinah': { name_ko: 'ë©”ë””ë‚˜', population: 2389452, area: 151990 },
                    'Al-Qassim': { name_ko: 'ì¹´ì‹¬', population: 1336179, area: 58046 },
                    'Eastern Province': { name_ko: 'ë™ë¶€ ì£¼', population: 5125254, area: 672522 },
                    'Al-Sharqiyah': { name_ko: 'ì•Œìƒ¤ë¥´í‚¤ì•¼', population: 5125254, area: 672522 },
                    'Asir': { name_ko: 'ì•„ì‹œë¥´', population: 2024285, area: 76693 },
                    'Tabuk': { name_ko: 'íƒ€ë¶€í¬', population: 886036, area: 146072 },
                    'Hail': { name_ko: 'í•˜ì¼', population: 746406, area: 103887 },
                    'Northern Borders': { name_ko: 'ë¶ë¶€ ë³€ê²½ ì£¼', population: 373577, area: 111797 },
                    'Al-Hudud ash-Shamaliyah': { name_ko: 'ì•Œí›„ë‘ë“œ ì•„ìƒ¤ë§ë¦¬ì•¼', population: 373577, area: 111797 },
                    'Jazan': { name_ko: 'ìì”', population: 1404997, area: 11671 },
                    'Jizan': { name_ko: 'ìì”', population: 1404997, area: 11671 },
                    'Najran': { name_ko: 'ë‚˜ì¦ˆë€', population: 592300, area: 149511 },
                    'Al-Baha': { name_ko: 'ë°”í•˜', population: 339174, area: 9921 },
                    'Al-Jawf': { name_ko: 'ì•Œììš°í”„', population: 500000, area: 100212 }
                };
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('saudi-arabia', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('saudi-arabia', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    // ë” ê¸´ ì´ë¦„ì„ ìš°ì„  ë§¤ì¹­í•˜ê¸° ìœ„í•´ ì´ë¦„ ê¸¸ì´ë¡œ ì •ë ¬
                    let provinceInfo = null;
                    const sortedProvinces = Object.entries(saudiArabiaProvinceData).sort((a, b) => b[0].length - a[0].length);
                    const rawLower = rawName.toLowerCase();
                    for (const [provinceName, provinceData] of sortedProvinces) {
                        const provinceLower = provinceName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­
                        if (rawLower === provinceLower || 
                            rawLower.includes(provinceLower) || 
                            provinceLower.includes(rawLower)) {
                            provinceInfo = provinceData;
                            break;
                        }
                    }
                    
                    // ë©´ì  ê³„ì‚°: provinceInfoì— ìˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ GeoJSON, ì—†ìœ¼ë©´ ì‹¤ì œ ê³„ì‚°
                    let calculatedArea = provinceInfo ? provinceInfo.area : (p.area && p.area > 0 ? p.area : 0);
                    if (calculatedArea <= 0 && feature.geometry) {
                        calculatedArea = this.calculatePolygonArea(feature);
                        if (calculatedArea > 0) {
                            console.log(`[ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${calculatedArea.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceInfo ? provinceInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Saudi Arabia',
                        country_code: 'SA',
                        admin_level: 'Province',
                        population: provinceInfo ? provinceInfo.population : (p.population && p.population > 0 ? p.population : 0),
                        area: calculatedArea,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 250000) + 200000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#0652DD',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                });
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#0652DD'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í„°í‚¤ ë°ì´í„° ë¡œë“œ (ì£¼/Province ë‹¨ìœ„)
    async loadTurkeyData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('turkey', async () => {
                let data = null;
                const candidateUrls = [
                    // geoBoundaries TUR ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/TUR/ADM1/geoBoundaries-TUR-ADM1.geojson',
                    // click_that_hood turkey
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/turkey.geojson',
                    // Natural Earth Turkey provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í„°í‚¤ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'TUR' || admin === 'Turkey' || iso2 === 'TR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Turkey] Filtered Natural Earth/global dataset to Turkey only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 50) {
                            data = fetchedData;
                            console.log('[Turkey] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 50) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Turkey] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 50 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Turkey] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Turkey] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Turkey dataset available');
                
                // 81ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš” (ì£¼ -> ì§€ì—­)
                const needsGrouping = data.features && data.features.length > 50;
                
                if (needsGrouping) {
                    // íŠ€ë¥´í‚¤ì˜ˆ ì£¼ë¥¼ 7ê°œ ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    const turkeyRegionMapping = {
                        'Marmara Region': ['BalÄ±kesir', 'Bilecik', 'Bursa', 'Ã‡anakkale', 'Edirne', 'Ä°stanbul', 'Istanbul', 'KÄ±rklareli', 'Kocaeli', 'Sakarya', 'TekirdaÄŸ', 'Tekirdag', 'Yalova'],
                        'Aegean Region': ['Afyonkarahisar', 'AydÄ±n', 'Aydin', 'Denizli', 'Ä°zmir', 'Izmir', 'KÃ¼tahya', 'Kutahya', 'Manisa', 'MuÄŸla', 'Mugla', 'UÅŸak', 'Usak'],
                        'Mediterranean Region': ['Adana', 'Antalya', 'Burdur', 'Hatay', 'Isparta', 'Mersin', 'Osmaniye', 'KahramanmaraÅŸ', 'KahramanmaraÅŸ', 'Kahramanmaras'],
                        'Central Anatolia Region': ['Aksaray', 'Ankara', 'Ã‡ankÄ±rÄ±', 'Cankiri', 'EskiÅŸehir', 'Eskisehir', 'Karaman', 'Kayseri', 'KÄ±rÄ±kkale', 'Kirikkale', 'KÄ±rÅŸehir', 'Kirsehir', 'Konya', 'NevÅŸehir', 'Nevsehir', 'NiÄŸde', 'Nigde', 'Sivas', 'Yozgat'],
                        'Black Sea Region': ['Amasya', 'Artvin', 'BartÄ±n', 'Bartin', 'Bayburt', 'Bolu', 'Ã‡orum', 'Corum', 'DÃ¼zce', 'Duzce', 'Giresun', 'GÃ¼mÃ¼ÅŸhane', 'Gumushane', 'KarabÃ¼k', 'Karabuk', 'Kastamonu', 'Ordu', 'Rize', 'Samsun', 'Sinop', 'Tokat', 'Trabzon', 'Zonguldak'],
                        'Eastern Anatolia Region': ['AÄŸrÄ±', 'Agri', 'Ardahan', 'BingÃ¶l', 'Bingol', 'Bitlis', 'ElazÄ±ÄŸ', 'Elazig', 'Erzincan', 'Erzurum', 'HakkÃ¢ri', 'Hakkari', 'IÄŸdÄ±r', 'Igdir', 'Kars', 'Malatya', 'MuÅŸ', 'Mus', 'Tunceli', 'Van'],
                        'Southeastern Anatolia Region': ['AdÄ±yaman', 'Adiyaman', 'Batman', 'DiyarbakÄ±r', 'Diyarbakir', 'Gaziantep', 'Kilis', 'Mardin', 'Siirt', 'ÅanlÄ±urfa', 'Sanliurfa', 'ÅÄ±rnak', 'Sirnak']
                    };
                    
                    // íŠ€ë¥´í‚¤ì˜ˆ ì§€ì—­ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                    const turkeyRegionData = {
                        'Marmara Region': { name_ko: 'ë§ˆë¥´ë§ˆë¼', population: 26650000, area: 67000 },
                        'Aegean Region': { name_ko: 'ì—ê²Œí•´', population: 10974000, area: 90000 },
                        'Mediterranean Region': { name_ko: 'ì§€ì¤‘í•´', population: 10584000, area: 89500 },
                        'Central Anatolia Region': { name_ko: 'ì¤‘ì•™ ì•„ë‚˜í†¨ë¦¬ì•„', population: 12000000, area: 65000 },
                        'Black Sea Region': { name_ko: 'í‘í•´', population: 8500000, area: 70000 },
                        'Eastern Anatolia Region': { name_ko: 'ë™ë¶€ ì•„ë‚˜í†¨ë¦¬ì•„', population: 6500000, area: 165000 },
                        'Southeastern Anatolia Region': { name_ko: 'ë™ë‚¨ë¶€ ì•„ë‚˜í†¨ë¦¬ì•„', population: 9490000, area: 76200 }
                    };
                    
                    // ì—­ë§¤í•‘ ìƒì„± (ì£¼ -> ì§€ì—­)
                    const reverseMapping = {};
                    Object.keys(turkeyRegionMapping).forEach(region => {
                        turkeyRegionMapping[region].forEach(province => {
                            const provLower = province.toLowerCase();
                            reverseMapping[provLower] = region;
                            // í„°í‚¤ì–´ íŠ¹ìˆ˜ë¬¸ì ì œê±° ë³€í˜•
                            reverseMapping[provLower.replace(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄIÄ°Ã–ÅÃœ]/g, (m) => {
                                const map = { 'Ã§': 'c', 'ÄŸ': 'g', 'Ä±': 'i', 'Ã¶': 'o', 'ÅŸ': 's', 'Ã¼': 'u',
                                             'Ã‡': 'c', 'Ä': 'g', 'Ä°': 'i', 'Ã–': 'o', 'Å': 's', 'Ãœ': 'u' };
                                return map[m] || m;
                            })] = region;
                        });
                    });
                    
                    // ì§€ì—­ ê·¸ë£¹í™”
                    const groupedFeatures = new Map();
                    const idSet = new Set();
                    
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                        const nameLower = rawName.toLowerCase();
                        
                        // ì •í™•í•œ ë§¤ì¹­ ë¨¼ì € ì‹œë„
                        let groupName = reverseMapping[nameLower] || null;
                        
                        // ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [key, value] of Object.entries(reverseMapping)) {
                                if (key.length > 3 && (nameLower.includes(key) || key.includes(nameLower))) {
                                    groupName = value;
                                    break;
                                }
                            }
                        }
                        
                        // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [region, provinces] of Object.entries(turkeyRegionMapping)) {
                                for (const prov of provinces) {
                                    const provLower = prov.toLowerCase();
                                    if (nameLower === provLower || nameLower.includes(provLower) || provLower.includes(nameLower)) {
                                        groupName = region;
                                        break;
                                    }
                                }
                                if (groupName) break;
                            }
                        }
                        
                        // ì§€ì—­ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            const regionNames = Object.keys(turkeyRegionMapping);
                            for (const region of regionNames) {
                                const regionLower = region.toLowerCase();
                                if (nameLower === regionLower || nameLower.includes(regionLower) || regionLower.includes(nameLower)) {
                                    groupName = region;
                                    break;
                                }
                            }
                        }
                        
                        // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬
                        if (!groupName) {
                            console.warn(`[Turkey] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì£¼: "${rawName}" - ê°œë³„ ì£¼ë¡œ ì²˜ë¦¬`);
                            groupName = rawName;
                        }
                        
                        if (!groupedFeatures.has(groupName)) {
                            groupedFeatures.set(groupName, {
                                features: [],
                                totalPopulation: 0,
                                totalArea: 0
                            });
                        }
                        
                        const group = groupedFeatures.get(groupName);
                        group.features.push(feature);
                        group.totalPopulation += (p.population || 0);
                        group.totalArea += (p.area || 0);
                    });
                    
                    // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                    const mergedFeatures = [];
                    
                    groupedFeatures.forEach((group, groupName) => {
                        if (group.features.length === 0) return;
                        
                        // ê°œë³„ ì£¼ì¸ ê²½ìš° (ê·¸ë£¹ëª…ì´ ì›ë³¸ ì£¼ëª…ê³¼ ê°™ì€ ê²½ìš°) - ê·¸ë£¹í™”í•˜ì§€ ì•Šê³  ê°œë³„ë¡œ ì²˜ë¦¬
                        const isIndividualProvince = group.features.length === 1 || 
                                                   !Object.keys(turkeyRegionMapping).includes(groupName);
                        
                        if (isIndividualProvince) {
                            // ê°œë³„ ì£¼ë¡œ ì²˜ë¦¬ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                            group.features.forEach((feature, idx) => {
                                const p = feature.properties || {};
                                const rawName = p.name || p.NAME_1 || p.province || groupName || `Province_${idx}`;
                                
                                if (!feature.geometry || !feature.geometry.coordinates) {
                                    console.warn(`[Turkey] "${rawName}" ì£¼ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                    return;
                                }
                                
                                // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                                let finalId = this.generateRegionIdentifier('turkey', p, mergedFeatures.length);
                                let c = 1;
                                while (idSet.has(finalId)) {
                                    finalId = this.generateRegionIdentifier('turkey', { ...p, index: mergedFeatures.length + c }, mergedFeatures.length + c);
                                    c++;
                                }
                                idSet.add(finalId);
                                
                                mergedFeatures.push({
                                    type: 'Feature',
                                    geometry: feature.geometry,
                                    properties: {
                                        ...p,
                                        id: finalId,
                                        name: rawName,
                                        name_ko: rawName,
                                        name_en: rawName,
                                        country: 'Turkey',
                                        country_code: 'TR',
                                        admin_level: 'Province',
                                        population: p.population || Math.floor(Math.random() * 3000000) + 200000,
                                        area: p.area || Math.floor(Math.random() * 50000) + 5000,
                                        ad_status: 'available',
                                        ad_price: 150000 + (mergedFeatures.length * 5000),
                                        revenue: 0,
                                        company: null,
                                        logo: null,
                                        color: '#ee5a6f',
                                        border_color: '#ffffff',
                                        border_width: 1
                                    }
                                });
                                
                                this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                            });
                            return;
                        }
                        
                        // ê·¸ë£¹í™”ëœ ì§€ì—­ì¸ ê²½ìš° - Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                        const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                        
                        if (geometries.length === 0) {
                            console.warn(`[Turkey] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        let mergedGeometry;
                        if (geometries.length === 1) {
                            mergedGeometry = geometries[0];
                        } else {
                            const allCoordinates = [];
                            geometries.forEach(g => {
                                if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(g.coordinates);
                                } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(...g.coordinates);
                                }
                            });
                            if (allCoordinates.length === 1) {
                                mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                            } else if (allCoordinates.length > 1) {
                                mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                            } else {
                                mergedGeometry = geometries[0];
                            }
                        }
                        
                        // Geometry ê²€ì¦
                        if (!mergedGeometry || !mergedGeometry.coordinates || 
                            (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                            (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                            console.warn(`[Turkey] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                            return;
                        }
                        
                        // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                        let finalId = this.generateRegionIdentifier('turkey', { name: groupName }, mergedFeatures.length);
                        let c = 1;
                        while (idSet.has(finalId)) {
                            finalId = this.generateRegionIdentifier('turkey', { name: groupName, index: mergedFeatures.length + c }, mergedFeatures.length + c);
                            c++;
                        }
                        idSet.add(finalId);
                        
                        // ì§€ì—­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        const regionInfo = turkeyRegionData[groupName] || {};
                        const regionPopulation = regionInfo.population || Math.max(group.totalPopulation, Math.floor(Math.random() * 10000000) + 5000000);
                        const regionArea = regionInfo.area || Math.max(group.totalArea, Math.floor(Math.random() * 100000) + 50000);
                        const regionNameKo = regionInfo.name_ko || groupName;
                        
                        mergedFeatures.push({
                            type: 'Feature',
                            geometry: mergedGeometry,
                            properties: {
                                id: finalId,
                                name: groupName,
                                name_ko: regionNameKo,
                                name_en: groupName,
                                country: 'Turkey',
                                country_code: 'TR',
                                admin_level: 'Region',
                                population: regionPopulation,
                                area: regionArea,
                                ad_status: 'available',
                                ad_price: 150000 + (mergedFeatures.length * 15000),
                                revenue: 0,
                                company: null,
                                logo: null,
                                color: '#ee5a6f',
                                border_color: '#ffffff',
                                border_width: 1,
                                original_count: group.features.length
                            }
                        });
                        
                        // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                    });
                    
                    console.log(`[Turkey] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${data.features.length}ê°œ)`);
                    
                    data = {
                        type: 'FeatureCollection',
                        features: mergedFeatures
                    };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    const idSet = new Set();
                    data.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `TUR_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `tur_province_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'Turkey',
                            country_code: 'TR',
                            admin_level: 'Province',
                            population: p.population || Math.floor(Math.random() * 3000000) + 200000,
                            area: p.area || Math.floor(Math.random() * 50000) + 5000,
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 210000) + 150000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#ee5a6f',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                    });
                }
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ee5a6f'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í„°í‚¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`í„°í‚¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í„°í‚¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í„°í‚¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ (ì§€êµ¬/District ë‹¨ìœ„ - 52ê°œ í–‰ì •êµ¬ì—­)
    async loadSouthAfricaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('south-africa', async () => {
                let data = null;
                // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ 9ê°œ ì£¼ì™€ 52ê°œ ì§€êµ¬ ë§¤í•‘ (2024 ì¶”ì • ì¸êµ¬ ë° ë©´ì )
                const southAfricaProvinceMapping = {
                    'Eastern Cape': {
                        name_ko: 'ì´ìŠ¤í„´ì¼€ì´í”„',
                        population: 6700000,
                        area: 168966,
                        districts: [
                            'Buffalo City', 'Nelson Mandela Bay', 'Sarah Baartman', 'Amathole', 
                            'Chris Hani', 'Joe Gqabi', 'OR Tambo', 'Alfred Nzo'
                        ]
                    },
                    'Free State': {
                        name_ko: 'í”„ë¦¬ìŠ¤í…Œì´íŠ¸',
                        population: 3000000,
                        area: 129825,
                        districts: [
                            'Mangaung', 'Fezile Dabi', 'Lejweleputswa', 'Thabo Mofutsanyana', 'Xhariep'
                        ]
                    },
                    'Gauteng': {
                        name_ko: 'í•˜ìš°í…¡',
                        population: 16500000,
                        area: 18176,
                        districts: [
                            'City of Johannesburg', 'City of Tshwane', 'City of Ekurhuleni', 
                            'West Rand', 'Sedibeng', 'Metsweding'
                        ]
                    },
                    'KwaZulu-Natal': {
                        name_ko: 'ì½°ì¤„ë£¨ë‚˜íƒˆ',
                        population: 12400000,
                        area: 94361,
                        districts: [
                            'eThekwini', 'iLembe', 'Ugu', 'uMgungundlovu', 'uMzinyathi', 
                            'uThukela', 'Amajuba', 'Zululand', 'uMkhanyakude', 'uThungulu', 
                            'King Cetshwayo'
                        ]
                    },
                    'Limpopo': {
                        name_ko: 'ë¦¼í¬í¬',
                        population: 6200000,
                        area: 125754,
                        districts: [
                            'Mopani', 'Vhembe', 'Capricorn', 'Waterberg', 'Sekhukhune'
                        ]
                    },
                    'Mpumalanga': {
                        name_ko: 'ìŒí’€ë§ë‘ê°€',
                        population: 4900000,
                        area: 76495,
                        districts: [
                            'Gert Sibande', 'Nkangala', 'Ehlanzeni'
                        ]
                    },
                    'Northern Cape': {
                        name_ko: 'ë…¸ë˜ì¼€ì´í”„',
                        population: 1400000,
                        area: 372889,
                        districts: [
                            'Namakwa', 'Pixley ka Seme', 'Siyanda', 'Frances Baard', 'Kgalagadi'
                        ]
                    },
                    'North West': {
                        name_ko: 'ë…¸ìŠ¤ì›¨ìŠ¤íŠ¸',
                        population: 4300000,
                        area: 104882,
                        districts: [
                            'Bojanala Platinum', 'Ngaka Modiri Molema', 'Dr Ruth Segomotsi Mompati', 
                            'Dr Kenneth Kaunda'
                        ]
                    },
                    'Western Cape': {
                        name_ko: 'ì›¨ìŠ¤í„´ì¼€ì´í”„',
                        population: 7400000,
                        area: 129462,
                        districts: [
                            'City of Cape Town', 'West Coast', 'Cape Winelands', 'Overberg', 
                            'Garden Route', 'Central Karoo'
                        ]
                    }
                };

                const candidateUrls = [
                    // geoBoundaries ZAF ADM2 (52ê°œ ì§€êµ¬)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ZAF/ADM2/geoBoundaries-ZAF-ADM2.geojson',
                    // geoBoundaries ZAF ADM1 (9ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ZAF/ADM1/geoBoundaries-ZAF-ADM1.geojson',
                    // click_that_hood south-africa
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/south-africa.geojson',
                    // Natural Earth South Africa provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ZAF' || admin === 'South Africa' || iso2 === 'ZA';
                            });
                            if (filtered.length > 0) {
                                console.log(`[South Africa] Filtered Natural Earth/global dataset to South Africa only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = fetchedData;
                            console.log('[South Africa] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 5) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[South Africa] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 5 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[South Africa] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[South Africa] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No South Africa dataset available');
                
                // ì£¼-ì§€êµ¬ ë§¤í•‘ì„ í´ë˜ìŠ¤ì— ì €ì¥
                this.southAfricaProvinceMapping = southAfricaProvinceMapping;
                
                // ì§€êµ¬ ì´ë¦„ì„ ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const districtToProvinceMap = {};
                Object.keys(southAfricaProvinceMapping).forEach(provinceName => {
                    const province = southAfricaProvinceMapping[provinceName];
                    province.districts.forEach(district => {
                        districtToProvinceMap[district.toLowerCase()] = {
                            province: provinceName,
                            province_ko: province.name_ko
                        };
                    });
                });
                
                const idSet = new Set();
                const isDistrictLevel = data.features.length > 40; // ADM2 ë°ì´í„°ì¸ ê²½ìš° (52ê°œ ì§€êµ¬)
                
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_2 || p.NAME_1 || p.province || p.district || `Region_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('south-africa', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('south-africa', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì§€êµ¬ ì´ë¦„ìœ¼ë¡œ ì£¼ ì°¾ê¸°
                    let provinceInfo = null;
                    let provinceData = null;
                    if (isDistrictLevel) {
                        const districtNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (districtToProvinceMap[districtNameLower]) {
                            provinceInfo = districtToProvinceMap[districtNameLower];
                            provinceData = southAfricaProvinceMapping[provinceInfo.province];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [districtKey, provInfo] of Object.entries(districtToProvinceMap)) {
                                if (districtNameLower.includes(districtKey) || districtKey.includes(districtNameLower)) {
                                    provinceInfo = provInfo;
                                    provinceData = southAfricaProvinceMapping[provInfo.province];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!provinceInfo && p.NAME_1) {
                            const provinceName = p.NAME_1;
                            if (southAfricaProvinceMapping[provinceName]) {
                                provinceInfo = {
                                    province: provinceName,
                                    province_ko: southAfricaProvinceMapping[provinceName].name_ko
                                };
                                provinceData = southAfricaProvinceMapping[provinceName];
                            }
                        }
                    } else {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && southAfricaProvinceMapping[p.NAME_1]) {
                            provinceData = southAfricaProvinceMapping[p.NAME_1];
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isDistrictLevel && provinceData) {
                        // ì£¼ì˜ ì´ ì¸êµ¬/ë©´ì ì„ ì§€êµ¬ ìˆ˜ë¡œ ë‚˜ëˆ„ì–´ í‰ê·  ê³„ì‚°
                        const districtCount = provinceData.districts.length;
                        population = p.population || Math.floor(provinceData.population / districtCount);
                        area = p.area || Math.floor(provinceData.area / districtCount);
                    } else if (!isDistrictLevel && provinceData) {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        population = p.population || provinceData.population;
                        area = p.area || provinceData.area;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isDistrictLevel ? 2000000 : 8000000)) + (isDistrictLevel ? 100000 : 500000);
                        area = p.area || Math.floor(Math.random() * (isDistrictLevel ? 50000 : 200000)) + (isDistrictLevel ? 5000 : 30000);
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName,
                        name_en: p.NAME_2 || p.NAME_1 || p.name || rawName,
                        country: 'South Africa',
                        country_code: 'ZA',
                        admin_level: isDistrictLevel ? 'District' : 'Province',
                        province: provinceInfo ? provinceInfo.province : (p.NAME_1 || null),
                        province_ko: provinceInfo ? provinceInfo.province_ko : (southAfricaProvinceMapping[p.NAME_1] ? southAfricaProvinceMapping[p.NAME_1].name_ko : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 220000) + 160000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#f39c12',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displaySouthAfricaGroupedRegions();
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#f39c12'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isDistrictLevel = geoJsonData.features.length > 40;
            const adminType = isDistrictLevel ? 'ì§€êµ¬' : 'ì£¼';
            console.log('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displaySouthAfricaGroupedRegions() {
        if (!this.southAfricaProvinceMapping) {
            console.log('[South Africa] Province mapping not available');
            return;
        }

        console.log('\n=== ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼, 52ê°œ ì§€êµ¬) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ 9ê°œ ì£¼ (Provinces) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(90));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(35) + '| ì§€êµ¬ ìˆ˜ | ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(90));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(this.southAfricaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.southAfricaProvinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} â€“ ${province.name_ko}`.padEnd(33);
            const districts = province.districts.length.toString().padEnd(7);
            const population = province.population.toLocaleString().padEnd(23);
            const area = province.area.toLocaleString();
            console.log(`${seq} | ${name} | ${districts} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(90));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalDistricts = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'South Africa') {
                const province = regionData.province || 'Unknown';
                if (!groupedRegions[province]) {
                    groupedRegions[province] = {
                        name_ko: regionData.province_ko || province,
                        districts: []
                    };
                }
                groupedRegions[province].districts.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalDistricts++;
            }
        });

        // ì£¼ë³„ë¡œ ì¶œë ¥
        Object.keys(this.southAfricaProvinceMapping).forEach(provinceName => {
            const province = this.southAfricaProvinceMapping[provinceName];
            const loadedDistricts = groupedRegions[provinceName] || { districts: [] };
            
            console.log(`\nğŸ“Œ ${provinceName} (${province.name_ko})`);
            console.log(`   ì¸êµ¬: ${province.population.toLocaleString()}ëª… (2024 ì¶”ì •)`);
            console.log(`   ë©´ì : ${province.area.toLocaleString()} ã¢`);
            console.log(`   ì§€êµ¬ ìˆ˜: ì´ ${province.districts.length}ê°œ (ë¡œë“œë¨: ${loadedDistricts.districts.length}ê°œ)`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // ì˜ˆìƒ ì§€êµ¬ ëª©ë¡
            province.districts.forEach((districtName, idx) => {
                const loadedDistrict = loadedDistricts.districts.find(d => 
                    d.name.toLowerCase().includes(districtName.toLowerCase()) ||
                    districtName.toLowerCase().includes(d.name.toLowerCase())
                );
                
                if (loadedDistrict) {
                    console.log(`   ${idx + 1}. ${districtName} âœ“`);
                    console.log(`      â””â”€ ë¡œë“œëœ ì´ë¦„: ${loadedDistrict.name}`);
                    console.log(`      â””â”€ ID: ${loadedDistrict.id}`);
                    console.log(`      â””â”€ ì¸êµ¬: ${loadedDistrict.population.toLocaleString()}ëª…`);
                    console.log(`      â””â”€ ë©´ì : ${loadedDistrict.area.toLocaleString()} kmÂ²`);
                } else {
                    console.log(`   ${idx + 1}. ${districtName} (ë°ì´í„° ì—†ìŒ)`);
                }
            });
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Provinces): ${Object.keys(this.southAfricaProvinceMapping).length}ê°œ`);
        console.log(`   â€¢ ì§€êµ¬ (Districts): ${totalDistricts}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateSouthAfricaGroupedHTML(groupedRegions);
        console.log('%cë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #4ecdc4; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateSouthAfricaGroupedHTML(groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #4ecdc4; margin-top: 0;">ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼, 52ê°œ ì§€êµ¬)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<div style="margin-bottom: 20px; overflow-x: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
        html += '<thead><tr style="background: rgba(78, 205, 196, 0.2);">';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(78, 205, 196, 0.3);">ìˆœë²ˆ</th>';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(78, 205, 196, 0.3);">ì£¼ (ì˜ë¬¸ / í•œê¸€)</th>';
        html += '<th style="padding: 8px; text-align: center; border: 1px solid rgba(78, 205, 196, 0.3);">ì§€êµ¬ ìˆ˜</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.3);">ì¸êµ¬ (ëª…, 2024 ì¶”ì •)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.3);">ë©´ì  (ã¢)</th>';
        html += '</tr></thead><tbody>';
        
        Object.keys(this.southAfricaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.southAfricaProvinceMapping[provinceName];
            html += '<tr style="border-bottom: 1px solid rgba(78, 205, 196, 0.1);">';
            html += `<td style="padding: 8px; border: 1px solid rgba(78, 205, 196, 0.1);">${idx + 1}</td>`;
            html += `<td style="padding: 8px; border: 1px solid rgba(78, 205, 196, 0.1);">${provinceName} â€“ ${province.name_ko}</td>`;
            html += `<td style="padding: 8px; text-align: center; border: 1px solid rgba(78, 205, 196, 0.1);">${province.districts.length}</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.1);">${province.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.1);">${province.area.toLocaleString()}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        
        Object.keys(this.southAfricaProvinceMapping).forEach((provinceName, pIdx) => {
            const province = this.southAfricaProvinceMapping[provinceName];
            const loadedDistricts = groupedRegions[provinceName] || { districts: [] };
            
            html += `<div style="margin-bottom: 20px; padding: 15px; background: rgba(78, 205, 196, 0.1); border-left: 4px solid #4ecdc4; border-radius: 4px;">`;
            html += `<h4 style="color: #feca57; margin: 0 0 10px 0;">${pIdx + 1}. ${provinceName} (${province.name_ko})</h4>`;
            html += `<p style="color: #aaa; margin: 0 0 5px 0; font-size: 12px;">ì¸êµ¬: <span style="color: #4ecdc4;">${province.population.toLocaleString()}ëª…</span> (2024 ì¶”ì •) | ë©´ì : <span style="color: #4ecdc4;">${province.area.toLocaleString()} ã¢</span></p>`;
            html += `<p style="color: #aaa; margin: 0 0 10px 0; font-size: 12px;">ì§€êµ¬ ìˆ˜: ì´ ${province.districts.length}ê°œ (ë¡œë“œë¨: ${loadedDistricts.districts.length}ê°œ)</p>`;
            html += `<ul style="margin: 0; padding-left: 20px; list-style: none;">`;
            
            province.districts.forEach((districtName, dIdx) => {
                const loadedDistrict = loadedDistricts.districts.find(d => 
                    d.name.toLowerCase().includes(districtName.toLowerCase()) ||
                    districtName.toLowerCase().includes(d.name.toLowerCase())
                );
                
                html += `<li style="margin: 5px 0; color: ${loadedDistrict ? '#4ecdc4' : '#666'};">
                    ${dIdx + 1}. ${districtName} ${loadedDistrict ? 'âœ“' : '(ë°ì´í„° ì—†ìŒ)'}
                    ${loadedDistrict ? `<span style="color: #aaa; font-size: 11px;"> - ì¸êµ¬: ${loadedDistrict.population.toLocaleString()}ëª…, ë©´ì : ${loadedDistrict.area.toLocaleString()} kmÂ²</span>` : ''}
                </li>`;
            });
            
            html += `</ul></div>`;
        });
        
        html += '</div>';
        return html;
    }

    // ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ (ì£¼/Provincia ë‹¨ìœ„ - 23ê°œ ì£¼)
    async loadArgentinaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('argentina', async () => {
                let data = null;
                // ì•„ë¥´í—¨í‹°ë‚˜ 23ê°œ ì£¼ ë§¤í•‘ (2024 ì¶”ì • ì¸êµ¬ ë° ë©´ì )
                const argentinaProvinceMapping = {
                    'Buenos Aires': {
                        name_ko: 'ë¶€ì—ë…¸ìŠ¤ì•„ì´ë ˆìŠ¤',
                        population: 17500000,
                        area: 307571
                    },
                    'Catamarca': {
                        name_ko: 'ì¹´íƒ€ë§ˆë¥´ì¹´',
                        population: 430000,
                        area: 102602
                    },
                    'Chaco': {
                        name_ko: 'ì°¨ì½”',
                        population: 1200000,
                        area: 99633
                    },
                    'Chubut': {
                        name_ko: 'ì¶”ë¶€íŠ¸',
                        population: 600000,
                        area: 224686
                    },
                    'CÃ³rdoba': {
                        name_ko: 'ì½”ë¥´ë„ë°”',
                        population: 3800000,
                        area: 165321
                    },
                    'Corrientes': {
                        name_ko: 'ì½”ë¦¬ì—”í…ŒìŠ¤',
                        population: 1300000,
                        area: 88199
                    },
                    'Entre RÃ­os': {
                        name_ko: 'ì—”íŠ¸ë ˆë¦¬ì˜¤ìŠ¤',
                        population: 1400000,
                        area: 78781
                    },
                    'Formosa': {
                        name_ko: 'í¬ë¥´ëª¨ì‚¬',
                        population: 600000,
                        area: 72066
                    },
                    'Jujuy': {
                        name_ko: 'í›„í›„ì´',
                        population: 800000,
                        area: 53219
                    },
                    'La Pampa': {
                        name_ko: 'ë¼íŒœíŒŒ',
                        population: 360000,
                        area: 143440
                    },
                    'La Rioja': {
                        name_ko: 'ë¼ë¦¬ì˜¤í•˜',
                        population: 420000,
                        area: 89680
                    },
                    'Mendoza': {
                        name_ko: 'ë©˜ë„ì‚¬',
                        population: 2000000,
                        area: 148827
                    },
                    'Misiones': {
                        name_ko: 'ë¯¸ì‹œì˜¤ë„¤ìŠ¤',
                        population: 1300000,
                        area: 29801
                    },
                    'NeuquÃ©n': {
                        name_ko: 'ë„¤ìš°ì¼„',
                        population: 700000,
                        area: 94078
                    },
                    'RÃ­o Negro': {
                        name_ko: 'ë¦¬ì˜¤ë„¤ê·¸ë¡œ',
                        population: 750000,
                        area: 203013
                    },
                    'Salta': {
                        name_ko: 'ì‚´íƒ€',
                        population: 1500000,
                        area: 155488
                    },
                    'San Juan': {
                        name_ko: 'ì‚°í›„ì•ˆ',
                        population: 850000,
                        area: 89651
                    },
                    'San Luis': {
                        name_ko: 'ì‚°ë£¨ì´ìŠ¤',
                        population: 550000,
                        area: 76748
                    },
                    'Santa Cruz': {
                        name_ko: 'ì‚°íƒ€í¬ë£¨ìŠ¤',
                        population: 350000,
                        area: 243943
                    },
                    'Santa Fe': {
                        name_ko: 'ì‚°íƒ€í˜',
                        population: 3600000,
                        area: 133007
                    },
                    'Santiago del Estero': {
                        name_ko: 'ì‚°í‹°ì•„ê³ ë¸ì—ìŠ¤í…Œë¡œ',
                        population: 1000000,
                        area: 136351
                    },
                    'Tierra del Fuego': {
                        name_ko: 'í‹°ì—ë¼ë¸í‘¸ì—ê³ ',
                        population: 190000,
                        area: 21263
                    },
                    'TucumÃ¡n': {
                        name_ko: 'íˆ¬ì¿ ë§Œ',
                        population: 1800000,
                        area: 22524
                    }
                };

                const candidateUrls = [
                    // geoBoundaries ARG ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ARG/ADM1/geoBoundaries-ARG-ADM1.geojson',
                    // Natural Earth Argentina provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì•„ë¥´í—¨í‹°ë‚˜ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ARG' || admin === 'Argentina' || iso2 === 'AR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Argentina] Filtered Natural Earth/global dataset to Argentina only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 15) {
                            data = fetchedData;
                            console.log('[Argentina] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 15) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Argentina] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 15 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Argentina] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Argentina] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Argentina dataset available');
                return data;
                
                // ì£¼ ë§¤í•‘ì„ í´ë˜ìŠ¤ì— ì €ì¥
                this.argentinaProvinceMapping = argentinaProvinceMapping;
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('argentina', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('argentina', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ì •ë³´ ì°¾ê¸°
                    let provinceData = null;
                    const provinceName = rawName;
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    if (argentinaProvinceMapping[provinceName]) {
                        provinceData = argentinaProvinceMapping[provinceName];
                    } else {
                        // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                        const provinceNameLower = provinceName.toLowerCase();
                        for (const [key, value] of Object.entries(argentinaProvinceMapping)) {
                            if (key.toLowerCase() === provinceNameLower || 
                                provinceNameLower.includes(key.toLowerCase()) ||
                                key.toLowerCase().includes(provinceNameLower)) {
                                provinceData = value;
                                break;
                            }
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    const population = p.population || (provinceData ? provinceData.population : Math.floor(Math.random() * 4000000) + 300000);
                    const area = p.area || (provinceData ? provinceData.area : Math.floor(Math.random() * 300000) + 50000);
                    const name_ko = provinceData ? provinceData.name_ko : rawName;
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: name_ko,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Argentina',
                        country_code: 'AR',
                        admin_level: 'Province',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 210000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#74b9ff',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayArgentinaGroupedRegions();
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#74b9ff'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì•„ë¥´í—¨í‹°ë‚˜ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displayArgentinaGroupedRegions() {
        if (!this.argentinaProvinceMapping) {
            console.log('[Argentina] Province mapping not available');
            return;
        }

        console.log('\n=== ì•„ë¥´í—¨í‹°ë‚˜ í–‰ì •êµ¬ì—­ (23ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ì•„ë¥´í—¨í‹°ë‚˜ 23ê°œ ì£¼ ì¸êµ¬ ë° ë©´ì  (2024 ì¶”ì •)');
        console.log('â”€'.repeat(90));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(35) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(90));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(this.argentinaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.argentinaProvinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} (${province.name_ko})`.padEnd(33);
            const population = province.population.toLocaleString().padEnd(23);
            const area = province.area.toLocaleString();
            console.log(`${seq} | ${name} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(90));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const loadedProvinces = [];
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Argentina') {
                loadedProvinces.push({
                    name: regionData.name,
                    name_ko: regionData.name_ko,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
            }
        });

        console.log(`\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Provinces): ${Object.keys(this.argentinaProvinceMapping).length}ê°œ`);
        console.log(`   â€¢ ë¡œë“œëœ í–‰ì •êµ¬ì—­: ${loadedProvinces.length}ê°œ`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateArgentinaGroupedHTML(loadedProvinces);
        console.log('%cì•„ë¥´í—¨í‹°ë‚˜ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #74b9ff; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateArgentinaGroupedHTML(loadedProvinces) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #74b9ff; margin-top: 0;">ì•„ë¥´í—¨í‹°ë‚˜ í–‰ì •êµ¬ì—­ (23ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<div style="margin-bottom: 20px; overflow-x: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
        html += '<thead><tr style="background: rgba(116, 185, 255, 0.2);">';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(116, 185, 255, 0.3);">ìˆœë²ˆ</th>';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(116, 185, 255, 0.3);">ì£¼ (ì˜ë¬¸ / í•œê¸€)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.3);">ì¸êµ¬ (ëª…, 2024 ì¶”ì •)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.3);">ë©´ì  (ã¢)</th>';
        html += '</tr></thead><tbody>';
        
        Object.keys(this.argentinaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.argentinaProvinceMapping[provinceName];
            html += '<tr style="border-bottom: 1px solid rgba(116, 185, 255, 0.1);">';
            html += `<td style="padding: 8px; border: 1px solid rgba(116, 185, 255, 0.1);">${idx + 1}</td>`;
            html += `<td style="padding: 8px; border: 1px solid rgba(116, 185, 255, 0.1);">${provinceName} (${province.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.1);">${province.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.1);">${province.area.toLocaleString()}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        html += '</div>';
        return html;
    }

    async loadEuropeanUnionData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('european-union', async () => {
                // EU íšŒì›êµ­ ëª©ë¡ (ì£¼ìš” 27ê°œ íšŒì›êµ­)
                const euCountries = [
                    { code: 'DEU', name: 'Germany', name_ko: 'ë…ì¼' },
                    { code: 'FRA', name: 'France', name_ko: 'í”„ë‘ìŠ¤' },
                    { code: 'ITA', name: 'Italy', name_ko: 'ì´íƒˆë¦¬ì•„' },
                    { code: 'ESP', name: 'Spain', name_ko: 'ìŠ¤í˜ì¸' },
                    { code: 'POL', name: 'Poland', name_ko: 'í´ë€ë“œ' },
                    { code: 'NLD', name: 'Netherlands', name_ko: 'ë„¤ëœë€ë“œ' },
                    { code: 'BEL', name: 'Belgium', name_ko: 'ë²¨ê¸°ì—' },
                    { code: 'GRC', name: 'Greece', name_ko: 'ê·¸ë¦¬ìŠ¤' },
                    { code: 'PRT', name: 'Portugal', name_ko: 'í¬ë¥´íˆ¬ê°ˆ' },
                    { code: 'CZE', name: 'Czech Republic', name_ko: 'ì²´ì½”' },
                    { code: 'HUN', name: 'Hungary', name_ko: 'í—ê°€ë¦¬' },
                    { code: 'SWE', name: 'Sweden', name_ko: 'ìŠ¤ì›¨ë´' },
                    { code: 'AUT', name: 'Austria', name_ko: 'ì˜¤ìŠ¤íŠ¸ë¦¬ì•„' },
                    { code: 'DNK', name: 'Denmark', name_ko: 'ë´ë§ˆí¬' },
                    { code: 'FIN', name: 'Finland', name_ko: 'í•€ë€ë“œ' },
                    { code: 'ROU', name: 'Romania', name_ko: 'ë£¨ë§ˆë‹ˆì•„' },
                    { code: 'BGR', name: 'Bulgaria', name_ko: 'ë¶ˆê°€ë¦¬ì•„' },
                    { code: 'HRV', name: 'Croatia', name_ko: 'í¬ë¡œì•„í‹°ì•„' },
                    { code: 'SVK', name: 'Slovakia', name_ko: 'ìŠ¬ë¡œë°”í‚¤ì•„' },
                    { code: 'IRL', name: 'Ireland', name_ko: 'ì•„ì¼ëœë“œ' },
                    { code: 'LTU', name: 'Lithuania', name_ko: 'ë¦¬íˆ¬ì•„ë‹ˆì•„' },
                    { code: 'SVN', name: 'Slovenia', name_ko: 'ìŠ¬ë¡œë² ë‹ˆì•„' },
                    { code: 'LVA', name: 'Latvia', name_ko: 'ë¼íŠ¸ë¹„ì•„' },
                    { code: 'EST', name: 'Estonia', name_ko: 'ì—ìŠ¤í† ë‹ˆì•„' },
                    { code: 'CYP', name: 'Cyprus', name_ko: 'í‚¤í”„ë¡œìŠ¤' },
                    { code: 'LUX', name: 'Luxembourg', name_ko: 'ë£©ì…ˆë¶€ë¥´í¬' },
                    { code: 'MLT', name: 'Malta', name_ko: 'ëª°íƒ€' }
                ];
                
                const allFeatures = [];
                const idSet = new Set();
                
                // EU êµ­ê°€ ISO ì½”ë“œ ë§¤í•‘ (2ìë¦¬ ì½”ë“œ)
                const iso2Codes = {
                    'DEU': 'DE', 'FRA': 'FR', 'ITA': 'IT', 'ESP': 'ES', 'POL': 'PL',
                    'NLD': 'NL', 'BEL': 'BE', 'GRC': 'GR', 'PRT': 'PT', 'CZE': 'CZ',
                    'HUN': 'HU', 'SWE': 'SE', 'AUT': 'AT', 'DNK': 'DK', 'FIN': 'FI',
                    'ROU': 'RO', 'BGR': 'BG', 'HRV': 'HR', 'SVK': 'SK', 'IRL': 'IE',
                    'LTU': 'LT', 'SVN': 'SI', 'LVA': 'LV', 'EST': 'EE', 'CYP': 'CY',
                    'LUX': 'LU', 'MLT': 'MT'
                };
                
                // ë¨¼ì € ì „ì„¸ê³„ ì§€ë„ í•œ ë²ˆë§Œ ë¡œë“œ ì‹œë„ (ë” íš¨ìœ¨ì )
                let worldData = null;
                try {
                    const worldResp = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson', { cache: 'no-store' });
                    if (worldResp.ok) {
                        worldData = await worldResp.json();
                        console.log('[EU] Loaded world data for filtering');
                    }
                } catch (e) {
                    console.warn('[EU] Failed to load world data:', e.message);
                }
                
                // ê° êµ­ê°€ ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
                const loadPromises = euCountries.map(async (country, index) => {
                    const iso2 = iso2Codes[country.code] || country.code.substring(0, 2);
                    let countryData = null;
                    
                    // ë°©ë²• 1: ì „ì„¸ê³„ ì§€ë„ì—ì„œ í•„í„°ë§ (ê°€ì¥ ì•ˆì •ì )
                    if (worldData && worldData.features) {
                        const filtered = worldData.features.filter(f => {
                            const props = f.properties || {};
                            const name = (props.name || props.NAME || props.NAME_0 || '').toLowerCase();
                            const code = (props.ISO_A2 || props.ISO_A3 || props.ADM0_A3 || props.iso_a2 || props.iso_a3 || '').toUpperCase();
                            const iso2Upper = iso2.toUpperCase();
                            const countryNameLower = country.name.toLowerCase();
                            
                            return name === countryNameLower ||
                                   name.includes(countryNameLower.split(' ')[0]) ||
                                   code === country.code ||
                                   code === iso2Upper ||
                                   (code.length === 2 && code === iso2Upper);
                        });
                        
                        if (filtered.length > 0) {
                            countryData = filtered;
                            console.log(`[EU] Loaded ${country.name} from world data`);
                        }
                    }
                    
                    // ë°©ë²• 2: ê°œë³„ êµ­ê°€ íŒŒì¼ ì‹œë„
                    if (!countryData) {
                        const candidateUrls = [
                            `https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/${country.code}/ADM1/geoBoundaries-${country.code}-ADM1.geojson`
                        ];
                        
                        // ì†Œê·œëª¨ êµ­ê°€ëŠ” johan URL ì œì™¸ (404 ì˜¤ë¥˜ ë°©ì§€)
                        const isSmallCountry = ['MLT', 'LUX', 'CYP'].includes(country.code);
                        if (!isSmallCountry) {
                            candidateUrls.unshift(`https://raw.githubusercontent.com/johan/world.geo.json/master/countries/${iso2.toLowerCase()}.geo.json`);
                        }
                        
                        for (const url of candidateUrls) {
                            try {
                                const resp = await fetch(url, { cache: 'no-store' });
                                if (!resp.ok) {
                                    // 404ëŠ” ì¡°ìš©íˆ ê±´ë„ˆë›°ê¸°
                                    if (resp.status === 404) continue;
                                    throw new Error(`HTTP ${resp.status}`);
                                }
                                const data = await resp.json();
                                
                                if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                                    countryData = data.features;
                                    console.log(`[EU] Loaded ${country.name} from ${url}`);
                                    break;
                                } else if (data && data.type === 'Feature') {
                                    countryData = [data];
                                    console.log(`[EU] Loaded ${country.name} as single feature`);
                                    break;
                                }
                            } catch (e) {
                                // ì˜ˆìƒ ê°€ëŠ¥í•œ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬
                                const isExpected = this.isExpectedError(e);
                                if (!isExpected) {
                                    // ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ë§Œ ë¡œê·¸ (ì¡°ìš©íˆ ì²˜ë¦¬)
                                }
                                continue;
                            }
                        }
                    }
                    
                    // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ êµ­ê°€ ê±´ë„ˆë›°ê¸° (Malta ê°™ì€ ì†Œê·œëª¨ êµ­ê°€ëŠ” ìì£¼ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ)
                    if (!countryData || countryData.length === 0) {
                        // Malta ê°™ì€ ì†Œê·œëª¨ êµ­ê°€ëŠ” ê²½ê³ ë¡œ ì²˜ë¦¬ (ì—ëŸ¬ ì•„ë‹˜)
                        const isSmallCountry = ['MLT', 'LUX', 'CYP'].includes(country.code);
                        if (isSmallCountry) {
                            console.info(`[EU] ${country.name} (${country.code}) ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê±´ë„ˆëœë‹ˆë‹¤.`);
                        } else {
                            console.warn(`[EU] Failed to load ${country.name} (${country.code}), skipping`);
                        }
                        return null;
                    }
                    
                    // ê° featureì— EU ì†ì„± ì¶”ê°€
                    countryData.forEach((feature, featureIndex) => {
                        const p = feature.properties || {};
                        const rawName = p.NAME_0 || p.NAME || p.name || p.NAME_EN || country.name;
                        const baseIdSrc = p.ISO_A3 || p.ISO_A2 || p.ADM0_A3 || country.code || rawName;
                        let baseId = `${baseIdSrc.toString().toLowerCase().replace(/[^a-z0-9]/g, '_')}_eu`;
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: country.name_ko,
                            name_en: country.name,
                            country: 'European Union',
                            country_code: 'EU',
                            eu_member: true,
                            admin_level: 'Country',
                            population: p.population || Math.floor(Math.random() * 10000000) + 1000000,
                            area: p.area || Math.floor(Math.random() * 500000) + 10000,
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 500000) + 200000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#4ecdc4',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        
                        allFeatures.push(feature);
                    });
                    
                    return countryData; // ì„±ê³µì ìœ¼ë¡œ ë¡œë“œëœ ë°ì´í„° ë°˜í™˜
                });
                
                await Promise.all(loadPromises);
                
                // null ê°’ í•„í„°ë§ (ë¡œë“œ ì‹¤íŒ¨í•œ êµ­ê°€ ì œì™¸)
                const validFeatures = allFeatures.filter(f => f !== null && f !== undefined);
                
                const finalGeoJson = {
                    type: 'FeatureCollection',
                    features: validFeatures
                };
                
                if (validFeatures.length === 0) {
                    throw new Error(`EU: No valid features loaded from ${euCountries.length} countries`);
                }
                
                console.log(`[EU] Loaded ${validFeatures.length} features from ${euCountries.length} countries`);
                
                // regionDataì— ì €ì¥ (ìœ íš¨í•œ featuresë§Œ)
                validFeatures.forEach(feature => {
                    if (feature && feature.properties && feature.properties.id) {
                        this.regionData.set(feature.properties.id, feature.properties);
                    }
                });
                
                return finalGeoJson;
            });
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            ['==', ['get', 'ad_status'], 'selected'],
                            '#feca57',
                            '#4ecdc4'
                        ],
                        'fill-opacity': 0.6
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            if (geoJsonData && geoJsonData.features && geoJsonData.features.length > 0) {
                console.log('ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ êµ­ê°€');
                this.showNotification(`ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ êµ­ê°€`, 'info');
                this.updateStatistics();
            } else {
                // ì¼ë¶€ êµ­ê°€ë§Œ ë¡œë“œëœ ê²½ìš° ê²½ê³ ë§Œ í‘œì‹œ
                console.warn('ìœ ëŸ½ì—°í•© ë°ì´í„°: ì¼ë¶€ êµ­ê°€ë§Œ ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.');
                this.showNotification('ìœ ëŸ½ì—°í•© ë°ì´í„° ì¼ë¶€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'warning');
            }
        } catch (error) {
            // Malta ê°™ì€ ì†Œê·œëª¨ êµ­ê°€ ì‹¤íŒ¨ëŠ” ì „ì²´ ì‹¤íŒ¨ë¡œ ì²˜ë¦¬í•˜ì§€ ì•ŠìŒ
            const isMinorError = error.message && error.message.includes('MLT');
            if (isMinorError) {
                console.warn('ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ: ì¼ë¶€ êµ­ê°€(Malta ë“±)ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', error.message);
            } else {
                console.error('ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                this.showNotification('ìœ ëŸ½ì—°í•© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }
    }

    // 15ê°œ ì£¼ìš” ìœ ëŸ½ ê²½ì œêµ­ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤
    async loadEuropeanCountryData(countryCode, countryName, countryNameKo, countryCodeIso, color) {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData[countryCode]) {
                geoJsonData = this.cachedGeoJsonData[countryCode];
            } else {
                // ì—¬ëŸ¬ ë°ì´í„° ì†ŒìŠ¤ ì‹œë„ (í”„ë‘ìŠ¤/ë…ì¼ê³¼ ê°™ì€ ë°©ì‹ - ADM1 í–‰ì •êµ¬ì—­ ë°ì´í„° ìš°ì„ )
                const iso2 = countryCodeIso.substring(0, 2);
                const candidateUrls = [
                    `https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/${countryCodeIso}/ADM1/geoBoundaries-${countryCodeIso}-ADM1.geojson`,
                    `https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson`
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ì „ì„¸ê³„ ë°ì´í„°ì¸ ê²½ìš° í•´ë‹¹ êµ­ê°€ í–‰ì •êµ¬ì—­ë§Œ í•„í„°ë§
                        if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2Code = (p.iso_a2 || '').toUpperCase();
                                return a3 === countryCodeIso || admin === countryName || iso2Code === iso2.toUpperCase();
                            });
                            if (filtered.length > 0) {
                                console.log(`[${countryName}] Filtered Natural Earth/global dataset to ${countryName} only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        // ADM1 ë°ì´í„°ì¸ ê²½ìš° (í–‰ì •êµ¬ì—­ ë ˆë²¨)
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                            // ADM1 ë°ì´í„°ëŠ” ë³´í†µ 5ê°œ ì´ìƒì˜ í–‰ì •êµ¬ì—­ì„ ê°€ì§
                            if (data.features.length >= 1) {
                                geoJsonData = data;
                                console.log(`[${countryName}] Loaded ADM1 from`, url, 'features:', data.features.length);
                                break;
                            }
                        }
                        
                        if (Array.isArray(data.features) && data.features.length > 0) {
                            data = { type: 'FeatureCollection', features: data.features };
                            console.log(`[${countryName}] Loaded (normalized) from`, url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                            data = { type: 'FeatureCollection', features: data };
                            console.log(`[${countryName}] Loaded (array -> FC) from`, url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn(`[${countryName}] Failed loading from`, url, e);
                        }
                    }
                }
                if (!geoJsonData) throw lastError || new Error(`No ${countryName} dataset available`);
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `${countryCodeIso}_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `${countryCode.toLowerCase()}_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: countryName,
                        country_code: countryCodeIso.substring(0, 2),
                        admin_level: 'Region/Province',
                        population: p.population || Math.floor(Math.random() * 5000000) + 100000,
                        area: p.area || Math.floor(Math.random() * 50000) + 1000,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: color,
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData[countryCode] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', color], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ:`, geoJsonData.features.length, 'ê°œ í–‰ì •êµ¬ì—­');
            this.showNotification(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
            this.showNotification(`${countryNameKo} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
        }
    }
    
    normalizeRegionKey(value) {
        if (!value && value !== 0) return '';
        return value.toString()
            .trim()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9\s\-]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    async fetchCountryGeoJson(countryKey, countryName, countryCodeIso, candidateUrls = []) {
        if (!this.rawGeoJsonCache) {
            this.rawGeoJsonCache = {};
        }
        if (this.rawGeoJsonCache[countryKey]) {
            return JSON.parse(JSON.stringify(this.rawGeoJsonCache[countryKey]));
        }

        const iso3 = countryCodeIso.toUpperCase();
        const iso2 = iso3.substring(0, 2).toUpperCase();
        const defaultUrls = [
            `https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/${iso3}/ADM1/geoBoundaries-${iso3}-ADM1.geojson`,
            `https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson`
        ];
        const urls = [...candidateUrls, ...defaultUrls].filter((url, idx, arr) => arr.indexOf(url) === idx);

        let geoJsonData = null;
        let lastError = null;

        for (const url of urls) {
            try {
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();

                if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                    const filtered = data.features.filter((feature) => {
                        const p = feature.properties || {};
                        const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                        const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                        const iso2Code = (p.iso_a2 || '').toUpperCase();
                        return a3 === iso3 || admin === countryName || iso2Code === iso2;
                    });
                    if (filtered.length > 0) {
                        console.log(`[${countryName}] Filtered Natural Earth/global dataset to ${countryName} only: ${filtered.length} features`);
                        geoJsonData = { type: 'FeatureCollection', features: filtered };
                        break;
                    }
                }

                if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                    geoJsonData = data;
                    console.log(`[${countryName}] Loaded from`, url, 'features:', data.features.length);
                    break;
                }
                if (Array.isArray(data.features) && data.features.length > 0) {
                    geoJsonData = { type: 'FeatureCollection', features: data.features };
                    console.log(`[${countryName}] Loaded (normalized) from`, url, 'features:', data.features.length);
                    break;
                }
                if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                    geoJsonData = { type: 'FeatureCollection', features: data };
                    console.log(`[${countryName}] Loaded (array -> FC) from`, url, 'features:', data.length);
                    break;
                }
                lastError = new Error('Invalid data shape');
            } catch (error) {
                lastError = error;
                // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                const isLastUrl = urls.indexOf(url) === urls.length - 1;
                if (!this.isExpectedError(error) || isLastUrl) {
                    console.warn(`[${countryName}] Failed loading from`, url, error);
                }
            }
        }

        if (!geoJsonData) {
            throw lastError || new Error(`No ${countryName} dataset available`);
        }

        this.rawGeoJsonCache[countryKey] = geoJsonData;
        return JSON.parse(JSON.stringify(geoJsonData));
    }

    async loadCustomEuropeanCountry(options) {
        const {
            countryKey,
            countryName,
            countryNameKo,
            countryCodeIso,
            defaultColor = '#27ae60',
            adminLevel = 'Region/Province',
            mapping,
            candidateUrls = [],
            onAfterProcess
        } = options;

        try {
            const geoJsonData = await this.loadGeoJsonWithCache(countryKey, async () => {
                const data = await this.fetchCountryGeoJson(countryKey, countryName, countryCodeIso, candidateUrls);

                const aliasMap = new Map();
                Object.entries(mapping).forEach(([key, meta]) => {
                    const aliases = [
                        key,
                        meta.name_en,
                        meta.name_local,
                        meta.name_native,
                        ...(meta.aliases || [])
                    ];
                    aliases.forEach((alias) => {
                        if (!alias) return;
                        const normalized = this.normalizeRegionKey(alias);
                        if (normalized && !aliasMap.has(normalized)) {
                            aliasMap.set(normalized, key);
                        }
                    });
                });

                const idSet = new Set();
                const iso2 = countryCodeIso.substring(0, 2).toUpperCase();

                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = (p.name || p.NAME_1 || p.NAME || p.NAME_2 || p.admin || `Region_${index}`).toString();
                    const normalizedRaw = this.normalizeRegionKey(rawName);

                    let matchedKey = aliasMap.get(normalizedRaw);
                    if (!matchedKey) {
                        for (const [aliasKey, regionKey] of aliasMap.entries()) {
                            if (!aliasKey) continue;
                            if (normalizedRaw.includes(aliasKey) || aliasKey.includes(normalizedRaw)) {
                                matchedKey = regionKey;
                                break;
                            }
                        }
                    }

                    const meta = matchedKey ? mapping[matchedKey] : null;
                    if (!meta) {
                        console.warn(`[${countryName}] Unmatched region in dataset: ${rawName}`);
                    }

                    const baseIdSrc = p.hasc || p.shapeID || rawName || `${countryCodeIso}_${index}`;
                    let baseId = this.normalizeRegionKey(baseIdSrc).replace(/\s+/g, '_');
                    if (!baseId) baseId = `${countryKey}_region_${index}`;
                    let finalId = baseId;
                    let duplicateIndex = 1;
                    while (idSet.has(finalId)) {
                        finalId = `${baseId}_${duplicateIndex++}`;
                    }
                    idSet.add(finalId);

                    let population = meta?.population ?? (p.population && p.population > 0 ? p.population : 0);
                    let area = meta?.area ?? (p.area && p.area > 0 ? p.area : 0);
                    
                    // ë©´ì ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°
                    if (area <= 0 && feature.geometry) {
                        area = this.calculatePolygonArea(feature);
                        if (area > 0) {
                            console.log(`[${countryNameKo} ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${area.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    const englishName = meta?.name_en || rawName;
                    const localName = meta?.name_local || rawName;

                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: englishName,
                        name_en: englishName,
                        name_local: localName,
                        name_ko: meta?.name_ko || rawName,
                        country: countryName,
                        country_code: iso2,
                        admin_level: meta?.admin_level || adminLevel,
                        population,
                        area,
                        ad_status: 'available',
                        ad_price: meta?.ad_price || Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: meta?.color || defaultColor,
                        border_color: '#ffffff',
                        border_width: 1
                    };

                    if (meta?.extra && typeof meta.extra === 'object') {
                        Object.assign(feature.properties, meta.extra);
                    }

                    this.regionData.set(finalId, feature.properties);
                });

                if (typeof onAfterProcess === 'function') {
                    onAfterProcess(data, mapping);
                }
                
                return data;
            });

            const fillColorExpression = ['case', ['==', ['get', 'ad_status'], 'occupied'], '#ff6b6b', ['coalesce', ['get', 'color'], defaultColor]];

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }

            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': fillColorExpression,
                        'fill-opacity': 0.6
                    }
                });
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            } else {
                this.map.setPaintProperty('regions-fill', 'fill-color', fillColorExpression);
            }

            console.log(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ:`, geoJsonData.features.length, 'ê°œ í–‰ì •êµ¬ì—­');
            this.showNotification(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
            this.showNotification(`${countryNameKo} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
        }
    }

    // ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ (17ê°œ ìì¹˜ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)
    async loadSpainData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('spain', async () => {
                let data = null;
                // ìŠ¤í˜ì¸ 17ê°œ ìì¹˜ì§€ì—­ê³¼ 52ê°œ ì£¼ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const spainAutonomousCommunityMapping = {
                    'AndalucÃ­a': {
                        name_ko: 'ì•ˆë‹¬ë£¨ì‹œì•„',
                        name_en: 'AndalucÃ­a',
                        population: 8600000,
                        area: 87268,
                        provinces: [
                            'AlmerÃ­a', 'CÃ¡diz', 'CÃ³rdoba', 'Granada', 'Huelva', 'JaÃ©n', 'MÃ¡laga', 'Sevilla'
                        ]
                    },
                    'AragÃ³n': {
                        name_ko: 'ì•„ë¼ê³¤',
                        name_en: 'AragÃ³n',
                        population: 1350000,
                        area: 47720,
                        provinces: [
                            'Huesca', 'Zaragoza', 'Teruel'
                        ]
                    },
                    'Asturias': {
                        name_ko: 'ì•„ìŠ¤íˆ¬ë¦¬ì•„ìŠ¤',
                        name_en: 'Asturias',
                        population: 1000000,
                        area: 10603,
                        provinces: [
                            'Asturias', 'Oviedo'
                        ]
                    },
                    'Islas Baleares': {
                        name_ko: 'ë°œë ˆì•„ë ˆìŠ¤ ì œë„',
                        name_en: 'Balearic Islands',
                        population: 1250000,
                        area: 4992,
                        provinces: [
                            'Islas Baleares', 'Balears', 'Palma de Mallorca'
                        ]
                    },
                    'PaÃ­s Vasco': {
                        name_ko: 'ë°”ìŠ¤í¬ ì§€ë°©',
                        name_en: 'Basque Country',
                        population: 2200000,
                        area: 7234,
                        provinces: [
                            'Ãlava', 'Gipuzkoa', 'Bizkaia', 'Vizcaya', 'GuipÃºzcoa'
                        ]
                    },
                    'Islas Canarias': {
                        name_ko: 'ì¹´ë‚˜ë¦¬ì•„ ì œë„',
                        name_en: 'Canary Islands',
                        population: 2250000,
                        area: 7447,
                        provinces: [
                            'Las Palmas', 'Santa Cruz de Tenerife'
                        ]
                    },
                    'Cantabria': {
                        name_ko: 'ì¹¸íƒ€ë¸Œë¦¬ì•„',
                        name_en: 'Cantabria',
                        population: 590000,
                        area: 5321,
                        provinces: [
                            'Cantabria', 'Santander'
                        ]
                    },
                    'Castilla-La Mancha': {
                        name_ko: 'ì¹´ìŠ¤í‹°ì•¼ ë¼ ë§Œì°¨',
                        name_en: 'Castilla-La Mancha',
                        population: 2100000,
                        area: 79463,
                        provinces: [
                            'Albacete', 'Ciudad Real', 'Cuenca', 'Guadalajara', 'Toledo'
                        ]
                    },
                    'Castilla y LeÃ³n': {
                        name_ko: 'ì¹´ìŠ¤í‹°ì•¼ ì´ ë ˆì˜¨',
                        name_en: 'Castilla y LeÃ³n',
                        population: 2350000,
                        area: 94224,
                        provinces: [
                            'Ãvila', 'Burgos', 'LeÃ³n', 'Palencia', 'Salamanca', 'Segovia', 'Soria', 'Valladolid', 'Zamora'
                        ]
                    },
                    'CataluÃ±a': {
                        name_ko: 'ì¹´íƒˆë£¨ëƒ',
                        name_en: 'Catalonia',
                        population: 7900000,
                        area: 32114,
                        provinces: [
                            'Barcelona', 'Girona', 'Lleida', 'Tarragona'
                        ]
                    },
                    'Extremadura': {
                        name_ko: 'ì—ìŠ¤íŠ¸ë ˆë§ˆë‘ë¼',
                        name_en: 'Extremadura',
                        population: 1050000,
                        area: 41634,
                        provinces: [
                            'Badajoz', 'CÃ¡ceres'
                        ]
                    },
                    'Galicia': {
                        name_ko: 'ê°ˆë¦¬ì‹œì•„',
                        name_en: 'Galicia',
                        population: 2700000,
                        area: 29574,
                        provinces: [
                            'A CoruÃ±a', 'Lugo', 'Ourense', 'Pontevedra'
                        ]
                    },
                    'Madrid': {
                        name_ko: 'ë§ˆë“œë¦¬ë“œ',
                        name_en: 'Madrid',
                        population: 6900000,
                        area: 8028,
                        provinces: [
                            'Madrid'
                        ]
                    },
                    'Murcia': {
                        name_ko: 'ë¬´ë¥´ì‹œì•„',
                        name_en: 'Murcia',
                        population: 1600000,
                        area: 11313,
                        provinces: [
                            'Murcia'
                        ]
                    },
                    'Navarra': {
                        name_ko: 'ë‚˜ë°”ë¼',
                        name_en: 'Navarre',
                        population: 690000,
                        area: 10391,
                        provinces: [
                            'Navarra', 'Navarre', 'Pamplona'
                        ]
                    },
                    'La Rioja': {
                        name_ko: 'ë¼ë¦¬ì˜¤í•˜',
                        name_en: 'La Rioja',
                        population: 320000,
                        area: 5045,
                        provinces: [
                            'La Rioja', 'LogroÃ±o'
                        ]
                    },
                    'Comunidad Valenciana': {
                        name_ko: 'ë°œë Œì‹œì•„ ê³µë™ì²´',
                        name_en: 'Valencian Community',
                        population: 5200000,
                        area: 23255,
                        provinces: [
                            'Alicante', 'CastellÃ³n', 'Valencia'
                        ]
                    }
                };

                const candidateUrls = [
                    // geoBoundaries ESP ADM1 (17ê°œ ìì¹˜ì§€ì—­ ë˜ëŠ” 50ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ESP/ADM1/geoBoundaries-ESP-ADM1.geojson',
                    // geoBoundaries ESP ADM2 (52ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ESP/ADM2/geoBoundaries-ESP-ADM2.geojson',
                    // Natural Earth Spain provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ìŠ¤í˜ì¸ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ESP' || admin === 'Spain' || iso2 === 'ES';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Spain] Filtered Natural Earth/global dataset to Spain only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = fetchedData;
                            console.log('[Spain] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Spain] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 1 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Spain] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Spain] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Spain dataset available');
                
                // ìì¹˜ì§€ì—­-ì£¼ ë§¤í•‘ì„ í´ë˜ìŠ¤ì— ì €ì¥
                this.spainAutonomousCommunityMapping = spainAutonomousCommunityMapping;
                
                // ì£¼ ì´ë¦„ì„ ìì¹˜ì§€ì—­ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const provinceToCommunityMap = {};
                Object.keys(spainAutonomousCommunityMapping).forEach(communityName => {
                    const community = spainAutonomousCommunityMapping[communityName];
                    community.provinces.forEach(province => {
                        provinceToCommunityMap[province.toLowerCase()] = {
                            community: communityName,
                            community_ko: community.name_ko,
                            community_en: community.name_en
                        };
                    });
                });
                
                const idSet = new Set();
                const isProvinceLevel = data.features.length > 40; // ADM2 ë°ì´í„°ì¸ ê²½ìš° (52ê°œ ì£¼)
                
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME_2 || p.province || `Region_${index}`;
                    
                    // generateRegionIdentifierë¥¼ ì‚¬ìš©í•˜ì—¬ ì¼ê´€ëœ ID í˜•ì‹ ìƒì„±
                    let finalId = this.generateRegionIdentifier('spain', p, index);
                    let c = 1;
                    while (idSet.has(finalId)) {
                        finalId = this.generateRegionIdentifier('spain', { ...p, index: index + c }, index + c);
                        c++;
                    }
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ìì¹˜ì§€ì—­ ì°¾ê¸°
                    let communityInfo = null;
                    let communityData = null;
                    if (isProvinceLevel) {
                        const provinceNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (provinceToCommunityMap[provinceNameLower]) {
                            communityInfo = provinceToCommunityMap[provinceNameLower];
                            communityData = spainAutonomousCommunityMapping[communityInfo.community];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [provinceKey, commInfo] of Object.entries(provinceToCommunityMap)) {
                                if (provinceNameLower.includes(provinceKey) || provinceKey.includes(provinceNameLower)) {
                                    communityInfo = commInfo;
                                    communityData = spainAutonomousCommunityMapping[commInfo.community];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ ìì¹˜ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!communityInfo && p.NAME_1) {
                            const communityName = p.NAME_1;
                            if (spainAutonomousCommunityMapping[communityName]) {
                                communityInfo = {
                                    community: communityName,
                                    community_ko: spainAutonomousCommunityMapping[communityName].name_ko,
                                    community_en: spainAutonomousCommunityMapping[communityName].name_en
                                };
                                communityData = spainAutonomousCommunityMapping[communityName];
                            }
                        }
                    } else {
                        // ìì¹˜ì§€ì—­ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && spainAutonomousCommunityMapping[p.NAME_1]) {
                            communityData = spainAutonomousCommunityMapping[p.NAME_1];
                        }
                    }
                    
                    // ìì¹˜ì§€ì—­ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isProvinceLevel && communityData) {
                        // ìì¹˜ì§€ì—­ì˜ ì´ ì¸êµ¬/ë©´ì ì„ ì£¼ ìˆ˜ë¡œ ë‚˜ëˆ„ì–´ í‰ê·  ê³„ì‚°
                        const provinceCount = communityData.provinces.length;
                        population = p.population && p.population > 0 ? p.population : Math.floor(communityData.population / provinceCount);
                        area = p.area && p.area > 0 ? p.area : Math.floor(communityData.area / provinceCount);
                    } else if (!isProvinceLevel && communityData) {
                        // ìì¹˜ì§€ì—­ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        population = p.population && p.population > 0 ? p.population : communityData.population;
                        area = p.area && p.area > 0 ? p.area : communityData.area;
                    } else {
                        // ê¸°ë³¸ê°’ (ëœë¤ ê°’ ì œê±°, 0ìœ¼ë¡œ ì„¤ì •)
                        population = p.population && p.population > 0 ? p.population : 0;
                        area = p.area && p.area > 0 ? p.area : 0;
                    }
                    
                    // ë©´ì ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°
                    if (area <= 0 && feature.geometry) {
                        area = this.calculatePolygonArea(feature);
                        if (area > 0) {
                            console.log(`[ìŠ¤í˜ì¸ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${area.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: communityInfo ? communityInfo.community_ko : (communityData ? communityData.name_ko : rawName),
                        name_en: communityInfo ? communityInfo.community_en : (communityData ? communityData.name_en : (p.NAME_1 || p.name || rawName)),
                        country: 'Spain',
                        country_code: 'ES',
                        admin_level: isProvinceLevel ? 'Province' : 'Autonomous Community',
                        autonomous_community: communityInfo ? communityInfo.community : (p.NAME_1 || null),
                        autonomous_community_ko: communityInfo ? communityInfo.community_ko : (communityData ? communityData.name_ko : null),
                        autonomous_community_en: communityInfo ? communityInfo.community_en : (communityData ? communityData.name_en : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#e74c3c',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    // regionData ì €ì¥ì€ loadGeoJsonWithCache ë°˜í™˜ ì´í›„ë¡œ ì´ë™ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
                });
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displaySpainGroupedRegions();
                
                return data;
            });

            // loadGeoJsonWithCache ë°˜í™˜ ì´í›„ì— regionData ì €ì¥ (ensureRegionIdentifiers ì´í›„ì˜ ìµœì¢… ID ì‚¬ìš©)
            this.saveRegionDataFromGeoJson(geoJsonData);

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#e74c3c'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isProvinceLevel = geoJsonData.features.length > 40;
            const adminType = isProvinceLevel ? 'ì£¼' : 'ìì¹˜ì§€ì—­';
            console.log('ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (17ê°œ ìì¹˜ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìŠ¤í˜ì¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìŠ¤í˜ì¸ ìì¹˜ì§€ì—­ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displaySpainGroupedRegions() {
        if (!this.spainAutonomousCommunityMapping) {
            console.log('[Spain] Autonomous community mapping not available');
            return;
        }

        console.log('\n=== ìŠ¤í˜ì¸ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (17ê°œ ìì¹˜ì§€ì—­, 52ê°œ ì£¼) ===\n');
        
        // ìì¹˜ì§€ì—­ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ìŠ¤í˜ì¸ 17ê°œ ìì¹˜ì§€ì—­ (Comunidades AutÃ³nomas) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | ìì¹˜ì§€ì—­ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì£¼ ìˆ˜ | ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(95));
        
        // ìì¹˜ì§€ì—­ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(this.spainAutonomousCommunityMapping).forEach((communityName, idx) => {
            const community = this.spainAutonomousCommunityMapping[communityName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${communityName} (${community.name_ko})`.padEnd(38);
            const provinces = community.provinces.length.toString().padEnd(5);
            const population = community.population.toLocaleString().padEnd(23);
            const area = community.area.toLocaleString();
            console.log(`${seq} | ${name} | ${provinces} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalProvinces = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Spain') {
                const community = regionData.autonomous_community || 'Unknown';
                if (!groupedRegions[community]) {
                    groupedRegions[community] = {
                        name_ko: regionData.autonomous_community_ko || community,
                        name_en: regionData.autonomous_community_en || community,
                        provinces: []
                    };
                }
                groupedRegions[community].provinces.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalProvinces++;
            }
        });

        // ìì¹˜ì§€ì—­ë³„ë¡œ ì¶œë ¥
        Object.keys(this.spainAutonomousCommunityMapping).forEach(communityName => {
            const community = this.spainAutonomousCommunityMapping[communityName];
            const loadedProvinces = groupedRegions[communityName] || { provinces: [] };
            
            console.log(`\nğŸ“Œ ${communityName} (${community.name_ko})`);
            console.log(`   ì¸êµ¬: ${community.population.toLocaleString()}ëª… (2024 ì¶”ì •)`);
            console.log(`   ë©´ì : ${community.area.toLocaleString()} ã¢`);
            console.log(`   ì£¼ ìˆ˜: ì´ ${community.provinces.length}ê°œ (ë¡œë“œë¨: ${loadedProvinces.provinces.length}ê°œ)`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // ì˜ˆìƒ ì£¼ ëª©ë¡
            community.provinces.forEach((provinceName, idx) => {
                const loadedProvince = loadedProvinces.provinces.find(p => 
                    p.name.toLowerCase().includes(provinceName.toLowerCase()) ||
                    provinceName.toLowerCase().includes(p.name.toLowerCase())
                );
                
                if (loadedProvince) {
                    console.log(`   ${idx + 1}. ${provinceName} âœ“`);
                    console.log(`      â””â”€ ë¡œë“œëœ ì´ë¦„: ${loadedProvince.name}`);
                    console.log(`      â””â”€ ID: ${loadedProvince.id}`);
                    console.log(`      â””â”€ ì¸êµ¬: ${loadedProvince.population.toLocaleString()}ëª…`);
                    console.log(`      â””â”€ ë©´ì : ${loadedProvince.area.toLocaleString()} kmÂ²`);
                } else {
                    console.log(`   ${idx + 1}. ${provinceName} (ë°ì´í„° ì—†ìŒ)`);
                }
            });
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ìì¹˜ì§€ì—­ (Comunidades AutÃ³nomas): ${Object.keys(this.spainAutonomousCommunityMapping).length}ê°œ`);
        console.log(`   â€¢ ì£¼ (Provincias): ${totalProvinces}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateSpainGroupedHTML(groupedRegions);
        console.log('%cìŠ¤í˜ì¸ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateSpainGroupedHTML(groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #e74c3c; margin-top: 0;">ìŠ¤í˜ì¸ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (17ê°œ ìì¹˜ì§€ì—­, 52ê°œ ì£¼)</h3>';
        
        // ìì¹˜ì§€ì—­ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ìì¹˜ì§€ì—­</th><th style="padding: 8px; text-align: right;">ì£¼ ìˆ˜</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(this.spainAutonomousCommunityMapping).forEach((communityName, idx) => {
            const community = this.spainAutonomousCommunityMapping[communityName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${communityName} (${community.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right;">${community.provinces.length}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${community.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${community.area.toLocaleString()}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ (12ê°œ ì£¼)
    async loadNetherlandsData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('netherlands', async () => {
                let data = null;
                // ë„¤ëœë€ë“œ 12ê°œ ì£¼ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const netherlandsProvinceMapping = {
                    'Drenthe': {
                        name_ko: 'ë“œë Œí„°',
                        name_nl: 'Drenthe',
                        population: 503000,
                        area: 2680
                    },
                    'Friesland': {
                        name_ko: 'í”„ë¦¬ìŠ¬ë€íŠ¸',
                        name_nl: 'Friesland',
                        population: 650000,
                        area: 5741
                    },
                    'Gelderland': {
                        name_ko: 'í—¬ë°ë¥¼ë€íŠ¸',
                        name_nl: 'Gelderland',
                        population: 2100000,
                        area: 5136
                    },
                    'Groningen': {
                        name_ko: 'íë¡œë‹ì–¸',
                        name_nl: 'Groningen',
                        population: 600000,
                        area: 2960
                    },
                    'Limburg': {
                        name_ko: 'ë¦¼ë·”ë¥´í',
                        name_nl: 'Limburg',
                        population: 1130000,
                        area: 2209
                    },
                    'Noord-Brabant': {
                        name_ko: 'ë…¸ë¥´íŠ¸ë¸Œë¼ë°˜íŠ¸',
                        name_nl: 'Noord-Brabant',
                        population: 2600000,
                        area: 5082
                    },
                    'Noord-Holland': {
                        name_ko: 'ë…¸ë¥´íŠ¸í™€ë€íŠ¸',
                        name_nl: 'Noord-Holland',
                        population: 2950000,
                        area: 2662
                    },
                    'Overijssel': {
                        name_ko: 'ì˜¤ë²„ë ˆì´ì„¤',
                        name_nl: 'Overijssel',
                        population: 1200000,
                        area: 3420
                    },
                    'Utrecht': {
                        name_ko: 'ìœ„íŠ¸ë ˆííŠ¸',
                        name_nl: 'Utrecht',
                        population: 1400000,
                        area: 1560
                    },
                    'Zeeland': {
                        name_ko: 'ì œì¼ë€íŠ¸',
                        name_nl: 'Zeeland',
                        population: 390000,
                        area: 1788
                    },
                    'Zuid-Holland': {
                        name_ko: 'ììœ„íŠ¸í™€ë€íŠ¸',
                        name_nl: 'Zuid-Holland',
                        population: 3800000,
                        area: 2872
                    },
                    'Flevoland': {
                        name_ko: 'í”Œë ˆë³¼ë€íŠ¸',
                        name_nl: 'Flevoland',
                        population: 450000,
                        area: 2412
                    }
                };

                const candidateUrls = [
                    // geoBoundaries NLD ADM1 (12ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/NLD/ADM1/geoBoundaries-NLD-ADM1.geojson',
                    // Natural Earth Netherlands provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë„¤ëœë€ë“œë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'NLD' || admin === 'Netherlands' || iso2 === 'NL';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Netherlands] Filtered Natural Earth/global dataset to Netherlands only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = fetchedData;
                            console.log('[Netherlands] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Netherlands] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 1 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Netherlands] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Netherlands] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Netherlands dataset available');
                return data;
                
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `NLD_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `nld_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ë°ì´í„° ì°¾ê¸°
                    let provinceData = null;
                    const provinceNameLower = rawName.toLowerCase();
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    for (const [provinceKey, provinceInfo] of Object.entries(netherlandsProvinceMapping)) {
                        if (provinceNameLower === provinceKey.toLowerCase() || 
                            provinceNameLower === provinceInfo.name_nl.toLowerCase()) {
                            provinceData = { key: provinceKey, ...provinceInfo };
                            break;
                        }
                    }
                    
                    // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                    if (!provinceData) {
                        for (const [provinceKey, provinceInfo] of Object.entries(netherlandsProvinceMapping)) {
                            if (provinceNameLower.includes(provinceKey.toLowerCase()) || 
                                provinceKey.toLowerCase().includes(provinceNameLower) ||
                                provinceNameLower.includes(provinceInfo.name_nl.toLowerCase()) ||
                                provinceInfo.name_nl.toLowerCase().includes(provinceNameLower)) {
                                provinceData = { key: provinceKey, ...provinceInfo };
                                break;
                            }
                        }
                    }
                    
                    // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!provinceData && p.NAME_1) {
                        const provinceName = p.NAME_1;
                        if (netherlandsProvinceMapping[provinceName]) {
                            provinceData = { key: provinceName, ...netherlandsProvinceMapping[provinceName] };
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    let population = provinceData ? provinceData.population : (p.population && p.population > 0 ? p.population : 0);
                    let area = provinceData ? provinceData.area : (p.area && p.area > 0 ? p.area : 0);
                    
                    // ë©´ì ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°
                    if (area <= 0 && feature.geometry) {
                        area = this.calculatePolygonArea(feature);
                        if (area > 0) {
                            console.log(`[ë„¤ëœë€ë“œ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${area.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceData ? provinceData.name_ko : rawName,
                        name_en: provinceData ? provinceData.name_nl : (p.NAME_1 || p.name || rawName),
                        country: 'Netherlands',
                        country_code: 'NL',
                        admin_level: 'Province',
                        province: provinceData ? provinceData.key : rawName,
                        province_ko: provinceData ? provinceData.name_ko : null,
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ff9f43',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayNetherlandsGroupedRegions(netherlandsProvinceMapping);
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ff9f43'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì£¼`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë„¤ëœë€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë„¤ëœë€ë“œ ì£¼ ëª©ë¡ í‘œì‹œ
    displayNetherlandsGroupedRegions(provinceMapping) {
        console.log('\n=== ë„¤ëœë€ë“œ í–‰ì •êµ¬ì—­ (12ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ë„¤ëœë€ë“œ 12ê°œ ì£¼ (Provinces) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(95));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(provinceMapping).forEach((provinceName, idx) => {
            const province = provinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} (${province.name_ko})`.padEnd(38);
            const population = province.population.toLocaleString().padEnd(23);
            const area = province.area.toLocaleString();
            console.log(`${seq} | ${name} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const loadedProvinces = [];
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Netherlands') {
                loadedProvinces.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    name_ko: regionData.name_ko,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
            }
        });

        console.log(`\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Provinces): ${Object.keys(provinceMapping).length}ê°œ`);
        console.log(`   â€¢ ë¡œë“œëœ ì£¼: ${loadedProvinces.length}ê°œ`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateNetherlandsGroupedHTML(provinceMapping, loadedProvinces);
        console.log('%cë„¤ëœë€ë“œ í–‰ì •êµ¬ì—­', 'color: #ff9f43; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateNetherlandsGroupedHTML(provinceMapping, loadedProvinces) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #ff9f43; margin-top: 0;">ë„¤ëœë€ë“œ í–‰ì •êµ¬ì—­ (12ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(provinceMapping).forEach((provinceName, idx) => {
            const province = provinceMapping[provinceName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${provinceName} (${province.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right;">${province.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${province.area.toLocaleString()}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // í´ë€ë“œ ë°ì´í„° ë¡œë“œ (16ê°œ ì£¼)
    async loadPolandData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('poland', async () => {
                let data = null;
                // í´ë€ë“œ 16ê°œ ì£¼ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const polandVoivodeshipMapping = {
                    'Wielkopolskie': {
                        name_ko: 'ê·¸ë ˆì´í„°í´ë€ë“œ',
                        name_en: 'Greater Poland',
                        name_pl: 'Wielkopolskie',
                        population: 3470000,
                        area: 29826
                    },
                    'Kujawsko-Pomorskie': {
                        name_ko: 'ì¿ ì•¼ë¹„ì•ˆí¬ëª¨ì œ',
                        name_en: 'Kuyavian-Pomeranian',
                        name_pl: 'Kujawsko-Pomorskie',
                        population: 2030000,
                        area: 17972
                    },
                    'MaÅ‚opolskie': {
                        name_ko: 'ë ˆì„œí´ë€ë“œ',
                        name_en: 'Lesser Poland',
                        name_pl: 'MaÅ‚opolskie',
                        population: 3430000,
                        area: 15190
                    },
                    'ÅÃ³dzkie': {
                        name_ko: 'ìš°ì¹˜',
                        name_en: 'ÅÃ³dÅº',
                        name_pl: 'ÅÃ³dzkie',
                        population: 2360000,
                        area: 18219
                    },
                    'DolnoÅ›lÄ…skie': {
                        name_ko: 'ë¡œì›Œì‹¤ë ˆì‹œì•„',
                        name_en: 'Lower Silesian',
                        name_pl: 'DolnoÅ›lÄ…skie',
                        population: 2850000,
                        area: 19947
                    },
                    'Lubelskie': {
                        name_ko: 'ë£¨ë¸”ë¦°',
                        name_en: 'Lublin',
                        name_pl: 'Lubelskie',
                        population: 2070000,
                        area: 25122
                    },
                    'Lubuskie': {
                        name_ko: 'ë£¨ë¶€ì‹œ',
                        name_en: 'Lubusz',
                        name_pl: 'Lubuskie',
                        population: 1020000,
                        area: 13987
                    },
                    'Mazowieckie': {
                        name_ko: 'ë§ˆì¡°ë¹„ì•„',
                        name_en: 'Masovian',
                        name_pl: 'Mazowieckie',
                        population: 5500000,
                        area: 35558
                    },
                    'Opolskie': {
                        name_ko: 'ì˜¤í´ë ˆ',
                        name_en: 'Opole',
                        name_pl: 'Opolskie',
                        population: 960000,
                        area: 9412
                    },
                    'Podlaskie': {
                        name_ko: 'í¬ë“¤ë¼ìŠ¤í‚¤ì—',
                        name_en: 'Podlaskie',
                        name_pl: 'Podlaskie',
                        population: 1140000,
                        area: 20187
                    },
                    'Pomorskie': {
                        name_ko: 'í¬ë©”ë¼ë‹ˆì•ˆ',
                        name_en: 'Pomeranian',
                        name_pl: 'Pomorskie',
                        population: 2450000,
                        area: 18310
                    },
                    'ÅšlÄ…skie': {
                        name_ko: 'ì‹¤ë ˆì‹œì•„',
                        name_en: 'Silesian',
                        name_pl: 'ÅšlÄ…skie',
                        population: 4440000,
                        area: 12333
                    },
                    'Podkarpackie': {
                        name_ko: 'ì„œë¸Œì¹´ë¥´íŒŒí‹°ì•„',
                        name_en: 'Subcarpathian',
                        name_pl: 'Podkarpackie',
                        population: 2110000,
                        area: 17846
                    },
                    'ÅšwiÄ™tokrzyskie': {
                        name_ko: 'ì‹œë¹„ì—¥í† í¬ì‹œìŠ¤í‚¤ì—',
                        name_en: 'ÅšwiÄ™tokrzyskie',
                        name_pl: 'ÅšwiÄ™tokrzyskie',
                        population: 1140000,
                        area: 11672
                    },
                    'WarmiÅ„sko-Mazurskie': {
                        name_ko: 'ë°”ë¥´ë¯¸ì•„ë§ˆì£¼ë¦¬',
                        name_en: 'Warmian-Masurian',
                        name_pl: 'WarmiÅ„sko-Mazurskie',
                        population: 1370000,
                        area: 24173
                    },
                    'Zachodniopomorskie': {
                        name_ko: 'ì„œí¬ë©”ë¼ë‹ˆì•ˆ',
                        name_en: 'West Pomeranian',
                        name_pl: 'Zachodniopomorskie',
                        population: 1660000,
                        area: 22892
                    }
                };

                const candidateUrls = [
                    // geoBoundaries POL ADM1 (16ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/POL/ADM1/geoBoundaries-POL-ADM1.geojson',
                    // Natural Earth Poland voivodeships
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í´ë€ë“œë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'POL' || admin === 'Poland' || iso2 === 'PL';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Poland] Filtered Natural Earth/global dataset to Poland only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = fetchedData;
                            console.log('[Poland] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Poland] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 1 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Poland] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Poland] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Poland dataset available');
                
                const idSet = new Set();
                
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.voivodeship || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `POL_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `pol_voivodeship_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ë°ì´í„° ì°¾ê¸°
                    let voivodeshipData = null;
                    const voivodeshipNameLower = rawName.toLowerCase();
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    for (const [voivodeshipKey, voivodeshipInfo] of Object.entries(polandVoivodeshipMapping)) {
                        if (voivodeshipNameLower === voivodeshipKey.toLowerCase() || 
                            voivodeshipNameLower === voivodeshipInfo.name_pl.toLowerCase() ||
                            voivodeshipNameLower === voivodeshipInfo.name_en.toLowerCase()) {
                            voivodeshipData = { key: voivodeshipKey, ...voivodeshipInfo };
                            break;
                        }
                    }
                    
                    // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                    if (!voivodeshipData) {
                        for (const [voivodeshipKey, voivodeshipInfo] of Object.entries(polandVoivodeshipMapping)) {
                            if (voivodeshipNameLower.includes(voivodeshipKey.toLowerCase()) || 
                                voivodeshipKey.toLowerCase().includes(voivodeshipNameLower) ||
                                voivodeshipNameLower.includes(voivodeshipInfo.name_pl.toLowerCase()) ||
                                voivodeshipInfo.name_pl.toLowerCase().includes(voivodeshipNameLower) ||
                                voivodeshipNameLower.includes(voivodeshipInfo.name_en.toLowerCase()) ||
                                voivodeshipInfo.name_en.toLowerCase().includes(voivodeshipNameLower)) {
                                voivodeshipData = { key: voivodeshipKey, ...voivodeshipInfo };
                                break;
                            }
                        }
                    }
                    
                    // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!voivodeshipData && p.NAME_1) {
                        const voivodeshipName = p.NAME_1;
                        if (polandVoivodeshipMapping[voivodeshipName]) {
                            voivodeshipData = { key: voivodeshipName, ...polandVoivodeshipMapping[voivodeshipName] };
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    let population = voivodeshipData ? voivodeshipData.population : (p.population && p.population > 0 ? p.population : 0);
                    let area = voivodeshipData ? voivodeshipData.area : (p.area && p.area > 0 ? p.area : 0);
                    
                    // ë©´ì ì´ ì—†ê±°ë‚˜ 0ì´ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°
                    if (area <= 0 && feature.geometry) {
                        area = this.calculatePolygonArea(feature);
                        if (area > 0) {
                            console.log(`[í´ë€ë“œ ë©´ì  ê³„ì‚°] ${rawName} (${finalId}): ${area.toFixed(2)} kmÂ²`);
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: voivodeshipData ? voivodeshipData.name_ko : rawName,
                        name_en: voivodeshipData ? voivodeshipData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Poland',
                        country_code: 'PL',
                        admin_level: 'Voivodeship',
                        voivodeship: voivodeshipData ? voivodeshipData.key : rawName,
                        voivodeship_ko: voivodeshipData ? voivodeshipData.name_ko : null,
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#feca57',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayPolandGroupedRegions(polandVoivodeshipMapping);
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#feca57'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í´ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`í´ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì£¼`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í´ë€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í´ë€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í´ë€ë“œ ì£¼ ëª©ë¡ í‘œì‹œ
    displayPolandGroupedRegions(voivodeshipMapping) {
        console.log('\n=== í´ë€ë“œ í–‰ì •êµ¬ì—­ (16ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š í´ë€ë“œ 16ê°œ ì£¼ (Voivodeships) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(100));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(45) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(100));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(voivodeshipMapping).forEach((voivodeshipName, idx) => {
            const voivodeship = voivodeshipMapping[voivodeshipName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${voivodeship.name_en} (${voivodeship.name_ko})`.padEnd(43);
            const population = voivodeship.population.toLocaleString().padEnd(23);
            const area = voivodeship.area.toLocaleString();
            console.log(`${seq} | ${name} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(100));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const loadedVoivodeships = [];
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Poland') {
                loadedVoivodeships.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    name_ko: regionData.name_ko,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
            }
        });

        console.log(`\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Voivodeships): ${Object.keys(voivodeshipMapping).length}ê°œ`);
        console.log(`   â€¢ ë¡œë“œëœ ì£¼: ${loadedVoivodeships.length}ê°œ`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generatePolandGroupedHTML(voivodeshipMapping, loadedVoivodeships);
        console.log('%cí´ë€ë“œ í–‰ì •êµ¬ì—­', 'color: #feca57; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generatePolandGroupedHTML(voivodeshipMapping, loadedVoivodeships) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #feca57; margin-top: 0;">í´ë€ë“œ í–‰ì •êµ¬ì—­ (16ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(voivodeshipMapping).forEach((voivodeshipName, idx) => {
            const voivodeship = voivodeshipMapping[voivodeshipName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${voivodeship.name_en} (${voivodeship.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right;">${voivodeship.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${voivodeship.area.toLocaleString()}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­)
    async loadBelgiumData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('belgium', async () => {
                let data = null;
                // ë²¨ê¸°ì— 10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const belgiumProvinceMapping = {
                    // í”Œë‘ë“œë¥´ ì§€ì—­
                    'Antwerpen': {
                        name_ko: 'ì•ˆíŠ¸ë² ë¥´íœ',
                        name_en: 'Antwerpen',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1940000,
                        area: 2876
                    },
                    'Limburg': {
                        name_ko: 'ë¦¼ë·”ë¥´í',
                        name_en: 'Limburg',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 900000,
                        area: 2427
                    },
                    'Oost-Vlaanderen': {
                        name_ko: 'ì˜¤ìŠ¤íŠ¸í”Œë€ë°ëŸ°',
                        name_en: 'East Flanders',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1540000,
                        area: 2982
                    },
                    'Vlaams-Brabant': {
                        name_ko: 'í”ŒëŒìŠ¤ë¸Œë¼ë°˜íŠ¸',
                        name_en: 'Flemish Brabant',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1200000,
                        area: 2106
                    },
                    'West-Vlaanderen': {
                        name_ko: 'ë² ìŠ¤íŠ¸í”Œë€ë°ëŸ°',
                        name_en: 'West Flanders',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1210000,
                        area: 3125
                    },
                    // ì™ˆë¡± ì§€ì—­
                    'Brabant Wallon': {
                        name_ko: 'ë¸Œë¼ë°©ì™ˆë¡±',
                        name_en: 'Walloon Brabant',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 420000,
                        area: 1090
                    },
                    'Hainaut': {
                        name_ko: 'ì—ë…¸',
                        name_en: 'Hainaut',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 1340000,
                        area: 3787
                    },
                    'LiÃ¨ge': {
                        name_ko: 'ë¦¬ì—ì£¼',
                        name_en: 'LiÃ¨ge',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 1110000,
                        area: 3857
                    },
                    'Luxembourg': {
                        name_ko: 'ë¤½ìƒë¶€ë¥´',
                        name_en: 'Luxembourg',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 290000,
                        area: 4443
                    },
                    'Namur': {
                        name_ko: 'ë‚˜ë®ˆë¥´',
                        name_en: 'Namur',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 520000,
                        area: 3666
                    },
                    // ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­
                    'Brussels-Capital': {
                        name_ko: 'ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­',
                        name_en: 'Brussels-Capital Region',
                        region: 'Brussels-Capital',
                        region_ko: 'ë¸Œë¤¼ì…€ ìˆ˜ë„ ì§€ì—­',
                        population: 1240000,
                        area: 162
                    }
                };

                const candidateUrls = [
                    // geoBoundaries BEL ADM1 (10ê°œ ì£¼ + ë¸Œë¤¼ì…€)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/BEL/ADM1/geoBoundaries-BEL-ADM1.geojson',
                    // Natural Earth Belgium provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë²¨ê¸°ì—ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'BEL' || admin === 'Belgium' || iso2 === 'BE';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Belgium] Filtered Natural Earth/global dataset to Belgium only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = fetchedData;
                            console.log('[Belgium] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Belgium] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 1 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Belgium] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Belgium] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Belgium dataset available');
                return data;
                
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `BEL_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `bel_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ë°ì´í„° ì°¾ê¸°
                    let provinceData = null;
                    const provinceNameLower = rawName.toLowerCase();
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    for (const [provinceKey, provinceInfo] of Object.entries(belgiumProvinceMapping)) {
                        if (provinceNameLower === provinceKey.toLowerCase() || 
                            provinceNameLower === provinceInfo.name_en.toLowerCase() ||
                            provinceNameLower.includes('brussels') && provinceKey === 'Brussels-Capital') {
                            provinceData = { key: provinceKey, ...provinceInfo };
                            break;
                        }
                    }
                    
                    // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                    if (!provinceData) {
                        for (const [provinceKey, provinceInfo] of Object.entries(belgiumProvinceMapping)) {
                            if (provinceNameLower.includes(provinceKey.toLowerCase()) || 
                                provinceKey.toLowerCase().includes(provinceNameLower) ||
                                provinceNameLower.includes(provinceInfo.name_en.toLowerCase()) ||
                                provinceInfo.name_en.toLowerCase().includes(provinceNameLower)) {
                                provinceData = { key: provinceKey, ...provinceInfo };
                                break;
                            }
                        }
                    }
                    
                    // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!provinceData && p.NAME_1) {
                        const provinceName = p.NAME_1;
                        if (belgiumProvinceMapping[provinceName]) {
                            provinceData = { key: provinceName, ...belgiumProvinceMapping[provinceName] };
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    const population = provinceData ? provinceData.population : (p.population || Math.floor(Math.random() * 2000000) + 300000);
                    const area = provinceData ? provinceData.area : (p.area || Math.floor(Math.random() * 4000) + 1000);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceData ? provinceData.name_ko : rawName,
                        name_en: provinceData ? provinceData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Belgium',
                        country_code: 'BE',
                        admin_level: provinceData && provinceData.key === 'Brussels-Capital' ? 'Capital Region' : 'Province',
                        province: provinceData ? provinceData.key : rawName,
                        province_ko: provinceData ? provinceData.name_ko : null,
                        region: provinceData ? provinceData.region : null,
                        region_ko: provinceData ? provinceData.region_ko : null,
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#5dade2',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayBelgiumGroupedRegions(belgiumProvinceMapping);
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#5dade2'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ í–‰ì •êµ¬ì—­');
            this.showNotification(`ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë²¨ê¸°ì— ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë²¨ê¸°ì— ì£¼ ëª©ë¡ í‘œì‹œ
    displayBelgiumGroupedRegions(provinceMapping) {
        console.log('\n=== ë²¨ê¸°ì— í–‰ì •êµ¬ì—­ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­) ===\n');
        
        // ì§€ì—­ë³„ë¡œ ê·¸ë£¹í™”
        const regions = {
            'Flanders': { name_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­', provinces: [] },
            'Walloon': { name_ko: 'ì™ˆë¡± ì§€ì—­', provinces: [] },
            'Brussels-Capital': { name_ko: 'ë¸Œë¤¼ì…€ ìˆ˜ë„ ì§€ì—­', provinces: [] }
        };
        
        Object.keys(provinceMapping).forEach(provinceKey => {
            const province = provinceMapping[provinceKey];
            if (regions[province.region]) {
                regions[province.region].provinces.push({ key: provinceKey, ...province });
            }
        });
        
        // ì§€ì—­ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(regions).forEach(regionKey => {
            const region = regions[regionKey];
            console.log(`\nğŸ“Œ ${region.name_ko} (${regionKey} Region)`);
            console.log('â”€'.repeat(95));
            console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
            console.log('â”€'.repeat(95));
            
            region.provinces.forEach((province, idx) => {
                const seq = (idx + 1).toString().padEnd(5);
                const name = `${province.name_en} (${province.name_ko})`.padEnd(38);
                const population = province.population.toLocaleString().padEnd(23);
                const area = province.area.toLocaleString();
                console.log(`${seq} | ${name} | ${population} | ${area}`);
            });
        });
        
        console.log('\nğŸ“Š ì´ê³„:');
        console.log(`   â€¢ ì§€ì—­ (Regions): 3ê°œ`);
        console.log(`   â€¢ ì£¼ (Provinces): 10ê°œ`);
        console.log(`   â€¢ ìˆ˜ë„ì§€ì—­: 1ê°œ (ë¸Œë¤¼ì…€)`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateBelgiumGroupedHTML(provinceMapping, regions);
        console.log('%cë²¨ê¸°ì— í–‰ì •êµ¬ì—­', 'color: #5dade2; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateBelgiumGroupedHTML(provinceMapping, regions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #5dade2; margin-top: 0;">ë²¨ê¸°ì— í–‰ì •êµ¬ì—­ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­)</h3>';
        
        // ì§€ì—­ë³„ ìš”ì•½ í…Œì´ë¸”
        Object.keys(regions).forEach(regionKey => {
            const region = regions[regionKey];
            html += `<h4 style="color: #5dade2; margin-top: 20px;">${region.name_ko}</h4>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
            html += '<tbody>';
            
            region.provinces.forEach((province, idx) => {
                html += `<tr style="border-bottom: 1px solid #333;">`;
                html += `<td style="padding: 8px;">${idx + 1}</td>`;
                html += `<td style="padding: 8px;">${province.name_en} (${province.name_ko})</td>`;
                html += `<td style="padding: 8px; text-align: right;">${province.population.toLocaleString()}</td>`;
                html += `<td style="padding: 8px; text-align: right;">${province.area.toLocaleString()}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
        });
        
        html += '</div>';
        return html;
    }
    
    // ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ (21ê°œ ì£¼ë¡œ ê·¸ë£¹í™”)
    async loadSwedenData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('sweden', async () => {
                let data = null;
                // ìŠ¤ì›¨ë´ 21ê°œ ì£¼(LÃ¤n) ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const swedenCountyMapping = {
                    'Stockholm': { name_ko: 'ìŠ¤í†¡í™€ë¦„ ì£¼', name_en: 'Stockholm', name_sv: 'Stockholms lÃ¤n', population: 2460000, area: 6519 },
                    'Uppsala': { name_ko: 'ì›ì‚´ë¼ ì£¼', name_en: 'Uppsala', name_sv: 'Uppsala lÃ¤n', population: 410000, area: 8207 },
                    'SÃ¶dermanland': { name_ko: 'ì‡ ë°ë¥´ë§Œë€ë“œ ì£¼', name_en: 'SÃ¶dermanland', name_sv: 'SÃ¶dermanlands lÃ¤n', population: 305000, area: 6072 },
                    'Ã–stergÃ¶tland': { name_ko: 'ì™¸ìŠ¤í…Œë¥´ì˜ˆí‹€ë€ë“œ ì£¼', name_en: 'Ã–stergÃ¶tland', name_sv: 'Ã–stergÃ¶tlands lÃ¤n', population: 480000, area: 10562 },
                    'JÃ¶nkÃ¶ping': { name_ko: 'ì˜Œì…°í•‘ ì£¼', name_en: 'JÃ¶nkÃ¶ping', name_sv: 'JÃ¶nkÃ¶pings lÃ¤n', population: 370000, area: 10494 },
                    'Kronoberg': { name_ko: 'í¬ë¡œë…¸ë² ë¦¬ ì£¼', name_en: 'Kronoberg', name_sv: 'Kronobergs lÃ¤n', population: 210000, area: 8457 },
                    'Kalmar': { name_ko: 'ì¹¼ë§ˆë¥´ ì£¼', name_en: 'Kalmar', name_sv: 'Kalmar lÃ¤n', population: 250000, area: 11163 },
                    'Gotland': { name_ko: 'ê³ í‹€ë€ë“œ ì£¼', name_en: 'Gotland', name_sv: 'Gotlands lÃ¤n', population: 60000, area: 3184 },
                    'Blekinge': { name_ko: 'ë¸”ë ˆí‚¹ì— ì£¼', name_en: 'Blekinge', name_sv: 'Blekinge lÃ¤n', population: 160000, area: 3039 },
                    'SkÃ¥ne': { name_ko: 'ìŠ¤ì½”ë„¤ ì£¼', name_en: 'SkÃ¥ne', name_sv: 'SkÃ¥ne lÃ¤n', population: 1420000, area: 11303 },
                    'Halland': { name_ko: 'í• ë€ë“œ ì£¼', name_en: 'Halland', name_sv: 'Hallands lÃ¤n', population: 345000, area: 5427 },
                    'VÃ¤stra GÃ¶taland': { name_ko: 'ë² ìŠ¤íŠ¸ë¼ì˜ˆíƒˆë€ë“œ ì£¼', name_en: 'VÃ¤stra GÃ¶taland', name_sv: 'VÃ¤stra GÃ¶talands lÃ¤n', population: 1800000, area: 23942 },
                    'VÃ¤rmland': { name_ko: 'ë² ë¥´ë¯ˆë€ë“œ ì£¼', name_en: 'VÃ¤rmland', name_sv: 'VÃ¤rmlands lÃ¤n', population: 285000, area: 17583 },
                    'Ã–rebro': { name_ko: 'ì™¸ë ˆë¸Œë¡œ ì£¼', name_en: 'Ã–rebro', name_sv: 'Ã–rebro lÃ¤n', population: 320000, area: 8555 },
                    'VÃ¤stmanland': { name_ko: 'ë² ìŠ¤íŠ¸ë§Œë€ë“œ ì£¼', name_en: 'VÃ¤stmanland', name_sv: 'VÃ¤stmanlands lÃ¤n', population: 290000, area: 5146 },
                    'Dalarna': { name_ko: 'ë‹¬ë¼ë¥´ë‚˜ ì£¼', name_en: 'Dalarna', name_sv: 'Dalarnas lÃ¤n', population: 285000, area: 28194 },
                    'GÃ¤vleborg': { name_ko: 'ì˜ˆë¸”ë ˆë³´ë¦¬ ì£¼', name_en: 'GÃ¤vleborg', name_sv: 'GÃ¤vleborgs lÃ¤n', population: 290000, area: 18186 },
                    'VÃ¤sternorrland': { name_ko: 'ë² ìŠ¤í…Œë¥´ë…¸ë¥¼ë€ë“œ ì£¼', name_en: 'VÃ¤sternorrland', name_sv: 'VÃ¤sternorrlands lÃ¤n', population: 230000, area: 21683 },
                    'JÃ¤mtland': { name_ko: 'ì˜˜í‹€ë€ë“œ ì£¼', name_en: 'JÃ¤mtland', name_sv: 'JÃ¤mtlands lÃ¤n', population: 130000, area: 49443 },
                    'VÃ¤sterbotten': { name_ko: 'ë² ìŠ¤í…Œë¥´ë³´í… ì£¼', name_en: 'VÃ¤sterbotten', name_sv: 'VÃ¤sterbottens lÃ¤n', population: 280000, area: 55186 },
                    'Norrbotten': { name_ko: 'ë…¸ë¥¼ë³´í… ì£¼', name_en: 'Norrbotten', name_sv: 'Norrbottens lÃ¤n', population: 250000, area: 106211 }
                };

                const candidateUrls = [
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/SWE/ADM1/geoBoundaries-SWE-ADM1.geojson',
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        if (url.includes('natural-earth') && fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'SWE' || admin === 'Sweden' || iso2 === 'SE';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Sweden] Filtered Natural Earth/global dataset to Sweden only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 0) {
                            data = fetchedData;
                            console.log('[Sweden] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 0) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Sweden] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 0 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Sweden] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Sweden] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Sweden dataset available');
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `SWE_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `swe_county_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // í–‰ì •êµ¬ì—­ ì´ë¦„ ë§¤ì¹­
                    let countyData = null;
                    const rawNameLower = rawName.toLowerCase();
                    for (const [countyKey, countyInfo] of Object.entries(swedenCountyMapping)) {
                        const countyKeyLower = countyKey.toLowerCase();
                        const nameEnLower = countyInfo.name_en.toLowerCase();
                        const nameSvLower = countyInfo.name_sv.toLowerCase();
                        if (rawNameLower.includes(countyKeyLower) || countyKeyLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameEnLower) || nameEnLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameSvLower) || nameSvLower.includes(rawNameLower)) {
                            countyData = countyInfo;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° NAME_1ì—ì„œë„ í™•ì¸
                    if (!countyData && p.NAME_1) {
                        const name1Lower = p.NAME_1.toLowerCase();
                        for (const [countyKey, countyInfo] of Object.entries(swedenCountyMapping)) {
                            const countyKeyLower = countyKey.toLowerCase();
                            const nameEnLower = countyInfo.name_en.toLowerCase();
                            const nameSvLower = countyInfo.name_sv.toLowerCase();
                            if (name1Lower.includes(countyKeyLower) || countyKeyLower.includes(name1Lower) ||
                                name1Lower.includes(nameEnLower) || nameEnLower.includes(name1Lower) ||
                                name1Lower.includes(nameSvLower) || nameSvLower.includes(name1Lower)) {
                                countyData = countyInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: countyData ? countyData.name_ko : rawName,
                        name_en: countyData ? countyData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Sweden',
                        country_code: 'SE',
                        admin_level: 'County (LÃ¤n)',
                        population: countyData ? countyData.population : (p.population || Math.floor(Math.random() * 500000) + 50000),
                        area: countyData ? countyData.area : (p.area || Math.floor(Math.random() * 10000) + 1000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#3498db',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#3498db'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì£¼ (LÃ¤n)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìŠ¤ì›¨ë´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ (9ê°œ ì£¼ë¡œ ê·¸ë£¹í™”)
    async loadAustriaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('austria', async () => {
                let data = null;
                // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ 9ê°œ ì—°ë°©ì£¼ ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const austriaStateMapping = {
                    'Wien': {
                        name_ko: 'ë¹ˆ',
                        name_en: 'Vienna',
                        name_de: 'Wien',
                        population: 1985000,
                        area: 415,
                        districts: ['Wien', 'Vienna']
                    },
                    'NiederÃ¶sterreich': {
                        name_ko: 'ë‹ˆë”ì™¸ìŠ¤í„°ë¼ì´íˆ',
                        name_en: 'Lower Austria',
                        name_de: 'NiederÃ¶sterreich',
                        population: 1720000,
                        area: 19186,
                        districts: ['NiederÃ¶sterreich', 'Lower Austria', 'NÃ–', 'NOE']
                    },
                    'OberÃ¶sterreich': {
                        name_ko: 'ì˜¤ë²„ì™¸ìŠ¤í„°ë¼ì´íˆ',
                        name_en: 'Upper Austria',
                        name_de: 'OberÃ¶sterreich',
                        population: 1520000,
                        area: 11982,
                        districts: ['OberÃ¶sterreich', 'Upper Austria', 'OÃ–', 'OOE']
                    },
                    'Steiermark': {
                        name_ko: 'ìŠˆíƒ€ì´ì–´ë§ˆë¥´í¬',
                        name_en: 'Styria',
                        name_de: 'Steiermark',
                        population: 1260000,
                        area: 16401,
                        districts: ['Steiermark', 'Styria', 'ST']
                    },
                    'Tirol': {
                        name_ko: 'í‹°ë¡¤',
                        name_en: 'Tyrol',
                        name_de: 'Tirol',
                        population: 770000,
                        area: 12648,
                        districts: ['Tirol', 'Tyrol', 'T']
                    },
                    'KÃ¤rnten': {
                        name_ko: 'ì¼€ë¥¸í…',
                        name_en: 'Carinthia',
                        name_de: 'KÃ¤rnten',
                        population: 570000,
                        area: 9537,
                        districts: ['KÃ¤rnten', 'Carinthia', 'K']
                    },
                    'Salzburg': {
                        name_ko: 'ì˜ì¸ ë¶€ë¥´í¬',
                        name_en: 'Salzburg',
                        name_de: 'Salzburg',
                        population: 570000,
                        area: 7156,
                        districts: ['Salzburg']
                    },
                    'Vorarlberg': {
                        name_ko: 'í¬ì–´ì•„ë¥¼ë² ë¥´í¬',
                        name_en: 'Vorarlberg',
                        name_de: 'Vorarlberg',
                        population: 410000,
                        area: 2601,
                        districts: ['Vorarlberg', 'V']
                    },
                    'Burgenland': {
                        name_ko: 'ë¶€ë¥´ê²ë€íŠ¸',
                        name_en: 'Burgenland',
                        name_de: 'Burgenland',
                        population: 310000,
                        area: 3965,
                        districts: ['Burgenland', 'B']
                    }
                };

                const candidateUrls = [
                    // geoBoundaries AUT ADM1 (9ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/AUT/ADM1/geoBoundaries-AUT-ADM1.geojson',
                    // geoBoundaries AUT ADM2 (21ê°œ êµ¬)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/AUT/ADM2/geoBoundaries-AUT-ADM2.geojson',
                    // Natural Earth Austria states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'AUT' || admin === 'Austria' || iso2 === 'AT';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Austria] Filtered Natural Earth/global dataset to Austria only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = fetchedData;
                            console.log('[Austria] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Austria] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 1 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Austria] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Austria] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Austria dataset available');
                return data;
                
                // êµ¬ ì´ë¦„ì„ ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const districtToStateMap = {};
                Object.keys(austriaStateMapping).forEach(stateName => {
                    const state = austriaStateMapping[stateName];
                    state.districts.forEach(district => {
                        districtToStateMap[district.toLowerCase()] = {
                            state: stateName,
                            state_ko: state.name_ko,
                            state_en: state.name_en
                        };
                    });
                });
                
                const idSet = new Set();
                const isDistrictLevel = data.features.length > 15; // ADM2 ë°ì´í„°ì¸ ê²½ìš° (21ê°œ êµ¬)
                
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME_2 || p.district || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `AUT_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = isDistrictLevel ? `aut_district_${index}` : `aut_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // êµ¬ ì´ë¦„ìœ¼ë¡œ ì£¼ ì°¾ê¸°
                    let stateInfo = null;
                    let stateData = null;
                    if (isDistrictLevel) {
                        const districtNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (districtToStateMap[districtNameLower]) {
                            stateInfo = districtToStateMap[districtNameLower];
                            stateData = austriaStateMapping[stateInfo.state];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [districtKey, stInfo] of Object.entries(districtToStateMap)) {
                                if (districtNameLower.includes(districtKey) || districtKey.includes(districtNameLower)) {
                                    stateInfo = stInfo;
                                    stateData = austriaStateMapping[stInfo.state];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!stateInfo && p.NAME_1) {
                            const stateName = p.NAME_1;
                            if (austriaStateMapping[stateName]) {
                                stateInfo = {
                                    state: stateName,
                                    state_ko: austriaStateMapping[stateName].name_ko,
                                    state_en: austriaStateMapping[stateName].name_en
                                };
                                stateData = austriaStateMapping[stateName];
                            } else {
                                // NAME_1ì´ ì£¼ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                                for (const [stateKey, stateInfoData] of Object.entries(austriaStateMapping)) {
                                    if (stateName.toLowerCase().includes(stateKey.toLowerCase()) || 
                                        stateKey.toLowerCase().includes(stateName.toLowerCase()) ||
                                        stateInfoData.name_en.toLowerCase().includes(stateName.toLowerCase()) ||
                                        stateInfoData.name_de.toLowerCase().includes(stateName.toLowerCase())) {
                                        stateInfo = {
                                            state: stateKey,
                                            state_ko: stateInfoData.name_ko,
                                            state_en: stateInfoData.name_en
                                        };
                                        stateData = stateInfoData;
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && austriaStateMapping[p.NAME_1]) {
                            stateData = austriaStateMapping[p.NAME_1];
                        } else if (p.NAME_1) {
                            // NAME_1ì´ ì£¼ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                            for (const [stateKey, stateInfoData] of Object.entries(austriaStateMapping)) {
                                if (p.NAME_1.toLowerCase().includes(stateKey.toLowerCase()) || 
                                    stateKey.toLowerCase().includes(p.NAME_1.toLowerCase()) ||
                                    stateInfoData.name_en.toLowerCase().includes(p.NAME_1.toLowerCase()) ||
                                    stateInfoData.name_de.toLowerCase().includes(p.NAME_1.toLowerCase())) {
                                    stateData = stateInfoData;
                                    stateInfo = {
                                        state: stateKey,
                                        state_ko: stateInfoData.name_ko,
                                        state_en: stateInfoData.name_en
                                    };
                                    break;
                                }
                            }
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isDistrictLevel && stateData) {
                        // êµ¬ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° ì£¼ì˜ í‰ê·  ì¸êµ¬/ë©´ì  ì‚¬ìš©
                        const avgPopulation = stateData.population ? Math.floor(stateData.population / stateData.districts.length) : (p.population || Math.floor(Math.random() * 500000) + 50000);
                        const avgArea = stateData.area ? Math.floor(stateData.area / stateData.districts.length) : (p.area || Math.floor(Math.random() * 2000) + 500);
                        population = p.population || avgPopulation;
                        area = p.area || avgArea;
                    } else if (!isDistrictLevel && stateData) {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° - ë§¤í•‘ëœ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©
                        population = p.population || stateData.population || Math.floor(Math.random() * 2000000) + 200000;
                        area = p.area || stateData.area || Math.floor(Math.random() * 10000) + 2000;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isDistrictLevel ? 500000 : 2000000)) + (isDistrictLevel ? 50000 : 200000);
                        area = p.area || Math.floor(Math.random() * (isDistrictLevel ? 2000 : 10000)) + (isDistrictLevel ? 500 : 2000);
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.state_ko : (stateData ? stateData.name_ko : rawName),
                        name_en: stateInfo ? stateInfo.state_en : (stateData ? stateData.name_en : (p.NAME_1 || p.name || rawName)),
                        country: 'Austria',
                        country_code: 'AT',
                        admin_level: isDistrictLevel ? 'District' : 'State',
                        state: stateInfo ? stateInfo.state : (p.NAME_1 || null),
                        state_ko: stateInfo ? stateInfo.state_ko : (stateData ? stateData.name_ko : null),
                        state_en: stateInfo ? stateInfo.state_en : (stateData ? stateData.name_en : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#9b59b6',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayAustriaGroupedRegions(austriaStateMapping);
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#9b59b6'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isDistrictLevel = geoJsonData.features.length > 15;
            const adminType = isDistrictLevel ? 'êµ¬' : 'ì£¼';
            console.log('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (9ê°œ ì£¼ë¡œ ê·¸ë£¹í™”)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ì£¼ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displayAustriaGroupedRegions(stateMapping) {
        console.log('\n=== ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ 9ê°œ ì—°ë°©ì£¼ (BundeslÃ¤nder) ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ë…ì¼ì–´ëª…'.padEnd(20) + '| êµ¬ ìˆ˜ (ì¶”ì •)');
        console.log('â”€'.repeat(95));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(stateMapping).forEach((stateName, idx) => {
            const state = stateMapping[stateName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${state.name_en} (${state.name_ko})`.padEnd(38);
            const nameDe = state.name_de.padEnd(18);
            const districtCount = state.districts.length.toString().padEnd(10);
            console.log(`${seq} | ${name} | ${nameDe} | ${districtCount}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalDistricts = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Austria') {
                const state = regionData.state || 'Unknown';
                if (!groupedRegions[state]) {
                    groupedRegions[state] = {
                        name_ko: regionData.state_ko || state,
                        name_en: regionData.state_en || state,
                        districts: []
                    };
                }
                groupedRegions[state].districts.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalDistricts++;
            }
        });

        // ì£¼ë³„ë¡œ ì¶œë ¥
        Object.keys(stateMapping).forEach(stateName => {
            const state = stateMapping[stateName];
            const loadedDistricts = groupedRegions[stateName] || { districts: [] };
            
            console.log(`\nğŸ“Œ ${state.name_en} (${state.name_ko})`);
            console.log(`   ë…ì¼ì–´ëª…: ${state.name_de}`);
            console.log(`   êµ¬ ìˆ˜: ë¡œë“œë¨ ${loadedDistricts.districts.length}ê°œ`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì—°ë°©ì£¼ (BundeslÃ¤nder): ${Object.keys(stateMapping).length}ê°œ`);
        console.log(`   â€¢ êµ¬ (Bezirke): ${totalDistricts}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateAustriaGroupedHTML(stateMapping, groupedRegions);
        console.log('%cì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateAustriaGroupedHTML(stateMapping, groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #9b59b6; margin-top: 0;">ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: left;">ë…ì¼ì–´ëª…</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(stateMapping).forEach((stateName, idx) => {
            const state = stateMapping[stateName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${state.name_en} (${state.name_ko})</td>`;
            html += `<td style="padding: 8px;">${state.name_de}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ (5ê°œ ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)
    async loadDenmarkData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('denmark', async () => {
                let data = null;
                // ë´ë§ˆí¬ 5ê°œ ì§€ì—­(Regioner) ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const denmarkRegionMapping = {
                    'Hovedstaden': { name_ko: 'ìˆ˜ë„ ì§€ì—­', name_en: 'Capital Region', name_da: 'Region Hovedstaden', population: 1900000, area: 2560 },
                    'SjÃ¦lland': { name_ko: 'ì…€ë€ ì§€ì—­', name_en: 'Zealand Region', name_da: 'Region SjÃ¦lland', population: 850000, area: 7274 },
                    'Syddanmark': { name_ko: 'ë‚¨ë´ë§ˆí¬ ì§€ì—­', name_en: 'Southern Denmark', name_da: 'Region Syddanmark', population: 1250000, area: 12192 },
                    'Midtjylland': { name_ko: 'ì¤‘ë¶€ ìœ í‹€ë€ë“œ ì§€ì—­', name_en: 'Central Jutland', name_da: 'Region Midtjylland', population: 1350000, area: 13142 },
                    'Nordjylland': { name_ko: 'ë¶ìœ í‹€ë€ë“œ ì§€ì—­', name_en: 'North Jutland', name_da: 'Region Nordjylland', population: 600000, area: 7874 }
                };

                const candidateUrls = [
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/DNK/ADM1/geoBoundaries-DNK-ADM1.geojson',
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        if (url.includes('natural-earth') && fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'DNK' || admin === 'Denmark' || iso2 === 'DK';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Denmark] Filtered Natural Earth/global dataset to Denmark only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 0) {
                            data = fetchedData;
                            console.log('[Denmark] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 0) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Denmark] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 0 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Denmark] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Denmark] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Denmark dataset available');
                return data;
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `DNK_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `dnk_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // í–‰ì •êµ¬ì—­ ì´ë¦„ ë§¤ì¹­
                    let regionData = null;
                    const rawNameLower = rawName.toLowerCase();
                    for (const [regionKey, regionInfo] of Object.entries(denmarkRegionMapping)) {
                        const regionKeyLower = regionKey.toLowerCase();
                        const nameEnLower = regionInfo.name_en.toLowerCase();
                        const nameDaLower = regionInfo.name_da.toLowerCase();
                        if (rawNameLower.includes(regionKeyLower) || regionKeyLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameEnLower) || nameEnLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameDaLower) || nameDaLower.includes(rawNameLower)) {
                            regionData = regionInfo;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° NAME_1ì—ì„œë„ í™•ì¸
                    if (!regionData && p.NAME_1) {
                        const name1Lower = p.NAME_1.toLowerCase();
                        for (const [regionKey, regionInfo] of Object.entries(denmarkRegionMapping)) {
                            const regionKeyLower = regionKey.toLowerCase();
                            const nameEnLower = regionInfo.name_en.toLowerCase();
                            const nameDaLower = regionInfo.name_da.toLowerCase();
                            if (name1Lower.includes(regionKeyLower) || regionKeyLower.includes(name1Lower) ||
                                name1Lower.includes(nameEnLower) || nameEnLower.includes(name1Lower) ||
                                name1Lower.includes(nameDaLower) || nameDaLower.includes(name1Lower)) {
                                regionData = regionInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: regionData ? regionData.name_ko : rawName,
                        name_en: regionData ? regionData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Denmark',
                        country_code: 'DK',
                        admin_level: 'Region',
                        population: regionData ? regionData.population : (p.population || Math.floor(Math.random() * 2000000) + 300000),
                        area: regionData ? regionData.area : (p.area || Math.floor(Math.random() * 15000) + 2000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#1abc9c',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#1abc9c'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
            this.showNotification(`ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì§€ì—­ (Regioner)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë´ë§ˆí¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // í•€ë€ë“œ ë°ì´í„° ë¡œë“œ (19ê°œ ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)
    async loadFinlandData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('finland', async () => {
                let data = null;
                // í•€ë€ë“œ 19ê°œ ì§€ì—­(Maakunta) ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const finlandRegionMapping = {
                    'Uusimaa': { name_ko: 'ìš°ì‹œë§ˆ', name_en: 'Uusimaa', name_fi: 'Uusimaa', population: 1750000, area: 9100 },
                    'Varsinais-Suomi': { name_ko: 'ë‚¨ì„œí•€ë€ë“œ', name_en: 'Southwest Finland', name_fi: 'Varsinais-Suomi', population: 490000, area: 10900 },
                    'Satakunta': { name_ko: 'ì‚¬íƒ€ì¿¤íƒ€', name_en: 'Satakunta', name_fi: 'Satakunta', population: 215000, area: 8200 },
                    'Kanta-HÃ¤me': { name_ko: 'ì¹¸íƒ€í—¤ë©”', name_en: 'Tavastia Proper', name_fi: 'Kanta-HÃ¤me', population: 185000, area: 5200 },
                    'PÃ¤ijÃ¤t-HÃ¤me': { name_ko: 'íŒŒì´ì–˜íŠ¸í•´ë©”', name_en: 'PÃ¤ijÃ¤nne Tavastia', name_fi: 'PÃ¤ijÃ¤t-HÃ¤me', population: 210000, area: 5100 },
                    'Kymenlaakso': { name_ko: 'í‚¤ë©”ë„¬ë½ì†Œ', name_en: 'Kymenlaakso', name_fi: 'Kymenlaakso', population: 155000, area: 5100 },
                    'EtelÃ¤-Karjala': { name_ko: 'ë‚¨ì¹´ë¦¬ì•Œë¼', name_en: 'South Karelia', name_fi: 'EtelÃ¤-Karjala', population: 125000, area: 5700 },
                    'EtelÃ¤-Savo': { name_ko: 'ë‚¨ì‚¬ë³´', name_en: 'South Savo', name_fi: 'EtelÃ¤-Savo', population: 140000, area: 18800 },
                    'Pohjois-Savo': { name_ko: 'ë¶ì‚¬ë³´', name_en: 'North Savo', name_fi: 'Pohjois-Savo', population: 240000, area: 20400 },
                    'Pohjois-Karjala': { name_ko: 'ë¶ì¹´ë¦¬ì•Œë¼', name_en: 'North Karelia', name_fi: 'Pohjois-Karjala', population: 160000, area: 21600 },
                    'Keski-Suomi': { name_ko: 'ì¤‘ë¶€í•€ë€ë“œ', name_en: 'Central Finland', name_fi: 'Keski-Suomi', population: 280000, area: 19900 },
                    'EtelÃ¤-Pohjanmaa': { name_ko: 'ë‚¨ì˜¤ìŠ¤íŠ¸ë¡œë³´ìŠ¤ë‹ˆì•„', name_en: 'South Ostrobothnia', name_fi: 'EtelÃ¤-Pohjanmaa', population: 195000, area: 14400 },
                    'Pohjanmaa': { name_ko: 'í¬íì–€ë§ˆ', name_en: 'Ostrobothnia', name_fi: 'Pohjanmaa', population: 180000, area: 7800 },
                    'Keski-Pohjanmaa': { name_ko: 'ì¤‘ë¶€ì˜¤ìŠ¤íŠ¸ë¡œë³´ìŠ¤ë‹ˆì•„', name_en: 'Central Ostrobothnia', name_fi: 'Keski-Pohjanmaa', population: 70000, area: 5700 },
                    'Pohjois-Pohjanmaa': { name_ko: 'ë¶ì˜¤ìŠ¤íŠ¸ë¡œë³´ìŠ¤ë‹ˆì•„', name_en: 'North Ostrobothnia', name_fi: 'Pohjois-Pohjanmaa', population: 420000, area: 37100 },
                    'Kainuu': { name_ko: 'ì¹´ì´ëˆ„', name_en: 'Kainuu', name_fi: 'Kainuu', population: 70000, area: 22600 },
                    'Lappi': { name_ko: 'ë¼í”Œë€ë“œ', name_en: 'Lapland', name_fi: 'Lappi', population: 175000, area: 98000 },
                    'Pirkanmaa': { name_ko: 'í”¼ë¥´ì¹¸ë§ˆ', name_en: 'Pirkanmaa', name_fi: 'Pirkanmaa', population: 550000, area: 12300 },
                    'Ahvenanmaa': { name_ko: 'ì˜¬ë€ë“œ ì œë„', name_en: 'Ã…land', name_fi: 'Ahvenanmaa', population: 30000, area: 1550 }
                };

                const candidateUrls = [
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/FIN/ADM1/geoBoundaries-FIN-ADM1.geojson',
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        if (url.includes('natural-earth') && fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'FIN' || admin === 'Finland' || iso2 === 'FI';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Finland] Filtered Natural Earth/global dataset to Finland only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 0) {
                            data = fetchedData;
                            console.log('[Finland] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 0) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Finland] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 0 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Finland] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Finland] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Finland dataset available');
                
                const idSet = new Set();
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `FIN_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `fin_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // í–‰ì •êµ¬ì—­ ì´ë¦„ ë§¤ì¹­
                    let regionData = null;
                    const rawNameLower = rawName.toLowerCase();
                    for (const [regionKey, regionInfo] of Object.entries(finlandRegionMapping)) {
                        const regionKeyLower = regionKey.toLowerCase();
                        const nameEnLower = regionInfo.name_en.toLowerCase();
                        const nameFiLower = regionInfo.name_fi.toLowerCase();
                        if (rawNameLower.includes(regionKeyLower) || regionKeyLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameEnLower) || nameEnLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameFiLower) || nameFiLower.includes(rawNameLower)) {
                            regionData = regionInfo;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° NAME_1ì—ì„œë„ í™•ì¸
                    if (!regionData && p.NAME_1) {
                        const name1Lower = p.NAME_1.toLowerCase();
                        for (const [regionKey, regionInfo] of Object.entries(finlandRegionMapping)) {
                            const regionKeyLower = regionKey.toLowerCase();
                            const nameEnLower = regionInfo.name_en.toLowerCase();
                            const nameFiLower = regionInfo.name_fi.toLowerCase();
                            if (name1Lower.includes(regionKeyLower) || regionKeyLower.includes(name1Lower) ||
                                name1Lower.includes(nameEnLower) || nameEnLower.includes(name1Lower) ||
                                name1Lower.includes(nameFiLower) || nameFiLower.includes(name1Lower)) {
                                regionData = regionInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: regionData ? regionData.name_ko : rawName,
                        name_en: regionData ? regionData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Finland',
                        country_code: 'FI',
                        admin_level: 'Region (Maakunta)',
                        population: regionData ? regionData.population : (p.population || Math.floor(Math.random() * 500000) + 50000),
                        area: regionData ? regionData.area : (p.area || Math.floor(Math.random() * 10000) + 1000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#34495e',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#34495e'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í•€ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
            this.showNotification(`í•€ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì§€ì—­ (Maakunta)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í•€ë€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í•€ë€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ (4ê°œ í”„ë¡œë¹ˆìŠ¤ë¡œ ê·¸ë£¹í™”)
    async loadIrelandData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('ireland', async () => {
                let data = null;
                // ì•„ì¼ëœë“œ 4ê°œ í”„ë¡œë¹ˆìŠ¤ì™€ 26ê°œ ì¹´ìš´í‹° ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const irelandProvinceMapping = {
                    'Leinster': {
                        name_ko: 'ë ŒìŠ¤í„°',
                        name_en: 'Leinster',
                        population: 3200000,
                        area: 19800,
                        counties: [
                            'Carlow', 'Dublin', 'Kildare', 'Kilkenny', 'Laois', 
                            'Longford', 'Louth', 'Meath', 'Offaly', 'Westmeath', 
                            'Wexford', 'Wicklow'
                        ]
                    },
                    'Munster': {
                        name_ko: 'ë¨¼ìŠ¤í„°',
                        name_en: 'Munster',
                        population: 1350000,
                        area: 24700,
                        counties: [
                            'Clare', 'Cork', 'Kerry', 'Limerick', 'Tipperary', 'Waterford'
                        ]
                    },
                    'Connacht': {
                        name_ko: 'ì½”ë…¸íŠ¸',
                        name_en: 'Connacht',
                        population: 590000,
                        area: 17700,
                        counties: [
                            'Galway', 'Leitrim', 'Mayo', 'Roscommon', 'Sligo'
                        ]
                    },
                    'Ulster': {
                        name_ko: 'ì–¼ìŠ¤í„°',
                        name_en: 'Ulster',
                        population: 300000,
                        area: 8300,
                        counties: [
                            'Cavan', 'Donegal', 'Monaghan'
                        ]
                    }
                };
                
                // ì•„ì¼ëœë“œ 26ê°œ ì¹´ìš´í‹°ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ì¶”ì •)
                const irelandCountyData = {
                    'Carlow': { name_ko: 'ì¹¼ë¡œìš°', population: 65000, area: 900 },
                    'Cavan': { name_ko: 'ìºë²ˆ', population: 81000, area: 1930 },
                    'Clare': { name_ko: 'í´ë ˆì–´', population: 128000, area: 3450 },
                    'Cork': { name_ko: 'ì½”í¬', population: 580000, area: 7500 },
                    'Donegal': { name_ko: 'ë„ë„¤ê³¨', population: 165000, area: 4860 },
                    'Dublin': { name_ko: 'ë”ë¸”ë¦°', population: 1450000, area: 920 },
                    'Galway': { name_ko: 'ê³¨ì›¨ì´', population: 280000, area: 6150 },
                    'Kerry': { name_ko: 'ì¼€ë¦¬', population: 155000, area: 4800 },
                    'Kildare': { name_ko: 'í‚¬ë°ì–´', population: 250000, area: 1690 },
                    'Kilkenny': { name_ko: 'í‚¬ì¼€ë‹ˆ', population: 105000, area: 2070 },
                    'Laois': { name_ko: 'ë¼ì˜¤ì´ìŠ¤', population: 95000, area: 1720 },
                    'Leitrim': { name_ko: 'ë¦¬íŠ¸ë¦¼', population: 35000, area: 1580 },
                    'Limerick': { name_ko: 'ë¦¬ë¨¸ë¦­', population: 210000, area: 2750 },
                    'Longford': { name_ko: 'ë¡±í¼ë“œ', population: 47000, area: 1090 },
                    'Louth': { name_ko: 'ë¼ìš°ìŠ¤', population: 140000, area: 820 },
                    'Mayo': { name_ko: 'ë©”ì´ì˜¤', population: 135000, area: 5400 },
                    'Meath': { name_ko: 'ë¯¸ìŠ¤', population: 225000, area: 2330 },
                    'Monaghan': { name_ko: 'ëª¨ë‚˜í•œ', population: 65000, area: 1290 },
                    'Offaly': { name_ko: 'ì˜¤í„ë¦¬', population: 85000, area: 2000 },
                    'Roscommon': { name_ko: 'ë¡œìŠ¤ì½”ë¨¼', population: 70000, area: 2500 },
                    'Sligo': { name_ko: 'ìŠ¬ë¼ì´ê³ ', population: 65000, area: 1800 },
                    'Tipperary': { name_ko: 'í‹°í¼ë ˆë¦¬', population: 165000, area: 4300 },
                    'Waterford': { name_ko: 'ì›Œí„°í¼ë“œ', population: 125000, area: 1850 },
                    'Westmeath': { name_ko: 'ì›¨ìŠ¤íŠ¸ë¯¸ìŠ¤', population: 96000, area: 1840 },
                    'Wexford': { name_ko: 'ì›©ìŠ¤í¼ë“œ', population: 165000, area: 2350 },
                    'Wicklow': { name_ko: 'ìœ…ë¡œìš°', population: 155000, area: 2030 }
                };

                const candidateUrls = [
                    // geoBoundaries IRL ADM1 (26ê°œ ì¹´ìš´í‹°)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/IRL/ADM1/geoBoundaries-IRL-ADM1.geojson',
                    // Natural Earth Ireland counties
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const fetchedData = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì•„ì¼ëœë“œë§Œ í•„í„°ë§
                        if (fetchedData && Array.isArray(fetchedData.features) && fetchedData.features.length > 300) {
                            const filtered = fetchedData.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'IRL' || admin === 'Ireland' || iso2 === 'IE';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Ireland] Filtered Natural Earth/global dataset to Ireland only: ${filtered.length} features`);
                                data = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (fetchedData && fetchedData.type === 'FeatureCollection' && Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = fetchedData;
                            console.log('[Ireland] Loaded from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData.features) && fetchedData.features.length > 1) {
                            data = { type: 'FeatureCollection', features: fetchedData.features };
                            console.log('[Ireland] Loaded (normalized) from', url, 'features:', fetchedData.features.length);
                            break;
                        }
                        if (Array.isArray(fetchedData) && fetchedData.length > 1 && fetchedData[0].geometry) {
                            data = { type: 'FeatureCollection', features: fetchedData };
                            console.log('[Ireland] Loaded (array -> FC) from', url, 'features:', fetchedData.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        // ì˜ˆìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ëŠ” ì¡°ìš©íˆ ì²˜ë¦¬ (ë§ˆì§€ë§‰ URLì—ì„œë§Œ ê²½ê³ )
                        const isLastUrl = candidateUrls.indexOf(url) === candidateUrls.length - 1;
                        if (!this.isExpectedError(e) || isLastUrl) {
                            console.warn('[Ireland] Failed loading from', url, e);
                        }
                    }
                }
                if (!data) throw lastError || new Error('No Ireland dataset available');
                return data;
                
                // ì¹´ìš´í‹° ì´ë¦„ì„ í”„ë¡œë¹ˆìŠ¤ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const countyToProvinceMap = {};
                Object.keys(irelandProvinceMapping).forEach(provinceName => {
                    const province = irelandProvinceMapping[provinceName];
                    province.counties.forEach(county => {
                        countyToProvinceMap[county.toLowerCase()] = {
                            province: provinceName,
                            province_ko: province.name_ko,
                            province_en: province.name_en
                        };
                    });
                });
                
                const idSet = new Set();
                const isCountyLevel = data.features.length > 10; // ì¹´ìš´í‹° ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° (26ê°œ ì¹´ìš´í‹°)
                
                data.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.county || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `IRL_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = isCountyLevel ? `irl_county_${index}` : `irl_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì¹´ìš´í‹° ì´ë¦„ìœ¼ë¡œ í”„ë¡œë¹ˆìŠ¤ ì°¾ê¸°
                    let provinceInfo = null;
                    let provinceData = null;
                    if (isCountyLevel) {
                        const countyNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (countyToProvinceMap[countyNameLower]) {
                            provinceInfo = countyToProvinceMap[countyNameLower];
                            provinceData = irelandProvinceMapping[provinceInfo.province];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [countyKey, provInfo] of Object.entries(countyToProvinceMap)) {
                                if (countyNameLower.includes(countyKey) || countyKey.includes(countyNameLower)) {
                                    provinceInfo = provInfo;
                                    provinceData = irelandProvinceMapping[provInfo.province];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ í”„ë¡œë¹ˆìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!provinceInfo && p.NAME_1) {
                            const provinceName = p.NAME_1;
                            if (irelandProvinceMapping[provinceName]) {
                                provinceInfo = {
                                    province: provinceName,
                                    province_ko: irelandProvinceMapping[provinceName].name_ko,
                                    province_en: irelandProvinceMapping[provinceName].name_en
                                };
                                provinceData = irelandProvinceMapping[provinceName];
                            } else {
                                // NAME_1ì´ í”„ë¡œë¹ˆìŠ¤ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                                for (const [provinceKey, provinceInfoData] of Object.entries(irelandProvinceMapping)) {
                                    if (provinceName.toLowerCase().includes(provinceKey.toLowerCase()) || 
                                        provinceKey.toLowerCase().includes(provinceName.toLowerCase()) ||
                                        provinceInfoData.name_en.toLowerCase().includes(provinceName.toLowerCase())) {
                                        provinceInfo = {
                                            province: provinceKey,
                                            province_ko: provinceInfoData.name_ko,
                                            province_en: provinceInfoData.name_en
                                        };
                                        provinceData = provinceInfoData;
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        // í”„ë¡œë¹ˆìŠ¤ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && irelandProvinceMapping[p.NAME_1]) {
                            provinceData = irelandProvinceMapping[p.NAME_1];
                        } else if (p.NAME_1) {
                            // NAME_1ì´ í”„ë¡œë¹ˆìŠ¤ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                            for (const [provinceKey, provinceInfoData] of Object.entries(irelandProvinceMapping)) {
                                if (p.NAME_1.toLowerCase().includes(provinceKey.toLowerCase()) || 
                                    provinceKey.toLowerCase().includes(p.NAME_1.toLowerCase()) ||
                                    provinceInfoData.name_en.toLowerCase().includes(p.NAME_1.toLowerCase())) {
                                    provinceData = provinceInfoData;
                                    provinceInfo = {
                                        province: provinceKey,
                                        province_ko: provinceInfoData.name_ko,
                                        province_en: provinceInfoData.name_en
                                    };
                                    break;
                                }
                            }
                        }
                    }
                    
                    // í”„ë¡œë¹ˆìŠ¤ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isCountyLevel) {
                        // ì¹´ìš´í‹° ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° - ì‹¤ì œ ì¹´ìš´í‹° ë°ì´í„° ì‚¬ìš©
                        const countyNameLower = rawName.toLowerCase();
                        let countyData = null;
                        for (const [countyKey, countyInfo] of Object.entries(irelandCountyData)) {
                            if (countyNameLower === countyKey.toLowerCase() || countyNameLower.includes(countyKey.toLowerCase()) || countyKey.toLowerCase().includes(countyNameLower)) {
                                countyData = countyInfo;
                                break;
                            }
                        }
                        if (countyData) {
                            population = p.population || countyData.population;
                            area = p.area || countyData.area;
                        } else {
                            // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° í”„ë¡œë¹ˆìŠ¤ì˜ í‰ê·  ì¸êµ¬/ë©´ì  ì‚¬ìš©
                            const avgPopulation = provinceData && provinceData.population ? Math.floor(provinceData.population / provinceData.counties.length) : (p.population || Math.floor(Math.random() * 300000) + 30000);
                            const avgArea = provinceData && provinceData.area ? Math.floor(provinceData.area / provinceData.counties.length) : (p.area || Math.floor(Math.random() * 3000) + 500);
                            population = p.population || avgPopulation;
                            area = p.area || avgArea;
                        }
                    } else if (!isCountyLevel && provinceData) {
                        // í”„ë¡œë¹ˆìŠ¤ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° - ë§¤í•‘ëœ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©
                        population = p.population || provinceData.population || Math.floor(Math.random() * 2000000) + 200000;
                        area = p.area || provinceData.area || Math.floor(Math.random() * 15000) + 5000;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isCountyLevel ? 300000 : 2000000)) + (isCountyLevel ? 30000 : 200000);
                        area = p.area || Math.floor(Math.random() * (isCountyLevel ? 3000 : 15000)) + (isCountyLevel ? 500 : 5000);
                    }
                    
                    // ì¹´ìš´í‹° ë°ì´í„°ì—ì„œ ì´ë¦„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const countyNameLower = rawName.toLowerCase();
                    let matchedCountyData = null;
                    if (isCountyLevel) {
                        for (const [countyKey, countyInfo] of Object.entries(irelandCountyData)) {
                            if (countyNameLower === countyKey.toLowerCase() || countyNameLower.includes(countyKey.toLowerCase()) || countyKey.toLowerCase().includes(countyNameLower)) {
                                matchedCountyData = countyInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: isCountyLevel && matchedCountyData ? matchedCountyData.name_ko : (provinceInfo ? provinceInfo.province_ko : (provinceData ? provinceData.name_ko : rawName)),
                        name_en: isCountyLevel ? (p.NAME_1 || p.name || rawName) : (provinceInfo ? provinceInfo.province_en : (provinceData ? provinceData.name_en : (p.NAME_1 || p.name || rawName))),
                        country: 'Ireland',
                        country_code: 'IE',
                        admin_level: isCountyLevel ? 'County' : 'Province',
                        province: provinceInfo ? provinceInfo.province : (p.NAME_1 || null),
                        province_ko: provinceInfo ? provinceInfo.province_ko : (provinceData ? provinceData.name_ko : null),
                        province_en: provinceInfo ? provinceInfo.province_en : (provinceData ? provinceData.name_en : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#16a085',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayIrelandGroupedRegions(irelandProvinceMapping);
                
                return data;
            });

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#16a085'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isCountyLevel = geoJsonData.features.length > 10;
            const adminType = isCountyLevel ? 'ì¹´ìš´í‹°' : 'í”„ë¡œë¹ˆìŠ¤';
            console.log('ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (4ê°œ í”„ë¡œë¹ˆìŠ¤ë¡œ ê·¸ë£¹í™”)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì•„ì¼ëœë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì•„ì¼ëœë“œ í”„ë¡œë¹ˆìŠ¤ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displayIrelandGroupedRegions(provinceMapping) {
        console.log('\n=== ì•„ì¼ëœë“œ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (4ê°œ í”„ë¡œë¹ˆìŠ¤, 26ê°œ ì¹´ìš´í‹°) ===\n');
        
        // í”„ë¡œë¹ˆìŠ¤ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ì•„ì¼ëœë“œ 4ê°œ í”„ë¡œë¹ˆìŠ¤ (Provinces) ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | í”„ë¡œë¹ˆìŠ¤ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì¹´ìš´í‹° ìˆ˜'.padEnd(15) + '| ì¹´ìš´í‹° ëª©ë¡');
        console.log('â”€'.repeat(95));
        
        // í”„ë¡œë¹ˆìŠ¤ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(provinceMapping).forEach((provinceName, idx) => {
            const province = provinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} (${province.name_ko})`.padEnd(38);
            const countyCount = province.counties.length.toString().padEnd(13);
            const counties = province.counties.join(', ');
            console.log(`${seq} | ${name} | ${countyCount} | ${counties}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalCounties = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Ireland') {
                const province = regionData.province || 'Unknown';
                if (!groupedRegions[province]) {
                    groupedRegions[province] = {
                        name_ko: regionData.province_ko || province,
                        name_en: regionData.province_en || province,
                        counties: []
                    };
                }
                groupedRegions[province].counties.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalCounties++;
            }
        });

        // í”„ë¡œë¹ˆìŠ¤ë³„ë¡œ ì¶œë ¥
        Object.keys(provinceMapping).forEach(provinceName => {
            const province = provinceMapping[provinceName];
            const loadedCounties = groupedRegions[provinceName] || { counties: [] };
            
            console.log(`\nğŸ“Œ ${provinceName} (${province.name_ko})`);
            console.log(`   ì¹´ìš´í‹° ìˆ˜: ì´ ${province.counties.length}ê°œ (ë¡œë“œë¨: ${loadedCounties.counties.length}ê°œ)`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // ì˜ˆìƒ ì¹´ìš´í‹° ëª©ë¡
            province.counties.forEach((countyName, idx) => {
                const loadedCounty = loadedCounties.counties.find(c => 
                    c.name.toLowerCase().includes(countyName.toLowerCase()) ||
                    countyName.toLowerCase().includes(c.name.toLowerCase())
                );
                
                if (loadedCounty) {
                    console.log(`   ${idx + 1}. ${countyName} âœ“`);
                    console.log(`      â””â”€ ë¡œë“œëœ ì´ë¦„: ${loadedCounty.name}`);
                    console.log(`      â””â”€ ì¸êµ¬: ${loadedCounty.population.toLocaleString()}ëª…`);
                    console.log(`      â””â”€ ë©´ì : ${loadedCounty.area.toLocaleString()} kmÂ²`);
                } else {
                    console.log(`   ${idx + 1}. ${countyName} (ë°ì´í„° ì—†ìŒ)`);
                }
            });
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ í”„ë¡œë¹ˆìŠ¤ (Provinces): ${Object.keys(provinceMapping).length}ê°œ`);
        console.log(`   â€¢ ì¹´ìš´í‹° (Counties): ${totalCounties}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateIrelandGroupedHTML(provinceMapping, groupedRegions);
        console.log('%cì•„ì¼ëœë“œ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #16a085; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateIrelandGroupedHTML(provinceMapping, groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #16a085; margin-top: 0;">ì•„ì¼ëœë“œ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (4ê°œ í”„ë¡œë¹ˆìŠ¤, 26ê°œ ì¹´ìš´í‹°)</h3>';
        
        // í”„ë¡œë¹ˆìŠ¤ë³„ ìš”ì•½ í…Œì´ë¸”
        Object.keys(provinceMapping).forEach(provinceName => {
            const province = provinceMapping[provinceName];
            const loadedCounties = groupedRegions[provinceName] || { counties: [] };
            
            html += `<h4 style="color: #16a085; margin-top: 20px;">${provinceName} (${province.name_ko})</h4>`;
            html += `<p style="color: #aaa; margin: 0 0 10px 0; font-size: 12px;">ì¹´ìš´í‹° ìˆ˜: ì´ ${province.counties.length}ê°œ (ë¡œë“œë¨: ${loadedCounties.counties.length}ê°œ)</p>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì¹´ìš´í‹°</th></tr></thead>';
            html += '<tbody>';
            
            province.counties.forEach((countyName, idx) => {
                const loadedCounty = loadedCounties.counties.find(c => 
                    c.name.toLowerCase().includes(countyName.toLowerCase()) ||
                    countyName.toLowerCase().includes(c.name.toLowerCase())
                );
                
                html += `<tr style="border-bottom: 1px solid #333;">`;
                html += `<td style="padding: 8px;">${idx + 1}</td>`;
                html += `<td style="padding: 8px; color: ${loadedCounty ? '#16a085' : '#666'};">
                    ${countyName} ${loadedCounty ? 'âœ“' : '(ë°ì´í„° ì—†ìŒ)'}
                </td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
        });
        
        html += '</div>';
        return html;
    }
    
    async loadPortugalData() {
        const portugalRegions = {
            'lisboa': { name_en: 'Lisboa', name_local: 'Lisboa', name_ko: 'ë¦¬ìŠ¤ë³´ì•„', population: 2300000, area: 2761, aliases: ['lisbon', 'distrito de lisboa'] },
            'porto': { name_en: 'Porto', name_local: 'Porto', name_ko: 'í¬ë¥´íˆ¬', population: 1780000, area: 2395, aliases: ['oporto', 'distrito do porto'] },
            'braga': { name_en: 'Braga', name_local: 'Braga', name_ko: 'ë¸Œë¼ê°€', population: 850000, area: 2673 },
            'aveiro': { name_en: 'Aveiro', name_local: 'Aveiro', name_ko: 'ì•„ë² ì´ë£¨', population: 720000, area: 2808 },
            'setubal': { name_en: 'SetÃºbal', name_local: 'SetÃºbal', name_ko: 'ì„¸íˆ¬ë°œ', population: 910000, area: 5064, aliases: ['setubal'] },
            'leiria': { name_en: 'Leiria', name_local: 'Leiria', name_ko: 'ë ˆì´ë¦¬ì•„', population: 460000, area: 3515 },
            'santarem': { name_en: 'SantarÃ©m', name_local: 'SantarÃ©m', name_ko: 'ì‚°íƒ€ë ˜', population: 420000, area: 6747, aliases: ['santarem'] },
            'coimbra': { name_en: 'Coimbra', name_local: 'Coimbra', name_ko: 'ì½”ì„ë¸Œë¼', population: 420000, area: 3947 },
            'faro': { name_en: 'Faro', name_local: 'Faro', name_ko: 'íŒŒë£¨', population: 460000, area: 4960, aliases: ['algarve'] },
            'viseu': { name_en: 'Viseu', name_local: 'Viseu', name_ko: 'ë¹„ì œìš°', population: 370000, area: 5007 },
            'vila_real': { name_en: 'Vila Real', name_local: 'Vila Real', name_ko: 'ë¹Œë¼ ë ˆì•Œ', population: 185000, area: 4328 },
            'viana_do_castelo': { name_en: 'Viana do Castelo', name_local: 'Viana do Castelo', name_ko: 'ë¹„ì•„ë‚˜ ë‘ ì¹´ìŠ¤í…”ë£¨', population: 240000, area: 2255 },
            'braganca': { name_en: 'BraganÃ§a', name_local: 'BraganÃ§a', name_ko: 'ë¸Œë¼ê°„ì‚¬', population: 120000, area: 6608, aliases: ['braganca'] },
            'guarda': { name_en: 'Guarda', name_local: 'Guarda', name_ko: 'ê³¼ë¥´ë‹¤', population: 140000, area: 5518 },
            'castelo_branco': { name_en: 'Castelo Branco', name_local: 'Castelo Branco', name_ko: 'ì¹´ìŠ¤í…”ë£¨ ë¸Œë‘ì¿ ', population: 170000, area: 6675 },
            'portalegre': { name_en: 'Portalegre', name_local: 'Portalegre', name_ko: 'í¬ë¥´íƒˆë ˆê·¸ë¦¬', population: 115000, area: 6065 },
            'evora': { name_en: 'Ã‰vora', name_local: 'Ã‰vora', name_ko: 'ì—ë³´ë¼', population: 150000, area: 7393, aliases: ['evora'] },
            'beja': { name_en: 'Beja', name_local: 'Beja', name_ko: 'ë² ì', population: 140000, area: 10263 },
            'acores': { name_en: 'Azores', name_local: 'RegiÃ£o AutÃ³noma dos AÃ§ores', name_ko: 'ì•„ì¡°ë ˆìŠ¤ ì œë„', population: 240000, area: 2333, aliases: ['regiao autonoma dos acores', 'acores', 'azores', 'ilha dos acores'] },
            'madeira': { name_en: 'Madeira', name_local: 'RegiÃ£o AutÃ³noma da Madeira', name_ko: 'ë§ˆë°ì´ë¼ ì œë„', population: 260000, area: 801, aliases: ['regiao autonoma da madeira', 'madeira'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'portugal',
            countryName: 'Portugal',
            countryNameKo: 'í¬ë¥´íˆ¬ê°ˆ',
            countryCodeIso: 'PRT',
            defaultColor: '#27ae60',
            adminLevel: 'District / Autonomous Region',
            mapping: portugalRegions
        });
    }
    
    async loadGreeceData() {
        const greeceRegions = {
            'attica': { name_en: 'Attica', name_local: 'Î‘Ï„Ï„Î¹ÎºÎ®', name_ko: 'ì•„í‹°í‚¤', population: 3780000, area: 3808, aliases: ['attiki', 'region of attica'] },
            'central_macedonia': { name_en: 'Central Macedonia', name_local: 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', name_ko: 'ì¤‘ì•™ë§ˆì¼€ë„ë‹ˆì•„', population: 1870000, area: 18810, aliases: ['kentriki makedonia'] },
            'eastern_macedonia_thrace': { name_en: 'Eastern Macedonia and Thrace', name_local: 'Î‘Î½Î±Ï„Î¿Î»Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± ÎºÎ±Î¹ Î˜ÏÎ¬ÎºÎ·', name_ko: 'ë™ë§ˆì¼€ë„ë‹ˆì•„ íŠ¸ë¼í‚¤ì•„', population: 600000, area: 14150, aliases: ['anatoliki makedonia kai thraki'] },
            'western_macedonia': { name_en: 'Western Macedonia', name_local: 'Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', name_ko: 'ì„œë§ˆì¼€ë„ë‹ˆì•„', population: 250000, area: 9450, aliases: ['dytiki makedonia'] },
            'epirus': { name_en: 'Epirus', name_local: 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', name_ko: 'ì´í”¼ë¡œìŠ¤', population: 330000, area: 9200, aliases: ['ipeiros'] },
            'thessaly': { name_en: 'Thessaly', name_local: 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', name_ko: 'í…Œì‚´ë¦¬ì•„', population: 720000, area: 14030, aliases: ['thessalia'] },
            'western_greece': { name_en: 'Western Greece', name_local: 'Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±', name_ko: 'ì„œê·¸ë¦¬ìŠ¤', population: 670000, area: 11300, aliases: ['dytiki ellada'] },
            'central_greece': { name_en: 'Central Greece', name_local: 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', name_ko: 'ì¤‘ë¶€ê·¸ë¦¬ìŠ¤', population: 540000, area: 15500, aliases: ['sterea ellada'] },
            'peloponnese': { name_en: 'Peloponnese', name_local: 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', name_ko: 'í ë¡œí°ë„¤ì†ŒìŠ¤', population: 570000, area: 15490, aliases: ['peloponnisos'] },
            'ionian_islands': { name_en: 'Ionian Islands', name_local: 'Î™ÏŒÎ½Î¹Î± ÎÎ·ÏƒÎ¹Î¬', name_ko: 'ì´ì˜¤ë‹ˆì•„ ì œë„', population: 210000, area: 2300, aliases: ['ionia nisia', 'region of ionian islands'] },
            'north_aegean': { name_en: 'North Aegean', name_local: 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', name_ko: 'ë¶ì—ê²Œ ì œë„', population: 190000, area: 3800, aliases: ['voreio aigaio'] },
            'south_aegean': { name_en: 'South Aegean', name_local: 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', name_ko: 'ë‚¨ì—ê²Œ ì œë„', population: 310000, area: 5900, aliases: ['notio aigaio'] },
            'crete': { name_en: 'Crete', name_local: 'ÎšÏÎ®Ï„Î·', name_ko: 'í¬ë ˆíƒ€', population: 620000, area: 8336, aliases: ['kriti'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'greece',
            countryName: 'Greece',
            countryNameKo: 'ê·¸ë¦¬ìŠ¤',
            countryCodeIso: 'GRC',
            defaultColor: '#2980b9',
            adminLevel: 'Region',
            mapping: greeceRegions
        });
    }
    
    async loadCzechRepublicData() {
        const czechRegions = {
            'prague': { name_en: 'Prague', name_local: 'HlavnÃ­ mÄ›sto Praha', name_ko: 'í”„ë¼í•˜', population: 1360000, area: 496, aliases: ['hlavni mesto praha', 'praha'] },
            'central_bohemian': { name_en: 'Central Bohemian', name_local: 'StÅ™edoÄeskÃ½ kraj', name_ko: 'ì¤‘ë¶€ë³´í—¤ë¯¸ì•„', population: 1450000, area: 10929, aliases: ['stredocesky kraj'] },
            'south_bohemian': { name_en: 'South Bohemian', name_local: 'JihoÄeskÃ½ kraj', name_ko: 'ë‚¨ë¶€ë³´í—¤ë¯¸ì•„', population: 640000, area: 10056, aliases: ['jihocesky kraj'] },
            'plzen': { name_en: 'PlzeÅˆ', name_local: 'PlzeÅˆskÃ½ kraj', name_ko: 'í”Œì  ', population: 580000, area: 7561, aliases: ['plzensky kraj', 'plzen'] },
            'karlovy_vary': { name_en: 'Karlovy Vary', name_local: 'KarlovarskÃ½ kraj', name_ko: 'ì¹´ë¥¼ë¡œë¹„ë°”ë¦¬', population: 290000, area: 3314, aliases: ['karlovarsky kraj'] },
            'usti_nad_labem': { name_en: 'ÃšstÃ­ nad Labem', name_local: 'ÃšsteckÃ½ kraj', name_ko: 'ìš°ìŠ¤í‹°', population: 810000, area: 5335, aliases: ['ustecky kraj', 'usti nad labem'] },
            'liberec': { name_en: 'Liberec', name_local: 'LibereckÃ½ kraj', name_ko: 'ë¦¬ë² ë ˆì¸ ', population: 460000, area: 3163, aliases: ['liberecky kraj'] },
            'hradec_kralove': { name_en: 'Hradec KrÃ¡lovÃ©', name_local: 'KrÃ¡lovÃ©hradeckÃ½ kraj', name_ko: 'íë¼ë°ì¸ í¬ë„ë¡œë² ', population: 550000, area: 4758, aliases: ['kralovehradecky kraj', 'hradec kralove'] },
            'pardubice': { name_en: 'Pardubice', name_local: 'PardubickÃ½ kraj', name_ko: 'íŒŒë¥´ë‘ë¹„ì²´', population: 520000, area: 4519, aliases: ['pardubicky kraj'] },
            'vysocina': { name_en: 'VysoÄina', name_local: 'Kraj VysoÄina', name_ko: 'ë¹„ì†Œì¹˜ë‚˜', population: 505000, area: 6796, aliases: ['kraj vysocina', 'vysocina'] },
            'south_moravian': { name_en: 'South Moravian', name_local: 'JihomoravskÃ½ kraj', name_ko: 'ë‚¨ë¶€ëª¨ë¼ë¹„ì•„', population: 1200000, area: 7196, aliases: ['jihomoravsky kraj'] },
            'olomouc': { name_en: 'Olomouc', name_local: 'OlomouckÃ½ kraj', name_ko: 'ì˜¬ë¡œëª¨ìš°ì¸ ', population: 630000, area: 5206, aliases: ['olomoucky kraj'] },
            'zlin': { name_en: 'ZlÃ­n', name_local: 'ZlÃ­nskÃ½ kraj', name_ko: 'ì¦ë¦°', population: 570000, area: 3964, aliases: ['zlinsky kraj'] },
            'moravian_silesian': { name_en: 'Moravian-Silesian', name_local: 'MoravskoslezskÃ½ kraj', name_ko: 'ëª¨ë¼ë¹„ì•„ìŠ¬ë ˆìŠ¤ì¹´', population: 1160000, area: 5427, aliases: ['moravskoslezsky kraj', 'moravian silesian'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'czech-republic',
            countryName: 'Czech Republic',
            countryNameKo: 'ì²´ì½”',
            countryCodeIso: 'CZE',
            defaultColor: '#8e44ad',
            adminLevel: 'Region (Kraj)',
            mapping: czechRegions
        });
    }
    
    async loadRomaniaData() {
        const romaniaRegions = {
            'alba': { name_en: 'Alba', name_local: 'Alba', name_ko: 'ì•Œë°”', population: 320000, area: 6242 },
            'arad': { name_en: 'Arad', name_local: 'Arad', name_ko: 'ì•„ë¼ë“œ', population: 470000, area: 7754 },
            'arges': { name_en: 'ArgeÈ™', name_local: 'ArgeÈ™', name_ko: 'ì•„ë¥´ì œìŠˆ', population: 610000, area: 6826, aliases: ['arges'] },
            'bacau': { name_en: 'BacÄƒu', name_local: 'BacÄƒu', name_ko: 'ë°”ì»¤ìš°', population: 610000, area: 6621, aliases: ['bacau'] },
            'bihor': { name_en: 'Bihor', name_local: 'Bihor', name_ko: 'ë¹„í˜¸ë¥´', population: 590000, area: 7544 },
            'bistrita_nasaud': { name_en: 'BistriÈ›a-NÄƒsÄƒud', name_local: 'BistriÈ›a-NÄƒsÄƒud', name_ko: 'ë¹„ìŠ¤íŠ¸ë¦¬ì°¨ë„ˆì„œìš°ë“œ', population: 280000, area: 5355, aliases: ['bistrita-nasaud', 'bistrita nasaud'] },
            'botosani': { name_en: 'BotoÈ™ani', name_local: 'BotoÈ™ani', name_ko: 'ë³´í† ìƒ¤ë‹ˆ', population: 370000, area: 4986, aliases: ['botosani'] },
            'brasov': { name_en: 'BraÈ™ov', name_local: 'BraÈ™ov', name_ko: 'ë¸Œë¼ì‡¼ë¸Œ', population: 570000, area: 5363, aliases: ['brasov'] },
            'braila': { name_en: 'BrÄƒila', name_local: 'BrÄƒila', name_ko: 'ë¸ŒëŸ¬ì¼ë¼', population: 300000, area: 4766, aliases: ['braila'] },
            'buzau': { name_en: 'BuzÄƒu', name_local: 'BuzÄƒu', name_ko: 'ë¶€ì €ìš°', population: 430000, area: 6103, aliases: ['buzau'] },
            'caras_severin': { name_en: 'CaraÈ™-Severin', name_local: 'CaraÈ™-Severin', name_ko: 'ì¹´ë¼ìŠˆì„¸ë² ë¦°', population: 270000, area: 8514, aliases: ['caras severin', 'caras-severin'] },
            'calarasi': { name_en: 'CÄƒlÄƒraÈ™i', name_local: 'CÄƒlÄƒraÈ™i', name_ko: 'ì»¬ëŸ¬ë¼ì‹œ', population: 270000, area: 5088, aliases: ['calarasi'] },
            'cluj': { name_en: 'Cluj', name_local: 'Cluj', name_ko: 'í´ë£¨ì§€', population: 740000, area: 6674 },
            'constanta': { name_en: 'ConstanÈ›a', name_local: 'ConstanÈ›a', name_ko: 'ì½˜ìŠ¤íƒ„ì°¨', population: 700000, area: 7071, aliases: ['constanta'] },
            'covasna': { name_en: 'Covasna', name_local: 'Covasna', name_ko: 'ì½”ë°”ìŠ¤ë‚˜', population: 200000, area: 3710 },
            'dambovita': { name_en: 'DÃ¢mboviÈ›a', name_local: 'DÃ¢mboviÈ›a', name_ko: 'ë¤ë³´ë¹„ì°¨', population: 500000, area: 4054, aliases: ['dambovita'] },
            'dolj': { name_en: 'Dolj', name_local: 'Dolj', name_ko: 'ëŒì§€', population: 580000, area: 7414 },
            'galati': { name_en: 'GalaÈ›i', name_local: 'GalaÈ›i', name_ko: 'ê°ˆë¼ì¹˜', population: 530000, area: 4466, aliases: ['galati'] },
            'giurgiu': { name_en: 'Giurgiu', name_local: 'Giurgiu', name_ko: 'ì§€ìš°ë¥´ì§€ìš°', population: 250000, area: 3526 },
            'gorj': { name_en: 'Gorj', name_local: 'Gorj', name_ko: 'ê³ ë¥´ì§€', population: 320000, area: 5602 },
            'harghita': { name_en: 'Harghita', name_local: 'Harghita', name_ko: 'í•˜ë¥´ê¸°íƒ€', population: 280000, area: 6639 },
            'hunedoara': { name_en: 'Hunedoara', name_local: 'Hunedoara', name_ko: 'í›„ë„¤ë„ì•„ë¼', population: 380000, area: 7063 },
            'ialomita': { name_en: 'IalomiÈ›a', name_local: 'IalomiÈ›a', name_ko: 'ì´ì•Œë¡œë¯¸ì°¨', population: 250000, area: 4453, aliases: ['ialomita'] },
            'iasi': { name_en: 'IaÈ™i', name_local: 'IaÈ™i', name_ko: 'ì•¼ì‹œ', population: 750000, area: 5476, aliases: ['iasi'] },
            'ilfov': { name_en: 'Ilfov', name_local: 'Ilfov', name_ko: 'ì¼í¬ë¸Œ', population: 550000, area: 1583 },
            'maramures': { name_en: 'MaramureÈ™', name_local: 'MaramureÈ™', name_ko: 'ë§ˆë¼ë¬´ë ˆìŠˆ', population: 470000, area: 6304, aliases: ['maramures'] },
            'mehedinti': { name_en: 'MehedinÈ›i', name_local: 'MehedinÈ›i', name_ko: 'ë©”í—¤ë”˜ì¹˜', population: 260000, area: 4933, aliases: ['mehedinti'] },
            'mures': { name_en: 'MureÈ™', name_local: 'MureÈ™', name_ko: 'ë¬´ë ˆìŠˆ', population: 540000, area: 6714, aliases: ['mures'] },
            'neamt': { name_en: 'NeamÈ›', name_local: 'NeamÈ›', name_ko: 'ë„¤ì•”ì¸ ', population: 470000, area: 5896, aliases: ['neamt'] },
            'olt': { name_en: 'Olt', name_local: 'Olt', name_ko: 'ì˜¬íŠ¸', population: 420000, area: 5498 },
            'prahova': { name_en: 'Prahova', name_local: 'Prahova', name_ko: 'í”„ë¼í˜¸ë°”', population: 800000, area: 4716 },
            'satu_mare': { name_en: 'Satu Mare', name_local: 'Satu Mare', name_ko: 'ì‚¬íˆ¬ë§ˆë ˆ', population: 330000, area: 4418 },
            'salaj': { name_en: 'SÄƒlaj', name_local: 'SÄƒlaj', name_ko: 'ì„¤ë¼ì£¼', population: 200000, area: 3850, aliases: ['salaj'] },
            'sibiu': { name_en: 'Sibiu', name_local: 'Sibiu', name_ko: 'ì‹œë¹„ìš°', population: 410000, area: 5432 },
            'suceava': { name_en: 'Suceava', name_local: 'Suceava', name_ko: 'ìˆ˜ì²´ì•„ë°”', population: 620000, area: 8553 },
            'teleorman': { name_en: 'Teleorman', name_local: 'Teleorman', name_ko: 'í…”ë ˆì˜¤ë¥´ë§Œ', population: 320000, area: 5790 },
            'timis': { name_en: 'TimiÈ™', name_local: 'TimiÈ™', name_ko: 'í‹°ë¯¸ìŠˆ', population: 760000, area: 8697, aliases: ['timis'] },
            'tulcea': { name_en: 'Tulcea', name_local: 'Tulcea', name_ko: 'íˆ´ì²´ì•„', population: 200000, area: 8499 },
            'vaslui': { name_en: 'Vaslui', name_local: 'Vaslui', name_ko: 'ë°”ìŠ¬ë£¨ì´', population: 370000, area: 5318 },
            'valcea': { name_en: 'VÃ¢lcea', name_local: 'VÃ¢lcea', name_ko: 'ë¸”ì²´ì•„', population: 370000, area: 5768, aliases: ['valcea'] },
            'vrancea': { name_en: 'Vrancea', name_local: 'Vrancea', name_ko: 'ë¸Œë€ì²´ì•„', population: 330000, area: 4857 },
            'bucharest': { name_en: 'Bucharest', name_local: 'Municipiul BucureÈ™ti', name_ko: 'ë¶€ì¿ ë ˆìŠˆí‹°', population: 1700000, area: 228, aliases: ['municipiul bucuresti', 'bucuresti', 'bucharest'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'romania',
            countryName: 'Romania',
            countryNameKo: 'ë£¨ë§ˆë‹ˆì•„',
            countryCodeIso: 'ROU',
            defaultColor: '#c0392b',
            adminLevel: 'County (JudeÈ›)',
            mapping: romaniaRegions
        });
    }
    
    // í—ê°€ë¦¬ ë°ì´í„° ë¡œë“œ (20ê°œ ì£¼)
    async loadHungaryData() {
        const hungaryRegions = {
            'budapest': { name_en: 'Budapest', name_local: 'Budapest', name_ko: 'ë¶€ë‹¤í˜ìŠ¤íŠ¸', population: 1720000, area: 525, admin_level: 'Capital City', aliases: ['budapest fovaros', 'budapest fÅ‘vÃ¡ros'] },
            'bacs_kiskun': { name_en: 'BÃ¡cs-Kiskun', name_local: 'BÃ¡cs-Kiskun', name_ko: 'ë²„ì¹˜í‚¤ìŠˆì¿¤', population: 490000, area: 8445, aliases: ['bacs-kiskun', 'bacs kiskun'] },
            'baranya': { name_en: 'Baranya', name_local: 'Baranya', name_ko: 'ë²„ëŸ¬ë…€', population: 360000, area: 4430 },
            'bekes': { name_en: 'BÃ©kÃ©s', name_local: 'BÃ©kÃ©s', name_ko: 'ë² ì¼€ì‹œ', population: 330000, area: 5630, aliases: ['bekes'] },
            'borsod_abauj_zemplen': { name_en: 'Borsod-AbaÃºj-ZemplÃ©n', name_local: 'Borsod-AbaÃºj-ZemplÃ©n', name_ko: 'ë³´ë¥´ì‡¼ë“œì–´ë²„ìš°ì´ì  í”Œë Œ', population: 630000, area: 7247, aliases: ['borsod-abauj-zemplen', 'borsod abauj zemplen'] },
            'csongrad_csanad': { name_en: 'CsongrÃ¡d-CsanÃ¡d', name_local: 'CsongrÃ¡d-CsanÃ¡d', name_ko: 'ì´Œê·¸ë¼ë“œ-ì°¨ë‚˜ë“œ', population: 390000, area: 4263, aliases: ['csongrad-csanad', 'csongrad csanad', 'csongrad'] },
            'fejer': { name_en: 'FejÃ©r', name_local: 'FejÃ©r', name_ko: 'í˜ì˜ˆë¥´', population: 420000, area: 4358, aliases: ['fejer'] },
            'gyor_moson_sopron': { name_en: 'GyÅ‘r-Moson-Sopron', name_local: 'GyÅ‘r-Moson-Sopron', name_ko: 'ì£„ë¥´-ëª¨ìˆ€-ì‡¼í”„ë¡ ', population: 480000, area: 4208, aliases: ['gyor-moson-sopron', 'gyor moson sopron'] },
            'hajdu_bihar': { name_en: 'HajdÃº-Bihar', name_local: 'HajdÃº-Bihar', name_ko: 'í•˜ì´ë‘ë¹„í—ˆë¥´', population: 530000, area: 6210, aliases: ['hajdu-bihar', 'hajdu bihar'] },
            'heves': { name_en: 'Heves', name_local: 'Heves', name_ko: 'í—¤ë² ì‹œ', population: 280000, area: 3637 },
            'jasz_nagykun_szolnok': { name_en: 'JÃ¡sz-Nagykun-Szolnok', name_local: 'JÃ¡sz-Nagykun-Szolnok', name_ko: 'ì•¼ìŠ¤ë„ˆì§€ì¿¤ì†”ë…¸í¬', population: 360000, area: 5582, aliases: ['jasz-nagykun-szolnok', 'jasz nagykun szolnok'] },
            'komarom_esztergom': { name_en: 'KomÃ¡rom-Esztergom', name_local: 'KomÃ¡rom-Esztergom', name_ko: 'ì½”ë§ˆë¡¬-ì—ìŠ¤í…Œë¥´ê³°', population: 300000, area: 2265, aliases: ['komarom-esztergom', 'komarom esztergom'] },
            'nograd': { name_en: 'NÃ³grÃ¡d', name_local: 'NÃ³grÃ¡d', name_ko: 'ë…¸ê·¸ë¼ë“œ', population: 180000, area: 2544, aliases: ['nograd'] },
            'pest': { name_en: 'Pest', name_local: 'Pest', name_ko: 'í˜ìŠˆíŠ¸', population: 1350000, area: 6394 },
            'somogy': { name_en: 'Somogy', name_local: 'Somogy', name_ko: 'ì‡¼ë¨¸ì§€', population: 280000, area: 6036 },
            'szabolcs_szatmar_bereg': { name_en: 'Szabolcs-SzatmÃ¡r-Bereg', name_local: 'Szabolcs-SzatmÃ¡r-Bereg', name_ko: 'ì„œë³¼ì¸ -ì„œíŠ¸ë¨¸ë¥´-ë² ë ˆê·¸', population: 525000, area: 5935, aliases: ['szabolcs-szatmar-bereg', 'szabolcs szatmar bereg'] },
            'tolna': { name_en: 'Tolna', name_local: 'Tolna', name_ko: 'í†¨ë„ˆ', population: 210000, area: 3703 },
            'vas': { name_en: 'Vas', name_local: 'Vas', name_ko: 'ë²„ì‹œ', population: 250000, area: 3336 },
            'veszprem': { name_en: 'VeszprÃ©m', name_local: 'VeszprÃ©m', name_ko: 'ë² ìŠ¤í”„ë ˜', population: 340000, area: 4463, aliases: ['veszprem'] },
            'zala': { name_en: 'Zala', name_local: 'Zala', name_ko: 'ì¡¸ëŸ¬', population: 260000, area: 3784 }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'hungary',
            countryName: 'Hungary',
            countryNameKo: 'í—ê°€ë¦¬',
            countryCodeIso: 'HUN',
            defaultColor: '#d35400',
            adminLevel: 'County (Megye)',
            mapping: hungaryRegions
        });
    }

    async loadBulgariaData() {
        const bulgariaRegions = {
            'sofia_capital': { name_en: 'Sofia (Capital)', name_local: 'Ğ¡Ğ¾Ñ„Ğ¸Ñ-Ğ³Ñ€Ğ°Ğ´', name_ko: 'ì†Œí”¼ì•„ ì‹œ', population: 1310000, area: 1349, admin_level: 'Capital Municipality', aliases: ['sofia grad', 'sofia-city', 'sofia city'] },
            'sofia_province': { name_en: 'Sofia Province', name_local: 'Ğ¡Ğ¾Ñ„Ğ¸Ğ¹ÑĞºĞ° Ğ¾Ğ±Ğ»Ğ°ÑÑ‚', name_ko: 'ì†Œí”¼ì•„ ì£¼', population: 220000, area: 7059, aliases: ['sofiyska oblast', 'sofia oblast'] },
            'plovdiv': { name_en: 'Plovdiv', name_local: 'ĞŸĞ»Ğ¾Ğ²Ğ´Ğ¸Ğ²', name_ko: 'í”Œë¡œë¸Œë””í”„', population: 620000, area: 5972 },
            'varna': { name_en: 'Varna', name_local: 'Ğ’Ğ°Ñ€Ğ½Ğ°', name_ko: 'ë°”ë¥´ë‚˜', population: 470000, area: 3819 },
            'burgas': { name_en: 'Burgas', name_local: 'Ğ‘ÑƒÑ€Ğ³Ğ°Ñ', name_ko: 'ë¶€ë¥´ê°€ìŠ¤', population: 390000, area: 7748 },
            'stara_zagora': { name_en: 'Stara Zagora', name_local: 'Ğ¡Ñ‚Ğ°Ñ€Ğ° Ğ—Ğ°Ğ³Ğ¾Ñ€Ğ°', name_ko: 'ìŠ¤íƒ€ë¼ìê³ ë¼', population: 300000, area: 5151, aliases: ['stara zagora'] },
            'blagoevgrad': { name_en: 'Blagoevgrad', name_local: 'Ğ‘Ğ»Ğ°Ğ³Ğ¾ĞµĞ²Ğ³Ñ€Ğ°Ğ´', name_ko: 'ë¸”ë¼ê³ ì—ë¸Œê·¸ë¼ë“œ', population: 280000, area: 6449 },
            'pleven': { name_en: 'Pleven', name_local: 'ĞŸĞ»ĞµĞ²ĞµĞ½', name_ko: 'í”Œë ˆë²¤', population: 240000, area: 4653 },
            'sliven': { name_en: 'Sliven', name_local: 'Ğ¡Ğ»Ğ¸Ğ²ĞµĞ½', name_ko: 'ìŠ¬ë¦¬ë²¤', population: 180000, area: 3554 },
            'dobrich': { name_en: 'Dobrich', name_local: 'Ğ”Ğ¾Ğ±Ñ€Ğ¸Ñ‡', name_ko: 'ë„ë¸Œë¦¬ì¹˜', population: 160000, area: 4719 },
            'veliko_tarnovo': { name_en: 'Veliko Tarnovo', name_local: 'Ğ’ĞµĞ»Ğ¸ĞºĞ¾ Ğ¢ÑŠÑ€Ğ½Ğ¾Ğ²Ğ¾', name_ko: 'ë²¨ë¦¬ì½”í„°ë¥´ë…¸ë³´', population: 220000, area: 4662, aliases: ['veliko tarnovo', 'veliko turnovo'] },
            'haskovo': { name_en: 'Haskovo', name_local: 'Ğ¥Ğ°ÑĞºĞ¾Ğ²Ğ¾', name_ko: 'í•˜ìŠ¤ì½”ë³´', population: 210000, area: 5543 },
            'shumen': { name_en: 'Shumen', name_local: 'Ğ¨ÑƒĞ¼ĞµĞ½', name_ko: 'ìŠˆë©˜', population: 170000, area: 3389 },
            'yambol': { name_en: 'Yambol', name_local: 'Ğ¯Ğ¼Ğ±Ğ¾Ğ»', name_ko: 'ì–Œë³¼', population: 110000, area: 3333 },
            'ruse': { name_en: 'Ruse', name_local: 'Ğ ÑƒÑĞµ', name_ko: 'ë£¨ì„¸', population: 200000, area: 2621, aliases: ['rousse', 'ruse'] },
            'pernik': { name_en: 'Pernik', name_local: 'ĞŸĞµÑ€Ğ½Ğ¸Ğº', name_ko: 'í˜ë¥´ë‹ˆí¬', population: 110000, area: 2392 },
            'kyustendil': { name_en: 'Kyustendil', name_local: 'ĞšÑÑÑ‚ĞµĞ½Ğ´Ğ¸Ğ»', name_ko: 'íìŠ¤í…ë”œ', population: 115000, area: 3084, aliases: ['kyustendil', 'kjustendil'] },
            'gabrovo': { name_en: 'Gabrovo', name_local: 'Ğ“Ğ°Ğ±Ñ€Ğ¾Ğ²Ğ¾', name_ko: 'ê°€ë¸Œë¡œë³´', population: 100000, area: 2023 },
            'montana': { name_en: 'Montana', name_local: 'ĞœĞ¾Ğ½Ñ‚Ğ°Ğ½Ğ°', name_ko: 'ëª¬íƒ€ë‚˜', population: 125000, area: 3635 },
            'vratsa': { name_en: 'Vratsa', name_local: 'Ğ’Ñ€Ğ°Ñ†Ğ°', name_ko: 'ë¸Œë¼ì°¨', population: 155000, area: 3619 },
            'vidin': { name_en: 'Vidin', name_local: 'Ğ’Ğ¸Ğ´Ğ¸Ğ½', name_ko: 'ë¹„ë”˜', population: 80000, area: 3032 },
            'lovech': { name_en: 'Lovech', name_local: 'Ğ›Ğ¾Ğ²ĞµÑ‡', name_ko: 'ë¡œë² ì¹˜', population: 120000, area: 4128 },
            'targovishte': { name_en: 'Targovishte', name_local: 'Ğ¢ÑŠÑ€Ğ³Ğ¾Ğ²Ğ¸Ñ‰Ğµ', name_ko: 'í„°ë¥´ê³ ë¹„ì‰¬í…Œ', population: 110000, area: 2716, aliases: ['targovishte', 'turgovishte'] },
            'razgrad': { name_en: 'Razgrad', name_local: 'Ğ Ğ°Ğ·Ğ³Ñ€Ğ°Ğ´', name_ko: 'ë¼ì¦ˆê·¸ë¼ë“œ', population: 110000, area: 2639 },
            'silistra': { name_en: 'Silistra', name_local: 'Ğ¡Ğ¸Ğ»Ğ¸ÑÑ‚Ñ€Ğ°', name_ko: 'ì‹¤ë¦¬ìŠ¤íŠ¸ë¼', population: 105000, area: 2846 },
            'smolyan': { name_en: 'Smolyan', name_local: 'Ğ¡Ğ¼Ğ¾Ğ»ÑĞ½', name_ko: 'ìŠ¤ëª°ë¸', population: 100000, area: 3193, aliases: ['smoljan'] },
            'kardzhali': { name_en: 'Kardzhali', name_local: 'ĞšÑŠÑ€Ğ´Ğ¶Ğ°Ğ»Ğ¸', name_ko: 'ì»¤ë¥´ì˜ë¦¬', population: 150000, area: 3209, aliases: ['kardjali', 'kurdzhali'] },
            'pazardzhik': { name_en: 'Pazardzhik', name_local: 'ĞŸĞ°Ğ·Ğ°Ñ€Ğ´Ğ¶Ğ¸Ğº', name_ko: 'íŒŒìë¥´ì§€í¬', population: 270000, area: 4480, aliases: ['pazardjik', 'pazardzhik'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'bulgaria',
            countryName: 'Bulgaria',
            countryNameKo: 'ë¶ˆê°€ë¦¬ì•„',
            countryCodeIso: 'BGR',
            defaultColor: '#7f8c8d',
            adminLevel: 'Province (Oblast)',
            mapping: bulgariaRegions
        });
    }

    async loadKoreaData() {
        try {
            const geoJsonData = await this.loadGeoJsonWithCache('korea', async () => {
                // ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ
                const koreaUrl = this.getAssetUrl('data/korea-cities-official.geojson');
                console.log('[loadKoreaData] ë„¤íŠ¸ì›Œí¬ì—ì„œ ë¡œë“œ:', koreaUrl);
                const response = await fetch(koreaUrl, { cache: 'no-store' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[loadKoreaData] HTTP ì—ëŸ¬:', response.status, response.statusText);
                    console.error('[loadKoreaData] ì‘ë‹µ ë‚´ìš©:', errorText.substring(0, 200));
                    throw new Error(`í•œêµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: HTTP ${response.status} ${response.statusText}`);
                }
                
                const geoJsonData = await response.json();
                
                // í•œêµ­ í–‰ì •êµ¬ì—­ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const koreaRegionData = {
                    // ì„œìš¸íŠ¹ë³„ì‹œ
                    'ì¢…ë¡œêµ¬': { population: 139272, area: 23.91 },
                    'ì¤‘êµ¬': { population: 123766, area: 9.96 },
                    'ìš©ì‚°êµ¬': { population: 235326, area: 21.87 },
                    'ì„±ë™êµ¬': { population: 286490, area: 16.85 },
                    'ê´‘ì§„êµ¬': { population: 342710, area: 17.06 },
                    'ë™ëŒ€ë¬¸êµ¬': { population: 342715, area: 14.22 },
                    'ì¤‘ë‘êµ¬': { population: 394214, area: 18.50 },
                    'ì„±ë¶êµ¬': { population: 440186, area: 24.57 },
                    'ê°•ë¶êµ¬': { population: 298527, area: 23.60 },
                    'ë„ë´‰êµ¬': { population: 316856, area: 20.71 },
                    'ë…¸ì›êµ¬': { population: 540540, area: 35.44 },
                    'ì€í‰êµ¬': { population: 456023, area: 29.71 },
                    'ì„œëŒ€ë¬¸êµ¬': { population: 312823, area: 17.62 },
                    'ë§ˆí¬êµ¬': { population: 374756, area: 23.86 },
                    'ì–‘ì²œêµ¬': { population: 438640, area: 17.41 },
                    'ê°•ì„œêµ¬': { population: 565785, area: 41.44 },
                    'êµ¬ë¡œêµ¬': { population: 409129, area: 20.12 },
                    'ê¸ˆì²œêµ¬': { population: 238168, area: 13.01 },
                    'ì˜ë“±í¬êµ¬': { population: 385291, area: 24.56 },
                    'ë™ì‘êµ¬': { population: 392823, area: 16.36 },
                    'ê´€ì•…êµ¬': { population: 500005, area: 29.57 },
                    'ì„œì´ˆêµ¬': { population: 405407, area: 47.00 },
                    'ê°•ë‚¨êµ¬': { population: 537294, area: 39.55 },
                    'ì†¡íŒŒêµ¬': { population: 655238, area: 33.89 },
                    'ê°•ë™êµ¬': { population: 453970, area: 24.59 },
                    // ë¶€ì‚°ê´‘ì—­ì‹œ
                    'ë¶€ì‚° ì¤‘êµ¬': { population: 38423, area: 2.84 },
                    'ë¶€ì‚° ì„œêµ¬': { population: 98703, area: 14.15 },
                    'ë¶€ì‚° ë™êµ¬': { population: 82653, area: 9.77 },
                    'ì˜ë„êµ¬': { population: 114202, area: 14.15 },
                    'ë¶€ì‚°ì§„êµ¬': { population: 343091, area: 29.70 },
                    'ë™ë˜êµ¬': { population: 259604, area: 16.63 },
                    'ë¶€ì‚° ë‚¨êµ¬': { population: 270264, area: 26.81 },
                    'ë¶€ì‚° ë¶êµ¬': { population: 301908, area: 39.37 },
                    'í•´ìš´ëŒ€êµ¬': { population: 397996, area: 51.41 },
                    'ì‚¬í•˜êµ¬': { population: 309070, area: 40.64 },
                    'ê¸ˆì •êµ¬': { population: 227568, area: 65.19 },
                    'ë¶€ì‚° ê°•ì„œêµ¬': { population: 169059, area: 181.58 },
                    'ì—°ì œêµ¬': { population: 214771, area: 12.38 },
                    'ìˆ˜ì˜êµ¬': { population: 171423, area: 10.16 },
                    'ì‚¬ìƒêµ¬': { population: 213193, area: 35.56 },
                    'ê¸°ì¥êµ°': { population: 169799, area: 218.02 },
                    // ëŒ€êµ¬ê´‘ì—­ì‹œ
                    'ëŒ€êµ¬ ì¤‘êµ¬': { population: 69595, area: 7.06 },
                    'ëŒ€êµ¬ ë™êµ¬': { population: 345558, area: 182.35 },
                    'ëŒ€êµ¬ ì„œêµ¬': { population: 169819, area: 17.32 },
                    'ëŒ€êµ¬ ë‚¨êµ¬': { population: 131412, area: 17.43 },
                    'ëŒ€êµ¬ ë¶êµ¬': { population: 432714, area: 93.99 },
                    'ìˆ˜ì„±êµ¬': { population: 418466, area: 76.54 },
                    'ë‹¬ì„œêµ¬': { population: 567112, area: 62.35 },
                    'ë‹¬ì„±êµ°': { population: 278185, area: 426.16 },
                    // ì¸ì²œê´‘ì—­ì‹œ
                    'ì¸ì²œ ì¤‘êµ¬': { population: 139047, area: 128.17 },
                    'ì¸ì²œ ë™êµ¬': { population: 63152, area: 7.19 },
                    'ë¯¸ì¶”í™€êµ¬': { population: 377101, area: 24.38 },
                    'ì—°ìˆ˜êµ¬': { population: 385676, area: 50.77 },
                    'ë‚¨ë™êµ¬': { population: 534299, area: 57.99 },
                    'ë¶€í‰êµ¬': { population: 532184, area: 32.91 },
                    'ê³„ì–‘êµ¬': { population: 310581, area: 45.61 },
                    'ì¸ì²œ ì„œêµ¬': { population: 642268, area: 122.49 },
                    'ê°•í™”êµ°': { population: 69500, area: 411.35 },
                    'ì˜¹ì§„êµ°': { population: 20800, area: 1141.19 },
                    // ê´‘ì£¼ê´‘ì—­ì‹œ
                    'ê´‘ì£¼ ë™êµ¬': { population: 93284, area: 48.31 },
                    'ê´‘ì£¼ ì„œêµ¬': { population: 208347, area: 47.83 },
                    'ê´‘ì£¼ ë‚¨êµ¬': { population: 213655, area: 61.14 },
                    'ê´‘ì£¼ ë¶êµ¬': { population: 440297, area: 92.56 },
                    'ê´‘ì‚°êµ¬': { population: 434509, area: 222.89 },
                    // ëŒ€ì „ê´‘ì—­ì‹œ
                    'ëŒ€ì „ ë™êµ¬': { population: 189176, area: 136.61 },
                    'ëŒ€ì „ ì¤‘êµ¬': { population: 230245, area: 62.09 },
                    'ëŒ€ì „ ì„œêµ¬': { population: 493225, area: 95.35 },
                    'ìœ ì„±êµ¬': { population: 362377, area: 176.47 },
                    'ëŒ€ë•êµ¬': { population: 166249, area: 68.27 },
                    // ìš¸ì‚°ê´‘ì—­ì‹œ
                    'ìš¸ì‚° ì¤‘êµ¬': { population: 205018, area: 37.18 },
                    'ìš¸ì‚° ë‚¨êµ¬': { population: 341218, area: 72.06 },
                    'ìš¸ì‚° ë™êµ¬': { population: 167280, area: 36.94 },
                    'ìš¸ì‚° ë¶êµ¬': { population: 212050, area: 80.31 },
                    'ìš¸ì£¼êµ°': { population: 236680, area: 733.14 },
                    // ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ
                    'ì„¸ì¢…ì‹œ': { population: 396141, area: 465.23 },
                    // ê²½ê¸°ë„
                    'ìˆ˜ì›ì‹œì¥ì•ˆêµ¬': { population: 281250, area: 36.06 },
                    'ìˆ˜ì›ì‹œê¶Œì„ êµ¬': { population: 351590, area: 47.10 },
                    'ìˆ˜ì›ì‹œíŒ”ë‹¬êµ¬': { population: 174390, area: 22.76 },
                    'ìˆ˜ì›ì‹œì˜í†µêµ¬': { population: 393808, area: 26.65 },
                    'ì„±ë‚¨ì‹œìˆ˜ì •êµ¬': { population: 240471, area: 42.86 },
                    'ì„±ë‚¨ì‹œì¤‘ì›êµ¬': { population: 221787, area: 28.03 },
                    'ì„±ë‚¨ì‹œë¶„ë‹¹êµ¬': { population: 445109, area: 66.73 },
                    'ì˜ì •ë¶€ì‹œ': { population: 446070, area: 81.53 },
                    'ì•ˆì–‘ì‹œë§Œì•ˆêµ¬': { population: 186421, area: 16.58 },
                    'ì•ˆì–‘ì‹œë™ì•ˆêµ¬': { population: 345620, area: 36.43 },
                    'ë¶€ì²œì‹œ': { population: 789655, area: 53.44 },
                    'ê´‘ëª…ì‹œ': { population: 309756, area: 38.45 },
                    'í‰íƒì‹œ': { population: 583626, area: 452.54 },
                    'ë™ë‘ì²œì‹œ': { population: 95413, area: 95.67 },
                    'ì•ˆì‚°ì‹œìƒë¡êµ¬': { population: 365482, area: 57.31 },
                    'ì•ˆì‚°ì‹œë‹¨ì›êµ¬': { population: 358978, area: 57.35 },
                    'ê³ ì–‘ì‹œë•ì–‘êµ¬': { population: 495325, area: 165.53 },
                    'ê³ ì–‘ì‹œì¼ì‚°ë™êµ¬': { population: 288620, area: 58.89 },
                    'ê³ ì–‘ì‹œì¼ì‚°ì„œêµ¬': { population: 302344, area: 58.89 },
                    'ê³¼ì²œì‹œ': { population: 58412, area: 35.87 },
                    'êµ¬ë¦¬ì‹œ': { population: 185187, area: 33.29 },
                    'ë‚¨ì–‘ì£¼ì‹œ': { population: 754213, area: 458.22 },
                    'ì˜¤ì‚°ì‹œ': { population: 242683, area: 42.74 },
                    'ì‹œí¥ì‹œ': { population: 567198, area: 131.82 },
                    'êµ°í¬ì‹œ': { population: 262667, area: 36.39 },
                    'ì˜ì™•ì‹œ': { population: 169839, area: 54.10 },
                    'í•˜ë‚¨ì‹œ': { population: 366455, area: 93.04 },
                    'ìš©ì¸ì‹œì²˜ì¸êµ¬': { population: 304061, area: 591.25 },
                    'ìš©ì¸ì‹œê¸°í¥êµ¬': { population: 528543, area: 84.46 },
                    'ìš©ì¸ì‹œìˆ˜ì§€êµ¬': { population: 390258, area: 42.38 },
                    'íŒŒì£¼ì‹œ': { population: 514337, area: 672.84 },
                    'ì´ì²œì‹œ': { population: 227452, area: 461.30 },
                    'ì•ˆì„±ì‹œ': { population: 182049, area: 554.20 },
                    'ê¹€í¬ì‹œ': { population: 514880, area: 276.60 },
                    'í™”ì„±ì‹œ': { population: 1011366, area: 845.19 },
                    'ê´‘ì£¼ì‹œ': { population: 396487, area: 431.16 },
                    'ì–‘ì£¼ì‹œ': { population: 235743, area: 310.04 },
                    'í¬ì²œì‹œ': { population: 148682, area: 826.89 },
                    'ì—¬ì£¼ì‹œ': { population: 117456, area: 608.02 },
                    'ì—°ì²œêµ°': { population: 44135, area: 675.22 },
                    'ê°€í‰êµ°': { population: 59202, area: 843.77 },
                    'ì–‘í‰êµ°': { population: 118180, area: 877.43 },
                    // ê°•ì›íŠ¹ë³„ìì¹˜ë„
                    'ì¶˜ì²œì‹œ': { population: 285280, area: 1116.44 },
                    'ì›ì£¼ì‹œ': { population: 374640, area: 867.36 },
                    'ê°•ë¦‰ì‹œ': { population: 213587, area: 1040.78 },
                    'ë™í•´ì‹œ': { population: 90622, area: 180.48 },
                    'íƒœë°±ì‹œ': { population: 39021, area: 303.53 },
                    'ì†ì´ˆì‹œ': { population: 81692, area: 105.43 },
                    'ì‚¼ì²™ì‹œ': { population: 63318, area: 1185.86 },
                    'í™ì²œêµ°': { population: 67825, area: 1819.00 },
                    'íš¡ì„±êµ°': { population: 44986, area: 920.94 },
                    'ì˜ì›”êµ°': { population: 35178, area: 1127.36 },
                    'í‰ì°½êµ°': { population: 38964, area: 1464.14 },
                    'ì •ì„ êµ°': { population: 33693, area: 1219.02 },
                    'ì² ì›êµ°': { population: 43204, area: 889.51 },
                    'í™”ì²œêµ°': { population: 23912, area: 909.48 },
                    'ì–‘êµ¬êµ°': { population: 21332, area: 701.19 },
                    'ì¸ì œêµ°': { population: 33055, area: 1646.56 },
                    'ê³ ì„±êµ°': { population: 26442, area: 664.68 },
                    'ì–‘ì–‘êµ°': { population: 27378, area: 630.56 },
                    // ì¶©ì²­ë¶ë„
                    'ì²­ì£¼ì‹œìƒë‹¹êµ¬': { population: 195024, area: 404.49 },
                    'ì²­ì£¼ì‹œì„œì›êµ¬': { population: 256011, area: 122.17 },
                    'ì²­ì£¼ì‹œí¥ë•êµ¬': { population: 310884, area: 209.54 },
                    'ì²­ì£¼ì‹œì²­ì›êµ¬': { population: 203531, area: 214.99 },
                    'ì¶©ì£¼ì‹œ': { population: 211703, area: 983.84 },
                    'ì œì²œì‹œ': { population: 131977, area: 882.47 },
                    'ë³´ì€êµ°': { population: 29187, area: 584.13 },
                    'ì˜¥ì²œêµ°': { population: 48416, area: 537.65 },
                    'ì˜ë™êµ°': { population: 45162, area: 846.15 },
                    'ì§„ì²œêµ°': { population: 93407, area: 406.65 },
                    'ê´´ì‚°êµ°': { population: 35916, area: 849.87 },
                    'ìŒì„±êµ°': { population: 97311, area: 520.84 },
                    'ë‹¨ì–‘êµ°': { population: 28662, area: 781.06 },
                    'ì¦í‰êµ°': { population: 36210, area: 81.84 },
                    // ì¶©ì²­ë‚¨ë„
                    'ì²œì•ˆì‹œë™ë‚¨êµ¬': { population: 332674, area: 636.22 },
                    'ì²œì•ˆì‹œì„œë¶êµ¬': { population: 493320, area: 401.43 },
                    'ê³µì£¼ì‹œ': { population: 113452, area: 864.11 },
                    'ë³´ë ¹ì‹œ': { population: 104293, area: 569.54 },
                    'ì•„ì‚°ì‹œ': { population: 352616, area: 542.25 },
                    'ì„œì‚°ì‹œ': { population: 177293, area: 741.32 },
                    'ë…¼ì‚°ì‹œ': { population: 114668, area: 554.09 },
                    'ê³„ë£¡ì‹œ': { population: 44928, area: 60.74 },
                    'ë‹¹ì§„ì‹œ': { population: 171149, area: 703.68 },
                    'ê¸ˆì‚°êµ°': { population: 50803, area: 573.54 },
                    'ë¶€ì—¬êµ°': { population: 59010, area: 624.57 },
                    'ì„œì²œêµ°': { population: 49001, area: 359.49 },
                    'ì²­ì–‘êµ°': { population: 29689, area: 479.57 },
                    'í™ì„±êµ°': { population: 94210, area: 443.09 },
                    'ì˜ˆì‚°êµ°': { population: 82391, area: 542.46 },
                    'íƒœì•ˆêµ°': { population: 62075, area: 503.48 },
                    // ì „ë¶íŠ¹ë³„ìì¹˜ë„
                    'ì „ì£¼ì‹œì™„ì‚°êµ¬': { population: 335912, area: 105.29 },
                    'ì „ì£¼ì‹œë•ì§„êµ¬': { population: 287848, area: 81.62 },
                    'êµ°ì‚°ì‹œ': { population: 263044, area: 402.20 },
                    'ìµì‚°ì‹œ': { population: 276497, area: 506.36 },
                    'ì •ìì‹œ': { population: 103965, area: 692.74 },
                    'ë‚¨ì›ì‹œ': { population: 78697, area: 752.69 },
                    'ê¹€ì œì‹œ': { population: 83981, area: 545.94 },
                    'ì™„ì£¼êµ°': { population: 95707, area: 821.07 },
                    'ì§„ì•ˆêµ°': { population: 23434, area: 789.38 },
                    'ë¬´ì£¼êµ°': { population: 24612, area: 631.54 },
                    'ì¥ìˆ˜êµ°': { population: 19469, area: 534.31 },
                    'ì„ì‹¤êµ°': { population: 24317, area: 596.93 },
                    'ìˆœì°½êµ°': { population: 26155, area: 495.74 },
                    'ê³ ì°½êµ°': { population: 52804, area: 608.27 },
                    'ë¶€ì•ˆêµ°': { population: 53994, area: 493.27 },
                    // ì „ë¼ë‚¨ë„
                    'ëª©í¬ì‹œ': { population: 217669, area: 50.12 },
                    'ì—¬ìˆ˜ì‹œ': { population: 271487, area: 512.29 },
                    'ìˆœì²œì‹œ': { population: 275334, area: 910.94 },
                    'ë‚˜ì£¼ì‹œ': { population: 118318, area: 608.22 },
                    'ê´‘ì–‘ì‹œ': { population: 149224, area: 463.24 },
                    'ë‹´ì–‘êµ°': { population: 44266, area: 455.81 },
                    'ê³¡ì„±êµ°': { population: 26324, area: 547.41 },
                    'êµ¬ë¡€êµ°': { population: 24152, area: 443.02 },
                    'ê³ í¥êµ°': { population: 59281, area: 777.65 },
                    'ë³´ì„±êµ°': { population: 38693, area: 664.02 },
                    'í™”ìˆœêµ°': { population: 63759, area: 787.14 },
                    'ì¥í¥êµ°': { population: 38304, area: 618.45 },
                    'ê°•ì§„êµ°': { population: 34578, area: 501.81 },
                    'í•´ë‚¨êµ°': { population: 65864, area: 1010.40 },
                    'ì˜ì•”êµ°': { population: 53620, area: 615.71 },
                    'ë¬´ì•ˆêµ°': { population: 90618, area: 449.63 },
                    'í•¨í‰êµ°': { population: 29639, area: 392.90 },
                    'ì˜ê´‘êµ°': { population: 51004, area: 473.29 },
                    'ì¥ì„±êµ°': { population: 43761, area: 518.06 },
                    'ì™„ë„êµ°': { population: 49210, area: 391.84 },
                    'ì§„ë„êµ°': { population: 29750, area: 439.19 },
                    'ì‹ ì•ˆêµ°': { population: 39020, area: 656.83 },
                    // ê²½ìƒë¶ë„
                    'í¬í•­ì‹œë‚¨êµ¬': { population: 243412, area: 507.41 },
                    'í¬í•­ì‹œë¶êµ¬': { population: 257948, area: 734.45 },
                    'ê²½ì£¼ì‹œ': { population: 243687, area: 1324.94 },
                    'ê¹€ì²œì‹œ': { population: 133298, area: 989.55 },
                    'ì•ˆë™ì‹œ': { population: 156797, area: 1519.14 },
                    'êµ¬ë¯¸ì‹œ': { population: 410775, area: 615.43 },
                    'ì˜ì£¼ì‹œ': { population: 102748, area: 1254.73 },
                    'ì˜ì²œì‹œ': { population: 100780, area: 920.55 },
                    'ìƒì£¼ì‹œ': { population: 94809, area: 1254.40 },
                    'ë¬¸ê²½ì‹œ': { population: 69856, area: 911.95 },
                    'ê²½ì‚°ì‹œ': { population: 278411, area: 395.52 },
                    'êµ°ìœ„êµ°': { population: 22412, area: 614.14 },
                    'ì˜ì„±êµ°': { population: 48355, area: 1175.16 },
                    'ì²­ì†¡êµ°': { population: 23905, area: 846.53 },
                    'ì˜ì–‘êµ°': { population: 15273, area: 815.13 },
                    'ì˜ë•êµ°': { population: 36257, area: 641.08 },
                    'ì²­ë„êµ°': { population: 41246, area: 694.83 },
                    'ê³ ë ¹êµ°': { population: 31944, area: 384.10 },
                    'ì„±ì£¼êµ°': { population: 42155, area: 616.63 },
                    'ì¹ ê³¡êµ°': { population: 104315, area: 451.45 },
                    'ì˜ˆì²œêµ°': { population: 52432, area: 661.55 },
                    'ë´‰í™”êµ°': { population: 31667, area: 1201.89 },
                    'ìš¸ì§„êµ°': { population: 49337, area: 989.51 },
                    'ìš¸ë¦‰êµ°': { population: 9208, area: 72.86 },
                    // ê²½ìƒë‚¨ë„
                    'ì°½ì›ì‹œì˜ì°½êµ¬': { population: 271158, area: 125.91 },
                    'ì°½ì›ì‹œì„±ì‚°êµ¬': { population: 243132, area: 70.73 },
                    'ì°½ì›ì‹œë§ˆì‚°í•©í¬êµ¬': { population: 173118, area: 120.02 },
                    'ì°½ì›ì‹œë§ˆì‚°íšŒì›êµ¬': { population: 191905, area: 67.21 },
                    'ì°½ì›ì‹œì§„í•´êµ¬': { population: 187096, area: 120.33 },
                    'ì§„ì£¼ì‹œ': { population: 354745, area: 712.70 },
                    'í†µì˜ì‹œ': { population: 125563, area: 238.89 },
                    'ì‚¬ì²œì‹œ': { population: 108803, area: 398.57 },
                    'ê¹€í•´ì‹œ': { population: 563397, area: 463.25 },
                    'ë°€ì–‘ì‹œ': { population: 97435, area: 799.24 },
                    'ê±°ì œì‹œ': { population: 238054, area: 401.66 },
                    'ì–‘ì‚°ì‹œ': { population: 374605, area: 485.23 },
                    'ì˜ë ¹êµ°': { population: 24360, area: 482.64 },
                    'í•¨ì•ˆêµ°': { population: 59622, area: 415.89 },
                    'ì°½ë…•êµ°': { population: 58029, area: 532.14 },
                    'ê²½ë‚¨ ê³ ì„±êµ°': { population: 49504, area: 517.98 },
                    'ë‚¨í•´êµ°': { population: 42800, area: 357.71 },
                    'í•˜ë™êµ°': { population: 43675, area: 675.34 },
                    'ì‚°ì²­êµ°': { population: 33753, area: 792.06 },
                    'í•¨ì–‘êµ°': { population: 38027, area: 725.05 },
                    'ê±°ì°½êµ°': { population: 61854, area: 803.05 },
                    'í•©ì²œêµ°': { population: 41917, area: 983.34 },
                    // ì œì£¼íŠ¹ë³„ìì¹˜ë„
                    'ì œì£¼ì‹œ': { population: 493621, area: 977.80 },
                    'ì„œê·€í¬ì‹œ': { population: 190311, area: 870.56 },
                    // ë…ë„
                    'ë…ë„': { population: 2, area: 0.18745 }
                };
                
                // ê° ì§€ì—­ì— ê´‘ê³  ì •ë³´ ì¶”ê°€ (ì‹œ ë‹¨ìœ„)
                const idSet = new Set(); // ì¤‘ë³µ ID ë°©ì§€
                
                geoJsonData.features.forEach((feature, index) => {
                    const props = feature.properties;
                    
                    // ì‹œ/êµ¬ ë‹¨ìœ„ ë°ì´í„°ì˜ ì†ì„± êµ¬ì¡°ì— ë§ê²Œ ì¡°ì •
                    // ë‹¤ì–‘í•œ ì†ì„± ì´ë¦„ íŒ¨í„´ í™•ì¸
                    const sigNameKo = props.SIG_KOR_NM || props.sig_name_ko || props.name_ko || props.name;
                    const sigNameEn = props.SIG_ENG_NM || props.sig_name_en || props.name_en || props.name_eng;
                    let ctpNameKo = props.CTP_KOR_NM || props.ctp_name_ko || '';
                    let ctpNameEn = props.CTP_ENG_NM || props.ctp_name_en || '';
                    
                    // ì²« ë²ˆì§¸ ì§€ì—­ì˜ ì†ì„± êµ¬ì¡° ì¶œë ¥ (ë””ë²„ê¹…)
                    if (index === 0) {
                        console.log('ì²« ë²ˆì§¸ ì§€ì—­ ì†ì„± êµ¬ì¡°:', Object.keys(props));
                        console.log('ì²« ë²ˆì§¸ ì§€ì—­ ì†ì„± ê°’:', {
                            CTP_KOR_NM: props.CTP_KOR_NM,
                            SIG_KOR_NM: props.SIG_KOR_NM,
                            name: props.name,
                            name_ko: props.name_ko,
                            sigNameKo,
                            ctpNameKo
                        });
                    }
                    
                    // ì‹œ/êµ¬ ì´ë¦„ ì¡°í•© ë° í‘œì‹œ ì´ë¦„ ìƒì„±
                    let cityNameKo, cityNameEn;
                    
                    // êµ¬ ì´ë¦„ë§Œ ìˆëŠ” ê²½ìš° - codeë‚˜ name_engì—ì„œ ì‹œ ì´ë¦„ ì¶”ì¶œ (ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œë§Œ)
                    let isMetropolitan = false; // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì—¬ë¶€
                    
                    if (!ctpNameKo && sigNameKo && props.code) {
                        // í–‰ì •êµ¬ì—­ ì½”ë“œë¡œ ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì¶”ì¶œ
                        const codePrefix = props.code.substring(0, 2);
                        // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì½”ë“œë§Œ (ì„œìš¸: 11, ë¶€ì‚°: 21, ëŒ€êµ¬: 22, ì¸ì²œ: 23, ê´‘ì£¼: 24, ëŒ€ì „: 25, ìš¸ì‚°: 26)
                        const metropolitanCityMap = {
                            '11': 'ì„œìš¸', '21': 'ë¶€ì‚°', '22': 'ëŒ€êµ¬', '23': 'ì¸ì²œ',
                            '24': 'ê´‘ì£¼', '25': 'ëŒ€ì „', '26': 'ìš¸ì‚°'
                        };
                        
                        if (metropolitanCityMap[codePrefix]) {
                            ctpNameKo = metropolitanCityMap[codePrefix];
                            isMetropolitan = true;
                        }
                    }
                    
                    // name_engì—ì„œë„ ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì´ë¦„ ì¶”ì¶œ ì‹œë„
                    if (!ctpNameKo && props.name_eng) {
                        const nameEngParts = props.name_eng.split('-');
                        if (nameEngParts.length > 0) {
                            const cityEng = nameEngParts[0].toLowerCase();
                            const metropolitanCityMapEng = {
                                'seoul': 'ì„œìš¸', 'busan': 'ë¶€ì‚°', 'daegu': 'ëŒ€êµ¬', 'incheon': 'ì¸ì²œ',
                                'gwangju': 'ê´‘ì£¼', 'daejeon': 'ëŒ€ì „', 'ulsan': 'ìš¸ì‚°'
                            };
                            if (metropolitanCityMapEng[cityEng]) {
                                ctpNameKo = metropolitanCityMapEng[cityEng];
                                isMetropolitan = true;
                            }
                        }
                    }
                    
                    // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œì¸ ê²½ìš°ë§Œ ì‹œ ì´ë¦„ í¬í•¨
                    if (isMetropolitan && ctpNameKo && sigNameKo && sigNameKo !== ctpNameKo && !sigNameKo.includes(ctpNameKo)) {
                        // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œì™€ êµ¬ê°€ ë¶„ë¦¬ëœ ê²½ìš° - í‘œì‹œ ì´ë¦„ì— ì‹œ ì´ë¦„ í¬í•¨
                        cityNameKo = `${ctpNameKo} ${sigNameKo}`;
                        cityNameEn = ctpNameEn && sigNameEn ? `${ctpNameEn} ${sigNameEn}` : 
                                   (sigNameEn || props.name || cityNameKo);
                    } else if (sigNameKo && sigNameKo.endsWith('êµ¬')) {
                        // êµ¬ ë‹¨ìœ„ì¸ë° ì‹œ ì´ë¦„ì´ ì—†ëŠ” ê²½ìš° - nameì—ì„œ ì¶”ì¶œ ì‹œë„
                        // ì˜ˆ: props.name = "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬ìƒêµ¬"
                        const nameText = props.name || props.name_ko || '';
                        if (nameText.includes('ê´‘ì—­ì‹œ') || nameText.includes('íŠ¹ë³„ì‹œ')) {
                            const nameParts = nameText.split(/\s+/);
                            const ctpPart = nameParts.find(p => p.includes('ê´‘ì—­ì‹œ') || p.includes('íŠ¹ë³„ì‹œ'));
                            if (ctpPart) {
                                const ctpShort = ctpPart.replace(/ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ/g, '').trim();
                                cityNameKo = `${ctpShort} ${sigNameKo}`;
                            } else {
                                cityNameKo = sigNameKo;
                            }
                        } else {
                            cityNameKo = sigNameKo;
                        }
                        cityNameEn = sigNameEn || props.name_eng || cityNameKo;
                    } else {
                        // ì‹œ/ë„ ë‹¨ìœ„ë§Œ ìˆëŠ” ê²½ìš°
                        cityNameKo = sigNameKo || props.name || `City_${index}`;
                        cityNameEn = sigNameEn || props.name_eng || props.name || cityNameKo;
                    }
                    
                    // ê³ ìœ  ID ìƒì„±: ì‹œ_êµ¬ í˜•íƒœë¡œ ì¡°í•© (ì¤‘ë³µ ë°©ì§€)
                    let finalCityId;
                    if (ctpNameKo && sigNameKo && sigNameKo !== ctpNameKo) {
                        // ì‹œì™€ êµ¬ê°€ ë¶„ë¦¬ëœ ê²½ìš° (ì˜ˆ: ë¶€ì‚°ê´‘ì—­ì‹œ_ë‚¨êµ¬)
                        const fullName = `${ctpNameKo}_${sigNameKo}`;
                        finalCityId = fullName.toLowerCase()
                            .replace(/[^\wê°€-í£]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                    } else {
                        // ì‹œ/ë„ ë‹¨ìœ„ë§Œ ìˆëŠ” ê²½ìš°
                        const idSource = ctpNameKo || sigNameKo || props.name || `City_${index}`;
                        finalCityId = idSource.toLowerCase()
                            .replace(/[^\wê°€-í£]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                    }
                    
                    // ì¤‘ë³µ ë°©ì§€: ê°™ì€ IDê°€ ìˆìœ¼ë©´ ì¸ë±ìŠ¤ ì¶”ê°€
                    let uniqueId = finalCityId;
                    let counter = 1;
                    while (idSet.has(uniqueId)) {
                        uniqueId = `${finalCityId}_${counter}`;
                        counter++;
                    }
                    idSet.add(uniqueId);
                    finalCityId = uniqueId;
                    
                    // ìµœì¢… IDê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ ì‚¬ìš©
                    if (!finalCityId) {
                        finalCityId = `korea_region_${index}`;
                    }
                    
                    // ì§€ì—­ ë°ì´í„° ë§¤ì¹­ (ì—¬ëŸ¬ ì´ë¦„ íŒ¨í„´ ì‹œë„)
                    let regionData = null;
                    const searchKeys = [
                        cityNameKo, // ìµœì¢… í‘œì‹œ ì´ë¦„
                        sigNameKo, // ì‹œ/êµ°/êµ¬ ì´ë¦„
                        props.name, // ì›ë³¸ name
                        props.SIG_KOR_NM, // SIG_KOR_NM
                        `${ctpNameKo} ${sigNameKo}`, // ì‹œë„ + ì‹œêµ°êµ¬ ì¡°í•©
                        `${sigNameKo}êµ¬`, // êµ¬ ì´ë¦„ (êµ¬ ì œê±°)
                        `${sigNameKo}ì‹œ`, // ì‹œ ì´ë¦„ (ì‹œ ì œê±°)
                        `${sigNameKo}êµ°` // êµ° ì´ë¦„ (êµ° ì œê±°)
                    ];
                    
                    for (const key of searchKeys) {
                        if (key && koreaRegionData[key]) {
                            regionData = koreaRegionData[key];
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const population = regionData ? regionData.population : (props.population || Math.floor(Math.random() * 500000) + 50000);
                    const area = regionData ? regionData.area : (props.area || Math.floor(Math.random() * 1000) + 100);
                    
                    feature.properties = {
                        ...props,
                        id: finalCityId,
                        name: cityNameKo,
                        name_en: cityNameEn,
                        name_ko: cityNameKo,
                        sig_name_ko: sigNameKo,
                        sig_name_en: sigNameEn,
                        ctp_name_ko: ctpNameKo,
                        ctp_name_en: ctpNameEn,
                        country: 'South Korea',
                        country_code: 'KR',
                        admin_level: (sigNameKo && ctpNameKo && sigNameKo !== ctpNameKo) ? 'District' : 'City',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 500000) + 100000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#4ecdc4',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    
                    // ë””ë²„ê¹…: êµ¬ê°€ ìˆëŠ” ì§€ì—­ ëª¨ë‘ ì¶œë ¥
                    if (sigNameKo && ctpNameKo && sigNameKo !== ctpNameKo) {
                        console.log(`[${index}] êµ¬ ì´ë¦„ ì²˜ë¦¬:`, {
                            ì›ë³¸_ctp: props.CTP_KOR_NM,
                            ì›ë³¸_sig: props.SIG_KOR_NM,
                            ctpNameKo,
                            sigNameKo,
                            í‘œì‹œì´ë¦„: cityNameKo,
                            finalId: finalCityId
                        });
                    }
                    
                    // regionDataì— ì €ì¥ (ê¸°ì¡´ ì¤‘ë³µ ë®ì–´ì“°ê¸°)
                    this.regionData.set(finalCityId, feature.properties);
                });
                
                // ë…ë„ ë³„ë„ ì¶”ê°€ (ìš¸ë¦‰êµ°ê³¼ ë¶„ë¦¬)
                const dokdoData = koreaRegionData['ë…ë„'] || { population: 2, area: 0.18745 };
                const dokdoFeature = {
                    type: 'Feature',
                    properties: {
                        id: 'dokdo',
                        name: 'ë…ë„',
                        name_en: 'Dokdo',
                        name_ko: 'ë…ë„',
                        sig_name_ko: 'ë…ë„',
                        sig_name_en: 'Dokdo',
                        ctp_name_ko: '',
                        ctp_name_en: '',
                        country: 'South Korea',
                        country_code: 'KR',
                        admin_level: 'Island',
                        population: dokdoData.population,
                        area: dokdoData.area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 500000) + 100000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#4ecdc4',
                        border_color: '#ffffff',
                        border_width: 1
                    },
                    geometry: {
                        type: 'Polygon',
                        // ë…ë„ ìœ„ì¹˜: ê²½ë„ 131.87, ìœ„ë„ 37.24
                        // ì‘ì€ ì„¬ì´ë¯€ë¡œ ì‘ì€ í´ë¦¬ê³¤ìœ¼ë¡œ í‘œí˜„
                        coordinates: [[
                            [131.86, 37.239],
                            [131.88, 37.239],
                            [131.88, 37.241],
                            [131.86, 37.241],
                            [131.86, 37.239]
                        ]]
                    }
                };
                
                // ë…ë„ feature ì¶”ê°€
                geoJsonData.features.push(dokdoFeature);
                this.regionData.set('dokdo', dokdoFeature.properties);
                
                console.log('í•œêµ­ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­, ê³ ìœ  ID:', idSet.size);
                console.log('ì²˜ë¦¬ëœ ì§€ì—­ ìƒ˜í”Œ:', geoJsonData.features.slice(0, 5).map(f => ({
                    id: f.properties.id,
                    name: f.properties.name_ko || f.properties.name,
                    sig: f.properties.sig_name_ko,
                    ctp: f.properties.ctp_name_ko
                })));
                console.log('ë…ë„ê°€ ë³„ë„ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                return geoJsonData;
            });
        
        // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
        if (this.map.getSource('world-regions')) {
            // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (ë” ë¹ ë¦„)
            this.map.getSource('world-regions').setData(geoJsonData);
        } else {
            // ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            this.map.addSource('world-regions', {
                type: 'geojson',
                data: geoJsonData
            });
        }
        
        // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        if (!this.map.getLayer('regions-fill')) {
            this.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ['get', 'ad_status'], 'occupied'],
                        '#ff6b6b',
                        '#4ecdc4'
                    ],
                    'fill-opacity': 0.6
                }
            });
            
            this.map.addLayer({
                id: 'regions-border',
                type: 'line',
                source: 'world-regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1,
                    'line-opacity': 0.8
                }
            });
            
            this.map.addLayer({
                id: 'regions-hover',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': '#feca57',
                    'fill-opacity': 0
                }
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•œ ë²ˆë§Œ ì¶”ê°€
            if (!this.eventListenersAdded) {
                this.setupEventListeners();
                this.eventListenersAdded = true;
            }
        }
        
        console.log('í•œêµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        this.updateStatistics();
        
        } catch (error) {
            console.error('í•œêµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í•œêµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    generateSampleRegions() {
        // ìƒ˜í”Œ í–‰ì •êµ¬ì—­ ë°ì´í„° ìƒì„±
        const regions = [
            // í•œêµ­
            {
                type: 'Feature',
                properties: {
                    id: 'seoul',
                    name_ko: 'ì„œìš¸íŠ¹ë³„ì‹œ',
                    name_en: 'Seoul',
                    country: 'South Korea',
                    admin_level: 'Metropolitan City',
                    population: 9720846,
                    area: 605.21,
                    occupied: false,
                    price: 50000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[126.8, 37.4], [127.2, 37.4], [127.2, 37.7], [126.8, 37.7], [126.8, 37.4]]]
                }
            },
            {
                type: 'Feature',
                properties: {
                    id: 'busan',
                    name_ko: 'ë¶€ì‚°ê´‘ì—­ì‹œ',
                    name_en: 'Busan',
                    country: 'South Korea',
                    admin_level: 'Metropolitan City',
                    population: 3448737,
                    area: 770.18,
                    occupied: false,
                    price: 30000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[128.8, 35.0], [129.2, 35.0], [129.2, 35.3], [128.8, 35.3], [128.8, 35.0]]]
                }
            },
            // ë¯¸êµ­
            {
                type: 'Feature',
                properties: {
                    id: 'california',
                    name_ko: 'ìº˜ë¦¬í¬ë‹ˆì•„ì£¼',
                    name_en: 'California',
                    country: 'United States',
                    admin_level: 'State',
                    population: 39538223,
                    area: 423967,
                    occupied: false,
                    price: 200000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[-124.5, 32.5], [-114.0, 32.5], [-114.0, 42.0], [-124.5, 42.0], [-124.5, 32.5]]]
                }
            },
            {
                type: 'Feature',
                properties: {
                    id: 'newyork',
                    name_ko: 'ë‰´ìš•ì£¼',
                    name_en: 'New York',
                    country: 'United States',
                    admin_level: 'State',
                    population: 20201249,
                    area: 141297,
                    occupied: false,
                    price: 150000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[-79.8, 40.5], [-71.9, 40.5], [-71.9, 45.0], [-79.8, 45.0], [-79.8, 40.5]]]
                }
            },
            // ì¤‘êµ­
            {
                type: 'Feature',
                properties: {
                    id: 'guangdong',
                    name_ko: 'ê´‘ë‘¥ì„±',
                    name_en: 'Guangdong',
                    country: 'China',
                    admin_level: 'Province',
                    population: 126012510,
                    area: 179800,
                    occupied: false,
                    price: 100000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[109.7, 20.2], [117.2, 20.2], [117.2, 25.5], [109.7, 25.5], [109.7, 20.2]]]
                }
            },
            // ì¼ë³¸
            {
                type: 'Feature',
                properties: {
                    id: 'tokyo',
                    name_ko: 'ë„ì¿„ë„',
                    name_en: 'Tokyo',
                    country: 'Japan',
                    admin_level: 'Prefecture',
                    population: 13929286,
                    area: 2194,
                    occupied: false,
                    price: 80000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[138.7, 35.5], [139.9, 35.5], [139.9, 35.9], [138.7, 35.9], [138.7, 35.5]]]
                }
            }
        ];
        
        return regions;
    }
    
    setupEventListeners() {
        // ì§€ì—­ í´ë¦­ ì´ë²¤íŠ¸
        this.map.on('click', 'regions-fill', async (e) => {
            // í”½ì…€ í¸ì§‘ ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í–‰ì •êµ¬ì—­ í´ë¦­ ë¬´ì‹œ
            if (this.isPixelEditMode) {
                // í´ë¦­í•œ ìœ„ì¹˜ì— í”½ì…€ ê·¸ë¦¬ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                const pixelFeatures = this.map.queryRenderedFeatures(e.point, {
                    layers: ['pixel-grids-fill']
                });
                
                // í”½ì…€ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ í–‰ì •êµ¬ì—­ í´ë¦­ ë¬´ì‹œ
                if (pixelFeatures && pixelFeatures.length > 0) {
                    return;
                }
                
                // í”½ì…€ í¸ì§‘ ëª¨ë“œ ì¤‘ì—ëŠ” ëª¨ë“  í–‰ì •êµ¬ì—­ í´ë¦­ ë¬´ì‹œ
                return;
            }
            
            // í”½ì…€ ìŠ¤íŠœë””ì˜¤ê°€ ì—´ë ¤ìˆëŠ”ì§€ í™•ì¸ (ì¶”ê°€ ì•ˆì „ì¥ì¹˜)
            const pixelStudioModal = document.getElementById('pixel-studio-modal');
            if (pixelStudioModal && !pixelStudioModal.classList.contains('hidden')) {
                // í´ë¦­í•œ ìœ„ì¹˜ì— í”½ì…€ ê·¸ë¦¬ë“œê°€ ìˆëŠ”ì§€ í™•ì¸
                const pixelFeatures = this.map.queryRenderedFeatures(e.point, {
                    layers: ['pixel-grids-fill']
                });
                
                // í”½ì…€ ê·¸ë¦¬ë“œê°€ ìˆìœ¼ë©´ í–‰ì •êµ¬ì—­ í´ë¦­ ë¬´ì‹œ
                if (pixelFeatures && pixelFeatures.length > 0) {
                    return;
                }
            }
            
            e.preventDefault();
            const feature = e.features[0];
            await this.selectRegion(feature);
        });
        
        // í˜¸ë²„ íš¨ê³¼ - mousemove ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ (í–‰ì •êµ¬ì—­ê°„ ì´ë™ ì‹¤ì‹œê°„ ê°ì§€)
        let lastHoverRegionId = null;
        let hoverTimeout = null;
        
        // í–‰ì •êµ¬ì—­ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ì‹œ
        this.map.on('mousemove', 'regions-fill', (e) => {
            if (hoverTimeout) {
                clearTimeout(hoverTimeout);
                hoverTimeout = null;
            }
            
            if (!e.features || e.features.length === 0) {
                return;
            }
            
            const feature = e.features[0];
            const properties = feature.properties;
            const regionId = properties.id;
            
            // ê°™ì€ ì§€ì—­ì´ë©´ íˆ´íŒë§Œ ì—…ë°ì´íŠ¸
            if (lastHoverRegionId === regionId) {
                this.showTooltip(e.point, properties);
                return;
            }
            
            // ë‹¤ë¥¸ ì§€ì—­ìœ¼ë¡œ ì´ë™
            if (lastHoverRegionId && lastHoverRegionId !== regionId) {
                this.clearHoverEffectImmediate();
            }
            
            // ìƒˆ ì§€ì—­ì— hover íš¨ê³¼ ì ìš©
            lastHoverRegionId = regionId;
            this.currentHoverRegionId = regionId;
            this.applyHoverEffect(regionId);
            
            // ì»¤ì„œ ë° íˆ´íŒ
            this.map.getCanvas().style.cursor = 'pointer';
            this.showTooltip(e.point, properties);
        });
        
        // í–‰ì •êµ¬ì—­ì—ì„œ ë²—ì–´ë‚  ë•Œ (debounce ì²˜ë¦¬)
        this.map.on('mouseleave', 'regions-fill', () => {
            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ê²½ê³„ì„ ì„ ë„˜ì–´ê°ˆ ë•Œ flickering ë°©ì§€
            hoverTimeout = setTimeout(() => {
                this.handleRegionHoverExit();
                lastHoverRegionId = null;
            }, 10);
        });
        
        // ì§€ë„ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
        this.map.on('click', (e) => {
            if (!e.features || e.features.length === 0) {
                this.hideInfoPanel();
            }
        });
        
        // ì¤Œ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
        document.getElementById('zoom-world').addEventListener('click', () => {
            this.zoomToLevel('world');
        });
        
        document.getElementById('zoom-country').addEventListener('click', () => {
            this.zoomToLevel('country');
        });
        
        document.getElementById('zoom-region').addEventListener('click', () => {
            this.zoomToLevel('region');
        });
        
        // íŒ¨ë„ ë‹«ê¸°
        document.getElementById('close-panel').addEventListener('click', () => {
            this.hideInfoPanel();
        });
        
        // êµ¬ë§¤ ë²„íŠ¼ (ì •ë³´ íŒ¨ë„)
        document.getElementById('purchase-btn').addEventListener('click', () => {
            if (!this.currentRegion) {
                this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            // ì˜¥ì…˜ ëª¨ë‹¬ ì—´ê¸°
            this.openAuctionModal(this.currentRegion);
        });
        
        // ë„ì›€ë§ ë²„íŠ¼
        document.getElementById('help-btn').addEventListener('click', () => {
            this.showHelp();
        });
        
        
        // ë©”ë‰´ ë‹«ê¸°
        document.getElementById('close-menu').addEventListener('click', () => {
            this.hideMenu();
        });
        
        // í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼
        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        if (hamburgerMenuBtn) {
            hamburgerMenuBtn.addEventListener('click', () => {
                this.toggleSideMenu();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë‹«ê¸°
        const closeSideMenu = document.getElementById('close-side-menu');
        if (closeSideMenu) {
            closeSideMenu.addEventListener('click', () => {
                this.hideSideMenu();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ì˜¤ë²„ë ˆì´)
        document.addEventListener('click', (e) => {
            const sideMenu = document.getElementById('side-menu');
            const hamburgerBtn = document.getElementById('hamburger-menu-btn');
            if (sideMenu && !sideMenu.classList.contains('hidden')) {
                // ì‚¬ì´ë“œ ë©”ë‰´ë‚˜ í–„ë²„ê±° ë²„íŠ¼ì´ ì•„ë‹Œ ê³³ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ë‹«ê¸°
                if (!sideMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                    this.hideSideMenu();
                }
            }
        });
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ì‚¬ìš©ì ë¡œê·¸ì¸ ë²„íŠ¼
        const sideUserLoginBtn = document.getElementById('side-user-login-btn');
        if (sideUserLoginBtn) {
            sideUserLoginBtn.addEventListener('click', () => {
                this.showUserLoginModal();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const sideUserLogoutBtn = document.getElementById('side-user-logout-btn');
        if (sideUserLogoutBtn) {
            sideUserLogoutBtn.addEventListener('click', () => {
                this.logoutUser();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼
        const sideAdminLoginBtn = document.getElementById('side-admin-login-btn');
        if (sideAdminLoginBtn) {
            sideAdminLoginBtn.addEventListener('click', () => {
                this.showAdminLoginModal();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const sideAdminLogoutBtn = document.getElementById('side-admin-logout-btn');
        if (sideAdminLogoutBtn) {
            sideAdminLogoutBtn.addEventListener('click', () => {
                this.handleAdminLogout();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë„ì›€ë§ ë²„íŠ¼
        const sideHelpBtn = document.getElementById('side-help-btn');
        if (sideHelpBtn) {
            sideHelpBtn.addEventListener('click', () => {
                this.showHelp();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì¸ ë²„íŠ¼
        const userLoginBtn = document.getElementById('user-login-btn');
        if (userLoginBtn) {
            userLoginBtn.addEventListener('click', () => {
                this.showUserLoginModal();
            });
        }

        const walletBtn = document.getElementById('wallet-btn');
        if (walletBtn) {
            walletBtn.addEventListener('click', () => {
                this.openWalletModal();
            });
        }

        const sideWalletBtn = document.getElementById('side-wallet-btn');
        if (sideWalletBtn) {
            sideWalletBtn.addEventListener('click', () => {
                this.openWalletModal();
                this.hideSideMenu();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const userLogoutBtn = document.getElementById('user-logout-btn');
        if (userLogoutBtn) {
            userLogoutBtn.addEventListener('click', () => {
                this.logoutUser();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
        const closeUserLogin = document.getElementById('close-user-login');
        if (closeUserLogin) {
            closeUserLogin.addEventListener('click', () => {
                this.hideUserLoginModal();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì¸ ì œì¶œ
        const userLoginSubmit = document.getElementById('user-login-submit');
        if (userLoginSubmit) {
            userLoginSubmit.addEventListener('click', () => {
                const email = document.getElementById('user-email-input').value;
                const password = document.getElementById('user-password-input').value;
                this.loginUser(email, password).then(() => {
                    this.hideUserLoginModal();
                });
            });
        }
        
        // êµ¬ê¸€ íšŒì›ê°€ì…/ë¡œê·¸ì¸ ë²„íŠ¼
        const userGoogleSignupBtn = document.getElementById('user-google-signup-btn');
        if (userGoogleSignupBtn) {
            userGoogleSignupBtn.addEventListener('click', () => {
                this.signInWithGoogle();
            });
        }

        // ë‚´ í™œë™ (My Page) ë²„íŠ¼ë“¤
        const myPageBtn = document.getElementById('my-page-btn');
        if (myPageBtn) {
            myPageBtn.addEventListener('click', () => {
                this.openUserDashboard();
            });
        }

        const sideMyPageBtn = document.getElementById('side-my-page-btn');
        if (sideMyPageBtn) {
            sideMyPageBtn.addEventListener('click', () => {
                this.openUserDashboard();
            });
        }

        const closeUserDashboardBtn = document.getElementById('close-user-dashboard');
        if (closeUserDashboardBtn) {
            closeUserDashboardBtn.addEventListener('click', () => {
                this.closeUserDashboard();
            });
        }

        const refreshUserDashboardBtn = document.getElementById('refresh-user-dashboard');
        if (refreshUserDashboardBtn) {
            refreshUserDashboardBtn.addEventListener('click', () => {
                this.loadUserDashboardData(true);
            });
        }

        const retryUserDashboardBtn = document.getElementById('user-dashboard-retry-btn');
        if (retryUserDashboardBtn) {
            retryUserDashboardBtn.addEventListener('click', () => {
                this.loadUserDashboardData(true);
            });
        }

        const userDashboardModal = document.getElementById('user-dashboard-modal');
        if (userDashboardModal) {
            userDashboardModal.addEventListener('click', (event) => {
                if (event.target === userDashboardModal) {
                    this.closeUserDashboard();
                }
            });
        }

        const userDashboardTabs = document.querySelectorAll('.user-dashboard-tabs .tab-btn');
        if (userDashboardTabs.length > 0) {
            userDashboardTabs.forEach(tab => {
                tab.addEventListener('click', (event) => {
                    const tabName = event.currentTarget.dataset.tab;
                    this.switchUserDashboardTab(tabName);
                });
            });
        }

        const userDashboardList = document.getElementById('user-dashboard-list');
        if (userDashboardList) {
            userDashboardList.addEventListener('click', async (event) => {
                const actionBtn = event.target.closest('[data-dashboard-action]');
                if (!actionBtn) return;
                const regionId = actionBtn.dataset.regionId;
                if (!regionId) return;

                if (actionBtn.dataset.dashboardAction === 'open-auction') {
                    await this.openAuctionFromDashboard(regionId);
                }
            });
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼
        const adminLoginBtn = document.getElementById('admin-login-btn');
        if (adminLoginBtn) {
            adminLoginBtn.addEventListener('click', () => {
                console.log('Admin ë²„íŠ¼ í´ë¦­ë¨');
                this.showAdminLoginModal();
            });
        } else {
            console.error('admin-login-btn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
        const closeAdminLogin = document.getElementById('close-admin-login');
        if (closeAdminLogin) {
            closeAdminLogin.addEventListener('click', () => {
                this.hideAdminLoginModal();
            });
        } else {
            console.error('close-admin-login ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ ì œì¶œ
        const adminLoginSubmit = document.getElementById('admin-login-submit');
        if (adminLoginSubmit) {
            adminLoginSubmit.addEventListener('click', async () => {
                console.log('[ADMIN] ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨');
                try {
                    await this.handleAdminLogin();
                } catch (error) {
                    console.error('[ADMIN] ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                    const errorDiv = document.getElementById('login-error');
                    if (errorDiv) {
                        errorDiv.classList.remove('hidden');
                        this.setSafeHTML(errorDiv, 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                    }
                    this.showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            });
            
            // Enter í‚¤ë¡œë„ ë¡œê·¸ì¸ ê°€ëŠ¥í•˜ë„ë¡
            const adminUsername = document.getElementById('admin-username');
            const adminPassword = document.getElementById('admin-password');
            if (adminUsername && adminPassword) {
                const handleEnterKey = async (e) => {
                    if (e.key === 'Enter') {
                        console.log('[ADMIN] Enter í‚¤ë¡œ ë¡œê·¸ì¸ ì‹œë„');
                        try {
                            await this.handleAdminLogin();
                        } catch (error) {
                            console.error('[ADMIN] ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                            const errorDiv = document.getElementById('login-error');
                            if (errorDiv) {
                                errorDiv.classList.remove('hidden');
                                this.setSafeHTML(errorDiv, 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                            }
                            this.showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        }
                    }
                };
                adminUsername.addEventListener('keypress', handleEnterKey);
                adminPassword.addEventListener('keypress', handleEnterKey);
            }
        } else {
            console.error('admin-login-submit ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        if (adminLogoutBtn) {
            adminLogoutBtn.addEventListener('click', () => {
                this.handleAdminLogout();
            });
        }
        
        // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        const closeCompanyInfo = document.getElementById('close-company-info');
        if (closeCompanyInfo) {
            closeCompanyInfo.addEventListener('click', () => {
                this.hideCompanyInfoModal();
            });
        }
        
        // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        const closeRegionInfo = document.getElementById('close-region-info');
        if (closeRegionInfo) {
            closeRegionInfo.addEventListener('click', () => {
                this.hideRegionInfoModal();
            });
        }
        
        // ì§€ì—­ êµ¬ë§¤ ë²„íŠ¼ (ëª¨ë‹¬)
        const regionPurchaseBtn = document.getElementById('region-purchase-btn');
        if (regionPurchaseBtn) {
            regionPurchaseBtn.addEventListener('click', async () => {
                // ìš°ì„ ìˆœìœ„: ë²„íŠ¼ data-state-id â†’ this.selectedStateId â†’ this.currentRegion?.id
                const btnStateId = regionPurchaseBtn.dataset.stateId;
                const targetStateId = btnStateId || this.selectedStateId || (this.currentRegion && this.currentRegion.id);
                
                console.log('êµ¬ë§¤ ë²„íŠ¼ í´ë¦­:', {
                    btnStateId,
                    selectedStateId: this.selectedStateId,
                    currentRegionId: this.currentRegion?.id,
                    targetStateId
                });
                
                // regionDataì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                let region = targetStateId ? this.regionData.get(targetStateId) : null;
                
                // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ currentRegion ì‚¬ìš©
                if (!region && this.currentRegion) {
                    region = this.currentRegion;
                    // currentRegionì— idê°€ ì—†ìœ¼ë©´ targetStateId ì¶”ê°€
                    if (!region.id && targetStateId) {
                        region.id = targetStateId;
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ selectedStateIdë¡œ ì¬ì‹œë„
                if (!region && this.selectedStateId) {
                    region = this.regionData.get(this.selectedStateId);
                    if (region) {
                        this.currentRegion = { ...region, id: this.selectedStateId };
                    } else if (this.currentRegion) {
                        // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆì§€ë§Œ currentRegionì´ ìˆìœ¼ë©´ ì‚¬ìš©
                        region = { ...this.currentRegion, id: this.selectedStateId };
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ Firestoreì—ì„œ ì¡°íšŒ ì‹œë„ (ê´€ë¦¬ì ëª¨ë“œ)
                if (!region && targetStateId && this.isAdminLoggedIn) {
                    try {
                        console.log('Firestoreì—ì„œ ì§€ì—­ ì •ë³´ ì¡°íšŒ ì‹œë„:', targetStateId);
                        const regionDoc = await this.getRegionById(targetStateId);
                        if (regionDoc) {
                            region = { ...regionDoc, id: targetStateId };
                            this.currentRegion = region;
                            this.selectedStateId = targetStateId;
                            // regionDataì—ë„ ì¶”ê°€
                            this.regionData.set(targetStateId, region);
                            console.log('Firestoreì—ì„œ ì§€ì—­ ì •ë³´ ì¡°íšŒ ì„±ê³µ:', region);
                        }
                    } catch (error) {
                        console.error('Firestore ì¡°íšŒ ì‹¤íŒ¨:', error);
                    }
                }
                
                // ìµœì¢…ì ìœ¼ë¡œ regionì´ ì—†ì–´ë„ targetStateIdê°€ ìˆìœ¼ë©´ ìµœì†Œí•œì˜ region ê°ì²´ ìƒì„±
                if (!region && targetStateId) {
                    console.warn('êµ¬ë§¤ ë²„íŠ¼: regionì´ ì—†ì§€ë§Œ targetStateIdë¡œ ìµœì†Œ ì •ë³´ ìƒì„±:', targetStateId);
                    const defaultCountry = this.currentMapMode === 'korea' ? 'South Korea' : 
                                           this.currentMapMode === 'japan' ? 'Japan' : 'USA';
                    region = {
                        id: targetStateId,
                        name: targetStateId,
                        name_ko: targetStateId,
                        name_en: targetStateId,
                        country: defaultCountry,
                        ad_status: 'available',
                        ad_price: 0
                    };
                    // currentRegionê³¼ regionDataì—ë„ ì„¤ì •
                    this.currentRegion = region;
                    this.selectedStateId = targetStateId;
                    this.regionData.set(targetStateId, region);
                }
                
                // targetStateIdë„ ì—†ìœ¼ë©´ ì—ëŸ¬
                if (!region || !region.id) {
                    console.error('êµ¬ë§¤ ë²„íŠ¼: ì§€ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', {
                        targetStateId,
                        currentRegion: this.currentRegion,
                        selectedStateId: this.selectedStateId,
                        regionDataKeys: Array.from(this.regionData.keys()).slice(0, 10)
                    });
                    this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                if (region.ad_status === 'occupied' || region.occupied) {
                    this.showNotification('ì´ë¯¸ ê´‘ê³ ê°€ ì§„í–‰ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤.', 'info');
                    return;
                }
                
                // ì˜¥ì…˜ ëª¨ë‹¬ ì—´ê¸°
                this.currentRegion = region;
                this.selectedStateId = region.id;
                this.openAuctionModal(region);
            });
        }
        
        // ê¸°ì—… ì •ë³´ ì €ì¥
        const saveCompanyInfo = document.getElementById('save-company-info');
        if (saveCompanyInfo) {
            saveCompanyInfo.addEventListener('click', () => {
                this.saveCompanyInfo();
            });
        }
        
        // ê¸°ì—… ì •ë³´ ë¯¸ë¦¬ë³´ê¸°
        const previewCompanyInfo = document.getElementById('preview-company-info');
        if (previewCompanyInfo) {
            previewCompanyInfo.addEventListener('click', async () => {
                await this.previewCompanyInfo();
            });
        }
        
        // ì§€ì—­ ì •ë³´ ì €ì¥
        const saveRegionInfo = document.getElementById('save-region-info');
        if (saveRegionInfo) {
            saveRegionInfo.addEventListener('click', () => {
                this.saveRegionInfo();
            });
        }

        // ëª¨ë“  ì§€ì—­ Firestore ë™ê¸°í™” ë²„íŠ¼
        const syncAllRegionsBtn = document.getElementById('sync-all-regions-btn');
        if (syncAllRegionsBtn) {
            syncAllRegionsBtn.addEventListener('click', async () => {
                if (!this.isAdminLoggedIn) {
                    this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                const confirmed = confirm('ëª¨ë“  ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ 1000ë‹¬ëŸ¬ë¡œ í†µì¼í•˜ê³  Firestoreì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (confirmed) {
                    syncAllRegionsBtn.disabled = true;
                    syncAllRegionsBtn.textContent = 'ë™ê¸°í™” ì¤‘...';
                    try {
                        const result = await this.syncAllRegionsToFirestore();
                        this.showNotification(
                            `ë™ê¸°í™” ì™„ë£Œ: ê°€ê²© ${result.priceUpdated}ê°œ ì—…ë°ì´íŠ¸, Firestore ${result.success}ê°œ ì„±ê³µ, ${result.failed}ê°œ ì‹¤íŒ¨`,
                            result.success > 0 ? 'success' : 'error'
                        );
                    } catch (error) {
                        console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
                        this.showNotification('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        syncAllRegionsBtn.disabled = false;
                        syncAllRegionsBtn.textContent = 'ëª¨ë“  ì§€ì—­ Firestore ë™ê¸°í™”';
                    }
                }
            });
        }
        
        // ëª¨ë‹¬ì—ì„œ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        const companyEditBtn = document.getElementById('company-edit-btn');
        if (companyEditBtn) {
            companyEditBtn.addEventListener('click', () => {
                this.openRegionEditFromModal();
            });
        }
        
        // íšŒì‚¬ ëª¨ë‹¬ ë‚´ êµ¬ë§¤ ë²„íŠ¼
        const companyPurchaseBtn = document.getElementById('company-purchase-btn');
        if (companyPurchaseBtn) {
            companyPurchaseBtn.addEventListener('click', () => {
                // ìš°ì„ ìˆœìœ„: ë²„íŠ¼ data-state-id â†’ this.selectedStateId â†’ this.currentRegion?.id
                const btnStateId = companyPurchaseBtn.dataset.stateId;
                const targetStateId = btnStateId || this.selectedStateId || (this.currentRegion && this.currentRegion.id);
                
                // regionDataì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                let region = targetStateId ? this.regionData.get(targetStateId) : null;
                
                // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ currentRegion ì‚¬ìš©
                if (!region && this.currentRegion) {
                    region = this.currentRegion;
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ selectedStateIdë¡œ ì¬ì‹œë„
                if (!region && this.selectedStateId) {
                    region = this.regionData.get(this.selectedStateId);
                    if (region) {
                        this.currentRegion = { ...region, id: this.selectedStateId };
                    }
                }
                
                if (!region) {
                    this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                if (region.ad_status === 'occupied' || region.occupied) {
                    this.showNotification('ì´ë¯¸ ê´‘ê³ ê°€ ì§„í–‰ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤.', 'info');
                    return;
                }
                // ì˜¥ì…˜ ëª¨ë‹¬ ì—´ê¸°
                this.currentRegion = region;
                this.openAuctionModal(region);
            });
        }
        
        const regionEditBtn = document.getElementById('region-edit-btn');
        if (regionEditBtn) {
            regionEditBtn.addEventListener('click', () => {
                this.openRegionEditFromModal();
            });
        }
        
        // í”½ì…€ ì—ë””í„° ë²„íŠ¼ë“¤
        const companyEditPixelBtn = document.getElementById('company-edit-pixel-btn');
        if (companyEditPixelBtn) {
            companyEditPixelBtn.addEventListener('click', async () => {
                // ìš°ì„ ìˆœìœ„: ë²„íŠ¼ ìì‹ ì˜ data-state-id â†’ company-purchase-btnì˜ data-state-id â†’ this.selectedStateId â†’ this.currentRegion?.id
                const btnStateId = companyEditPixelBtn.dataset.stateId;
                let targetStateId = btnStateId;
                
                // ë²„íŠ¼ ìì‹ ì˜ data-state-idê°€ ì—†ìœ¼ë©´ company-purchase-btnì˜ data-state-id í™•ì¸
                if (!targetStateId) {
                    const companyPurchaseBtnEl = document.getElementById('company-purchase-btn');
                    if (companyPurchaseBtnEl) {
                        targetStateId = companyPurchaseBtnEl.dataset.stateId;
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ selectedStateId ë˜ëŠ” currentRegion ì‚¬ìš©
                if (!targetStateId) {
                    targetStateId = this.selectedStateId || (this.currentRegion && this.currentRegion.id);
                }
                
                console.log('í”½ì…€ ì•„íŠ¸ í¸ì§‘ ë²„íŠ¼ í´ë¦­ (company):', {
                    btnStateId,
                    selectedStateId: this.selectedStateId,
                    currentRegionId: this.currentRegion?.id,
                    targetStateId
                });
                
                // regionDataì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                let region = targetStateId ? this.regionData.get(targetStateId) : null;
                let regionId = targetStateId;
                
                // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ currentRegion ì‚¬ìš©
                if (!region && this.currentRegion) {
                    region = this.currentRegion;
                    regionId = region.id || targetStateId;
                    // currentRegionì— idê°€ ì—†ìœ¼ë©´ targetStateId ì¶”ê°€
                    if (!region.id && targetStateId) {
                        region.id = targetStateId;
                        regionId = targetStateId;
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ selectedStateIdë¡œ ì¬ì‹œë„
                if (!region && this.selectedStateId) {
                    region = this.regionData.get(this.selectedStateId);
                    regionId = this.selectedStateId;
                    if (region) {
                        this.currentRegion = { ...region, id: this.selectedStateId };
                    } else if (this.currentRegion) {
                        // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆì§€ë§Œ currentRegionì´ ìˆìœ¼ë©´ ì‚¬ìš©
                        region = { ...this.currentRegion, id: this.selectedStateId };
                        regionId = this.selectedStateId;
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ Firestoreì—ì„œ ì¡°íšŒ ì‹œë„ (ê´€ë¦¬ì ëª¨ë“œ)
                if (!region && targetStateId && this.isAdminLoggedIn) {
                    try {
                        console.log('Firestoreì—ì„œ ì§€ì—­ ì •ë³´ ì¡°íšŒ ì‹œë„:', targetStateId);
                        const regionDoc = await this.getRegionById(targetStateId);
                        if (regionDoc) {
                            region = { ...regionDoc, id: targetStateId };
                            regionId = targetStateId;
                            this.currentRegion = region;
                            this.selectedStateId = targetStateId;
                            // regionDataì—ë„ ì¶”ê°€
                            this.regionData.set(targetStateId, region);
                            console.log('Firestoreì—ì„œ ì§€ì—­ ì •ë³´ ì¡°íšŒ ì„±ê³µ:', region);
                        }
                    } catch (error) {
                        console.error('Firestore ì¡°íšŒ ì‹¤íŒ¨:', error);
                    }
                }
                
                // ìµœì¢…ì ìœ¼ë¡œ regionì´ ì—†ì–´ë„ targetStateIdê°€ ìˆìœ¼ë©´ ìµœì†Œí•œì˜ region ê°ì²´ ìƒì„±
                if (!region && targetStateId) {
                    console.warn('í”½ì…€ ì•„íŠ¸ í¸ì§‘ (company): regionì´ ì—†ì§€ë§Œ targetStateIdë¡œ ìµœì†Œ ì •ë³´ ìƒì„±:', targetStateId);
                    const defaultCountry = this.currentMapMode === 'korea' ? 'South Korea' : 
                                           this.currentMapMode === 'japan' ? 'Japan' : 'USA';
                    region = {
                        id: targetStateId,
                        name: targetStateId,
                        name_ko: targetStateId,
                        name_en: targetStateId,
                        country: defaultCountry,
                        ad_status: 'available',
                        ad_price: 0
                    };
                    regionId = targetStateId;
                    // currentRegionê³¼ regionDataì—ë„ ì„¤ì •
                    this.currentRegion = region;
                    this.selectedStateId = targetStateId;
                    this.regionData.set(targetStateId, region);
                }
                
                // targetStateIdë„ ì—†ìœ¼ë©´ ì—ëŸ¬
                if (!region || !regionId) {
                    console.error('í”½ì…€ ì•„íŠ¸ í¸ì§‘ (company): ì§€ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', {
                        targetStateId,
                        currentRegion: this.currentRegion,
                        selectedStateId: this.selectedStateId,
                        regionDataKeys: Array.from(this.regionData.keys()).slice(0, 10)
                    });
                    this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                await this.openPixelStudio(regionId, region);
            });
        }
        
        const regionEditPixelBtn = document.getElementById('region-edit-pixel-btn');
        if (regionEditPixelBtn) {
            regionEditPixelBtn.addEventListener('click', async () => {
                try {
                    console.log('[í”½ì…€ ì•„íŠ¸ í¸ì§‘ ë²„íŠ¼ í´ë¦­] ì‹œì‘', {
                        isAdmin: this.isAdminLoggedIn,
                        buttonElement: regionEditPixelBtn,
                        hasDataset: !!regionEditPixelBtn.dataset
                    });
                    
                    // ìš°ì„ ìˆœìœ„: ë²„íŠ¼ data-state-id â†’ this.selectedStateId â†’ this.currentRegion?.id
                    const btnStateId = regionEditPixelBtn.dataset.stateId;
                    const targetStateId = btnStateId || this.selectedStateId || (this.currentRegion && this.currentRegion.id);
                    
                    console.log('í”½ì…€ ì•„íŠ¸ í¸ì§‘ ë²„íŠ¼ í´ë¦­ (region):', {
                        btnStateId,
                        selectedStateId: this.selectedStateId,
                        currentRegionId: this.currentRegion?.id,
                        targetStateId,
                        isAdmin: this.isAdminLoggedIn
                    });
                
                // regionDataì—ì„œ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                let region = targetStateId ? this.regionData.get(targetStateId) : null;
                let regionId = targetStateId;
                
                // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆìœ¼ë©´ currentRegion ì‚¬ìš©
                if (!region && this.currentRegion) {
                    region = this.currentRegion;
                    regionId = region.id || targetStateId;
                    // currentRegionì— idê°€ ì—†ìœ¼ë©´ targetStateId ì¶”ê°€
                    if (!region.id && targetStateId) {
                        region.id = targetStateId;
                        regionId = targetStateId;
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ selectedStateIdë¡œ ì¬ì‹œë„
                if (!region && this.selectedStateId) {
                    region = this.regionData.get(this.selectedStateId);
                    regionId = this.selectedStateId;
                    if (region) {
                        this.currentRegion = { ...region, id: this.selectedStateId };
                    } else if (this.currentRegion) {
                        // regionDataì—ì„œ ì°¾ì§€ ëª»í–ˆì§€ë§Œ currentRegionì´ ìˆìœ¼ë©´ ì‚¬ìš©
                        region = { ...this.currentRegion, id: this.selectedStateId };
                        regionId = this.selectedStateId;
                    }
                }
                
                // ì—¬ì „íˆ ì—†ìœ¼ë©´ Firestoreì—ì„œ ì¡°íšŒ ì‹œë„ (ê´€ë¦¬ì ëª¨ë“œ)
                if (!region && targetStateId && this.isAdminLoggedIn) {
                    try {
                        console.log('Firestoreì—ì„œ ì§€ì—­ ì •ë³´ ì¡°íšŒ ì‹œë„:', targetStateId);
                        const regionDoc = await this.getRegionById(targetStateId);
                        if (regionDoc) {
                            region = { ...regionDoc, id: targetStateId };
                            regionId = targetStateId;
                            this.currentRegion = region;
                            this.selectedStateId = targetStateId;
                            // regionDataì—ë„ ì¶”ê°€
                            this.regionData.set(targetStateId, region);
                            console.log('Firestoreì—ì„œ ì§€ì—­ ì •ë³´ ì¡°íšŒ ì„±ê³µ:', region);
                        }
                    } catch (error) {
                        console.error('Firestore ì¡°íšŒ ì‹¤íŒ¨:', error);
                    }
                }
                
                // ìµœì¢…ì ìœ¼ë¡œ regionì´ ì—†ì–´ë„ targetStateIdê°€ ìˆìœ¼ë©´ ìµœì†Œí•œì˜ region ê°ì²´ ìƒì„±
                if (!region && targetStateId) {
                    console.warn('í”½ì…€ ì•„íŠ¸ í¸ì§‘ (region): regionì´ ì—†ì§€ë§Œ targetStateIdë¡œ ìµœì†Œ ì •ë³´ ìƒì„±:', targetStateId);
                    const defaultCountry = this.currentMapMode === 'korea' ? 'South Korea' : 
                                           this.currentMapMode === 'japan' ? 'Japan' : 'USA';
                    region = {
                        id: targetStateId,
                        name: targetStateId,
                        name_ko: targetStateId,
                        name_en: targetStateId,
                        country: defaultCountry,
                        ad_status: 'available',
                        ad_price: 0
                    };
                    regionId = targetStateId;
                    // currentRegionê³¼ regionDataì—ë„ ì„¤ì •
                    this.currentRegion = region;
                    this.selectedStateId = targetStateId;
                    this.regionData.set(targetStateId, region);
                }
                
                // targetStateIdë„ ì—†ìœ¼ë©´ ì—ëŸ¬
                if (!regionId) {
                    console.error('í”½ì…€ ì•„íŠ¸ í¸ì§‘ (region): ì§€ì—­ IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', {
                        targetStateId,
                        currentRegion: this.currentRegion,
                        selectedStateId: this.selectedStateId,
                        regionDataKeys: Array.from(this.regionData.keys()).slice(0, 10)
                    });
                    this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                // regionì´ ì—†ì–´ë„ regionIdë§Œ ìˆìœ¼ë©´ ìµœì†Œ ì •ë³´ë¡œ ìƒì„± (ê´€ë¦¬ì ëª¨ë“œ ì§€ì›)
                if (!region) {
                    console.warn('í”½ì…€ ì•„íŠ¸ í¸ì§‘: region ê°ì²´ê°€ ì—†ì§€ë§Œ regionIdë¡œ ì§„í–‰:', regionId);
                    region = {
                        id: regionId,
                        name: regionId,
                        name_ko: regionId,
                        name_en: regionId,
                        country: this.currentMapMode || 'Unknown',
                        ad_status: 'available',
                        ad_price: 0
                    };
                }
                
                console.log('í”½ì…€ ì•„íŠ¸ í¸ì§‘ ì‹œì‘:', { regionId, region, isAdmin: this.isAdminLoggedIn });
                
                // regionIdê°€ ì—†ìœ¼ë©´ ì—ëŸ¬ í‘œì‹œ
                if (!regionId) {
                    console.error('[í”½ì…€ ì•„íŠ¸ í¸ì§‘ ì‹¤íŒ¨] regionIdê°€ ì—†ìŠµë‹ˆë‹¤.');
                    this.showNotification('ì§€ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // openPixelStudio í˜¸ì¶œ
                try {
                    await this.openPixelStudio(regionId, region);
                    console.log('[í”½ì…€ ì•„íŠ¸ í¸ì§‘] openPixelStudio í˜¸ì¶œ ì™„ë£Œ');
                } catch (error) {
                    console.error('[í”½ì…€ ì•„íŠ¸ í¸ì§‘] openPixelStudio í˜¸ì¶œ ì‹¤íŒ¨:', error);
                    this.showNotification('í”½ì…€ ìŠ¤íŠœë””ì˜¤ë¥¼ ì—´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message, 'error');
                }
            } catch (error) {
                console.error('[í”½ì…€ ì•„íŠ¸ í¸ì§‘ ë²„íŠ¼] ì˜ˆì™¸ ë°œìƒ:', error);
                this.showNotification('í”½ì…€ ì•„íŠ¸ í¸ì§‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
            }
        } else {
            console.warn('[í”½ì…€ ì•„íŠ¸ í¸ì§‘] region-edit-pixel-btn ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        // ê´€ë¦¬ì íŒ¨ë„ ì´ë²¤íŠ¸ (ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ)
        const adminToggle = document.getElementById('admin-toggle');
        if (adminToggle) {
            adminToggle.addEventListener('click', () => {
                this.toggleAdminMode();
            });
        }
        
        const logoEditMode = document.getElementById('logo-edit-mode');
        if (logoEditMode) {
            logoEditMode.addEventListener('click', () => {
                this.toggleLogoEditMode();
            });
        }
        
        const closeAdmin = document.getElementById('close-admin');
        if (closeAdmin) {
            closeAdmin.addEventListener('click', () => {
                this.toggleAdminMode();
            });
        }
        
        const adminExitBtn = document.getElementById('admin-exit-btn');
        if (adminExitBtn) {
            adminExitBtn.addEventListener('click', () => {
                if (!this.isAdminLoggedIn) {
                    this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    return;
                }
                this.disableAdminMode();
            });
        }
        
        // ë¡œê³  ê´€ë¦¬ ì´ë²¤íŠ¸
        const uploadLogo = document.getElementById('upload-logo');
        if (uploadLogo) {
            uploadLogo.addEventListener('click', () => {
                this.uploadLogo();
            });
        }
        
        const saveLogo = document.getElementById('save-logo');
        if (saveLogo) {
            saveLogo.addEventListener('click', () => {
                this.saveLogo();
            });
        }
        
        const removeLogo = document.getElementById('remove-logo');
        if (removeLogo) {
            removeLogo.addEventListener('click', () => {
                this.removeLogo();
            });
        }
        
        const resetLogo = document.getElementById('reset-logo');
        if (resetLogo) {
            resetLogo.addEventListener('click', () => {
                this.resetLogo();
            });
        }
        
        // ë¡œê³  ì„¤ì • ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        const logoSize = document.getElementById('logo-size');
        if (logoSize) {
            logoSize.addEventListener('input', (e) => {
                this.updateLogoPreview();
            });
        }
        
        const logoOpacity = document.getElementById('logo-opacity');
        if (logoOpacity) {
            logoOpacity.addEventListener('input', (e) => {
                this.updateLogoPreview();
            });
        }
        
        const logoRotation = document.getElementById('logo-rotation');
        if (logoRotation) {
            logoRotation.addEventListener('input', (e) => {
                this.updateLogoPreview();
            });
        }
        
        // ìƒ‰ìƒ ì„¤ì • ì´ë²¤íŠ¸ëŠ” setupColorPresetListenersì—ì„œ ì²˜ë¦¬
        
        // ì§€ë„ ì¤Œ ë ˆë²¨ ë³€ê²½ ê°ì§€
        this.map.on('zoom', () => {
            this.updateZoomLevel();
        });
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            this.handleKeyboardShortcuts(e);
        });
        
        // ì˜¥ì…˜ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.setupAuctionModalListeners();
        
        // í”½ì…€ ìŠ¤íŠœë””ì˜¤ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.setupPixelStudioListeners();

        // ì»¤ë®¤ë‹ˆí‹° ë¬´ë£Œ í”½ì…€ ë“œë ë²„íŠ¼
        const triggerPixelDropBtn = document.getElementById('trigger-pixel-airdrop');
        if (triggerPixelDropBtn) {
            triggerPixelDropBtn.addEventListener('click', () => {
                this.triggerCommunityAirdrop();
            });
        }
        
        // ì˜¥ì…˜ ëŒ€ì‹œë³´ë“œ ë²„íŠ¼
        const sideAuctionDashboardBtn = document.getElementById('side-auction-dashboard-btn');
        if (sideAuctionDashboardBtn) {
            sideAuctionDashboardBtn.addEventListener('click', () => {
                this.openAuctionDashboard();
            });
        }
        
        // ì˜¥ì…˜ ëŒ€ì‹œë³´ë“œ ëª¨ë‹¬ ë‹«ê¸°
        const closeAuctionDashboard = document.getElementById('close-auction-dashboard');
        if (closeAuctionDashboard) {
            closeAuctionDashboard.addEventListener('click', () => {
                this.closeAuctionDashboard();
            });
        }
        
        // ëŒ€ì‹œë³´ë“œ íƒ­ ì „í™˜
        const dashboardTabs = document.querySelectorAll('.dashboard-tabs .tab-btn');
        dashboardTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                this.switchDashboardTab(tabName);
            });
        });
        
        // í†µê³„ ëª¨ë‹¬ ì—´ê¸° (í—¤ë”ì— ë²„íŠ¼ ì¶”ê°€ ê°€ëŠ¥)
        const marketStatsBtn = document.getElementById('market-stats-btn');
        if (marketStatsBtn) {
            marketStatsBtn.addEventListener('click', () => {
                this.openMarketStatsModal();
            });
        }
        
        // í†µê³„ ëª¨ë‹¬ ë‹«ê¸°
        const closeMarketStats = document.getElementById('close-market-stats');
        if (closeMarketStats) {
            closeMarketStats.addEventListener('click', () => {
                this.closeMarketStatsModal();
            });
        }
        
        // í†µê³„ íƒ­ ì „í™˜
        const statsTabs = document.querySelectorAll('.stats-tabs .tab-btn');
        statsTabs.forEach(tab => {
            tab.addEventListener('click', (e) => {
                const tabName = e.target.dataset.tab;
                this.switchStatsTab(tabName);
            });
        });
    }
    
    // êµ­ê°€ ì „í™˜ í•¨ìˆ˜
    switchCountry(countryCode) {
        console.log('êµ­ê°€ ì „í™˜:', countryCode);
        
        const country = this.g20Countries[countryCode];
        if (!country) {
            console.error('ì§€ì›í•˜ì§€ ì•ŠëŠ” êµ­ê°€:', countryCode);
            return;
        }
        
        // ì§€ë„ ì¤‘ì‹¬ê³¼ ì¤Œ ë ˆë²¨ ë³€ê²½
        this.map.flyTo({
            center: country.center,
            zoom: country.zoom,
            duration: 2000,
            essential: true
        });
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œ ì—…ë°ì´íŠ¸
        this.currentMapMode = countryCode;
        
        // ì•Œë¦¼ í‘œì‹œ
        this.showNotification(`${country.flag} ${country.name}ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        
        // í•´ë‹¹ êµ­ê°€ì˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë¡œë“œ
        this.loadCountryData(countryCode);
    }
    
    // êµ­ê°€ë³„ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async loadCountryData(countryCode) {
        try {
            // í˜„ì¬ëŠ” ê¸°ë³¸ ë°ì´í„°ë§Œ ë¡œë“œ
            // í–¥í›„ ê° êµ­ê°€ë³„ GeoJSON ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆë„ë¡ í™•ì¥ ê°€ëŠ¥
            console.log(`${countryCode} ë°ì´í„° ë¡œë“œ ì¤‘...`);
            
            // ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
            if (this.map.getLayer('regions-fill')) {
                this.map.removeLayer('regions-fill');
            }
            if (this.map.getSource('world-regions')) {
                this.map.removeSource('world-regions');
            }
            
            // êµ­ê°€ë³„ ë°ì´í„° ë¡œë“œ (í˜„ì¬ëŠ” ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©)
            await this.loadWorldData();
            
        } catch (error) {
            console.error('êµ­ê°€ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            this.showNotification('êµ­ê°€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    async selectRegion(feature) {
        const properties = feature.properties;
        
        // properties.idê°€ ì—†ìœ¼ë©´ ë‹¤ë¥¸ ì†ì„±ì—ì„œ ID ì¶”ì¶œ ì‹œë„
        let regionId = properties.id;
        if (!regionId) {
            regionId = properties.state_id || properties.name || properties.name_ko;
            console.warn('properties.idê°€ ì—†ì–´ ëŒ€ì²´ ID ì‚¬ìš©:', regionId);
        }
        
        // currentRegion ì„¤ì • (ìµœì†Œí•œì˜ ì •ë³´ë¼ë„ ë³´ì¥)
        this.currentRegion = {
            ...properties,
            id: regionId
        };
        this.selectedStateId = regionId;
        
        console.log('ì§€ì—­ ì„ íƒë¨:', {
            region: properties,
            regionId: regionId,
            selectedStateId: this.selectedStateId,
            isAdminLoggedIn: this.isAdminLoggedIn,
            adminMode: this.adminMode,
            currentMapMode: this.currentMapMode,
            hasRegionData: this.regionData.has(regionId)
        });
        
        // regionDataì— ì—†ìœ¼ë©´ propertiesë¡œ ê¸°ë³¸ ë°ì´í„° ìƒì„±
        if (!this.regionData.has(regionId)) {
            console.log('regionDataì— ì—†ì–´ì„œ propertiesë¡œ ê¸°ë³¸ ë°ì´í„° ìƒì„±:', regionId);
            const defaultCountry = this.currentMapMode === 'korea' ? 'South Korea' : 
                                   this.currentMapMode === 'japan' ? 'Japan' : 'USA';
            this.regionData.set(regionId, {
                ...properties,
                id: regionId,
                country: properties.country || defaultCountry
            });
        }
        
        // ì´ì „ ì„ íƒ í•´ì œ
        this.map.setFilter('regions-hover', ['==', 'id', '']);
        
        // í˜„ì¬ ì§€ì—­ í•˜ì´ë¼ì´íŠ¸
        if (regionId) {
            this.map.setFilter('regions-hover', ['==', 'id', regionId]);
            this.map.setPaintProperty('regions-hover', 'fill-opacity', 0.3);
        }
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” ê´€ë¦¬ì ê¸°ëŠ¥ê³¼ ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
        if (this.isAdminLoggedIn && this.adminMode) {
            console.log('ê´€ë¦¬ì ëª¨ë“œ: ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸ ë° ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ');
            this.updateAdminPanelForRegion(this.currentRegion);
            // ê´€ë¦¬ì ëª¨ë“œì—ì„œë„ ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (ë²„íŠ¼ë“¤ì´ ì‘ë™í•˜ë„ë¡)
            await this.showRegionInfoModal(regionId);
            return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œí•˜ì—¬ ì¼ë°˜ ì‚¬ìš©ì ê¸°ëŠ¥ ì°¨ë‹¨
        }
        
        // ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œì¼ ë•Œë§Œ ê¸°ì—… ì •ë³´ í‘œì‹œ
        console.log('ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ: ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ');
        await this.showCompanyInfoModal(regionId);
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ì„ ì„ íƒëœ ì£¼ì— ë§ê²Œ ì—…ë°ì´íŠ¸
    updateAdminPanelForRegion(region) {
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸:', region);
        
        const selectedStateName = document.getElementById('selected-state-name');
        if (selectedStateName) {
            const displayName = this.getRegionDisplayName(region);
            selectedStateName.textContent = displayName;
            console.log('ì„ íƒëœ ì£¼ ì´ë¦„ ì„¤ì •:', displayName);
        } else {
            console.error('selected-state-name ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        this.updateLogoPreview();
        this.updateColorPreview();
        this.loadCompanyInfoForEdit(region.id);
        
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
    
    // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
    async showCompanyInfoModal(stateId) {
        console.log('ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ ì‹œë„:', stateId);
        console.log('í˜„ì¬ ì§€ë„ ëª¨ë“œ:', this.currentMapMode);
        
        // currentRegionì´ ì—†ìœ¼ë©´ regionDataì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (!this.currentRegion && stateId) {
            const regionFromData = this.regionData.get(stateId);
            if (regionFromData) {
                this.currentRegion = { ...regionFromData, id: stateId };
                this.selectedStateId = stateId;
            }
        }
        
        // currentRegionì´ ì—¬ì „íˆ ì—†ìœ¼ë©´ propertiesì—ì„œ ìƒì„±
        if (!this.currentRegion && stateId) {
            // selectRegionì—ì„œ ì„¤ì •ëœ propertiesë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìœ¼ë¯€ë¡œ regionDataì—ì„œ ìµœì†Œ ì •ë³´ ìƒì„±
            this.currentRegion = { id: stateId };
            this.selectedStateId = stateId;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const companyData = this.currentMapMode === 'korea' 
            ? this.koreaCompanyData[stateId] 
            : this.currentMapMode === 'japan'
            ? this.japanCompanyData[stateId]
            : this.companyData[stateId];
            
        console.log('í˜„ì¬ companyData:', this.currentMapMode === 'korea' ? this.koreaCompanyData : this.companyData);
        console.log('ì„ íƒëœ stateIdì˜ companyData:', companyData);
        const modal = document.getElementById('company-info-modal');
        if (!modal) {
            console.error('company-info-modal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // ì§€ì—­ëª… ê°€ì ¸ì˜¤ê¸° (êµ­ê°€ë³„ ì–¸ì–´ ìš°ì„ ìˆœìœ„ ì ìš©)
        const regionName = this.getRegionDisplayName(this.currentRegion) || stateId;
        
        console.log('ì§€ì—­ëª…:', regionName, 'currentRegion:', this.currentRegion);
        
        // í•­ìƒ ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (ê¸°ì—… ì •ë³´ê°€ ì—†ì–´ë„ ì§€ì—­ ì •ë³´ í¬í•¨)
        console.log('ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (í†µí•© ëª¨ë‹¬)');
        
        // ëª¨ë‹¬ ì œëª© ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const regionInfoText = this.getLanguageText('Region Information');
        const companyInfoText = this.getLanguageText('Company Information');
        const companyNameElement = document.getElementById('company-name');
        const companyNameTitleElement = document.getElementById('company-name-title');
        if (companyNameElement) {
            const titleText = (companyData && companyData.name) ? companyData.name : regionInfoText.primary;
            companyNameElement.textContent = titleText;
        }
        if (companyNameTitleElement) {
            const titleText = (companyData && companyData.name) ? companyData.name : regionInfoText.primary;
            companyNameTitleElement.textContent = titleText;
        }
        
        // ì§€ì—­ ì •ë³´ ì„¤ì •
        const companyRegionElement = document.getElementById('company-region');
        if (companyRegionElement) {
            companyRegionElement.textContent = regionName;
        }
        
        // ì„¹ì…˜ ì œëª© ë° ë¼ë²¨ ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const updateLabelWithTranslation = (secondaryId, key) => {
            const text = this.getLanguageText(key);
            const secondaryEl = document.getElementById(secondaryId);
            const secondaryParent = secondaryEl?.parentElement;
            const primaryEl = secondaryParent?.querySelector('.label-primary');
            
            if (primaryEl) primaryEl.textContent = text.primary;
            if (secondaryEl) {
                if (text.secondary) {
                    secondaryEl.textContent = ` (${text.secondary})`;
                    secondaryEl.style.display = 'inline';
                } else {
                    secondaryEl.style.display = 'none';
                }
            }
        };
        
        // ì„¹ì…˜ ì œëª© ì—…ë°ì´íŠ¸
        updateLabelWithTranslation('company-region-section-label-en', 'Region Information');
        updateLabelWithTranslation('company-info-section-label-en', 'Company Information');
        
        // ì§€ì—­ ì •ë³´ ë¼ë²¨ ì—…ë°ì´íŠ¸
        updateLabelWithTranslation('company-region-label-en', 'Region');
        updateLabelWithTranslation('company-region-population-label-en', 'Population');
        updateLabelWithTranslation('company-region-area-label-en', 'Area');
        updateLabelWithTranslation('company-region-admin-level-label-en', 'Administrative Level');
        updateLabelWithTranslation('company-region-price-label-en', 'Advertising Price');
        updateLabelWithTranslation('company-region-status-label-en', 'Status');
        
        // ê¸°ì—… ì •ë³´ ë¼ë²¨ ì—…ë°ì´íŠ¸
        updateLabelWithTranslation('company-industry-label-en', 'Industry');
        updateLabelWithTranslation('company-founded-label-en', 'Founded');
        updateLabelWithTranslation('company-employees-label-en', 'Employees');
        updateLabelWithTranslation('company-website-label-en', 'Website');
        updateLabelWithTranslation('company-description-label-en', 'Company Description');
        updateLabelWithTranslation('company-features-label-en', 'Key Features');
        
        if (companyData && companyData.name) {
            // ê¸°ì—… ì •ë³´ ì„¤ì •
            const elements = {
                'company-industry': companyData.industry || '-',
                'company-founded': companyData.founded || '-',
                'company-employees': companyData.employees || '-',
                'company-website': companyData.website || '-'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    if (id === 'company-website') {
                        element.href = companyData.website || '#';
                    }
                }
            });
            
            // ì„¤ëª… ì„¤ì •
            const descriptionElement = document.getElementById('company-description-text');
            if (descriptionElement) {
                descriptionElement.textContent = companyData.description || '-';
            }
            
            // ë¡œê³  í‘œì‹œ
            const logoImg = document.getElementById('company-logo');
            if (logoImg) {
                if (companyData.logo && companyData.logo.trim() !== '') {
                    logoImg.src = companyData.logo;
                    logoImg.style.display = 'block';
                    console.log('ë¡œê³  í‘œì‹œ:', companyData.logo);
                } else {
                    logoImg.style.display = 'none';
                    console.log('ë¡œê³  ì—†ìŒ - ìˆ¨ê¹€');
                }
            }
            
            // íŠ¹ì§• ëª©ë¡
            const featuresList = document.getElementById('company-features-list');
            if (featuresList) {
                if (companyData.features && companyData.features.length > 0) {
                    featuresList.innerHTML = '';
                    companyData.features.forEach(feature => {
                        if (feature && feature.trim() !== '') {
                            const li = document.createElement('li');
                            li.textContent = feature;
                            featuresList.appendChild(li);
                        }
                    });
                } else {
                    const noFeaturesText = this.getLanguageText('Key Features');
                    featuresList.innerHTML = '';
                    const li = document.createElement('li');
                    li.textContent = '-';
                    featuresList.appendChild(li);
                }
            }
        } else {
            // ê¸°ì—… ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
            const elements = {
                'company-industry': '-',
                'company-founded': '-',
                'company-employees': '-',
                'company-website': '-'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    if (id === 'company-website') {
                        element.href = '#';
                    }
                }
            });
            
            const descriptionElement = document.getElementById('company-description-text');
            if (descriptionElement) {
                // ì–¸ì–´ ë³€í™˜ì€ ê¸°ë³¸ ë©”ì‹œì§€ì´ë¯€ë¡œ ì˜ì–´ë¡œë§Œ í‘œì‹œí•˜ê±°ë‚˜, í•„ìš”ì‹œ ì¶”ê°€
                descriptionElement.textContent = 'No company information available for this region.';
            }
            
            const logoImg = document.getElementById('company-logo');
            if (logoImg) {
                logoImg.style.display = 'none';
            }
            
            const featuresList = document.getElementById('company-features-list');
            if (featuresList) {
                featuresList.innerHTML = '';
                const li = document.createElement('li');
                li.textContent = 'ë“±ë¡ëœ íŠ¹ì§•ì´ ì—†ìŠµë‹ˆë‹¤.';
                featuresList.appendChild(li);
            }
        }
        
        // ì§€ì—­ ì •ë³´ í‘œì‹œ (ëª¨ë“  ê²½ìš°)
        // regionDataê°€ ì—†ìœ¼ë©´ regionData Mapì—ì„œ ê°€ì ¸ì˜¤ê¸°
        let regionData = this.currentRegion;
        if (!regionData && stateId) {
            regionData = this.regionData.get(stateId);
            if (regionData) {
                this.currentRegion = { ...regionData, id: stateId };
                this.selectedStateId = stateId;
            }
        }
        
        if (regionData || stateId) {
            // êµ¬ë§¤ ë²„íŠ¼ì— í˜„ì¬ stateId ì €ì¥ (onclickì—ì„œ í™œìš©)
            const companyPurchaseBtnEl = document.getElementById('company-purchase-btn');
            if (companyPurchaseBtnEl && stateId) {
                companyPurchaseBtnEl.dataset.stateId = stateId;
            }
            
            // í”½ì…€ ì—ë””í„° ë²„íŠ¼ì— í˜„ì¬ stateId ì €ì¥ (onclickì—ì„œ í™œìš©)
            const companyEditPixelBtnEl = document.getElementById('company-edit-pixel-btn');
            if (companyEditPixelBtnEl && stateId) {
                companyEditPixelBtnEl.dataset.stateId = stateId;
            }
            
            // ì¸êµ¬, ë©´ì , í–‰ì •êµ¬ì—­ ë ˆë²¨, ê´‘ê³  ê°€ê²© ë“± ì§€ì—­ ì •ë³´ í‘œì‹œ (regionDataì—ì„œ ì •í™•í•œ ê°’ ê°€ì ¸ì˜¤ê¸°)
            const regionDataFromMap = this.regionData.get(stateId) || regionData || { id: stateId };
            const populationEl = document.getElementById('company-region-population');
            const areaEl = document.getElementById('company-region-area');
            const adminLevelEl = document.getElementById('company-region-admin-level');
            const priceEl = document.getElementById('company-region-price');
            const statusEl = document.getElementById('company-region-status');
            
            if (populationEl) {
                const population = regionDataFromMap.population || regionData.population || 0;
                populationEl.textContent = population ? population.toLocaleString() : '-';
            }
            if (areaEl) {
                const area = regionDataFromMap.area || regionData.area || 0;
                areaEl.textContent = area ? `${area.toLocaleString()} kmÂ²` : '-';
            }
            if (adminLevelEl) {
                const adminLevel = regionDataFromMap.admin_level || regionData.admin_level || '-';
                // í˜„ì¬ êµ­ê°€ì˜ ì´ í–‰ì •êµ¬ì—­ ìˆ˜ ê³„ì‚°
                const totalRegions = this.getTotalAdminRegionsCount(regionDataFromMap.country || regionData.country);
                if (adminLevel !== '-' && totalRegions > 0) {
                    adminLevelEl.textContent = `${adminLevel} (${totalRegions}ê°œ)`;
                } else {
                    adminLevelEl.textContent = adminLevel;
                }
            }
            if (priceEl) {
                const adPrice = regionDataFromMap.ad_price || regionData.ad_price || 0;
                priceEl.textContent = adPrice ? `$${adPrice.toLocaleString()}` : '-';
            }
            if (statusEl) {
                const status = regionDataFromMap.ad_status || regionData.ad_status || 'available';
                const availableText = this.getLanguageText('Available');
                const occupiedText = this.getLanguageText('Occupied');
                statusEl.textContent = status === 'occupied' ? occupiedText.primary : availableText.primary;
                statusEl.style.color = status === 'occupied' ? '#ff6b6b' : '#4ecdc4';
            }
            
            // êµ¬ë§¤ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´ (ê¸°ì—… ëª¨ë‹¬)
            const companyPurchaseBtn = companyPurchaseBtnEl || document.getElementById('company-purchase-btn');
            if (companyPurchaseBtn) {
                const isOccupied = (regionDataFromMap.ad_status || regionData.ad_status) === 'occupied' || regionDataFromMap.occupied || regionData.occupied;
                if (isOccupied) {
                    companyPurchaseBtn.classList.add('hidden');
                } else {
                    companyPurchaseBtn.classList.remove('hidden');
                }
            }
            
            console.log('ì§€ì—­ ì •ë³´ í‘œì‹œ ì™„ë£Œ:', regionData);
        }
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ í¸ì§‘ ë²„íŠ¼ í‘œì‹œ
        const companyEditBtn = document.getElementById('company-edit-btn');
        if (companyEditBtn) {
            if (this.isAdminLoggedIn) {
                companyEditBtn.classList.remove('hidden');
            } else {
                companyEditBtn.classList.add('hidden');
            }
        }
        
        // í”½ì…€ ì—ë””í„° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ì†Œìœ ìë§Œ)
        const companyEditPixelBtn = document.getElementById('company-edit-pixel-btn');
        if (companyEditPixelBtn) {
            await this.updatePixelEditorButtonVisibility(companyEditPixelBtn, stateId);
        }
        
        modal.classList.remove('hidden');
        console.log('í†µí•© ì •ë³´ ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');
    }
    
    // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideCompanyInfoModal() {
        const modal = document.getElementById('company-info-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
    
    // ê¸°ì—… ì •ë³´ í¸ì§‘ì„ ìœ„í•´ ë¡œë“œ
    loadCompanyInfoForEdit(stateId) {
        const companyData = this.currentMapMode === 'korea' 
            ? (this.koreaCompanyData[stateId] || {})
            : (this.companyData[stateId] || {});
        
        document.getElementById('company-name-input').value = companyData.name || '';
        document.getElementById('company-industry-input').value = companyData.industry || '';
        document.getElementById('company-founded-input').value = companyData.founded || '';
        document.getElementById('company-employees-input').value = companyData.employees || '';
        document.getElementById('company-website-input').value = companyData.website || '';
        document.getElementById('company-description-input').value = companyData.description || '';
        document.getElementById('company-features-input').value = companyData.features ? companyData.features.join('\n') : '';
    }
    
    // ê¸°ì—… ì •ë³´ ì €ì¥
    saveCompanyInfo() {
        console.log('ê¸°ì—… ì •ë³´ ì €ì¥ ì‹œë„:', {
            selectedStateId: this.selectedStateId,
            adminMode: this.adminMode,
            isAdminLoggedIn: this.isAdminLoggedIn
        });
        
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ì…ë ¥ ê²€ì¦
        let companyData;
        try {
            const name = this.validateInput(
                document.getElementById('company-name-input').value,
                'text',
                200,
                false
            );
            const industry = this.validateInput(
                document.getElementById('company-industry-input').value,
                'text',
                100,
                false
            );
            const founded = this.validateInput(
                document.getElementById('company-founded-input').value,
                'number',
                10,
                false
            );
            const employees = this.validateInput(
                document.getElementById('company-employees-input').value,
                'number',
                20,
                false
            );
            const website = this.validateInput(
                document.getElementById('company-website-input').value,
                'url',
                500,
                false
            );
            const description = this.validateInput(
                document.getElementById('company-description-input').value,
                'text',
                2000,
                false
            );
            const featuresInput = document.getElementById('company-features-input').value;
            const features = featuresInput ? featuresInput.split('\n')
                .map(f => this.validateInput(f, 'text', 200, false))
                .filter(f => f.trim()) : [];
            
            companyData = {
                name: name || 'ê¸°ì—…ëª…',
                industry: industry || 'ì‚°ì—…',
                founded: founded || 'ì„¤ë¦½ë…„ë„',
                employees: employees || 'ì§ì› ìˆ˜',
                website: website || '',
                description: description || 'ê¸°ì—… ì†Œê°œ',
                features: features,
                region: this.getRegionDisplayName(this.currentRegion),
                logo: this.logoData[this.selectedStateId]?.src || ''
            };
        } catch (error) {
            this.showNotification(error.message, 'error');
            return;
        }
        
        console.log('ì €ì¥í•  ê¸°ì—… ë°ì´í„°:', companyData);
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaCompanyData[this.selectedStateId] = companyData;
        } else {
            this.companyData[this.selectedStateId] = companyData;
        }
        
        this.showNotification('ê¸°ì—… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ê¸°ì—… ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, companyData, 'ëª¨ë“œ:', this.currentMapMode);
    }
    
    // ê¸°ì—… ì •ë³´ ë¯¸ë¦¬ë³´ê¸°
    async previewCompanyInfo() {
        if (!this.selectedStateId) {
            this.showNotification('ë¯¸ë¦¬ë³´ê¸°í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ì„ì‹œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸° (ê²€ì¦ ì—†ì´ í‘œì‹œìš©)
        let tempData;
        try {
            const name = this.validateInput(
                document.getElementById('company-name-input').value,
                'text',
                200,
                false
            ) || 'ê¸°ì—…ëª…';
            const industry = this.validateInput(
                document.getElementById('company-industry-input').value,
                'text',
                100,
                false
            ) || 'ì‚°ì—…';
            const founded = this.validateInput(
                document.getElementById('company-founded-input').value,
                'number',
                10,
                false
            ) || 'ì„¤ë¦½ë…„ë„';
            const employees = this.validateInput(
                document.getElementById('company-employees-input').value,
                'number',
                20,
                false
            ) || 'ì§ì› ìˆ˜';
            const website = this.validateInput(
                document.getElementById('company-website-input').value,
                'url',
                500,
                false
            ) || 'ì›¹ì‚¬ì´íŠ¸';
            const description = this.validateInput(
                document.getElementById('company-description-input').value,
                'text',
                2000,
                false
            ) || 'ê¸°ì—… ì†Œê°œ';
            const featuresInput = document.getElementById('company-features-input').value;
            const features = featuresInput ? featuresInput.split('\n')
                .map(f => this.validateInput(f, 'text', 200, false))
                .filter(f => f.trim()) : [];
            
            tempData = {
                name: name,
                industry: industry,
                founded: founded,
                employees: employees,
                website: website,
                description: description,
                features: features,
                region: this.getRegionDisplayName(this.currentRegion),
                logo: this.logoData[this.selectedStateId]?.src || ''
            };
        } catch (error) {
            this.showNotification(error.message, 'error');
            return;
        }
        
        // ì„ì‹œë¡œ ì €ì¥
        const originalData = this.companyData[this.selectedStateId];
        this.companyData[this.selectedStateId] = tempData;
        
        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        await this.showCompanyInfoModal(this.selectedStateId);
        
        // ì›ë˜ ë°ì´í„° ë³µì›
        this.companyData[this.selectedStateId] = originalData;
    }
    
    // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateColorPreview() {
        if (!this.selectedStateId) return;
        
        const regionColor = document.getElementById('region-color').value;
        const borderColor = document.getElementById('border-color').value;
        const borderWidth = document.getElementById('border-width').value;
        
        // ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById('region-color-value').textContent = regionColor;
        document.getElementById('border-color-value').textContent = borderColor;
        document.getElementById('border-width-value').textContent = borderWidth + 'px';
        
        // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        this.colorData[this.selectedStateId] = {
            regionColor: regionColor,
            borderColor: borderColor,
            borderWidth: parseInt(borderWidth)
        };
    }
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©
    applyColorPreset(preset) {
        const regionColor = preset.dataset.color;
        const borderColor = preset.dataset.border;
        
        // ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('region-color').value = regionColor;
        document.getElementById('border-color').value = borderColor;
        
        // í”„ë¦¬ì…‹ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
        preset.classList.add('selected');
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        this.updateColorPreview();
        
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©:', regionColor, borderColor);
    }
    
    // ì§€ë„ì— ìƒ‰ìƒ ì ìš©
    applyColorToMap(stateId, colorData) {
        if (!this.map || !colorData) return;
        
        // ì§€ë„ ë ˆì´ì–´ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        this.map.setPaintProperty('regions-fill', 'fill-color', [
            'case',
            ['==', ['get', 'id'], stateId],
            colorData.regionColor,
            [
                'case',
                ['==', ['get', 'ad_status'], 'occupied'],
                '#ff6b6b',
                '#4ecdc4'
            ]
        ]);
        
        this.map.setPaintProperty('regions-border', 'line-color', [
            'case',
            ['==', ['get', 'id'], stateId],
            colorData.borderColor,
            '#ffffff'
        ]);
        
        this.map.setPaintProperty('regions-border', 'line-width', [
            'case',
            ['==', ['get', 'id'], stateId],
            colorData.borderWidth,
            1
        ]);
        
        console.log('ì§€ë„ì— ìƒ‰ìƒ ì ìš© ì™„ë£Œ:', stateId, colorData);
    }
    
    showInfoPanel(region) {
        const panel = document.getElementById('info-panel');
        const regionName = document.getElementById('region-name');
        const countryName = document.getElementById('country-name');
        const adminLevel = document.getElementById('admin-level');
        const population = document.getElementById('population');
        const area = document.getElementById('area');
        const adStatus = document.getElementById('ad-status');
        const adPrice = document.getElementById('ad-price');
        
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í‘œì‹œí•  ì´ë¦„ ê²°ì •
        regionName.textContent = this.getRegionDisplayName(region);
        
        if (this.currentMapMode === 'japan') {
            adminLevel.textContent = 'Prefecture';
            adStatus.textContent = region.ad_status === 'occupied' ? 'Occupied' : 'Available';
        } else if (this.currentMapMode === 'spain' && region.autonomous_community_ko) {
            // ìŠ¤í˜ì¸ì˜ ê²½ìš° ìì¹˜ì§€ì—­ ì •ë³´ í‘œì‹œ
            adminLevel.textContent = `${region.admin_level} (ìì¹˜ì§€ì—­: ${region.autonomous_community_ko})`;
            adStatus.textContent = region.ad_status === 'occupied' ? 'ê´‘ê³  ì¤‘' : 'ì‚¬ìš© ê°€ëŠ¥';
        } else {
            const englishCountries = ['usa', 'uk', 'canada', 'australia', 'south-africa'];
            const isEnglishCountry = englishCountries.includes(this.currentMapMode);
            adminLevel.textContent = region.admin_level;
            adStatus.textContent = isEnglishCountry 
                ? (region.occupied ? 'Occupied' : 'Available')
                : (region.occupied ? 'ê´‘ê³  ì¤‘' : 'ì‚¬ìš© ê°€ëŠ¥');
        }
        countryName.textContent = region.country;
        population.textContent = region.population.toLocaleString();
        area.textContent = `${region.area.toLocaleString()} kmÂ²`;
        adStatus.style.color = region.ad_status === 'occupied' ? '#ff6b6b' : '#4ecdc4';
        adPrice.textContent = `$${region.ad_price.toLocaleString()}`;
        
        panel.classList.remove('hidden');
    }
    
    hideInfoPanel() {
        const panel = document.getElementById('info-panel');
        panel.classList.add('hidden');
        
        // í•˜ì´ë¼ì´íŠ¸ ì œê±°
        this.map.setFilter('regions-hover', ['==', 'id', '']);
        this.currentRegion = null;
    }
    
    // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ PayPal ë²„íŠ¼ ë Œë”ë§
    async autoRenderPayPalButtons() {
        if (!this.currentRegion || !this.currentUser) {
            return;
        }
        
        // í˜„ì¬ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ í™•ì¸
        const infoPanel = document.getElementById('info-panel');
        const regionModal = document.getElementById('region-info-modal');
        const companyModal = document.getElementById('company-info-modal');
        
        // ì •ë³´ íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´
        if (infoPanel && !infoPanel.classList.contains('hidden')) {
            await this.renderPayPalButtons('paypal-buttons', this.currentRegion);
        }
        // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´
        else if (regionModal && !regionModal.classList.contains('hidden')) {
            await this.renderPayPalButtons('region-paypal-buttons', this.currentRegion);
        }
        // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´
        else if (companyModal && !companyModal.classList.contains('hidden')) {
            await this.renderPayPalButtons('company-paypal-buttons', this.currentRegion);
        }
    }
    
    // PayPal ë²„íŠ¼ ë Œë”ë§
    async renderPayPalButtons(containerId, region) {
        try {
            const container = document.getElementById(containerId);
            if (!container) return;
            // ë¹„ì–´ìˆê²Œ ì´ˆê¸°í™” (ì¤‘ë³µ ë Œë” ì œê±°) - ì•ˆì „í•œ ë°©ë²• ì‚¬ìš©
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            if (!(window.paypal && window.paypal.Buttons)) {
                this.showNotification('ê²°ì œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê°€ê²© ì‚¬ìš© (ì—†ìœ¼ë©´ ê³„ì‚°)
            let amount = region?.ad_price;
            if (!amount || amount <= 0) {
                const regionId = region.id || region.regionId;
                if (regionId) {
                    amount = await this.getStartingPriceForRegion(regionId);
                } else {
                    amount = this.uniformAdPrice || 1000; // í´ë°±
                }
            }
            const description = `${region.country} - ${this.getRegionDisplayName(region)} (${region.id})`;
            
            window.paypal.Buttons({
                style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: description,
                            amount: {
                                currency_code: 'USD',
                                value: String(amount)
                            }
                        }]
                    });
                },
                onApprove: async (data, actions) => {
                    try {
                        const details = await actions.order.capture();
                        
                        // êµ¬ë§¤ì ì´ë©”ì¼ ì¶”ì¶œ (PayPal ê²°ì œ ì •ë³´ì—ì„œ)
                        const buyerEmail = details.payer?.email_address || details.payer?.payer_info?.email || null;
                        const orderId = details.id;
                        
                        // Firestoreì— êµ¬ë§¤ ê¸°ë¡ ì €ì¥
                        if (this.isFirebaseInitialized) {
                            await this.savePurchaseToFirestore(
                                region.id,
                                this.getRegionDisplayName(region),
                                orderId,
                                buyerEmail || 'unknown@example.com',
                                amount
                            );
                        }
                        
                        // ê²°ì œ ì„±ê³µ ì²˜ë¦¬: ì§€ì—­ ì ìœ ë¡œ í‘œì‹œ
                        region.ad_status = 'occupied';
                        // ì§€ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
                        this.updateRegionStatus(region.id, true);
                        this.showNotification('êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì§€ì—­ì´ ê´‘ê³  ì¤‘ ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        // íŒ¨ë„/ëª¨ë‹¬ UI ê°±ì‹ 
                        this.showInfoPanel(region);
                        // í†µê³„ ì—…ë°ì´íŠ¸
                        this.updateStatistics();
                        // ë²„íŠ¼ ë¹„í™œì„±í™”
                        const successDiv = document.createElement('div');
                        successDiv.style.color = '#2ecc71';
                        successDiv.style.fontWeight = '600';
                        successDiv.textContent = 'ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        container.innerHTML = '';
                        container.appendChild(successDiv);
                        console.log('PayPal capture result:', details);
                    } catch (err) {
                        console.error('Capture error:', err);
                        this.showNotification('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                },
                onCancel: () => {
                    this.showNotification('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                },
                onError: (err) => {
                    console.error('PayPal error:', err);
                    this.showNotification('ê²°ì œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }).render(`#${containerId}`);
        } catch (e) {
            console.error('renderPayPalButtons error:', e);
            this.showNotification('ê²°ì œ ë²„íŠ¼ ë Œë”ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    zoomToLevel(level) {
        const zoom = this.zoomLevels[level];
        this.map.easeTo({
            zoom: zoom,
            duration: 1000
        });
    }
    
    updateZoomLevel() {
        const currentZoom = this.map.getZoom();
        // ë””ë²„ê·¸ ë¡œê·¸ ì œê±° (ì„±ëŠ¥ í–¥ìƒ)
        // console.log('í˜„ì¬ ì¤Œ ë ˆë²¨:', currentZoom);
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í–‰ì •êµ¬ì—­ í‘œì‹œ ì¡°ì •
        if (currentZoom < 3) {
            // ì „ ì„¸ê³„ ë ˆë²¨ - êµ­ê°€ë§Œ í‘œì‹œ
            this.map.setLayoutProperty('regions-fill', 'visibility', 'visible');
        } else if (currentZoom < 6) {
            // êµ­ê°€ ë ˆë²¨ - ì£¼/ì„± ë‹¨ìœ„ í‘œì‹œ
            this.map.setLayoutProperty('regions-fill', 'visibility', 'visible');
        } else {
            // ì§€ì—­ ë ˆë²¨ - ì‹œ/êµ°/êµ¬ ë‹¨ìœ„ í‘œì‹œ
            this.map.setLayoutProperty('regions-fill', 'visibility', 'visible');
        }
    }
    
    purchaseRegion() {
        if (!this.currentRegion) {
            this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        if (this.currentRegion.occupied) {
            this.showNotification('ì´ë¯¸ ê´‘ê³ ê°€ ì§„í–‰ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤.', 'error');
            return;
        }
        
        // êµ¬ë§¤ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
        this.showPurchaseModal(this.currentRegion);
    }
    
    showPurchaseModal(region) {
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        this.hidePurchaseModal();
        
        // ëª¨ë‹¬ ìƒì„± (XSS ë°©ì–´: ì•ˆì „í•œ HTML ìƒì„±)
        const modal = document.createElement('div');
        modal.id = 'purchase-modal';
        modal.className = 'purchase-modal';
        
        // ì•ˆì „í•œ ë°ì´í„° ì¶”ì¶œ
        const regionName = this.sanitizeHTML(this.getRegionDisplayName(region) || '');
        const country = this.sanitizeHTML(region.country || '');
        const population = region.population ? region.population.toLocaleString() : '0';
        const area = region.area ? region.area.toLocaleString() : '0';
        const gdp = region.gdp_per_capita ? region.gdp_per_capita.toLocaleString() : '0';
        const price = region.price ? region.price.toLocaleString() : '0';
        const popWeight = region.population ? (region.population / 1000000).toFixed(1) : '0';
        const areaWeight = region.area ? (region.area / 1000).toFixed(1) : '0';
        
        // ì•ˆì „í•œ HTML ìƒì„±
        const modalHTML = `
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ì§€ì—­ ê´‘ê³  êµ¬ë§¤</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="region-summary">
                        <h4>${regionName}</h4>
                        <p><strong>êµ­ê°€:</strong> ${country}</p>
                        <p><strong>ì¸êµ¬:</strong> ${population}ëª…</p>
                        <p><strong>ë©´ì :</strong> ${area} kmÂ²</p>
                        <p><strong>1ì¸ë‹¹ GDP:</strong> $${gdp}</p>
                    </div>
                    <div class="pricing-info">
                        <h4>ê°€ê²© ì •ë³´</h4>
                        <div class="price-breakdown">
                            <p>ê¸°ë³¸ ê°€ê²©: $${price}</p>
                            <p>ì¸êµ¬ ê°€ì¤‘ì¹˜: ${popWeight}M</p>
                            <p>ë©´ì  ê°€ì¤‘ì¹˜: ${areaWeight}K kmÂ²</p>
                        </div>
                        <div class="total-price">
                            <strong>ì´ ê°€ê²©: $${price}</strong>
                        </div>
                    </div>
                    <div class="purchase-form">
                        <h4>ê´‘ê³  ì •ë³´</h4>
                        <input type="text" id="advertiser-name" placeholder="ê´‘ê³ ì£¼ëª…" required>
                        <input type="url" id="advertiser-website" placeholder="ì›¹ì‚¬ì´íŠ¸ URL">
                        <textarea id="ad-description" placeholder="ê´‘ê³  ì„¤ëª… (ì„ íƒì‚¬í•­)" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel">ì·¨ì†Œ</button>
                    <button class="btn-purchase">êµ¬ë§¤í•˜ê¸°</button>
                </div>
            </div>
        `;
        this.setSafeHTML(modal, modalHTML);
        
        document.body.appendChild(modal);
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        modal.querySelector('.modal-close').addEventListener('click', () => {
            this.hidePurchaseModal();
        });
        
        modal.querySelector('.modal-overlay').addEventListener('click', () => {
            this.hidePurchaseModal();
        });
        
        modal.querySelector('.btn-cancel').addEventListener('click', () => {
            this.hidePurchaseModal();
        });
        
        modal.querySelector('.btn-purchase').addEventListener('click', () => {
            this.processPurchase(region);
        });
    }
    
    hidePurchaseModal() {
        const modal = document.getElementById('purchase-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    processPurchase(region) {
        const advertiserName = document.getElementById('advertiser-name').value;
        const advertiserWebsite = document.getElementById('advertiser-website').value;
        const adDescription = document.getElementById('ad-description').value;
        
        if (!advertiserName.trim()) {
            this.showNotification('ê´‘ê³ ì£¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // êµ¬ë§¤ ì²˜ë¦¬
        const purchaseData = {
            regionId: region.id,
            regionName: this.getRegionDisplayName(region),
            advertiserName: advertiserName,
            advertiserWebsite: advertiserWebsite,
            adDescription: adDescription,
            price: region.price,
            purchaseDate: new Date().toISOString()
        };
        
        // ì‹¤ì œë¡œëŠ” ì„œë²„ì— êµ¬ë§¤ ìš”ì²­ì„ ë³´ë‚´ì•¼ í•¨
        console.log('êµ¬ë§¤ ë°ì´í„°:', purchaseData);
        
        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        this.currentRegion.occupied = true;
        this.currentRegion.advertiser = advertiserName;
        this.currentRegion.advertiserWebsite = advertiserWebsite;
        this.currentRegion.adDescription = adDescription;
        
        this.updateRegionStatus(this.currentRegion.id, true);
        this.hidePurchaseModal();
        this.showNotification('êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        this.showInfoPanel(this.currentRegion);
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        this.updateStatistics();
    }
    
    showNotification(message, type = 'info', duration = 5000) {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        this.hideNotification();
        
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `notification notification-${type}`;
        
        // XSS ë°©ì–´: ë©”ì‹œì§€ ì •í™”
        const safeMessage = this.sanitizeHTML(message);
        const icon = this.getNotificationIcon(type);
        
        const notificationHTML = `
            <div class="notification-content">
                <span class="notification-icon">${icon}</span>
                <span class="notification-message">${safeMessage}</span>
                <button class="notification-close">&times;</button>
            </div>
        `;
        this.setSafeHTML(notification, notificationHTML);
        
        document.body.appendChild(notification);
        
        // ìë™ ì œê±° (duration ë§¤ê°œë³€ìˆ˜ ì§€ì›)
        if (duration > 0) {
            setTimeout(() => {
                this.hideNotification();
            }, duration);
        }
        
        // ìˆ˜ë™ ì œê±°
        const closeButton = notification.querySelector('.notification-close');
        if (closeButton) {
            closeButton.addEventListener('click', () => {
                this.hideNotification();
            });
        }
    }
    
    hideNotification() {
        const notification = document.getElementById('notification');
        if (notification) {
            notification.remove();
        }
    }
    
    getNotificationIcon(type) {
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸',
            info: 'â„¹ï¸'
        };
        return icons[type] || icons.info;
    }
    
    updateStatistics() {
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const source = this.map.getSource('world-regions');
        if (!source || !source._data) return;
        
        const features = source._data.features;
        const totalRegions = features.length;
        const occupiedRegions = features.filter(f => f.properties.occupied).length;
        const totalRevenue = features
            .filter(f => f.properties.occupied)
            .reduce((sum, f) => sum + f.properties.price, 0);
        const occupancyRate = totalRegions > 0 ? Math.round((occupiedRegions / totalRegions) * 100) : 0;
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('total-regions').textContent = totalRegions;
        document.getElementById('occupied-regions').textContent = occupiedRegions;
        document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;
        document.getElementById('occupancy-rate').textContent = `${occupancyRate}%`;
        
        console.log(`í†µê³„ ì—…ë°ì´íŠ¸: ${occupiedRegions}/${totalRegions} ì§€ì—­ ê´‘ê³  ì¤‘, ì´ ìˆ˜ìµ: $${totalRevenue.toLocaleString()}, ì ìœ ìœ¨: ${occupancyRate}%`);
    }
    
    updateRegionStatus(regionId, occupied) {
        // ì§€ë„ ë°ì´í„° ì—…ë°ì´íŠ¸
        const source = this.map.getSource('world-regions');
        if (source && source._data) {
            const features = source._data.features;
            const feature = features.find(f => f.properties.id === regionId);
            if (feature) {
                feature.properties.occupied = occupied;
                source.setData(source._data);
            }
        }
    }
    
    hideLoading() {
        const loading = document.getElementById('loading');
        if (loading) {
            loading.style.display = 'none';
            // ì¶”ê°€ë¡œ í´ë˜ìŠ¤ ì œê±°ë¡œ í™•ì‹¤íˆ ìˆ¨ê¹€
            loading.classList.add('hidden');
        }
    }
    
    showTooltip(point, properties) {
        // ê¸°ì¡´ íˆ´íŒ ì œê±°
        this.hideTooltip();
        
        // íˆ´íŒ ìš”ì†Œ ìƒì„±
        const tooltip = document.createElement('div');
        tooltip.id = 'map-tooltip';
        tooltip.className = 'map-tooltip';
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í‘œì‹œí•  ì´ë¦„ ê²°ì •
        let displayName, subName;
        
        if (this.currentMapMode === 'japan') {
            displayName = properties.name_en || properties.name;
            subName = properties.name_ja;
        } else if (this.currentMapMode === 'korea') {
            // í•œêµ­ ëª¨ë“œ: name_koê°€ ì´ë¯¸ "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬" í˜•íƒœë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨
            displayName = properties.name_ko || properties.name || properties.sig_name_ko;
            // ì‹œ ì´ë¦„ì´ ë³„ë„ë¡œ ìˆìœ¼ë©´ ì„œë¸Œ ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
            if (properties.ctp_name_ko && properties.sig_name_ko && properties.ctp_name_ko !== properties.sig_name_ko) {
                const ctpShort = properties.ctp_name_ko.replace(/ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ|ì‹œ$/g, '').trim();
                if (!displayName.includes(ctpShort)) {
                    displayName = `${ctpShort} ${displayName}`;
                }
            }
            subName = properties.name_en || properties.sig_name_en;
        } else {
            displayName = properties.name_ko || properties.name;
            subName = properties.name_en;
        }
            
        // ì•ˆì „í•œ ë°ì´í„° ì¶”ì¶œ
        const safeDisplayName = this.sanitizeHTML(displayName || '');
        const safeSubName = subName ? this.sanitizeHTML(subName) : '';
        const safeCountry = this.sanitizeHTML(properties.country || '');
        const population = properties.population ? properties.population.toLocaleString() : '0';
        const price = properties.ad_price ? properties.ad_price.toLocaleString() : '0';
        const status = properties.ad_status === 'occupied' ? 'occupied' : 'available';
        const statusText = properties.ad_status === 'occupied' ? 'Occupied' : 'Available';
        
        // ì•ˆì „í•œ HTML ìƒì„±
        const tooltipHTML = `
            <div class="tooltip-content">
                <h4>${safeDisplayName}</h4>
                ${safeSubName ? `<p>${safeSubName}</p>` : ''}
                <p><strong>${safeCountry}</strong></p>
                <p>Population: ${population}</p>
                <p>Price: $${price}</p>
                <p class="status ${status}">${statusText}</p>
            </div>
        `;
        this.setSafeHTML(tooltip, tooltipHTML);
        
        // íˆ´íŒ ìœ„ì¹˜ ì„¤ì •
        tooltip.style.left = point.x + 10 + 'px';
        tooltip.style.top = point.y - 10 + 'px';
        
        document.body.appendChild(tooltip);
    }
    
    hideTooltip() {
        const existingTooltip = document.getElementById('map-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
    }
    
    handleKeyboardShortcuts(e) {
        // Pí‚¤ ì—°íƒ€ ì²˜ë¦¬
        if (e.key.toLowerCase() === 'p') {
            e.preventDefault();
            this.handlePKeyPress();
            return;
        }
        
        // ESC í‚¤ë¡œ íŒ¨ë„ ë‹«ê¸°
        if (e.key === 'Escape') {
            this.hideInfoPanel();
            this.hidePurchaseModal();
        }
        
        // UIê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ ë‹¨ì¶•í‚¤ ë¬´ì‹œ
        if (!this.uiVisible) {
            return;
        }
        
        // ìˆ«ì í‚¤ë¡œ ì¤Œ ë ˆë²¨ ë³€ê²½
        if (e.key === '1') {
            this.zoomToLevel('world');
        } else if (e.key === '2') {
            this.zoomToLevel('country');
        } else if (e.key === '3') {
            this.zoomToLevel('region');
        }
        
        // Enter í‚¤ë¡œ êµ¬ë§¤ (ì„ íƒëœ ì§€ì—­ì´ ìˆì„ ë•Œ)
        if (e.key === 'Enter' && this.currentRegion && !this.currentRegion.occupied) {
            this.purchaseRegion();
        }
        
        // H í‚¤ë¡œ ë„ì›€ë§ í‘œì‹œ
        if (e.key === 'h' || e.key === 'H') {
            this.showHelp();
        }
    }
    
    // Pí‚¤ ì—°íƒ€ ì²˜ë¦¬ - ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    handlePKeyPress() {
        this.pKeyCount++;
        
        // ê¸°ì¡´ íƒ€ì´ë¨¸ í´ë¦¬ì–´
        if (this.pKeyTimer) {
            clearTimeout(this.pKeyTimer);
        }
        
        // 3ë²ˆ ì—°íƒ€ ì‹œ ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ ë˜ëŠ” admin.htmlë¡œ ì´ë™
        if (this.pKeyCount >= 3) {
            // ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•Šìœ¼ë©´ ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
            if (!this.isAdminLoggedIn) {
                this.showAdminLoginModal();
                this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'info');
            } else {
                // ì´ë¯¸ ë¡œê·¸ì¸ë˜ì–´ ìˆìœ¼ë©´ admin.htmlë¡œ ì´ë™
                const storedSession = this.getStoredAdminSession();
                if (storedSession && storedSession.signature) {
                    // signatureê°€ ìˆëŠ” ì„¸ì…˜ì´ ìˆìœ¼ë©´ admin.htmlë¡œ ì´ë™
                    this.showNotification('ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');
                    setTimeout(() => {
                        window.location.href = 'admin.html';
                    }, 300);
                } else {
                    // signatureê°€ ì—†ëŠ” ì„¸ì…˜ì´ë©´ ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
                    if (!this.adminMode) {
                        this.toggleAdminMode();
                        this.showNotification('ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    } else {
                        this.showNotification('ì´ë¯¸ ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'info');
                    }
                }
            }
            this.pKeyCount = 0;
        } else {
            // 1ì´ˆ í›„ ì¹´ìš´íŠ¸ ë¦¬ì…‹
            this.pKeyTimer = setTimeout(() => {
                this.pKeyCount = 0;
            }, 1000);
        }
    }
    
    // UI í† ê¸€
    toggleUI() {
        this.uiVisible = !this.uiVisible;
        
        if (this.uiVisible) {
            this.showUI();
        } else {
            this.hideUI();
        }
    }
    
    // UI í‘œì‹œ (í—¤ë” ë²„íŠ¼ë“¤ - Pí‚¤ ì—°íƒ€ë¡œ í‘œì‹œ)
    showUI() {
        // í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ í‘œì‹œ
        const helpBtn = document.getElementById('help-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        if (helpBtn) helpBtn.classList.remove('hidden');
        if (adminLoginBtn) adminLoginBtn.classList.remove('hidden');
        
        if (this.isAdminLoggedIn && adminLogoutBtn) {
            adminLogoutBtn.classList.remove('hidden');
            // ê´€ë¦¬ì íŒ¨ë„ì€ Pí‚¤ ì—°íƒ€ë¡œë§Œ í‘œì‹œ (ìë™ í‘œì‹œí•˜ì§€ ì•ŠìŒ)
            // this.showAdminPanel(); // ì œê±°
        }
        
        // í—¤ë” ìë™ ì¡°ì •
        this.adjustHeader();
        
        console.log('UI í‘œì‹œë¨');
    }
    
    // UI ìˆ¨ê¹€ (í—¤ë” ë²„íŠ¼ë“¤ - Pí‚¤ ì—°íƒ€ë¡œ ìˆ¨ê¹€)
    hideUI() {
        // í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ ìˆ¨ê¹€
        const helpBtn = document.getElementById('help-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        if (helpBtn) helpBtn.classList.add('hidden');
        if (adminLoginBtn) adminLoginBtn.classList.add('hidden');
        if (adminLogoutBtn) adminLogoutBtn.classList.add('hidden');
        
        // ê´€ë¦¬ì íŒ¨ë„ê³¼ ì¢Œì¸¡ íŒ¨ë„ ìˆ¨ê¹€
        this.hideAdminPanel();
        this.hideMenu();
        
        // í—¤ë” ìë™ ì¡°ì •
        this.adjustHeader();
        
        console.log('UI ìˆ¨ê¹€ë¨');
    }
    
    // í—¤ë” ìë™ ì¡°ì •
    adjustHeader() {
        const header = document.querySelector('.header');
        const headerActions = document.querySelector('.header-actions');
        
        if (this.uiVisible) {
            // UIê°€ ë³´ì¼ ë•ŒëŠ” ì›ë˜ ìŠ¤íƒ€ì¼
            header.style.gap = '30px';
            headerActions.style.display = 'flex';
        } else {
            // UIê°€ ìˆ¨ê²¨ì§ˆ ë•ŒëŠ” ì¤‘ì•™ ì •ë ¬
            header.style.gap = '0';
            headerActions.style.display = 'none';
        }
    }
    
    showHelp() {
        const helpModal = document.createElement('div');
        helpModal.id = 'help-modal';
        helpModal.className = 'purchase-modal';
        // ë„ì›€ë§ ëª¨ë‹¬ HTML (ì •ì  ì½˜í…ì¸ ì´ë¯€ë¡œ DOMPurifyë¡œ ì •í™”)
        const helpHTML = `
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ë„ì›€ë§ - í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h4>ğŸ® ê¸°ë³¸ ì¡°ì‘</h4>
                        <ul>
                            <li><strong>ë§ˆìš°ìŠ¤ íœ :</strong> ì¤Œ ì¸/ì•„ì›ƒ</li>
                            <li><strong>ë“œë˜ê·¸:</strong> ì§€ë„ ì´ë™</li>
                            <li><strong>í´ë¦­:</strong> ì§€ì—­ ì„ íƒ</li>
                            <li><strong>í˜¸ë²„:</strong> ì§€ì—­ ì •ë³´ ë¯¸ë¦¬ë³´ê¸°</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h4>âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h4>
                        <ul>
                            <li><strong>1:</strong> ì „ ì„¸ê³„ ë³´ê¸°</li>
                            <li><strong>2:</strong> êµ­ê°€ë³„ ë³´ê¸°</li>
                            <li><strong>3:</strong> ì§€ì—­ë³„ ë³´ê¸°</li>
                            <li><strong>Enter:</strong> ì„ íƒëœ ì§€ì—­ êµ¬ë§¤</li>
                            <li><strong>ESC:</strong> íŒ¨ë„ ë‹«ê¸°</li>
                            <li><strong>H:</strong> ì´ ë„ì›€ë§ í‘œì‹œ</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h4>ğŸ¨ ìƒ‰ìƒ ì˜ë¯¸</h4>
                        <ul>
                            <li><span style="color: #4ecdc4;">â—</span> ì²­ë¡ìƒ‰: ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì—­</li>
                            <li><span style="color: #ff6b6b;">â—</span> ë¹¨ê°„ìƒ‰: ê´‘ê³  ì¤‘ì¸ ì§€ì—­</li>
                            <li><span style="color: #feca57;">â—</span> ë…¸ë€ìƒ‰: ì„ íƒëœ ì§€ì—­</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel">ë‹«ê¸°</button>
                </div>
            </div>
        `;
        this.setSafeHTML(helpModal, helpHTML);
        
        document.body.appendChild(helpModal);
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        helpModal.querySelector('.modal-close').addEventListener('click', () => {
            helpModal.remove();
        });
        
        helpModal.querySelector('.modal-overlay').addEventListener('click', () => {
            helpModal.remove();
        });
        
        helpModal.querySelector('.btn-cancel').addEventListener('click', () => {
            helpModal.remove();
        });
    }
    
    // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
    // í–„ë²„ê±° ë©”ë‰´ í† ê¸€ (ê´€ë¦¬ì ì „ìš©)
    toggleMenu() {
        if (!this.isAdminLoggedIn) {
            this.showAdminLoginModal();
            return;
        }
        
        const controlPanel = document.getElementById('control-panel');
        controlPanel.classList.toggle('hidden');
    }
    
    // ë©”ë‰´ ìˆ¨ê¸°ê¸°
    hideMenu() {
        const controlPanel = document.getElementById('control-panel');
        controlPanel.classList.add('hidden');
    }
    
    // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    showUserLoginModal() {
        const modal = document.getElementById('user-login-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }
    
    // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideUserLoginModal() {
        const modal = document.getElementById('user-login-modal');
        if (modal) {
            modal.classList.add('hidden');
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const emailInput = document.getElementById('user-email-input');
            const passwordInput = document.getElementById('user-password-input');
            const errorDiv = document.getElementById('user-login-error');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            if (errorDiv) errorDiv.classList.add('hidden');
        }
    }
    
    // ì‚¬ìš©ì ìƒíƒœ UI ì—…ë°ì´íŠ¸
    updateUserUI() {
        // í—¤ë”ì˜ ë¡œê·¸ì¸ ë²„íŠ¼ë“¤
        const loginBtn = document.getElementById('user-login-btn');
        const logoutBtn = document.getElementById('user-logout-btn');
        const userEmail = document.getElementById('user-email');
        
        // ì‚¬ì´ë“œ ë©”ë‰´ì˜ ë¡œê·¸ì¸ ë²„íŠ¼ë“¤
        const sideLoginBtn = document.getElementById('side-user-login-btn');
        const sideLogoutBtn = document.getElementById('side-user-logout-btn');
        const sideUserEmail = document.getElementById('side-user-email');
        const myPageBtn = document.getElementById('my-page-btn');
        const sideMyPageBtn = document.getElementById('side-my-page-btn');
        
        if (this.currentUser) {
            // ë¡œê·¸ì¸ ìƒíƒœ
            if (loginBtn) loginBtn.classList.add('hidden');
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            if (userEmail) {
                userEmail.textContent = this.currentUser.email;
                userEmail.classList.remove('hidden');
            }
            
            // ì‚¬ì´ë“œ ë©”ë‰´ ì—…ë°ì´íŠ¸
            if (sideLoginBtn) sideLoginBtn.classList.add('hidden');
            if (sideLogoutBtn) sideLogoutBtn.classList.remove('hidden');
            if (sideUserEmail) {
                sideUserEmail.textContent = this.currentUser.email;
                sideUserEmail.classList.remove('hidden');
            }
            if (myPageBtn) myPageBtn.classList.remove('hidden');
            if (sideMyPageBtn) sideMyPageBtn.classList.remove('hidden');
        } else {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
            if (loginBtn) loginBtn.classList.remove('hidden');
            if (logoutBtn) logoutBtn.classList.add('hidden');
            if (userEmail) {
                userEmail.textContent = '';
                userEmail.classList.add('hidden');
            }
            
            // ì‚¬ì´ë“œ ë©”ë‰´ ì—…ë°ì´íŠ¸
            if (sideLoginBtn) sideLoginBtn.classList.remove('hidden');
            if (sideLogoutBtn) sideLogoutBtn.classList.add('hidden');
            if (sideUserEmail) {
                sideUserEmail.textContent = '';
                sideUserEmail.classList.add('hidden');
            }
            if (myPageBtn) myPageBtn.classList.add('hidden');
            if (sideMyPageBtn) sideMyPageBtn.classList.add('hidden');
            this.closeUserDashboard({ silent: true });
        }

        this.updateWalletUIElements();
    }

    createEmptyWalletState() {
        return {
            loading: false,
            balance: 0,
            holdBalance: 0,
            holds: {},
            history: [],
            currency: 'POINT',
            error: null,
            lastUpdated: null
        };
    }

    formatPoints(value) {
        const numeric = Number(value) || 0;
        const isInteger = Number.isInteger(numeric);
        const options = {
            minimumFractionDigits: isInteger ? 0 : 2,
            maximumFractionDigits: isInteger ? 0 : 2
        };
        return `${numeric.toLocaleString(undefined, options)}P`;
    }

    formatDateTime(value) {
        if (!value) {
            return '-';
        }
        const date = typeof value.toDate === 'function' ? value.toDate() : value;
        try {
            return new Intl.DateTimeFormat('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }).format(date);
        } catch (error) {
            return new Date(date).toLocaleString();
        }
    }

    getWalletAvailablePoints(stateOverride = null) {
        const state = stateOverride || this.walletState;
        const balance = Number(state.balance || 0);
        const holdBalance = Number(state.holdBalance || 0);
        return Math.max(0, balance - holdBalance);
    }

    async ensureUserWallet(user) {
        if (!user || !this.firestore) {
            return;
        }
        try {
            const { doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const walletRef = doc(this.firestore, 'wallets', user.uid);
            const walletSnap = await getDoc(walletRef);
            if (!walletSnap.exists()) {
                await setDoc(walletRef, {
                    userId: user.uid,
                    userEmail: user.email || null,
                    balance: 0,
                    holdBalance: 0,
                    holds: {},
                    history: [],
                    currency: 'POINT',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
            }
        } catch (error) {
            console.warn('[ì§€ê°‘] ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
        }
    }

    async subscribeToUserWallet(userId) {
        if (!userId || !this.firestore) {
            return;
        }
        this.teardownWalletSubscription();
        try {
            const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const walletRef = doc(this.firestore, 'wallets', userId);
            this.walletState = { ...this.walletState, loading: true, error: null };
            this.updateWalletUIElements();
            this.walletListener = onSnapshot(walletRef, (snapshot) => {
                this.handleWalletSnapshot(snapshot);
            }, (error) => {
                console.error('[ì§€ê°‘] ì‹¤ì‹œê°„ êµ¬ë… ì˜¤ë¥˜:', error);
                this.walletState = { ...this.createEmptyWalletState(), error: error.message };
                this.updateWalletUIElements();
            });
        } catch (error) {
            console.error('[ì§€ê°‘] êµ¬ë… ì‹¤íŒ¨:', error);
        }
    }

    teardownWalletSubscription() {
        if (this.walletListener) {
            this.walletListener();
            this.walletListener = null;
        }
    }

    handleWalletSnapshot(snapshot) {
        if (!snapshot || !snapshot.exists?.()) {
            this.walletState = { ...this.createEmptyWalletState(), loading: false };
            this.updateWalletUIElements();
            this.populateWalletModal();
            this.syncAuctionWalletSummary();
            return;
        }

        const data = snapshot.data() || {};
        const history = Array.isArray(data.history) ? data.history : [];
        this.walletState = {
            ...this.walletState,
            loading: false,
            balance: Number(data.balance || 0),
            holdBalance: Number(data.holdBalance || 0),
            holds: data.holds || {},
            history,
            currency: data.currency || 'POINT',
            error: null,
            lastUpdated: data.updatedAt ? (typeof data.updatedAt.toDate === 'function' ? data.updatedAt.toDate() : data.updatedAt) : new Date()
        };
        this.updateWalletUIElements();
        this.populateWalletModal();
        this.syncAuctionWalletSummary();
    }

    updateWalletUIElements() {
        const walletBtn = document.getElementById('wallet-btn');
        const walletChip = document.getElementById('wallet-balance-chip');
        const sideWalletBtn = document.getElementById('side-wallet-btn');
        const sideWalletChip = document.getElementById('side-wallet-chip');
        const hasUser = !!this.currentUser;
        // ê´€ë¦¬ìëŠ” í¬ì¸íŠ¸ ì œí•œ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ (ì‹¤ì œ ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
        const available = this.isAdminLoggedIn ? Infinity : this.getWalletAvailablePoints();

        if (walletBtn) {
            walletBtn.classList.toggle('hidden', !hasUser);
        }
        if (sideWalletBtn) {
            sideWalletBtn.classList.toggle('hidden', !hasUser);
        }
        if (walletChip) {
            walletChip.textContent = this.isAdminLoggedIn ? 'ë¬´ì œí•œ' : this.formatPoints(available);
        }
        if (sideWalletChip) {
            if (hasUser) {
                sideWalletChip.classList.remove('hidden');
                sideWalletChip.textContent = this.isAdminLoggedIn ? 'ì”ì•¡ ë¬´ì œí•œ' : `ì”ì•¡ ${this.formatPoints(available)}`;
            } else {
                sideWalletChip.classList.add('hidden');
                sideWalletChip.textContent = 'ì”ì•¡ 0P';
            }
        }

        this.populateWalletModal();
        this.syncAuctionWalletSummary();
    }

    populateWalletModal() {
        const modal = document.getElementById('wallet-modal');
        if (!modal) {
            return;
        }
        const state = this.walletState;
        const balanceEl = document.getElementById('wallet-balance-value');
        const holdEl = document.getElementById('wallet-hold-value');
        const availableEl = document.getElementById('wallet-available-value');
        const lastUpdatedEl = document.getElementById('wallet-last-updated');
        const errorInline = document.getElementById('wallet-error-inline');

        // ê´€ë¦¬ìëŠ” í¬ì¸íŠ¸ ì œí•œ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ (ì‹¤ì œ ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
        if (balanceEl) balanceEl.textContent = this.isAdminLoggedIn ? 'ë¬´ì œí•œ' : this.formatPoints(state.balance);
        if (holdEl) holdEl.textContent = this.isAdminLoggedIn ? 'ë¬´ì œí•œ' : this.formatPoints(state.holdBalance);
        if (availableEl) availableEl.textContent = this.isAdminLoggedIn ? 'ë¬´ì œí•œ' : this.formatPoints(this.getWalletAvailablePoints());
        if (lastUpdatedEl) lastUpdatedEl.textContent = state.lastUpdated ? this.formatDateTime(state.lastUpdated) : '-';

        if (errorInline) {
            if (state.error) {
                errorInline.textContent = state.error;
                errorInline.classList.remove('hidden');
            } else if (state.loading) {
                errorInline.textContent = 'ì§€ê°‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...';
                errorInline.classList.remove('hidden');
            } else {
                errorInline.textContent = '';
                errorInline.classList.add('hidden');
            }
        }

        this.renderWalletHistory(state.history);
    }

    renderWalletHistory(history = []) {
        const container = document.getElementById('wallet-history-list');
        if (!container) {
            return;
        }

        container.innerHTML = '';
        if (!Array.isArray(history) || history.length === 0) {
            const empty = document.createElement('p');
            empty.className = 'wallet-empty';
            empty.textContent = 'ê±°ë˜ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
            container.appendChild(empty);
            return;
        }

        const recentEntries = history.slice(-10).reverse();
        recentEntries.forEach((entry) => {
            const item = document.createElement('div');
            item.className = 'wallet-history-item';

            const meta = document.createElement('div');
            meta.className = 'wallet-history-meta';

            const typeLabel = document.createElement('span');
            typeLabel.className = 'wallet-history-type';
            typeLabel.textContent = this.getWalletHistoryLabel(entry?.type);
            meta.appendChild(typeLabel);

            const desc = document.createElement('div');
            desc.className = 'wallet-history-desc';
            desc.textContent = entry?.description || entry?.note || entry?.meta?.regionName || '-';
            meta.appendChild(desc);

            const time = document.createElement('span');
            time.className = 'wallet-history-time';
            time.textContent = this.formatDateTime(entry?.createdAt || entry?.timestamp);
            meta.appendChild(time);

            const amount = document.createElement('span');
            amount.className = 'wallet-history-amount';
            const value = Number(entry?.amount);
            if (Number.isFinite(value) && value !== 0) {
                amount.classList.add(value >= 0 ? 'positive' : 'negative');
                amount.textContent = `${value >= 0 ? '+' : '-'}${this.formatPoints(Math.abs(value))}`;
            } else {
                amount.textContent = this.formatPoints(value || 0);
            }

            item.appendChild(meta);
            item.appendChild(amount);
            container.appendChild(item);
        });
    }

    getWalletHistoryLabel(type) {
        const map = {
            topup: 'ì¶©ì „',
            hold: 'í™€ë“œ',
            release: 'í•´ì œ',
            spend: 'ì°¨ê°',
            refund: 'í™˜ë¶ˆ'
        };
        return map[type] || 'í™œë™';
    }

    syncAuctionWalletSummary() {
        const modal = document.getElementById('auction-modal');
        if (modal && !modal.classList.contains('hidden')) {
            this.updateAuctionWalletSummary();
        }
    }

    extractMinBidFromModal() {
        const minBidLabel = document.getElementById('min-bid-amount');
        if (!minBidLabel) {
            return 0;
        }
        const numeric = parseFloat(minBidLabel.textContent.replace(/[^0-9.]/g, ''));
        return Number.isFinite(numeric) ? numeric : 0;
    }

    updateAuctionWalletSummary(minBidOverride = null) {
        // ê´€ë¦¬ìëŠ” í¬ì¸íŠ¸ ì œí•œ ì—†ì´ ì‚¬ìš© ê°€ëŠ¥ (ì‹¤ì œ ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
        const available = this.isAdminLoggedIn ? Infinity : this.getWalletAvailablePoints();
        const availableEl = document.getElementById('auction-wallet-available');
        if (availableEl) {
            if (this.isAdminLoggedIn) {
                availableEl.textContent = 'ë¬´ì œí•œ';
            } else {
                availableEl.textContent = this.formatPoints(available);
            }
        }
        const warningEl = document.getElementById('auction-wallet-warning');
        const minBid = typeof minBidOverride === 'number' ? minBidOverride : this.extractMinBidFromModal();
        if (warningEl) {
            // ê´€ë¦¬ìëŠ” ê²½ê³  í‘œì‹œ ì•ˆ í•¨
            if (this.isAdminLoggedIn) {
                warningEl.classList.add('hidden');
            } else if (minBid > 0 && available < minBid) {
                warningEl.classList.remove('hidden');
            } else {
                warningEl.classList.add('hidden');
            }
        }
    }

    openWalletModal() {
        if (!this.currentUser) {
            this.showNotification('í¬ì¸íŠ¸ ì§€ê°‘ì„ í™•ì¸í•˜ë ¤ë©´ ë¡œê·¸ì¸í•˜ì„¸ìš”.', 'warning');
            this.showUserLoginModal();
            return;
        }
        const modal = document.getElementById('wallet-modal');
        if (!modal) {
            return;
        }
        this.populateWalletModal();
        modal.classList.remove('hidden');
    }

    closeWalletModal() {
        const modal = document.getElementById('wallet-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }

    bindWalletModalEvents() {
        const closeBtn = document.getElementById('close-wallet-modal');
        if (closeBtn && !closeBtn.dataset.bound) {
            closeBtn.dataset.bound = 'true';
            closeBtn.addEventListener('click', () => this.closeWalletModal());
        }

        const modal = document.getElementById('wallet-modal');
        if (modal && !modal.dataset.bound) {
            modal.dataset.bound = 'true';
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeWalletModal();
                }
            });
        }

        const topUpBtn = document.getElementById('wallet-topup-btn');
        if (topUpBtn && !topUpBtn.dataset.bound) {
            topUpBtn.dataset.bound = 'true';
            topUpBtn.addEventListener('click', () => this.handleWalletTopUpRequest());
        }

        const refreshBtn = document.getElementById('wallet-refresh-btn');
        if (refreshBtn && !refreshBtn.dataset.bound) {
            refreshBtn.dataset.bound = 'true';
            refreshBtn.addEventListener('click', () => this.refreshWalletSnapshot());
        }
    }

    async refreshWalletSnapshot(showToast = true) {
        if (!this.currentUser || !this.firestore || this.walletRefreshInFlight) {
            return;
        }
        this.walletRefreshInFlight = true;
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const walletRef = doc(this.firestore, 'wallets', this.currentUser.uid);
            const walletSnap = await getDoc(walletRef);
            this.handleWalletSnapshot(walletSnap);
            if (showToast) {
                this.showNotification('ì§€ê°‘ ì”ì•¡ì„ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.', 'success');
            }
        } catch (error) {
            console.error('[ì§€ê°‘] ìƒˆë¡œê³ ì¹¨ ì‹¤íŒ¨:', error);
            if (showToast) {
                this.showNotification('ì§€ê°‘ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        } finally {
            this.walletRefreshInFlight = false;
        }
    }

    handleWalletTopUpRequest() {
        // í¬ì¸íŠ¸ ì¶©ì „ ê¸ˆì•¡ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
        this.showWalletTopUpModal();
    }

    showWalletTopUpModal() {
        // ê°„ë‹¨í•œ ê¸ˆì•¡ ì„ íƒ UI (ë˜ëŠ” ì…ë ¥ í•„ë“œ)
        const amounts = [10, 25, 50, 100, 200, 500];
        const selectedAmount = prompt(`í¬ì¸íŠ¸ ì¶©ì „ ê¸ˆì•¡ì„ ì„ íƒí•˜ì„¸ìš”:\n${amounts.map(a => `$${a}`).join(', ')}\në˜ëŠ” ì§ì ‘ ì…ë ¥í•˜ì„¸ìš” (USD):`);
        
        if (!selectedAmount) {
            return; // ì·¨ì†Œ
        }

        const amount = parseFloat(selectedAmount);
        if (isNaN(amount) || amount <= 0) {
            this.showNotification('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }

        // PayPal ë²„íŠ¼ ë Œë”ë§
        this.renderWalletPayPalButtons(amount);
    }

    renderWalletPayPalButtons(amount) {
        try {
            const container = document.getElementById('wallet-paypal-buttons');
            if (!container) {
                this.showNotification('ê²°ì œ ë²„íŠ¼ì„ í‘œì‹œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            // ê¸°ì¡´ ë²„íŠ¼ ì œê±°
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }

            if (!(window.paypal && window.paypal.Buttons)) {
                this.showNotification('ê²°ì œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            // í¬ì¸íŠ¸ í™˜ì‚° (1 USD = 100 í¬ì¸íŠ¸ë¡œ ê°€ì •, í•„ìš”ì‹œ ì¡°ì •)
            const pointsToAdd = Math.floor(amount * 100);
            const description = `í¬ì¸íŠ¸ ì¶©ì „: $${amount.toFixed(2)} (${pointsToAdd.toLocaleString()}P)`;

            window.paypal.Buttons({
                style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: description,
                            amount: {
                                currency_code: 'USD',
                                value: String(amount.toFixed(2))
                            }
                        }]
                    });
                },
                onApprove: async (data, actions) => {
                    try {
                        const details = await actions.order.capture();
                        const orderId = details.id;
                        const buyerEmail = details.payer?.email_address || details.payer?.payer_info?.email || this.currentUser?.email;

                        // ì§€ê°‘ì— í¬ì¸íŠ¸ ì¶”ê°€
                        if (this.isFirebaseInitialized && this.currentUser) {
                            await this.addPointsToWallet(this.currentUser.uid, pointsToAdd, orderId, amount, buyerEmail);
                            this.showNotification(`í¬ì¸íŠ¸ ${pointsToAdd.toLocaleString()}Pê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
                            
                            // ì§€ê°‘ UI ìƒˆë¡œê³ ì¹¨
                            await this.refreshWalletSnapshot(true);
                            
                            // PayPal ë²„íŠ¼ ì œê±°í•˜ê³  ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                            const successDiv = document.createElement('div');
                            successDiv.style.color = '#2ecc71';
                            successDiv.style.fontWeight = '600';
                            successDiv.style.padding = '10px';
                            successDiv.style.textAlign = 'center';
                            successDiv.textContent = `âœ… í¬ì¸íŠ¸ ì¶©ì „ ì™„ë£Œ: ${pointsToAdd.toLocaleString()}P`;
                            container.innerHTML = '';
                            container.appendChild(successDiv);
                        } else {
                            this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                        }
                    } catch (err) {
                        console.error('PayPal capture error:', err);
                        this.showNotification('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                },
                onCancel: () => {
                    this.showNotification('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                },
                onError: (err) => {
                    console.error('PayPal error:', err);
                    this.showNotification('ê²°ì œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }).render('#wallet-paypal-buttons');
        } catch (e) {
            console.error('renderWalletPayPalButtons error:', e);
            this.showNotification('ê²°ì œ ë²„íŠ¼ ë Œë”ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    async addPointsToWallet(userId, points, orderId, amount, buyerEmail) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }

        try {
            const { doc, runTransaction, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const walletRef = doc(this.firestore, 'wallets', userId);

            await runTransaction(this.firestore, async (transaction) => {
                const walletSnap = await transaction.get(walletRef);
                
                let walletData;
                if (walletSnap.exists()) {
                    walletData = walletSnap.data();
                } else {
                    walletData = {
                        balance: 0,
                        holdBalance: 0,
                        holds: {},
                        history: []
                    };
                }

                const currentBalance = Number(walletData.balance || 0);
                const newBalance = currentBalance + points;
                const history = walletData.history || [];

                transaction.set(walletRef, {
                    balance: newBalance,
                    holdBalance: Number(walletData.holdBalance || 0),
                    holds: walletData.holds || {},
                    history: [...history, {
                        type: 'topup',
                        amount: points,
                        usdAmount: amount,
                        orderId: orderId,
                        timestamp: serverTimestamp()
                    }],
                    updatedAt: serverTimestamp()
                }, { merge: true });
            });

            // êµ¬ë§¤ ê¸°ë¡ë„ ì €ì¥ (ì„ íƒì )
            try {
                const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                await addDoc(collection(this.firestore, 'purchases'), {
                    type: 'wallet_topup',
                    buyerId: userId,
                    buyerEmail: buyerEmail || 'unknown@example.com',
                    amount: amount,
                    points: points,
                    paypalOrderId: orderId,
                    purchaseDate: serverTimestamp(),
                    status: 'completed'
                });
            } catch (purchaseError) {
                console.warn('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ ì‹¤íŒ¨ (ë¬´ì‹œ ê°€ëŠ¥):', purchaseError);
            }

            console.log(`[ì§€ê°‘] í¬ì¸íŠ¸ ì¶©ì „ ì™„ë£Œ: ${userId}, ${points}P ì¶”ê°€`);
        } catch (error) {
            console.error('[ì§€ê°‘] í¬ì¸íŠ¸ ì¶©ì „ ì‹¤íŒ¨:', error);
            throw error;
        }
    }
    
    // ì‚¬ì´ë“œ ë©”ë‰´ í† ê¸€
    toggleSideMenu() {
        const sideMenu = document.getElementById('side-menu');
        if (sideMenu) {
            sideMenu.classList.toggle('hidden');
        }
    }
    
    // ì‚¬ì´ë“œ ë©”ë‰´ í‘œì‹œ
    showSideMenu() {
        const sideMenu = document.getElementById('side-menu');
        if (sideMenu) {
            sideMenu.classList.remove('hidden');
        }
    }
    
    // ì‚¬ì´ë“œ ë©”ë‰´ ìˆ¨ê¹€
    hideSideMenu() {
        const sideMenu = document.getElementById('side-menu');
        if (sideMenu) {
            sideMenu.classList.add('hidden');
        }
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    showAdminLoginModal() {
        console.log('ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ ì‹œë„');
        const modal = document.getElementById('admin-login-modal');
        if (modal) {
            modal.classList.remove('hidden');
            console.log('ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œë¨');
            
            // ëª¨ë‹¬ í‘œì‹œ í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¬í™•ì¸ ë° ì¬ë“±ë¡
            const adminLoginSubmit = document.getElementById('admin-login-submit');
            if (adminLoginSubmit) {
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì¤‘ë³µ ë°©ì§€)
                const newSubmitBtn = adminLoginSubmit.cloneNode(true);
                adminLoginSubmit.parentNode.replaceChild(newSubmitBtn, adminLoginSubmit);
                
                // ìƒˆë¡œìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                newSubmitBtn.addEventListener('click', async (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('[ADMIN] ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­ë¨ (ëª¨ë‹¬ í‘œì‹œ í›„ ì¬ë“±ë¡)');
                    try {
                        await this.handleAdminLogin();
                    } catch (error) {
                        console.error('[ADMIN] ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                        const errorDiv = document.getElementById('login-error');
                        if (errorDiv) {
                            errorDiv.classList.remove('hidden');
                            this.setSafeHTML(errorDiv, 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        }
                        this.showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                });
                
                // Enter í‚¤ ì´ë²¤íŠ¸ë„ ì¬ë“±ë¡
                const adminUsername = document.getElementById('admin-username');
                const adminPassword = document.getElementById('admin-password');
                if (adminUsername && adminPassword) {
                    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                    const newUsername = adminUsername.cloneNode(true);
                    const newPassword = adminPassword.cloneNode(true);
                    adminUsername.parentNode.replaceChild(newUsername, adminUsername);
                    adminPassword.parentNode.replaceChild(newPassword, adminPassword);
                    
                    const handleEnterKey = async (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            console.log('[ADMIN] Enter í‚¤ë¡œ ë¡œê·¸ì¸ ì‹œë„');
                            try {
                                await this.handleAdminLogin();
                            } catch (error) {
                                console.error('[ADMIN] ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                                const errorDiv = document.getElementById('login-error');
                                if (errorDiv) {
                                    errorDiv.classList.remove('hidden');
                                    this.setSafeHTML(errorDiv, 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                                }
                                this.showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                            }
                        }
                    };
                    newUsername.addEventListener('keypress', handleEnterKey);
                    newPassword.addEventListener('keypress', handleEnterKey);
                    
                    // í¬ì»¤ìŠ¤ ì„¤ì •
                    setTimeout(() => {
                        newUsername.focus();
                    }, 100);
                }
            } else {
                console.error('[ADMIN] admin-login-submit ë²„íŠ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            }
        } else {
            console.error('admin-login-modal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideAdminLoginModal() {
        const modal = document.getElementById('admin-login-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        const usernameInput = document.getElementById('admin-username');
        const passwordInput = document.getElementById('admin-password');
        const errorDiv = document.getElementById('login-error');
        
        if (usernameInput) usernameInput.value = '';
        if (passwordInput) passwordInput.value = '';
        if (errorDiv) errorDiv.classList.add('hidden');
    }

    getStoredAdminSession() {
        if (typeof window === 'undefined' || !window.localStorage) {
            return null;
        }
        try {
            const raw = window.localStorage.getItem(this.ADMIN_SESSION_KEY);
            if (!raw) {
                return null;
            }
            const parsed = JSON.parse(raw);
            // Functions ì—†ì´ ì‚¬ìš©í•˜ë¯€ë¡œ signature ì—†ì´ë„ ìœ íš¨
            if (!parsed || !parsed.sessionId) {
                return null;
            }
            return parsed;
        } catch (error) {
            console.warn('[ADMIN] ì„¸ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
            return null;
        }
    }

    isAdminSessionExpired(session) {
        if (!session) return true;
        const expiresAt = Number(session.expiresAt);
        if (!Number.isFinite(expiresAt)) {
            return true;
        }
        return expiresAt <= Date.now();
    }

    persistAdminSession(session) {
        if (typeof window === 'undefined' || !window.localStorage) {
            return;
        }
        if (!session || !session.sessionId) {
            return;
        }
        try {
            // Functions ì—†ì´ ì‚¬ìš©í•˜ë¯€ë¡œ signature ì—†ì´ ì €ì¥
            const payload = {
                sessionId: session.sessionId,
                issuedAt: session.issuedAt,
                expiresAt: session.expiresAt,
                username: session.username || null
            };
            window.localStorage.setItem(this.ADMIN_SESSION_KEY, JSON.stringify(payload));
        } catch (error) {
            console.warn('[ADMIN] ì„¸ì…˜ ì •ë³´ë¥¼ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
        }
    }
    
    // ì„¸ì…˜ ID ìƒì„± í•¨ìˆ˜
    generateSessionId() {
        const array = new Uint8Array(32);
        crypto.getRandomValues(array);
        return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
    }

    clearPersistedAdminSession() {
        if (typeof window === 'undefined' || !window.localStorage) {
            return;
        }
        try {
            window.localStorage.removeItem(this.ADMIN_SESSION_KEY);
        } catch (error) {
            console.warn('[ADMIN] ì„¸ì…˜ ì •ë³´ë¥¼ ì‚­ì œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', error);
        }
    }

    setupAdminSessionSync() {
        if (this.hasSessionSync || typeof window === 'undefined') {
            return;
        }
        this.hasSessionSync = true;
        window.addEventListener('storage', (event) => {
            if (event.key !== this.ADMIN_SESSION_KEY) {
                return;
            }
            if (!event.newValue) {
                this.handleExternalAdminLogout();
                return;
            }
            try {
                const parsed = JSON.parse(event.newValue);
                if (this.isAdminSessionExpired(parsed)) {
                    return;
                }
                if (!this.firebaseAuth || !this.isFirebaseInitialized) {
                    return;
                }
                if (this.firebaseAuth.currentUser) {
                    return;
                }
                this.tryResumeAdminSession(parsed);
            } catch (error) {
                console.warn('[ADMIN] ì„¸ì…˜ ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜', error);
            }
        });
    }

    async handleExternalAdminLogout() {
        this.disableAdminMode({ silent: true });
        this.clearPersistedAdminSession();
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            return;
        }
        if (!this.firebaseAuth.currentUser) {
            return;
        }
        try {
            const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await signOut(this.firebaseAuth);
        } catch (error) {
            console.warn('[ADMIN] ì™¸ë¶€ ì„¸ì…˜ ì¢…ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨', error);
        }
    }

    async tryResumeAdminSession(sessionOverride = null) {
        if (this.sessionResumeInFlight) {
            return false;
        }
        const session = sessionOverride || this.getStoredAdminSession();
        if (!session) {
            return false;
        }
        if (this.isAdminSessionExpired(session)) {
            this.clearPersistedAdminSession();
            return false;
        }

        // Firestoreì—ì„œ ì„¸ì…˜ í™•ì¸ (Functions ì—†ì´)
        if (this.isFirebaseInitialized && this.firestore && session.sessionId) {
            try {
                const { collection, query, where, getDocs, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const sessionsRef = collection(this.firestore, 'admin_sessions');
                const q = query(sessionsRef, where('sessionId', '==', session.sessionId));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    const sessionDoc = snapshot.docs[0].data();
                    const expiresAt = sessionDoc.expiresAt?.toMillis?.() || sessionDoc.expiresAt;
                    
                    if (expiresAt && expiresAt > Date.now()) {
                        console.log('[ADMIN] Firestoreì—ì„œ ì„¸ì…˜ í™•ì¸ë¨');
                        this.isAdminLoggedIn = true;
                        this.switchToAdminMode();
                        return true;
                    } else {
                        console.log('[ADMIN] ì„¸ì…˜ì´ ë§Œë£Œë¨');
                        this.clearPersistedAdminSession();
                        return false;
                    }
                } else {
                    console.log('[ADMIN] Firestoreì—ì„œ ì„¸ì…˜ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    // Firestoreì— ì—†ì–´ë„ localStorageì— ìˆìœ¼ë©´ í—ˆìš© (ì½ê¸° ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ)
                }
            } catch (error) {
                console.warn('[ADMIN] ì„¸ì…˜ í™•ì¸ ì‹¤íŒ¨ (ì½ê¸° ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ):', error);
                // ì—ëŸ¬ê°€ ìˆì–´ë„ localStorage ì„¸ì…˜ì´ ìˆìœ¼ë©´ í—ˆìš©
            }
        }

        // ì„¸ì…˜ì´ ìœ íš¨í•˜ë©´ ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”
        this.isAdminLoggedIn = true;
        this.switchToAdminMode();
        return true;
    }
    
    // ê°„ë‹¨í•œ í•´ì‹œ í•¨ìˆ˜ (í´ë¼ì´ì–¸íŠ¸ ì¸¡)
    async simpleHash(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }

    // ê´€ë¦¬ì ë¡œê·¸ì¸ ì²˜ë¦¬ (Firestore ê¸°ë°˜, Functions ì—†ì´)
    async handleAdminLogin() {
        console.log('[ADMIN] handleAdminLogin ì‹œì‘');
        
        const usernameInput = document.getElementById('admin-username');
        const passwordInput = document.getElementById('admin-password');
        const errorDiv = document.getElementById('login-error');
        
        if (!usernameInput || !passwordInput) {
            console.error('[ADMIN] ì…ë ¥ í•„ë“œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            if (errorDiv) {
                errorDiv.classList.remove('hidden');
                this.setSafeHTML(errorDiv, 'ë¡œê·¸ì¸ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            this.showNotification('ë¡œê·¸ì¸ í¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        
        console.log('[ADMIN] ì…ë ¥ê°’ í™•ì¸:', { username: username ? 'ì…ë ¥ë¨' : 'ë¹„ì–´ìˆìŒ', password: password ? 'ì…ë ¥ë¨' : 'ë¹„ì–´ìˆìŒ' });
        
        // ì…ë ¥ê°’ ê²€ì¦
        if (!username || !password) {
            console.warn('[ADMIN] ì…ë ¥ê°’ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤');
            if (errorDiv) {
                errorDiv.classList.remove('hidden');
                this.setSafeHTML(errorDiv, 'ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
            this.showNotification('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        
        // Rate Limiting í™•ì¸
        const identifier = this.getUserIdentifier();
        const rateLimit = this.checkLoginRateLimit(identifier);
        
        if (!rateLimit.allowed) {
            errorDiv.classList.remove('hidden');
            const message = rateLimit.lockoutTime > 0 
                ? `ë„ˆë¬´ ë§ì€ ë¡œê·¸ì¸ ì‹œë„ê°€ ìˆì—ˆìŠµë‹ˆë‹¤. ${rateLimit.lockoutTime}ë¶„ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`
                : 'ë¡œê·¸ì¸ ì‹œë„ê°€ ì œí•œë˜ì—ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            this.setSafeHTML(errorDiv, message);
            this.showNotification(message, 'error');
            return;
        }
        
        try {
            console.log('[ADMIN] Firebase ì´ˆê¸°í™” í™•ì¸ ì¤‘...');
            if (!this.isFirebaseInitialized || !this.firestore) {
                console.log('[ADMIN] Firebase ì´ˆê¸°í™” ì‹œì‘...');
                await this.initializeFirebase();
                console.log('[ADMIN] Firebase ì´ˆê¸°í™” ì™„ë£Œ');
            }

            console.log('[ADMIN] Firestore ëª¨ë“ˆ import ì¤‘...');
            // Firestore ëª¨ë“ˆì‹ API import
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            console.log('[ADMIN] Firestore ëª¨ë“ˆ import ì™„ë£Œ');

            // Firestoreì—ì„œ ê´€ë¦¬ì ì •ë³´ í™•ì¸
            console.log('[ADMIN] Firestoreì—ì„œ ê´€ë¦¬ì ì •ë³´ í™•ì¸ ì¤‘...');
            const adminDocRef = doc(this.firestore, 'admin', 'credentials');
            const adminDoc = await getDoc(adminDocRef);
            console.log('[ADMIN] ê´€ë¦¬ì ë¬¸ì„œ í™•ì¸ ì™„ë£Œ:', adminDoc.exists() ? 'ì¡´ì¬í•¨' : 'ì—†ìŒ');
            
            const usernameHash = await this.simpleHash(username.trim());
            const passwordHash = await this.simpleHash(password);

            // ê¸°ë³¸ê°’: admin / admin123 (ì²˜ìŒ ì„¤ì • ì‹œ ì‚¬ìš©)
            const defaultUsernameHash = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'; // admin
            const defaultPasswordHash = '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9'; // admin123

            // ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©, ìˆìœ¼ë©´ ì €ì¥ëœ ê°’ ì‚¬ìš©
            let storedUsernameHash = defaultUsernameHash;
            let storedPasswordHash = defaultPasswordHash;
            
            if (adminDoc.exists()) {
                const adminData = adminDoc.data();
                storedUsernameHash = adminData.usernameHash || defaultUsernameHash;
                storedPasswordHash = adminData.passwordHash || defaultPasswordHash;
            }

            console.log('[ADMIN] ìê²©ì¦ëª… ê²€ì¦ ì¤‘...');
            if (usernameHash !== storedUsernameHash || passwordHash !== storedPasswordHash) {
                console.warn('[ADMIN] ìê²©ì¦ëª… ë¶ˆì¼ì¹˜');
                throw new Error('ì˜ëª»ëœ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤.');
            }
            console.log('[ADMIN] ìê²©ì¦ëª… ê²€ì¦ ì„±ê³µ');

            // Functions ì—†ì´ Firestoreì— ì„¸ì…˜ ì§ì ‘ ìƒì„±
            console.log('[ADMIN] Firestore ê¸°ë°˜ ì„¸ì…˜ ìƒì„± (Functions ì—†ìŒ)');
            
            // ì„¸ì…˜ ID ìƒì„± (ëœë¤ ë¬¸ìì—´)
            const sessionId = this.generateSessionId();
            const issuedAt = Date.now();
            const expiresAt = issuedAt + (2 * 60 * 60 * 1000); // 2ì‹œê°„ ìœ íš¨
            
            // ì„¸ì…˜ ë°ì´í„°
            const session = {
                sessionId,
                issuedAt,
                expiresAt,
                username: username.trim(),
                userAgent: navigator.userAgent,
                createdAt: new Date().toISOString()
            };
            
            // Firestoreì— ì„¸ì…˜ ì €ì¥
            const { collection, addDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const sessionsRef = collection(this.firestore, 'admin_sessions');
            
            try {
                await addDoc(sessionsRef, {
                    sessionId,
                    issuedAt: Timestamp.fromMillis(issuedAt),
                    expiresAt: Timestamp.fromMillis(expiresAt),
                    username: username.trim(),
                    userAgent: navigator.userAgent,
                    createdAt: Timestamp.now()
                });
                console.log('[ADMIN] ì„¸ì…˜ì´ Firestoreì— ì €ì¥ë¨');
            } catch (sessionError) {
                console.error('[ADMIN] ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', sessionError);
                // ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨í•´ë„ ë¡œê·¸ì¸ì€ ì§„í–‰ (ì½ê¸° ê¶Œí•œ ë¬¸ì œì¼ ìˆ˜ ìˆìŒ)
            }
            
            // localStorageì— ì„¸ì…˜ ì €ì¥
            this.persistAdminSession(session);
            this.recordLoginAttempt(identifier, true);

            console.log('[ADMIN] ë¡œê·¸ì¸ ì„±ê³µ, ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘...');
            this.isAdminLoggedIn = true;
            console.log('[ADMIN] isAdminLoggedIn =', this.isAdminLoggedIn);
            
            this.hideAdminLoginModal();
            console.log('[ADMIN] ëª¨ë‹¬ ë‹«ê¸° ì™„ë£Œ');
            
            // admin.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
            console.log('[ADMIN] ê´€ë¦¬ì í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì¤€ë¹„...');
            this.showNotification('ê´€ë¦¬ì í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤...', 'success');
            setTimeout(() => {
                console.log('[ADMIN] admin.htmlë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤í–‰');
                window.location.href = 'admin.html';
            }, 600);
        } catch (error) {
            console.error('[ADMIN] ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            console.error('[ADMIN] ì˜¤ë¥˜ ìŠ¤íƒ:', error.stack);
            this.recordLoginAttempt(identifier, false);
            if (errorDiv) {
                errorDiv.classList.remove('hidden');
                const message = error?.message || 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                this.setSafeHTML(errorDiv, message);
                this.showNotification(message, 'error');
            } else {
                const message = error?.message || 'ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                this.showNotification(message, 'error');
            }
            // ì—ëŸ¬ë¥¼ ë‹¤ì‹œ throwí•˜ì—¬ í˜¸ì¶œìê°€ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡
            throw error;
        }
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    async handleAdminLogout() {
        this.clearPersistedAdminSession();
        await this.logoutUser();
        this.disableAdminMode({ silent: true });
        console.log('ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ');
    }
    
    // ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜
    switchToAdminMode() {
        this.adminMode = true; // ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”
        this.updateAdminModeControls();
        
        // ê¸°ì¡´ì— ì—´ë¦° ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        this.hideCompanyInfoModal();
        
        // í—¤ë” ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (UIê°€ ë³´ì¼ ë•Œë§Œ)
        if (this.uiVisible) {
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            if (adminLoginBtn) adminLoginBtn.classList.add('hidden');
            if (adminLogoutBtn) adminLogoutBtn.classList.remove('hidden');
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ê´€ë¦¬ì ì„¹ì…˜ì€ ìˆ¨ê¹€)
        const sideAdminSection = document.getElementById('side-admin-section');
        if (sideAdminSection) {
            sideAdminSection.style.display = 'none'; // ê´€ë¦¬ì ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        }
        
        // ê´€ë¦¬ì íŒ¨ë„ì€ Pí‚¤ ì—°íƒ€ë¡œë§Œ í‘œì‹œ (ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
        // this.showAdminPanel(); // ì œê±°
        
        console.log('ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜');
    }
    
    // ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œë¡œ ì „í™˜
    switchToUserMode() {
        this.disableAdminMode({ silent: true });
        
        // í—¤ë” ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (UIê°€ ë³´ì¼ ë•Œë§Œ)
        if (this.uiVisible) {
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            if (adminLoginBtn) adminLoginBtn.classList.remove('hidden');
            if (adminLogoutBtn) adminLogoutBtn.classList.add('hidden');
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ê´€ë¦¬ì ì„¹ì…˜ì€ ìˆ¨ê¹€)
        const sideAdminSection = document.getElementById('side-admin-section');
        if (sideAdminSection) {
            sideAdminSection.style.display = 'none'; // ê´€ë¦¬ì ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        }

        // ì¢Œì¸¡ íŒ¨ë„ ìˆ¨ê¸°ê¸°
        this.hideMenu();
        
        console.log('ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œë¡œ ì „í™˜');
    }
    
    updateAdminModeControls() {
        const adminExitBtn = document.getElementById('admin-exit-btn');
        if (adminExitBtn) {
            if (this.isAdminLoggedIn && this.adminMode) {
                adminExitBtn.classList.remove('hidden');
            } else {
                adminExitBtn.classList.add('hidden');
            }
        }
    }
    
    disableAdminMode(options = {}) {
        const { silent = false } = options;
        
        if (!this.adminMode) {
            this.updateAdminModeControls();
            return;
        }
        
        this.adminMode = false;
        this.hideAdminPanel();
        
        if (this.map && this.map.setFilter) {
            try {
                this.map.setFilter('regions-hover', ['==', 'id', '']);
            } catch (error) {
                console.warn('regions-hover í•„í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }
        
        this.selectedStateId = null;
        this.currentRegion = null;
        this.updateAdminModeControls();
        
        if (!silent) {
            this.showNotification('ê´€ë¦¬ì ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }
    }
    
    toggleAdminMode() {
        if (!this.isAdminLoggedIn) {
            this.showAdminLoginModal();
            return;
        }
        
        if (this.adminMode) {
            this.disableAdminMode();
            return;
        }
        
        this.adminMode = true;
        this.showAdminPanel();
        this.updateAdminModeControls();
        this.showNotification('ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    // ë¡œê³  í¸ì§‘ ëª¨ë“œ í† ê¸€
    toggleLogoEditMode() {
        this.logoEditMode = !this.logoEditMode;
        const logoEditBtn = document.getElementById('logo-edit-mode');
        
        if (this.logoEditMode) {
            logoEditBtn.textContent = 'ë¡œê³  í¸ì§‘ (ON)';
            logoEditBtn.classList.add('active');
            this.map.getCanvas().style.cursor = 'crosshair';
        } else {
            logoEditBtn.textContent = 'ë¡œê³  í¸ì§‘';
            logoEditBtn.classList.remove('active');
            this.map.getCanvas().style.cursor = '';
        }
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
    showAdminPanel() {
        const panel = document.getElementById('admin-panel');
        if (panel) {
            panel.classList.remove('hidden');
            console.log('ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œë¨');
        } else {
            console.error('admin-panel ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ ìˆ¨ê¸°ê¸°
    hideAdminPanel() {
        const panel = document.getElementById('admin-panel');
        if (panel) {
            panel.classList.add('hidden');
        }
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì—…ë¡œë“œ
    async uploadLogo() {
        if (!this.selectedStateId) {
            this.showNotification('ë¨¼ì € ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        const fileInput = document.getElementById('logo-file-input');
        const file = fileInput.files[0];
        
        if (!file) {
            this.showNotification('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // íŒŒì¼ ê²€ì¦
        try {
            await this.validateImageFile(file);
        } catch (error) {
            this.showNotification(error.message, 'error');
            return;
        }
        
        // ê°„ë‹¨í•œ FileReader ì‚¬ìš©
        const reader = new FileReader();
        reader.onload = (e) => {
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë¡œê³  ë°ì´í„° ì €ì¥ì†Œì— ì €ì¥
        const logoData = {
            src: e.target.result,
            size: 80, // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            opacity: 0.8,
            rotation: 0
        };
        
        if (this.currentMapMode === 'korea') {
            this.koreaLogoData[this.selectedStateId] = logoData;
        } else {
            this.logoData[this.selectedStateId] = logoData;
        }
            
            this.updateLogoPreview();
            this.showNotification('ë¡œê³ ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            console.log('ë¡œê³  ì—…ë¡œë“œ ì™„ë£Œ:', this.selectedStateId);
        };
        
        reader.onerror = () => {
            this.showNotification('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        };
        
        reader.readAsDataURL(file);
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateLogoPreview() {
        if (!this.selectedStateId) return;
        
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[this.selectedStateId]
            : this.logoData[this.selectedStateId];
        const currentLogoImg = document.getElementById('current-logo-img');
        const noLogo = document.getElementById('no-logo');
        const sizeValue = document.getElementById('logo-size-value');
        const opacityValue = document.getElementById('logo-opacity-value');
        const rotationValue = document.getElementById('logo-rotation-value');
        
        if (logoData) {
            currentLogoImg.src = logoData.src;
            currentLogoImg.style.display = 'block';
            noLogo.style.display = 'none';
            
            // ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
            document.getElementById('logo-size').value = logoData.size;
            document.getElementById('logo-opacity').value = logoData.opacity;
            document.getElementById('logo-rotation').value = logoData.rotation;
            
            // ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì ìš©
            currentLogoImg.style.width = logoData.size + 'px';
            currentLogoImg.style.height = logoData.size + 'px';
            currentLogoImg.style.opacity = logoData.opacity;
            currentLogoImg.style.transform = `rotate(${logoData.rotation}deg)`;
            
            // ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
            sizeValue.textContent = logoData.size + 'px';
            opacityValue.textContent = Math.round(logoData.opacity * 100) + '%';
            rotationValue.textContent = logoData.rotation + 'Â°';
        } else {
            currentLogoImg.style.display = 'none';
            noLogo.style.display = 'block';
        }
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì €ì¥ (ìƒ‰ìƒ í¬í•¨)
    saveLogo() {
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanLogoData[this.selectedStateId]
            : this.logoData[this.selectedStateId];
        const colorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanColorData[this.selectedStateId]
            : this.colorData[this.selectedStateId];
        
        // ë¡œê³  ë°ì´í„° ì—…ë°ì´íŠ¸
        if (logoData) {
            logoData.size = parseInt(document.getElementById('logo-size').value) || 80; // ê¸°ë³¸ê°’ì„ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            logoData.opacity = parseFloat(document.getElementById('logo-opacity').value) || 0.8;
            logoData.rotation = parseInt(document.getElementById('logo-rotation').value) || 0;
            
            // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
            if (this.currentMapMode === 'korea') {
                this.koreaLogoData[this.selectedStateId] = logoData;
            } else if (this.currentMapMode === 'japan') {
                this.japanLogoData[this.selectedStateId] = logoData;
            } else {
                this.logoData[this.selectedStateId] = logoData;
            }
            
            // ì§€ë„ì— ë¡œê³  í‘œì‹œ
            this.displayLogoOnMapSimple(this.selectedStateId, logoData);
        }
        
        // ìƒ‰ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì ìš©
        const currentColorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanColorData[this.selectedStateId]
            : this.colorData[this.selectedStateId];
            
        console.log('saveLogoì—ì„œ ìƒ‰ìƒ ë°ì´í„° í™•ì¸:', this.selectedStateId, currentColorData, 'ëª¨ë“œ:', this.currentMapMode);
        console.log('í•œêµ­ ìƒ‰ìƒ ë°ì´í„°:', this.koreaColorData);
        console.log('ë¯¸êµ­ ìƒ‰ìƒ ë°ì´í„°:', this.colorData);
            
        if (currentColorData) {
            // ìƒ‰ìƒ ë°ì´í„° í˜•ì‹ í†µì¼ (regionColor -> fillColor)
            const normalizedColorData = {
                fillColor: currentColorData.fillColor || currentColorData.regionColor || '#4ecdc4',
                borderColor: currentColorData.borderColor || '#ffffff',
                borderWidth: currentColorData.borderWidth || 1
            };
            this.applyColorToMap(this.selectedStateId, normalizedColorData);
        } else {
            console.warn('ìƒ‰ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
            // ê¸°ë³¸ ìƒ‰ìƒ ë°ì´í„° ìƒì„±
            const defaultColorData = {
                fillColor: '#4ecdc4',
                borderColor: '#ffffff',
                borderWidth: 1
            };
            
            // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ìƒ‰ìƒ ë°ì´í„° ì €ì¥
            if (this.currentMapMode === 'korea') {
                this.koreaColorData[this.selectedStateId] = defaultColorData;
            } else if (this.currentMapMode === 'japan') {
                this.japanColorData[this.selectedStateId] = defaultColorData;
            } else {
                this.colorData[this.selectedStateId] = defaultColorData;
            }
            
            this.applyColorToMap(this.selectedStateId, defaultColorData);
        }
        
        this.showNotification('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ë¡œê³  ë° ìƒ‰ìƒ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, { logoData, currentColorData });
    }
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©
    applyPresetColor(fillColor, borderColor) {
        if (!this.selectedStateId) {
            this.showNotification('ìƒ‰ìƒì„ ì ìš©í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©:', fillColor, borderColor);
        
        // ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        const regionColorInput = document.getElementById('region-color');
        const borderColorInput = document.getElementById('border-color');
        
        if (regionColorInput) regionColorInput.value = fillColor;
        if (borderColorInput) borderColorInput.value = borderColor;
        
        // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        const colorData = {
            fillColor: fillColor,
            borderColor: borderColor,
            borderWidth: 1
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaColorData[this.selectedStateId] = colorData;
        } else if (this.currentMapMode === 'japan') {
            this.japanColorData[this.selectedStateId] = colorData;
        } else {
            this.colorData[this.selectedStateId] = colorData;
        }
        
        // ì§€ë„ì— ìƒ‰ìƒ ì ìš©
        this.applyColorToMap(this.selectedStateId, colorData);
        
        // ìƒ‰ìƒì´ ì¦‰ì‹œ ì ìš©ë˜ë„ë¡ ì§€ë„ ìƒˆë¡œê³ ì¹¨
        this.map.triggerRepaint();
        
        this.showNotification('ìƒ‰ìƒì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš© ì™„ë£Œ:', this.selectedStateId, colorData);
    }
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupColorPresetListeners() {
        // ìƒ‰ìƒ í”„ë¦¬ì…‹ ë²„íŠ¼ë“¤ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        const colorPresets = document.querySelectorAll('.color-preset');
        colorPresets.forEach(preset => {
            preset.addEventListener('click', () => {
                const fillColor = preset.getAttribute('data-color');
                const borderColor = preset.getAttribute('data-border');
                this.applyPresetColor(fillColor, borderColor);
            });
        });
        
        // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const regionColorInput = document.getElementById('region-color');
        const borderColorInput = document.getElementById('border-color');
        const borderWidthInput = document.getElementById('border-width');
        
        if (regionColorInput) {
            regionColorInput.addEventListener('change', () => {
                this.applyCustomColor();
            });
            regionColorInput.addEventListener('input', () => {
                this.applyCustomColor();
            });
        }
        
        if (borderColorInput) {
            borderColorInput.addEventListener('change', () => {
                this.applyCustomColor();
            });
            borderColorInput.addEventListener('input', () => {
                this.applyCustomColor();
            });
        }
        
        if (borderWidthInput) {
            borderWidthInput.addEventListener('change', () => {
                this.applyCustomColor();
            });
            borderWidthInput.addEventListener('input', () => {
                this.applyCustomColor();
            });
        }
        
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ:', colorPresets.length, 'ê°œ');
        console.log('ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
    
    // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©
    applyCustomColor() {
        if (!this.selectedStateId) {
            console.warn('ì„ íƒëœ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        const fillColor = document.getElementById('region-color')?.value || '#4ecdc4';
        const borderColor = document.getElementById('border-color')?.value || '#ffffff';
        const borderWidth = parseInt(document.getElementById('border-width')?.value) || 1;
        
        console.log('ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©:', fillColor, borderColor, borderWidth);
        
        // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        const colorData = {
            fillColor: fillColor,
            borderColor: borderColor,
            borderWidth: borderWidth
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaColorData[this.selectedStateId] = colorData;
        } else if (this.currentMapMode === 'japan') {
            this.japanColorData[this.selectedStateId] = colorData;
        } else {
            this.colorData[this.selectedStateId] = colorData;
        }
        
        // ì§€ë„ì— ìƒ‰ìƒ ì ìš©
        this.applyColorToMap(this.selectedStateId, colorData);
        
        this.showNotification('ì»¤ìŠ¤í…€ ìƒ‰ìƒì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì œê±° (ìƒ‰ìƒ í¬í•¨)
    removeLogo() {
        if (!this.selectedStateId) {
            this.showNotification('ì œê±°í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ë¡œê³  ì œê±°
        delete this.logoData[this.selectedStateId];
        this.removeLogoFromMap(this.selectedStateId);
        
        // ìƒ‰ìƒ ì œê±° ë° ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
        delete this.colorData[this.selectedStateId];
        this.resetRegionColor(this.selectedStateId);
        
        this.updateLogoPreview();
        this.updateColorPreview();
        this.showNotification('ë¡œê³ ì™€ ìƒ‰ìƒì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        console.log('ë¡œê³  ë° ìƒ‰ìƒ ì œê±° ì™„ë£Œ:', this.selectedStateId);
    }
    
    // ì§€ì—­ ìƒ‰ìƒì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
    resetRegionColor(stateId) {
        if (!this.map) return;
        
        // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
        this.map.setPaintProperty('regions-fill', 'fill-color', [
            'case',
            ['==', ['get', 'ad_status'], 'occupied'],
            '#ff6b6b',
            '#4ecdc4'
        ]);
        
        this.map.setPaintProperty('regions-border', 'line-color', '#ffffff');
        this.map.setPaintProperty('regions-border', 'line-width', 1);
        
        console.log('ì§€ì—­ ìƒ‰ìƒ ë³µì› ì™„ë£Œ:', stateId);
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì„¤ì • ì´ˆê¸°í™” (ìƒ‰ìƒ í¬í•¨)
    resetLogo() {
        if (!this.selectedStateId) return;
        
        // ë¡œê³  ì„¤ì • ì´ˆê¸°í™”
        const logoData = this.logoData[this.selectedStateId];
        if (logoData) {
            logoData.size = 80; // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            logoData.opacity = 0.8;
            logoData.rotation = 0;
            this.logoData[this.selectedStateId] = logoData;
        }
        
        // ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™”
        const defaultColorData = {
            regionColor: '#4ecdc4',
            borderColor: '#ffffff',
            borderWidth: 1
        };
        this.colorData[this.selectedStateId] = defaultColorData;
        
        // UI ì´ˆê¸°í™”
        document.getElementById('region-color').value = defaultColorData.regionColor;
        document.getElementById('border-color').value = defaultColorData.borderColor;
        document.getElementById('border-width').value = defaultColorData.borderWidth;
        
        // í”„ë¦¬ì…‹ ì„ íƒ í•´ì œ
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
        
        this.updateLogoPreview();
        this.updateColorPreview();
        this.showNotification('ëª¨ë“  ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  í‘œì‹œ í•¨ìˆ˜ (ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì •)
    displayLogoOnMapSimple(stateId, logoData) {
        console.log('ë¡œê³  í‘œì‹œ ì‹œì‘:', stateId, logoData);
        
        // ê¸°ì¡´ ë¡œê³  ì œê±°
        this.removeLogoFromMap(stateId);
        
        // ì£¼ì˜ ì¤‘ì‹¬ì ì„ ê°„ë‹¨í•˜ê²Œ ê³„ì‚°
        const centerCoords = this.getStateCenter(stateId);
        if (!centerCoords) {
            console.error('ì£¼ ì¤‘ì‹¬ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        // ë¡œê³  ìš”ì†Œ ìƒì„±
        const logoElement = document.createElement('div');
        logoElement.id = `logo-${stateId}`;
        logoElement.className = 'state-logo';
        // ë¡œê³  ì´ë¯¸ì§€ ì•ˆì „í•˜ê²Œ ì„¤ì •
        while (logoElement.firstChild) {
            logoElement.removeChild(logoElement.firstChild);
        }
        const img = document.createElement('img');
        img.src = logoData.src; // ì´ë¯¸ì§€ URLì€ ì•ˆì „
        img.alt = `${this.sanitizeHTML(stateId || '')} Logo`;
        logoElement.appendChild(img);
        
        // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
        logoElement.style.position = 'absolute';
        logoElement.style.pointerEvents = 'none';
        logoElement.style.zIndex = '1000';
        logoElement.style.opacity = logoData.opacity;
        logoElement.style.transform = `rotate(${logoData.rotation}deg)`;
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ê³„ì‚° í•¨ìˆ˜ (ë” í¬ê²Œ í‘œì‹œ)
        const calculateLogoSize = (zoomLevel) => {
            const baseSize = logoData.size || 80; // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            const zoomFactor = Math.pow(2, zoomLevel - 4); // ì¤Œ ë ˆë²¨ 4ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•¨
            return Math.max(30, Math.min(300, baseSize * zoomFactor)); // ìµœì†Œ 30px, ìµœëŒ€ 300pxë¡œ ì¦ê°€
        };
        
        // ìœ„ì¹˜ ë° í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updatePositionAndSize = () => {
            const currentZoom = this.map.getZoom();
            const currentSize = calculateLogoSize(currentZoom);
            
            // í¬ê¸° ì—…ë°ì´íŠ¸
            logoElement.style.width = currentSize + 'px';
            logoElement.style.height = currentSize + 'px';
            
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const point = this.map.project(centerCoords);
            logoElement.style.left = (point.x - currentSize / 2) + 'px';
            logoElement.style.top = (point.y - currentSize / 2) + 'px';
            
            console.log(`ë¡œê³  í¬ê¸° ì¡°ì •: ì¤Œ ${currentZoom.toFixed(2)}, í¬ê¸° ${currentSize.toFixed(1)}px`);
        };
        
        // ì´ˆê¸° ì„¤ì •
        updatePositionAndSize();
        
        // ì§€ë„ ì´ë™ ë° ì¤Œ ì‹œ ì—…ë°ì´íŠ¸
        this.map.on('move', updatePositionAndSize);
        this.map.on('zoom', updatePositionAndSize);
        
        // ì§€ë„ì— ì¶”ê°€
        const mapContainer = document.getElementById('map');
        mapContainer.appendChild(logoElement);
        
        console.log('ë¡œê³  í‘œì‹œ ì™„ë£Œ (ì¤Œ ë°˜ì‘í˜•):', stateId);
    }
    
    // ëª¨ë“  ë¡œê³ ì˜ í¬ê¸°ë¥¼ ì¤Œ ë ˆë²¨ì— ë§ê²Œ ì—…ë°ì´íŠ¸
    updateAllLogoSizes() {
        const currentZoom = this.map.getZoom();
        
        // ëª¨ë“  ë¡œê³  ë°ì´í„°ì— ëŒ€í•´ í¬ê¸° ì—…ë°ì´íŠ¸
        Object.keys(this.logoData).forEach(stateId => {
            const logoElement = document.getElementById(`logo-${stateId}`);
            if (logoElement && this.logoData[stateId]) {
                const logoData = this.logoData[stateId];
                const baseSize = logoData.size || 80; // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
                const zoomFactor = Math.pow(2, currentZoom - 4);
                const newSize = Math.max(30, Math.min(300, baseSize * zoomFactor)); // ìµœì†Œ 30px, ìµœëŒ€ 300pxë¡œ ì¦ê°€
                
                // í¬ê¸° ì—…ë°ì´íŠ¸
                logoElement.style.width = newSize + 'px';
                logoElement.style.height = newSize + 'px';
                
                // ìœ„ì¹˜ë„ ë‹¤ì‹œ ê³„ì‚°
                const centerCoords = this.getStateCenter(stateId);
                if (centerCoords) {
                    const point = this.map.project(centerCoords);
                    logoElement.style.left = (point.x - newSize / 2) + 'px';
                    logoElement.style.top = (point.y - newSize / 2) + 'px';
                }
            }
        });
        
    }
    
    // ì£¼ì˜ ì¤‘ì‹¬ì ì„ ê°„ë‹¨í•˜ê²Œ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    getStateCenter(stateId) {
        const source = this.map.getSource('world-regions');
        if (!source || !source._data) return null;
        
        const feature = source._data.features.find(f => f.properties.id === stateId);
        if (!feature) return null;
        
        const coordinates = feature.geometry.coordinates[0];
        if (!coordinates || coordinates.length === 0) return null;
        
        let centerLng = 0, centerLat = 0;
        coordinates.forEach(coord => {
            centerLng += coord[0];
            centerLat += coord[1];
        });
        
        return [centerLng / coordinates.length, centerLat / coordinates.length];
    }
    
    // ì§€ë„ì—ì„œ ë¡œê³  ì œê±°
    removeLogoFromMap(stateId) {
        const logoElement = document.getElementById(`logo-${stateId}`);
        if (logoElement) {
            logoElement.remove();
        }
    }
    
    getKoreanStateName(englishName) {
        const stateNames = {
            'Alabama': 'ì•¨ë¼ë°°ë§ˆì£¼',
            'Alaska': 'ì•Œë˜ìŠ¤ì¹´ì£¼',
            'Arizona': 'ì• ë¦¬ì¡°ë‚˜ì£¼',
            'Arkansas': 'ì•„ì¹¸ì†Œì£¼',
            'California': 'ìº˜ë¦¬í¬ë‹ˆì•„ì£¼',
            'Colorado': 'ì½œë¡œë¼ë„ì£¼',
            'Connecticut': 'ì½”ë„¤í‹°ì»·ì£¼',
            'Delaware': 'ë¸ë¼ì›¨ì–´ì£¼',
            'Florida': 'í”Œë¡œë¦¬ë‹¤ì£¼',
            'Georgia': 'ì¡°ì§€ì•„ì£¼',
            'Hawaii': 'í•˜ì™€ì´ì£¼',
            'Idaho': 'ì•„ì´ë‹¤í˜¸ì£¼',
            'Illinois': 'ì¼ë¦¬ë…¸ì´ì£¼',
            'Indiana': 'ì¸ë””ì• ë‚˜ì£¼',
            'Iowa': 'ì•„ì´ì˜¤ì™€ì£¼',
            'Kansas': 'ìº”ììŠ¤ì£¼',
            'Kentucky': 'ì¼„í„°í‚¤ì£¼',
            'Louisiana': 'ë£¨ì´ì§€ì• ë‚˜ì£¼',
            'Maine': 'ë©”ì¸ì£¼',
            'Maryland': 'ë©”ë¦´ëœë“œì£¼',
            'Massachusetts': 'ë§¤ì‚¬ì¶”ì„¸ì¸ ì£¼',
            'Michigan': 'ë¯¸ì‹œê°„ì£¼',
            'Minnesota': 'ë¯¸ë„¤ì†Œíƒ€ì£¼',
            'Mississippi': 'ë¯¸ì‹œì‹œí”¼ì£¼',
            'Missouri': 'ë¯¸ì£¼ë¦¬ì£¼',
            'Montana': 'ëª¬íƒœë‚˜ì£¼',
            'Nebraska': 'ë„¤ë¸Œë˜ìŠ¤ì¹´ì£¼',
            'Nevada': 'ë„¤ë°”ë‹¤ì£¼',
            'New Hampshire': 'ë‰´í–„í”„ì…”ì£¼',
            'New Jersey': 'ë‰´ì €ì§€ì£¼',
            'New Mexico': 'ë‰´ë©•ì‹œì½”ì£¼',
            'New York': 'ë‰´ìš•ì£¼',
            'North Carolina': 'ë…¸ìŠ¤ìºë¡¤ë¼ì´ë‚˜ì£¼',
            'North Dakota': 'ë…¸ìŠ¤ë‹¤ì½”íƒ€ì£¼',
            'Ohio': 'ì˜¤í•˜ì´ì˜¤ì£¼',
            'Oklahoma': 'ì˜¤í´ë¼í˜¸ë§ˆì£¼',
            'Oregon': 'ì˜¤ë¦¬ê±´ì£¼',
            'Pennsylvania': 'íœì‹¤ë² ì´ë‹ˆì•„ì£¼',
            'Rhode Island': 'ë¡œë“œì•„ì¼ëœë“œì£¼',
            'South Carolina': 'ì‚¬ìš°ìŠ¤ìºë¡¤ë¼ì´ë‚˜ì£¼',
            'South Dakota': 'ì‚¬ìš°ìŠ¤ë‹¤ì½”íƒ€ì£¼',
            'Tennessee': 'í…Œë„¤ì‹œì£¼',
            'Texas': 'í…ì‚¬ìŠ¤ì£¼',
            'Utah': 'ìœ íƒ€ì£¼',
            'Vermont': 'ë²„ëª¬íŠ¸ì£¼',
            'Virginia': 'ë²„ì§€ë‹ˆì•„ì£¼',
            'Washington': 'ì›Œì‹±í„´ì£¼',
            'West Virginia': 'ì›¨ìŠ¤íŠ¸ë²„ì§€ë‹ˆì•„ì£¼',
            'Wisconsin': 'ìœ„ìŠ¤ì½˜ì‹ ì£¼',
            'Wyoming': 'ì™€ì´ì˜¤ë°ì£¼'
        };
        return stateNames[englishName] || englishName;
    }
    
    // ìƒ‰ìƒì„ ë°ê²Œ ë§Œë“œëŠ” í—¬í¼ í•¨ìˆ˜ (hover íš¨ê³¼ìš©)
    lightenColor(color, percent) {
        // HEX ìƒ‰ìƒì„ RGBë¡œ ë³€í™˜
        const num = parseInt(color.replace("#", ""), 16);
        const r = Math.min(255, ((num >> 16) & 0xff) + Math.round(255 * percent / 100));
        const g = Math.min(255, ((num >> 8) & 0xff) + Math.round(255 * percent / 100));
        const b = Math.min(255, (num & 0xff) + Math.round(255 * percent / 100));
        
        // RGBë¥¼ HEXë¡œ ë³€í™˜
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    
    // hover íš¨ê³¼ ì ìš© í•¨ìˆ˜ (ì¦‰ì‹œ ì ìš©)
    applyHoverEffect(regionId) {
        if (!regionId) {
            console.warn('[Hover] regionIdê°€ ì •ì˜ë˜ì§€ ì•Šì•„ hover íš¨ê³¼ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
            return;
        }
        // hover ë ˆì´ì–´ì— í•´ë‹¹ ì§€ì—­ë§Œ í‘œì‹œ
        if (this.map.getLayer('regions-hover')) {
            this.map.setFilter('regions-hover', ['==', 'id', regionId]);
            this.map.setPaintProperty('regions-hover', 'fill-opacity', 0.5);
            this.map.setPaintProperty('regions-hover', 'fill-color', '#feca57');
        }
        
        // ì €ì¥ëœ ìƒ‰ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const currentColorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData 
            : this.currentMapMode === 'japan'
            ? this.japanColorData
            : this.colorData;
        
        // ê²½ê³„ì„  ë‘ê»˜ ê°•ì¡° (ì €ì¥ëœ ë‘ê»˜ + í˜¸ë²„ ê°•ì¡°)
        if (this.map.getLayer('regions-border')) {
            let borderWidthConditions = ['case'];
            
            // ì €ì¥ëœ ìƒ‰ìƒì´ ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì—­ì€ ë‘êº¼ìš´ ê²½ê³„ì„ , ë‚˜ë¨¸ì§€ëŠ” ì €ì¥ëœ ë‘ê»˜
            if (Object.keys(currentColorData).length > 0) {
                Object.keys(currentColorData).forEach(id => {
                    const regionColor = currentColorData[id];
                    if (regionColor && regionColor.borderWidth) {
                        borderWidthConditions.push(['==', ['get', 'id'], id]);
                        borderWidthConditions.push(regionColor.borderWidth);
                    }
                });
            }
            
            // í˜¸ë²„ ì§€ì—­ì€ 3ìœ¼ë¡œ ê°•ì¡°
            borderWidthConditions.push(['==', ['get', 'id'], regionId]);
            borderWidthConditions.push(3);
            borderWidthConditions.push(1); // ê¸°ë³¸ê°’
            
            this.map.setPaintProperty('regions-border', 'line-width', borderWidthConditions);
            this.map.setPaintProperty('regions-border', 'line-opacity', [
                'case',
                ['==', ['get', 'id'], regionId],
                1,
                0.8
            ]);
        }
        
        // fill ìƒ‰ìƒ ë°ê²Œ (ì €ì¥ëœ ìƒ‰ìƒ ìœ ì§€ + í˜¸ë²„ ì§€ì—­ë§Œ ê°•ì¡°)
        if (this.map.getLayer('regions-fill')) {
            const currentMode = this.currentMapMode;
            let hoverColorExpr = ['case'];
            
            // ì €ì¥ëœ ìƒ‰ìƒì´ ìˆìœ¼ë©´ ì ìš©
            if (Object.keys(currentColorData).length > 0) {
                Object.keys(currentColorData).forEach(id => {
                    const regionColor = currentColorData[id];
                    if (regionColor && regionColor.fillColor && id !== regionId) {
                        hoverColorExpr.push(['==', ['get', 'id'], id]);
                        hoverColorExpr.push(regionColor.fillColor);
                    }
                });
            }
            
            // occupied ìƒíƒœ
            hoverColorExpr.push(['==', ['get', 'ad_status'], 'occupied']);
            hoverColorExpr.push('#ff6b6b');
            
            // ì˜¥ì…˜ ìƒíƒœë“¤
            hoverColorExpr.push(['==', ['get', 'auction_status'], 'active']);
            hoverColorExpr.push('#3498db');
            hoverColorExpr.push(['==', ['get', 'auction_status'], 'upcoming']);
            hoverColorExpr.push('#f39c12');
            hoverColorExpr.push(['==', ['get', 'auction_status'], 'ended']);
            hoverColorExpr.push('#95a5a6');
            hoverColorExpr.push(['==', ['get', 'auction_status'], 'sold']);
            hoverColorExpr.push('#7f8c8d');
            
            // í˜¸ë²„ ì§€ì—­ì€ ë°ì€ ìƒ‰ìƒ
            hoverColorExpr.push(['==', ['get', 'id'], regionId]);
            hoverColorExpr.push('#6dd5d8');
            
            // ê¸°ë³¸ ìƒ‰ìƒ: ì›ë˜ GeoJSONì˜ ìƒ‰ìƒ ì‚¬ìš© (country_color ë˜ëŠ” color ì†ì„±)
            hoverColorExpr.push(['coalesce', 
                ['get', 'country_color'], 
                ['get', 'color'],
                '#4ecdc4' // ê¸°ë³¸ ìƒ‰ìƒ
            ]);
            
            this.map.setPaintProperty('regions-fill', 'fill-color', hoverColorExpr);
        }
    }
    
    // hover íš¨ê³¼ ì¦‰ì‹œ ì œê±° í•¨ìˆ˜ (transition ì—†ìŒ)
    clearHoverEffectImmediate() {
        if (!this.currentHoverRegionId) return;
        
        // hover ë ˆì´ì–´ ì œê±°
        if (this.map.getLayer('regions-hover')) {
            this.map.setFilter('regions-hover', ['==', 'id', '']);
            this.map.setPaintProperty('regions-hover', 'fill-opacity', 0);
        }
        
        // ê²½ê³„ì„  ì›ë˜ëŒ€ë¡œ ë³µì› (ì €ì¥ëœ ìƒ‰ìƒ ìœ ì§€)
        if (this.map.getLayer('regions-border')) {
            // ì €ì¥ëœ ìƒ‰ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const currentColorData = this.currentMapMode === 'korea' 
                ? this.koreaColorData 
                : this.currentMapMode === 'japan'
                ? this.japanColorData
                : this.colorData;
            
            // ì €ì¥ëœ ê²½ê³„ì„  ìƒ‰ìƒì´ ìˆìœ¼ë©´ ë³µì›, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            if (Object.keys(currentColorData).length > 0) {
                let borderColorConditions = ['case'];
                let borderWidthConditions = ['case'];
                
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.borderColor) {
                        borderColorConditions.push(['==', ['get', 'id'], regionId]);
                        borderColorConditions.push(regionColor.borderColor);
                    }
                    if (regionColor && regionColor.borderWidth) {
                        borderWidthConditions.push(['==', ['get', 'id'], regionId]);
                        borderWidthConditions.push(regionColor.borderWidth);
                    }
                });
                borderColorConditions.push('#ffffff');
                borderWidthConditions.push(1);
                
                this.map.setPaintProperty('regions-border', 'line-color', borderColorConditions);
                this.map.setPaintProperty('regions-border', 'line-width', borderWidthConditions);
            } else {
                this.map.setPaintProperty('regions-border', 'line-width', 1);
            }
            this.map.setPaintProperty('regions-border', 'line-opacity', 0.8);
        }
        
        // fill ìƒ‰ìƒ ì›ë˜ëŒ€ë¡œ ë³µì› (ì €ì¥ëœ ìƒ‰ìƒ ìœ ì§€)
        if (this.map.getLayer('regions-fill')) {
            const currentMode = this.currentMapMode;
            const currentColorData = this.currentMapMode === 'korea' 
                ? this.koreaColorData 
                : this.currentMapMode === 'japan'
                ? this.japanColorData
                : this.colorData;
            
            let fillColorExpr;
            
            // ì €ì¥ëœ ìƒ‰ìƒì´ ìˆìœ¼ë©´ ë³µì›
            if (Object.keys(currentColorData).length > 0) {
                fillColorExpr = ['case'];
                let hasConditions = false;
                
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.fillColor) {
                        fillColorExpr.push(['==', ['get', 'id'], regionId]);
                        fillColorExpr.push(regionColor.fillColor);
                        hasConditions = true;
                    }
                });
                
                // ê¸°ë³¸ ìƒ‰ìƒ (occupied ìƒíƒœì— ë”°ë¼)
                const defaultColorExpr = [
                    'case',
                    ['==', ['get', 'ad_status'], 'occupied'],
                    '#ff6b6b',
                    '#4ecdc4'
                ];
                
                // ì¡°ê±´ì´ í•˜ë‚˜ë„ ì¶”ê°€ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒ í‘œí˜„ì‹ë§Œ ì‚¬ìš©
                if (!hasConditions) {
                    fillColorExpr = defaultColorExpr;
                } else {
                    // ì¡°ê±´ì´ ìˆìœ¼ë©´ ê¸°ë³¸ ìƒ‰ìƒ ì¡°ê±´ë“¤ì„ ê°œë³„ì ìœ¼ë¡œ ì¶”ê°€ (ì¤‘ì²© ë°°ì—´ ë°©ì§€)
                    fillColorExpr.push(['==', ['get', 'ad_status'], 'occupied']);
                    fillColorExpr.push('#ff6b6b');
                    fillColorExpr.push('#4ecdc4');
                }
            } else {
                // ì €ì¥ëœ ìƒ‰ìƒì´ ì—†ìœ¼ë©´ ì›ë˜ GeoJSONì˜ ìƒ‰ìƒ ì‚¬ìš© (country_color ë˜ëŠ” color ì†ì„±)
                if (currentMode === 'japan') {
                    fillColorExpr = [
                        'case',
                        ['==', ['get', 'ad_status'], 'occupied'],
                        '#ff6b6b',
                        ['==', ['get', 'ad_status'], 'selected'],
                        '#feca57',
                        ['coalesce', 
                            ['get', 'country_color'], 
                            ['get', 'color'],
                            '#4ecdc4' // ê¸°ë³¸ ìƒ‰ìƒ
                        ]
                    ];
                } else {
                    fillColorExpr = [
                        'case',
                        ['==', ['get', 'ad_status'], 'occupied'],
                        '#ff6b6b',
                        ['==', ['get', 'auction_status'], 'active'],
                        '#3498db',
                        ['==', ['get', 'auction_status'], 'upcoming'],
                        '#f39c12',
                        ['==', ['get', 'auction_status'], 'ended'],
                        '#95a5a6',
                        ['==', ['get', 'auction_status'], 'sold'],
                        '#7f8c8d',
                        ['coalesce', 
                            ['get', 'country_color'], 
                            ['get', 'color'],
                            '#4ecdc4' // ê¸°ë³¸ ìƒ‰ìƒ
                        ]
                    ];
                }
            }
            
            this.map.setPaintProperty('regions-fill', 'fill-color', fillColorExpr);
        }
        
        this.currentHoverRegionId = null;
    }
    
    // hover íš¨ê³¼ ì œê±° í•¨ìˆ˜ (transition í¬í•¨ - í˜¸í™˜ì„±ìš©)
    clearHoverEffect() {
        this.clearHoverEffectImmediate();
    }
    
    // í–‰ì •êµ¬ì—­ hover ì¢…ë£Œ ì²˜ë¦¬
    handleRegionHoverExit() {
        this.map.getCanvas().style.cursor = '';
        this.clearHoverEffectImmediate();
        this.hideTooltip();
    }
    
    showError(message) {
        const loading = document.getElementById('loading');
        // ì•ˆì „í•œ ì˜¤ë¥˜ ë©”ì‹œì§€ í‘œì‹œ
        while (loading.firstChild) {
            loading.removeChild(loading.firstChild);
        }
        const errorDiv = document.createElement('div');
        errorDiv.style.color = '#ff6b6b';
        errorDiv.style.fontSize = '1.2rem';
        const errorP1 = document.createElement('p');
        errorP1.textContent = 'âŒ ì˜¤ë¥˜ ë°œìƒ';
        const errorP2 = document.createElement('p');
        errorP2.style.fontSize = '0.9rem';
        errorP2.style.marginTop = '10px';
        errorP2.textContent = this.sanitizeHTML(message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
        errorDiv.appendChild(errorP1);
        errorDiv.appendChild(errorP2);
        loading.appendChild(errorDiv);
    }
    
    // ì–¸ì–´ ë³€í™˜ í—¬í¼ í•¨ìˆ˜
    getLanguageText(key, includeSecondary = true) {
        let countryCode = this.currentMapMode;
        
        // 'korea' ëª¨ë“œë¥¼ 'south-korea' ì–¸ì–´ ë§¤í•‘ìœ¼ë¡œ ë³€í™˜
        if (countryCode === 'korea') {
            countryCode = 'south-korea';
        }
        
        const langData = this.countryLanguages[countryCode];
        
        if (!langData) {
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ì˜ì–´ ë°˜í™˜
            return {
                primary: key,
                secondary: includeSecondary && Object.keys(this.countryLanguages['usa']?.primary || {}).includes(key) 
                    ? this.countryLanguages['usa'].primary[key] 
                    : null
            };
        }
        
        const primary = langData.primary[key] || key;
        const secondary = includeSecondary && langData.secondary && Object.keys(langData.secondary).length > 0
            ? langData.secondary[key] || null
            : null;
        
        return { primary, secondary };
    }
    
    // ì§€ì—­ í‘œì‹œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (êµ­ê°€ë³„ ì–¸ì–´ ìš°ì„ ìˆœìœ„ ì ìš©)
    getRegionDisplayName(regionData) {
        if (!regionData) return '';
        
        const englishCountries = ['usa', 'uk', 'canada', 'australia', 'south-africa'];
        const isEnglishCountry = englishCountries.includes(this.currentMapMode);
        
        if (this.currentMapMode === 'japan') {
            return `${regionData.name_en || ''}${regionData.name_ja ? ` (${regionData.name_ja})` : ''}`;
        } else if (this.currentMapMode === 'korea') {
            let displayName = regionData.name_ko || regionData.name;
            if (regionData.ctp_name_ko && regionData.sig_name_ko && regionData.sig_name_ko !== regionData.ctp_name_ko) {
                const ctpShort = regionData.ctp_name_ko.replace(/ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ|ì‹œ$/g, '').trim();
                if (!displayName.includes(ctpShort)) {
                    displayName = `${ctpShort} ${regionData.sig_name_ko || displayName}`;
                }
            }
            return `${displayName}${regionData.name_en ? ` (${regionData.name_en})` : ''}`;
        } else if (isEnglishCountry) {
            // ì˜ì–´ê¶Œ êµ­ê°€: ì˜ì–´ë§Œ í‘œì‹œ
            return regionData.name_en || regionData.name_ko || regionData.name || '';
        } else {
            // ê·¸ ì™¸: í˜„ì§€ì–´ (ì˜ì–´)
            return `${regionData.name_ko || regionData.name}${regionData.name_en ? ` (${regionData.name_en})` : ''}`;
        }
    }
    
    // ìƒ‰ìƒì„ ì§€ë„ì— ì ìš© (í•œêµ­ ëª¨ë“œ ì§€ì›)
    applyColorToMap(stateId, colorData) {
        if (!this.map.getLayer('regions-fill')) {
            console.error('regions-fill ë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // colorDataê°€ ìœ íš¨í•œì§€ í™•ì¸
        if (!colorData || !colorData.fillColor) {
            console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ìƒ‰ìƒ ë°ì´í„°:', colorData);
            return;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaColorData[stateId] = colorData;
        } else if (this.currentMapMode === 'japan') {
            this.japanColorData[stateId] = colorData;
        } else {
            this.colorData[stateId] = colorData;
        }
        
        console.log('ìƒ‰ìƒ ë°ì´í„° ì €ì¥:', stateId, colorData, 'ëª¨ë“œ:', this.currentMapMode);
        
        // ì„ íƒëœ ì§€ì—­ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ë¯¸êµ­ ì§€ë„ì™€ ë™ì¼í•œ ë°©ì‹)
        console.log('ìƒ‰ìƒ ì ìš© ì‹œì‘:', stateId, colorData.fillColor);
        
        // ë ˆì´ì–´ ì¡´ì¬ í™•ì¸
        if (!this.map.getLayer('regions-fill')) {
            console.error('regions-fill ë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // í˜„ì¬ ëª¨ë“œì˜ ëª¨ë“  ìƒ‰ìƒ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì¡°ê±´ ìƒì„±
        const currentColorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData 
            : this.currentMapMode === 'japan'
            ? this.japanColorData
            : this.colorData;
        
        // ìƒ‰ìƒ ì¡°ê±´ì„ ë‹¨ê³„ë³„ë¡œ êµ¬ì„±
        let colorConditions = ['case'];
        
        // ê° ì§€ì—­ì˜ ìƒ‰ìƒ ì¡°ê±´ ì¶”ê°€
        Object.keys(currentColorData).forEach(regionId => {
            const regionColor = currentColorData[regionId];
            if (regionColor && regionColor.fillColor) {
                colorConditions.push(['==', ['get', 'id'], regionId]);
                colorConditions.push(regionColor.fillColor);
                console.log(`ìƒ‰ìƒ ì¡°ê±´ ì¶”ê°€: ${regionId} -> ${regionColor.fillColor}`);
            }
        });
        
        // ê¸°ë³¸ ìƒ‰ìƒ (occupied ìƒíƒœì— ë”°ë¼)
        colorConditions.push([
            'case',
            ['==', ['get', 'ad_status'], 'occupied'],
            '#ff6b6b', // ê´‘ê³  ì¤‘ì¸ ì§€ì—­
            '#4ecdc4'  // ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì—­
        ]);
        
        console.log('ìµœì¢… ìƒ‰ìƒ ì¡°ê±´:', colorConditions);
        
        // ìƒ‰ìƒ ì ìš©
        try {
            this.map.setPaintProperty('regions-fill', 'fill-color', colorConditions);
            console.log('ìƒ‰ìƒ ì ìš© ì„±ê³µ:', stateId, colorData.fillColor);
            
            // ì§€ë„ ê°•ì œ ìƒˆë¡œê³ ì¹¨
            this.map.triggerRepaint();
            
        } catch (error) {
            console.error('ìƒ‰ìƒ ì ìš© ì‹¤íŒ¨:', error);
        }
        
        console.log('ìƒ‰ìƒ paint property ì—…ë°ì´íŠ¸:', stateId, colorData.fillColor);
        
        // ê²½ê³„ì„  ìƒ‰ìƒê³¼ ë‘ê»˜ëŠ” regions-border ë ˆì´ì–´ì— ì ìš© (ëª¨ë“  ì§€ì—­ í†µí•© ì ìš©)
        if (this.map.getLayer('regions-border')) {
            try {
                // ê²½ê³„ì„  ìƒ‰ìƒ ì¡°ê±´ ìƒì„± (ëª¨ë“  ì§€ì—­ ì ìš©)
                let borderColorConditions = ['case'];
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.borderColor) {
                        borderColorConditions.push(['==', ['get', 'id'], regionId]);
                        borderColorConditions.push(regionColor.borderColor);
                    }
                });
                borderColorConditions.push('#ffffff'); // ê¸°ë³¸ ìƒ‰ìƒ
                
                this.map.setPaintProperty('regions-border', 'line-color', borderColorConditions);
                console.log('ê²½ê³„ì„  ìƒ‰ìƒ ì ìš© ì„±ê³µ');
            } catch (error) {
                console.warn('ê²½ê³„ì„  ìƒ‰ìƒ ì ìš© ì‹¤íŒ¨:', error);
            }
            
            try {
                // ê²½ê³„ì„  ë‘ê»˜ ì¡°ê±´ ìƒì„± (ëª¨ë“  ì§€ì—­ ì ìš©)
                let borderWidthConditions = ['case'];
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.borderWidth) {
                        borderWidthConditions.push(['==', ['get', 'id'], regionId]);
                        borderWidthConditions.push(regionColor.borderWidth);
                    }
                });
                borderWidthConditions.push(1); // ê¸°ë³¸ ë‘ê»˜
                
                this.map.setPaintProperty('regions-border', 'line-width', borderWidthConditions);
                console.log('ê²½ê³„ì„  ë‘ê»˜ ì ìš© ì„±ê³µ');
            } catch (error) {
                console.warn('ê²½ê³„ì„  ë‘ê»˜ ì ìš© ì‹¤íŒ¨:', error);
            }
        }
        
        console.log('ìƒ‰ìƒ ì ìš© ì™„ë£Œ:', stateId, colorData, 'ëª¨ë“œ:', this.currentMapMode);
    }
    
    // ë¡œê³ ë¥¼ ì§€ë„ì— í‘œì‹œ (ê°„ë‹¨í•œ ë²„ì „)
    displayLogoOnMapSimple(stateId, logoData) {
        console.log('ë¡œê³  í‘œì‹œ ì‹œì‘:', stateId, logoData, 'ëª¨ë“œ:', this.currentMapMode);
        
        // ê¸°ì¡´ ë¡œê³  ì œê±°
        this.removeLogoFromMap(stateId);
        
        // ì£¼ì˜ ì¤‘ì‹¬ì ì„ ê°„ë‹¨í•˜ê²Œ ê³„ì‚°
        const centerCoords = this.getStateCenter(stateId);
        if (!centerCoords) {
            console.error('ì£¼ ì¤‘ì‹¬ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        console.log('ì¤‘ì‹¬ì  ì¢Œí‘œ:', stateId, centerCoords, 'ëª¨ë“œ:', this.currentMapMode);
        
        // ë¡œê³  ìš”ì†Œ ìƒì„±
        const logoElement = document.createElement('div');
        logoElement.id = `logo-${stateId}`;
        logoElement.className = 'state-logo';
        // ë¡œê³  ì´ë¯¸ì§€ ì•ˆì „í•˜ê²Œ ì„¤ì •
        while (logoElement.firstChild) {
            logoElement.removeChild(logoElement.firstChild);
        }
        const img = document.createElement('img');
        img.src = logoData.src; // ì´ë¯¸ì§€ URLì€ ì•ˆì „
        img.alt = `${this.sanitizeHTML(stateId || '')} Logo`;
        logoElement.appendChild(img);
        
        // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
        logoElement.style.position = 'absolute';
        logoElement.style.pointerEvents = 'none';
        logoElement.style.zIndex = '1000';
        logoElement.style.opacity = logoData.opacity || 0.8;
        logoElement.style.transform = `rotate(${logoData.rotation || 0}deg)`;
        logoElement.style.display = 'block';
        logoElement.style.visibility = 'visible';
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ê³„ì‚° í•¨ìˆ˜ (ë¯¸êµ­ ì‹œìŠ¤í…œê³¼ ë™ì¼í•œ ë°©ì‹)
        const calculateLogoSize = (zoomLevel) => {
            const baseSize = logoData.size || 80;
            
            // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ë§ (ë¯¸êµ­ ì‹œìŠ¤í…œê³¼ ë™ì¼)
            let scaleFactor;
            if (zoomLevel <= 3) {
                scaleFactor = 0.3; // ë§¤ìš° ì‘ê²Œ
            } else if (zoomLevel <= 4) {
                scaleFactor = 0.5; // ì‘ê²Œ
            } else if (zoomLevel <= 5) {
                scaleFactor = 0.7; // ì¤‘ê°„
            } else if (zoomLevel <= 6) {
                scaleFactor = 1.0; // ê¸°ë³¸ í¬ê¸°
            } else if (zoomLevel <= 7) {
                scaleFactor = 1.3; // í¬ê²Œ
            } else if (zoomLevel <= 8) {
                scaleFactor = 1.6; // ë§¤ìš° í¬ê²Œ
            } else {
                scaleFactor = 2.0; // ìµœëŒ€ í¬ê¸°
            }
            
            const finalSize = baseSize * scaleFactor;
            return Math.max(20, Math.min(400, finalSize)); // ìµœì†Œ 20px, ìµœëŒ€ 400px
        };
        
        // ìœ„ì¹˜ ë° í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updatePositionAndSize = () => {
            const currentZoom = this.map.getZoom();
            const currentSize = calculateLogoSize(currentZoom);
            
            // í¬ê¸° ì—…ë°ì´íŠ¸
            logoElement.style.width = currentSize + 'px';
            logoElement.style.height = currentSize + 'px';
            
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const point = this.map.project(centerCoords);
            logoElement.style.left = (point.x - currentSize / 2) + 'px';
            logoElement.style.top = (point.y - currentSize / 2) + 'px';
            
            console.log(`ë¡œê³  í¬ê¸° ì¡°ì •: ì¤Œ ${currentZoom.toFixed(2)}, í¬ê¸° ${currentSize.toFixed(1)}px`);
        };
        
        // ì´ˆê¸° ì„¤ì •
        updatePositionAndSize();
        
        // ì§€ë„ ì´ë™ ë° ì¤Œ ì‹œ ì—…ë°ì´íŠ¸
        this.map.on('move', updatePositionAndSize);
        this.map.on('zoom', updatePositionAndSize);
        
        // ì§€ë„ì— ì¶”ê°€
        const mapContainer = document.getElementById('map');
        mapContainer.appendChild(logoElement);
        
        console.log('ë¡œê³  í‘œì‹œ ì™„ë£Œ (ì¤Œ ë°˜ì‘í˜•):', stateId);
    }
    
    // ë¡œê³ ë¥¼ ì§€ë„ì—ì„œ ì œê±°
    removeLogoFromMap(stateId) {
        const existingLogo = document.getElementById(`logo-${stateId}`);
        if (existingLogo) {
            existingLogo.remove();
        }
    }
    
    // ì£¼ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
    getStateCenter(stateId) {
        // ë¯¸êµ­ ì£¼ ì¤‘ì‹¬ì  ë§¤í•‘
        const usStateCenters = {
            'california': [-119.4179, 36.7783],
            'texas': [-99.9018, 31.9686],
            'florida': [-81.5158, 27.7663],
            'new_york': [-74.9481, 42.1657],
            'pennsylvania': [-77.1945, 41.2033],
            'illinois': [-89.3985, 40.3363],
            'ohio': [-82.7649, 40.3888],
            'georgia': [-83.1136, 32.1656],
            'north_carolina': [-79.0193, 35.6301],
            'michigan': [-84.5467, 43.3266],
            'new_jersey': [-74.4057, 40.2989],
            'virginia': [-78.1694, 37.7693],
            'washington': [-121.4905, 47.4009],
            'arizona': [-111.4312, 33.7298],
            'massachusetts': [-71.5376, 42.2302],
            'tennessee': [-86.7816, 35.7478],
            'indiana': [-86.1349, 39.7909],
            'missouri': [-92.1893, 38.4561],
            'maryland': [-76.8021, 39.0458],
            'wisconsin': [-89.6165, 44.2685],
            'colorado': [-105.3111, 39.0598],
            'minnesota': [-94.6859, 46.7296],
            'south_carolina': [-80.9007, 33.8569],
            'alabama': [-86.7911, 32.8067],
            'louisiana': [-92.4737, 31.1695],
            'kentucky': [-84.6701, 37.6681],
            'oregon': [-122.0709, 44.5721],
            'oklahoma': [-97.5164, 35.5653],
            'connecticut': [-72.7273, 41.5978],
            'utah': [-111.8926, 40.1500],
            'iowa': [-93.6205, 42.0115],
            'nevada': [-117.0554, 38.3135],
            'arkansas': [-92.3731, 34.9697],
            'mississippi': [-89.3985, 32.7416],
            'kansas': [-98.4842, 38.5266],
            'new_mexico': [-106.2485, 34.8405],
            'nebraska': [-99.9018, 41.1254],
            'west_virginia': [-80.9696, 38.3495],
            'idaho': [-114.4788, 44.2405],
            'hawaii': [-157.4983, 21.0943],
            'new_hampshire': [-71.5653, 43.4525],
            'maine': [-69.7653, 44.3235],
            'montana': [-110.4544, 47.0526],
            'rhode_island': [-71.5118, 41.6809],
            'delaware': [-75.5267, 39.3185],
            'south_dakota': [-99.9018, 44.2998],
            'north_dakota': [-101.0020, 47.5289],
            'alaska': [-152.4044, 61.3707],
            'vermont': [-72.7317, 44.0459],
            'wyoming': [-107.3025, 42.7550]
        };
        
        // í•œêµ­ ë„ì‹œ ì¤‘ì‹¬ì  ë§¤í•‘ (ë” ë§ì€ ë„ì‹œ ì¶”ê°€)
        const koreanCityCenters = {
            'í™”ì„±si': [126.8, 37.2],
            'seoul': [126.98, 37.57],
            'busan': [129.08, 35.18],
            'daegu': [128.6, 35.87],
            'incheon': [126.7, 37.46],
            'gwangju': [126.85, 35.16],
            'daejeon': [127.39, 36.35],
            'ulsan': [129.31, 35.54],
            'sejong': [127.29, 36.48],
            'suwon': [127.0, 37.3],
            'yongin': [127.2, 37.2],
            'seongnam': [127.1, 37.4],
            'bucheon': [126.8, 37.5],
            'ansan': [126.8, 37.3],
            'anyang': [126.9, 37.4],
            'namyangju': [127.2, 37.6],
            'hwasong': [126.8, 37.2],
            'pyeongtaek': [127.0, 37.0],
            'siheung': [126.8, 37.4],
            'goyang': [126.8, 37.7],
            'gimpo': [126.7, 37.6],
            'hanam': [127.2, 37.5],
            'osan': [127.1, 37.1],
            'icheon': [127.4, 37.3],
            'yangju': [127.0, 37.8],
            'dongducheon': [127.1, 37.9],
            'guri': [127.1, 37.6],
            'gwangmyeong': [126.9, 37.5],
            'gunpo': [126.9, 37.4],
            'uiwang': [127.0, 37.4],
            'yeoju': [127.6, 37.3],
            'yangpyeong': [127.5, 37.5],
            'gapyeong': [127.5, 37.8],
            'yeoncheon': [127.1, 38.1]
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì¤‘ì‹¬ì  ë°˜í™˜
        if (this.currentMapMode === 'korea') {
            return koreanCityCenters[stateId] || [127.5, 36.0]; // ê¸°ë³¸ê°’: í•œêµ­ ì¤‘ì‹¬
        } else {
            return usStateCenters[stateId] || [-98.5795, 39.8283]; // ê¸°ë³¸ê°’: ë¯¸êµ­ ì¤‘ì‹¬
        }
    }
    
    // ê¸°ì¡´ ë ˆì´ì–´ì™€ ì†ŒìŠ¤ ì œê±°
    removeExistingLayersAndSources() {
        try {
            // ë ˆì´ì–´ ì œê±°
            const layersToRemove = ['regions-fill', 'regions-border', 'regions-hover'];
            layersToRemove.forEach(layerId => {
                if (this.map.getLayer(layerId)) {
                    this.map.removeLayer(layerId);
                    console.log('ë ˆì´ì–´ ì œê±°:', layerId);
                }
            });
            
            // ì†ŒìŠ¤ ì œê±°
            const sourcesToRemove = ['regions', 'world-regions'];
            sourcesToRemove.forEach(sourceId => {
                if (this.map.getSource(sourceId)) {
                    this.map.removeSource(sourceId);
                    console.log('ì†ŒìŠ¤ ì œê±°:', sourceId);
                }
            });
            
            // ê¸°ì¡´ ë¡œê³ ë“¤ ì œê±°
            this.removeAllLogosFromMap();
            
        } catch (error) {
            console.warn('ë ˆì´ì–´/ì†ŒìŠ¤ ì œê±° ì¤‘ ì˜¤ë¥˜:', error);
        }
    }
    
    // ëª¨ë“  ë¡œê³ ë¥¼ ì§€ë„ì—ì„œ ì œê±°
    removeAllLogosFromMap() {
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            const allLogos = mapContainer.querySelectorAll('.state-logo');
            allLogos.forEach(logo => logo.remove());
            console.log('ëª¨ë“  ë¡œê³  ì œê±° ì™„ë£Œ:', allLogos.length, 'ê°œ');
        }
    }
    
    // í˜„ì¬ ëª¨ë“œì˜ ëª¨ë“  ë¡œê³ ì™€ ìƒ‰ìƒ í‘œì‹œ
    displayAllLogosForCurrentMode() {
        const logoData = this.currentMapMode === 'korea' ? this.koreaLogoData : this.currentMapMode === 'japan' ? this.japanLogoData : this.logoData;
        const colorData = this.currentMapMode === 'korea' ? this.koreaColorData : this.currentMapMode === 'japan' ? this.japanColorData : this.colorData;
        
        // ë¡œê³  í‘œì‹œ
        Object.keys(logoData).forEach(stateId => {
            const logo = logoData[stateId];
            if (logo && logo.src) {
                this.displayLogoOnMapSimple(stateId, logo);
            }
        });
        
        // ìƒ‰ìƒ ë³µì›
        Object.keys(colorData).forEach(stateId => {
            const color = colorData[stateId];
            if (color) {
                // ìƒ‰ìƒ ë°ì´í„° í˜•ì‹ í†µì¼
                const normalizedColorData = {
                    fillColor: color.fillColor || color.regionColor || '#4ecdc4',
                    borderColor: color.borderColor || '#ffffff',
                    borderWidth: color.borderWidth || 1
                };
                this.applyColorToMap(stateId, normalizedColorData);
            }
        });
        
        // ëª¨ë“  ë¡œê³  í¬ê¸° ì—…ë°ì´íŠ¸ (ì¤Œ ë ˆë²¨ì— ë§ê²Œ)
        this.updateAllLogoSizes();
        
        console.log('í˜„ì¬ ëª¨ë“œ ë¡œê³  ë° ìƒ‰ìƒ í‘œì‹œ ì™„ë£Œ:', this.currentMapMode, 
                   'ë¡œê³ :', Object.keys(logoData).length, 'ê°œ', 
                   'ìƒ‰ìƒ:', Object.keys(colorData).length, 'ê°œ');
    }
    
    // ëª¨ë“  ë¡œê³  í¬ê¸° ì—…ë°ì´íŠ¸ (ì¤Œ ë ˆë²¨ì— ë§ê²Œ) - ê°•í™”ëœ ë²„ì „
    updateAllLogoSizes() {
        const logoData = this.currentMapMode === 'korea' ? this.koreaLogoData : this.currentMapMode === 'japan' ? this.japanLogoData : this.logoData;
        const currentZoom = this.map.getZoom();
        
        // ë¡œê³ ê°€ ì—†ìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
        if (Object.keys(logoData).length === 0) {
            return;
        }
        
        // ëª¨ë“  ë¡œê³  ìš”ì†Œë¥¼ ì§ì ‘ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
        const allLogoElements = document.querySelectorAll('.state-logo');
        
        // DOMì˜ ëª¨ë“  ë¡œê³  ìš”ì†Œë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
        allLogoElements.forEach(logoElement => {
            const stateId = logoElement.id.replace('logo-', '');
            const logo = logoData[stateId];
            
            if (logo && logo.src) {
                const baseSize = logo.size || 80;
                
                // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ë§ (ë¯¸êµ­ ì§€ë„ì™€ ë™ì¼)
                let scaleFactor;
                if (currentZoom <= 3) {
                    scaleFactor = 0.3;
                } else if (currentZoom <= 4) {
                    scaleFactor = 0.5;
                } else if (currentZoom <= 5) {
                    scaleFactor = 0.7;
                } else if (currentZoom <= 6) {
                    scaleFactor = 1.0;
                } else if (currentZoom <= 7) {
                    scaleFactor = 1.3;
                } else if (currentZoom <= 8) {
                    scaleFactor = 1.6;
                } else {
                    scaleFactor = 2.0;
                }
                
                const currentSize = Math.max(20, Math.min(400, baseSize * scaleFactor));
                
                // í¬ê¸° ì—…ë°ì´íŠ¸ (ê°•ì œ ì ìš©)
                logoElement.style.width = currentSize + 'px';
                logoElement.style.height = currentSize + 'px';
                logoElement.style.display = 'block';
                logoElement.style.visibility = 'visible';
                
                // CSS transition ì¶”ê°€ë¡œ ë¶€ë“œëŸ¬ìš´ í¬ê¸° ë³€í™”
                logoElement.style.transition = 'width 0.3s ease, height 0.3s ease, left 0.3s ease, top 0.3s ease';
                
                // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                const centerCoords = this.getStateCenter(stateId);
                if (centerCoords) {
                    const point = this.map.project(centerCoords);
                    logoElement.style.left = (point.x - currentSize / 2) + 'px';
                    logoElement.style.top = (point.y - currentSize / 2) + 'px';
                }
                
                console.log(`ë¡œê³  í¬ê¸° ì—…ë°ì´íŠ¸: ${stateId}, ì¤Œ ${currentZoom.toFixed(2)}, í¬ê¸° ${currentSize.toFixed(1)}px, ìŠ¤ì¼€ì¼ ${scaleFactor.toFixed(2)}x`);
            }
        });
        
        // ë°ì´í„°ì— ìˆì§€ë§Œ DOMì— ì—†ëŠ” ë¡œê³  ìš”ì†Œë“¤ ì¬ìƒì„±
        Object.keys(logoData).forEach(stateId => {
            const logo = logoData[stateId];
            if (logo && logo.src) {
                const logoElement = document.getElementById(`logo-${stateId}`);
                if (!logoElement) {
                    console.log(`ë¡œê³  ìš”ì†Œê°€ ì—†ì–´ì„œ ë‹¤ì‹œ ìƒì„±: ${stateId}`);
                    this.displayLogoOnMapSimple(stateId, logo);
                }
            }
        });
        
        
        // ê°•ì œë¡œ ì§€ë„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ ì ìš©
        this.map.triggerRepaint();
    }
    
    
    // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (ê´‘ê³ ê°€ ì—†ì„ ë•Œ)
    async showRegionInfoModal(stateId) {
        console.log('ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ:', stateId, 'ëª¨ë“œ:', this.currentMapMode);
        
        // stateIdê°€ ì—†ìœ¼ë©´ currentRegionì—ì„œ ê°€ì ¸ì˜¤ê¸°
        if (!stateId && this.currentRegion) {
            stateId = this.currentRegion.id || this.selectedStateId;
            console.log('stateIdê°€ ì—†ì–´ì„œ currentRegionì—ì„œ ê°€ì ¸ì˜´:', stateId);
        }
        
        if (!stateId) {
            console.error('stateIdê°€ ì—†ìŠµë‹ˆë‹¤.');
            this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // í˜„ì¬ ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        let regionData = this.regionData.get(stateId);
        
        // regionDataê°€ ì—†ìœ¼ë©´ currentRegion ì‚¬ìš©
        if (!regionData) {
            console.warn('regionDataì—ì„œ ì°¾ì§€ ëª»í•¨, currentRegion ì‚¬ìš©:', stateId);
            if (this.currentRegion && (this.currentRegion.id === stateId || !this.currentRegion.id)) {
                regionData = { ...this.currentRegion, id: stateId };
            } else {
                // currentRegionë„ ì—†ìœ¼ë©´ ìµœì†Œí•œì˜ ì •ë³´ë¡œ ìƒì„±
                console.warn('currentRegionë„ ì—†ì–´ì„œ ìµœì†Œ ì •ë³´ë¡œ ìƒì„±:', stateId);
                const defaultCountry = this.currentMapMode === 'korea' ? 'South Korea' : 
                                       this.currentMapMode === 'japan' ? 'Japan' : 'USA';
                regionData = {
                    id: stateId,
                    name: stateId,
                    name_ko: stateId,
                    name_en: stateId,
                    country: defaultCountry,
                    population: 0,
                    area: 0,
                    ad_price: 0,
                    ad_status: 'available'
                };
            }
        }
        
        // í˜„ì¬ ì§€ì—­ ì„¤ì • (ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ì—ì„œ ì‚¬ìš©) - ê°•ì œë¡œ ì„¤ì •
        this.currentRegion = { ...regionData, id: stateId };
        this.selectedStateId = stateId; // selectedStateIdë„ í•¨ê»˜ ì„¤ì •
        
        // regionDataì—ë„ í™•ì‹¤í•˜ê²Œ ì €ì¥ (ë™ê¸°í™” ë³´ì¥)
        if (!this.regionData.has(stateId)) {
            this.regionData.set(stateId, this.currentRegion);
        } else {
            // ì´ë¯¸ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
            this.regionData.set(stateId, this.currentRegion);
        }
        
        console.log('currentRegion ì„¤ì • ì™„ë£Œ:', {
            currentRegion: this.currentRegion,
            selectedStateId: this.selectedStateId,
            stateId: stateId,
            hasRegionData: this.regionData.has(stateId)
        });
        
        // êµ­ê°€ë³„ í”Œë˜ê·¸ ì„¤ì •
        const getCountryFlag = (country) => {
            switch(country) {
                case 'USA': return 'ğŸ‡ºğŸ‡¸';
                case 'South Korea': return 'ğŸ‡°ğŸ‡·';
                case 'Japan': return 'ğŸ‡¯ğŸ‡µ';
                default: return 'ğŸ´';
            }
        };
        
        // ëª¨ë‹¬ ì œëª© ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const titleText = this.getLanguageText('Region Information');
        const titlePrimary = document.querySelector('#region-modal-title.label-primary') || document.getElementById('region-modal-title');
        const titleSecondary = document.getElementById('region-modal-title-en');
        if (titlePrimary) titlePrimary.textContent = titleText.primary;
        if (titleSecondary && titleText.secondary) {
            titleSecondary.textContent = ` (${titleText.secondary})`;
            titleSecondary.style.display = 'inline';
        } else if (titleSecondary) {
            titleSecondary.style.display = 'none';
        }
        
        // ì§€ì—­ ì´ë¦„ ì„¤ì • (êµ­ê°€ë³„ ì–¸ì–´ ìš°ì„ ìˆœìœ„ ì ìš©)
        const regionName = this.getRegionDisplayName(regionData);
        document.getElementById('region-modal-name').textContent = regionName;
        
        // êµ­ê°€ ì •ë³´ ì„¤ì •
        document.getElementById('region-modal-country').textContent = regionData.country;
        document.getElementById('region-flag').textContent = getCountryFlag(regionData.country);
        
        // ìƒì„¸ ì •ë³´ ì„¤ì • (regionDataì—ì„œ ì •í™•í•œ ê°’ ê°€ì ¸ì˜¤ê¸°)
        const population = regionData.population || 0;
        const area = regionData.area || 0;
        const adminLevel = regionData.admin_level || (this.currentMapMode === 'japan' 
            ? 'Prefecture'
            : this.currentMapMode === 'korea'
            ? 'City'
            : 'State');
        const adPrice = regionData.ad_price || 0;
        
        document.getElementById('region-modal-population').textContent = population ? population.toLocaleString() : '-';
        document.getElementById('region-modal-area').textContent = area ? `${area.toLocaleString()} kmÂ²` : '-';
        // í–‰ì •êµ¬ì—­ ìˆ˜ í¬í•¨í•˜ì—¬ í‘œì‹œ
        const totalRegions = this.getTotalAdminRegionsCount(regionData.country);
        const adminLevelText = adminLevel && totalRegions > 0 ? `${adminLevel} (${totalRegions}ê°œ)` : adminLevel;
        document.getElementById('region-modal-admin-level').textContent = adminLevelText;
        document.getElementById('region-modal-price').textContent = adPrice ? `$${adPrice.toLocaleString()}` : '-';
        
        // ë¼ë²¨ í…ìŠ¤íŠ¸ ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const regionLabel = this.getLanguageText('Region');
        const populationLabel = this.getLanguageText('Population');
        const areaLabel = this.getLanguageText('Area');
        const adminLevelLabel = this.getLanguageText('Administrative Level');
        const priceLabel = this.getLanguageText('Advertising Price');
        const statusLabel = this.getLanguageText('Status');
        
        // Primary ë¼ë²¨ ì—…ë°ì´íŠ¸
        const updateRegionModalLabel = (secondaryId, text) => {
            const secondaryEl = document.getElementById(secondaryId);
            const primaryEl = secondaryEl?.parentElement?.querySelector('.label-primary');
            if (primaryEl) primaryEl.textContent = text.primary;
        };
        
        // ì§€ì—­ëª… ë¼ë²¨ ì—…ë°ì´íŠ¸ëŠ” region-modal-nameì´ ì§€ì—­ ì´ë¦„ì„ í‘œì‹œí•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì œì™¸
        updateRegionModalLabel('region-modal-population-label-en', populationLabel);
        updateRegionModalLabel('region-modal-area-label-en', areaLabel);
        updateRegionModalLabel('region-modal-admin-level-label-en', adminLevelLabel);
        updateRegionModalLabel('region-modal-price-label-en', priceLabel);
        
        // Secondary ë¼ë²¨ ì—…ë°ì´íŠ¸
        const populationLabelEn = document.getElementById('region-modal-population-label-en');
        const areaLabelEn = document.getElementById('region-modal-area-label-en');
        const adminLevelLabelEn = document.getElementById('region-modal-admin-level-label-en');
        const priceLabelEn = document.getElementById('region-modal-price-label-en');
        const statusLabelEn = document.getElementById('region-modal-status-label-en');
        
        if (populationLabelEn) {
            if (populationLabel.secondary) {
                populationLabelEn.textContent = ` (${populationLabel.secondary})`;
                populationLabelEn.style.display = 'inline';
            } else {
                populationLabelEn.style.display = 'none';
            }
        }
        if (areaLabelEn) {
            if (areaLabel.secondary) {
                areaLabelEn.textContent = ` (${areaLabel.secondary})`;
                areaLabelEn.style.display = 'inline';
            } else {
                areaLabelEn.style.display = 'none';
            }
        }
        if (adminLevelLabelEn) {
            if (adminLevelLabel.secondary) {
                adminLevelLabelEn.textContent = ` (${adminLevelLabel.secondary})`;
                adminLevelLabelEn.style.display = 'inline';
            } else {
                adminLevelLabelEn.style.display = 'none';
            }
        }
        if (priceLabelEn) {
            if (priceLabel.secondary) {
                priceLabelEn.textContent = ` (${priceLabel.secondary})`;
                priceLabelEn.style.display = 'inline';
            } else {
                priceLabelEn.style.display = 'none';
            }
        }
        if (statusLabelEn) {
            if (statusLabel.secondary) {
                statusLabelEn.textContent = ` (${statusLabel.secondary})`;
                statusLabelEn.style.display = 'inline';
            } else {
                statusLabelEn.style.display = 'none';
            }
        }
        
        // ê´‘ê³  ìƒíƒœ ì„¤ì •
        const statusElement = document.getElementById('region-modal-status');
        const statusIcon = statusElement.querySelector('.status-icon');
        const statusText = statusElement.querySelector('.status-text');
        
        const availableText = this.getLanguageText('Available');
        const occupiedText = this.getLanguageText('Occupied');
        
        if (regionData.ad_status === 'occupied') {
            statusElement.className = 'status-badge occupied';
            statusIcon.textContent = 'âŒ';
            statusText.textContent = occupiedText.primary;
        } else {
            statusElement.className = 'status-badge available';
            statusIcon.textContent = 'âœ…';
            statusText.textContent = availableText.primary;
        }
        
        // ìƒíƒœ ì„¤ëª… ì„¤ì •
        const statusDescription = document.querySelector('.status-description');
        const descriptionPrimary = statusDescription?.querySelector('.description-primary');
        const descriptionSecondary = document.getElementById('region-modal-status-description-en');
        
        if (regionData.ad_status === 'occupied') {
            const occupiedDesc = this.getLanguageText('This region is currently occupied by an advertisement.');
            if (descriptionPrimary) descriptionPrimary.textContent = occupiedDesc.primary;
            if (descriptionSecondary && occupiedDesc.secondary) {
                descriptionSecondary.textContent = ` (${occupiedDesc.secondary})`;
                descriptionSecondary.style.display = 'inline';
            } else if (descriptionSecondary) {
                descriptionSecondary.style.display = 'none';
            }
        } else {
            const availableDesc = this.getLanguageText('This region is available for advertisement registration.');
            if (descriptionPrimary) descriptionPrimary.textContent = availableDesc.primary;
            if (descriptionSecondary && availableDesc.secondary) {
                descriptionSecondary.textContent = ` (${availableDesc.secondary})`;
                descriptionSecondary.style.display = 'inline';
            } else if (descriptionSecondary) {
                descriptionSecondary.style.display = 'none';
            }
        }
        
        // êµ¬ë§¤ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì • ë° í‘œì‹œ/ìˆ¨ê¹€ ì œì–´
        const purchaseText = this.getLanguageText('Purchase This Region');
        const purchaseBtn = document.getElementById('region-purchase-btn');
        if (purchaseBtn) {
            purchaseBtn.textContent = purchaseText.primary;
            // data-state-id ì„¤ì • (ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ì—ì„œ í™œìš©) - ê°•í™”
            // stateIdê°€ ì—†ìœ¼ë©´ currentRegion.id ë˜ëŠ” selectedStateId ì‚¬ìš©
            const btnStateId = stateId || this.currentRegion?.id || this.selectedStateId;
            if (btnStateId) {
                purchaseBtn.dataset.stateId = btnStateId;
                console.log('êµ¬ë§¤ ë²„íŠ¼ì— data-state-id ì„¤ì •:', btnStateId, {
                    stateId: stateId,
                    currentRegionId: this.currentRegion?.id,
                    selectedStateId: this.selectedStateId
                });
            } else {
                console.warn('êµ¬ë§¤ ë²„íŠ¼ì— data-state-idë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. stateIdê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            // ê´€ë¦¬ìëŠ” í•­ìƒ êµ¬ë§¤ ë²„íŠ¼ í‘œì‹œ (ì‹¤ì œ ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
            if (this.isAdminLoggedIn) {
                purchaseBtn.classList.remove('hidden');
            } else {
                // ì¼ë°˜ ì‚¬ìš©ìëŠ” occupied ìƒíƒœì¼ ë•Œë§Œ ìˆ¨ê¹€
                const isOccupied = regionData.ad_status === 'occupied' || regionData.occupied;
                if (isOccupied) {
                    purchaseBtn.classList.add('hidden');
                } else {
                    purchaseBtn.classList.remove('hidden');
                }
            }
        }
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ í¸ì§‘ ë²„íŠ¼ í‘œì‹œ
        const regionEditBtn = document.getElementById('region-edit-btn');
        if (regionEditBtn) {
            if (this.isAdminLoggedIn) {
                regionEditBtn.classList.remove('hidden');
            } else {
                regionEditBtn.classList.add('hidden');
            }
        }
        
        // í”½ì…€ ì—ë””í„° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ì†Œìœ ìë§Œ, ê´€ë¦¬ìëŠ” í•­ìƒ í‘œì‹œ)
        const regionEditPixelBtn = document.getElementById('region-edit-pixel-btn');
        if (regionEditPixelBtn) {
            // data-state-id ì„¤ì • (ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ì—ì„œ í™œìš©) - ê°•í™”
            // stateIdê°€ ì—†ìœ¼ë©´ currentRegion.id ë˜ëŠ” selectedStateId ì‚¬ìš©
            const btnStateId = stateId || this.currentRegion?.id || this.selectedStateId;
            if (btnStateId) {
                regionEditPixelBtn.dataset.stateId = btnStateId;
                console.log('í”½ì…€ ì•„íŠ¸ í¸ì§‘ ë²„íŠ¼ì— data-state-id ì„¤ì •:', btnStateId, {
                    stateId: stateId,
                    currentRegionId: this.currentRegion?.id,
                    selectedStateId: this.selectedStateId
                });
            } else {
                console.warn('í”½ì…€ ì•„íŠ¸ í¸ì§‘ ë²„íŠ¼ì— data-state-idë¥¼ ì„¤ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. stateIdê°€ ì—†ìŠµë‹ˆë‹¤.');
            }
            this.updatePixelEditorButtonVisibility(regionEditPixelBtn, stateId);
        }
        
        // ì˜¥ì…˜ ì •ë³´ ë¡œë“œ ë° í‘œì‹œ
        await this.loadAndDisplayAuctionInfo(stateId);
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('region-info-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'block';
        }
    }
    
    /**
     * ì˜¥ì…˜ ì •ë³´ ë¡œë“œ ë° í‘œì‹œ
     */
    async loadAndDisplayAuctionInfo(regionId) {
        const auctionSection = document.getElementById('region-auction-section');
        if (!auctionSection) return;
        
        try {
            const auctionData = await this.getAuction(regionId);
            
            if (auctionData && auctionData.status === 'active') {
                // ì˜¥ì…˜ ì„¹ì…˜ í‘œì‹œ
                auctionSection.classList.remove('hidden');
                
                // í˜„ì¬ ì…ì°°ê°€
                const currentBid = auctionData.currentBid || 1.0;
                document.getElementById('region-auction-current-bid').textContent = `$${currentBid.toFixed(2)}`;
                
                // ë‚¨ì€ ì‹œê°„
                if (auctionData.endTime) {
                    const endTime = auctionData.endTime.toMillis ? auctionData.endTime.toMillis() : auctionData.endTime;
                    const remaining = endTime - Date.now();
                    const hours = Math.floor(remaining / (1000 * 60 * 60));
                    const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                    document.getElementById('region-auction-time-remaining').textContent = 
                        remaining > 0 ? `${hours}ì‹œê°„ ${minutes}ë¶„` : 'ì¢…ë£Œë¨';
                }
                
                // ìµœê³  ì…ì°°ì
                const highestBidder = auctionData.highestBidderEmail || auctionData.highestBidder || 'ì—†ìŒ';
                document.getElementById('region-auction-highest-bidder').textContent = highestBidder;
                
                // ì˜ˆìƒ ë…¸ì¶œ ìˆ˜ (ì¸êµ¬ ê¸°ë°˜ ì¶”ì •)
                const regionData = this.regionData.get(regionId);
                const population = regionData?.population || 0;
                const estimatedImpressions = Math.floor(population * 0.3); // ì¸êµ¬ì˜ 30%ê°€ ë…¸ì¶œëœë‹¤ê³  ê°€ì •
                document.getElementById('region-estimated-impressions').textContent = 
                    estimatedImpressions > 0 ? estimatedImpressions.toLocaleString() : '-';
                
                // í™€ë” í”„ë¡œí•„ (ë‚™ì°°ëœ ê²½ìš°)
                if (auctionData.status === 'sold' && auctionData.highestBidderId) {
                    await this.loadHolderProfile(auctionData.highestBidderId, regionId);
                } else {
                    document.getElementById('region-holder-profile').classList.add('hidden');
                }
                
                // ì…ì°° íƒ€ì„ë¼ì¸
                await this.loadBidTimeline(regionId, auctionData.bidHistory || []);
            } else {
                // ì˜¥ì…˜ì´ ì—†ê±°ë‚˜ ì¢…ë£Œëœ ê²½ìš°
                auctionSection.classList.add('hidden');
            }
        } catch (error) {
            console.error('[ì˜¥ì…˜ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨]:', error);
            auctionSection.classList.add('hidden');
        }
    }
    
    /**
     * í™€ë” í”„ë¡œí•„ ë¡œë“œ
     */
    async loadHolderProfile(userId, regionId) {
        const holderProfile = document.getElementById('region-holder-profile');
        if (!holderProfile) return;
        
        try {
            const { doc, getDoc, collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
            const userRef = doc(this.firestore, 'users', userId);
            const userSnap = await getDoc(userRef);
            
            if (userSnap.exists()) {
                const userData = userSnap.data();
                document.getElementById('region-holder-name').textContent = userData.displayName || userData.email || 'Unknown';
                document.getElementById('region-holder-email').textContent = userData.email || '-';
                
                // ì†Œìœ  ì§€ì—­ ìˆ˜ ê³„ì‚°
                const auctionsRef = collection(this.firestore, 'auctions');
                const ownedQuery = query(auctionsRef, where('status', '==', 'sold'), where('highestBidderId', '==', userId));
                const ownedSnapshot = await getDocs(ownedQuery);
                document.getElementById('region-holder-regions-count').textContent = ownedSnapshot.size;
                
                // ì´ ì…ì°° ìˆ˜ ê³„ì‚°
                const allAuctionsQuery = query(auctionsRef);
                const allAuctionsSnapshot = await getDocs(allAuctionsQuery);
                let totalBids = 0;
                allAuctionsSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.bidHistory) {
                        totalBids += data.bidHistory.filter(bid => bid.bidderId === userId).length;
                    }
                });
                document.getElementById('region-holder-total-bids').textContent = totalBids;
                
                holderProfile.classList.remove('hidden');
            } else {
                holderProfile.classList.add('hidden');
            }
        } catch (error) {
            console.error('[í™€ë” í”„ë¡œí•„ ë¡œë“œ ì‹¤íŒ¨]:', error);
            holderProfile.classList.add('hidden');
        }
    }
    
    /**
     * ì…ì°° íƒ€ì„ë¼ì¸ ë¡œë“œ
     */
    async loadBidTimeline(regionId, bidHistory) {
        const timelineList = document.getElementById('region-bid-timeline-list');
        if (!timelineList) return;
        
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (timelineList.firstChild) {
            timelineList.removeChild(timelineList.firstChild);
        }
        
        if (!bidHistory || bidHistory.length === 0) {
            const emptyP = document.createElement('p');
            emptyP.style.textAlign = 'center';
            emptyP.style.color = '#666';
            emptyP.style.padding = '20px';
            emptyP.textContent = 'ì…ì°° ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.';
            timelineList.appendChild(emptyP);
            return;
        }
        
        // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedHistory = [...bidHistory].sort((a, b) => {
            const timeA = a.timestamp?.toMillis ? a.timestamp.toMillis() : (a.timestamp || 0);
            const timeB = b.timestamp?.toMillis ? b.timestamp.toMillis() : (b.timestamp || 0);
            return timeB - timeA;
        });
        
        sortedHistory.forEach((bid, index) => {
            const time = bid.timestamp?.toDate ? bid.timestamp.toDate() : new Date(bid.timestamp || Date.now());
            const timeStr = time.toLocaleString('ko-KR', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric', 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            const item = document.createElement('div');
            item.className = 'timeline-item';
            
            const icon = document.createElement('div');
            icon.className = 'timeline-icon';
            icon.textContent = index === 0 ? 'ğŸ†' : 'ğŸ’°';
            
            const content = document.createElement('div');
            content.className = 'timeline-content';
            
            const bidder = document.createElement('div');
            bidder.className = 'timeline-bidder';
            bidder.textContent = this.sanitizeHTML(bid.bidderEmail || bid.bidderId || 'Unknown');
            
            const amount = document.createElement('div');
            amount.className = 'timeline-amount';
            amount.textContent = `$${bid.amount.toFixed(2)}`;
            
            const timeDiv = document.createElement('div');
            timeDiv.className = 'timeline-time';
            timeDiv.textContent = timeStr;
            
            content.appendChild(bidder);
            content.appendChild(amount);
            content.appendChild(timeDiv);
            
            item.appendChild(icon);
            item.appendChild(content);
            timelineList.appendChild(item);
        });
    }
    
    // ==================== ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ ====================
    openUserDashboard() {
        if (!this.currentUser) {
            this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            this.showUserLoginModal();
            return;
        }
        
        const modal = document.getElementById('user-dashboard-modal');
        if (!modal) return;
        
        modal.classList.remove('hidden');
        const shouldRefresh = !this.userDashboardState.lastLoadedAt 
            || (Date.now() - this.userDashboardState.lastLoadedAt > 60 * 1000);
        
        if (shouldRefresh) {
            this.loadUserDashboardData(true);
        } else {
            this.renderUserDashboardState();
        }
    }
    
    closeUserDashboard(options = {}) {
        const modal = document.getElementById('user-dashboard-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        if (!options.silent && this.userDashboardState.entries.length === 0) {
            const emptyEl = document.getElementById('user-dashboard-empty');
            if (emptyEl) {
                emptyEl.classList.add('hidden');
            }
        }
    }
    
    isUserDashboardOpen() {
        const modal = document.getElementById('user-dashboard-modal');
        return modal ? !modal.classList.contains('hidden') : false;
    }
    
    switchUserDashboardTab(tabName = 'active') {
        if (!tabName) return;
        this.userDashboardState.activeTab = tabName;
        const tabs = document.querySelectorAll('.user-dashboard-tabs .tab-btn');
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });
        this.renderUserDashboardList(this.userDashboardState.entries || []);
    }
    
    setUserDashboardLoading(isLoading) {
        this.userDashboardState.loading = isLoading;
        const loadingEl = document.getElementById('user-dashboard-loading');
        const contentEl = document.getElementById('user-dashboard-content');
        if (loadingEl) {
            loadingEl.classList.toggle('hidden', !isLoading);
        }
        if (contentEl) {
            contentEl.classList.toggle('hidden', isLoading);
        }
    }
    
    showUserDashboardError(message) {
        const errorEl = document.getElementById('user-dashboard-error');
        const contentEl = document.getElementById('user-dashboard-content');
        if (errorEl) {
            const textEl = errorEl.querySelector('p');
            if (textEl) {
                textEl.textContent = message || 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
            }
            errorEl.classList.remove('hidden');
        }
        if (contentEl) {
            contentEl.classList.add('hidden');
        }
    }
    
    clearUserDashboardError() {
        const errorEl = document.getElementById('user-dashboard-error');
        if (errorEl) {
            errorEl.classList.add('hidden');
        }
    }
    
    async loadUserDashboardData(force = false) {
        if (!this.currentUser) {
            return;
        }
        
        if (this.userDashboardState.loading && !force) {
            return;
        }
        
        if (!this.isFirebaseInitialized || !this.firestore) {
            await this.initializeFirebase();
            if (!this.firestore) {
                this.showUserDashboardError('Firebase ì„¤ì • í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }
        }
        
        this.clearUserDashboardError();
        this.setUserDashboardLoading(true);
        
        try {
            const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionsRef = collection(this.firestore, 'auctions');
            const bidsQuery = query(auctionsRef, where('participantIds', 'array-contains', this.currentUser.uid));
            const snapshot = await getDocs(bidsQuery);
            
            const entries = [];
            snapshot.forEach(doc => {
                const entry = this.buildUserDashboardEntry(doc.id, doc.data());
                if (entry) {
                    entries.push(entry);
                }
            });
            
            entries.sort((a, b) => (b.lastBidAt || 0) - (a.lastBidAt || 0));
            this.userDashboardState.entries = entries;
            this.userDashboardState.timeline = this.buildUserDashboardTimeline(entries);
            this.userDashboardState.lastLoadedAt = Date.now();
            this.renderUserDashboardState();
        } catch (error) {
            console.error('[ì‚¬ìš©ì ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨]:', error);
            this.showUserDashboardError('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        } finally {
            this.setUserDashboardLoading(false);
        }
    }
    
    buildUserDashboardEntry(auctionId, auctionData) {
        if (!auctionData || !this.currentUser) {
            return null;
        }
        const userId = this.currentUser.uid;
        const userEmail = this.currentUser.email;
        const regionId = auctionData.regionId || auctionId;
        const regionMeta = this.regionData.get(regionId);
        const toMillis = (value) => {
            if (!value) return null;
            if (typeof value.toMillis === 'function') return value.toMillis();
            if (typeof value.toDate === 'function') return value.toDate().getTime();
            if (value instanceof Date) return value.getTime();
            if (typeof value === 'number') return value;
            return null;
        };
        
        const myBids = (auctionData.bidHistory || []).filter(bid => {
            return (bid.bidderId && bid.bidderId === userId) || (bid.bidderEmail && bid.bidderEmail === userEmail);
        });
        if (myBids.length === 0) {
            return null;
        }
        const lastBid = myBids[myBids.length - 1];
        const lastBidAt = toMillis(lastBid.timestamp) || Date.now();
        const status = auctionData.status || 'active';
        const isHighest = auctionData.highestBidderId === userId;
        const category = this.resolveUserAuctionCategory(status, isHighest);
        
        return {
            regionId,
            regionName: auctionData.regionName || auctionData.regionNameEn || regionMeta?.name_ko || regionMeta?.name || regionId,
            country: auctionData.country || regionMeta?.country || '-',
            lastBidAmount: lastBid.amount,
            lastBidAt,
            currentBid: auctionData.currentBid || auctionData.startPrice || lastBid.amount || 0,
            myBidCount: myBids.length,
            myIsHighest: isHighest,
            status,
            category,
            endTime: toMillis(auctionData.endTime),
            timeline: myBids.map(bid => ({
                amount: bid.amount,
                timestamp: toMillis(bid.timestamp) || lastBidAt
            }))
        };
    }
    
    resolveUserAuctionCategory(status, isHighest) {
        switch (status) {
            case 'sold':
            case 'ended':
                return isHighest ? 'won' : 'lost';
            case 'pending_payment':
                return isHighest ? 'active' : 'lost';
            default:
                return 'active';
        }
    }
    
    buildUserDashboardSummary(entries = []) {
        return entries.reduce((acc, entry) => {
            if (entry.category === 'active') acc.active += 1;
            if (entry.category === 'won') acc.won += 1;
            if (entry.category === 'lost') acc.lost += 1;
            acc.totalAmount += entry.lastBidAmount || 0;
            return acc;
        }, { active: 0, won: 0, lost: 0, totalAmount: 0 });
    }
    
    renderUserDashboardSummaryUI() {
        const summary = this.buildUserDashboardSummary(this.userDashboardState.entries || []);
        const activeEl = document.getElementById('user-bids-active-count');
        const wonEl = document.getElementById('user-bids-won-count');
        const lostEl = document.getElementById('user-bids-lost-count');
        const totalEl = document.getElementById('user-bids-total-amount');
        
        if (activeEl) activeEl.textContent = summary.active.toLocaleString();
        if (wonEl) wonEl.textContent = summary.won.toLocaleString();
        if (lostEl) lostEl.textContent = summary.lost.toLocaleString();
        if (totalEl) totalEl.textContent = this.formatCurrency(summary.totalAmount || 0);
    }
    
    renderUserDashboardState() {
        this.renderUserDashboardSummaryUI();
        this.renderUserDashboardList(this.userDashboardState.entries || []);
        this.renderUserDashboardTimeline(this.userDashboardState.timeline || []);
    }
    
    renderUserDashboardList(entries = []) {
        const listEl = document.getElementById('user-dashboard-list');
        const emptyEl = document.getElementById('user-dashboard-empty');
        if (!listEl || !emptyEl) return;
        
        listEl.innerHTML = '';
        const targetTab = this.userDashboardState.activeTab || 'active';
        const filtered = entries.filter(entry => entry.category === targetTab);
        
        if (filtered.length === 0) {
            emptyEl.classList.remove('hidden');
            return;
        }
        emptyEl.classList.add('hidden');
        
        filtered.forEach(entry => {
            const card = document.createElement('div');
            card.className = 'user-dashboard-card';
            const statusClass = this.getUserDashboardStatusClass(entry);
            const statusLabel = this.getUserDashboardStatusLabel(entry);
            const lastBidDate = entry.lastBidAt ? new Date(entry.lastBidAt).toLocaleString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '-';
            
            card.innerHTML = `
                <div class="user-card-header">
                    <div class="user-card-title">${this.sanitizeHTML(entry.regionName || entry.regionId)}</div>
                    <div class="user-card-meta">${this.sanitizeHTML(entry.country || '-')}</div>
                    <span class="status-chip ${statusClass}">${statusLabel}</span>
                </div>
                <div class="user-card-stat">
                    <label>ë‚´ ìµœê·¼ ì…ì°°</label>
                    <span>${this.formatCurrency(entry.lastBidAmount || 0)}</span>
                    <small style="color: rgba(255,255,255,0.6);">${lastBidDate}</small>
                </div>
                <div class="user-card-stat">
                    <label>í˜„ì¬ ìµœê³ ê°€</label>
                    <span>${this.formatCurrency(entry.currentBid || 0)}</span>
                </div>
                <div class="user-card-actions">
                    <button data-dashboard-action="open-auction" data-region-id="${this.sanitizeHTML(entry.regionId)}">ì˜¥ì…˜ ì—´ê¸°</button>
                </div>
            `;
            listEl.appendChild(card);
        });
    }
    
    getUserDashboardStatusLabel(entry) {
        if (entry.category === 'won') return 'ë‚™ì°°';
        if (entry.category === 'lost') return 'ìœ ì°°';
        if (entry.status === 'pending_payment' && entry.myIsHighest) return 'ê²°ì œ ëŒ€ê¸°';
        return 'ì§„í–‰ ì¤‘';
    }
    
    getUserDashboardStatusClass(entry) {
        if (entry.category === 'won') return 'status-won';
        if (entry.category === 'lost') return 'status-lost';
        if (entry.status === 'pending_payment' && entry.myIsHighest) return 'status-pending';
        return 'status-active';
    }
    
    buildUserDashboardTimeline(entries = []) {
        const events = [];
        entries.forEach(entry => {
            (entry.timeline || []).forEach(bid => {
                events.push({
                    regionId: entry.regionId,
                    regionName: entry.regionName,
                    amount: bid.amount,
                    timestamp: bid.timestamp,
                    category: entry.category
                });
            });
        });
        events.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
        return events.slice(0, 10);
    }
    
    renderUserDashboardTimeline(events = []) {
        const container = document.getElementById('user-dashboard-activity');
        if (!container) return;
        container.innerHTML = '';
        
        if (events.length === 0) {
            const empty = document.createElement('p');
            empty.style.color = 'rgba(255,255,255,0.6)';
            empty.style.textAlign = 'center';
            empty.textContent = 'ìµœê·¼ í™œë™ì´ ì—†ìŠµë‹ˆë‹¤.';
            container.appendChild(empty);
            return;
        }
        
        events.forEach(event => {
            const item = document.createElement('div');
            item.className = 'timeline-event';
            
            const icon = document.createElement('div');
            icon.className = 'timeline-icon';
            icon.textContent = event.category === 'won' ? 'ğŸ†' : event.category === 'lost' ? 'âŒ' : 'ğŸ’°';
            
            const content = document.createElement('div');
            content.className = 'timeline-content';
            
            const title = document.createElement('div');
            title.className = 'timeline-title';
            title.textContent = `${event.regionName} - ${this.formatCurrency(event.amount || 0)}`;
            
            const meta = document.createElement('div');
            meta.className = 'timeline-meta';
            const dateLabel = event.timestamp ? new Date(event.timestamp).toLocaleString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            }) : '-';
            meta.textContent = dateLabel;
            
            content.appendChild(title);
            content.appendChild(meta);
            item.appendChild(icon);
            item.appendChild(content);
            container.appendChild(item);
        });
    }
    
    async openAuctionFromDashboard(regionId) {
        if (!regionId) {
            this.showNotification('ì§€ì—­ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }
        
        let region = this.regionData.get(regionId);
        if (!region) {
            region = await this.getRegionById(regionId);
        }
        
        if (!region) {
            this.showNotification('ì§€ì—­ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        this.currentRegion = region;
        await this.openAuctionModal(region);
    }
    
    // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideCompanyInfoModal() {
        const modal = document.getElementById('company-info-modal');
        modal.classList.add('hidden');
    }
    
    // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideRegionInfoModal() {
        const modal = document.getElementById('region-info-modal');
        modal.classList.add('hidden');
    }
    
    // ê¸°ì—… ì •ë³´ ë¡œë“œ (í¸ì§‘ìš©)
    loadCompanyInfoForEdit(stateId) {
        console.log('ê¸°ì—… ì •ë³´ ë¡œë“œ (í¸ì§‘ìš©):', stateId, 'ëª¨ë“œ:', this.currentMapMode);
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const companyData = this.currentMapMode === 'korea' 
            ? this.koreaCompanyData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanCompanyData[stateId]
            : this.companyData[stateId];
            
        if (companyData) {
            // í¼ í•„ë“œë“¤ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('company-name-input').value = companyData.name || '';
            document.getElementById('company-industry-input').value = companyData.industry || '';
            document.getElementById('company-founded-input').value = companyData.founded || '';
            document.getElementById('company-employees-input').value = companyData.employees || '';
            document.getElementById('company-website-input').value = companyData.website || '';
            document.getElementById('company-description-input').value = companyData.description || '';
            
            // íŠ¹ì§• ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
            const featuresText = companyData.features ? companyData.features.join('\n') : '';
            document.getElementById('company-features-input').value = featuresText;
            
            console.log('ê¸°ì—… ì •ë³´ ë¡œë“œ ì™„ë£Œ:', companyData);
        } else {
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            document.getElementById('company-name-input').value = '';
            document.getElementById('company-industry-input').value = '';
            document.getElementById('company-founded-input').value = '';
            document.getElementById('company-employees-input').value = '';
            document.getElementById('company-website-input').value = '';
            document.getElementById('company-description-input').value = '';
            document.getElementById('company-features-input').value = '';
            
            console.log('ê¸°ì—… ì •ë³´ ì—†ìŒ, ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”');
        }
    }
    
    // ê¸°ì—… ì •ë³´ ì €ì¥ (ëª¨ë“œë³„ ë°ì´í„° ì²˜ë¦¬)
    async saveCompanyInfo() {
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ê¶Œí•œ í™•ì¸: ê´€ë¦¬ìì´ê±°ë‚˜ í•´ë‹¹ ì§€ì—­ì˜ ì†Œìœ ìì¸ì§€ í™•ì¸
        if (!this.isAdminLoggedIn) {
            // ì¼ë°˜ ì‚¬ìš©ìì¸ ê²½ìš° ì†Œìœ ê¶Œ í™•ì¸
            const isOwner = await this.checkRegionOwnership(this.selectedStateId);
            if (!isOwner) {
                this.showNotification('ì´ ì§€ì—­ì˜ ì†Œìœ ìë§Œ ê¸°ì—… ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € í•´ë‹¹ ì§€ì—­ì„ êµ¬ë§¤í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
        }
        
        // í¼ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
        const companyData = {
            name: document.getElementById('company-name-input').value,
            industry: document.getElementById('company-industry-input').value,
            founded: document.getElementById('company-founded-input').value,
            employees: document.getElementById('company-employees-input').value,
            website: document.getElementById('company-website-input').value,
            description: document.getElementById('company-description-input').value,
            features: document.getElementById('company-features-input').value.split('\n').filter(f => f.trim()),
            logo: this.currentMapMode === 'korea' 
                ? (this.koreaLogoData[this.selectedStateId]?.src || '')
                : (this.logoData[this.selectedStateId]?.src || '')
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaCompanyData[this.selectedStateId] = companyData;
        } else if (this.currentMapMode === 'japan') {
            this.japanCompanyData[this.selectedStateId] = companyData;
        } else {
            this.companyData[this.selectedStateId] = companyData;
        }
        
        this.showNotification('ê¸°ì—… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ê¸°ì—… ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, companyData, 'ëª¨ë“œ:', this.currentMapMode);
    }
    
    
    // ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸
    updateAdminPanel(stateId, stateName) {
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸:', stateId, stateName);
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanLogoData[stateId]
            : this.logoData[stateId];
        const colorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanColorData[stateId]
            : this.colorData[stateId];
        const companyData = this.currentMapMode === 'korea' 
            ? this.koreaCompanyData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanCompanyData[stateId]
            : this.companyData[stateId];
        
        // ì„ íƒëœ ì£¼ ì´ë¦„ í‘œì‹œ
        const selectedStateElement = document.getElementById('selected-state-name');
        if (selectedStateElement) {
            selectedStateElement.textContent = stateName;
        } else {
            console.warn('selected-state-name ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        this.updateLogoPreview();
        
        // ìƒ‰ìƒ ì„¤ì • ì—…ë°ì´íŠ¸
        if (colorData) {
            const fillColorInput = document.getElementById('region-color');
            const borderColorInput = document.getElementById('border-color');
            const borderWidthInput = document.getElementById('border-width');
            
            if (fillColorInput) {
                fillColorInput.value = colorData.fillColor || '#4ecdc4';
            }
            if (borderColorInput) {
                borderColorInput.value = colorData.borderColor || '#ffffff';
            }
            if (borderWidthInput) {
                borderWidthInput.value = colorData.borderWidth || 1;
            }
        }
        
        // ê¸°ì—… ì •ë³´ ë¡œë“œ
        this.loadCompanyInfoForEdit(stateId);
        
        // ì§€ì—­ ì •ë³´ ë¡œë“œ
        this.loadRegionInfoForEdit(stateId);
        
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
    
    // ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateLogoPreview() {
        const previewImg = document.getElementById('current-logo-img');
        const noLogoMsg = document.getElementById('no-logo');
        
        // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if (!previewImg || !noLogoMsg) {
            console.warn('ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { previewImg, noLogoMsg });
            return;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanLogoData[this.selectedStateId]
            : this.logoData[this.selectedStateId];
        
        if (logoData && logoData.src) {
            previewImg.src = logoData.src;
            previewImg.style.display = 'block';
            noLogoMsg.style.display = 'none';
            console.log('ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸:', logoData.src);
        } else {
            previewImg.style.display = 'none';
            noLogoMsg.style.display = 'block';
            console.log('ë¡œê³  ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ');
        }
    }
    
    // ì§€ì—­ ì •ë³´ í¸ì§‘ìš© ë¡œë“œ
    loadRegionInfoForEdit(stateId) {
        console.log('ì§€ì—­ ì •ë³´ ë¡œë“œ (í¸ì§‘ìš©):', stateId);
        
        const regionData = this.regionData.get(stateId);
        if (!regionData) {
            console.warn('ì§€ì—­ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        // í¼ í•„ë“œì— ë°ì´í„° ì±„ìš°ê¸°
        const nameKoInput = document.getElementById('region-name-ko-input');
        const nameEnInput = document.getElementById('region-name-en-input');
        const countryInput = document.getElementById('region-country-input');
        const adminLevelInput = document.getElementById('region-admin-level-input');
        const populationInput = document.getElementById('region-population-input');
        const areaInput = document.getElementById('region-area-input');
        const adPriceInput = document.getElementById('region-ad-price-input');
        const adStatusInput = document.getElementById('region-ad-status-input');
        
        if (nameKoInput) nameKoInput.value = regionData.name_ko || regionData.name || '';
        if (nameEnInput) nameEnInput.value = regionData.name_en || regionData.name || '';
        if (countryInput) countryInput.value = regionData.country || '';
        if (adminLevelInput) adminLevelInput.value = regionData.admin_level || '';
        if (populationInput) populationInput.value = regionData.population || 0;
        if (areaInput) areaInput.value = regionData.area || 0;
        if (adPriceInput) adPriceInput.value = regionData.ad_price || 0;
        if (adStatusInput) adStatusInput.value = regionData.ad_status || 'available';
        
        console.log('ì§€ì—­ ì •ë³´ ë¡œë“œ ì™„ë£Œ:', regionData);
    }
    
    // ì§€ì—­ ì •ë³´ ì €ì¥
    async saveRegionInfo() {
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        const regionData = this.regionData.get(this.selectedStateId);
        if (!regionData) {
            this.showNotification('ì§€ì—­ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        // í¼ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
        const nameKoInput = document.getElementById('region-name-ko-input');
        const nameEnInput = document.getElementById('region-name-en-input');
        const countryInput = document.getElementById('region-country-input');
        const adminLevelInput = document.getElementById('region-admin-level-input');
        const populationInput = document.getElementById('region-population-input');
        const areaInput = document.getElementById('region-area-input');
        const adPriceInput = document.getElementById('region-ad-price-input');
        const adStatusInput = document.getElementById('region-ad-status-input');
        
        // ì§€ì—­ ë°ì´í„° ì—…ë°ì´íŠ¸
        regionData.name_ko = nameKoInput?.value || regionData.name_ko || '';
        regionData.name_en = nameEnInput?.value || regionData.name_en || regionData.name || '';
        regionData.country = countryInput?.value || regionData.country || '';
        regionData.admin_level = adminLevelInput?.value || regionData.admin_level || '';
        regionData.population = parseInt(populationInput?.value) || regionData.population || 0;
        regionData.area = parseInt(areaInput?.value) || regionData.area || 0;
        
        const parsedAdPrice = parseFloat(adPriceInput?.value);
        if (!Number.isNaN(parsedAdPrice) && parsedAdPrice >= 0) {
            regionData.ad_price = parsedAdPrice;
        } else if (typeof regionData.ad_price !== 'number') {
            regionData.ad_price = this.uniformAdPrice;
        }
        
        regionData.ad_status = adStatusInput?.value || regionData.ad_status || 'available';

        // regionData Map ì—…ë°ì´íŠ¸
        this.regionData.set(this.selectedStateId, regionData);
        
        // GeoJSON ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ (ì§€ë„ì— ë°˜ì˜)
        if (this.map && this.map.getSource('world-regions')) {
            const source = this.map.getSource('world-regions');
            const geoJsonData = source._data;
            
            // í•´ë‹¹ featureì˜ properties ì—…ë°ì´íŠ¸
            const feature = geoJsonData.features.find(f => f.properties.id === this.selectedStateId);
            if (feature) {
                Object.assign(feature.properties, regionData);
                source.setData(geoJsonData);
            }
        }
        
        // í˜„ì¬ êµ­ê°€ë³„ GeoJSON ì†ŒìŠ¤ë„ ì—…ë°ì´íŠ¸
        const sourceId = this.getCurrentSourceId();
        if (this.map && this.map.getSource(sourceId)) {
            const source = this.map.getSource(sourceId);
            const geoJsonData = source._data;
            
            const feature = geoJsonData.features.find(f => f.properties.id === this.selectedStateId);
            if (feature) {
                Object.assign(feature.properties, regionData);
                source.setData(geoJsonData);
            }
        }
        
        // Firestoreì— ì €ì¥ (ë¹„ë™ê¸°)
        try {
            const saved = await this.saveRegionDataToFirestore(this.selectedStateId, regionData);
            if (saved) {
                this.showNotification('ì§€ì—­ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (Firestore ë™ê¸°í™” ì™„ë£Œ)', 'success');
                console.log('Firestoreì— ì§€ì—­ ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, regionData);
            } else {
                this.showNotification('ì§€ì—­ ì •ë³´ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (Firestore ë™ê¸°í™” ì‹¤íŒ¨)', 'warning');
                console.log('ë¡œì»¬ì—ë§Œ ì§€ì—­ ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, regionData);
            }
        } catch (error) {
            console.error('ì§€ì—­ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            this.showNotification('ì§€ì—­ ì •ë³´ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (Firestore ë™ê¸°í™” ì‹¤íŒ¨)', 'warning');
            console.log('ë¡œì»¬ì—ë§Œ ì§€ì—­ ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, regionData);
        }
    }
    
    // ëª¨ë‹¬ì—ì„œ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì‹œ ê´€ë¦¬ì íŒ¨ë„ ì—´ê¸°
    openRegionEditFromModal() {
        if (!this.isAdminLoggedIn) {
            this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            return;
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        this.hideCompanyInfoModal();
        this.hideRegionInfoModal();
        
        // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
        const adminPanel = document.getElementById('admin-panel');
        if (adminPanel) {
            adminPanel.classList.remove('hidden');
        }
        
        // ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”
        this.adminMode = true;
        this.updateAdminModeControls();
        
        // ì§€ì—­ ì •ë³´ ë¡œë“œ
        if (this.currentRegion && this.currentRegion.id) {
            this.selectedStateId = this.currentRegion.id;
            const regionName = this.getRegionDisplayName(this.currentRegion);
            this.updateAdminPanel(this.selectedStateId, regionName);
        }
    }
    
    // í˜„ì¬ ì†ŒìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
    getCurrentSourceId() {
        const sourceMap = {
            'usa': 'world-regions',
            'korea': 'korea-regions',
            'japan': 'japan-regions',
            'china': 'china-regions',
            'russia': 'russia-regions',
            'india': 'india-regions',
            'canada': 'canada-regions',
            'germany': 'germany-regions',
            'uk': 'uk-regions',
            'france': 'france-regions',
            'italy': 'italy-regions',
            'brazil': 'brazil-regions',
            'australia': 'australia-regions',
            'mexico': 'mexico-regions',
            'indonesia': 'indonesia-regions',
            'saudi-arabia': 'saudi-arabia-regions',
            'turkey': 'turkey-regions',
            'south-africa': 'south-africa-regions',
            'argentina': 'argentina-regions',
            'european-union': 'european-union-regions',
            'spain': 'spain-regions',
            'netherlands': 'netherlands-regions',
            'poland': 'poland-regions',
            'belgium': 'belgium-regions',
            'sweden': 'sweden-regions',
            'austria': 'austria-regions',
            'denmark': 'denmark-regions',
            'finland': 'finland-regions',
            'ireland': 'ireland-regions',
            'portugal': 'portugal-regions',
            'greece': 'greece-regions',
            'czech-republic': 'czech-republic-regions',
            'romania': 'romania-regions',
            'hungary': 'hungary-regions',
            'bulgaria': 'bulgaria-regions'
        };
        
        return sourceMap[this.currentMapMode] || 'world-regions';
    }
    
    // ==================== ì˜¥ì…˜ ì‹œìŠ¤í…œ ====================
    
    /**
     * ì˜¥ì…˜ ìƒì„± ë˜ëŠ” ì¡°íšŒ
     * ê·œì¹™: ì´ˆê¸°ê°€ 1ë‹¬ëŸ¬, ìµœì†Œ 12ì‹œê°„ ë³´ì¥
     */
    async createOrGetAuction(regionId, regionData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì˜¥ì…˜ì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return null;
        }
        
        try {
            const { doc, getDoc, setDoc, serverTimestamp, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            const auctionSnap = await getDoc(auctionRef);
            
            if (auctionSnap.exists()) {
                // ê¸°ì¡´ ì˜¥ì…˜ì´ ìˆëŠ” ê²½ìš°
                const auctionData = auctionSnap.data();
                this.activeAuctions.set(regionId, auctionData);
                this.startAuctionCountdown(regionId, auctionData);
                return auctionData;
            } else {
                // ìƒˆ ì˜¥ì…˜ ìƒì„±
                const now = Timestamp.now();
                const endTime = Timestamp.fromMillis(now.toMillis() + (12 * 60 * 60 * 1000)); // 12ì‹œê°„ í›„
                
                // í”½ì…€ ìˆ˜ ê¸°ë°˜ìœ¼ë¡œ ì‹œì‘ê°€ê²© ê³„ì‚°
                const calculatedStartPrice = await this.getStartingPriceForRegion(regionId);
                
                const newAuction = {
                    regionId: regionId,
                    regionName: regionData.name_ko || regionData.name || 'Unknown',
                    regionNameEn: regionData.name_en || regionData.name || 'Unknown',
                    country: regionData.country || 'Unknown',
                    status: 'active', // active, ended, sold
                    startPrice: calculatedStartPrice, // í”½ì…€ ìˆ˜ ê¸°ë°˜ ê³„ì‚°ëœ ì‹œì‘ê°€ê²©
                    currentBid: calculatedStartPrice,
                    highestBidder: null,
                    highestBidderId: null,
                    highestBidderEmail: null,
                    bidHistory: [],
                    startTime: now,
                    endTime: endTime,
                    originalEndTime: endTime, // ì›ë˜ ì¢…ë£Œ ì‹œê°„ (ì—°ì¥ ê³„ì‚°ìš©)
                    extended: false, // ì—°ì¥ ì—¬ë¶€
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    participantIds: [],
                    participantEmails: []
                };
                
                await setDoc(auctionRef, newAuction);
                this.activeAuctions.set(regionId, newAuction);
                this.startAuctionCountdown(regionId, newAuction);
                
                // Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
                await this.setupAuctionListener(regionId);
                
                console.log(`[ì˜¥ì…˜ ìƒì„±] ${regionId}: ì‹œì‘ê°€ê²© $${calculatedStartPrice.toFixed(2)} (í”½ì…€ ìˆ˜ ê¸°ë°˜), ì¢…ë£Œ ì‹œê°„ ${endTime.toDate()}`);
                return newAuction;
            }
        } catch (error) {
            console.error(`[ì˜¥ì…˜ ìƒì„± ì‹¤íŒ¨] ${regionId}:`, error);
            return null;
        }
    }
    
    /**
     * ì˜¥ì…˜ ì¡°íšŒ
     */
    async getAuction(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return null;
        }
        
        // ìºì‹œì—ì„œ ë¨¼ì € í™•ì¸
        if (this.activeAuctions.has(regionId)) {
            return this.activeAuctions.get(regionId);
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            const auctionSnap = await getDoc(auctionRef);
            
            if (auctionSnap.exists()) {
                const auctionData = auctionSnap.data();
                this.activeAuctions.set(regionId, auctionData);
                return auctionData;
            }
            return null;
        } catch (error) {
            console.error(`[ì˜¥ì…˜ ì¡°íšŒ ì‹¤íŒ¨] ${regionId}:`, error);
            return null;
        }
    }
    
    /**
     * ì…ì°° ì²˜ë¦¬
     * ê·œì¹™: ë§ˆì§€ë§‰ 5ë¶„ ë‚´ ì…ì°° ì‹œ ìë™ ì—°ì¥
     */
    async placeBid(regionId, bidAmount, bidderId, bidderEmail) {
        const numericBidAmount = Number(bidAmount);
        if (!Number.isFinite(numericBidAmount) || numericBidAmount <= 0) {
            this.showNotification('ìœ íš¨í•œ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return { success: false, message: 'ìœ íš¨í•œ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.' };
        }

        // ì…ì°° ì´ë²¤íŠ¸ ë¡œê¹…
        this.logEvent('bid_placed', {
            regionId,
            amount: numericBidAmount,
            bidderId,
            bidderEmail
        });
        
        // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê¸°ë¡ ì‹œì‘
        const startTime = performance.now();
        // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ë¡œê·¸ì¸ ì²´í¬
        if (!this.isAdminLoggedIn && (!this.isFirebaseInitialized || !this.firestore || !this.currentUser)) {
            this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            return { success: false, message: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.' };
        }
        
        try {
            const { doc, getDoc, updateDoc, serverTimestamp, Timestamp, runTransaction } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            const walletRef = doc(this.firestore, 'wallets', bidderId);
            
            // íŠ¸ëœì­ì…˜ìœ¼ë¡œ ë™ì‹œ ì…ì°° ì²˜ë¦¬
            const result = await runTransaction(this.firestore, async (transaction) => {
                const auctionSnap = await transaction.get(auctionRef);
                
                if (!auctionSnap.exists()) {
                    throw new Error('ì˜¥ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                }
                
                const auctionData = auctionSnap.data();
                
                // ì˜¥ì…˜ ìƒíƒœ í™•ì¸
                if (auctionData.status !== 'active') {
                    throw new Error('ì´ë¯¸ ì¢…ë£Œëœ ì˜¥ì…˜ì…ë‹ˆë‹¤.');
                }
                
                // ì¢…ë£Œ ì‹œê°„ í™•ì¸
                const now = Timestamp.now();
                const endTime = auctionData.endTime.toMillis();
                if (now.toMillis() >= endTime) {
                    throw new Error('ì˜¥ì…˜ì´ ì´ë¯¸ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                }
                
                // ì…ì°° ê¸ˆì•¡ ê²€ì¦
                const minBid = auctionData.currentBid + this.minBidIncrement;
                if (numericBidAmount < minBid) {
                    throw new Error(`ìµœì†Œ ì…ì°° ê¸ˆì•¡ì€ $${minBid.toFixed(2)}ì…ë‹ˆë‹¤.`);
                }

                const walletSnap = await transaction.get(walletRef);
                let walletData = walletSnap.exists() ? walletSnap.data() : null;
                if (!walletData) {
                    walletData = {
                        balance: 0,
                        holdBalance: 0,
                        holds: {}
                    };
                    transaction.set(walletRef, walletData, { merge: true });
                }

                const rawHolds = walletData.holds && typeof walletData.holds === 'object' ? walletData.holds : {};
                const currentHoldForRegion = Number(rawHolds[regionId] || 0);
                const walletBalance = Number(walletData.balance || 0);
                const walletHoldBalance = Number(walletData.holdBalance || 0);
                const availablePoints = walletBalance - walletHoldBalance + currentHoldForRegion;

                // ê´€ë¦¬ìëŠ” í¬ì¸íŠ¸ ì œí•œ ì—†ì´ ì…ì°° ê°€ëŠ¥ (ì‹¤ì œ ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
                if (!this.isAdminLoggedIn && availablePoints < numericBidAmount) {
                    throw new Error('í¬ì¸íŠ¸ ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì§€ê°‘ì„ ì¶©ì „í•´ì£¼ì„¸ìš”.');
                }

                const updatedHolds = { ...rawHolds, [regionId]: numericBidAmount };
                const updatedHoldBalance = Math.max(0, walletHoldBalance - currentHoldForRegion + numericBidAmount);

                transaction.set(walletRef, {
                    holds: updatedHolds,
                    holdBalance: updatedHoldBalance,
                    updatedAt: serverTimestamp()
                }, { merge: true });

                if (auctionData.highestBidderId && auctionData.highestBidderId !== bidderId) {
                    const previousWalletRef = doc(this.firestore, 'wallets', auctionData.highestBidderId);
                    const previousWalletSnap = await transaction.get(previousWalletRef);
                    if (previousWalletSnap.exists()) {
                        const previousWalletData = previousWalletSnap.data() || {};
                        const previousHolds = { ...(previousWalletData.holds || {}) };
                        const previousHoldAmount = Number(previousHolds[regionId] || 0);
                        if (previousHoldAmount > 0) {
                            delete previousHolds[regionId];
                            const newHoldBalance = Math.max(0, Number(previousWalletData.holdBalance || 0) - previousHoldAmount);
                            transaction.set(previousWalletRef, {
                                holds: previousHolds,
                                holdBalance: newHoldBalance,
                                updatedAt: serverTimestamp()
                            }, { merge: true });
                        }
                    }
                }
                
                // ì…ì°° ì´ë ¥ ì¶”ê°€
                const bidEntry = {
                    bidderId: bidderId,
                    bidderEmail: bidderEmail,
                    amount: numericBidAmount,
                    timestamp: now
                };
                
                const updatedBidHistory = [...(auctionData.bidHistory || []), bidEntry];

                const participantIds = new Set(Array.isArray(auctionData.participantIds) ? auctionData.participantIds : []);
                if (bidderId) {
                    participantIds.add(bidderId);
                }

                const participantEmails = new Set(Array.isArray(auctionData.participantEmails) ? auctionData.participantEmails : []);
                if (bidderEmail) {
                    participantEmails.add(bidderEmail);
                }
                
                // ë§ˆì§€ë§‰ 2ë¶„ ë‚´ ì…ì°° ì‹œ ìë™ ì—°ì¥ (anti-sniping)
                const timeRemaining = endTime - now.toMillis();
                const extensionWindow = 2 * 60 * 1000; // 2ë¶„
                const extensionDuration = 2 * 60 * 1000; // 2ë¶„ ì—°ì¥
                let newEndTime = auctionData.endTime;
                let extended = auctionData.extended;
                
                if (timeRemaining <= extensionWindow) {
                    // 2ë¶„ ì—°ì¥
                    newEndTime = Timestamp.fromMillis(endTime + extensionDuration);
                    extended = true;
                    console.log(`[ì˜¥ì…˜ ì—°ì¥] ${regionId}: 2ë¶„ ì—°ì¥ (anti-sniping), ìƒˆë¡œìš´ ì¢…ë£Œ ì‹œê°„ ${newEndTime.toDate()}`);
                }
                
                // ì˜¥ì…˜ ì—…ë°ì´íŠ¸
                transaction.update(auctionRef, {
                    currentBid: numericBidAmount,
                    highestBidder: bidderEmail,
                    highestBidderId: bidderId,
                    highestBidderEmail: bidderEmail,
                    bidHistory: updatedBidHistory,
                    endTime: newEndTime,
                    extended: extended,
                    updatedAt: serverTimestamp(),
                    participantIds: Array.from(participantIds),
                    participantEmails: Array.from(participantEmails)
                });
                
                return { success: true, extended: timeRemaining <= extensionWindow };
            });
            
            // ìºì‹œ ì—…ë°ì´íŠ¸
            const updatedAuction = await this.getAuction(regionId);
            if (updatedAuction) {
                this.activeAuctions.set(regionId, updatedAuction);
                this.startAuctionCountdown(regionId, updatedAuction);
            }
            
            // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê¸°ë¡
            const endTime = performance.now();
            this.recordPerformanceMetric('bidTime', endTime - startTime);
            
            if (result.extended) {
                this.showNotification('ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì˜¥ì…˜ì´ 2ë¶„ ì—°ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (anti-sniping)', 'success');
            } else {
                this.showNotification('ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }

            this.updateAuctionWalletSummary();

            if (this.isUserDashboardOpen()) {
                this.loadUserDashboardData(true);
            }
            
            return { success: true, message: 'ì…ì°°ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' };
        } catch (error) {
            console.error(`[ì…ì°° ì‹¤íŒ¨] ${regionId}:`, error);
            
            // ì‹¤íŒ¨ ì´ë²¤íŠ¸ë„ ë¡œê¹…
            this.logEvent('bid_failed', {
                regionId,
                amount: numericBidAmount,
                error: error.message
            });
            
            this.showNotification(error.message || 'ì…ì°°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: false, message: error.message || 'ì…ì°°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.' };
        }
    }
    
    /**
     * ì˜¥ì…˜ ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
     */
    startAuctionCountdown(regionId, auctionData) {
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
        if (this.auctionTimers.has(regionId)) {
            clearInterval(this.auctionTimers.get(regionId));
        }
        
        const updateCountdown = async () => {
            try {
                const { Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const now = Timestamp.now();
                const endTime = auctionData.endTime.toMillis();
                const remaining = endTime - now.toMillis();
                
                if (remaining <= 0) {
                    // ì˜¥ì…˜ ì¢…ë£Œ ì²˜ë¦¬
                    clearInterval(this.auctionTimers.get(regionId));
                    this.auctionTimers.delete(regionId);
                    await this.finalizeAuction(regionId);
                } else {
                    // UI ì—…ë°ì´íŠ¸ (ì˜¥ì…˜ ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°)
                    this.updateAuctionUI(regionId, remaining);
                }
            } catch (error) {
                console.error(`[ì¹´ìš´íŠ¸ë‹¤ìš´ ì˜¤ë¥˜] ${regionId}:`, error);
            }
        };
        
        // ì¦‰ì‹œ ì‹¤í–‰ í›„ 1ì´ˆë§ˆë‹¤ ì—…ë°ì´íŠ¸
        updateCountdown();
        const timerId = setInterval(updateCountdown, 1000);
        this.auctionTimers.set(regionId, timerId);
    }
    
    /**
     * ì˜¥ì…˜ UI ì—…ë°ì´íŠ¸ (ì¹´ìš´íŠ¸ë‹¤ìš´ í‘œì‹œ)
     */
    updateAuctionUI(regionId, remainingMs) {
        const hours = Math.floor(remainingMs / (1000 * 60 * 60));
        const minutes = Math.floor((remainingMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((remainingMs % (1000 * 60)) / 1000);
        
        const countdownElement = document.getElementById('auction-countdown');
        if (countdownElement) {
            countdownElement.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
    }
    
    /**
     * ì˜¥ì…˜ ìµœì¢… ë‚™ì°° ì²˜ë¦¬ (í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ - ì§€ê°‘ í™€ë“œ ê¸°ë°˜)
     * ê·œì¹™: 12ì‹œê°„ ì¢…ë£Œ ì‹œì ì— ìµœê³ ê°€ ìë™ ë‚™ì°° ë° ì§€ê°‘ í™€ë“œ ìë™ ì°¨ê°
     */
    async finalizeAuction(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { doc, getDoc, updateDoc, serverTimestamp, Timestamp, runTransaction } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            const auctionSnap = await getDoc(auctionRef);
            
            if (!auctionSnap.exists()) {
                return;
            }
            
            const auctionData = auctionSnap.data();
            
            if (auctionData.status !== 'active' && auctionData.status !== 'live') {
                return; // ì´ë¯¸ ì²˜ë¦¬ë¨
            }
            
            // ì…ì°° ì´ë ¥ì—ì„œ ìµœê³ ê°€ ë° ì°¨ìˆœìœ„ ê³„ì‚°
            const bidHistory = auctionData.bidHistory || [];
            if (bidHistory.length === 0) {
                // ì…ì°°ìê°€ ì—†ëŠ” ê²½ìš° ì˜¥ì…˜ ì¢…ë£Œ
                await updateDoc(auctionRef, {
                    status: 'cancelled',
                    finalizedAt: serverTimestamp(),
                    cancellationReason: 'no_bids'
                });
                console.log(`[ì˜¥ì…˜ ì¢…ë£Œ] ${regionId}: ì…ì°°ì ì—†ìŒ`);
                return;
            }
            
            // ì…ì°° ì´ë ¥ì„ ê¸ˆì•¡ ë‚´ë¦¼ì°¨ìˆœìœ¼ë¡œ ì •ë ¬
            const sortedBids = [...bidHistory]
                .filter(bid => Number(bid?.amount) > 0)
                .sort((a, b) => {
                    const amountDiff = Number(b.amount) - Number(a.amount);
                    if (amountDiff !== 0) return amountDiff;
                    const timeA = this.toMillis(b.timestamp) || 0;
                    const timeB = this.toMillis(a.timestamp) || 0;
                    return timeB - timeA;
                });
            
            const highestBid = sortedBids[0];
            const runnerUpBid = sortedBids[1] || null;
            const highestAmount = Number(highestBid.amount || auctionData.currentBid || 0);
            const highestBidderId = highestBid.bidderId || auctionData.highestBidderId;
            const highestBidderEmail = highestBid.bidderEmail || auctionData.highestBidderEmail;
            
            if (!highestBidderId) {
                await updateDoc(auctionRef, {
                    status: 'cancelled',
                    finalizedAt: serverTimestamp(),
                    cancellationReason: 'no_valid_bidder'
                });
                return;
            }
            
            // ì˜¥ì…˜ ìƒíƒœë¥¼ 'pending_payment'ë¡œ ë³€ê²½
            const now = Timestamp.now();
            const deadlineMillis = Date.now() + this.auctionPaymentGraceMs;
            await updateDoc(auctionRef, {
                status: 'pending_payment',
                paymentStatus: 'in_progress',
                finalizedAt: now,
                updatedAt: now,
                highestBid: highestAmount,
                highestBidderId,
                highestBidderEmail,
                secondBid: runnerUpBid ? Number(runnerUpBid.amount || 0) : null,
                secondBidderId: runnerUpBid?.bidderId || null,
                secondBidderEmail: runnerUpBid?.bidderEmail || null,
                pendingPaymentDeadline: Timestamp.fromMillis(deadlineMillis)
            });
            
            // ì§€ê°‘ í™€ë“œ ê¸°ë°˜ ìë™ ê²°ì œ ì‹œë„
            const chargeResult = await this.chargeWalletForAuction({
                bidderId: highestBidderId,
                regionId,
                amount: highestAmount
            });
            
            if (chargeResult.success) {
                // ê²°ì œ ì„±ê³µ: ì†Œìœ ê¶Œ ë¶€ì—¬
                await this.markAuctionSold(auctionRef, auctionData, {
                    bidderId: highestBidderId,
                    bidderEmail: highestBidderEmail,
                    amount: highestAmount
                });
                
                // íŒ¨ë°°ìë“¤ì˜ í™€ë“œ í•´ì œ
                await this.releaseLoserHolds(auctionData, highestBidderId, regionId);
                
                console.log(`[ì˜¥ì…˜ ë‚™ì°° ì™„ë£Œ] ${regionId}: ${highestBidderEmail} - $${highestAmount}`);
                this.showNotification(`${auctionData.regionName || regionId} ì˜¥ì…˜ì´ $${highestAmount}ì— ë‚™ì°°ë˜ì—ˆê³  ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
            } else {
                // ê²°ì œ ì‹¤íŒ¨: ì°¨ìˆœìœ„ë¡œ ì´ë™
                console.warn(`[ì˜¥ì…˜ ë‚™ì°°ì ê²°ì œ ì‹¤íŒ¨] ${regionId}:`, chargeResult);
                await this.moveToRunnerUp(auctionRef, auctionData, runnerUpBid, chargeResult.reason || 'insufficient_balance');
            }
            
            // ìºì‹œ ë° ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
            this.activeAuctions.delete(regionId);
            if (this.auctionListeners.has(regionId)) {
                this.auctionListeners.get(regionId)();
                this.auctionListeners.delete(regionId);
            }
        } catch (error) {
            console.error(`[ì˜¥ì…˜ ë‚™ì°° ì²˜ë¦¬ ì‹¤íŒ¨] ${regionId}:`, error);
        }
    }
    
    /**
     * Timestampë¥¼ ë°€ë¦¬ì´ˆë¡œ ë³€í™˜
     */
    toMillis(value) {
        if (!value) return null;
        if (typeof value.toMillis === 'function') return value.toMillis();
        if (typeof value.toDate === 'function') return value.toDate().getTime();
        if (value instanceof Date) return value.getTime();
        if (typeof value === 'number') return value;
        if (typeof value === 'object' && typeof value.seconds === 'number') {
            return value.seconds * 1000 + (value.nanoseconds || 0) / 1000000;
        }
        return null;
    }
    
    /**
     * ì§€ê°‘ í™€ë“œ ê¸°ë°˜ ì˜¥ì…˜ ê²°ì œ
     */
    async chargeWalletForAuction({ bidderId, regionId, amount }) {
        if (!bidderId || !regionId || !Number.isFinite(Number(amount))) {
            return { success: false, reason: 'invalid_parameters' };
        }
        
        try {
            const { doc, runTransaction, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const walletRef = doc(this.firestore, 'wallets', bidderId);
            
            const result = await runTransaction(this.firestore, async (transaction) => {
                const walletSnap = await transaction.get(walletRef);
                if (!walletSnap.exists()) {
                    return { success: false, reason: 'wallet_not_found' };
                }
                
                const walletData = walletSnap.data() || {};
                const holds = { ...(walletData.holds || {}) };
                const holdAmount = Number(holds[regionId] || 0);
                const balance = Number(walletData.balance || 0);
                const holdBalance = Number(walletData.holdBalance || 0);
                const numericAmount = Number(amount);
                
                // ê´€ë¦¬ìëŠ” í¬ì¸íŠ¸ ì œí•œ ì—†ì´ ê²°ì œ ê°€ëŠ¥ (ì‹¤ì œ ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
                const isAdmin = this.isAdminLoggedIn;
                if (!isAdmin) {
                    if (!holdAmount || holdAmount < numericAmount) {
                        return { success: false, reason: 'insufficient_hold' };
                    }
                    if (balance < numericAmount) {
                        return { success: false, reason: 'insufficient_balance' };
                    }
                }
                
                // í™€ë“œ í•´ì œ ë° ì”ì•¡ ì°¨ê°
                delete holds[regionId];
                const newBalance = balance - numericAmount;
                const newHoldBalance = Math.max(0, holdBalance - holdAmount);
                
                transaction.update(walletRef, {
                    balance: newBalance,
                    holdBalance: newHoldBalance,
                    holds,
                    updatedAt: serverTimestamp(),
                    lastPaymentAt: serverTimestamp()
                });
                
                return { success: true };
            });
            
            return result;
        } catch (error) {
            console.error('[chargeWalletForAuction] ê²°ì œ ì‹¤íŒ¨', { bidderId, regionId, error });
            return { success: false, reason: 'transaction_failed', error: error.message };
        }
    }
    
    /**
     * ì˜¥ì…˜ ë‚™ì°° ì™„ë£Œ ì²˜ë¦¬
     */
    async markAuctionSold(auctionRef, auctionData, winnerInfo) {
        const { updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const now = serverTimestamp();
        
        await updateDoc(auctionRef, {
            status: 'sold',
            paymentStatus: 'paid',
            soldAt: now,
            updatedAt: now,
            winnerId: winnerInfo.bidderId,
            winnerEmail: winnerInfo.bidderEmail || auctionData.highestBidderEmail,
            highestBid: Number(winnerInfo.amount || auctionData.highestBid || 0)
        });
        
        // ì§€ì—­ ì†Œìœ ê¶Œ ì—…ë°ì´íŠ¸
        await this.updateRegionOwnership(auctionRef.id, {
            ownerId: winnerInfo.bidderId,
            ownerEmail: winnerInfo.bidderEmail || auctionData.highestBidderEmail,
            purchasePrice: Number(winnerInfo.amount || auctionData.highestBid || 0),
            purchasedAt: now
        });
        
        // ì»¤ë®¤ë‹ˆí‹° í’€ ì—…ë°ì´íŠ¸
        await this.updateCommunityPoolContribution({
            ...auctionData,
            currentBid: Number(winnerInfo.amount || auctionData.highestBid || 0)
        });
    }
    
    /**
     * ì°¨ìˆœìœ„ë¡œ ì´ë™
     */
    async moveToRunnerUp(auctionRef, auctionData, runnerUpBid, failureReason) {
        const { updateDoc, serverTimestamp, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        
        // ìµœê³  ì…ì°°ìì˜ í™€ë“œ í•´ì œ
        if (auctionData.highestBidderId) {
            await this.releaseWalletHold(auctionData.highestBidderId, auctionRef.id);
        }
        
        if (!runnerUpBid || !runnerUpBid.bidderId) {
            // ì°¨ìˆœìœ„ê°€ ì—†ìœ¼ë©´ ì·¨ì†Œ
            await updateDoc(auctionRef, {
                status: 'cancelled',
                paymentStatus: 'failed',
                cancellationReason: failureReason || 'no_runner_up',
                updatedAt: serverTimestamp(),
                finalizedAt: auctionData.finalizedAt || serverTimestamp()
            });
            await this.releaseAllHolds(auctionData, auctionRef.id);
            return;
        }
        
        // ì°¨ìˆœìœ„ë¡œ ì´ë™
        const nowMillis = Date.now();
        await updateDoc(auctionRef, {
            status: 'pending_runner_up',
            paymentStatus: 'failed',
            paymentFailureReason: failureReason || 'winner_payment_failed',
            runnerUpDeadline: Timestamp.fromMillis(nowMillis + this.auctionRunnerUpGraceMs),
            runnerUpAttemptCount: 0,
            secondBid: Number(runnerUpBid.amount || auctionData.secondBid || 0),
            secondBidderId: runnerUpBid.bidderId,
            secondBidderEmail: runnerUpBid.bidderEmail || null,
            updatedAt: serverTimestamp()
        });
    }
    
    /**
     * ì§€ê°‘ í™€ë“œ í•´ì œ
     */
    async releaseWalletHold(bidderId, regionId) {
        if (!bidderId || !regionId) return;
        
        try {
            const { doc, runTransaction, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const walletRef = doc(this.firestore, 'wallets', bidderId);
            
            await runTransaction(this.firestore, async (transaction) => {
                const walletSnap = await transaction.get(walletRef);
                if (!walletSnap.exists()) return;
                
                const walletData = walletSnap.data() || {};
                const holds = { ...(walletData.holds || {}) };
                const holdAmount = Number(holds[regionId] || 0);
                if (!holdAmount) return;
                
                delete holds[regionId];
                const currentHoldBalance = Number(walletData.holdBalance || 0);
                const newHoldBalance = Math.max(0, currentHoldBalance - holdAmount);
                
                transaction.update(walletRef, {
                    holds,
                    holdBalance: newHoldBalance,
                    updatedAt: serverTimestamp()
                });
            });
        } catch (error) {
            console.error('[releaseWalletHold] ì‹¤íŒ¨', { bidderId, regionId, error });
        }
    }
    
    /**
     * íŒ¨ë°°ìë“¤ì˜ í™€ë“œ í•´ì œ
     */
    async releaseLoserHolds(auctionData, winnerId, regionId) {
        const participantIds = new Set(Array.isArray(auctionData.participantIds) ? auctionData.participantIds : []);
        (auctionData.bidHistory || []).forEach(bid => {
            if (bid?.bidderId) participantIds.add(bid.bidderId);
        });
        
        for (const participantId of participantIds) {
            if (participantId === winnerId) continue;
            await this.releaseWalletHold(participantId, regionId);
        }
    }
    
    /**
     * ëª¨ë“  í™€ë“œ í•´ì œ
     */
    async releaseAllHolds(auctionData, regionId) {
        const participantIds = new Set(Array.isArray(auctionData.participantIds) ? auctionData.participantIds : []);
        (auctionData.bidHistory || []).forEach(bid => {
            if (bid?.bidderId) participantIds.add(bid.bidderId);
        });
        
        for (const participantId of participantIds) {
            await this.releaseWalletHold(participantId, regionId);
        }
    }
    
    /**
     * ì§€ì—­ IDë¡œ ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
     */
    async getRegionById(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return null;
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionRef = doc(this.firestore, 'regions', regionId);
            const regionSnap = await getDoc(regionRef);
            
            if (regionSnap.exists()) {
                const regionData = regionSnap.data();
                return {
                    id: regionId,
                    ...regionData
                };
            }
            
            // Firestoreì— ì—†ìœ¼ë©´ ì˜¥ì…˜ ë°ì´í„°ì—ì„œ ì§€ì—­ ì •ë³´ ì¶”ì¶œ
            const { doc: auctionDoc, getDoc: getAuctionDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = auctionDoc(this.firestore, 'auctions', regionId);
            const auctionSnap = await getAuctionDoc(auctionRef);
            
            if (auctionSnap.exists()) {
                const auctionData = auctionSnap.data();
                return {
                    id: regionId,
                    name_ko: auctionData.regionName,
                    name_en: auctionData.regionNameEn || auctionData.regionName,
                    country: auctionData.country || 'Unknown',
                    ad_price: auctionData.currentBid || 1000,
                    ad_status: 'available'
                };
            }
            
            return null;
        } catch (error) {
            console.error(`[ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨] ${regionId}:`, error);
            return null;
        }
    }
    
    /**
     * ì˜¥ì…˜ ë‚™ì°° í›„ ìë™ ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘
     * ë‚™ì°°ìì—ê²Œ ê²°ì œ ì•Œë¦¼ì„ ë³´ë‚´ê³  ê²°ì œ ëª¨ë‹¬ì„ ìë™ìœ¼ë¡œ í‘œì‹œ
     */
    async initiateAuctionPayment(regionId, auctionData) {
        try {
            // ë‚™ì°°ìê°€ í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ìì¸ì§€ í™•ì¸
            if (this.currentUser && this.currentUser.uid === auctionData.highestBidderId) {
                // í˜„ì¬ ì‚¬ìš©ìê°€ ë‚™ì°°ìì¸ ê²½ìš° ìë™ìœ¼ë¡œ ê²°ì œ ëª¨ë‹¬ í‘œì‹œ
                const region = await this.getRegionById(regionId);
                if (region) {
                    // ê²°ì œ ëª¨ë‹¬ í‘œì‹œ
                    this.showAuctionPaymentModal(region, auctionData);
                    return { success: true, orderId: null, requiresUserAction: true };
                }
            }
            
            // ë‚™ì°°ìê°€ ë‹¤ë¥¸ ì‚¬ìš©ìì¸ ê²½ìš° ì´ë©”ì¼ ì•Œë¦¼ (í–¥í›„ êµ¬í˜„)
            // í˜„ì¬ëŠ” ê²°ì œ ëŒ€ê¸° ìƒíƒœë¡œ ìœ ì§€
            return { success: false, error: 'ë‚™ì°°ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê²°ì œë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.', requiresUserAction: true };
        } catch (error) {
            console.error(`[ê²°ì œ í”„ë¡œì„¸ìŠ¤ ì‹œì‘ ì‹¤íŒ¨] ${regionId}:`, error);
            return { success: false, error: error.message };
        }
    }
    
    /**
     * ì˜¥ì…˜ ê²°ì œ ëª¨ë‹¬ í‘œì‹œ
     */
    showAuctionPaymentModal(region, auctionData) {
        // ê¸°ì¡´ ëª¨ë‹¬ì´ ìˆìœ¼ë©´ ë‹«ê¸°
        const existingModal = document.getElementById('auction-payment-modal');
        if (existingModal) {
            existingModal.remove();
        }
        
        // ê²°ì œ ëª¨ë‹¬ ìƒì„±
        const modal = document.createElement('div');
        modal.id = 'auction-payment-modal';
        modal.className = 'modal';
        
        const regionName = this.sanitizeHTML(this.getRegionDisplayName(region) || auctionData.regionName || '');
        const amount = auctionData.currentBid || 0;
        
        modal.innerHTML = `
            <div class="modal-content auction-payment-modal">
                <div class="modal-header">
                    <h2>
                        <span class="label-primary">ì˜¥ì…˜ ë‚™ì°° - ê²°ì œ í•„ìš”</span>
                        <span class="label-secondary">Auction Won - Payment Required</span>
                    </h2>
                    <button class="close-btn" id="close-auction-payment-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="payment-info">
                        <h3>ì¶•í•˜í•©ë‹ˆë‹¤! ì˜¥ì…˜ì—ì„œ ë‚™ì°°ë˜ì—ˆìŠµë‹ˆë‹¤.</h3>
                        <p><strong>ì§€ì—­:</strong> ${regionName}</p>
                        <p><strong>ë‚™ì°°ê°€:</strong> $${amount.toFixed(2)}</p>
                        <p class="payment-deadline">âš ï¸ 24ì‹œê°„ ë‚´ ê²°ì œë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”. ê²°ì œí•˜ì§€ ì•Šìœ¼ë©´ ë‚™ì°°ì´ ì·¨ì†Œë©ë‹ˆë‹¤.</p>
                    </div>
                    <div id="auction-payment-paypal-buttons" style="margin-top: 20px;"></div>
                    <div id="auction-payment-status" style="margin-top: 15px;"></div>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        modal.classList.remove('hidden');
        
        // ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        const closeBtn = modal.querySelector('#close-auction-payment-modal');
        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            setTimeout(() => modal.remove(), 300);
        });
        
        // PayPal ë²„íŠ¼ ë Œë”ë§ (ë‚™ì°°ê°€ë¡œ ì„¤ì •)
        const tempRegion = { ...region, ad_price: amount };
        this.renderAuctionPaymentButtons('auction-payment-paypal-buttons', tempRegion, auctionData);
    }
    
    /**
     * ì˜¥ì…˜ ê²°ì œìš© PayPal ë²„íŠ¼ ë Œë”ë§
     */
    renderAuctionPaymentButtons(containerId, region, auctionData) {
        try {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            // ë¹„ì–´ìˆê²Œ ì´ˆê¸°í™”
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            if (!(window.paypal && window.paypal.Buttons)) {
                this.showNotification('ê²°ì œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const amount = auctionData.currentBid || region.ad_price || 1000;
            const description = `ì˜¥ì…˜ ë‚™ì°°: ${this.getRegionDisplayName(region)} (${region.id})`;
            
            window.paypal.Buttons({
                style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: description,
                            amount: {
                                currency_code: 'USD',
                                value: String(amount)
                            }
                        }]
                    });
                },
                onApprove: async (data, actions) => {
                    try {
                        const details = await actions.order.capture();
                        
                        // ê²°ì œ ì„±ê³µ ì²˜ë¦¬
                        const buyerEmail = details.payer?.email_address || details.payer?.payer_info?.email || auctionData.highestBidderEmail;
                        const orderId = details.id;
                        
                        // Firestoreì— êµ¬ë§¤ ê¸°ë¡ ì €ì¥
                        await this.savePurchaseToFirestore(
                            region.id,
                            this.getRegionDisplayName(region),
                            orderId,
                            buyerEmail,
                            amount
                        );
                        
                        // ì˜¥ì…˜ ìƒíƒœë¥¼ 'sold'ë¡œ ì—…ë°ì´íŠ¸
                        const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                        const auctionRef = doc(this.firestore, 'auctions', region.id);
                        await updateDoc(auctionRef, {
                            status: 'sold',
                            paymentCompleted: true,
                            paypalOrderId: orderId,
                            paymentCompletedAt: serverTimestamp()
                        });
                        
                        // ì§€ì—­ ì†Œìœ ê¶Œ ì—…ë°ì´íŠ¸
                        await this.updateRegionOwnership(region.id, {
                            ownerId: auctionData.highestBidderId,
                            ownerEmail: buyerEmail,
                            purchasePrice: amount,
                            purchasedAt: serverTimestamp(),
                            paypalOrderId: orderId
                        });
                        
                        // ì»¤ë®¤ë‹ˆí‹° ìƒê¸ˆ/ë¬´ë£Œ í”½ì…€ í’€ ì—…ë°ì´íŠ¸
                        await this.updateCommunityPoolContribution(auctionData);
                        
                        // ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                        const statusDiv = document.getElementById('auction-payment-status');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #2ecc71; font-weight: 600;">âœ… ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì†Œìœ ê¶Œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                        }
                        
                        // PayPal ë²„íŠ¼ ì œê±°
                        container.innerHTML = '';
                        
                        // ëª¨ë‹¬ ìë™ ë‹«ê¸° (3ì´ˆ í›„)
                        setTimeout(() => {
                            const modal = document.getElementById('auction-payment-modal');
                            if (modal) {
                                modal.classList.add('hidden');
                                setTimeout(() => modal.remove(), 300);
                            }
                        }, 3000);
                        
                        this.showNotification('ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì§€ì—­ ì†Œìœ ê¶Œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        
                        // ì§€ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
                        region.ad_status = 'occupied';
                        this.updateRegionStatus(region.id, true);
                        this.updateStatistics();
                        
                    } catch (err) {
                        console.error('ê²°ì œ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                        this.showNotification('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                        const statusDiv = document.getElementById('auction-payment-status');
                        if (statusDiv) {
                            statusDiv.innerHTML = '<div style="color: #e74c3c; font-weight: 600;">âŒ ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</div>';
                        }
                    }
                },
                onCancel: () => {
                    this.showNotification('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. 24ì‹œê°„ ë‚´ ê²°ì œë¥¼ ì™„ë£Œí•´ì£¼ì„¸ìš”.', 'warning');
                },
                onError: (err) => {
                    console.error('PayPal ì˜¤ë¥˜:', err);
                    this.showNotification('ê²°ì œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }).render(`#${containerId}`);
        } catch (e) {
            console.error('ê²°ì œ ë²„íŠ¼ ë Œë”ë§ ì˜¤ë¥˜:', e);
            this.showNotification('ê²°ì œ ë²„íŠ¼ ë Œë”ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    /**
     * ì˜¥ì…˜ ìƒíƒœ ë¡¤ë°± (ê²°ì œ ì‹¤íŒ¨ ì‹œ)
     */
    async rollbackAuction(regionId, auctionData, errorMessage) {
        try {
            const { doc, updateDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            
            // ì˜¥ì…˜ ìƒíƒœë¥¼ 'ended'ë¡œ ë³€ê²½í•˜ê³  ë‹¤ìŒ ì…ì°°ìì—ê²Œ ì¬ì˜¥ì…˜ ë˜ëŠ” ì˜¥ì…˜ ì¢…ë£Œ
            await updateDoc(auctionRef, {
                status: 'ended',
                rollbackReason: errorMessage || 'ê²°ì œ ì‹¤íŒ¨',
                rollbackAt: serverTimestamp()
            });
            
            console.log(`[ì˜¥ì…˜ ë¡¤ë°±] ${regionId}: ê²°ì œ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¡¤ë°±`);
            this.showNotification(`${auctionData.regionName} ì˜¥ì…˜ì˜ ê²°ì œê°€ ì‹¤íŒ¨í•˜ì—¬ ë‚™ì°°ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'error');
            
            // ë‚™ì°°ìì—ê²Œ ì•Œë¦¼ (í–¥í›„ ì´ë©”ì¼ ì•Œë¦¼ êµ¬í˜„)
            // í˜„ì¬ëŠ” ì½˜ì†” ë¡œê·¸ë§Œ
        } catch (error) {
            console.error(`[ë¡¤ë°± ì‹¤íŒ¨] ${regionId}:`, error);
        }
    }
    
    /**
     * ì§€ì—­ ì†Œìœ ê¶Œ ì—…ë°ì´íŠ¸
     */
    async updateRegionOwnership(regionId, ownershipData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionRef = doc(this.firestore, 'regions', regionId);
            
            await setDoc(regionRef, {
                ...ownershipData,
                ad_status: 'occupied',
                updatedAt: serverTimestamp()
            }, { merge: true });
        } catch (error) {
            console.error(`[ì†Œìœ ê¶Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨] ${regionId}:`, error);
        }
    }
    
    /**
     * Firestore ì‹¤ì‹œê°„ ì˜¥ì…˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    async setupAuctionListener(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        // ë¦¬ìŠ¤ë„ˆ ìˆ˜ ì œí•œ (ë©”ëª¨ë¦¬ ìµœì í™”)
        const maxListeners = 50;
        if (this.auctionListeners.size >= maxListeners) {
            // ê°€ì¥ ì˜¤ë˜ëœ ë¦¬ìŠ¤ë„ˆ ì œê±°
            const firstKey = this.auctionListeners.keys().next().value;
            if (firstKey) {
                this.auctionListeners.get(firstKey)();
                this.auctionListeners.delete(firstKey);
                this.activeAuctions.delete(firstKey);
            }
        }
        
        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        if (this.auctionListeners.has(regionId)) {
            this.auctionListeners.get(regionId)();
        }
        
        try {
            const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            
            const unsubscribe = onSnapshot(auctionRef, (snapshot) => {
                if (snapshot.exists()) {
                    const auctionData = snapshot.data();
                    this.activeAuctions.set(regionId, auctionData);
                    
                    // ì¹´ìš´íŠ¸ë‹¤ìš´ ì¬ì‹œì‘
                    this.startAuctionCountdown(regionId, auctionData);
                    
                    // UI ì—…ë°ì´íŠ¸ (ì˜¥ì…˜ ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš°)
                    this.refreshAuctionModal(regionId, auctionData);
                }
            }, (error) => {
                console.error(`[ì˜¥ì…˜ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜] ${regionId}:`, error);
            });
            
            this.auctionListeners.set(regionId, unsubscribe);
        } catch (error) {
            console.error(`[ì˜¥ì…˜ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨] ${regionId}:`, error);
        }
    }
    
    /**
     * ì˜¥ì…˜ ëª¨ë‹¬ ìƒˆë¡œê³ ì¹¨
     */
    refreshAuctionModal(regionId, auctionData) {
        // ì˜¥ì…˜ ëª¨ë‹¬ì´ ì—´ë ¤ìˆëŠ” ê²½ìš° UI ì—…ë°ì´íŠ¸
        const modal = document.getElementById('auction-modal');
        if (modal && !modal.classList.contains('hidden')) {
            // í˜„ì¬ ì§€ì—­ì´ ì˜¥ì…˜ ì§€ì—­ê³¼ ì¼ì¹˜í•˜ëŠ” ê²½ìš°ì—ë§Œ ì—…ë°ì´íŠ¸
            if (this.currentRegion && this.currentRegion.id === regionId) {
                // ì˜¥ì…˜ ì •ë³´ í‘œì‹œ ì—…ë°ì´íŠ¸
                const currentBidElement = document.getElementById('auction-current-bid');
                if (currentBidElement) {
                    currentBidElement.textContent = `$${auctionData.currentBid.toFixed(2)}`;
                }
                
                const bidHistoryElement = document.getElementById('auction-bid-history');
                if (bidHistoryElement && auctionData.bidHistory) {
                    this.renderBidHistory(bidHistoryElement, auctionData.bidHistory);
                }

                this.updateAuctionActionState(auctionData);
            }
        }
    }
    
    /**
     * ì…ì°° ì´ë ¥ ë Œë”ë§
     */
    renderBidHistory(container, bidHistory) {
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        
        if (!bidHistory || bidHistory.length === 0) {
            const p = document.createElement('p');
            p.textContent = 'ì•„ì§ ì…ì°°ì´ ì—†ìŠµë‹ˆë‹¤.';
            container.appendChild(p);
            return;
        }
        
        // ìµœì‹  ì…ì°°ë¶€í„° í‘œì‹œ
        const sortedHistory = [...bidHistory].sort((a, b) => {
            return b.timestamp.toMillis() - a.timestamp.toMillis();
        });
        
        sortedHistory.forEach((bid, index) => {
            const entry = document.createElement('div');
            entry.className = `bid-entry ${index === 0 ? 'latest' : ''}`;
            
            const amount = document.createElement('span');
            amount.className = 'bid-amount';
            amount.textContent = `$${bid.amount.toFixed(2)}`;
            
            const bidder = document.createElement('span');
            bidder.className = 'bid-bidder';
            bidder.textContent = this.sanitizeHTML(bid.bidderEmail || '-');
            
            const time = document.createElement('span');
            time.className = 'bid-time';
            const date = bid.timestamp.toDate();
            time.textContent = date.toLocaleString('ko-KR');
            
            entry.appendChild(amount);
            entry.appendChild(bidder);
            entry.appendChild(time);
            container.appendChild(entry);
        });
    }

    getAuctionStatusMeta(auctionData = {}) {
        const status = (auctionData.status || 'active').toLowerCase();
        const currentUserId = this.currentUser?.uid;
        const isMyHighest = Boolean(currentUserId && auctionData.highestBidderId === currentUserId);
        const isRunnerUp = Boolean(currentUserId && auctionData.secondBidderId === currentUserId);
        const formatDeadline = (timestamp) => {
            if (!timestamp) {
                return null;
            }
            try {
                if (typeof timestamp.toMillis === 'function') {
                    return timestamp.toMillis();
                }
                if (typeof timestamp === 'number') {
                    return timestamp;
                }
                if (typeof timestamp === 'object') {
                    if (typeof timestamp.seconds === 'number') {
                        return timestamp.seconds * 1000;
                    }
                    if (typeof timestamp._seconds === 'number') {
                        return timestamp._seconds * 1000;
                    }
                }
            } catch (error) {
                console.warn('[ì˜¥ì…˜ ìƒíƒœ í¬ë§· ì‹¤íŒ¨]', error);
            }
            return null;
        };
        const deadlineToLabel = (label, timestamp) => {
            const millis = formatDeadline(timestamp);
            if (!millis) {
                return null;
            }
            const formatted = new Date(millis).toLocaleString('ko-KR', {
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
            return `${label}: ${formatted}`;
        };
        const meta = {
            statusKey: status,
            statusLabel: 'ì§„í–‰ ì¤‘',
            statusClass: 'status-live',
            message: 'ì˜¥ì…˜ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.',
            subtext: '',
            showBidForm: status === 'active' || status === 'live',
            showPayButton: false,
            payButtonText: 'ì§€ê¸ˆ ê²°ì œí•˜ê¸°'
        };
        switch (status) {
            case 'pending_payment':
                meta.showBidForm = false;
                meta.statusLabel = 'ê²°ì œ ëŒ€ê¸°';
                meta.statusClass = 'status-pending';
                if (isMyHighest) {
                    meta.message = 'ìë™ ê²°ì œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ê²°ì œ ê¸°í•œ ë‚´ ì™„ë£Œë˜ì§€ ì•Šìœ¼ë©´ ì°¨ìˆœìœ„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.';
                    meta.subtext = deadlineToLabel('ê²°ì œ ê¸°í•œ', auctionData.pendingPaymentDeadline || auctionData.paymentDeadline) || '';
                    meta.showPayButton = true;
                    meta.payButtonText = 'ì§€ê¸ˆ ê²°ì œí•˜ê¸°';
                } else if (isRunnerUp) {
                    meta.message = 'ì°¨ìˆœìœ„ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤. ì„ ë‘ ê²°ì œê°€ ì‹¤íŒ¨í•˜ë©´ ìë™ìœ¼ë¡œ ê²°ì œ ì ˆì°¨ê°€ ì§„í–‰ë©ë‹ˆë‹¤.';
                    meta.subtext = 'ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì§€ê°‘ ì”ì•¡ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                } else {
                    meta.message = 'ê²°ì œ ì ˆì°¨ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
                }
                break;
            case 'pending_runner_up':
                meta.showBidForm = false;
                meta.statusLabel = 'ì°¨ìˆœìœ„ ê²°ì œ';
                meta.statusClass = 'status-runner';
                if (isRunnerUp) {
                    meta.message = 'ì°¨ìˆœìœ„ ìë™ ê²°ì œê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤. í•„ìš”í•˜ë‹¤ë©´ ì§€ê¸ˆ ê²°ì œë¥¼ ì™„ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.';
                    meta.subtext = deadlineToLabel('ì°¨ìˆœìœ„ ê²°ì œ ê¸°í•œ', auctionData.runnerUpDeadline) || '';
                    meta.showPayButton = true;
                    meta.payButtonText = 'ì°¨ìˆœìœ„ ê²°ì œ ì§„í–‰';
                } else {
                    meta.message = 'ì°¨ìˆœìœ„ ê²°ì œ ì ˆì°¨ê°€ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.';
                }
                break;
            case 'sold':
                meta.showBidForm = false;
                meta.statusLabel = 'ë‚™ì°° ì™„ë£Œ';
                meta.statusClass = 'status-sold';
                meta.message = isMyHighest
                    ? 'ì¶•í•˜í•©ë‹ˆë‹¤! ê²°ì œê¹Œì§€ ì™„ë£Œë˜ì–´ ì†Œìœ ê¶Œì´ ë¶€ì—¬ë˜ì—ˆìŠµë‹ˆë‹¤.'
                    : 'ì´ë¯¸ ë‚™ì°°ì´ ì™„ë£Œëœ ì˜¥ì…˜ì…ë‹ˆë‹¤.';
                break;
            case 'cancelled':
                meta.showBidForm = false;
                meta.statusLabel = 'ì·¨ì†Œë¨';
                meta.statusClass = 'status-cancelled';
                meta.message = 'ì˜¥ì…˜ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ë¼ìš´ë“œë¥¼ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
                break;
            case 'ended':
                meta.showBidForm = false;
                meta.statusLabel = 'ì¢…ë£Œ';
                meta.statusClass = 'status-cancelled';
                meta.message = 'ì˜¥ì…˜ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”í›„ ê³µì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.';
                break;
            case 'scheduled':
            case 'draft':
                meta.showBidForm = false;
                meta.statusLabel = 'ì˜¤í”ˆ ì˜ˆì •';
                meta.statusClass = 'status-live';
                meta.message = 'ê³§ ì˜¥ì…˜ì´ ì‹œì‘ë©ë‹ˆë‹¤. ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.';
                break;
            default:
                meta.showBidForm = true;
                meta.statusLabel = 'ì§„í–‰ ì¤‘';
                meta.statusClass = 'status-live';
                meta.message = 'ì˜¥ì…˜ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.';
                break;
        }
        return meta;
    }

    updateAuctionActionState(auctionData = {}) {
        const bidSection = document.getElementById('auction-bid-section');
        const statusPanel = document.getElementById('auction-status-panel');
        const statusChip = document.getElementById('auction-status-chip');
        const statusMessage = document.getElementById('auction-status-message');
        const statusSubtext = document.getElementById('auction-status-subtext');
        const payNowBtn = document.getElementById('auction-pay-now-btn');
        if (!bidSection || !statusPanel) {
            return;
        }
        const meta = this.getAuctionStatusMeta(auctionData);
        if (meta.showBidForm) {
            bidSection.classList.remove('hidden');
            statusPanel.classList.add('hidden');
            if (payNowBtn) {
                payNowBtn.classList.add('hidden');
            }
            return;
        }
        bidSection.classList.add('hidden');
        statusPanel.classList.remove('hidden');
        if (statusChip) {
            statusChip.textContent = meta.statusLabel;
            statusChip.className = `auction-status-chip ${meta.statusClass}`;
        }
        if (statusMessage) {
            statusMessage.textContent = meta.message || '';
        }
        if (statusSubtext) {
            if (meta.subtext) {
                statusSubtext.textContent = meta.subtext;
                statusSubtext.classList.remove('hidden');
            } else {
                statusSubtext.textContent = '';
                statusSubtext.classList.add('hidden');
            }
        }
        if (payNowBtn) {
            if (meta.showPayButton) {
                payNowBtn.textContent = meta.payButtonText || 'ì§€ê¸ˆ ê²°ì œí•˜ê¸°';
                payNowBtn.classList.remove('hidden');
                payNowBtn.disabled = false;
            } else {
                payNowBtn.classList.add('hidden');
            }
        }
    }

    async handleAuctionPayNowClick() {
        if (!this.currentRegion) {
            this.showNotification('ì§€ì—­ ì •ë³´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }
        const regionId = this.currentRegion.id;
        let auction = this.activeAuctions.get(regionId);
        if (!auction) {
            auction = await this.getAuction(regionId);
        }
        if (!auction) {
            this.showNotification('ì˜¥ì…˜ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        const isRunnerUp = Boolean(this.currentUser && auction.secondBidderId === this.currentUser.uid);
        const paymentPayload = { ...auction };
        if (isRunnerUp && auction.secondBid) {
            paymentPayload.currentBid = Number(auction.secondBid);
        } else if (auction.highestBid) {
            paymentPayload.currentBid = Number(auction.highestBid);
        }
        this.showAuctionPaymentModal(this.currentRegion, paymentPayload);
    }

    getDefaultCommunityPoolData() {
        return {
            rewardFund: 0,
            totalAuctions: 0,
            freePixelPool: 0,
            lastContributionAt: null,
            lastDistributionAt: null,
            recentContribution: 0,
            recentAuctionRegion: null
        };
    }

    async subscribeToCommunityPool() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }

        if (this.communityPoolListener) {
            return;
        }

        try {
            const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const poolRef = doc(this.firestore, 'communityPools', 'global');
            this.communityPoolListener = onSnapshot(poolRef, (snapshot) => {
                if (snapshot.exists()) {
                    this.communityPoolData = {
                        ...this.getDefaultCommunityPoolData(),
                        ...snapshot.data()
                    };
                } else {
                    this.communityPoolData = this.getDefaultCommunityPoolData();
                }
                this.updateCommunityRewardUI(this.communityPoolData);
            }, (error) => {
                console.error('ì»¤ë®¤ë‹ˆí‹° í’€ ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜:', error);
            });
        } catch (error) {
            console.error('ì»¤ë®¤ë‹ˆí‹° í’€ êµ¬ë… ì‹¤íŒ¨:', error);
        }
    }
    
    /**
     * í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²½ë§¤ ìë™í™” ì¡ ì‹œì‘
     * pending_payment, pending_runner_up ìƒíƒœ ì˜¥ì…˜ì„ ì£¼ê¸°ì ìœ¼ë¡œ ì²´í¬
     */
    startAuctionAutomationJob() {
        if (this.auctionCheckInterval) {
            return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘
        }
        
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('[ê²½ë§¤ ìë™í™”] Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì¡ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ì¦‰ì‹œ í•œ ë²ˆ ì‹¤í–‰
        this.checkPendingAuctions();
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰
        this.auctionCheckInterval = setInterval(() => {
            this.checkPendingAuctions();
        }, this.auctionCheckIntervalMs);
        
        console.log('[ê²½ë§¤ ìë™í™”] í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ì¡ ì‹œì‘');
    }
    
    /**
     * pending ìƒíƒœ ì˜¥ì…˜ ì²´í¬ ë° ì²˜ë¦¬
     */
    async checkPendingAuctions() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { collection, query, where, getDocs, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionsRef = collection(this.firestore, 'auctions');
            
            // pending_payment ìƒíƒœ ì˜¥ì…˜ ì²´í¬
            const pendingPaymentQuery = query(
                auctionsRef,
                where('status', '==', 'pending_payment')
            );
            const pendingPaymentSnap = await getDocs(pendingPaymentQuery);
            
            for (const docSnap of pendingPaymentSnap.docs) {
                try {
                    await this.processPendingPaymentAuction(docSnap);
                } catch (error) {
                    console.error(`[ê²½ë§¤ ìë™í™”] pending_payment ì²˜ë¦¬ ì‹¤íŒ¨: ${docSnap.id}`, error);
                }
            }
            
            // pending_runner_up ìƒíƒœ ì˜¥ì…˜ ì²´í¬
            const runnerUpQuery = query(
                auctionsRef,
                where('status', '==', 'pending_runner_up')
            );
            const runnerUpSnap = await getDocs(runnerUpQuery);
            
            for (const docSnap of runnerUpSnap.docs) {
                try {
                    await this.processPendingRunnerUpAuction(docSnap);
                } catch (error) {
                    console.error(`[ê²½ë§¤ ìë™í™”] pending_runner_up ì²˜ë¦¬ ì‹¤íŒ¨: ${docSnap.id}`, error);
                }
            }
        } catch (error) {
            console.error('[ê²½ë§¤ ìë™í™”] ì²´í¬ ì‹¤íŒ¨', error);
        }
    }
    
    /**
     * pending_payment ìƒíƒœ ì˜¥ì…˜ ì²˜ë¦¬
     */
    async processPendingPaymentAuction(auctionSnap) {
        const { updateDoc, serverTimestamp, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const auctionData = auctionSnap.data() || {};
        
        // ì´ë¯¸ ê²°ì œ ì™„ë£Œëœ ê²½ìš°
        if (auctionData.paymentStatus === 'paid') {
            await this.markAuctionSold(auctionSnap.ref, auctionData, {
                bidderId: auctionData.highestBidderId,
                bidderEmail: auctionData.highestBidderEmail,
                amount: auctionData.highestBid
            });
            return;
        }
        
        // ë°ë“œë¼ì¸ ì²´í¬
        const deadline = auctionData.pendingPaymentDeadline || auctionData.paymentDeadline;
        const deadlineMillis = this.toMillis(deadline);
        if (!deadlineMillis || deadlineMillis > Date.now()) {
            return; // ì•„ì§ ì‹œê°„ ë‚¨ìŒ
        }
        
        // ë°ë“œë¼ì¸ ì´ˆê³¼: ì°¨ìˆœìœ„ë¡œ ì´ë™
        const runnerUpBid = auctionData.secondBidderId ? {
            bidderId: auctionData.secondBidderId,
            bidderEmail: auctionData.secondBidderEmail,
            amount: auctionData.secondBid
        } : null;
        
        await this.moveToRunnerUp(auctionSnap.ref, auctionData, runnerUpBid, 'payment_deadline_expired');
    }
    
    /**
     * pending_runner_up ìƒíƒœ ì˜¥ì…˜ ì²˜ë¦¬
     */
    async processPendingRunnerUpAuction(auctionSnap) {
        const { updateDoc, serverTimestamp, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const auctionData = auctionSnap.data() || {};
        
        // ì´ë¯¸ ê²°ì œ ì™„ë£Œëœ ê²½ìš°
        if (auctionData.paymentStatus === 'runner_up_paid') {
            await this.markAuctionSold(auctionSnap.ref, auctionData, {
                bidderId: auctionData.secondBidderId,
                bidderEmail: auctionData.secondBidderEmail,
                amount: auctionData.secondBid
            }, 'runner_up');
            return;
        }
        
        // ë°ë“œë¼ì¸ ì²´í¬
        const deadline = auctionData.runnerUpDeadline;
        const deadlineMillis = this.toMillis(deadline);
        if (deadlineMillis && deadlineMillis <= Date.now()) {
            // ë°ë“œë¼ì¸ ì´ˆê³¼: ì·¨ì†Œ
            await this.releaseWalletHold(auctionData.secondBidderId, auctionSnap.id);
            await updateDoc(auctionSnap.ref, {
                status: 'cancelled',
                paymentStatus: 'failed',
                cancellationReason: 'runner_up_deadline_expired',
                updatedAt: serverTimestamp()
            });
            await this.releaseAllHolds(auctionData, auctionSnap.id);
            return;
        }
        
        // ìµœëŒ€ ì‹œë„ íšŸìˆ˜ ì²´í¬
        const attempts = Number(auctionData.runnerUpAttemptCount || 0);
        if (attempts >= this.runnerUpMaxAttempts) {
            await this.releaseWalletHold(auctionData.secondBidderId, auctionSnap.id);
            await updateDoc(auctionSnap.ref, {
                status: 'cancelled',
                paymentStatus: 'failed',
                cancellationReason: 'runner_up_max_attempt',
                updatedAt: serverTimestamp()
            });
            await this.releaseAllHolds(auctionData, auctionSnap.id);
            return;
        }
        
        // ì°¨ìˆœìœ„ ìë™ ê²°ì œ ì‹œë„
        const chargeResult = await this.chargeWalletForAuction({
            bidderId: auctionData.secondBidderId,
            regionId: auctionSnap.id,
            amount: Number(auctionData.secondBid || auctionData.highestBid || 0)
        });
        
        if (chargeResult.success) {
            // ê²°ì œ ì„±ê³µ
            await this.markAuctionSold(auctionSnap.ref, auctionData, {
                bidderId: auctionData.secondBidderId,
                bidderEmail: auctionData.secondBidderEmail,
                amount: auctionData.secondBid || auctionData.highestBid
            }, 'runner_up');
            
            await this.releaseLoserHolds(auctionData, auctionData.secondBidderId, auctionSnap.id);
            console.log(`[ê²½ë§¤ ìë™í™”] ì°¨ìˆœìœ„ ê²°ì œ ì„±ê³µ: ${auctionSnap.id}`);
        } else {
            // ê²°ì œ ì‹¤íŒ¨: ì‹œë„ íšŸìˆ˜ ì¦ê°€
            await updateDoc(auctionSnap.ref, {
                runnerUpAttemptCount: attempts + 1,
                lastRunnerUpAttemptAt: serverTimestamp(),
                paymentFailureReason: chargeResult.reason || 'runner_up_charge_failed',
                updatedAt: serverTimestamp()
            });
            console.warn(`[ê²½ë§¤ ìë™í™”] ì°¨ìˆœìœ„ ê²°ì œ ì‹¤íŒ¨: ${auctionSnap.id}`, chargeResult);
        }
    }

    updateCommunityRewardUI(poolData = {}) {
        const rewardEl = document.getElementById('community-reward-total');
        if (rewardEl) {
            rewardEl.textContent = this.formatCurrency(poolData.rewardFund || 0);
        }

        const freePixelEl = document.getElementById('community-free-pixels');
        if (freePixelEl) {
            freePixelEl.textContent = `${(poolData.freePixelPool || 0).toLocaleString()} px`;
        }

        const auctionCountEl = document.getElementById('community-auctions-count');
        if (auctionCountEl) {
            auctionCountEl.textContent = `${(poolData.totalAuctions || 0).toLocaleString()}íšŒ`;
        }

        const lastDropEl = document.getElementById('community-last-drop');
        if (lastDropEl) {
            lastDropEl.textContent = poolData.lastDistributionAt ? this.formatDateTime(poolData.lastDistributionAt) : 'ì•„ì§ ì—†ìŒ';
        }

        const lastContributionEl = document.getElementById('community-last-contribution');
        if (lastContributionEl) {
            const amount = poolData.recentContribution || 0;
            const region = poolData.recentAuctionRegion || '-';
            lastContributionEl.textContent = amount > 0
                ? `${this.formatCurrency(amount)} (${region})`
                : 'ì•„ì§ ì—†ìŒ';
        }

        const triggerBtn = document.getElementById('trigger-pixel-airdrop');
        if (triggerBtn) {
            const available = (poolData.freePixelPool || 0) >= this.freePixelDropSize;
            triggerBtn.disabled = !available;
            triggerBtn.textContent = available ? 'ë¬´ë£Œ í”½ì…€ ë“œë ì‹¤í–‰' : 'ì ë¦½ ëŒ€ê¸°ì¤‘';
        }
    }

    formatCurrency(amount = 0, currency = 'USD') {
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency,
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        }).format(amount);
    }

    formatDateTime(timestamp) {
        if (!timestamp) {
            return '-';
        }
        const date = typeof timestamp.toDate === 'function' ? timestamp.toDate() : timestamp;
        if (!(date instanceof Date)) {
            return '-';
        }
        return date.toLocaleString('ko-KR', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit'
        });
    }

    async updateCommunityPoolContribution(auctionData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }

        try {
            const { doc, setDoc, serverTimestamp, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const poolRef = doc(this.firestore, 'communityPools', 'global');
            const rewardContribution = Math.max(0, Number((auctionData.currentBid || 0) * this.communityRewardRate));
            const roundedContribution = Math.round(rewardContribution * 100) / 100;
            const freePixelsEarned = Math.max(0, Math.floor(roundedContribution / this.freePixelConversionRate));

            await setDoc(poolRef, {
                rewardFund: increment(roundedContribution),
                totalAuctions: increment(1),
                freePixelPool: increment(freePixelsEarned),
                recentContribution: roundedContribution,
                recentAuctionRegion: auctionData.regionName || auctionData.regionNameEn || auctionData.regionId || 'Unknown',
                lastContributionAt: serverTimestamp()
            }, { merge: true });
        } catch (error) {
            console.error('ì»¤ë®¤ë‹ˆí‹° í’€ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }

    async triggerCommunityAirdrop() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
            return;
        }

        try {
            const { doc, runTransaction, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const poolRef = doc(this.firestore, 'communityPools', 'global');

            await runTransaction(this.firestore, async (transaction) => {
                const poolSnap = await transaction.get(poolRef);
                const poolData = poolSnap.exists() ? poolSnap.data() : this.getDefaultCommunityPoolData();
                const availablePixels = poolData.freePixelPool || 0;

                if (availablePixels < this.freePixelDropSize) {
                    throw new Error('ë¬´ë£Œ í”½ì…€ í’€ì— ì”ì—¬ í”½ì…€ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                }

                transaction.set(poolRef, {
                    freePixelPool: availablePixels - this.freePixelDropSize,
                    lastDistributionAt: serverTimestamp(),
                    lastDistributionSize: this.freePixelDropSize
                }, { merge: true });
            });

            this.showNotification(`ë¬´ë£Œ í”½ì…€ ${this.freePixelDropSize.toLocaleString()}ê°œê°€ ì»¤ë®¤ë‹ˆí‹°ì— ë°°í¬ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        } catch (error) {
            console.error('ë¬´ë£Œ í”½ì…€ ë“œë ì‹¤íŒ¨:', error);
            this.showNotification(error.message || 'ë¬´ë£Œ í”½ì…€ ë“œëì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    /**
     * ì˜¥ì…˜ ëª¨ë‹¬ ì—´ê¸°
     */
    async openAuctionModal(region) {
        // regionì´ ì—†ê±°ë‚˜ region.idê°€ ì—†ìœ¼ë©´ currentRegion ë˜ëŠ” selectedStateId ì‚¬ìš©
        if (!region || !region.id) {
            if (this.currentRegion && this.currentRegion.id) {
                region = this.currentRegion;
            } else if (this.selectedStateId) {
                // selectedStateIdë¡œ regionDataì—ì„œ ì¡°íšŒ ì‹œë„
                region = this.regionData.get(this.selectedStateId);
                if (!region) {
                    // regionDataì—ë„ ì—†ìœ¼ë©´ ìµœì†Œí•œì˜ region ê°ì²´ ìƒì„±
                    const defaultCountry = this.currentMapMode === 'korea' ? 'South Korea' : 
                                           this.currentMapMode === 'japan' ? 'Japan' : 'USA';
                    region = {
                        id: this.selectedStateId,
                        name: this.selectedStateId,
                        name_ko: this.selectedStateId,
                        name_en: this.selectedStateId,
                        country: defaultCountry,
                        ad_status: 'available',
                        ad_price: 0
                    };
                    this.regionData.set(this.selectedStateId, region);
                }
            } else {
                this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
        }
        
        // ë¡œê·¸ì¸ ì²´í¬ (ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ)
        if (!this.isAdminLoggedIn && !this.currentUser) {
            this.showNotification('ì˜¥ì…˜ì— ì°¸ì—¬í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            this.showUserLoginModal();
            return;
        }
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ ê°€ì§œ ì‚¬ìš©ì ê°ì²´ ìƒì„± (ì‚¬ìš©ì ê²½í—˜ í…ŒìŠ¤íŠ¸ìš©)
        if (this.isAdminLoggedIn && !this.currentUser) {
            this.currentUser = {
                uid: 'admin-test-user',
                email: 'admin@test.com'
            };
        }
        
        this.currentRegion = region;
        this.selectedStateId = region.id;

        // ì´ë¯¸ ì ìœ ëœ ì§€ì—­ì¸ì§€ í™•ì¸
        if (region.ad_status === 'occupied' || region.occupied) {
            this.showNotification('ì´ë¯¸ ê´‘ê³ ê°€ ì§„í–‰ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤.', 'info');
            return;
        }
        
        // ì˜¥ì…˜ ìƒì„± ë˜ëŠ” ì¡°íšŒ
        const auction = await this.createOrGetAuction(region.id, region);
        if (!auction) {
            this.showNotification('ì˜¥ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('auction-modal');
        if (modal) {
            modal.classList.remove('hidden');
            
            // ì˜¥ì…˜ ì •ë³´ í‘œì‹œ
            document.getElementById('auction-region-name').textContent = region.name_ko || region.name || 'Unknown';
            document.getElementById('auction-country').textContent = region.country || 'Unknown';
            document.getElementById('auction-current-bid').textContent = `$${auction.currentBid.toFixed(2)}`;
            
            // ìµœì†Œ ì…ì°°ê°€ ê³„ì‚°
            const minBid = auction.currentBid + this.minBidIncrement;
            document.getElementById('min-bid-amount').textContent = `$${minBid.toFixed(2)}`;
            document.getElementById('bid-amount-input').min = minBid;
            document.getElementById('bid-amount-input').value = minBid.toFixed(2);
            this.updateAuctionWalletSummary(minBid);
            
            // ì…ì°° ì´ë ¥ í‘œì‹œ
            const bidHistoryContainer = document.getElementById('auction-bid-history');
            if (bidHistoryContainer) {
                this.renderBidHistory(bidHistoryContainer, auction.bidHistory || []);
            }

            this.updateAuctionActionState(auction);
            
            // ì¹´ìš´íŠ¸ë‹¤ìš´ ì‹œì‘
            this.startAuctionCountdown(region.id, auction);
        }
    }
    
    /**
     * ì˜¥ì…˜ ëª¨ë‹¬ ë‹«ê¸°
     */
    closeAuctionModal() {
        const modal = document.getElementById('auction-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
    
    /**
     * ì˜¥ì…˜ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    setupAuctionModalListeners() {
        // ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼
        const closeBtn = document.getElementById('close-auction-modal');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closeAuctionModal();
            });
        }
        
        // ì…ì°° ë²„íŠ¼
        const placeBidBtn = document.getElementById('place-bid-btn');
        if (placeBidBtn) {
            placeBidBtn.addEventListener('click', async () => {
                if (!this.currentRegion) {
                    this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ê´€ë¦¬ì ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ ë¡œê·¸ì¸ ì²´í¬
                if (!this.isAdminLoggedIn && !this.currentUser) {
                    this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                    return;
                }
                
                // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ ê°€ì§œ ì‚¬ìš©ì ê°ì²´ ìƒì„±
                if (this.isAdminLoggedIn && !this.currentUser) {
                    this.currentUser = {
                        uid: 'admin-test-user',
                        email: 'admin@test.com'
                    };
                }
                
                const bidAmountInput = document.getElementById('bid-amount-input');
                const bidAmount = parseFloat(bidAmountInput.value);
                
                if (isNaN(bidAmount) || bidAmount <= 0) {
                    this.showNotification('ì˜¬ë°”ë¥¸ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                // ì…ì°° ì²˜ë¦¬
                const result = await this.placeBid(
                    this.currentRegion.id,
                    bidAmount,
                    this.currentUser.uid,
                    this.currentUser.email
                );
                
                if (result.success) {
                    // ì…ì°° ê¸ˆì•¡ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                    const auction = await this.getAuction(this.currentRegion.id);
                    if (auction) {
                        const minBid = auction.currentBid + this.minBidIncrement;
                        bidAmountInput.value = minBid.toFixed(2);
                        document.getElementById('min-bid-amount').textContent = `$${minBid.toFixed(2)}`;
                    }
                }
            });
        }

        const auctionWalletBtn = document.getElementById('auction-open-wallet');
        if (auctionWalletBtn) {
            auctionWalletBtn.addEventListener('click', () => {
                this.openWalletModal();
            });
        }

        const payNowBtn = document.getElementById('auction-pay-now-btn');
        if (payNowBtn) {
            payNowBtn.addEventListener('click', () => {
                this.handleAuctionPayNowClick();
            });
        }
        
        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
        const modal = document.getElementById('auction-modal');
        if (modal) {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    this.closeAuctionModal();
                }
            });
        }

        this.bindWalletModalEvents();
    }
    
    // ========== í”½ì…€ ì•„íŠ¸ ìŠ¤íŠœë””ì˜¤ ê¸°ëŠ¥ ==========
    
    buildPixelBrandGuides() {
        return [
            {
                id: 'neon-impact',
                name: 'ë„¤ì˜¨ ì„íŒ©íŠ¸',
                description: 'ì²­ë¡-ì˜ë¡œìš° ëŒ€ë¹„, ì‚°ì„¸ë¦¬í”„ ê³„ì—´ í°íŠ¸',
                palette: ['#4ecdc4', '#ffe66d', '#1a535c', '#ff6b6b'],
                accent: '#ffe66d',
                fontFamily: "'Pretendard', 'Noto Sans KR', sans-serif"
            },
            {
                id: 'noir-premium',
                name: 'í”„ë¦¬ë¯¸ì—„ ëˆ„ì•„ë¥´',
                description: 'ë¸”ë™ & ê³¨ë“œ í†¤, ì„¸ë¦¬í”„ ê³„ì—´ í°íŠ¸',
                palette: ['#0d0d0d', '#d4af37', '#2c2c34', '#f7f1e3'],
                accent: '#f5d76e',
                fontFamily: "'Cormorant Garamond', 'Noto Serif KR', serif"
            },
            {
                id: 'playful-pop',
                name: 'í”Œë ˆì´í’€ íŒ',
                description: 'ëŒ€ë¹„ê°€ ê°•í•œ íŒ ì•„íŠ¸ íŒ”ë ˆíŠ¸, ë¼ìš´ë“œ í°íŠ¸',
                palette: ['#ff6b6b', '#f368e0', '#48dbfb', '#1dd1a1'],
                accent: '#f368e0',
                fontFamily: "'Fredoka', 'GmarketSansMedium', sans-serif"
            }
        ];
    }
    
    buildPixelTemplates() {
        return [
            {
                id: 'hero-gradient',
                name: 'íˆì–´ë¡œ ë°°ë„ˆ',
                description: 'ìƒë‹¨ íˆì–´ë¡œ ê·¸ë¼ë°ì´ì…˜ê³¼ í•˜ë‹¨ CTA íŒ¨ë„ì„ ìë™ ë°°ì¹˜í•©ë‹ˆë‹¤.',
                previewStyle: 'background: linear-gradient(135deg, #ff6b6b, #ffe66d);',
                draw: (ctx, size, guide) => {
                    const colors = guide?.palette || [];
                    const primary = colors[0] || '#4ecdc4';
                    const secondary = colors[1] || '#ffe66d';
                    const contrast = colors[2] || '#1a535c';
                    ctx.save();
                    const gradient = ctx.createLinearGradient(0, 0, size, size);
                    gradient.addColorStop(0, primary);
                    gradient.addColorStop(1, secondary);
                    ctx.fillStyle = gradient;
                    ctx.fillRect(0, 0, size, size);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.fillRect(size * 0.08, size * 0.15, size * 0.45, size * 0.12);
                    ctx.fillStyle = contrast;
                    ctx.fillRect(size * 0.08, size * 0.65, size * 0.84, size * 0.2);
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.75)';
                    ctx.fillRect(size * 0.12, size * 0.7, size * 0.5, size * 0.1);
                    ctx.restore();
                }
            },
            {
                id: 'spotlight-diagonal',
                name: 'ìŠ¤í¬íŠ¸ë¼ì´íŠ¸',
                description: 'ëŒ€ê°ì„  ìŠ¤í¬íŠ¸ë¼ì´íŠ¸ì™€ í•˜ë‹¨ ë°°ê²½ìœ¼ë¡œ ë¸Œëœë“œë¥¼ ê°•ì¡°í•©ë‹ˆë‹¤.',
                previewStyle: 'background: linear-gradient(160deg, #0d0d0d 0%, #0d0d0d 55%, #ffe66d 55%, #ffe66d 100%);',
                draw: (ctx, size, guide) => {
                    const primary = guide?.palette?.[0] || '#1a535c';
                    const accent = guide?.accent || '#ffe66d';
                    const neutral = guide?.palette?.[2] || '#111111';
                    ctx.save();
                    ctx.fillStyle = neutral;
                    ctx.fillRect(0, 0, size, size);
                    ctx.fillStyle = primary;
                    ctx.fillRect(0, size * 0.55, size, size * 0.45);
                    ctx.fillStyle = accent;
                    ctx.beginPath();
                    ctx.moveTo(0, size * 0.35);
                    ctx.lineTo(size * 0.75, 0);
                    ctx.lineTo(size, 0);
                    ctx.lineTo(size, size * 0.3);
                    ctx.closePath();
                    ctx.fill();
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.25)';
                    ctx.fillRect(size * 0.1, size * 0.58, size * 0.55, size * 0.18);
                    ctx.restore();
                }
            },
            {
                id: 'modular-grid',
                name: 'ëª¨ë“ˆëŸ¬ ê·¸ë¦¬ë“œ',
                description: '4ë¶„í•  ì»¬ëŸ¬ ê·¸ë¦¬ë“œë¡œ ë¡œê³ /ìŠ¬ë¡œê±´ì„ ë¹ ë¥´ê²Œ ë°°ì¹˜í•©ë‹ˆë‹¤.',
                previewStyle: 'background: repeating-linear-gradient(90deg, #4ecdc4 0, #4ecdc4 20px, #ffe66d 20px, #ffe66d 40px);',
                draw: (ctx, size, guide) => {
                    const colors = guide?.palette?.length ? guide.palette : ['#ff6b6b', '#4ecdc4', '#ffe66d', '#1a535c'];
                    const cell = size / 4;
                    ctx.save();
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(0, 0, size, size);
                    for (let row = 0; row < 4; row++) {
                        for (let col = 0; col < 4; col++) {
                            const colorIndex = (row + col) % colors.length;
                            ctx.fillStyle = colors[colorIndex];
                            ctx.fillRect(col * cell, row * cell, cell - 1, cell - 1);
                        }
                    }
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.85)';
                    ctx.fillRect(cell * 0.5, cell * 2.8, cell * 3, cell * 0.9);
                    ctx.restore();
                }
            }
        ];
    }
    
    buildPixelStickers() {
        const starPixels = [
            { x: 2, y: 0, color: 'accent' },
            { x: 1, y: 1, color: 'accent' },
            { x: 2, y: 1, color: 'accent' },
            { x: 3, y: 1, color: 'accent' },
            { x: 0, y: 2, color: 'accent' },
            { x: 1, y: 2, color: 'accent' },
            { x: 2, y: 2, color: 'accent' },
            { x: 3, y: 2, color: 'accent' },
            { x: 4, y: 2, color: 'accent' },
            { x: 1, y: 3, color: 'accent' },
            { x: 2, y: 3, color: 'accent' },
            { x: 3, y: 3, color: 'accent' },
            { x: 2, y: 4, color: 'accent' }
        ];
        
        const heartPixels = [
            { x: 1, y: 0, color: 'primary' },
            { x: 2, y: 0, color: 'accent' },
            { x: 3, y: 0, color: 'accent' },
            { x: 4, y: 0, color: 'primary' },
            { x: 0, y: 1, color: 'primary' },
            { x: 1, y: 1, color: 'accent' },
            { x: 2, y: 1, color: 'accent' },
            { x: 3, y: 1, color: 'accent' },
            { x: 4, y: 1, color: 'accent' },
            { x: 5, y: 1, color: 'primary' },
            { x: 0, y: 2, color: 'primary' },
            { x: 1, y: 2, color: 'accent' },
            { x: 2, y: 2, color: 'accent' },
            { x: 3, y: 2, color: 'accent' },
            { x: 4, y: 2, color: 'accent' },
            { x: 5, y: 2, color: 'primary' },
            { x: 1, y: 3, color: 'primary' },
            { x: 2, y: 3, color: 'accent' },
            { x: 3, y: 3, color: 'accent' },
            { x: 4, y: 3, color: 'primary' },
            { x: 2, y: 4, color: 'primary' },
            { x: 3, y: 4, color: 'primary' }
        ];
        
        const ctaPixels = [];
        for (let y = 0; y < 4; y++) {
            for (let x = 0; x < 10; x++) {
                const isBorder = y === 0 || y === 3 || x === 0 || x === 9;
                ctaPixels.push({
                    x,
                    y,
                    color: isBorder ? 'secondary' : '#ffffff'
                });
            }
        }
        // í™”ì‚´í‘œ ê°•ì¡°
        ctaPixels.push(
            { x: 7, y: 1, color: 'accent' },
            { x: 8, y: 1, color: 'accent' },
            { x: 8, y: 2, color: 'accent' },
            { x: 7, y: 2, color: 'accent' }
        );
        
        return [
            { id: 'starburst', name: 'ìŠ¤íƒ€ ë²„ìŠ¤íŠ¸', emoji: 'âœ¨', width: 5, height: 5, pixels: starPixels },
            { id: 'heart', name: 'í•˜íŠ¸', emoji: 'â¤ï¸', width: 6, height: 5, pixels: heartPixels },
            { id: 'cta-tag', name: 'CTA ë°°ì§€', emoji: 'ğŸ·ï¸', width: 10, height: 4, pixels: ctaPixels }
        ];
    }
    
    /**
     * í”½ì…€ ì—ë””í„° ì´ˆê¸°í™”
     */
    initPixelEditor() {
        this.pixelEditor = {
            canvas: null,
            ctx: null,
            currentTool: 'pencil',
            currentColor: '#FF0000',
            canvasSize: 32,
            isDrawing: false,
            pixelData: null,
            regionId: null,
            currentSticker: null,
            activeStickerId: null,
            currentBrandGuide: this.pixelBrandGuides?.[0] || null,
            lastTemplateId: null,
            // ì‹¤ì‹œê°„ í˜‘ì—… ê´€ë ¨
            realtimeListener: null, // Firestore ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ unsubscribe í•¨ìˆ˜
            editBatch: [], // ë°°ì¹˜ ì²˜ë¦¬í•  í¸ì§‘ ì´ë²¤íŠ¸ë“¤
            editBatchTimer: null, // ë°°ì¹˜ ì²˜ë¦¬ íƒ€ì´ë¨¸
            lastProcessedEditTime: null, // ë§ˆì§€ë§‰ìœ¼ë¡œ ì²˜ë¦¬í•œ í¸ì§‘ ì‹œê°„
            isApplyingRemoteEdit: false // ì›ê²© í¸ì§‘ ì ìš© ì¤‘ í”Œë˜ê·¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
        };
    }
    
    setPixelTool(toolName) {
        const toolButtons = document.querySelectorAll('.tool-btn');
        toolButtons.forEach(btn => {
            const isActive = btn.dataset.tool === toolName;
            btn.classList.toggle('active', isActive);
        });
        
        if (!this.pixelEditor) {
            this.initPixelEditor();
        }
        
        this.pixelEditor.currentTool = toolName;
        
        if (toolName !== 'sticker') {
            this.pixelEditor.currentSticker = null;
            this.pixelEditor.activeStickerId = null;
            this.updateStickerSelectionUI(null);
        } else if (!this.pixelEditor.currentSticker) {
            this.showPixelMessage('ì‚¬ìš©í•  ìŠ¤í‹°ì»¤ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'warning');
        }
    }
    
    renderBrandGuideOptions() {
        const select = document.getElementById('pixel-brand-guide-select');
        if (!select || select.dataset.initialized === 'true') {
            return;
        }
        
        // ì•ˆì „í•œ innerHTML ì„¤ì •
        const optionsHTML = this.pixelBrandGuides.map(guide => {
            const safeId = this.sanitizeHTML(guide.id || '');
            const safeName = this.sanitizeHTML(guide.name || '');
            return `<option value="${safeId}">${safeName}</option>`;
        }).join('');
        select.innerHTML = optionsHTML;
        
        select.dataset.initialized = 'true';
        const defaultGuideId = this.pixelEditor?.currentBrandGuide?.id || this.pixelBrandGuides[0]?.id;
        if (defaultGuideId) {
            select.value = defaultGuideId;
        }
        
        select.addEventListener('change', (e) => {
            this.applyBrandGuide(e.target.value);
        });
        
        if (defaultGuideId) {
            this.applyBrandGuide(defaultGuideId, { silent: true });
        }
    }
    
    applyBrandGuide(guideId, options = { silent: false }) {
        const guide = this.pixelBrandGuides.find(g => g.id === guideId);
        if (!guide) return;
        
        if (!this.pixelEditor) {
            this.initPixelEditor();
        }
        
        this.pixelEditor.currentBrandGuide = guide;
        document.documentElement.style.setProperty('--pixel-brand-font', guide.fontFamily);
        
        const descEl = document.getElementById('pixel-brand-guide-desc');
        if (descEl) {
            descEl.textContent = `${guide.description} Â· ì¶”ì²œ í°íŠ¸: ${guide.fontFamily}`;
        }
        
        const colorPicker = document.getElementById('pixel-color-picker');
        const defaultColor = guide.palette?.[0] || '#FF0000';
        this.pixelEditor.currentColor = defaultColor;
        if (colorPicker) {
            colorPicker.value = defaultColor;
        }
        
        this.updateBrandSwatches(guide.palette);
        
        if (!options.silent) {
            this.showPixelMessage(`${guide.name} ë¸Œëœë”© ê°€ì´ë“œë¥¼ ì ìš©í–ˆìŠµë‹ˆë‹¤.`, 'info');
        }
    }
    
    updateBrandSwatches(colors = []) {
        const swatchContainer = document.getElementById('pixel-brand-swatches');
        if (!swatchContainer) return;
        
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (swatchContainer.firstChild) {
            swatchContainer.removeChild(swatchContainer.firstChild);
        }
        
        if (!colors.length) {
            const emptyP = document.createElement('p');
            emptyP.className = 'empty-state';
            emptyP.textContent = 'ì¶”ì²œ ìƒ‰ìƒì´ ì—†ìŠµë‹ˆë‹¤.';
            swatchContainer.appendChild(emptyP);
            return;
        }
        
        swatchContainer.classList.remove('empty-state');
        colors.forEach(color => {
            const btn = document.createElement('button');
            btn.className = 'brand-swatch';
            btn.type = 'button';
            btn.dataset.color = this.sanitizeHTML(color);
            btn.style.background = color; // CSS ì†ì„±ì€ ì•ˆì „
            swatchContainer.appendChild(btn);
        });
        
        swatchContainer.querySelectorAll('.brand-swatch').forEach(btn => {
            btn.addEventListener('click', () => {
                const selectedColor = btn.dataset.color;
                this.pixelEditor.currentColor = selectedColor;
                const colorPicker = document.getElementById('pixel-color-picker');
                if (colorPicker) {
                    colorPicker.value = selectedColor;
                }
            });
        });
    }
    
    renderPixelTemplates() {
        const container = document.getElementById('pixel-template-list');
        if (!container || container.dataset.initialized === 'true') {
            return;
        }
        
        container.classList.remove('empty-state');
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        
        this.pixelTemplates.forEach(template => {
            const btn = document.createElement('button');
            btn.className = 'template-card';
            btn.type = 'button';
            btn.dataset.templateId = template.id;
            
            const preview = document.createElement('div');
            preview.className = 'template-preview';
            preview.style.cssText = template.previewStyle || '';
            
            const title = document.createElement('div');
            title.className = 'template-title';
            title.textContent = this.sanitizeHTML(template.name || '');
            
            const desc = document.createElement('p');
            desc.textContent = this.sanitizeHTML(template.description || '');
            
            btn.appendChild(preview);
            btn.appendChild(title);
            btn.appendChild(desc);
            container.appendChild(btn);
        });
        
        container.dataset.initialized = 'true';
        
        container.querySelectorAll('.template-card').forEach(card => {
            card.addEventListener('click', () => {
                this.applyPixelTemplate(card.dataset.templateId);
            });
        });
    }
    
    highlightSelectedTemplate(templateId) {
        const cards = document.querySelectorAll('.template-card');
        cards.forEach(card => {
            card.classList.toggle('active', card.dataset.templateId === templateId);
        });
    }
    
    applyPixelTemplate(templateId) {
        const template = this.pixelTemplates.find(t => t.id === templateId);
        if (!template) return;
        
        if (!this.pixelEditor) {
            this.initPixelEditor();
        }
        
        if (!this.pixelEditor.canvas || !this.pixelEditor.ctx) {
            this.initPixelCanvas();
        }
        
        const proceed = confirm('í…œí”Œë¦¿ì„ ì ìš©í•˜ë©´ í˜„ì¬ ì‘ì—… ë‚´ìš©ì´ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
        if (!proceed) return;
        
        this.initPixelCanvas();
        template.draw(this.pixelEditor.ctx, this.pixelEditor.canvasSize, this.pixelEditor.currentBrandGuide);
        this.drawPixelGrid(0.05);
        this.pixelEditor.lastTemplateId = templateId;
        this.highlightSelectedTemplate(templateId);
        this.showPixelMessage(`${template.name} í…œí”Œë¦¿ì„ ì ìš©í–ˆìŠµë‹ˆë‹¤.`, 'info');
    }
    
    renderPixelStickers() {
        const container = document.getElementById('pixel-sticker-list');
        if (!container || container.dataset.initialized === 'true') {
            return;
        }
        
        container.classList.remove('empty-state');
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (container.firstChild) {
            container.removeChild(container.firstChild);
        }
        
        this.pixelStickers.forEach(sticker => {
            const btn = document.createElement('button');
            btn.className = 'sticker-chip';
            btn.type = 'button';
            btn.dataset.stickerId = sticker.id;
            
            const emojiSpan = document.createElement('span');
            emojiSpan.textContent = sticker.emoji || '';
            const nameText = document.createTextNode(this.sanitizeHTML(sticker.name || ''));
            
            btn.appendChild(emojiSpan);
            btn.appendChild(nameText);
            container.appendChild(btn);
        });
        
        container.dataset.initialized = 'true';
        container.querySelectorAll('.sticker-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                this.setActiveSticker(chip.dataset.stickerId);
            });
        });
    }
    
    setActiveSticker(stickerId) {
        const sticker = this.pixelStickers.find(s => s.id === stickerId);
        if (!sticker) return;
        
        if (!this.pixelEditor) {
            this.initPixelEditor();
        }
        
        this.pixelEditor.currentSticker = sticker;
        this.pixelEditor.activeStickerId = stickerId;
        this.setPixelTool('sticker');
        this.updateStickerSelectionUI(stickerId);
        this.showPixelMessage(`${sticker.name} ìŠ¤í‹°ì»¤ë¥¼ ë°°ì¹˜í•  ìœ„ì¹˜ë¥¼ í´ë¦­í•˜ì„¸ìš”.`, 'info');
    }
    
    updateStickerSelectionUI(activeStickerId) {
        const chips = document.querySelectorAll('.sticker-chip');
        chips.forEach(chip => {
            chip.classList.toggle('active', chip.dataset.stickerId === activeStickerId);
        });
    }
    
    resolveStickerColor(token, guide) {
        switch (token) {
            case 'accent':
                return guide?.accent || '#ffd93d';
            case 'primary':
                return guide?.palette?.[0] || '#ff6b6b';
            case 'secondary':
                return guide?.palette?.[1] || '#4ecdc4';
            case 'contrast':
                return guide?.palette?.[2] || '#1a535c';
            default:
                return token || '#ffffff';
        }
    }
    
    placeStickerAt(x, y) {
        if (!this.pixelEditor || !this.pixelEditor.currentSticker) {
            this.showPixelMessage('ìŠ¤í‹°ì»¤ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.', 'warning');
            return;
        }
        
        const sticker = this.pixelEditor.currentSticker;
        const ctx = this.pixelEditor.ctx;
        const size = this.pixelEditor.canvasSize;
        const width = sticker.width || sticker.size || 5;
        const height = sticker.height || sticker.size || 5;
        const offsetX = x - Math.floor(width / 2);
        const offsetY = y - Math.floor(height / 2);
        let placed = false;
        
        sticker.pixels.forEach(pixel => {
            const targetX = offsetX + pixel.x;
            const targetY = offsetY + pixel.y;
            if (targetX < 0 || targetX >= size || targetY < 0 || targetY >= size) {
                return;
            }
            const fillColor = this.resolveStickerColor(pixel.color, this.pixelEditor.currentBrandGuide);
            ctx.fillStyle = fillColor;
            ctx.fillRect(targetX, targetY, 1, 1);
            this.recordEditEvent(targetX, targetY, fillColor, 'sticker');
            placed = true;
        });
        
        if (placed) {
            this.showPixelMessage(`${sticker.name} ìŠ¤í‹°ì»¤ê°€ ë°°ì¹˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        } else {
            this.showPixelMessage('ìŠ¤í‹°ì»¤ë¥¼ ë°°ì¹˜í•  ê³µê°„ì´ ì¶©ë¶„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'warning');
        }
    }
    
    drawPixelGrid(opacity = 0.12) {
        if (!this.pixelEditor || !this.pixelEditor.ctx) return;
        const ctx = this.pixelEditor.ctx;
        const size = this.pixelEditor.canvasSize;
        ctx.save();
        ctx.strokeStyle = `rgba(0, 0, 0, ${opacity})`;
        ctx.lineWidth = 1;
        for (let i = 0; i <= size; i++) {
            ctx.beginPath();
            ctx.moveTo(i, 0);
            ctx.lineTo(i, size);
            ctx.stroke();
            
            ctx.beginPath();
            ctx.moveTo(0, i);
            ctx.lineTo(size, i);
            ctx.stroke();
        }
        ctx.restore();
    }
    
    /**
     * í”½ì…€ ì—ë””í„° ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì—…ë°ì´íŠ¸
     */
    async updatePixelEditorButtonVisibility(buttonElement, regionId) {
        if (!buttonElement || !regionId) return;
        
        // ê´€ë¦¬ìëŠ” í•­ìƒ í‘œì‹œ
        if (this.isAdminLoggedIn) {
            buttonElement.classList.remove('hidden');
            return;
        }
        
        // ì†Œìœ ì í™•ì¸
        const isOwner = await this.checkRegionOwnership(regionId);
        if (isOwner) {
            buttonElement.classList.remove('hidden');
        } else {
            buttonElement.classList.add('hidden');
        }
    }
    
    /**
     * í”½ì…€ ìŠ¤íŠœë””ì˜¤ ëª¨ë‹¬ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    setupPixelStudioListeners() {
        // í”½ì…€ ê·¸ë¦¬ë“œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        const toggleGridLinesBtn = document.getElementById('toggle-grid-lines-btn');
        if (toggleGridLinesBtn) {
            toggleGridLinesBtn.addEventListener('click', () => {
                this.togglePixelGridLines();
                toggleGridLinesBtn.textContent = this.showPixelGridLines ? 'ê·¸ë¦¬ë“œ ì„  ìˆ¨ê¹€' : 'ê·¸ë¦¬ë“œ ì„  í‘œì‹œ';
            });
        }
        
        const currentPixelColorInput = document.getElementById('current-pixel-color');
        if (currentPixelColorInput) {
            currentPixelColorInput.addEventListener('change', (e) => {
                const color = e.target.value;
                this.currentPixelColor = color;
                // pixelEditorì˜ currentColorë„ ë™ê¸°í™”
                if (this.pixelEditor) {
                    this.pixelEditor.currentColor = color;
                }
                // ìƒ‰ìƒ í”¼ì»¤ë„ ë™ê¸°í™”
                const colorPicker = document.getElementById('pixel-color-picker');
                if (colorPicker) {
                    colorPicker.value = color;
                }
            });
        }
        
        // í”½ì…€ ê·¸ë¦¬ë“œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ì€ ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ (í¸ì§‘ ëª¨ë“œì—ì„œë§Œ í‘œì‹œ)
        const pixelGridControls = document.getElementById('pixel-grid-controls');
        if (pixelGridControls) {
            pixelGridControls.classList.add('hidden');
        }
        // ì„¹ì…˜ ì ‘ê¸°/í¼ì¹˜ê¸°
        const collapsibleSections = document.querySelectorAll('.pixel-control-section.collapsible');
        collapsibleSections.forEach(section => {
            const header = section.querySelector('.section-header');
            const toggle = section.querySelector('.collapse-toggle');
            if (header && toggle) {
                header.addEventListener('click', () => {
                    section.classList.toggle('collapsed');
                });
            }
        });
        
        // ë‹¨ì¶•í‚¤ ê°€ì´ë“œ ëª¨ë‹¬
        const shortcutsBtn = document.getElementById('pixel-shortcuts-btn');
        const shortcutsModal = document.getElementById('pixel-shortcuts-modal');
        const closeShortcutsBtn = document.getElementById('close-shortcuts-modal');
        if (shortcutsBtn && shortcutsModal) {
            shortcutsBtn.addEventListener('click', () => {
                shortcutsModal.classList.remove('hidden');
            });
        }
        if (closeShortcutsBtn && shortcutsModal) {
            closeShortcutsBtn.addEventListener('click', () => {
                shortcutsModal.classList.add('hidden');
            });
        }
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        this.setupPixelKeyboardShortcuts();
        
        // ë‹«ê¸° ë²„íŠ¼
        const closeBtn = document.getElementById('close-pixel-studio');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.closePixelStudio();
            });
        }
        
        // ë„êµ¬ ë²„íŠ¼ë“¤
        const toolButtons = document.querySelectorAll('.tool-btn');
        toolButtons.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tool = e.target.closest('.tool-btn').dataset.tool;
                this.setPixelTool(tool);
            });
        });
        
        // ìƒ‰ìƒ ì„ íƒê¸°
        const colorPicker = document.getElementById('pixel-color-picker');
        if (colorPicker) {
            colorPicker.addEventListener('change', (e) => {
                const color = e.target.value;
                this.setPixelColor(color);
            });
        }
        
        // HEX ìƒ‰ìƒ ì…ë ¥
        const colorHexInput = document.getElementById('color-hex-input');
        if (colorHexInput) {
            colorHexInput.addEventListener('input', (e) => {
                let hex = e.target.value.replace('#', '');
                if (hex.length === 6 && /^[0-9A-Fa-f]{6}$/.test(hex)) {
                    const color = '#' + hex.toUpperCase();
                    this.setPixelColor(color);
                }
            });
            colorHexInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                }
            });
        }
        
        // ìƒ‰ìƒ í”„ë¦¬ì…‹
        const colorPresets = document.querySelectorAll('.color-preset');
        colorPresets.forEach(preset => {
            preset.addEventListener('click', (e) => {
                const colorPreset = e.target.closest('.color-preset');
                if (!colorPreset || colorPreset.classList.contains('empty-slot')) return;
                const color = colorPreset.dataset.color;
                this.setPixelColor(color);
                // í”„ë¦¬ì…‹ ì„ íƒ ì‹œê°ì  í”¼ë“œë°±
                colorPresets.forEach(p => p.classList.remove('selected'));
                colorPreset.classList.add('selected');
            });
        });
        
        // ìµœê·¼ ì‚¬ìš© ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        this.updateRecentColors();
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ìŠ¬ë¼ì´ë”
        const canvasSizeSlider = document.getElementById('pixel-canvas-size-slider');
        const canvasSizeValue = document.getElementById('canvas-size-value');
        if (canvasSizeSlider && canvasSizeValue) {
            canvasSizeSlider.addEventListener('input', (e) => {
                const size = parseInt(e.target.value);
                canvasSizeValue.textContent = `${size}x${size}`;
                this.resizePixelCanvas(size);
            });
        }
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì„ íƒ (ìˆ¨ê¹€ ì²˜ë¦¬ë¨)
        const canvasSizeSelect = document.getElementById('pixel-canvas-size');
        if (canvasSizeSelect) {
            canvasSizeSelect.addEventListener('change', (e) => {
                const size = parseInt(e.target.value);
                if (canvasSizeSlider) canvasSizeSlider.value = size;
                if (canvasSizeValue) canvasSizeValue.textContent = `${size}x${size}`;
                this.resizePixelCanvas(size);
            });
        }
        
        // ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ ë²„íŠ¼
        const undoBtn = document.getElementById('pixel-undo-btn');
        const redoBtn = document.getElementById('pixel-redo-btn');
        if (undoBtn) {
            undoBtn.addEventListener('click', () => {
                this.undoPixelEdit();
            });
        }
        if (redoBtn) {
            redoBtn.addEventListener('click', () => {
                this.redoPixelEdit();
            });
        }
        
        // ì•¡ì…˜ ë²„íŠ¼ë“¤
        const clearBtn = document.getElementById('pixel-clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => {
                this.savePixelHistory();
                this.clearPixelCanvas();
            });
        }
        
        const resetBtn = document.getElementById('pixel-reset-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', () => {
                this.resetPixelCanvas();
            });
        }
        
        // ì €ì¥/ë¡œë“œ ë²„íŠ¼
        const saveBtn = document.getElementById('pixel-save-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => {
                this.savePixelCanvas();
            });
        }
        
        const loadBtn = document.getElementById('pixel-load-btn');
        if (loadBtn) {
            loadBtn.addEventListener('click', () => {
                this.loadPixelCanvas();
            });
        }
        
        const closeStudioBtn = document.getElementById('pixel-close-btn');
        if (closeStudioBtn) {
            closeStudioBtn.addEventListener('click', () => {
                this.closePixelStudio();
            });
        }
        
        // ë²„ì „ íˆìŠ¤í† ë¦¬ ë²„íŠ¼
        const historyBtn = document.getElementById('pixel-history-btn');
        if (historyBtn) {
            historyBtn.addEventListener('click', async () => {
                await this.toggleVersionHistory();
            });
        }
        
        // ë²„ì „ íˆìŠ¤í† ë¦¬ ë‹«ê¸° ë²„íŠ¼
        const versionHistoryCloseBtn = document.getElementById('pixel-version-history-close');
        if (versionHistoryCloseBtn) {
            versionHistoryCloseBtn.addEventListener('click', () => {
                const versionHistorySection = document.getElementById('pixel-version-history-section');
                if (versionHistorySection) {
                    versionHistorySection.classList.add('hidden');
                }
            });
        }
        
        this.renderBrandGuideOptions();
        this.renderPixelTemplates();
        this.renderPixelStickers();
    }
    
    /**
     * í”½ì…€ ìŠ¤íŠœë””ì˜¤ ëª¨ë‹¬ ì—´ê¸°
     */
    async openPixelStudio(regionId, regionData) {
        if (!regionId) {
            console.error('[í”½ì…€ ìŠ¤íŠœë””ì˜¤ ì—´ê¸° ì‹¤íŒ¨] regionIdê°€ ì—†ìŠµë‹ˆë‹¤.');
            this.showNotification('ì§€ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        // ê´€ë¦¬ìëŠ” í•­ìƒ í—ˆìš©
        if (this.isAdminLoggedIn) {
            console.log('[í”½ì…€ ìŠ¤íŠœë””ì˜¤] ê´€ë¦¬ì ëª¨ë“œë¡œ ì—´ê¸°:', regionId);
        } else {
            // ê¶Œí•œ í™•ì¸ (ì¼ë°˜ ì‚¬ìš©ìëŠ” ì†Œìœ ìë§Œ)
            const isOwner = await this.checkRegionOwnership(regionId);
            if (!isOwner) {
                this.showNotification('ì´ ì§€ì—­ì˜ ì†Œìœ ìë§Œ í”½ì…€ ì•„íŠ¸ë¥¼ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
        }
        
        // í”½ì…€ ì—ë””í„° ì´ˆê¸°í™”
        if (!this.pixelEditor) {
            this.initPixelEditor();
        }
        
        this.pixelEditor.regionId = regionId;
        
        // í•´ë‹¹ í–‰ì •êµ¬ì—­ì˜ í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ ë° ê°•ì¡° í‘œì‹œ
        await this.highlightRegionPixelGrid(regionId);
        
        // í”½ì…€ ê·¸ë¦¬ë“œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ í‘œì‹œ
        const pixelGridControls = document.getElementById('pixel-grid-controls');
        if (pixelGridControls) {
            pixelGridControls.classList.remove('hidden');
        }
        
        // í”½ì…€ í¸ì§‘ ëª¨ë“œ í™œì„±í™”
        this.isPixelEditMode = true;
        
        // ì‚¬ì´ë“œë°” í‘œì‹œ
        const modal = document.getElementById('pixel-studio-modal');
        if (modal) {
            modal.classList.remove('hidden');
            
            // ì§€ë„ ì»¨í…Œì´ë„ˆì— ì‚¬ì´ë“œë°” í´ë˜ìŠ¤ ì¶”ê°€
            const mapContainer = document.getElementById('map-container');
            if (mapContainer) {
                mapContainer.classList.add('has-pixel-sidebar');
            }
            
            // ì§€ë„ ë¦¬ì‚¬ì´ì¦ˆ (ì‚¬ì´ë“œë°” ì—´ë¦¼ì— ë§ì¶°)
            if (this.map) {
                setTimeout(() => {
                    this.map.resize();
                }, 350);
            }
            
            // ì§€ì—­ ì •ë³´ í‘œì‹œ
            const regionNameEl = document.getElementById('pixel-studio-region-name');
            const countryEl = document.getElementById('pixel-studio-country');
            const permissionStatusEl = document.getElementById('pixel-studio-permission-status');
            
            if (regionNameEl) {
                regionNameEl.textContent = regionData.name_ko || regionData.name_en || regionData.name || '-';
            }
            if (countryEl) {
                countryEl.textContent = regionData.country || '-';
            }
            if (permissionStatusEl) {
                permissionStatusEl.classList.remove('locked', 'unlocked');
                permissionStatusEl.classList.add(isOwner || this.isAdminLoggedIn ? 'unlocked' : 'locked');
                const statusText = permissionStatusEl.querySelector('.status-text');
                if (statusText) {
                    statusText.textContent = isOwner || this.isAdminLoggedIn ? 'í¸ì§‘ ê°€ëŠ¥' : 'í¸ì§‘ ë¶ˆê°€';
                }
            }
            
            // ì•ˆë‚´ ë©”ì‹œì§€ ì¶”ê°€
            const modalBody = modal.querySelector('.modal-body');
            if (modalBody) {
                let guideMessage = modalBody.querySelector('.pixel-edit-guide');
                if (!guideMessage) {
                    guideMessage = document.createElement('div');
                    guideMessage.className = 'pixel-edit-guide';
                    guideMessage.style.cssText = `
                        background: rgba(78, 205, 196, 0.15);
                        border: 1px solid rgba(78, 205, 196, 0.4);
                        border-radius: 8px;
                        padding: 12px;
                        margin-bottom: 16px;
                        color: #4ecdc4;
                        font-size: 0.9rem;
                        line-height: 1.5;
                    `;
                    guideMessage.innerHTML = `
                        <strong>ğŸ’¡ í¸ì§‘ ë°©ë²•:</strong><br>
                        ì§€ë„ ìœ„ì˜ ${regionData.name_ko || regionData.name_en || 'ì´ ì§€ì—­'} í–‰ì •êµ¬ì—­ì„ í´ë¦­í•˜ë©´ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ê°€ í‘œì‹œë©ë‹ˆë‹¤.<br>
                        ìƒ‰ìƒì„ ì„ íƒí•˜ë©´ í•´ë‹¹ í”½ì…€ì´ ì¦‰ì‹œ ìƒ‰ì¹ ë©ë‹ˆë‹¤. ë“œë˜ê·¸ë¡œ ì—¬ëŸ¬ í”½ì…€ì„ ë™ì‹œì— ìƒ‰ì¹ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    `;
                    modalBody.insertBefore(guideMessage, modalBody.firstChild);
                }
            }
            
            // ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
            this.initPixelCanvas();
            
            // ì €ì¥ëœ í”½ì…€ ë°ì´í„° ë¡œë“œ ì‹œë„
            await this.loadPixelCanvas();
            
            // ì‹¤ì‹œê°„ í˜‘ì—… ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            await this.setupRealtimeCollaboration(regionId);
            
            // ë²„ì „ íˆìŠ¤í† ë¦¬ ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const versionHistorySection = document.getElementById('pixel-version-history-section');
            if (versionHistorySection) {
                versionHistorySection.classList.add('hidden');
            }
        }
    }
    
    /**
     * íŠ¹ì • í–‰ì •êµ¬ì—­ì˜ í”½ì…€ ê·¸ë¦¬ë“œ ê°•ì¡° í‘œì‹œ
     */
    async highlightRegionPixelGrid(regionId) {
        if (!this.map) return;
        
        // í•´ë‹¹ ì§€ì—­ì˜ í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ
        let pixelGrid = this.pixelGrids.get(regionId);
        if (!pixelGrid) {
            // GeoJSONì—ì„œ í•´ë‹¹ ì§€ì—­ ì°¾ê¸°
            const source = this.map.getSource('world-regions');
            if (source && source._data) {
                const feature = source._data.features.find(f => 
                    (f.properties?.id === regionId) || (f.properties?.regionId === regionId)
                );
                if (feature) {
                    pixelGrid = this.createPixelGrid(feature, this.pixelGridGridSize);
                    if (pixelGrid) {
                        await this.savePixelGrid(regionId, pixelGrid);
                        this.pixelGrids.set(regionId, pixelGrid);
                    }
                }
            }
        }
        
        if (!pixelGrid) return;
        
        // í•´ë‹¹ ì§€ì—­ì˜ í”½ì…€ë§Œ í•„í„°ë§í•˜ì—¬ í‘œì‹œ
        const regionGeoJson = this.pixelGridToGeoJson(pixelGrid);
        if (regionGeoJson && this.map.getSource('pixel-grids')) {
            // ê¸°ì¡´ ì†ŒìŠ¤ì— í•´ë‹¹ ì§€ì—­ í”½ì…€ë§Œ ì¶”ê°€/ì—…ë°ì´íŠ¸
            const currentSource = this.map.getSource('pixel-grids');
            const currentData = currentSource._data;
            
            // ë‹¤ë¥¸ ì§€ì—­ì˜ í”½ì…€ì€ ìˆ¨ê¸°ê³ , í˜„ì¬ ì§€ì—­ë§Œ í‘œì‹œ
            const filteredFeatures = currentData.features.filter(f => 
                f.properties.regionId === regionId
            );
            
            // í˜„ì¬ ì§€ì—­ í”½ì…€ ì¶”ê°€
            if (regionGeoJson.features) {
                filteredFeatures.push(...regionGeoJson.features);
            }
            
            const filteredGeoJson = {
                type: 'FeatureCollection',
                features: filteredFeatures
            };
            
            currentSource.setData(filteredGeoJson);
            
            // í•´ë‹¹ ì§€ì—­ìœ¼ë¡œ ì§€ë„ ì´ë™
            if (pixelGrid.bbox) {
                const { minX, minY, maxX, maxY } = pixelGrid.bbox;
                this.map.fitBounds(
                    [[minX, minY], [maxX, maxY]],
                    { padding: 50, duration: 1000 }
                );
            }
        }
        
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        await this.setupPixelRealtimeListener(regionId);
    }
    
    /**
     * í”½ì…€ ìº”ë²„ìŠ¤ ì´ˆê¸°í™”
     */
    initPixelCanvas() {
        const canvas = document.getElementById('pixel-canvas');
        if (!canvas) return;
        
        const size = this.pixelEditor.canvasSize;
        canvas.width = size;
        canvas.height = size;
        
        this.pixelEditor.canvas = canvas;
        this.pixelEditor.ctx = canvas.getContext('2d');
        
        // ê·¸ë¦¬ë“œ ë°°ê²½
        this.pixelEditor.ctx.fillStyle = '#f0f0f0';
        this.pixelEditor.ctx.fillRect(0, 0, size, size);
        this.drawPixelGrid();
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        canvas.addEventListener('mousedown', (e) => this.onPixelCanvasMouseDown(e));
        canvas.addEventListener('mousemove', (e) => this.onPixelCanvasMouseMove(e));
        canvas.addEventListener('mouseup', () => this.onPixelCanvasMouseUp());
        canvas.addEventListener('mouseleave', () => this.onPixelCanvasMouseUp());
    }
    
    /**
     * í”½ì…€ ìº”ë²„ìŠ¤ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
     */
    getPixelCoordinates(e) {
        const canvas = this.pixelEditor.canvas;
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        const x = Math.floor((e.clientX - rect.left) * scaleX);
        const y = Math.floor((e.clientY - rect.top) * scaleY);
        
        return { x, y };
    }
    
    onPixelCanvasMouseDown(e) {
        if (!this.pixelEditor) return;
        this.pixelEditor.isDrawing = true;
        this.drawPixel(e);
    }
    
    onPixelCanvasMouseMove(e) {
        if (!this.pixelEditor || !this.pixelEditor.isDrawing) return;
        this.drawPixel(e);
    }
    
    onPixelCanvasMouseUp() {
        if (!this.pixelEditor) return;
        this.pixelEditor.isDrawing = false;
    }
    
    /**
     * í”½ì…€ ê·¸ë¦¬ê¸°
     */
    drawPixel(e) {
        // ì›ê²© í¸ì§‘ ì ìš© ì¤‘ì´ë©´ ë¡œì»¬ í¸ì§‘ ë¬´ì‹œ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
        if (this.pixelEditor && this.pixelEditor.isApplyingRemoteEdit) {
            return;
        }
        
        const { x, y } = this.getPixelCoordinates(e);
        const size = this.pixelEditor.canvasSize;
        
        if (x < 0 || x >= size || y < 0 || y >= size) return;
        
        const ctx = this.pixelEditor.ctx;
        
        switch (this.pixelEditor.currentTool) {
            case 'pencil':
                ctx.fillStyle = this.pixelEditor.currentColor;
                ctx.fillRect(x, y, 1, 1);
                // í¸ì§‘ ì´ë²¤íŠ¸ ê¸°ë¡
                this.recordEditEvent(x, y, this.pixelEditor.currentColor, 'pencil');
                break;
            case 'eraser':
                ctx.fillStyle = '#f0f0f0';
                ctx.fillRect(x, y, 1, 1);
                // ê·¸ë¦¬ë“œ ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                ctx.strokeStyle = 'rgba(0, 0, 0, 0.12)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x, y, 1, 1);
                // í¸ì§‘ ì´ë²¤íŠ¸ ê¸°ë¡
                this.recordEditEvent(x, y, '#f0f0f0', 'eraser');
                break;
            case 'fill':
                this.floodFill(x, y);
                // ì±„ìš°ê¸°ëŠ” ì—¬ëŸ¬ í”½ì…€ì— ì˜í–¥ì„ ì£¼ë¯€ë¡œ ë³„ë„ ì²˜ë¦¬
                this.recordEditEvent(x, y, this.pixelEditor.currentColor, 'fill');
                break;
            case 'sticker':
                this.placeStickerAt(x, y);
                // ë“œë˜ê·¸ ìƒíƒœë¥¼ í•´ì œí•˜ì—¬ ì¤‘ë³µ ë°°ì¹˜ë¥¼ ë°©ì§€
                this.pixelEditor.isDrawing = false;
                break;
        }
    }
    
    /**
     * Flood Fill ì•Œê³ ë¦¬ì¦˜ (ì±„ìš°ê¸°)
     */
    floodFill(startX, startY) {
        const ctx = this.pixelEditor.ctx;
        const size = this.pixelEditor.canvasSize;
        const targetColor = this.getPixelColor(startX, startY);
        const fillColor = this.pixelEditor.currentColor;
        
        if (targetColor === fillColor) return;
        
        const stack = [[startX, startY]];
        const visited = new Set();
        
        while (stack.length > 0) {
            const [x, y] = stack.pop();
            const key = `${x},${y}`;
            
            if (x < 0 || x >= size || y < 0 || y >= size || visited.has(key)) continue;
            
            const pixelColor = this.getPixelColor(x, y);
            if (pixelColor !== targetColor) continue;
            
            visited.add(key);
            ctx.fillStyle = fillColor;
            ctx.fillRect(x, y, 1, 1);
            
            stack.push([x + 1, y], [x - 1, y], [x, y + 1], [x, y - 1]);
        }
    }
    
    /**
     * í”½ì…€ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸°
     */
    getPixelColor(x, y) {
        const imageData = this.pixelEditor.ctx.getImageData(x, y, 1, 1);
        const [r, g, b] = imageData.data;
        return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
    }
    
    /**
     * ìº”ë²„ìŠ¤ í¬ê¸° ë³€ê²½
     */
    resizePixelCanvas(newSize) {
        if (!this.pixelEditor) return;
        
        // í˜„ì¬ ìº”ë²„ìŠ¤ ë°ì´í„° ì €ì¥
        const oldData = this.pixelEditor.ctx.getImageData(0, 0, this.pixelEditor.canvasSize, this.pixelEditor.canvasSize);
        
        this.pixelEditor.canvasSize = newSize;
        this.initPixelCanvas();
        
        // ê¸°ì¡´ ë°ì´í„° ë³µì› (ê°€ëŠ¥í•œ ë²”ìœ„ë§Œ)
        const minSize = Math.min(newSize, oldData.width);
        const newData = this.pixelEditor.ctx.createImageData(minSize, minSize);
        for (let i = 0; i < minSize * minSize * 4; i++) {
            newData.data[i] = oldData.data[i];
        }
        this.pixelEditor.ctx.putImageData(newData, 0, 0);
    }
    
    /**
     * ìº”ë²„ìŠ¤ ì „ì²´ ì§€ìš°ê¸°
     */
    clearPixelCanvas() {
        if (!this.pixelEditor) return;
        this.initPixelCanvas();
    }
    
    /**
     * ìº”ë²„ìŠ¤ ì´ˆê¸°í™” (ì €ì¥ëœ ë°ì´í„°ë¡œ ë³µì›)
     */
    resetPixelCanvas() {
        if (!this.pixelEditor) return;
        this.initPixelCanvas();
        this.loadPixelCanvas();
    }
    
    /**
     * í”½ì…€ ìº”ë²„ìŠ¤ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥
     */
    async savePixelCanvas() {
        if (!this.pixelEditor || !this.pixelEditor.regionId) {
            this.showPixelMessage('ì €ì¥í•  ì§€ì—­ì´ ì„ íƒë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        if (!this.isFirebaseInitialized || !this.firestore) {
            this.showPixelMessage('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        // ê¶Œí•œ í™•ì¸
        const isOwner = await this.checkRegionOwnership(this.pixelEditor.regionId);
        if (!isOwner && !this.isAdminLoggedIn) {
            this.showPixelMessage('ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        try {
            const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ìº”ë²„ìŠ¤ ë°ì´í„°ë¥¼ base64ë¡œ ë³€í™˜
            const imageData = this.pixelEditor.canvas.toDataURL('image/png');
            
            const pixelData = {
                regionId: this.pixelEditor.regionId,
                imageData: imageData,
                canvasSize: this.pixelEditor.canvasSize,
                savedBy: this.currentUser?.email || 'admin',
                savedAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            };
            
            const pixelRef = doc(this.firestore, 'pixelArt', this.pixelEditor.regionId);
            await setDoc(pixelRef, pixelData, { merge: true });
            
            // ë²„ì „ íˆìŠ¤í† ë¦¬ì— ìŠ¤ëƒ…ìƒ· ì €ì¥
            await this.saveVersionSnapshot(imageData, this.pixelEditor.canvasSize);
            
            this.showPixelMessage('í”½ì…€ ì•„íŠ¸ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            console.log(`[í”½ì…€ ì•„íŠ¸ ì €ì¥] ${this.pixelEditor.regionId}`);
        } catch (error) {
            console.error('[í”½ì…€ ì•„íŠ¸ ì €ì¥ ì‹¤íŒ¨]:', error);
            this.showPixelMessage('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
    }
    
    /**
     * Firestoreì—ì„œ í”½ì…€ ìº”ë²„ìŠ¤ ë°ì´í„° ë¡œë“œ
     */
    async loadPixelCanvas() {
        if (!this.pixelEditor || !this.pixelEditor.regionId) {
            return;
        }
        
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const pixelRef = doc(this.firestore, 'pixelArt', this.pixelEditor.regionId);
            const pixelDoc = await getDoc(pixelRef);
            
            if (pixelDoc.exists()) {
                const pixelData = pixelDoc.data();
                const img = new Image();
                img.onload = () => {
                    // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                    if (pixelData.canvasSize) {
                        this.pixelEditor.canvasSize = pixelData.canvasSize;
                        const canvasSizeSelect = document.getElementById('pixel-canvas-size');
                        if (canvasSizeSelect) {
                            canvasSizeSelect.value = pixelData.canvasSize;
                        }
                    }
                    
                    // ìº”ë²„ìŠ¤ ì´ˆê¸°í™” í›„ ì´ë¯¸ì§€ ê·¸ë¦¬ê¸°
                    this.initPixelCanvas();
                    this.pixelEditor.ctx.drawImage(img, 0, 0);
                    
                    this.showPixelMessage('í”½ì…€ ì•„íŠ¸ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!', 'success');
                };
                img.src = pixelData.imageData;
            } else {
                // ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¹ˆ ìº”ë²„ìŠ¤ë§Œ í‘œì‹œ
                this.initPixelCanvas();
            }
        } catch (error) {
            console.error('[í”½ì…€ ì•„íŠ¸ ë¡œë“œ ì‹¤íŒ¨]:', error);
            this.showPixelMessage('ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
    }
    
    /**
     * ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥
     */
    async saveVersionSnapshot(imageData, canvasSize) {
        if (!this.pixelEditor || !this.pixelEditor.regionId || !this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const versionsRef = collection(this.firestore, 'pixelArt', this.pixelEditor.regionId, 'versions');
            
            const versionData = {
                imageData: imageData,
                canvasSize: canvasSize,
                savedBy: this.currentUser?.email || 'admin',
                savedAt: serverTimestamp(),
                note: 'ìë™ ì €ì¥' // ë‚˜ì¤‘ì— ì‚¬ìš©ìê°€ ë©”ëª¨ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆë„ë¡ í™•ì¥ ê°€ëŠ¥
            };
            
            await addDoc(versionsRef, versionData);
            
            console.log(`[ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥] ${this.pixelEditor.regionId}`);
        } catch (error) {
            console.error('[ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * ë²„ì „ ëª©ë¡ ë¡œë“œ
     */
    async loadVersionList() {
        if (!this.pixelEditor || !this.pixelEditor.regionId || !this.isFirebaseInitialized || !this.firestore) {
            return [];
        }
        
        try {
            const { collection, query, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const versionsRef = collection(this.firestore, 'pixelArt', this.pixelEditor.regionId, 'versions');
            const versionsQuery = query(versionsRef, orderBy('savedAt', 'desc'));
            
            const snapshot = await getDocs(versionsQuery);
            const versions = [];
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                versions.push({
                    id: doc.id,
                    imageData: data.imageData,
                    canvasSize: data.canvasSize,
                    savedBy: data.savedBy,
                    savedAt: data.savedAt,
                    note: data.note || 'ìë™ ì €ì¥'
                });
            });
            
            return versions;
        } catch (error) {
            console.error('[ë²„ì „ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨]:', error);
            return [];
        }
    }
    
    /**
     * íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë³µêµ¬ (ë¡¤ë°±)
     */
    async restoreVersion(versionId) {
        if (!this.pixelEditor || !this.pixelEditor.regionId || !this.isFirebaseInitialized || !this.firestore) {
            this.showPixelMessage('ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        // ê¶Œí•œ í™•ì¸
        const isOwner = await this.checkRegionOwnership(this.pixelEditor.regionId);
        if (!isOwner && !this.isAdminLoggedIn) {
            this.showPixelMessage('ë³µêµ¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }
        
        try {
            const { collection, doc, getDoc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ë²„ì „ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const versionRef = doc(this.firestore, 'pixelArt', this.pixelEditor.regionId, 'versions', versionId);
            const versionDoc = await getDoc(versionRef);
            
            if (!versionDoc.exists()) {
                this.showPixelMessage('ë²„ì „ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            const versionData = versionDoc.data();
            
            // ìº”ë²„ìŠ¤ì— ì ìš©
            if (versionData.canvasSize) {
                this.pixelEditor.canvasSize = versionData.canvasSize;
                const canvasSizeSelect = document.getElementById('pixel-canvas-size');
                if (canvasSizeSelect) {
                    canvasSizeSelect.value = versionData.canvasSize;
                }
            }
            
            this.initPixelCanvas();
            
            const img = new Image();
            img.onload = async () => {
                this.pixelEditor.ctx.drawImage(img, 0, 0);
                
                // í˜„ì¬ ë²„ì „ìœ¼ë¡œ ì €ì¥ (ë³µêµ¬ëœ ë²„ì „ì„ ìƒˆë¡œìš´ í˜„ì¬ ë²„ì „ìœ¼ë¡œ ë§Œë“¤ê¸°)
                const pixelRef = doc(this.firestore, 'pixelArt', this.pixelEditor.regionId);
                await setDoc(pixelRef, {
                    regionId: this.pixelEditor.regionId,
                    imageData: versionData.imageData,
                    canvasSize: versionData.canvasSize,
                    savedBy: this.currentUser?.email || 'admin',
                    savedAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    restoredFrom: versionId // ë³µêµ¬ ì •ë³´ ê¸°ë¡
                }, { merge: true });
                
                // ìƒˆë¡œìš´ ë²„ì „ ìŠ¤ëƒ…ìƒ· ì €ì¥
                await this.saveVersionSnapshot(versionData.imageData, versionData.canvasSize);
                
                // ë²„ì „ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await this.refreshVersionList();
                
                this.showPixelMessage('ë²„ì „ì´ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                console.log(`[ë²„ì „ ë³µêµ¬] ${this.pixelEditor.regionId} -> ${versionId}`);
            };
            img.src = versionData.imageData;
            
        } catch (error) {
            console.error('[ë²„ì „ ë³µêµ¬ ì‹¤íŒ¨]:', error);
            this.showPixelMessage('ë³µêµ¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message, 'error');
        }
    }
    
    /**
     * ë²„ì „ ëª©ë¡ UI ìƒˆë¡œê³ ì¹¨
     */
    async refreshVersionList() {
        const versions = await this.loadVersionList();
        this.displayVersionList(versions);
    }
    
    /**
     * ë²„ì „ ëª©ë¡ UI í‘œì‹œ
     */
    displayVersionList(versions) {
        const versionListEl = document.getElementById('pixel-version-list');
        if (!versionListEl) return;
        
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (versionListEl.firstChild) {
            versionListEl.removeChild(versionListEl.firstChild);
        }
        
        if (versions.length === 0) {
            const emptyP = document.createElement('p');
            emptyP.style.textAlign = 'center';
            emptyP.style.color = '#666';
            emptyP.style.padding = '20px';
            emptyP.textContent = 'ì €ì¥ëœ ë²„ì „ì´ ì—†ìŠµë‹ˆë‹¤.';
            versionListEl.appendChild(emptyP);
            return;
        }
        
        versions.forEach((version, index) => {
            const savedAt = version.savedAt?.toDate ? version.savedAt.toDate() : new Date();
            const dateStr = savedAt.toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            const item = document.createElement('div');
            item.className = 'version-item';
            item.dataset.versionId = version.id;
            
            const preview = document.createElement('div');
            preview.className = 'version-preview';
            const img = document.createElement('img');
            img.src = version.imageData; // ì´ë¯¸ì§€ URLì€ ì•ˆì „
            img.alt = `ë²„ì „ ${index + 1}`;
            img.style.width = '60px';
            img.style.height = '60px';
            img.style.imageRendering = 'pixelated';
            img.style.border = '1px solid #ddd';
            preview.appendChild(img);
            
            const info = document.createElement('div');
            info.className = 'version-info';
            
            const title = document.createElement('div');
            title.className = 'version-title';
            title.textContent = `ë²„ì „ ${versions.length - index}`;
            
            const meta = document.createElement('div');
            meta.className = 'version-meta';
            const dateSpan = document.createElement('span');
            dateSpan.className = 'version-date';
            dateSpan.textContent = dateStr;
            const authorSpan = document.createElement('span');
            authorSpan.className = 'version-author';
            authorSpan.textContent = this.sanitizeHTML(version.savedBy || '');
            meta.appendChild(dateSpan);
            meta.appendChild(authorSpan);
            
            const note = document.createElement('div');
            note.className = 'version-note';
            note.textContent = this.sanitizeHTML(version.note || '');
            
            info.appendChild(title);
            info.appendChild(meta);
            info.appendChild(note);
            
            const actions = document.createElement('div');
            actions.className = 'version-actions';
            
            const restoreBtn = document.createElement('button');
            restoreBtn.className = 'version-restore-btn';
            restoreBtn.dataset.versionId = version.id;
            restoreBtn.title = 'ì´ ë²„ì „ìœ¼ë¡œ ë³µêµ¬';
            restoreBtn.textContent = 'ğŸ”„';
            
            const previewBtn = document.createElement('button');
            previewBtn.className = 'version-preview-btn';
            previewBtn.dataset.versionId = version.id;
            previewBtn.title = 'ë¯¸ë¦¬ë³´ê¸°';
            previewBtn.textContent = 'ğŸ‘ï¸';
            
            actions.appendChild(restoreBtn);
            actions.appendChild(previewBtn);
            
            item.appendChild(preview);
            item.appendChild(info);
            item.appendChild(actions);
            versionListEl.appendChild(item);
        });
        
        // ë²„ì „ ë³µêµ¬ ë²„íŠ¼ ì´ë²¤íŠ¸
        versionListEl.querySelectorAll('.version-restore-btn').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const versionId = e.target.closest('.version-restore-btn').dataset.versionId;
                if (confirm('ì´ ë²„ì „ìœ¼ë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ì‘ì—… ë‚´ìš©ì€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.')) {
                    await this.restoreVersion(versionId);
                }
            });
        });
        
        // ë²„ì „ ë¯¸ë¦¬ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
        versionListEl.querySelectorAll('.version-preview-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const versionId = e.target.closest('.version-preview-btn').dataset.versionId;
                const version = versions.find(v => v.id === versionId);
                if (version) {
                    this.previewVersion(version);
                }
            });
        });
    }
    
    /**
     * ë²„ì „ íˆìŠ¤í† ë¦¬ í† ê¸€
     */
    async toggleVersionHistory() {
        const versionHistorySection = document.getElementById('pixel-version-history-section');
        if (!versionHistorySection) return;
        
        if (versionHistorySection.classList.contains('hidden')) {
            // ë²„ì „ íˆìŠ¤í† ë¦¬ í‘œì‹œ
            versionHistorySection.classList.remove('hidden');
            await this.refreshVersionList();
        } else {
            // ë²„ì „ íˆìŠ¤í† ë¦¬ ìˆ¨ê¸°ê¸°
            versionHistorySection.classList.add('hidden');
        }
    }
    
    /**
     * ë²„ì „ ë¯¸ë¦¬ë³´ê¸°
     */
    previewVersion(version) {
        // ê°„ë‹¨í•œ alertë¡œ ë¯¸ë¦¬ë³´ê¸° (ë‚˜ì¤‘ì— ëª¨ë‹¬ë¡œ í™•ì¥ ê°€ëŠ¥)
        const savedAt = version.savedAt?.toDate ? version.savedAt.toDate() : new Date();
        const dateStr = savedAt.toLocaleString('ko-KR');
        
        // ìƒˆ ì°½ìœ¼ë¡œ ì´ë¯¸ì§€ ì—´ê¸°
        const previewWindow = window.open('', '_blank', 'width=400,height=400');
        if (previewWindow) {
            previewWindow.document.write(`
                <html>
                    <head>
                        <title>ë²„ì „ ë¯¸ë¦¬ë³´ê¸°</title>
                        <style>
                            body { 
                                margin: 0; 
                                padding: 20px; 
                                display: flex; 
                                flex-direction: column; 
                                align-items: center; 
                                background: #f0f0f0;
                            }
                            img { 
                                image-rendering: pixelated;
                                border: 2px solid #333;
                                max-width: 100%;
                                height: auto;
                            }
                            .info {
                                margin-top: 10px;
                                text-align: center;
                                color: #666;
                            }
                        </style>
                    </head>
                    <body>
                        <img src="${version.imageData}" alt="ë²„ì „ ë¯¸ë¦¬ë³´ê¸°">
                        <div class="info">
                            <p><strong>ì €ì¥ì¼:</strong> ${dateStr}</p>
                            <p><strong>ì €ì¥ì:</strong> ${version.savedBy}</p>
                            <p><strong>ìº”ë²„ìŠ¤ í¬ê¸°:</strong> ${version.canvasSize}x${version.canvasSize}</p>
                        </div>
                    </body>
                </html>
            `);
            previewWindow.document.close();
        }
    }
    
    /**
     * ì‹¤ì‹œê°„ í˜‘ì—… ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    async setupRealtimeCollaboration(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore || !this.pixelEditor) {
            return;
        }
        
        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆê°€ ìˆìœ¼ë©´ ì •ë¦¬
        if (this.pixelEditor.realtimeListener) {
            this.pixelEditor.realtimeListener();
            this.pixelEditor.realtimeListener = null;
        }
        
        try {
            const { collection, query, orderBy, onSnapshot, serverTimestamp, where } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ì‹¤ì‹œê°„ í¸ì§‘ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            const editsRef = collection(this.firestore, 'pixelArt', regionId, 'edits');
            const editsQuery = query(editsRef, orderBy('timestamp', 'desc'));
            
            this.pixelEditor.realtimeListener = onSnapshot(editsQuery, (snapshot) => {
                // ìì‹ ì˜ í¸ì§‘ì€ ì œì™¸ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
                const currentUserEmail = this.currentUser?.email || 'anonymous';
                
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'added' || change.type === 'modified') {
                        const editData = change.doc.data();
                        
                        // ìì‹ ì˜ í¸ì§‘ì´ ì•„ë‹ˆê³ , ì´ë¯¸ ì²˜ë¦¬í•œ í¸ì§‘ì´ ì•„ë‹ˆë©´ ì ìš©
                        if (editData.editedBy !== currentUserEmail) {
                            // íƒ€ì„ìŠ¤íƒ¬í”„ ê¸°ë°˜ ì¶©ëŒ í•´ê²°
                            if (!this.pixelEditor.lastProcessedEditTime || 
                                editData.timestamp?.toMillis() > this.pixelEditor.lastProcessedEditTime) {
                                this.applyRemoteEdit(editData);
                                this.pixelEditor.lastProcessedEditTime = editData.timestamp?.toMillis() || Date.now();
                            }
                        }
                    }
                });
            }, (error) => {
                console.error('[ì‹¤ì‹œê°„ í˜‘ì—… ë¦¬ìŠ¤ë„ˆ ì˜¤ë¥˜]:', error);
            });
            
            console.log(`[ì‹¤ì‹œê°„ í˜‘ì—… í™œì„±í™”] ${regionId}`);
        } catch (error) {
            console.error('[ì‹¤ì‹œê°„ í˜‘ì—… ì„¤ì • ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * ì›ê²© í¸ì§‘ ì ìš©
     */
    applyRemoteEdit(editData) {
        if (!this.pixelEditor || !this.pixelEditor.ctx || this.pixelEditor.isApplyingRemoteEdit) {
            return;
        }
        
        this.pixelEditor.isApplyingRemoteEdit = true;
        
        try {
            const { x, y, color, tool } = editData;
            
            if (x === undefined || y === undefined) {
                return;
            }
            
            const ctx = this.pixelEditor.ctx;
            const size = this.pixelEditor.canvasSize;
            
            // ì¢Œí‘œ ë²”ìœ„ í™•ì¸
            if (x < 0 || x >= size || y < 0 || y >= size) {
                return;
            }
            
            switch (tool) {
                case 'pencil':
                    ctx.fillStyle = color || '#FF0000';
                    ctx.fillRect(x, y, 1, 1);
                    break;
                case 'eraser':
                    ctx.fillStyle = '#f0f0f0';
                    ctx.fillRect(x, y, 1, 1);
                    // ê·¸ë¦¬ë“œ ì„  ë‹¤ì‹œ ê·¸ë¦¬ê¸°
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.12)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(x, y, 1, 1);
                    break;
                case 'fill':
                    // ì±„ìš°ê¸° ë„êµ¬ëŠ” ë³µì¡í•˜ë¯€ë¡œ ì €ì¥ëœ ì´ë¯¸ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œ
                    this.loadPixelCanvas();
                    break;
                case 'sticker':
                    ctx.fillStyle = color || '#ffd93d';
                    ctx.fillRect(x, y, 1, 1);
                    break;
            }
        } catch (error) {
            console.error('[ì›ê²© í¸ì§‘ ì ìš© ì‹¤íŒ¨]:', error);
        } finally {
            this.pixelEditor.isApplyingRemoteEdit = false;
        }
    }
    
    /**
     * í¸ì§‘ ì´ë²¤íŠ¸ë¥¼ Firestoreì— ê¸°ë¡ (ë°°ì¹˜ ì²˜ë¦¬)
     */
    async recordEditEvent(x, y, color, tool) {
        if (!this.pixelEditor || !this.pixelEditor.regionId || !this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        // í¸ì§‘ ì´ë²¤íŠ¸ë¥¼ ë°°ì¹˜ì— ì¶”ê°€
        this.pixelEditor.editBatch.push({
            x,
            y,
            color,
            tool,
            timestamp: Date.now()
        });
        
        // ë°°ì¹˜ ì²˜ë¦¬ íƒ€ì´ë¨¸ ì„¤ì • (100msë§ˆë‹¤ ë°°ì¹˜ ì „ì†¡)
        if (this.pixelEditor.editBatchTimer) {
            clearTimeout(this.pixelEditor.editBatchTimer);
        }
        
        this.pixelEditor.editBatchTimer = setTimeout(() => {
            this.flushEditBatch();
        }, 100);
    }
    
    /**
     * í¸ì§‘ ë°°ì¹˜ë¥¼ Firestoreì— ì „ì†¡
     */
    async flushEditBatch() {
        if (!this.pixelEditor || !this.pixelEditor.editBatch.length || !this.pixelEditor.regionId) {
            return;
        }
        
        const batch = this.pixelEditor.editBatch;
        this.pixelEditor.editBatch = []; // ë°°ì¹˜ ì´ˆê¸°í™”
        
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ê° í¸ì§‘ ì´ë²¤íŠ¸ë¥¼ Firestoreì— ì¶”ê°€
            for (const edit of batch) {
                const editsRef = collection(this.firestore, 'pixelArt', this.pixelEditor.regionId, 'edits');
                await addDoc(editsRef, {
                    x: edit.x,
                    y: edit.y,
                    color: edit.color,
                    tool: edit.tool,
                    editedBy: this.currentUser?.email || 'anonymous',
                    timestamp: serverTimestamp(),
                    clientTimestamp: edit.timestamp
                });
            }
        } catch (error) {
            console.error('[í¸ì§‘ ì´ë²¤íŠ¸ ê¸°ë¡ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * í”½ì…€ ìŠ¤íŠœë””ì˜¤ ëª¨ë‹¬ ë‹«ê¸°
     */
    closePixelStudio() {
        // í”½ì…€ í¸ì§‘ ëª¨ë“œ ë¹„í™œì„±í™”
        this.isPixelEditMode = false;
        
        // í”½ì…€ ê·¸ë¦¬ë“œ ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìˆ¨ê¸°ê¸°
        const pixelGridControls = document.getElementById('pixel-grid-controls');
        if (pixelGridControls) {
            pixelGridControls.classList.add('hidden');
        }
        
        // ëª¨ë“  í”½ì…€ ê·¸ë¦¬ë“œ ë‹¤ì‹œ í‘œì‹œ
        if (this.map && this.map.getSource('pixel-grids')) {
            this.updateVisiblePixels();
        }
        // ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        if (this.pixelEditor && this.pixelEditor.realtimeListener) {
            this.pixelEditor.realtimeListener();
            this.pixelEditor.realtimeListener = null;
        }
        
        // ë°°ì¹˜ íƒ€ì´ë¨¸ ì •ë¦¬ ë° ë‚¨ì€ í¸ì§‘ ì „ì†¡
        if (this.pixelEditor && this.pixelEditor.editBatchTimer) {
            clearTimeout(this.pixelEditor.editBatchTimer);
            this.pixelEditor.editBatchTimer = null;
        }
        
        // ë‚¨ì€ í¸ì§‘ ì´ë²¤íŠ¸ ì „ì†¡
        if (this.pixelEditor && this.pixelEditor.editBatch.length > 0) {
            this.flushEditBatch();
        }
        
        const modal = document.getElementById('pixel-studio-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
        
        // ì§€ë„ ì»¨í…Œì´ë„ˆì—ì„œ ì‚¬ì´ë“œë°” í´ë˜ìŠ¤ ì œê±°
        const mapContainer = document.getElementById('map-container');
        if (mapContainer) {
            mapContainer.classList.remove('has-pixel-sidebar');
        }
        
        // ì§€ë„ ë¦¬ì‚¬ì´ì¦ˆ (ì‚¬ì´ë“œë°”ê°€ ë‹«í ë•Œ ì§€ë„ê°€ ë‹¤ì‹œ ì „ì²´ ë„ˆë¹„ë¥¼ ì°¨ì§€í•˜ë„ë¡)
        if (this.map) {
            setTimeout(() => {
                this.map.resize();
            }, 300);
        }
    }
    
    /**
     * í”½ì…€ ìŠ¤íŠœë””ì˜¤ ë©”ì‹œì§€ í‘œì‹œ
     */
    showPixelMessage(message, type = 'success') {
        const messageEl = document.getElementById('pixel-studio-message');
        if (messageEl) {
            messageEl.textContent = message;
            messageEl.className = `pixel-message ${type}`;
            messageEl.classList.remove('hidden');
            
            setTimeout(() => {
                messageEl.classList.add('hidden');
            }, 3000);
        }
    }
    
    // ========== Wplace ìŠ¤íƒ€ì¼ í”½ì…€ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ (Phase 0-4) ==========
    
    /**
     * Phase 0: í”½ì…€ì•„íŠ¸ ì§€ë„ í‘œì‹œ ê¸°ëŠ¥
     * ì €ì¥ëœ í”½ì…€ì•„íŠ¸ë¥¼ ì§€ë„ì— í‘œì‹œ
     */
    async loadPixelArtForMap(regionIds) {
        if (!this.isFirebaseInitialized || !this.firestore || !this.map) return;
        
        try {
            const { doc, getDoc, getDocFromCache } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const pixelArtPromises = regionIds.map(async (regionId) => {
                try {
                    const pixelRef = doc(this.firestore, 'pixelArt', regionId);
                    let pixelDoc;
                    
                    // ë¨¼ì € ì„œë²„ì—ì„œ ì½ê¸°ë¥¼ ì‹œë„í•˜ê³ , ì˜¤í”„ë¼ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ìºì‹œì—ì„œ ì½ê¸° ì‹œë„
                    try {
                        pixelDoc = await getDoc(pixelRef);
                    } catch (error) {
                        // ì˜¤í”„ë¼ì¸ ì˜¤ë¥˜ì¸ ê²½ìš° ìºì‹œì—ì„œ ì½ê¸° ì‹œë„
                        if (error.code === 'unavailable' || error.message?.includes('offline')) {
                            try {
                                pixelDoc = await getDocFromCache(pixelRef);
                            } catch (cacheError) {
                                // ìºì‹œì—ë„ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ (ì˜¤í”„ë¼ì¸ ìƒíƒœëŠ” ì •ìƒì ì¸ ìƒí™©)
                                return null;
                            }
                        } else {
                            // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                            return null;
                        }
                    }
                    
                    if (pixelDoc.exists()) {
                        const pixelData = pixelDoc.data();
                        if (pixelData.imageData) {
                            const img = new Image();
                            img.crossOrigin = 'anonymous';
                            
                            await new Promise((resolve, reject) => {
                                img.onload = () => {
                                    try {
                                        const imageId = `pixel-art-${regionId}`;
                                        if (this.map.hasImage(imageId)) {
                                            this.map.removeImage(imageId);
                                        }
                                        this.map.addImage(imageId, img);
                                        resolve({ regionId, imageId });
                                    } catch (error) {
                                        console.error(`[í”½ì…€ì•„íŠ¸ ì´ë¯¸ì§€ ë“±ë¡ ì‹¤íŒ¨] ${regionId}:`, error);
                                        reject(error);
                                    }
                                };
                                img.onerror = reject;
                                img.src = pixelData.imageData;
                            });
                            
                            return { regionId, imageId: `pixel-art-${regionId}` };
                        }
                    }
                } catch (error) {
                    // ì˜¤í”„ë¼ì¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ (ì •ìƒì ì¸ ìƒí™©)
                    // ë‹¤ë¥¸ ì˜¤ë¥˜ë§Œ ì½˜ì†”ì— ì¶œë ¥
                    if (error.code !== 'unavailable' && !error.message?.includes('offline')) {
                        console.error(`[í”½ì…€ì•„íŠ¸ ë¡œë“œ ì‹¤íŒ¨] ${regionId}:`, error);
                    }
                }
                return null;
            });
            
            const results = await Promise.all(pixelArtPromises);
            return results.filter(r => r !== null);
        } catch (error) {
            // ì˜¤í”„ë¼ì¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
            if (error.code !== 'unavailable' && !error.message?.includes('offline')) {
                console.error('[í”½ì…€ì•„íŠ¸ ì§€ë„ ë¡œë“œ ì‹¤íŒ¨]:', error);
            }
            return [];
        }
    }
    
    /**
     * Phase 0: GeoJSONì— í”½ì…€ì•„íŠ¸ ì´ë¯¸ì§€ ID ì¶”ê°€
     */
    addPixelArtToGeoJson(geoJson, pixelArtMap) {
        if (!geoJson || !geoJson.features) return geoJson;
        
        geoJson.features.forEach(feature => {
            const regionId = feature.properties?.id || feature.properties?.regionId;
            if (regionId && pixelArtMap[regionId]) {
                feature.properties.pixelArtImageId = pixelArtMap[regionId].imageId;
            }
        });
        return geoJson;
    }
    
    /**
     * Phase 0: í”½ì…€ì•„íŠ¸ ë ˆì´ì–´ ì—…ë°ì´íŠ¸
     */
    async updatePixelArtLayer(geoJson) {
        if (!this.map || !geoJson) return;
        
        // í”½ì…€ì•„íŠ¸ê°€ ìˆëŠ” ì§€ì—­ ID ìˆ˜ì§‘
        const regionIds = [];
        if (geoJson.features) {
            geoJson.features.forEach(feature => {
                const regionId = feature.properties?.id || feature.properties?.regionId;
                if (regionId) regionIds.push(regionId);
            });
        }
        
        // í”½ì…€ì•„íŠ¸ ë¡œë“œ
        const pixelArtList = await this.loadPixelArtForMap(regionIds);
        const pixelArtMap = {};
        pixelArtList.forEach(item => {
            pixelArtMap[item.regionId] = item;
        });
        
        // GeoJSONì— í”½ì…€ì•„íŠ¸ ì´ë¯¸ì§€ ID ì¶”ê°€
        this.addPixelArtToGeoJson(geoJson, pixelArtMap);
        
        // ë ˆì´ì–´ì— fill-pattern ì ìš© (ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ)
        if (this.map.getLayer('regions-fill')) {
            // í”½ì…€ì•„íŠ¸ ì´ë¯¸ì§€ê°€ ìˆëŠ” ì§€ì—­ì´ ìˆëŠ”ì§€ í™•ì¸
            const hasPixelArt = Object.keys(pixelArtMap).length > 0;
            
            if (hasPixelArt) {
                // ì´ë¯¸ì§€ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ fill-pattern ì„¤ì •
                this.map.setPaintProperty('regions-fill', 'fill-pattern', [
                    'case',
                    ['has', 'pixelArtImageId'],
                    ['get', 'pixelArtImageId'],
                    '' // null ëŒ€ì‹  ë¹ˆ ë¬¸ìì—´ ì‚¬ìš©
                ]);
            } else {
                // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ fill-pattern ì œê±°
                try {
                    this.map.setPaintProperty('regions-fill', 'fill-pattern', null);
                } catch (e) {
                    // ì´ë¯¸ nullì´ë©´ ë¬´ì‹œ
                }
            }
        }
    }
    
    /**
     * Phase 1: í–‰ì •êµ¬ì—­ì„ í”½ì…€ ê·¸ë¦¬ë“œë¡œ ë³€í™˜
     * ê°„ë‹¨í•œ í¬ì¸íŠ¸ ì¸ í´ë¦¬ê³¤ ì²´í¬ í•¨ìˆ˜ (turf.js ì—†ì´)
     */
    isPointInPolygon(point, polygon) {
        const [x, y] = point;
        const coordinates = polygon.coordinates[0]; // ì™¸ê³½ ê²½ê³„
        let inside = false;
        
        for (let i = 0, j = coordinates.length - 1; i < coordinates.length; j = i++) {
            const [xi, yi] = coordinates[i];
            const [xj, yj] = coordinates[j];
            
            const intersect = ((yi > y) !== (yj > y)) && 
                             (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        
        return inside;
    }
    
    /**
     * ì‹¤ì œ polygon ë©´ì  ê³„ì‚° (ì œê³±í‚¬ë¡œë¯¸í„° ë‹¨ìœ„)
     * WGS84 ì¢Œí‘œê³„ì—ì„œ êµ¬ë©´ ë©´ì ì„ ê³„ì‚°í•©ë‹ˆë‹¤
     * êµ¬ë©´ ë‹¤ê°í˜• ë©´ì  ê³µì‹ ì‚¬ìš© (Spherical polygon area formula)
     */
    calculatePolygonArea(feature) {
        if (!feature || !feature.geometry) return 0;
        
        const geometry = feature.geometry;
        const EARTH_RADIUS_KM = 6371.0088; // ì§€êµ¬ ë°˜ì§€ë¦„ (km) - WGS84 ê¸°ì¤€
        
        const calculatePolygonArea = (coordinates) => {
            if (!coordinates || coordinates.length < 3) return 0;
            
            // ì²« ë²ˆì§¸ ì ê³¼ ë§ˆì§€ë§‰ ì ì´ ê°™ìœ¼ë©´ ë§ˆì§€ë§‰ ì  ì œê±°
            const coords = [...coordinates];
            if (coords.length > 0 && 
                coords[0][0] === coords[coords.length - 1][0] && 
                coords[0][1] === coords[coords.length - 1][1]) {
                coords.pop();
            }
            if (coords.length < 3) return 0;
            
            // êµ¬ë©´ ë‹¤ê°í˜• ë©´ì  ê³„ì‚° (Spherical polygon area formula)
            let area = 0;
            const n = coords.length;
            
            for (let i = 0; i < n; i++) {
                const [lon1, lat1] = coords[i];
                const [lon2, lat2] = coords[(i + 1) % n];
                
                // ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜
                const lat1Rad = lat1 * Math.PI / 180;
                const lat2Rad = lat2 * Math.PI / 180;
                const lonDiffRad = (lon2 - lon1) * Math.PI / 180;
                
                // êµ¬ë©´ ì‚¼ê°í˜• ë©´ì  ëˆ„ì 
                // ê° ë³€ì— ëŒ€í•œ êµ¬ë©´ ì´ˆê³¼ ê³„ì‚°
                area += lonDiffRad * (2 + Math.sin(lat1Rad) + Math.sin(lat2Rad));
            }
            
            // ë©´ì ì„ ì œê³±í‚¬ë¡œë¯¸í„°ë¡œ ë³€í™˜
            // areaëŠ” êµ¬ë©´ ì´ˆê³¼ (ë¼ë””ì•ˆ)ì´ë¯€ë¡œ, ì´ë¥¼ ì œê³±ë¼ë””ì•ˆìœ¼ë¡œ ë³€í™˜ í›„ kmÂ²ë¡œ ë³€í™˜
            const sphericalArea = Math.abs(area - (n - 2) * Math.PI);
            return sphericalArea * EARTH_RADIUS_KM * EARTH_RADIUS_KM;
        };
        
        let totalArea = 0;
        
        // Polygon ì²˜ë¦¬
        if (geometry.type === 'Polygon') {
            // ì™¸ê³½ ê²½ê³„ë§Œ ê³„ì‚° (êµ¬ë©ì€ ì œì™¸)
            totalArea = calculatePolygonArea(geometry.coordinates[0]);
        }
        // MultiPolygon ì²˜ë¦¬
        else if (geometry.type === 'MultiPolygon') {
            geometry.coordinates.forEach(polygon => {
                // ê° polygonì˜ ì™¸ê³½ ê²½ê³„ë§Œ ê³„ì‚°
                totalArea += calculatePolygonArea(polygon[0]);
            });
        }
        
        // ë©´ì ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ì‘ìœ¼ë©´ 0 ë°˜í™˜ (ê³„ì‚° ì˜¤ë¥˜ ê°€ëŠ¥ì„±)
        // ê²½ê³ ëŠ” ë””ë²„ê·¸ ëª¨ë“œì—ì„œë§Œ ì¶œë ¥ (ë„ˆë¬´ ë§ì€ ê²½ê³  ë°©ì§€)
        if (totalArea < 0 || totalArea > 200000000) { // ìµœëŒ€ ì•½ 2ì–µ kmÂ² (ì§€êµ¬ í‘œë©´ì˜ ì•½ ì ˆë°˜)
            // ë””ë²„ê·¸ ëª¨ë“œê°€ ì•„ë‹ˆë©´ ê²½ê³  ìƒëµ (ì´ë¯¸ 0ì„ ë°˜í™˜í•˜ë¯€ë¡œ ë¬¸ì œ ì—†ìŒ)
            if (window.DEBUG_MODE) {
                console.warn(`[ë©´ì  ê³„ì‚°] ë¹„ì •ìƒì ì¸ ë©´ì  ê°’: ${totalArea.toFixed(2)} kmÂ²`);
            }
            return 0;
        }
        
        return Math.round(totalArea * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬ê¹Œì§€ ë°˜ì˜¬ë¦¼
    }
    
    /**
     * Phase 1: ë°”ìš´ë”© ë°•ìŠ¤ ê³„ì‚°
     */
    calculateBoundingBox(feature) {
        if (!feature || !feature.geometry) return null;
        
        const coordinates = feature.geometry.coordinates;
        let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
        
        const processCoordinates = (coords) => {
            if (Array.isArray(coords[0])) {
                coords.forEach(processCoordinates);
            } else {
                const [x, y] = coords;
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x);
                maxY = Math.max(maxY, y);
            }
        };
        
        if (feature.geometry.type === 'Polygon') {
            processCoordinates(coordinates[0]);
        } else if (feature.geometry.type === 'MultiPolygon') {
            coordinates.forEach(polygon => {
                processCoordinates(polygon[0]);
            });
        }
        
        return { minX, minY, maxX, maxY };
    }
    
    /**
     * Phase 1: í–‰ì •êµ¬ì—­ì„ í”½ì…€ ê·¸ë¦¬ë“œë¡œ ë³€í™˜ (ì‹¤ì œ ë©´ì  ê¸°ë°˜)
     * ì‹¤ì œ polygon ë©´ì ì„ ê¸°ë°˜ìœ¼ë¡œ í”½ì…€ í¬ê¸°ë¥¼ ì •í™•íˆ ê³„ì‚°í•©ë‹ˆë‹¤
     */
    createPixelGrid(feature, gridSize = 128) {
        if (!feature || !feature.geometry) return null;
        
        const bbox = this.calculateBoundingBox(feature);
        if (!bbox) return null;
        
        const { minX, minY, maxX, maxY } = bbox;
        
        // ì‹¤ì œ polygon ë©´ì  ê³„ì‚° (ì œê³±í‚¬ë¡œë¯¸í„°)
        let actualAreaKm2 = 0;
        
        // 1. propertiesì— ë©´ì ì´ ìˆê³  ìœ íš¨í•˜ë©´ ì‚¬ìš©
        if (feature.properties && feature.properties.area && feature.properties.area > 0) {
            actualAreaKm2 = feature.properties.area;
        }
        // 2. ì—†ìœ¼ë©´ ì‹¤ì œ polygon ë©´ì  ê³„ì‚°
        else {
            actualAreaKm2 = this.calculatePolygonArea(feature);
        }
        
        // 3. ë©´ì  ê³„ì‚° ì‹¤íŒ¨ ì‹œ ë°”ìš´ë”© ë°•ìŠ¤ ê¸°ë°˜ ì¶”ì •
        if (actualAreaKm2 <= 0) {
            const bboxWidth = maxX - minX;
            const bboxHeight = maxY - minY;
            const EARTH_RADIUS_KM = 6371;
            
            // ìœ„ë„ì— ë”°ë¥¸ ë³´ì • ê³„ìˆ˜ (ì¤‘ê°„ ìœ„ë„ ê¸°ì¤€)
            const avgLat = (minY + maxY) / 2;
            const latRad = avgLat * Math.PI / 180;
            const latCorrection = Math.cos(latRad);
            
            // ê²½ë„/ìœ„ë„ ì°¨ì´ë¥¼ kmë¡œ ë³€í™˜
            const widthKm = (bboxWidth * Math.PI / 180) * EARTH_RADIUS_KM * latCorrection;
            const heightKm = (bboxHeight * Math.PI / 180) * EARTH_RADIUS_KM;
            
            // ë°”ìš´ë”© ë°•ìŠ¤ ë©´ì  ì¶”ì • (ì‹¤ì œ ë©´ì ë³´ë‹¤ í¼)
            actualAreaKm2 = widthKm * heightKm * 0.8; // 0.8 ë³´ì • ê³„ìˆ˜ ì ìš©
        }
        
        // ì‹¤ì œ ë©´ì ì„ ê¸°ë°˜ìœ¼ë¡œ í”½ì…€ í¬ê¸° ê³„ì‚°
        // ëª©í‘œ: ê° í”½ì…€ì´ ëŒ€ëµ ë™ì¼í•œ ë©´ì ì„ ê°€ì§
        const targetPixelAreaKm2 = actualAreaKm2 / (gridSize * gridSize);
        const pixelSideLengthKm = Math.sqrt(targetPixelAreaKm2);
        
        // í”½ì…€ í¬ê¸°ë¥¼ ê²½ë„/ìœ„ë„ ë‹¨ìœ„ë¡œ ë³€í™˜
        const avgLat = (minY + maxY) / 2;
        const latRad = avgLat * Math.PI / 180;
        const EARTH_RADIUS_KM = 6371;
        const latCorrection = Math.cos(latRad);
        
        // 1ë„ ê²½ë„ = ì•½ 111km * cos(ìœ„ë„)
        // 1ë„ ìœ„ë„ = ì•½ 111km
        const degreesPerKmLon = 1 / (111 * latCorrection);
        const degreesPerKmLAT = 1 / 111;
        
        // í”½ì…€ í¬ê¸°ë¥¼ ë„ ë‹¨ìœ„ë¡œ ë³€í™˜
        const cellSizeLon = pixelSideLengthKm * degreesPerKmLon;
        const cellSizeLat = pixelSideLengthKm * degreesPerKmLAT;
        
        // ì •ì‚¬ê°í˜• í”½ì…€ì„ ìœ„í•´ ë” ì‘ì€ ì…€ í¬ê¸° ì‚¬ìš©
        const cellSize = Math.min(cellSizeLon, cellSizeLat);
        
        // ê·¸ë¦¬ë“œê°€ ë°”ìš´ë”© ë°•ìŠ¤ë¥¼ ì™„ì „íˆ ì»¤ë²„í•˜ë„ë¡ í¬ê¸° ì¡°ì •
        const bboxWidth = maxX - minX;
        const bboxHeight = maxY - minY;
        const adjustedGridWidth = Math.ceil(bboxWidth / cellSize);
        const adjustedGridHeight = Math.ceil(bboxHeight / cellSize);
        
        const pixels = [];
        
        for (let row = 0; row < adjustedGridHeight; row++) {
            for (let col = 0; col < adjustedGridWidth; col++) {
                const cellCenterX = minX + (col + 0.5) * cellSize;
                const cellCenterY = minY + (row + 0.5) * cellSize;
                
                // ì…€ ì¤‘ì‹¬ì ì´ í–‰ì •êµ¬ì—­ ë‚´ë¶€ì— ìˆëŠ”ì§€ í™•ì¸
                const isInside = this.isPointInPolygon([cellCenterX, cellCenterY], feature.geometry);
                
                if (isInside) {
                    pixels.push({
                        id: `${row}-${col}`,
                        row,
                        col,
                        x: cellCenterX,
                        y: cellCenterY,
                        color: null,
                        bounds: {
                            minX: minX + col * cellSize,
                            minY: minY + row * cellSize,
                            maxX: minX + (col + 1) * cellSize,
                            maxY: minY + (row + 1) * cellSize
                        }
                    });
                }
            }
        }
        
        const regionId = feature.properties?.id || feature.properties?.regionId;
        const pixelCount = pixels.length;
        
        return {
            regionId,
            gridSize: adjustedGridWidth, // ì¡°ì •ëœ ê·¸ë¦¬ë“œ í¬ê¸°
            gridHeight: adjustedGridHeight,
            bbox,
            pixels,
            pixelCount: pixelCount, // í”½ì…€ ìˆ˜ ì¶”ê°€
            actualAreaKm2: actualAreaKm2, // ì‹¤ì œ ë©´ì  ì €ì¥
            cellSize, // ì •ì‚¬ê°í˜• ì…€ í¬ê¸° (cellWidth = cellHeight)
            cellWidth: cellSize, // í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
            cellHeight: cellSize // í˜¸í™˜ì„±ì„ ìœ„í•´ ìœ ì§€
        };
    }
    
    /**
     * Phase 1: í”½ì…€ ê·¸ë¦¬ë“œë¥¼ GeoJSONìœ¼ë¡œ ë³€í™˜
     */
    pixelGridToGeoJson(pixelGrid) {
        if (!pixelGrid || !pixelGrid.pixels) return null;
        
        const features = pixelGrid.pixels.map(pixel => {
            return {
                type: 'Feature',
                properties: {
                    id: pixel.id,
                    regionId: pixelGrid.regionId,
                    color: pixel.color || '#f0f0f0',
                    row: pixel.row,
                    col: pixel.col
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[
                        [pixel.bounds.minX, pixel.bounds.minY],
                        [pixel.bounds.maxX, pixel.bounds.minY],
                        [pixel.bounds.maxX, pixel.bounds.maxY],
                        [pixel.bounds.minX, pixel.bounds.maxY],
                        [pixel.bounds.minX, pixel.bounds.minY]
                    ]]
                }
            };
        });
        
        return {
            type: 'FeatureCollection',
            features
        };
    }
    
    /**
     * Phase 1: í”½ì…€ ê·¸ë¦¬ë“œ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥
     * Firebase ë¬¸ì„œ í¬ê¸° ì œí•œ(1MB)ì„ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì €ì¥
     */
    async savePixelGrid(regionId, pixelGrid) {
        if (!this.isFirebaseInitialized || !this.firestore) return;
        
        // ê¶Œí•œ í™•ì¸
        const hasPermission = await this.checkRegionOwnership(regionId);
        if (!hasPermission && !this.isAdminLoggedIn) {
            // ê¶Œí•œì´ ì—†ìœ¼ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ (ì¡°ìš©íˆ ë¬´ì‹œ)
            return;
        }
        
        try {
            const { doc, setDoc, collection, writeBatch, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const pixelCount = pixelGrid.pixels ? pixelGrid.pixels.length : 0;
            const calculatedPrice = this.calculateStartingPriceFromPixels(pixelCount);
            
            // í”½ì…€ ë°ì´í„°ë¥¼ ì••ì¶•ëœ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            const compressedPixels = this.compressPixelData(pixelGrid.pixels);
            
            // Firebase ë¬¸ì„œ í¬ê¸° ì œí•œ: 1MB (1,048,576 bytes)
            // ì•ˆì „ ë§ˆì§„ì„ ê³ ë ¤í•˜ì—¬ ì²­í¬ë‹¹ ìµœëŒ€ 8,000ê°œ í”½ì…€ ì €ì¥ (ì•½ 800KB)
            const CHUNK_SIZE = 8000;
            const chunks = [];
            
            for (let i = 0; i < compressedPixels.length; i += CHUNK_SIZE) {
                chunks.push(compressedPixels.slice(i, i + CHUNK_SIZE));
            }
            
            // ë©”íƒ€ë°ì´í„° ë¬¸ì„œ ì €ì¥ (í”½ì…€ ë°ì´í„°ëŠ” ì œì™¸)
            const gridRef = doc(this.firestore, 'pixelGrids', regionId);
            await setDoc(gridRef, {
                gridSize: pixelGrid.gridSize,
                gridHeight: pixelGrid.gridHeight,
                bbox: pixelGrid.bbox,
                cellWidth: pixelGrid.cellWidth,
                cellHeight: pixelGrid.cellHeight,
                pixelCount: pixelCount,
                calculatedPrice: calculatedPrice,
                // ë°ì´í„° í˜•ì‹ ë²„ì „ (ì²­í¬ í˜•ì‹)
                dataFormat: 'chunked_v3',
                chunkCount: chunks.length,
                createdAt: serverTimestamp(),
                updatedAt: serverTimestamp()
            }, { merge: true });
            
            // í”½ì…€ ë°ì´í„°ë¥¼ ì²­í¬ë¡œ ë‚˜ëˆ„ì–´ ì„œë¸Œì»¬ë ‰ì…˜ì— ì €ì¥
            if (chunks.length > 0) {
                const pixelsRef = collection(this.firestore, 'pixelGrids', regionId, 'chunks');
                
                // ê¸°ì¡´ ì²­í¬ ì‚­ì œ (ì „ì²´ ì¬ì €ì¥)
                const existingChunksRef = collection(this.firestore, 'pixelGrids', regionId, 'chunks');
                const { getDocs, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const existingChunks = await getDocs(existingChunksRef);
                const deleteBatch = writeBatch(this.firestore);
                existingChunks.forEach(chunkDoc => {
                    deleteBatch.delete(chunkDoc.ref);
                });
                await deleteBatch.commit();
                
                // ìƒˆ ì²­í¬ ì €ì¥ (ë°°ì¹˜ë¡œ ì²˜ë¦¬)
                const batchSize = 500; // Firestore ë°°ì¹˜ ì œí•œ: 500ê°œ
                for (let i = 0; i < chunks.length; i += batchSize) {
                    const batch = writeBatch(this.firestore);
                    const batchChunks = chunks.slice(i, i + batchSize);
                    
                    batchChunks.forEach((chunk, chunkIndex) => {
                        const chunkRef = doc(pixelsRef, `chunk_${i + chunkIndex}`);
                        batch.set(chunkRef, {
                            index: i + chunkIndex,
                            pixels: chunk,
                            createdAt: serverTimestamp()
                        });
                    });
                    
                    await batch.commit();
                }
            }
            
            console.log(`[í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ ì™„ë£Œ] ${regionId}: ${pixelCount}ê°œ í”½ì…€ (${chunks.length}ê°œ ì²­í¬)`);
        } catch (error) {
            // ê¶Œí•œ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
            if (error.code !== 'permission-denied') {
                console.error(`[í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ ì‹¤íŒ¨] ${regionId}:`, error);
                
                // ë¬¸ì„œ í¬ê¸° ì´ˆê³¼ ì˜¤ë¥˜ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                if (error.message?.includes('exceeds the maximum allowed size') || error.code === 'invalid-argument') {
                    console.error(`[í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ ì‹¤íŒ¨] ë¬¸ì„œ í¬ê¸° ì œí•œ ì´ˆê³¼: ${regionId}`);
                    this.showNotification('í”½ì…€ ê·¸ë¦¬ë“œê°€ ë„ˆë¬´ ì»¤ì„œ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.', 'error');
                }
            }
        }
    }
    
    /**
     * í”½ì…€ ë°ì´í„°ë¥¼ ì••ì¶•ëœ í˜•ì‹ìœ¼ë¡œ ë³€í™˜
     * ê° í”½ì…€ì˜ í•„ìˆ˜ ì •ë³´ë§Œ ì €ì¥í•˜ì—¬ ë°ì´í„° í¬ê¸° ìµœì†Œí™”
     */
    compressPixelData(pixels) {
        if (!pixels || pixels.length === 0) return [];
        
        return pixels.map(pixel => ({
            id: pixel.id,
            r: pixel.row,
            c: pixel.col,
            x: pixel.x,
            y: pixel.y,
            clr: pixel.color || null // ìƒ‰ìƒì´ nullì´ë©´ ê¸°ë³¸ê°’
        }));
    }
    
    /**
     * ì••ì¶•ëœ í”½ì…€ ë°ì´í„°ë¥¼ ì›ë˜ í˜•ì‹ìœ¼ë¡œ ë³µì›
     */
    decompressPixelData(compressedPixels, gridData) {
        if (!compressedPixels || compressedPixels.length === 0) return [];
        
        const cellWidth = gridData.cellWidth || gridData.cellSize || 0.001;
        const cellHeight = gridData.cellHeight || gridData.cellSize || 0.001;
        
        return compressedPixels.map(p => ({
            id: p.id,
            row: p.r,
            col: p.c,
            x: p.x,
            y: p.y,
            color: p.clr || null,
            bounds: {
                minX: p.x - cellWidth / 2,
                minY: p.y - cellHeight / 2,
                maxX: p.x + cellWidth / 2,
                maxY: p.y + cellHeight / 2
            }
        }));
    }
    
    /**
     * í”½ì…€ ìˆ˜ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ê²½ë§¤ ì‹œì‘ê°€ê²© ê³„ì‚°
     * @param {number} pixelCount - í”½ì…€ ìˆ˜
     * @returns {number} ê³„ì‚°ëœ ì‹œì‘ê°€ê²© (USD)
     */
    calculateStartingPriceFromPixels(pixelCount) {
        if (!pixelCount || pixelCount <= 0) {
            return 1.0; // ìµœì†Œ ì‹œì‘ê°€ê²© 1ë‹¬ëŸ¬
        }
        const calculatedPrice = pixelCount * this.PIXEL_PRICE_PER_UNIT;
        // ìµœì†Œ ì‹œì‘ê°€ê²© 1ë‹¬ëŸ¬ ë³´ì¥
        return Math.max(calculatedPrice, 1.0);
    }
    
    /**
     * ì§€ì—­ì˜ í”½ì…€ ìˆ˜ë¥¼ ê°€ì ¸ì™€ì„œ ì‹œì‘ê°€ê²© ê³„ì‚°
     * @param {string} regionId - ì§€ì—­ ID
     * @returns {Promise<number>} ê³„ì‚°ëœ ì‹œì‘ê°€ê²© (USD)
     */
    async getStartingPriceForRegion(regionId) {
        try {
            // ë¨¼ì € ë©”ëª¨ë¦¬ì—ì„œ í”½ì…€ ê·¸ë¦¬ë“œ í™•ì¸
            let pixelGrid = this.pixelGrids.get(regionId);
            
            if (!pixelGrid) {
                // Firestoreì—ì„œ ë¡œë“œ ì‹œë„
                pixelGrid = await this.loadPixelGrid(regionId);
            }
            
            if (pixelGrid && pixelGrid.pixelCount) {
                return this.calculateStartingPriceFromPixels(pixelGrid.pixelCount);
            }
            
            // í”½ì…€ ê·¸ë¦¬ë“œê°€ ì—†ìœ¼ë©´ GeoJSONì—ì„œ ìƒì„± ì‹œë„
            const source = this.map?.getSource('world-regions');
            if (source && source._data) {
                const feature = source._data.features.find(f => 
                    (f.properties?.id === regionId) || (f.properties?.regionId === regionId)
                );
                if (feature) {
                    pixelGrid = this.createPixelGrid(feature, this.pixelGridGridSize);
                    if (pixelGrid && pixelGrid.pixels) {
                        const pixelCount = pixelGrid.pixels.length;
                        // í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ (ë¹„ë™ê¸°, ê²°ê³¼ ê¸°ë‹¤ë¦¬ì§€ ì•ŠìŒ)
                        this.savePixelGrid(regionId, pixelGrid).catch(err => {
                            console.warn(`[ì‹œì‘ê°€ê²© ê³„ì‚°] í”½ì…€ ê·¸ë¦¬ë“œ ì €ì¥ ì‹¤íŒ¨ (ë¬´ì‹œ):`, err);
                        });
                        return this.calculateStartingPriceFromPixels(pixelCount);
                    }
                }
            }
            
            // ëª¨ë“  ë°©ë²•ì´ ì‹¤íŒ¨í•˜ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
            return 1.0;
        } catch (error) {
            console.error(`[ì‹œì‘ê°€ê²© ê³„ì‚° ì‹¤íŒ¨] ${regionId}:`, error);
            return 1.0; // ê¸°ë³¸ê°’ ë°˜í™˜
        }
    }
    
    /**
     * Phase 1: Firestoreì—ì„œ í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ (ì„±ëŠ¥ ìµœì í™” ë²„ì „)
     * ìƒˆë¡œìš´ ì••ì¶• í˜•ì‹ê³¼ ê¸°ì¡´ ê°œë³„ ë¬¸ì„œ í˜•ì‹ ëª¨ë‘ ì§€ì›
     */
    async loadPixelGrid(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) return null;
        
        try {
            const { doc, getDoc, getDocFromCache, collection, getDocs, getDocsFromCache } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ë©”íƒ€ë°ì´í„° ë¡œë“œ (í•˜ë‚˜ì˜ ë¬¸ì„œë§Œ ì½ìŒ - ë§¤ìš° ë¹ ë¦„!)
            const gridRef = doc(this.firestore, 'pixelGrids', regionId);
            let gridDoc;
            
            // ë¨¼ì € ì„œë²„ì—ì„œ ì½ê¸°ë¥¼ ì‹œë„í•˜ê³ , ì˜¤ë¥˜ê°€ ë°œìƒí•˜ë©´ ìºì‹œì—ì„œ ì½ê¸° ì‹œë„
            try {
                gridDoc = await getDoc(gridRef);
            } catch (error) {
                // ì˜¤í”„ë¼ì¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ì˜¤ë¥˜ì¸ ê²½ìš° ìºì‹œì—ì„œ ì½ê¸° ì‹œë„
                if (error.code === 'unavailable' || error.code === 'resource-exhausted' || error.message?.includes('offline') || error.message?.includes('Too many outstanding requests')) {
                    try {
                        gridDoc = await getDocFromCache(gridRef);
                    } catch (cacheError) {
                        // ìºì‹œì—ë„ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
                        return null;
                    }
                } else {
                    // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                    return null;
                }
            }
            
            if (!gridDoc.exists()) return null;
            
            const gridData = gridDoc.data();
            let pixels = [];
            
            // ì²­í¬ í˜•ì‹ í™•ì¸ (ìµœì‹  í˜•ì‹ - ë¬¸ì„œ í¬ê¸° ì œí•œ í•´ê²°)
            if (gridData.dataFormat === 'chunked_v3' && gridData.chunkCount > 0) {
                // âœ… ì²­í¬ í˜•ì‹: ì„œë¸Œì»¬ë ‰ì…˜ì—ì„œ ì²­í¬ë¥¼ ì½ì–´ì„œ í•©ì¹˜ê¸°
                console.log(`[í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ] ${regionId}: ì²­í¬ í˜•ì‹ ì‚¬ìš© (${gridData.chunkCount}ê°œ ì²­í¬)`);
                const chunksRef = collection(this.firestore, 'pixelGrids', regionId, 'chunks');
                let chunksSnapshot;
                
                try {
                    chunksSnapshot = await getDocs(chunksRef);
                } catch (error) {
                    // ì˜¤í”„ë¼ì¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ì˜¤ë¥˜ì¸ ê²½ìš° ìºì‹œì—ì„œ ì½ê¸° ì‹œë„
                    if (error.code === 'unavailable' || error.code === 'resource-exhausted' || error.message?.includes('offline') || error.message?.includes('Too many outstanding requests')) {
                        try {
                            chunksSnapshot = await getDocsFromCache(chunksRef);
                        } catch (cacheError) {
                            // ìºì‹œì—ë„ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
                            return null;
                        }
                    } else {
                        // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                        return null;
                    }
                }
                
                // ì²­í¬ë¥¼ ì¸ë±ìŠ¤ ìˆœì„œë¡œ ì •ë ¬í•˜ì—¬ í•©ì¹˜ê¸°
                const chunks = [];
                chunksSnapshot.forEach(chunkDoc => {
                    const chunkData = chunkDoc.data();
                    chunks.push({
                        index: chunkData.index || 0,
                        pixels: chunkData.pixels || []
                    });
                });
                
                // ì¸ë±ìŠ¤ ìˆœì„œë¡œ ì •ë ¬
                chunks.sort((a, b) => a.index - b.index);
                
                // ëª¨ë“  ì²­í¬ì˜ í”½ì…€ì„ í•©ì¹˜ê¸°
                const allCompressedPixels = [];
                chunks.forEach(chunk => {
                    if (Array.isArray(chunk.pixels)) {
                        allCompressedPixels.push(...chunk.pixels);
                    }
                });
                
                // ì••ì¶•ëœ í”½ì…€ ë°ì´í„°ë¥¼ ì›ë˜ í˜•ì‹ìœ¼ë¡œ ë³µì›
                pixels = this.decompressPixelData(allCompressedPixels, gridData);
                console.log(`[í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ] ${regionId}: ${pixels.length}ê°œ í”½ì…€ ë¡œë“œ ì™„ë£Œ`);
            }
            // ê¸°ì¡´ ì••ì¶• í˜•ì‹ í™•ì¸ (í•˜ìœ„ í˜¸í™˜ì„±)
            else if (gridData.dataFormat === 'compressed_v2' && Array.isArray(gridData.pixels)) {
                // âœ… ì••ì¶• í˜•ì‹: í•˜ë‚˜ì˜ ë¬¸ì„œì— ëª¨ë“  í”½ì…€ ë°ì´í„° í¬í•¨ (ë§¤ìš° ë¹ ë¦„!)
                pixels = this.decompressPixelData(gridData.pixels, gridData);
                console.log(`[í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ] ${regionId}: ì••ì¶• í˜•ì‹ ì‚¬ìš© (${pixels.length}ê°œ í”½ì…€)`);
            } else {
                // ê¸°ì¡´ í˜•ì‹: ê°œë³„ ë¬¸ì„œì—ì„œ ë¡œë“œ (í•˜ìœ„ í˜¸í™˜ì„±)
                console.log(`[í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ] ${regionId}: ê¸°ì¡´ í˜•ì‹ ì‚¬ìš© (ëŠë¦´ ìˆ˜ ìˆìŒ)`);
                const pixelsRef = collection(this.firestore, 'pixelGrids', regionId, 'pixels');
                let pixelsSnapshot;
                
                try {
                    pixelsSnapshot = await getDocs(pixelsRef);
                } catch (error) {
                    // ì˜¤í”„ë¼ì¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ì˜¤ë¥˜ì¸ ê²½ìš° ìºì‹œì—ì„œ ì½ê¸° ì‹œë„
                    if (error.code === 'unavailable' || error.code === 'resource-exhausted' || error.message?.includes('offline') || error.message?.includes('Too many outstanding requests')) {
                        try {
                            pixelsSnapshot = await getDocsFromCache(pixelsRef);
                        } catch (cacheError) {
                            // ìºì‹œì—ë„ ì—†ìœ¼ë©´ ì¡°ìš©íˆ ë¬´ì‹œ
                            return null;
                        }
                    } else {
                        // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ
                        return null;
                    }
                }
                
                pixelsSnapshot.forEach(doc => {
                    const data = doc.data();
                    pixels.push({
                        id: data.id,
                        row: data.row,
                        col: data.col,
                        x: data.x,
                        y: data.y,
                        color: data.color || null,
                        bounds: {
                            minX: data.x - (gridData.cellWidth || 0.001) / 2,
                            minY: data.y - (gridData.cellHeight || 0.001) / 2,
                            maxX: data.x + (gridData.cellWidth || 0.001) / 2,
                            maxY: data.y + (gridData.cellHeight || 0.001) / 2
                        }
                    });
                });
            }
            
            return {
                regionId,
                gridSize: gridData.gridSize,
                gridHeight: gridData.gridHeight,
                bbox: gridData.bbox,
                pixels,
                pixelCount: gridData.pixelCount || pixels.length,
                calculatedPrice: gridData.calculatedPrice || null,
                cellWidth: gridData.cellWidth,
                cellHeight: gridData.cellHeight
            };
        } catch (error) {
            // ì˜¤í”„ë¼ì¸ ë˜ëŠ” ë¦¬ì†ŒìŠ¤ ê³ ê°ˆ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ ë¬´ì‹œ (ì •ìƒì ì¸ ìƒí™©)
            // ë‹¤ë¥¸ ì˜¤ë¥˜ë§Œ ì½˜ì†”ì— ì¶œë ¥
            if (error.code !== 'unavailable' && error.code !== 'resource-exhausted' && 
                !error.message?.includes('offline') && !error.message?.includes('Too many outstanding requests')) {
                console.error(`[í”½ì…€ ê·¸ë¦¬ë“œ ë¡œë“œ ì‹¤íŒ¨] ${regionId}:`, error);
            }
            return null;
        }
    }
    
    /**
     * Phase 1: í”½ì…€ ê·¸ë¦¬ë“œ ë ˆì´ì–´ ì¶”ê°€/ì—…ë°ì´íŠ¸
     * ì´ˆê¸° ë¡œë“œ ì‹œì—ëŠ” ê·¸ë¦¬ë“œë¥¼ ìƒì„±í•˜ì§€ ì•Šê³ , í¸ì§‘ ëª¨ë“œì—ì„œë§Œ ìƒì„±
     */
    async setupPixelGridLayer(geoJson) {
        if (!this.map || !geoJson) return;
        
        // ì´ˆê¸° ë¡œë“œ ì‹œì—ëŠ” ë¹ˆ GeoJSONìœ¼ë¡œ ë ˆì´ì–´ë§Œ ìƒì„±
        // ì‹¤ì œ ê·¸ë¦¬ë“œëŠ” í¸ì§‘ ëª¨ë“œì—ì„œ í•„ìš”í•  ë•Œ ìƒì„±
        const emptyGeoJson = {
            type: 'FeatureCollection',
            features: []
        };
        
        // Mapbox ì†ŒìŠ¤ ë° ë ˆì´ì–´ ì¶”ê°€
        if (!this.map.getSource('pixel-grids')) {
            this.map.addSource('pixel-grids', {
                type: 'geojson',
                data: emptyGeoJson
            });
            
            this.map.addLayer({
                id: 'pixel-grids-fill',
                type: 'fill',
                source: 'pixel-grids',
                paint: {
                    'fill-color': ['get', 'color'],
                    'fill-opacity': 0.9
                }
            });
            
            this.map.addLayer({
                id: 'pixel-grids-border',
                type: 'line',
                source: 'pixel-grids',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': this.showPixelGridLines ? 0.5 : 0,
                    'line-opacity': 0.3
                }
            });
        }
    }
    
    /**
     * Phase 2: í”½ì…€ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
     */
    setupPixelClickHandlers() {
        if (!this.map) return;
        
        // í”½ì…€ í´ë¦­ ì‹œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ í‘œì‹œ ë˜ëŠ” ë°”ë¡œ ìƒ‰ì¹ 
        this.map.on('click', 'pixel-grids-fill', async (e) => {
            // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨ (í–‰ì •êµ¬ì—­ í´ë¦­ ì´ë²¤íŠ¸ê°€ ë°œìƒí•˜ì§€ ì•Šë„ë¡)
            e.originalEvent?.stopPropagation();
            e.preventDefault();
            
            const pixel = e.features[0];
            const pixelId = pixel.properties.id;
            const regionId = pixel.properties.regionId;
            
            // ê¶Œí•œ í™•ì¸
            const hasPermission = await this.checkRegionOwnership(regionId);
            if (!hasPermission && !this.isAdminLoggedIn) {
                this.showNotification('ì´ ì§€ì—­ì˜ ì†Œìœ ìë§Œ í¸ì§‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            // í”½ì…€ í¸ì§‘ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´ ì„ íƒëœ ìƒ‰ìƒìœ¼ë¡œ ë°”ë¡œ ìƒ‰ì¹ 
            if (this.isPixelEditMode) {
                // í˜„ì¬ ì„ íƒëœ ìƒ‰ìƒ ê°€ì ¸ì˜¤ê¸° (í”½ì…€ ì—ë””í„° ë˜ëŠ” ê¸°ë³¸ ìƒ‰ìƒ)
                const selectedColor = this.pixelEditor?.currentColor || this.currentPixelColor || '#FF0000';
                await this.colorPixel(pixelId, regionId, selectedColor);
                // ì‹œê°ì  í”¼ë“œë°±: ì§§ì€ ì•Œë¦¼
                this.showNotification('í”½ì…€ ìƒ‰ì¹  ì™„ë£Œ', 'success', 1000);
            } else {
                // ëª¨ë‹¬ì´ ë‹«í˜€ìˆì„ ë•Œë§Œ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ í‘œì‹œ
                this.showColorPalette(e.lngLat, pixelId, regionId);
            }
        });
        
        // ë“œë˜ê·¸ë¡œ ì—¬ëŸ¬ í”½ì…€ ìƒ‰ì¹ 
        this.map.on('mousedown', 'pixel-grids-fill', async (e) => {
            // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
            e.originalEvent?.stopPropagation();
            e.preventDefault();
            
            const pixel = e.features[0];
            const regionId = pixel.properties.regionId;
            
            const hasPermission = await this.checkRegionOwnership(regionId);
            if (!hasPermission && !this.isAdminLoggedIn) return;
            
            this.isPixelDrawing = true;
            this.selectedPixels.clear();
            const pixelId = pixel.properties.id;
            this.selectedPixels.add(pixelId);
            await this.colorPixel(pixelId, regionId, this.currentPixelColor);
        });
        
        this.map.on('mousemove', 'pixel-grids-fill', async (e) => {
            if (this.isPixelDrawing) {
                // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ë‹¨
                e.originalEvent?.stopPropagation();
                
                const pixel = e.features[0];
                const pixelId = pixel.properties.id;
                const regionId = pixel.properties.regionId;
                
                if (!this.selectedPixels.has(pixelId)) {
                    this.selectedPixels.add(pixelId);
                    await this.colorPixel(pixelId, regionId, this.currentPixelColor);
                }
            }
        });
        
        this.map.on('mouseup', () => {
            this.isPixelDrawing = false;
            this.selectedPixels.clear();
        });
        
        // í”½ì…€ í˜¸ë²„ íš¨ê³¼
        this.map.on('mousemove', 'pixel-grids-fill', (e) => {
            this.map.getCanvas().style.cursor = 'pointer';
        });
        
        this.map.on('mouseleave', 'pixel-grids-fill', () => {
            this.map.getCanvas().style.cursor = '';
        });
    }
    
    /**
     * Phase 2: ìƒ‰ìƒ íŒ”ë ˆíŠ¸ í‘œì‹œ
     */
    showColorPalette(lngLat, pixelId, regionId) {
        const palette = document.createElement('div');
        palette.className = 'pixel-color-palette';
        palette.style.cssText = `
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        `;
        
        const colors = [
            '#FF0000', '#00FF00', '#0000FF', '#FFFF00',
            '#FF00FF', '#00FFFF', '#FFFFFF', '#000000',
            '#FFA500', '#800080', '#FFC0CB', '#A52A2A',
            '#808080', '#FFD700', '#00CED1', '#FF1493'
        ];
        
        colors.forEach(color => {
            const colorBtn = document.createElement('button');
            colorBtn.className = 'color-option';
            colorBtn.style.cssText = `
                width: 40px;
                height: 40px;
                background: ${color};
                border: 2px solid ${color === '#FFFFFF' ? '#ccc' : 'transparent'};
                border-radius: 4px;
                cursor: pointer;
                transition: transform 0.2s;
            `;
            colorBtn.dataset.color = color;
            colorBtn.title = color;
            
            colorBtn.addEventListener('mouseenter', () => {
                colorBtn.style.transform = 'scale(1.1)';
            });
            colorBtn.addEventListener('mouseleave', () => {
                colorBtn.style.transform = 'scale(1)';
            });
            
            colorBtn.addEventListener('click', async () => {
                await this.colorPixel(pixelId, regionId, color);
                if (popup) popup.remove();
            });
            
            palette.appendChild(colorBtn);
        });
        
        // ì»¤ìŠ¤í…€ ìƒ‰ìƒ í”¼ì»¤ ì¶”ê°€
        const customColorWrapper = document.createElement('div');
        customColorWrapper.style.cssText = 'grid-column: 1 / -1; margin-top: 8px;';
        const colorPicker = document.createElement('input');
        colorPicker.type = 'color';
        colorPicker.value = this.currentPixelColor;
        colorPicker.style.cssText = 'width: 100%; height: 40px; cursor: pointer;';
        colorPicker.addEventListener('change', async (e) => {
            await this.colorPixel(pixelId, regionId, e.target.value);
            if (popup) popup.remove();
        });
        customColorWrapper.appendChild(colorPicker);
        palette.appendChild(customColorWrapper);
        
        const popup = new mapboxgl.Popup({
            closeOnClick: true,
            closeButton: true,
            anchor: 'bottom'
        })
            .setLngLat(lngLat)
            .setDOMContent(palette)
            .addTo(this.map);
    }
    
    /**
     * ìƒ‰ìƒ ì„¤ì • (í†µí•© í•¨ìˆ˜)
     */
    setPixelColor(color) {
        if (!color || !/^#[0-9A-Fa-f]{6}$/.test(color)) return;
        
        this.pixelEditor.currentColor = color;
        this.currentPixelColor = color;
        
        // ìƒ‰ìƒ í”¼ì»¤ ì—…ë°ì´íŠ¸
        const colorPicker = document.getElementById('pixel-color-picker');
        if (colorPicker) colorPicker.value = color;
        
        // í˜„ì¬ ìƒ‰ìƒ í‘œì‹œ ì—…ë°ì´íŠ¸
        this.updateCurrentColorDisplay(color);
        
        // ìµœê·¼ ì‚¬ìš© ìƒ‰ìƒì— ì¶”ê°€
        this.addRecentColor(color);
    }
    
    /**
     * í˜„ì¬ ìƒ‰ìƒ í‘œì‹œ ì—…ë°ì´íŠ¸ (RGB í¬í•¨)
     */
    updateCurrentColorDisplay(color) {
        // current-pixel-color ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        const currentPixelColorInput = document.getElementById('current-pixel-color');
        if (currentPixelColorInput) {
            currentPixelColorInput.value = color;
        }
        
        // HEX ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        const colorHexInput = document.getElementById('color-hex-input');
        if (colorHexInput) {
            colorHexInput.value = color.toUpperCase();
        }
        
        // RGB í‘œì‹œ ì—…ë°ì´íŠ¸
        const colorRgbDisplay = document.getElementById('color-rgb-display');
        if (colorRgbDisplay) {
            const rgb = this.hexToRgb(color);
            if (rgb) {
                colorRgbDisplay.textContent = `RGB(${rgb.r}, ${rgb.g}, ${rgb.b})`;
            }
        }
        
        // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        const colorPreview = document.getElementById('color-preview');
        if (colorPreview) {
            colorPreview.style.background = color;
        }
    }
    
    /**
     * HEXë¥¼ RGBë¡œ ë³€í™˜
     */
    hexToRgb(hex) {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
        } : null;
    }
    
    /**
     * ìµœê·¼ ì‚¬ìš© ìƒ‰ìƒ ì¶”ê°€
     */
    addRecentColor(color) {
        // ì´ë¯¸ ìˆìœ¼ë©´ ì œê±°
        this.recentColors = this.recentColors.filter(c => c !== color);
        // ë§¨ ì•ì— ì¶”ê°€
        this.recentColors.unshift(color);
        // ìµœëŒ€ 8ê°œë§Œ ìœ ì§€
        this.recentColors = this.recentColors.slice(0, 8);
        // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥
        localStorage.setItem('pixelRecentColors', JSON.stringify(this.recentColors));
        // UI ì—…ë°ì´íŠ¸
        this.updateRecentColors();
    }
    
    /**
     * ìµœê·¼ ì‚¬ìš© ìƒ‰ìƒ UI ì—…ë°ì´íŠ¸
     */
    updateRecentColors() {
        const recentColorsContainer = document.getElementById('recent-colors');
        if (!recentColorsContainer) return;
        
        recentColorsContainer.innerHTML = '';
        
        if (this.recentColors.length === 0) {
            const emptySlot = document.createElement('div');
            emptySlot.className = 'color-preset empty-slot';
            emptySlot.title = 'ìµœê·¼ ì‚¬ìš©í•œ ìƒ‰ìƒì´ ì—†ìŠµë‹ˆë‹¤';
            emptySlot.textContent = '+';
            recentColorsContainer.appendChild(emptySlot);
            return;
        }
        
        this.recentColors.forEach(color => {
            const preset = document.createElement('div');
            preset.className = 'color-preset';
            preset.dataset.color = color;
            preset.style.background = color;
            preset.title = color;
            preset.addEventListener('click', (e) => {
                this.setPixelColor(color);
                document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
                preset.classList.add('selected');
            });
            recentColorsContainer.appendChild(preset);
        });
    }
    
    /**
     * í”½ì…€ í¸ì§‘ íˆìŠ¤í† ë¦¬ ì €ì¥
     */
    savePixelHistory() {
        if (!this.pixelEditor || !this.pixelEditor.canvas) return;
        
        const imageData = this.pixelEditor.canvas.toDataURL('image/png');
        // í˜„ì¬ ì¸ë±ìŠ¤ ì´í›„ì˜ íˆìŠ¤í† ë¦¬ ì œê±° (ìƒˆë¡œìš´ í¸ì§‘ ì‹œì‘)
        this.pixelHistory = this.pixelHistory.slice(0, this.pixelHistoryIndex + 1);
        // ìƒˆ íˆìŠ¤í† ë¦¬ ì¶”ê°€
        this.pixelHistory.push(imageData);
        // ìµœëŒ€ í¬ê¸° ì œí•œ
        if (this.pixelHistory.length > this.maxHistorySize) {
            this.pixelHistory.shift();
        } else {
            this.pixelHistoryIndex++;
        }
        
        // ì‹¤í–‰ ì·¨ì†Œ/ë‹¤ì‹œ ì‹¤í–‰ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        this.updateHistoryButtons();
    }
    
    /**
     * ì‹¤í–‰ ì·¨ì†Œ
     */
    undoPixelEdit() {
        if (this.pixelHistoryIndex <= 0) return;
        
        this.pixelHistoryIndex--;
        this.loadPixelHistory(this.pixelHistory[this.pixelHistoryIndex]);
        this.updateHistoryButtons();
    }
    
    /**
     * ë‹¤ì‹œ ì‹¤í–‰
     */
    redoPixelEdit() {
        if (this.pixelHistoryIndex >= this.pixelHistory.length - 1) return;
        
        this.pixelHistoryIndex++;
        this.loadPixelHistory(this.pixelHistory[this.pixelHistoryIndex]);
        this.updateHistoryButtons();
    }
    
    /**
     * íˆìŠ¤í† ë¦¬ì—ì„œ ì´ë¯¸ì§€ ë¡œë“œ
     */
    loadPixelHistory(imageData) {
        if (!this.pixelEditor || !this.pixelEditor.canvas || !this.pixelEditor.ctx) return;
        
        const img = new Image();
        img.onload = () => {
            this.pixelEditor.ctx.clearRect(0, 0, this.pixelEditor.canvasSize, this.pixelEditor.canvasSize);
            this.pixelEditor.ctx.drawImage(img, 0, 0);
        };
        img.src = imageData;
    }
    
    /**
     * íˆìŠ¤í† ë¦¬ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
     */
    updateHistoryButtons() {
        const undoBtn = document.getElementById('pixel-undo-btn');
        const redoBtn = document.getElementById('pixel-redo-btn');
        
        if (undoBtn) {
            undoBtn.disabled = this.pixelHistoryIndex <= 0;
        }
        if (redoBtn) {
            redoBtn.disabled = this.pixelHistoryIndex >= this.pixelHistory.length - 1;
        }
    }
    
    /**
     * í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤ ì„¤ì •
     */
    setupPixelKeyboardShortcuts() {
        document.addEventListener('keydown', (e) => {
            // í”½ì…€ í¸ì§‘ ëª¨ë‹¬ì´ ì—´ë ¤ìˆì„ ë•Œë§Œ ì‘ë™
            const pixelStudioModal = document.getElementById('pixel-studio-modal');
            if (!pixelStudioModal || pixelStudioModal.classList.contains('hidden')) return;
            
            // ë‹¨ì¶•í‚¤ ê°€ì´ë“œ ëª¨ë‹¬ ì—´ê¸°
            if (e.key === '?' && !e.ctrlKey && !e.altKey && !e.shiftKey) {
                e.preventDefault();
                const shortcutsModal = document.getElementById('pixel-shortcuts-modal');
                if (shortcutsModal) {
                    shortcutsModal.classList.toggle('hidden');
                }
                return;
            }
            
            // Ctrl í‚¤ ì¡°í•©
            if (e.ctrlKey || e.metaKey) {
                // ì‹¤í–‰ ì·¨ì†Œ
                if (e.key === 'z' && !e.shiftKey) {
                    e.preventDefault();
                    this.undoPixelEdit();
                    return;
                }
                // ë‹¤ì‹œ ì‹¤í–‰
                if ((e.key === 'y' || (e.key === 'z' && e.shiftKey)) && !e.altKey) {
                    e.preventDefault();
                    this.redoPixelEdit();
                    return;
                }
                // ì €ì¥
                if (e.key === 's') {
                    e.preventDefault();
                    this.savePixelCanvas();
                    return;
                }
            }
            
            // ë„êµ¬ ì„ íƒ (P, E, F, S)
            if (!e.ctrlKey && !e.altKey && !e.shiftKey) {
                if (e.key === 'p' || e.key === 'P') {
                    e.preventDefault();
                    this.setPixelTool('pencil');
                    return;
                }
                if (e.key === 'e' || e.key === 'E') {
                    e.preventDefault();
                    this.setPixelTool('eraser');
                    return;
                }
                if (e.key === 'f' || e.key === 'F') {
                    e.preventDefault();
                    this.setPixelTool('fill');
                    return;
                }
                if (e.key === 's' || e.key === 'S') {
                    e.preventDefault();
                    this.setPixelTool('sticker');
                    return;
                }
                // ìƒ‰ìƒ í”¼ì»¤ ì—´ê¸°
                if (e.key === 'c' || e.key === 'C') {
                    e.preventDefault();
                    const colorPicker = document.getElementById('pixel-color-picker');
                    if (colorPicker) {
                        colorPicker.click();
                    }
                    return;
                }
                
                // Phase 8: ìˆ«ì í‚¤ë¡œ ê¸°ë³¸ ìƒ‰ìƒ í”„ë¦¬ì…‹ ì„ íƒ (1-8)
                const numKey = parseInt(e.key);
                if (numKey >= 1 && numKey <= 8) {
                    e.preventDefault();
                    this.selectColorPresetByNumber(numKey);
                    return;
                }
            }
            
            // ESCë¡œ ëª¨ë‹¬ ë‹«ê¸°
            if (e.key === 'Escape') {
                const shortcutsModal = document.getElementById('pixel-shortcuts-modal');
                if (shortcutsModal && !shortcutsModal.classList.contains('hidden')) {
                    shortcutsModal.classList.add('hidden');
                    return;
                }
            }
        });
    }
    
    /**
     * Phase 8: ìˆ«ì í‚¤ë¡œ ìƒ‰ìƒ í”„ë¦¬ì…‹ ì„ íƒ
     */
    selectColorPresetByNumber(num) {
        // ê¸°ë³¸ ìƒ‰ìƒ í”„ë¦¬ì…‹ (index.htmlì— ì •ì˜ëœ ìˆœì„œëŒ€ë¡œ)
        const colorPresets = [
            '#FF0000', // 1: ë¹¨ê°•
            '#00FF00', // 2: ì´ˆë¡
            '#0000FF', // 3: íŒŒë‘
            '#FFFF00', // 4: ë…¸ë‘
            '#FF00FF', // 5: ë§ˆì  íƒ€
            '#00FFFF', // 6: ì‹œì•ˆ
            '#FFFFFF', // 7: í°ìƒ‰
            '#000000'  // 8: ê²€ì •
        ];
        
        if (num >= 1 && num <= 8) {
            const color = colorPresets[num - 1];
            this.currentPixelColor = color;
            
            // í”½ì…€ ì—ë””í„°ì—ë„ ë™ê¸°í™”
            if (this.pixelEditor) {
                this.pixelEditor.currentColor = color;
            }
            
            // UI ì—…ë°ì´íŠ¸
            const colorPicker = document.getElementById('pixel-color-picker');
            if (colorPicker) {
                colorPicker.value = color;
            }
            
            const hexInput = document.getElementById('color-hex-input');
            if (hexInput) {
                hexInput.value = color;
            }
            
            const currentPixelColorInput = document.getElementById('current-pixel-color');
            if (currentPixelColorInput) {
                currentPixelColorInput.value = color;
            }
            
            // í”„ë¦¬ì…‹ ì‹œê°ì  í”¼ë“œë°±
            const presetElements = document.querySelectorAll('.color-preset[data-color]');
            presetElements.forEach(preset => {
                preset.classList.remove('selected');
                if (preset.dataset.color === color) {
                    preset.classList.add('selected');
                }
            });
            
            this.showNotification(`ìƒ‰ìƒ ì„ íƒ: ${color}`, 'info', 800);
        }
    }
    
    /**
     * Phase 2: í”½ì…€ ìƒ‰ì¹  (ê°œì„ : ì‹œê°ì  í”¼ë“œë°± ì¶”ê°€)
     */
    async colorPixel(pixelId, regionId, color) {
        try {
            // ì‹œê°ì  í”¼ë“œë°±: í”½ì…€ í”Œë˜ì‹œ íš¨ê³¼
            this.addPixelFlashEffect(pixelId, regionId, color);
            
            // ë¡œì»¬ì—ì„œ ì¦‰ì‹œ ë°˜ì˜
            this.updatePixelColorLocally(pixelId, regionId, color);
            
            // ë°°ì¹˜ ì €ì¥ íì— ì¶”ê°€
            this.queuePixelUpdate(pixelId, regionId, color);
        } catch (error) {
            console.error('[í”½ì…€ ìƒ‰ì¹  ì˜¤ë¥˜]:', error);
            this.showNotification('í”½ì…€ ìƒ‰ì¹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    /**
     * Phase 8: í”½ì…€ í”Œë˜ì‹œ íš¨ê³¼ (ì‹œê°ì  í”¼ë“œë°±)
     */
    addPixelFlashEffect(pixelId, regionId, color) {
        if (!this.map || !this.map.getSource('pixel-grids')) return;
        
        const source = this.map.getSource('pixel-grids');
        const data = source._data;
        
        if (!data || !data.features) return;
        
        const feature = data.features.find(f => 
            f.properties.id === pixelId && f.properties.regionId === regionId
        );
        
        if (!feature) return;
        
        // í”Œë˜ì‹œ íš¨ê³¼ë¥¼ ìœ„í•œ ì„ì‹œ ë ˆì´ì–´ ìƒì„±
        const flashSourceId = 'pixel-flash';
        const flashLayerId = 'pixel-flash-layer';
        
        // ê¸°ì¡´ í”Œë˜ì‹œ ë ˆì´ì–´ ì œê±°
        if (this.map.getLayer(flashLayerId)) {
            this.map.removeLayer(flashLayerId);
        }
        if (this.map.getSource(flashSourceId)) {
            this.map.removeSource(flashSourceId);
        }
        
        // í”Œë˜ì‹œ GeoJSON ìƒì„±
        const flashGeoJson = {
            type: 'FeatureCollection',
            features: [{
                ...feature,
                properties: {
                    ...feature.properties,
                    flash: true
                }
            }]
        };
        
        // í”Œë˜ì‹œ ì†ŒìŠ¤ ë° ë ˆì´ì–´ ì¶”ê°€
        this.map.addSource(flashSourceId, {
            type: 'geojson',
            data: flashGeoJson
        });
        
        this.map.addLayer({
            id: flashLayerId,
            type: 'fill',
            source: flashSourceId,
            paint: {
                'fill-color': color,
                'fill-opacity': [
                    'interpolate',
                    ['linear'],
                    ['get', 'flash'],
                    0, 0.8,
                    1, 1.0
                ]
            }
        });
        
        // 150ms í›„ í”Œë˜ì‹œ ë ˆì´ì–´ ì œê±°
        setTimeout(() => {
            if (this.map.getLayer(flashLayerId)) {
                this.map.removeLayer(flashLayerId);
            }
            if (this.map.getSource(flashSourceId)) {
                this.map.removeSource(flashSourceId);
            }
        }, 150);
    }
    
    /**
     * Phase 2: ë¡œì»¬ì—ì„œ í”½ì…€ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
     */
    updatePixelColorLocally(pixelId, regionId, color) {
        // í”½ì…€ ê·¸ë¦¬ë“œ ë°ì´í„° ì—…ë°ì´íŠ¸
        const pixelGrid = this.pixelGrids.get(regionId);
        if (pixelGrid) {
            const pixel = pixelGrid.pixels.find(p => p.id === pixelId);
            if (pixel) {
                pixel.color = color;
            }
        }
        
        // Mapbox ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
        if (this.map && this.map.getSource('pixel-grids')) {
            const source = this.map.getSource('pixel-grids');
            const data = source._data;
            
            if (data && data.features) {
                const feature = data.features.find(f => 
                    f.properties.id === pixelId && f.properties.regionId === regionId
                );
                
                if (feature) {
                    feature.properties.color = color;
                    source.setData(data);
                }
            }
        }
    }
    
    /**
     * Phase 3: ë°°ì¹˜ ì €ì¥ íì— í”½ì…€ ì—…ë°ì´íŠ¸ ì¶”ê°€
     */
    queuePixelUpdate(pixelId, regionId, color) {
        this.pixelUpdateBatch.push({ pixelId, regionId, color });
        
        if (this.pixelBatchTimer) {
            clearTimeout(this.pixelBatchTimer);
        }
        
        this.pixelBatchTimer = setTimeout(() => {
            this.savePixelBatch();
        }, 500);
    }
    
    /**
     * Phase 3: ë°°ì¹˜ë¡œ í”½ì…€ ì—…ë°ì´íŠ¸ ì €ì¥ (ê°œì„ : ì—ëŸ¬ í•¸ë“¤ë§ ë° ì¬ì‹œë„ ë¡œì§)
     */
    async savePixelBatch(retryCount = 0) {
        if (!this.isFirebaseInitialized || !this.firestore || this.pixelUpdateBatch.length === 0) {
            return;
        }
        
        const maxRetries = 3;
        const batchToSave = [...this.pixelUpdateBatch]; // ë³µì‚¬ë³¸ ìƒì„±
        this.pixelUpdateBatch = []; // í ë¹„ìš°ê¸° (ì¬ì‹œë„ ì‹œ ì¤‘ë³µ ë°©ì§€)
        
        try {
            const { writeBatch, doc, collection, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // regionIdë³„ë¡œ ê·¸ë£¹í™”
            const updatesByRegion = {};
            batchToSave.forEach(update => {
                if (!updatesByRegion[update.regionId]) {
                    updatesByRegion[update.regionId] = [];
                }
                updatesByRegion[update.regionId].push(update);
            });
            
            // ê° ì§€ì—­ë³„ë¡œ ë°°ì¹˜ ì €ì¥
            for (const [regionId, updates] of Object.entries(updatesByRegion)) {
                const pixelsRef = collection(this.firestore, 'pixelGrids', regionId, 'pixels');
                const batch = writeBatch(this.firestore);
                
                updates.forEach(update => {
                    const pixelRef = doc(pixelsRef, update.pixelId);
                    batch.set(pixelRef, {
                        color: update.color,
                        updatedAt: serverTimestamp(),
                        updatedBy: this.currentUser?.email || 'system'
                    }, { merge: true });
                });
                
                await batch.commit();
            }
            
            this.pixelBatchTimer = null;
            
            // ì„±ê³µì ìœ¼ë¡œ ì €ì¥ëœ ê²½ìš° ì•Œë¦¼ (ì„ íƒì )
            if (batchToSave.length > 10) {
                console.log(`[í”½ì…€ ë°°ì¹˜ ì €ì¥ ì™„ë£Œ] ${batchToSave.length}ê°œ í”½ì…€ ì €ì¥ë¨`);
            }
        } catch (error) {
            console.error('[í”½ì…€ ë°°ì¹˜ ì €ì¥ ì‹¤íŒ¨]:', error);
            
            // ì‹¤íŒ¨í•œ ì—…ë°ì´íŠ¸ë¥¼ ë‹¤ì‹œ íì— ì¶”ê°€
            this.pixelUpdateBatch = [...this.pixelUpdateBatch, ...batchToSave];
            
            // ì¬ì‹œë„ ë¡œì§
            if (retryCount < maxRetries) {
                const delay = Math.min(1000 * Math.pow(2, retryCount), 5000); // ì§€ìˆ˜ ë°±ì˜¤í”„
                console.log(`[í”½ì…€ ë°°ì¹˜ ì €ì¥ ì¬ì‹œë„] ${retryCount + 1}/${maxRetries} (${delay}ms í›„)`);
                
                setTimeout(() => {
                    this.savePixelBatch(retryCount + 1);
                }, delay);
            } else {
                // ìµœëŒ€ ì¬ì‹œë„ íšŸìˆ˜ ì´ˆê³¼
                this.showNotification(
                    `í”½ì…€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (${batchToSave.length}ê°œ ë¯¸ì €ì¥) ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.`, 
                    'error'
                );
            }
        }
    }
    
    /**
     * Phase 3: ì‹¤ì‹œê°„ í”½ì…€ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    async setupPixelRealtimeListener(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) return;
        
        // ë¦¬ìŠ¤ë„ˆ ìˆ˜ ì œí•œ (ë©”ëª¨ë¦¬ ìµœì í™”)
        const maxListeners = 20;
        if (this.pixelGridListeners.size >= maxListeners) {
            // ê°€ì¥ ì˜¤ë˜ëœ ë¦¬ìŠ¤ë„ˆ ì œê±°
            const firstKey = this.pixelGridListeners.keys().next().value;
            if (firstKey) {
                this.pixelGridListeners.get(firstKey)();
                this.pixelGridListeners.delete(firstKey);
            }
        }
        
        // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±°
        if (this.pixelGridListeners.has(regionId)) {
            this.pixelGridListeners.get(regionId)();
            this.pixelGridListeners.delete(regionId);
        }
        
        try {
            const { collection, query, onSnapshot, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const pixelsRef = collection(this.firestore, 'pixelGrids', regionId, 'pixels');
            
            const unsubscribe = onSnapshot(pixelsRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    if (change.type === 'modified' || change.type === 'added') {
                        const pixelData = change.doc.data();
                        // ìì‹ ì´ ì—…ë°ì´íŠ¸í•œ ê²ƒì€ ì œì™¸ (ì´ë¯¸ ë¡œì»¬ì— ë°˜ì˜ë¨)
                        if (pixelData.updatedBy !== this.currentUser?.email) {
                            this.updatePixelColorLocally(
                                pixelData.id,
                                regionId,
                                pixelData.color
                            );
                        }
                    }
                });
            });
            
            this.pixelGridListeners.set(regionId, unsubscribe);
        } catch (error) {
            console.error(`[í”½ì…€ ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì‹¤íŒ¨] ${regionId}:`, error);
        }
    }
    
    /**
     * Phase 3: ë·°í¬íŠ¸ ê¸°ë°˜ ë Œë”ë§ ì—…ë°ì´íŠ¸
     */
    updateVisiblePixels() {
        if (!this.map || !this.map.getSource('pixel-grids')) return;
        
        // í”½ì…€ ê·¸ë¦¬ë“œê°€ ì—†ìœ¼ë©´ ì¦‰ì‹œ ì¢…ë£Œ
        if (!this.pixelGrids || this.pixelGrids.size === 0) return;
        
        const bounds = this.map.getBounds();
        const visibleFeatures = [];
        
        // ì„±ëŠ¥ ìµœì í™”: ë°”ìš´ë”© ë°•ìŠ¤ ë¯¸ë¦¬ ê³„ì‚°
        const west = bounds.getWest();
        const east = bounds.getEast();
        const south = bounds.getSouth();
        const north = bounds.getNorth();
        
        // ê²½ë„ ê²½ê³„ ì²˜ë¦¬ (180ë„ ê²½ê³„ ë„˜ì–´ê°€ëŠ” ê²½ìš°)
        const crossesMeridian = west > east;
        
        // ëª¨ë“  í”½ì…€ ê·¸ë¦¬ë“œì—ì„œ í™”ë©´ì— ë³´ì´ëŠ” í”½ì…€ë§Œ í•„í„°ë§ (ìµœì í™”ëœ bounds ì²´í¬)
        this.pixelGrids.forEach((pixelGrid, regionId) => {
            if (!pixelGrid.pixels || pixelGrid.pixels.length === 0) return;
            
            // ì„±ëŠ¥ ìµœì í™”: í”½ì…€ì´ ë„ˆë¬´ ë§ìœ¼ë©´ ìƒ˜í”Œë§ ë˜ëŠ” ì¡°ê¸° ì¢…ë£Œ
            let checkedCount = 0;
            const maxCheck = 10000; // ìµœëŒ€ 10,000ê°œë§Œ ì²´í¬ (ì„±ëŠ¥ ì œí•œ)
            
            pixelGrid.pixels.forEach(pixel => {
                if (checkedCount >= maxCheck) return; // ì¡°ê¸° ì¢…ë£Œ
                
                const x = pixel.x;
                const y = pixel.y;
                
                // ë¹ ë¥¸ ë°”ìš´ë”© ë°•ìŠ¤ ì²´í¬ (bounds.contains()ë³´ë‹¤ ë¹ ë¦„)
                let isVisible = false;
                
                if (crossesMeridian) {
                    // 180ë„ ê²½ê³„ë¥¼ ë„˜ì–´ê°€ëŠ” ê²½ìš°
                    isVisible = (x >= west || x <= east) && y >= south && y <= north;
                } else {
                    // ì¼ë°˜ì ì¸ ê²½ìš°
                    isVisible = x >= west && x <= east && y >= south && y <= north;
                }
                
                if (isVisible) {
                    checkedCount++;
                    const feature = {
                        type: 'Feature',
                        properties: {
                            id: pixel.id,
                            regionId: pixelGrid.regionId,
                            color: pixel.color || '#f0f0f0',
                            row: pixel.row,
                            col: pixel.col
                        },
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[
                                [pixel.bounds.minX, pixel.bounds.minY],
                                [pixel.bounds.maxX, pixel.bounds.minY],
                                [pixel.bounds.maxX, pixel.bounds.maxY],
                                [pixel.bounds.minX, pixel.bounds.maxY],
                                [pixel.bounds.minX, pixel.bounds.minY]
                            ]]
                        }
                    };
                    visibleFeatures.push(feature);
                }
            });
        });
        
        const visibleGeoJson = {
            type: 'FeatureCollection',
            features: visibleFeatures
        };
        
        // GeoJSON ì—…ë°ì´íŠ¸ (ë‹¨ì¼ í˜¸ì¶œë¡œ ìµœì í™”)
        this.map.getSource('pixel-grids').setData(visibleGeoJson);
    }
    
    /**
     * Phase 4: ê·¸ë¦¬ë“œ ì„  í‘œì‹œ/ìˆ¨ê¹€ í† ê¸€
     */
    togglePixelGridLines() {
        this.showPixelGridLines = !this.showPixelGridLines;
        
        if (this.map && this.map.getLayer('pixel-grids-border')) {
            this.map.setPaintProperty('pixel-grids-border', 'line-width', 
                this.showPixelGridLines ? 0.5 : 0
            );
        }
    }
    
    /**
     * Phase 8: í”½ì…€ ê·¸ë¦¬ë“œ í¬ê¸° ë™ì  ì¡°ì ˆ
     */
    setPixelGridSize(gridSize) {
        // Wplace ìŠ¤íƒ€ì¼: ë” ì‘ì€ í”½ì…€ì„ ìœ„í•´ ë” í° ê·¸ë¦¬ë“œ í¬ê¸° í—ˆìš©
        if (gridSize < 50 || gridSize > 200) {
            console.warn('[í”½ì…€ ê·¸ë¦¬ë“œ í¬ê¸°] í—ˆìš© ë²”ìœ„: 50-200 (ê°’ì´ í´ìˆ˜ë¡ í”½ì…€ì´ ì‘ì•„ì§‘ë‹ˆë‹¤)');
            return;
        }
        
        this.pixelGridGridSize = gridSize;
        this.showNotification(`ê·¸ë¦¬ë“œ í¬ê¸°: ${gridSize}x${gridSize} (í”½ì…€ í¬ê¸° ì¡°ì •)`, 'info', 1500);
        
        // í˜„ì¬ í¸ì§‘ ì¤‘ì¸ ì§€ì—­ì´ ìˆìœ¼ë©´ ê·¸ë¦¬ë“œ ì¬ìƒì„±
        if (this.currentRegion) {
            this.highlightRegionPixelGrid(this.currentRegion.id);
        }
    }
    
    /**
     * Phase 8: ì„±ëŠ¥ ìµœì í™” - ë·°í¬íŠ¸ ê¸°ë°˜ ë Œë”ë§ ê°œì„ 
     */
    optimizePixelGridRendering() {
        if (!this.map || !this.map.getSource('pixel-grids')) return;
        
        // í˜„ì¬ ì¤Œ ë ˆë²¨ì— ë”°ë¼ ê·¸ë¦¬ë“œ ì„  í‘œì‹œ ì—¬ë¶€ ìë™ ì¡°ì ˆ
        const zoom = this.map.getZoom();
        
        // ì¤Œ ë ˆë²¨ì´ ë‚®ìœ¼ë©´ (ì¶•ì†Œ) ê·¸ë¦¬ë“œ ì„  ìˆ¨ê¹€, ë†’ìœ¼ë©´ (í™•ëŒ€) í‘œì‹œ
        if (zoom < 6 && this.showPixelGridLines) {
            // ìë™ìœ¼ë¡œ ê·¸ë¦¬ë“œ ì„  ìˆ¨ê¹€ (ì„±ëŠ¥ í–¥ìƒ)
            if (this.map.getLayer('pixel-grids-border')) {
                this.map.setPaintProperty('pixel-grids-border', 'line-width', 0);
            }
        } else if (zoom >= 6 && this.showPixelGridLines) {
            // ë‹¤ì‹œ í‘œì‹œ
            if (this.map.getLayer('pixel-grids-border')) {
                this.map.setPaintProperty('pixel-grids-border', 'line-width', 0.5);
            }
        }
    }
    
    /**
     * Phase 4: í”½ì…€ ê·¸ë¦¬ë“œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
     */
    async initializePixelGridSystem(geoJson) {
        // Phase 0: í”½ì…€ì•„íŠ¸ ì§€ë„ í‘œì‹œ
        await this.updatePixelArtLayer(geoJson);
        
        // Phase 1: í”½ì…€ ê·¸ë¦¬ë“œ ìƒì„± ë° ë ˆì´ì–´ ì„¤ì •
        await this.setupPixelGridLayer(geoJson);
        
        // Phase 2: í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì„¤ì •
        this.setupPixelClickHandlers();
        
        // Phase 3: ë·°í¬íŠ¸ ì—…ë°ì´íŠ¸ ë¦¬ìŠ¤ë„ˆ (ì„±ëŠ¥ ìµœì í™”: ë””ë°”ìš´ì‹± ë° requestAnimationFrame ì ìš©)
        let pixelUpdateTimer = null;
        let pixelUpdateFrame = null;
        
        this.map.on('moveend', () => {
            // ë””ë°”ìš´ì‹±: ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ í›„ 200ms í›„ì—ë§Œ ì‹¤í–‰
            if (pixelUpdateTimer) {
                clearTimeout(pixelUpdateTimer);
            }
            pixelUpdateTimer = setTimeout(() => {
                // requestAnimationFrameìœ¼ë¡œ ë Œë”ë§ ìµœì í™”
                if (pixelUpdateFrame) {
                    cancelAnimationFrame(pixelUpdateFrame);
                }
                pixelUpdateFrame = requestAnimationFrame(() => {
                    this.updateVisiblePixels();
                    this.optimizePixelGridRendering();
                });
            }, 200);
        });
        
        this.map.on('zoomend', () => {
            // ë””ë°”ìš´ì‹±: ë§ˆì§€ë§‰ ì´ë²¤íŠ¸ í›„ 200ms í›„ì—ë§Œ ì‹¤í–‰
            if (pixelUpdateTimer) {
                clearTimeout(pixelUpdateTimer);
            }
            pixelUpdateTimer = setTimeout(() => {
                // requestAnimationFrameìœ¼ë¡œ ë Œë”ë§ ìµœì í™”
                if (pixelUpdateFrame) {
                    cancelAnimationFrame(pixelUpdateFrame);
                }
                pixelUpdateFrame = requestAnimationFrame(() => {
                    this.updateVisiblePixels();
                    this.optimizePixelGridRendering();
                });
            }, 200);
        });
        
        // Phase 8: ì¤Œ ë³€ê²½ ì‹œ ì‹¤ì‹œê°„ ìµœì í™” (ì“°ë¡œí‹€ë§ ì ìš©)
        let zoomOptimizeFrame = null;
        this.map.on('zoom', () => {
            // ì“°ë¡œí‹€ë§: ìµœëŒ€ 60fpsë¡œ ì œí•œ
            if (!zoomOptimizeFrame) {
                zoomOptimizeFrame = requestAnimationFrame(() => {
                    this.optimizePixelGridRendering();
                    zoomOptimizeFrame = null;
                });
            }
        });
        
        // Phase 3: ëª¨ë“  ì§€ì—­ì— ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.pixelGrids.forEach((grid, regionId) => {
            this.setupPixelRealtimeListener(regionId);
        });
    }
    
    // ========== ì˜¥ì…˜ ëŒ€ì‹œë³´ë“œ ==========
    
    /**
     * ì˜¥ì…˜ ëŒ€ì‹œë³´ë“œ ì—´ê¸°
     */
    async openAuctionDashboard() {
        const modal = document.getElementById('auction-dashboard-modal');
        if (modal) {
            modal.classList.remove('hidden');
            await this.loadDashboardAuctions('active');
        }
    }
    
    /**
     * ì˜¥ì…˜ ëŒ€ì‹œë³´ë“œ ë‹«ê¸°
     */
    closeAuctionDashboard() {
        const modal = document.getElementById('auction-dashboard-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
    
    /**
     * ëŒ€ì‹œë³´ë“œ íƒ­ ì „í™˜
     */
    async switchDashboardTab(tabName) {
        const tabs = document.querySelectorAll('.dashboard-tabs .tab-btn');
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });
        
        await this.loadDashboardAuctions(tabName);
    }
    
    /**
     * ëŒ€ì‹œë³´ë“œ ì˜¥ì…˜ ëª©ë¡ ë¡œë“œ
     */
    async loadDashboardAuctions(filter = 'active') {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        const listContainer = document.getElementById('dashboard-auction-list');
        if (!listContainer) return;
        
        // ë¡œë”© ë©”ì‹œì§€ í‘œì‹œ (ì•ˆì „í•œ ë°©ë²•)
        while (listContainer.firstChild) {
            listContainer.removeChild(listContainer.firstChild);
        }
        const loadingP = document.createElement('p');
        loadingP.style.textAlign = 'center';
        loadingP.style.color = '#666';
        loadingP.style.padding = '20px';
        loadingP.textContent = 'ë¡œë”© ì¤‘...';
        listContainer.appendChild(loadingP);
        
        try {
            const { collection, query, where, orderBy, getDocs, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionsRef = collection(this.firestore, 'auctions');
            
            let q;
            const now = Timestamp.now();
            
            switch (filter) {
                case 'active':
                    q = query(auctionsRef, where('status', '==', 'active'), orderBy('endTime', 'asc'));
                    break;
                case 'upcoming':
                    // ì˜ˆì •ëœ ì˜¥ì…˜ì€ ì•„ì§ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìœ¼ë¯€ë¡œ ë¹ˆ ëª©ë¡
                    while (listContainer.firstChild) {
                        listContainer.removeChild(listContainer.firstChild);
                    }
                    const upcomingP = document.createElement('p');
                    upcomingP.style.textAlign = 'center';
                    upcomingP.style.color = '#666';
                    upcomingP.style.padding = '20px';
                    upcomingP.textContent = 'ì˜ˆì •ëœ ì˜¥ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.';
                    listContainer.appendChild(upcomingP);
                    return;
                case 'ended':
                    // 'in' ì—°ì‚°ìì™€ orderByë¥¼ í•¨ê»˜ ì‚¬ìš©í•  ë•ŒëŠ” ë³µì¡í•œ ì¸ë±ìŠ¤ í•„ìš”
                    // ë‘ ê°œì˜ ë³„ë„ ì¿¼ë¦¬ë¡œ ë‚˜ëˆ„ì–´ ì‹¤í–‰ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³‘í•©
                    try {
                        const q1 = query(auctionsRef, where('status', '==', 'ended'), orderBy('finalizedAt', 'desc'));
                        const q2 = query(auctionsRef, where('status', '==', 'sold'), orderBy('finalizedAt', 'desc'));
                        const [snapshot1, snapshot2] = await Promise.all([getDocs(q1), getDocs(q2)]);
                        
                        const auctionsMap = new Map();
                        snapshot1.forEach((doc) => {
                            auctionsMap.set(doc.id, { id: doc.id, ...doc.data() });
                        });
                        snapshot2.forEach((doc) => {
                            auctionsMap.set(doc.id, { id: doc.id, ...doc.data() });
                        });
                        
                        // finalizedAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                        const auctions = Array.from(auctionsMap.values()).sort((a, b) => {
                            const timeA = a.finalizedAt?.toMillis() || 0;
                            const timeB = b.finalizedAt?.toMillis() || 0;
                            return timeB - timeA; // ë‚´ë¦¼ì°¨ìˆœ
                        });
                        
                        this.renderDashboardAuctions(auctions, filter);
                        return;
                    } catch (endedError) {
                        // ì¸ë±ìŠ¤ ì˜¤ë¥˜ì¸ ê²½ìš° ëª¨ë“  ì˜¥ì…˜ì„ ê°€ì ¸ì˜¨ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§
                        if (endedError.code === 'failed-precondition') {
                            console.warn('ended ì˜¥ì…˜ ì¸ë±ìŠ¤ ì˜¤ë¥˜, í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ìœ¼ë¡œ ëŒ€ì²´');
                            try {
                                // ëª¨ë“  ì˜¥ì…˜ ê°€ì ¸ì˜¤ê¸° (ì¸ë±ìŠ¤ ì—†ì´)
                                const allQuery = query(auctionsRef);
                                const allSnapshot = await getDocs(allQuery);
                                const allAuctions = [];
                                allSnapshot.forEach((doc) => {
                                    const data = doc.data();
                                    if (data.status === 'ended' || data.status === 'sold') {
                                        allAuctions.push({ id: doc.id, ...data });
                                    }
                                });
                                // finalizedAt ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                                allAuctions.sort((a, b) => {
                                    const timeA = a.finalizedAt?.toMillis() || 0;
                                    const timeB = b.finalizedAt?.toMillis() || 0;
                                    return timeB - timeA; // ë‚´ë¦¼ì°¨ìˆœ
                                });
                                this.renderDashboardAuctions(allAuctions, filter);
                                return;
                            } catch (fallbackError) {
                                console.error('ended ì˜¥ì…˜ ëŒ€ì²´ ì¿¼ë¦¬ ì‹¤íŒ¨:', fallbackError);
                                throw endedError;
                            }
                        } else {
                            throw endedError;
                        }
                    }
                    break;
                case 'watching':
                    // ê´€ì‹¬ ë“±ë¡ëœ ì˜¥ì…˜ (ì‚¬ìš©ìë³„)
                    if (!this.currentUser) {
                        while (listContainer.firstChild) {
                            listContainer.removeChild(listContainer.firstChild);
                        }
                        const loginP = document.createElement('p');
                        loginP.style.textAlign = 'center';
                        loginP.style.color = '#666';
                        loginP.style.padding = '20px';
                        loginP.textContent = 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.';
                        listContainer.appendChild(loginP);
                        return;
                    }
                    try {
                        q = query(auctionsRef, where('watchers', 'array-contains', this.currentUser.uid), orderBy('endTime', 'asc'));
                    } catch (watchingError) {
                        // ì¸ë±ìŠ¤ ì˜¤ë¥˜ì¸ ê²½ìš° ëª¨ë“  ì˜¥ì…˜ì„ ê°€ì ¸ì˜¨ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ í•„í„°ë§
                        if (watchingError.code === 'failed-precondition') {
                            console.warn('watching ì˜¥ì…˜ ì¸ë±ìŠ¤ ì˜¤ë¥˜, í´ë¼ì´ì–¸íŠ¸ í•„í„°ë§ìœ¼ë¡œ ëŒ€ì²´');
                            try {
                                const allQuery = query(auctionsRef);
                                const allSnapshot = await getDocs(allQuery);
                                const watchingAuctions = [];
                                allSnapshot.forEach((doc) => {
                                    const data = doc.data();
                                    if (data.watchers && Array.isArray(data.watchers) && data.watchers.includes(this.currentUser.uid)) {
                                        watchingAuctions.push({ id: doc.id, ...data });
                                    }
                                });
                                // endTime ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬
                                watchingAuctions.sort((a, b) => {
                                    const timeA = a.endTime?.toMillis() || 0;
                                    const timeB = b.endTime?.toMillis() || 0;
                                    return timeA - timeB; // ì˜¤ë¦„ì°¨ìˆœ
                                });
                                this.renderDashboardAuctions(watchingAuctions, filter);
                                return;
                            } catch (fallbackError) {
                                console.error('watching ì˜¥ì…˜ ëŒ€ì²´ ì¿¼ë¦¬ ì‹¤íŒ¨:', fallbackError);
                                throw watchingError;
                            }
                        } else {
                            throw watchingError;
                        }
                    }
                    break;
                default:
                    q = query(auctionsRef, orderBy('endTime', 'asc'));
            }
            
            // qê°€ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš° (ended ì¼€ì´ìŠ¤ì—ì„œ ì˜¤ë¥˜ ë°œìƒ ì‹œ)
            if (!q) {
                throw new Error('ì¿¼ë¦¬ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const snapshot = await getDocs(q);
            const auctions = [];
            
            snapshot.forEach((doc) => {
                const data = doc.data();
                auctions.push({
                    id: doc.id,
                    ...data
                });
            });
            
            this.renderDashboardAuctions(auctions, filter);
        } catch (error) {
            // 409 ì˜¤ë¥˜ (index already exists)ëŠ” ë¬´ì‹œ - ì´ë¯¸ ì¸ë±ìŠ¤ê°€ ì¡´ì¬í•œë‹¤ëŠ” ì˜ë¯¸
            if (error.code === 409 || (error.message && error.message.includes('index already exists'))) {
                console.log('[ì¸ë±ìŠ¤ ì •ë³´] ì´ë¯¸ ì¸ë±ìŠ¤ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ì •ìƒ ì‘ë™í•©ë‹ˆë‹¤.');
                // ì˜¤ë¥˜ë¥¼ í‘œì‹œí•˜ì§€ ì•Šê³  ì¡°ìš©íˆ ì²˜ë¦¬
                return;
            }
            
            console.error('[ëŒ€ì‹œë³´ë“œ ì˜¥ì…˜ ë¡œë“œ ì‹¤íŒ¨]:', error);
            while (listContainer.firstChild) {
                listContainer.removeChild(listContainer.firstChild);
            }
            const errorP = document.createElement('p');
            errorP.style.textAlign = 'center';
            errorP.style.color = '#ff6b6b';
            errorP.style.padding = '20px';
            
            // ì¸ë±ìŠ¤ ì˜¤ë¥˜ì¸ ê²½ìš° ë” ì¹œì ˆí•œ ë©”ì‹œì§€ í‘œì‹œ
            if (error.code === 'failed-precondition' && error.message && error.message.includes('index')) {
                errorP.innerHTML = 'ì˜¥ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.<br>ì¸ë±ìŠ¤ê°€ ìƒì„±ë˜ëŠ” ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } else {
                errorP.textContent = 'ì˜¥ì…˜ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            }
            listContainer.appendChild(errorP);
        }
    }
    
    /**
     * ëŒ€ì‹œë³´ë“œ ì˜¥ì…˜ ëª©ë¡ ë Œë”ë§
     */
    renderDashboardAuctions(auctions, filter) {
        const listContainer = document.getElementById('dashboard-auction-list');
        if (!listContainer) return;
        
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (listContainer.firstChild) {
            listContainer.removeChild(listContainer.firstChild);
        }
        
        if (auctions.length === 0) {
            const emptyP = document.createElement('p');
            emptyP.style.textAlign = 'center';
            emptyP.style.color = '#666';
            emptyP.style.padding = '20px';
            emptyP.textContent = 'ì˜¥ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.';
            listContainer.appendChild(emptyP);
            return;
        }
        
        auctions.forEach(auction => {
            const endTime = auction.endTime?.toDate ? auction.endTime.toDate() : new Date();
            const timeRemaining = endTime.getTime() - Date.now();
            const hours = Math.floor(timeRemaining / (1000 * 60 * 60));
            const minutes = Math.floor((timeRemaining % (1000 * 60 * 60)) / (1000 * 60));
            
            const isWatching = auction.watchers && this.currentUser && auction.watchers.includes(this.currentUser.uid);
            
            // ì•ˆì „í•œ ë°ì´í„° ì¶”ì¶œ
            const regionName = this.sanitizeHTML(auction.regionName || auction.regionNameEn || auction.regionId || '');
            const country = this.sanitizeHTML(auction.country || 'Unknown');
            const currentBid = auction.currentBid?.toFixed(2) || '0.00';
            const winnerEmail = this.sanitizeHTML(auction.highestBidderEmail || 'ì—†ìŒ');
            
            // DOM ìš”ì†Œ ìƒì„±
            const item = document.createElement('div');
            item.className = 'dashboard-auction-item';
            item.dataset.auctionId = auction.id;
            
            // í—¤ë”
            const header = document.createElement('div');
            header.className = 'auction-item-header';
            const h4 = document.createElement('h4');
            h4.textContent = regionName;
            const countrySpan = document.createElement('span');
            countrySpan.className = 'auction-country';
            countrySpan.textContent = country;
            header.appendChild(h4);
            header.appendChild(countrySpan);
            
            // ë°”ë””
            const body = document.createElement('div');
            body.className = 'auction-item-body';
            
            // ì…ì°°ê°€
            const bidDiv = document.createElement('div');
            bidDiv.className = 'auction-item-bid';
            const bidLabel = document.createElement('span');
            bidLabel.className = 'label';
            bidLabel.textContent = 'í˜„ì¬ ì…ì°°ê°€';
            const bidValue = document.createElement('span');
            bidValue.className = 'value';
            bidValue.textContent = `$${currentBid}`;
            bidDiv.appendChild(bidLabel);
            bidDiv.appendChild(bidValue);
            body.appendChild(bidDiv);
            
            // ë‚¨ì€ ì‹œê°„ (active í•„í„°ì¼ ë•Œë§Œ)
            if (filter === 'active') {
                const timeDiv = document.createElement('div');
                timeDiv.className = 'auction-item-time';
                const timeLabel = document.createElement('span');
                timeLabel.className = 'label';
                timeLabel.textContent = 'ë‚¨ì€ ì‹œê°„';
                const timeValue = document.createElement('span');
                timeValue.className = 'value';
                timeValue.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„`;
                timeDiv.appendChild(timeLabel);
                timeDiv.appendChild(timeValue);
                body.appendChild(timeDiv);
            }
            
            // ë‚™ì°°ì (ended í•„í„°ì¼ ë•Œë§Œ)
            if (filter === 'ended') {
                const winnerDiv = document.createElement('div');
                winnerDiv.className = 'auction-item-winner';
                const winnerLabel = document.createElement('span');
                winnerLabel.className = 'label';
                winnerLabel.textContent = 'ë‚™ì°°ì';
                const winnerValue = document.createElement('span');
                winnerValue.className = 'value';
                winnerValue.textContent = winnerEmail;
                winnerDiv.appendChild(winnerLabel);
                winnerDiv.appendChild(winnerValue);
                body.appendChild(winnerDiv);
            }
            
            // ì•¡ì…˜ ë²„íŠ¼
            const actions = document.createElement('div');
            actions.className = 'auction-item-actions';
            
            const viewBtn = document.createElement('button');
            viewBtn.className = 'btn-view-auction';
            viewBtn.dataset.regionId = auction.regionId;
            viewBtn.textContent = 'ì˜¥ì…˜ ë³´ê¸°';
            actions.appendChild(viewBtn);
            
            if (filter === 'active') {
                const watchBtn = document.createElement('button');
                watchBtn.className = `btn-watch-auction ${isWatching ? 'watching' : ''}`;
                watchBtn.dataset.auctionId = auction.id;
                watchBtn.textContent = isWatching ? 'ê´€ì‹¬ í•´ì œ' : 'ê´€ì‹¬ ë“±ë¡';
                actions.appendChild(watchBtn);
            }
            
            item.appendChild(header);
            item.appendChild(body);
            item.appendChild(actions);
            listContainer.appendChild(item);
        });
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        listContainer.querySelectorAll('.btn-view-auction').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const regionId = e.target.dataset.regionId;
                const region = this.regionData.get(regionId);
                if (region) {
                    this.closeAuctionDashboard();
                    this.currentRegion = region;
                    await this.openAuctionModal(region);
                }
            });
        });
        
        listContainer.querySelectorAll('.btn-watch-auction').forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const auctionId = e.target.dataset.auctionId;
                await this.toggleWatchAuction(auctionId);
            });
        });
    }
    
    /**
     * ì˜¥ì…˜ ê´€ì‹¬ ë“±ë¡/í•´ì œ
     */
    async toggleWatchAuction(auctionId) {
        if (!this.currentUser || !this.isFirebaseInitialized || !this.firestore) {
            this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            return;
        }
        
        try {
            const { doc, getDoc, updateDoc, arrayUnion, arrayRemove } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', auctionId);
            const auctionSnap = await getDoc(auctionRef);
            
            if (!auctionSnap.exists()) {
                return;
            }
            
            const auctionData = auctionSnap.data();
            const watchers = auctionData.watchers || [];
            const isWatching = watchers.includes(this.currentUser.uid);
            
            if (isWatching) {
                await updateDoc(auctionRef, {
                    watchers: arrayRemove(this.currentUser.uid)
                });
                this.showNotification('ê´€ì‹¬ ë“±ë¡ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                await updateDoc(auctionRef, {
                    watchers: arrayUnion(this.currentUser.uid)
                });
                this.showNotification('ê´€ì‹¬ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
            
            // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
            await this.loadDashboardAuctions('active');
        } catch (error) {
            console.error('[ê´€ì‹¬ ë“±ë¡ ì‹¤íŒ¨]:', error);
            this.showNotification('ê´€ì‹¬ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // ========== í†µê³„ & ìˆ˜ìµ ëª¨ë¸ ==========
    
    /**
     * í†µê³„ ëª¨ë‹¬ ì—´ê¸°
     */
    async openMarketStatsModal() {
        const modal = document.getElementById('market-stats-modal');
        if (modal) {
            modal.classList.remove('hidden');
            await this.loadMarketStatistics();
            
            // í†µê³„ íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì°¨íŠ¸ ë Œë”ë§
            const statisticsTab = document.getElementById('statistics-tab');
            if (statisticsTab && statisticsTab.classList.contains('active')) {
                await this.renderStatistics();
            }
        }
    }
    
    /**
     * í†µê³„ ëª¨ë‹¬ ë‹«ê¸°
     */
    closeMarketStatsModal() {
        const modal = document.getElementById('market-stats-modal');
        if (modal) {
            modal.classList.add('hidden');
        }
    }
    
    /**
     * í†µê³„ íƒ­ ì „í™˜
     */
    switchStatsTab(tabName) {
        const tabs = document.querySelectorAll('.stats-tabs .tab-btn');
        tabs.forEach(tab => {
            tab.classList.toggle('active', tab.dataset.tab === tabName);
        });
        
        const contents = document.querySelectorAll('.tab-content');
        contents.forEach(content => {
            content.classList.toggle('active', content.id === `${tabName}-tab`);
        });
        
        if (tabName === 'statistics') {
            this.renderStatistics();
        }
    }
    
    /**
     * ì‹œì¥ í†µê³„ ë¡œë“œ
     */
    async loadMarketStatistics() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ì´ ë‚™ì°° ê¸ˆì•¡ ê³„ì‚°
            const auctionsRef = collection(this.firestore, 'auctions');
            const soldQuery = query(auctionsRef, where('status', '==', 'sold'));
            const soldSnapshot = await getDocs(soldQuery);
            
            let totalRevenue = 0;
            soldSnapshot.forEach((doc) => {
                const data = doc.data();
                totalRevenue += data.currentBid || 0;
            });
            
            // ì§„í–‰ ì¤‘ ì˜¥ì…˜ ìˆ˜
            const activeQuery = query(auctionsRef, where('status', '==', 'active'));
            const activeSnapshot = await getDocs(activeQuery);
            const activeCount = activeSnapshot.size;
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            const totalRevenueEl = document.getElementById('total-revenue-stat');
            if (totalRevenueEl) {
                totalRevenueEl.textContent = this.formatCurrency(totalRevenue);
            }
            
            const activeAuctionsEl = document.getElementById('active-auctions-stat');
            if (activeAuctionsEl) {
                activeAuctionsEl.textContent = activeCount.toString();
            }
            
            const communityRewardEl = document.getElementById('community-reward-stat');
            if (communityRewardEl) {
                communityRewardEl.textContent = this.formatCurrency(this.communityPoolData.rewardFund || 0);
            }
            
            const p2wMitigationEl = document.getElementById('p2w-mitigation-stat');
            if (p2wMitigationEl) {
                p2wMitigationEl.textContent = '10%';
            }
        } catch (error) {
            console.error('[ì‹œì¥ í†µê³„ ë¡œë“œ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * í†µê³„ ì°¨íŠ¸ ë Œë”ë§ (Chart.js í†µí•©)
     */
    async renderStatistics() {
        if (!window.Chart) {
            console.warn('[í†µê³„ ì°¨íŠ¸] Chart.jsê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            // ë‚™ì°°ê°€ íˆìŠ¤í† ê·¸ë¨ ì°¨íŠ¸
            await this.renderBidHistogramChart();
            
            // í´ë¦­/ë…¸ì¶œ ë°ì´í„° ì°¨íŠ¸
            await this.renderClickExposureChart();
            
            // P2W ì™„í™” ì§€í‘œ ì°¨íŠ¸
            await this.renderP2WMitigationChart();
        } catch (error) {
            console.error('[í†µê³„ ì°¨íŠ¸ ë Œë”ë§ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * ë‚™ì°°ê°€ íˆìŠ¤í† ê·¸ë¨ ì°¨íŠ¸ ë Œë”ë§
     */
    async renderBidHistogramChart() {
        const canvas = document.getElementById('bid-histogram-chart');
        if (!canvas) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (this.bidHistogramChart) {
            this.bidHistogramChart.destroy();
        }
        
        try {
            // Firestoreì—ì„œ ë‚™ì°°ëœ ì˜¥ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionsRef = collection(this.firestore, 'auctions');
            const soldQuery = query(auctionsRef, where('status', '==', 'sold'));
            const soldSnapshot = await getDocs(soldQuery);
            
            const bidAmounts = [];
            soldSnapshot.forEach((doc) => {
                const data = doc.data();
                if (data.currentBid && data.currentBid > 0) {
                    bidAmounts.push(data.currentBid);
                }
            });
            
            // íˆìŠ¤í† ê·¸ë¨ êµ¬ê°„ ìƒì„±
            const bins = 10;
            const maxBid = Math.max(...bidAmounts, 100);
            const minBid = Math.min(...bidAmounts, 1);
            const binSize = (maxBid - minBid) / bins;
            
            const histogramData = new Array(bins).fill(0);
            const labels = [];
            
            bidAmounts.forEach(bid => {
                const binIndex = Math.min(Math.floor((bid - minBid) / binSize), bins - 1);
                histogramData[binIndex]++;
            });
            
            for (let i = 0; i < bins; i++) {
                const start = minBid + (i * binSize);
                const end = minBid + ((i + 1) * binSize);
                labels.push(`$${start.toFixed(0)}-${end.toFixed(0)}`);
            }
            
            // Chart.jsë¡œ íˆìŠ¤í† ê·¸ë¨ ìƒì„±
            const ctx = canvas.getContext('2d');
            this.bidHistogramChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ë‚™ì°° ê±´ìˆ˜',
                        data: histogramData,
                        backgroundColor: 'rgba(78, 205, 196, 0.6)',
                        borderColor: 'rgba(78, 205, 196, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                stepSize: 1
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff',
                                maxRotation: 45,
                                minRotation: 45
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('[ë‚™ì°°ê°€ íˆìŠ¤í† ê·¸ë¨ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * í´ë¦­/ë…¸ì¶œ ë°ì´í„° ì°¨íŠ¸ ë Œë”ë§
     */
    async renderClickExposureChart() {
        const canvas = document.getElementById('click-exposure-chart');
        if (!canvas) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (this.clickExposureChart) {
            this.clickExposureChart.destroy();
        }
        
        try {
            // Firestoreì—ì„œ ì˜¥ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í´ë¦­/ë…¸ì¶œ ë°ì´í„°ëŠ” í–¥í›„ ì¶”ê°€ ì˜ˆì •)
            // í˜„ì¬ëŠ” ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©
            const labels = ['ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† ', 'ì¼'];
            const clickData = [120, 190, 300, 250, 220, 180, 150];
            const exposureData = [5000, 7000, 9000, 8000, 7500, 6000, 5500];
            
            const ctx = canvas.getContext('2d');
            this.clickExposureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'í´ë¦­ ìˆ˜',
                            data: clickData,
                            borderColor: 'rgba(78, 205, 196, 1)',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4
                        },
                        {
                            label: 'ë…¸ì¶œ ìˆ˜',
                            data: exposureData,
                            borderColor: 'rgba(255, 107, 107, 1)',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('[í´ë¦­/ë…¸ì¶œ ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * P2W ì™„í™” ì§€í‘œ ì°¨íŠ¸ ë Œë”ë§
     */
    async renderP2WMitigationChart() {
        const canvas = document.getElementById('p2w-mitigation-chart');
        if (!canvas) return;
        
        // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
        if (this.p2wMitigationChart) {
            this.p2wMitigationChart.destroy();
        }
        
        try {
            // Firestoreì—ì„œ P2W ì™„í™” ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionsRef = collection(this.firestore, 'auctions');
            const soldQuery = query(auctionsRef, where('status', '==', 'sold'));
            const soldSnapshot = await getDocs(soldQuery);
            
            // ì›”ë³„ P2W ì™„í™” ë°ì´í„° ê³„ì‚°
            const monthlyData = {};
            soldSnapshot.forEach((doc) => {
                const data = doc.data();
                const bidAmount = data.currentBid || 0;
                const p2wAmount = bidAmount * 0.1; // 10% P2W ì™„í™”
                const soldDate = data.soldAt?.toDate?.() || data.endTime?.toDate?.() || new Date();
                const monthKey = `${soldDate.getFullYear()}-${String(soldDate.getMonth() + 1).padStart(2, '0')}`;
                
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = {
                        totalBid: 0,
                        p2wAmount: 0,
                        auctionCount: 0
                    };
                }
                
                monthlyData[monthKey].totalBid += bidAmount;
                monthlyData[monthKey].p2wAmount += p2wAmount;
                monthlyData[monthKey].auctionCount += 1;
            });
            
            // ìµœê·¼ 6ê°œì›” ë°ì´í„°ë§Œ ì‚¬ìš©
            const sortedMonths = Object.keys(monthlyData).sort().slice(-6);
            const labels = sortedMonths.map(month => {
                const [year, monthNum] = month.split('-');
                return `${year}ë…„ ${parseInt(monthNum)}ì›”`;
            });
            
            const p2wData = sortedMonths.map(month => monthlyData[month].p2wAmount);
            const totalBidData = sortedMonths.map(month => monthlyData[month].totalBid);
            const auctionCountData = sortedMonths.map(month => monthlyData[month].auctionCount);
            
            // ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ì˜ˆì‹œ ë°ì´í„° ì‚¬ìš©
            if (labels.length === 0) {
                labels.push('1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”');
                p2wData.push(0, 0, 0, 0, 0, 0);
                totalBidData.push(0, 0, 0, 0, 0, 0);
                auctionCountData.push(0, 0, 0, 0, 0, 0);
            }
            
            const ctx = canvas.getContext('2d');
            this.p2wMitigationChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'P2W ì™„í™” ê¸ˆì•¡ ($)',
                            data: p2wData,
                            backgroundColor: 'rgba(255, 193, 7, 0.6)',
                            borderColor: 'rgba(255, 193, 7, 1)',
                            borderWidth: 1,
                            yAxisID: 'y'
                        },
                        {
                            label: 'ì´ ë‚™ì°° ê¸ˆì•¡ ($)',
                            data: totalBidData,
                            backgroundColor: 'rgba(78, 205, 196, 0.4)',
                            borderColor: 'rgba(78, 205, 196, 1)',
                            borderWidth: 1,
                            yAxisID: 'y1',
                            type: 'line'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: '#ffffff'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += '$' + context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            ticks: {
                                color: '#ffffff',
                                callback: function(value) {
                                    return '$' + value.toLocaleString();
                                }
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        },
                        x: {
                            ticks: {
                                color: '#ffffff'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        } catch (error) {
            console.error('[P2W ì™„í™” ì°¨íŠ¸ ìƒì„± ì‹¤íŒ¨]:', error);
        }
    }
    
    // ========== ê¸°ìˆ  ì¸í”„ë¼ ê°œì„ : ë°ì´í„° íŒŒì´í”„ë¼ì¸ ==========
    
    /**
     * GeoJSON ë°ì´í„° íŒŒì´í”„ë¼ì¸: í–‰ì •êµ¬ì—­ ë‹¨ìœ„ ë¶„ë¦¬ ë° ìºì‹± êµ¬ì¡° ì¬ì •ë¹„
     */
    async loadGeoJsonWithPipeline(countryKey, url) {
        // ìºì‹œ í™•ì¸
        if (this.geoJsonPipeline.cache.has(countryKey)) {
            const cached = this.geoJsonPipeline.cache.get(countryKey);
            if (cached.timestamp && Date.now() - cached.timestamp < 3600000) { // 1ì‹œê°„ ìºì‹œ
                return cached.data;
            }
        }
        
        // ë¡œë”© ìƒíƒœ í™•ì¸
        if (this.geoJsonPipeline.loadingStates.get(countryKey)) {
            return await this.geoJsonPipeline.loadingStates.get(countryKey);
        }
        
        // ë¡œë”© ì‹œì‘
        const loadPromise = this.fetchGeoJsonStreaming(url);
        this.geoJsonPipeline.loadingStates.set(countryKey, loadPromise);
        
        try {
            const data = await loadPromise;
            
            // í–‰ì •êµ¬ì—­ ë‹¨ìœ„ë¡œ ë¶„ë¦¬í•˜ì—¬ ìºì‹œ
            const separatedFeatures = this.separateAdministrativeUnits(data, countryKey);
            
            // ìºì‹œ ì €ì¥
            this.geoJsonPipeline.cache.set(countryKey, {
                data: separatedFeatures,
                timestamp: Date.now(),
                size: JSON.stringify(separatedFeatures).length
            });
            
            // ìºì‹œ í¬ê¸° ê´€ë¦¬
            this.manageCacheSize();
            
            return separatedFeatures;
        } finally {
            this.geoJsonPipeline.loadingStates.delete(countryKey);
        }
    }
    
    /**
     * ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ GeoJSON ë¡œë“œ
     */
    async fetchGeoJsonStreaming(url) {
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder();
            let buffer = '';
            
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                
                buffer += decoder.decode(value, { stream: true });
                
                // ìŠ¤íŠ¸ë¦¬ë° ì¤‘ê°„ ì²˜ë¦¬ ê°€ëŠ¥ (í•„ìš”ì‹œ)
            }
            
            return JSON.parse(buffer);
        } catch (error) {
            console.error(`[GeoJSON ìŠ¤íŠ¸ë¦¬ë° ì‹¤íŒ¨] ${url}:`, error);
            throw error;
        }
    }
    
    /**
     * í–‰ì •êµ¬ì—­ ë‹¨ìœ„ë¡œ GeoJSON ë¶„ë¦¬
     */
    separateAdministrativeUnits(geoJson, countryKey) {
        if (!geoJson || !geoJson.features) {
            return geoJson;
        }
        
        const separated = {
            type: 'FeatureCollection',
            features: geoJson.features.map(feature => {
                // ê° featureì— í–‰ì •êµ¬ì—­ ë©”íƒ€ë°ì´í„° ì¶”ê°€
                const props = feature.properties || {};
                props._countryKey = countryKey;
                props._adminUnit = props.admin_level || props.ADMIN_LEVEL || 'unknown';
                props._regionId = props.id || props.regionId || props.stateId || `${countryKey}_${props.name}`;
                
                return {
                    ...feature,
                    properties: props
                };
            })
        };
        
        return separated;
    }
    
    /**
     * ìºì‹œ í¬ê¸° ê´€ë¦¬
     */
    manageCacheSize() {
        let totalSize = 0;
        const entries = Array.from(this.geoJsonPipeline.cache.entries());
        
        // í¬ê¸° ê³„ì‚°
        entries.forEach(([key, value]) => {
            totalSize += value.size || 0;
        });
        
        // ìµœëŒ€ í¬ê¸° ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ í•­ëª© ì œê±°
        if (totalSize > this.geoJsonPipeline.maxCacheSize) {
            entries.sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
            
            while (totalSize > this.geoJsonPipeline.maxCacheSize * 0.8 && entries.length > 0) {
                const [key, value] = entries.shift();
                this.geoJsonPipeline.cache.delete(key);
                totalSize -= value.size || 0;
            }
        }
    }
    
    // ========== ì„±ëŠ¥ ìµœì í™”: ë·°í¬íŠ¸ ê¸°ë°˜ ë¡œë”© ë° ì¿¼ë“œíŠ¸ë¦¬ íƒ€ì¼ë§ ==========
    
    /**
     * ì¿¼ë“œíŠ¸ë¦¬ ì¸ë±ìŠ¤ ì´ˆê¸°í™”
     */
    initQuadtree(features) {
        if (!features || features.length === 0) return;
        
        // ê°„ë‹¨í•œ ê³µê°„ ì¸ë±ìŠ¤ êµ¬ì¡° ìƒì„±
        this.quadtree = {
            bounds: this.calculateBounds(features),
            features: features,
            tiles: new Map()
        };
        
        // íƒ€ì¼ ë¶„í•  (ê°„ë‹¨í•œ ê·¸ë¦¬ë“œ ê¸°ë°˜)
        this.createTiles(features);
    }
    
    /**
     * ì „ì²´ bounds ê³„ì‚°
     */
    calculateBounds(features) {
        let minLng = Infinity, minLat = Infinity;
        let maxLng = -Infinity, maxLat = -Infinity;
        
        features.forEach(feature => {
            if (feature.geometry && feature.geometry.coordinates) {
                this.processCoordinates(feature.geometry.coordinates, (lng, lat) => {
                    minLng = Math.min(minLng, lng);
                    minLat = Math.min(minLat, lat);
                    maxLng = Math.max(maxLng, lng);
                    maxLat = Math.max(maxLat, lat);
                });
            }
        });
        
        return { minLng, minLat, maxLng, maxLat };
    }
    
    /**
     * ì¢Œí‘œ ì²˜ë¦¬ í—¬í¼
     */
    processCoordinates(coords, callback) {
        if (Array.isArray(coords[0])) {
            coords.forEach(coord => this.processCoordinates(coord, callback));
        } else {
            callback(coords[0], coords[1]);
        }
    }
    
    /**
     * íƒ€ì¼ ìƒì„± (ê°„ë‹¨í•œ ê·¸ë¦¬ë“œ ê¸°ë°˜)
     */
    createTiles(features, tileSize = 10) {
        if (!this.quadtree) return;
        
        const { bounds } = this.quadtree;
        const lngStep = (bounds.maxLng - bounds.minLng) / tileSize;
        const latStep = (bounds.maxLat - bounds.minLat) / tileSize;
        
        for (let i = 0; i < tileSize; i++) {
            for (let j = 0; j < tileSize; j++) {
                const tileKey = `${i}_${j}`;
                const tileBounds = {
                    minLng: bounds.minLng + i * lngStep,
                    maxLng: bounds.minLng + (i + 1) * lngStep,
                    minLat: bounds.minLat + j * latStep,
                    maxLat: bounds.minLat + (j + 1) * latStep
                };
                
                // íƒ€ì¼ ë‚´ features í•„í„°ë§
                const tileFeatures = features.filter(feature => 
                    this.featureInBounds(feature, tileBounds)
                );
                
                if (tileFeatures.length > 0) {
                    this.quadtree.tiles.set(tileKey, {
                        bounds: tileBounds,
                        features: tileFeatures
                    });
                }
            }
        }
    }
    
    /**
     * Featureê°€ bounds ë‚´ì— ìˆëŠ”ì§€ í™•ì¸
     */
    featureInBounds(feature, bounds) {
        if (!feature.geometry || !feature.geometry.coordinates) return false;
        
        let inBounds = false;
        this.processCoordinates(feature.geometry.coordinates, (lng, lat) => {
            if (lng >= bounds.minLng && lng <= bounds.maxLng &&
                lat >= bounds.minLat && lat <= bounds.maxLat) {
                inBounds = true;
            }
        });
        
        return inBounds;
    }
    
    /**
     * ë·°í¬íŠ¸ ê¸°ë°˜ features ë¡œë“œ
     */
    loadFeaturesForViewport() {
        if (!this.map || !this.quadtree) return;
        
        const bounds = this.map.getBounds();
        const viewportBounds = {
            minLng: bounds.getWest(),
            maxLng: bounds.getEast(),
            minLat: bounds.getSouth(),
            maxLat: bounds.getNorth()
        };
        
        this.viewportBounds = viewportBounds;
        
        // ë·°í¬íŠ¸ì™€ êµì°¨í•˜ëŠ” íƒ€ì¼ ì°¾ê¸°
        const visibleFeatures = [];
        const tilesToLoad = [];
        
        this.quadtree.tiles.forEach((tile, tileKey) => {
            if (this.tilesIntersect(tile.bounds, viewportBounds)) {
                if (!this.loadedTiles.has(tileKey)) {
                    tilesToLoad.push(tileKey);
                }
                visibleFeatures.push(...tile.features);
            }
        });
        
        // ìƒˆ íƒ€ì¼ ë¡œë“œ
        if (tilesToLoad.length > 0) {
            this.loadTiles(tilesToLoad);
        }
        
        return visibleFeatures;
    }
    
    /**
     * íƒ€ì¼ êµì°¨ í™•ì¸
     */
    tilesIntersect(tileBounds, viewportBounds) {
        return !(tileBounds.maxLng < viewportBounds.minLng ||
                 tileBounds.minLng > viewportBounds.maxLng ||
                 tileBounds.maxLat < viewportBounds.minLat ||
                 tileBounds.minLat > viewportBounds.maxLat);
    }
    
    /**
     * íƒ€ì¼ ë¡œë“œ
     */
    loadTiles(tileKeys) {
        tileKeys.forEach(key => {
            if (!this.loadedTiles.has(key)) {
                this.loadedTiles.add(key);
                // íƒ€ì¼ ë¡œë“œ ì´ë²¤íŠ¸ ê¸°ë¡
                this.logEvent('tile_loaded', { tileKey: key });
            }
        });
    }
    
    /**
     * MapLibre ë ˆì´ì–´ ë‹¨ìˆœí™”
     */
    simplifyMapLayers() {
        if (!this.map) return;
        
        // ë¶ˆí•„ìš”í•œ ë ˆì´ì–´ ì œê±° ë° í†µí•©
        const layers = ['regions-fill', 'regions-border', 'regions-hover'];
        
        layers.forEach(layerId => {
            if (this.map.getLayer(layerId)) {
                // ë ˆì´ì–´ ìŠ¤íƒ€ì¼ ìµœì í™”
                const layer = this.map.getLayer(layerId);
                if (layer.type === 'fill') {
                    // fill-opacity ìµœì í™”
                    this.map.setPaintProperty(layerId, 'fill-opacity', [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 0.5,
                        5, 0.7,
                        10, 0.8
                    ]);
                }
            }
        });
    }
    
    // ========== ëª¨ë‹ˆí„°ë§: ì´ë²¤íŠ¸ íŠ¸ë˜í‚¹ ë° ì´ìƒ íƒì§€ ==========
    
    /**
     * ì´ë²¤íŠ¸ ë¡œê¹…
     */
    logEvent(eventType, eventData = {}) {
        const event = {
            type: eventType,
            data: eventData,
            timestamp: Date.now(),
            userId: this.currentUser?.uid || 'anonymous',
            sessionId: this.getSessionId()
        };
        
        // ë¡œê·¸ ì¶”ê°€
        this.monitoring.eventLog.push(event);
        
        // ë¡œê·¸ í¬ê¸° ê´€ë¦¬
        if (this.monitoring.eventLog.length > this.monitoring.maxLogSize) {
            this.monitoring.eventLog.shift();
        }
        
        // Cloud Logging ì „ì†¡ (Firebase Functions ì‚¬ìš©)
        this.sendToCloudLogging(event).catch(err => {
            console.warn('[Cloud Logging ì‹¤íŒ¨]:', err);
        });
        
        // ì´ìƒ íƒì§€
        this.detectAnomalies(event);
    }

    async recordAdminAudit(action, details = {}) {
        if (!this.isFirebaseInitialized || !this.firestore || !this.isAdminLoggedIn) {
            return;
        }

        try {
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auditRef = collection(this.firestore, 'admin_audit');
            await addDoc(auditRef, {
                action,
                details,
                context: {
                    regionId: details.regionId || null,
                    mapMode: this.currentMapMode || null
                },
                actor: {
                    uid: this.currentUser?.uid || 'unknown',
                    email: this.currentUser?.email || null
                },
                createdAt: serverTimestamp()
            });
        } catch (error) {
            console.warn('[ADMIN AUDIT] ê¸°ë¡ ì‹¤íŒ¨:', error);
        }
    }
    
    /**
     * ì„¸ì…˜ ID ìƒì„±/ê°€ì ¸ì˜¤ê¸°
     */
    getSessionId() {
        let sessionId = sessionStorage.getItem('sessionId');
        if (!sessionId) {
            sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            sessionStorage.setItem('sessionId', sessionId);
        }
        return sessionId;
    }
    
    /**
     * Cloud Logging ì „ì†¡
     */
    async sendToCloudLogging(event) {
        if (!this.isFirebaseInitialized || !this.firestore) return;
        
        try {
            const { collection, addDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const logsRef = collection(this.firestore, 'event_logs');
            
            await addDoc(logsRef, {
                ...event,
                timestamp: new Date(event.timestamp)
            });
        } catch (error) {
            // ì¡°ìš©íˆ ì‹¤íŒ¨ (ë¡œê¹…ì€ ë¹„ì¤‘ìš”)
            console.debug('[Cloud Logging ì „ì†¡ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * ì´ìƒ ì…ì°° íƒì§€
     */
    detectAnomalies(event) {
        if (event.type === 'bid_placed') {
            const bidData = event.data;
            const userId = event.userId;
            
            // ë¹ ë¥¸ ì—°ì† ì…ì°° íŒ¨í„´ íƒì§€
            const userBids = this.monitoring.anomalyDetection.rapidBidPatterns.get(userId) || [];
            userBids.push({
                timestamp: event.timestamp,
                amount: bidData.amount,
                regionId: bidData.regionId
            });
            
            // ìµœê·¼ 1ë¶„ ë‚´ ì…ì°° í™•ì¸
            const recentBids = userBids.filter(
                bid => event.timestamp - bid.timestamp < 60000
            );
            
            if (recentBids.length > 5) {
                // 1ë¶„ ë‚´ 5íšŒ ì´ìƒ ì…ì°° ì‹œ ì˜ì‹¬
                this.monitoring.anomalyDetection.suspiciousBids.push({
                    userId,
                    pattern: 'rapid_bidding',
                    count: recentBids.length,
                    timestamp: event.timestamp
                });
                
                this.logEvent('anomaly_detected', {
                    type: 'rapid_bidding',
                    userId,
                    count: recentBids.length
                });
            }
            
            // ìµœê·¼ 10ê°œë§Œ ìœ ì§€
            if (userBids.length > 10) {
                userBids.shift();
            }
            this.monitoring.anomalyDetection.rapidBidPatterns.set(userId, userBids);
            
            // ë¹„ì •ìƒì ìœ¼ë¡œ ë†’ì€ ì…ì°°ê°€ íƒì§€
            if (bidData.amount > 10000) {
                this.monitoring.anomalyDetection.suspiciousBids.push({
                    userId,
                    pattern: 'unusually_high_bid',
                    amount: bidData.amount,
                    timestamp: event.timestamp
                });
            }
        }
    }
    
    /**
     * ì„±ëŠ¥ ë©”íŠ¸ë¦­ ê¸°ë¡
     */
    recordPerformanceMetric(metricType, value) {
        if (!this.monitoring.performanceMetrics[metricType]) {
            this.monitoring.performanceMetrics[metricType] = [];
        }
        
        this.monitoring.performanceMetrics[metricType].push({
            value,
            timestamp: Date.now()
        });
        
        // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
        if (this.monitoring.performanceMetrics[metricType].length > 100) {
            this.monitoring.performanceMetrics[metricType].shift();
        }
    }
    
    // ========== API ë¬¸ì„œí™”: ì™¸ë¶€ íŒŒíŠ¸ë„ˆìš© API ==========
    
    /**
     * ì†Œìœ ê¶Œ ì •ë³´ API (ì™¸ë¶€ íŒŒíŠ¸ë„ˆìš©)
     * GET /api/ownership/:regionId
     */
    async getOwnershipInfo(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionRef = doc(this.firestore, 'regions', regionId);
            const regionSnap = await getDoc(regionRef);
            
            if (!regionSnap.exists()) {
                return { error: 'Region not found', regionId };
            }
            
            const regionData = regionSnap.data();
            
            // ì˜¥ì…˜ ì •ë³´ í™•ì¸
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            const auctionSnap = await getDoc(auctionRef);
            
            let auctionInfo = null;
            if (auctionSnap.exists()) {
                const auctionData = auctionSnap.data();
                auctionInfo = {
                    status: auctionData.status,
                    currentBid: auctionData.currentBid,
                    endTime: auctionData.endTime?.toDate?.()?.toISOString() || null,
                    highestBidder: auctionData.highestBidder || null
                };
            }
            
            return {
                regionId,
                name: regionData.name || regionId,
                owner: regionData.owner || null,
                ownerEmail: regionData.ownerEmail || null,
                purchasedAt: regionData.purchasedAt?.toDate?.()?.toISOString() || null,
                auction: auctionInfo,
                status: auctionInfo ? auctionInfo.status : (regionData.owner ? 'owned' : 'available'),
                metadata: {
                    population: regionData.population || null,
                    area: regionData.area || null,
                    country: regionData.country || null
                }
            };
        } catch (error) {
            console.error('[ì†Œìœ ê¶Œ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨]:', error);
            throw error;
        }
    }
    
    /**
     * ì˜¥ì…˜ ìƒíƒœ API (ì™¸ë¶€ íŒŒíŠ¸ë„ˆìš©)
     * GET /api/auction/:regionId
     */
    async getAuctionStatus(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        try {
            const { doc, getDoc, collection, query, where, getDocs, orderBy, limit } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const auctionRef = doc(this.firestore, 'auctions', regionId);
            const auctionSnap = await getDoc(auctionRef);
            
            if (!auctionSnap.exists()) {
                return { error: 'Auction not found', regionId, status: 'not_started' };
            }
            
            const auctionData = auctionSnap.data();
            
            // ì…ì°° ì´ë ¥ ì¡°íšŒ
            const bidsRef = collection(this.firestore, 'auctions', regionId, 'bids');
            const bidsQuery = query(bidsRef, orderBy('timestamp', 'desc'), limit(10));
            const bidsSnap = await getDocs(bidsQuery);
            
            const bidHistory = [];
            bidsSnap.forEach(doc => {
                const bidData = doc.data();
                bidHistory.push({
                    bidder: bidData.bidder || 'anonymous',
                    amount: bidData.amount,
                    timestamp: bidData.timestamp?.toDate?.()?.toISOString() || null
                });
            });
            
            return {
                regionId,
                status: auctionData.status,
                currentBid: auctionData.currentBid || 0,
                startTime: auctionData.startTime?.toDate?.()?.toISOString() || null,
                endTime: auctionData.endTime?.toDate?.()?.toISOString() || null,
                highestBidder: auctionData.highestBidder || null,
                bidCount: auctionData.bidCount || 0,
                bidHistory: bidHistory.slice(0, 10), // ìµœê·¼ 10ê°œë§Œ
                metadata: {
                    minBidIncrement: auctionData.minBidIncrement || 0.1,
                    extensionMinutes: auctionData.extensionMinutes || 5
                }
            };
        } catch (error) {
            console.error('[ì˜¥ì…˜ ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨]:', error);
            throw error;
        }
    }
    
    /**
     * ì§€ì—­ ì •ë³´ API (ì™¸ë¶€ íŒŒíŠ¸ë„ˆìš©)
     * GET /api/region/:regionId
     */
    async getRegionInfo(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            throw new Error('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionRef = doc(this.firestore, 'regions', regionId);
            const regionSnap = await getDoc(regionRef);
            
            if (!regionSnap.exists()) {
                return { error: 'Region not found', regionId };
            }
            
            const regionData = regionSnap.data();
            
            return {
                regionId,
                name: regionData.name || regionId,
                country: regionData.country || null,
                administrativeLevel: regionData.admin_level || null,
                population: regionData.population || null,
                area: regionData.area || null,
                adPrice: regionData.ad_price || null,
                status: regionData.ad_status || 'available',
                owner: regionData.owner || null,
                ownerEmail: regionData.ownerEmail || null,
                purchasedAt: regionData.purchasedAt?.toDate?.()?.toISOString() || null,
                metadata: {
                    logoUrl: regionData.logoUrl || null,
                    color: regionData.color || null,
                    companyInfo: regionData.companyInfo || null
                }
            };
        } catch (error) {
            console.error('[ì§€ì—­ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨]:', error);
            throw error;
        }
    }
    
    /**
     * API ì—”ë“œí¬ì¸íŠ¸ ì´ˆê¸°í™” (Firebase Functionsì™€ ì—°ë™ ê°€ëŠ¥)
     */
    initAPIEndpoints() {
        // API ì—”ë“œí¬ì¸íŠ¸ë¥¼ ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ (ê°œë°œìš©)
        if (typeof window !== 'undefined') {
            window.WorldMapAPI = {
                getOwnership: (regionId) => this.getOwnershipInfo(regionId),
                getAuction: (regionId) => this.getAuctionStatus(regionId),
                getRegion: (regionId) => this.getRegionInfo(regionId)
            };
            
            console.log('[API ì—”ë“œí¬ì¸íŠ¸ ì´ˆê¸°í™” ì™„ë£Œ]');
            console.log('ì‚¬ìš©ë²•: window.WorldMapAPI.getOwnership(regionId)');
        }
    }
    
    // ========== ì»¤ë®¤ë‹ˆí‹° & ìš´ì˜: ì‹ ê³ /ëª¨ë”ë ˆì´ì…˜ ==========
    
    /**
     * í”½ì…€ ì•„íŠ¸ ì‹ ê³ 
     */
    async reportPixelArt(regionId, reason, details) {
        if (!this.isFirebaseInitialized || !this.firestore || !this.currentUser) {
            this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            return { success: false };
        }
        
        try {
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const reportsRef = collection(this.firestore, 'reports');
            
            const reportData = {
                regionId,
                reason,
                details: details || '',
                reporterId: this.currentUser.uid,
                reporterEmail: this.currentUser.email,
                status: 'pending',
                createdAt: serverTimestamp(),
                reviewedBy: null,
                reviewedAt: null
            };
            
            await addDoc(reportsRef, reportData);
            
            // ì´ë²¤íŠ¸ ë¡œê¹…
            this.logEvent('pixel_art_reported', {
                regionId,
                reason,
                reporterId: this.currentUser.uid
            });
            
            this.showNotification('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ê²€í†  í›„ ì¡°ì¹˜í•˜ê² ìŠµë‹ˆë‹¤.', 'success');
            return { success: true };
        } catch (error) {
            console.error('[ì‹ ê³  ì ‘ìˆ˜ ì‹¤íŒ¨]:', error);
            this.showNotification('ì‹ ê³  ì ‘ìˆ˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: false };
        }
    }
    
    /**
     * ëª¨ë”ë ˆì´ì…˜: ì‹ ê³  ìŠ¹ì¸/ê±°ë¶€
     */
    async moderateReport(reportId, action, moderatorNote = '') {
        if (!this.isFirebaseInitialized || !this.firestore || !this.isModerator()) {
            this.showNotification('ëª¨ë”ë ˆì´í„° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            return { success: false };
        }
        
        try {
            const { doc, updateDoc, serverTimestamp, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const reportRef = doc(this.firestore, 'reports', reportId);
            const reportSnap = await getDoc(reportRef);
            
            if (!reportSnap.exists()) {
                this.showNotification('í•´ë‹¹ ì‹ ê³ ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return { success: false };
            }

            const reportData = reportSnap.data();
            
            if (action === 'approve') {
                // ì‹ ê³  ìŠ¹ì¸: í”½ì…€ ì•„íŠ¸ ì‚­ì œ
                // í”½ì…€ ì•„íŠ¸ ì´ˆê¸°í™”
                await this.resetPixelArt(reportData.regionId);
                
                await updateDoc(reportRef, {
                    status: 'approved',
                    reviewedBy: this.currentUser.uid,
                    reviewedAt: serverTimestamp(),
                    moderatorNote
                });
                
                this.logEvent('report_approved', {
                    reportId,
                    regionId: reportData.regionId,
                    moderatorId: this.currentUser.uid
                });
                this.recordAdminAudit('report.approve', {
                    reportId,
                    regionId: reportData.regionId,
                    moderatorNote
                });
                
                this.showNotification('ì‹ ê³ ê°€ ìŠ¹ì¸ë˜ì–´ í”½ì…€ ì•„íŠ¸ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else if (action === 'reject') {
                // ì‹ ê³  ê±°ë¶€
                await updateDoc(reportRef, {
                    status: 'rejected',
                    reviewedBy: this.currentUser.uid,
                    reviewedAt: serverTimestamp(),
                    moderatorNote
                });
                
                this.logEvent('report_rejected', {
                    reportId,
                    moderatorId: this.currentUser.uid
                });
                this.recordAdminAudit('report.reject', {
                    reportId,
                    regionId: reportData.regionId,
                    moderatorNote
                });
                
                this.showNotification('ì‹ ê³ ê°€ ê±°ë¶€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
            
            // ëª¨ë”ë ˆì´ì…˜ íŒ¨ë„ ìƒˆë¡œê³ ì¹¨
            await this.loadModerationReports();
            
            return { success: true };
        } catch (error) {
            console.error('[ëª¨ë”ë ˆì´ì…˜ ì²˜ë¦¬ ì‹¤íŒ¨]:', error);
            this.showNotification('ëª¨ë”ë ˆì´ì…˜ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: false };
        }
    }
    
    /**
     * ëª¨ë”ë ˆì´í„° ê¶Œí•œ í™•ì¸
     */
    isModerator() {
        if (!this.currentUser) return false;
        
        // ê´€ë¦¬ìëŠ” ìë™ìœ¼ë¡œ ëª¨ë”ë ˆì´í„°
        if (this.isAdminLoggedIn) return true;
        
        // Firestoreì—ì„œ ëª¨ë”ë ˆì´í„° ëª©ë¡ í™•ì¸ (ìºì‹œ ì‚¬ìš©)
        return this.community.moderators.has(this.currentUser.uid);
    }
    
    /**
     * ëª¨ë”ë ˆì´í„° ëª©ë¡ ë¡œë“œ
     */
    async loadModerators() {
        if (!this.isFirebaseInitialized || !this.firestore) return;
        
        try {
            const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const moderatorsRef = collection(this.firestore, 'moderators');
            const snapshot = await getDocs(moderatorsRef);
            
            this.community.moderators.clear();
            snapshot.forEach(doc => {
                const data = doc.data();
                if (data.userId) {
                    this.community.moderators.add(data.userId);
                }
            });
            
            // ëª¨ë”ë ˆì´í„° ì„¹ì…˜ í‘œì‹œ/ìˆ¨ê¹€
            const moderatorSection = document.getElementById('side-moderator-section');
            if (moderatorSection) {
                moderatorSection.style.display = this.isModerator() ? 'block' : 'none';
            }
        } catch (error) {
            console.error('[ëª¨ë”ë ˆì´í„° ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * ëª¨ë”ë ˆì´ì…˜ ì‹ ê³  ëª©ë¡ ë¡œë“œ
     */
    async loadModerationReports(status = 'pending') {
        if (!this.isFirebaseInitialized || !this.firestore) return;
        
        try {
            const { collection, query, where, getDocs, orderBy } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const reportsRef = collection(this.firestore, 'reports');
            const q = query(
                reportsRef,
                where('status', '==', status),
                orderBy('createdAt', 'desc')
            );
            const snapshot = await getDocs(q);
            
            const reports = [];
            snapshot.forEach(doc => {
                reports.push({
                    id: doc.id,
                    ...doc.data()
                });
            });
            
            this.renderModerationReports(reports, status);
        } catch (error) {
            console.error('[ëª¨ë”ë ˆì´ì…˜ ì‹ ê³  ë¡œë“œ ì‹¤íŒ¨]:', error);
        }
    }
    
    /**
     * ëª¨ë”ë ˆì´ì…˜ ì‹ ê³  ëª©ë¡ ë Œë”ë§
     */
    renderModerationReports(reports, status) {
        const listEl = document.getElementById('moderation-list');
        if (!listEl) return;
        
        // ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
        while (listEl.firstChild) {
            listEl.removeChild(listEl.firstChild);
        }
        
        if (reports.length === 0) {
            const emptyP = document.createElement('p');
            emptyP.style.textAlign = 'center';
            emptyP.style.color = '#666';
            emptyP.style.padding = '20px';
            emptyP.textContent = 'ì‹ ê³ ê°€ ì—†ìŠµë‹ˆë‹¤.';
            listEl.appendChild(emptyP);
            return;
        }
        
        reports.forEach(report => {
            const item = document.createElement('div');
            item.className = 'moderation-item';
            
            const header = document.createElement('div');
            header.className = 'moderation-item-header';
            const h4 = document.createElement('h4');
            h4.textContent = this.sanitizeHTML(report.regionId || '');
            const statusSpan = document.createElement('span');
            statusSpan.className = `moderation-status status-${report.status}`;
            statusSpan.textContent = this.getStatusLabel(report.status);
            header.appendChild(h4);
            header.appendChild(statusSpan);
            
            const body = document.createElement('div');
            body.className = 'moderation-item-body';
            
            const reasonP = document.createElement('p');
            reasonP.innerHTML = `<strong>ì‚¬ìœ :</strong> ${this.sanitizeHTML(this.getReasonLabel(report.reason))}`;
            
            const reporterP = document.createElement('p');
            reporterP.innerHTML = `<strong>ì‹ ê³ ì:</strong> ${this.sanitizeHTML(report.reporterEmail || 'ìµëª…')}`;
            
            const detailsP = document.createElement('p');
            detailsP.innerHTML = `<strong>ìƒì„¸:</strong> ${this.sanitizeHTML(report.details || 'ì—†ìŒ')}`;
            
            const dateP = document.createElement('p');
            const dateStr = report.createdAt?.toDate?.()?.toLocaleString() || 'ì•Œ ìˆ˜ ì—†ìŒ';
            dateP.innerHTML = `<strong>ì‹ ê³ ì¼:</strong> ${this.sanitizeHTML(dateStr)}`;
            
            body.appendChild(reasonP);
            body.appendChild(reporterP);
            body.appendChild(detailsP);
            body.appendChild(dateP);
            
            if (status === 'pending') {
                const actions = document.createElement('div');
                actions.className = 'moderation-item-actions';
                
                const approveBtn = document.createElement('button');
                approveBtn.className = 'moderation-btn approve-btn';
                approveBtn.dataset.reportId = report.id;
                approveBtn.textContent = 'ìŠ¹ì¸';
                
                const rejectBtn = document.createElement('button');
                rejectBtn.className = 'moderation-btn reject-btn';
                rejectBtn.dataset.reportId = report.id;
                rejectBtn.textContent = 'ê±°ë¶€';
                
                actions.appendChild(approveBtn);
                actions.appendChild(rejectBtn);
                item.appendChild(actions);
            }
            
            item.appendChild(header);
            item.appendChild(body);
            listEl.appendChild(item);
        });
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        if (status === 'pending') {
            listEl.querySelectorAll('.approve-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.moderateReport(btn.dataset.reportId, 'approve');
                });
            });
            
            listEl.querySelectorAll('.reject-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    this.moderateReport(btn.dataset.reportId, 'reject');
                });
            });
        }
    }
    
    /**
     * ìƒíƒœ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
     */
    getStatusLabel(status) {
        const labels = {
            'pending': 'ëŒ€ê¸° ì¤‘',
            'approved': 'ìŠ¹ì¸ë¨',
            'rejected': 'ê±°ë¶€ë¨'
        };
        return labels[status] || status;
    }
    
    /**
     * ì‹ ê³  ì‚¬ìœ  ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
     */
    getReasonLabel(reason) {
        const labels = {
            'inappropriate': 'ë¶€ì ì ˆí•œ ë‚´ìš©',
            'spam': 'ìŠ¤íŒ¸/ê´‘ê³ ',
            'copyright': 'ì €ì‘ê¶Œ ì¹¨í•´',
            'harassment': 'ê´´ë¡­í˜/í˜ì˜¤ í‘œí˜„',
            'other': 'ê¸°íƒ€'
        };
        return labels[reason] || reason;
    }
    
    /**
     * í”½ì…€ ì•„íŠ¸ ì´ˆê¸°í™”
     */
    async resetPixelArt(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore) return;
        
        try {
            const { doc, deleteDoc, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // í”½ì…€ ì•„íŠ¸ ë°ì´í„° ì‚­ì œ
            const pixelArtRef = doc(this.firestore, 'pixelArt', regionId);
            await deleteDoc(pixelArtRef);
            
            // í¸ì§‘ ì´ë ¥ ì‚­ì œ
            const editsRef = collection(this.firestore, 'pixelArt', regionId, 'edits');
            const editsSnap = await getDocs(editsRef);
            const deletePromises = editsSnap.docs.map(d => deleteDoc(d.ref));
            await Promise.all(deletePromises);
            
            // ë²„ì „ íˆìŠ¤í† ë¦¬ ì‚­ì œ
            const versionsRef = collection(this.firestore, 'pixelArt', regionId, 'versions');
            const versionsSnap = await getDocs(versionsRef);
            const versionDeletePromises = versionsSnap.docs.map(d => deleteDoc(d.ref));
            await Promise.all(versionDeletePromises);
            
            this.logEvent('pixel_art_reset', { regionId, reason: 'moderation' });
            this.recordAdminAudit('pixel.reset', { regionId });
        } catch (error) {
            console.error('[í”½ì…€ ì•„íŠ¸ ì´ˆê¸°í™” ì‹¤íŒ¨]:', error);
            throw error;
        }
    }
    
    // ========== ì»¤ë®¤ë‹ˆí‹° & ìš´ì˜: ì´ë²¤íŠ¸ ë° ì›”ê°„ë¦¬í¬íŠ¸ ì œê±°ë¨ ==========
    
    // ========== ì»¤ë®¤ë‹ˆí‹° & ìš´ì˜: ì§€ì†ê°€ëŠ¥ì„± ==========
    
    /**
     * ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬ ê°€ì´ë“œ ìƒì„±
     */
    generateContributionGuide() {
        return {
            title: 'ì˜¤í”ˆì†ŒìŠ¤ ê¸°ì—¬ ê°€ì´ë“œ',
            sections: [
                {
                    title: 'ê¸°ì—¬ ë°©ë²•',
                    content: [
                        '1. GitHub ì €ì¥ì†Œë¥¼ Forkí•©ë‹ˆë‹¤',
                        '2. ìƒˆë¡œìš´ ë¸Œëœì¹˜ë¥¼ ìƒì„±í•©ë‹ˆë‹¤ (git checkout -b feature/amazing-feature)',
                        '3. ë³€ê²½ì‚¬í•­ì„ ì»¤ë°‹í•©ë‹ˆë‹¤ (git commit -m "Add amazing feature")',
                        '4. ë¸Œëœì¹˜ì— í‘¸ì‹œí•©ë‹ˆë‹¤ (git push origin feature/amazing-feature)',
                        '5. Pull Requestë¥¼ ìƒì„±í•©ë‹ˆë‹¤'
                    ]
                },
                {
                    title: 'ì½”ë“œ ìŠ¤íƒ€ì¼',
                    content: [
                        'JavaScript: ES6+ ë¬¸ë²• ì‚¬ìš©',
                        'ë“¤ì—¬ì“°ê¸°: 4 spaces',
                        'ë³€ìˆ˜ëª…: camelCase',
                        'í•¨ìˆ˜ëª…: ë™ì‚¬ë¡œ ì‹œì‘ (ì˜ˆ: getData, updateUser)'
                    ]
                },
                {
                    title: 'ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™',
                    content: [
                        'í˜•ì‹: [íƒ€ì…] ê°„ë‹¨í•œ ì„¤ëª…',
                        'íƒ€ì…: feat, fix, docs, style, refactor, test, chore',
                        'ì˜ˆì‹œ: [feat] í”½ì…€ ì•„íŠ¸ ì‹ ê³  ê¸°ëŠ¥ ì¶”ê°€'
                    ]
                }
            ]
        };
    }
    
    /**
     * ëª¨ë”ë ˆì´í„° í”„ë¡œê·¸ë¨ ì •ë³´
     */
    getModeratorProgramInfo() {
        return {
            title: 'ì»¤ë®¤ë‹ˆí‹° ëª¨ë”ë ˆì´í„° í”„ë¡œê·¸ë¨',
            description: 'í”Œë«í¼ì˜ ê±´ê°•í•œ ì»¤ë®¤ë‹ˆí‹°ë¥¼ ìœ„í•´ ëª¨ë”ë ˆì´í„°ë¥¼ ëª¨ì§‘í•©ë‹ˆë‹¤.',
            requirements: [
                'í”Œë«í¼ ì´ìš© ê²½ë ¥ 3ê°œì›” ì´ìƒ',
                'ì‹ ê³  ì²˜ë¦¬ ê²½í—˜ ë˜ëŠ” ì»¤ë®¤ë‹ˆí‹° ê´€ë¦¬ ê²½í—˜',
                'ê³µì •í•˜ê³  ê°ê´€ì ì¸ íŒë‹¨ ëŠ¥ë ¥',
                'ì£¼ 5ì‹œê°„ ì´ìƒ í™œë™ ê°€ëŠ¥'
            ],
            benefits: [
                'ëª¨ë”ë ˆì´í„° ë°°ì§€ ë° íŠ¹ë³„ ê¶Œí•œ',
                'ì›”ê°„ í™œë™ ë³´ìƒ',
                'ì»¤ë®¤ë‹ˆí‹° ë¦¬ë”ì‹­ ì¸ì •',
                'í”Œë«í¼ ê°œë°œì— ì°¸ì—¬í•  ê¸°íšŒ'
            ],
            applicationLink: 'mailto:moderator@worldadvertisingmap.com'
        };
    }
    
    /**
     * ì»¤ë®¤ë‹ˆí‹° ê¸°ëŠ¥ ì´ˆê¸°í™”
     */
    initCommunityFeatures() {
        // ëª¨ë”ë ˆì´í„° ëª©ë¡ ë¡œë“œ
        this.loadModerators();
        
        // ì»¤ë®¤ë‹ˆí‹° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        this.setupCommunityEventListeners();
    }
    
    /**
     * ì»¤ë®¤ë‹ˆí‹° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    setupCommunityEventListeners() {
        // ì‹ ê³  ë²„íŠ¼
        const reportBtn = document.getElementById('pixel-report-btn');
        if (reportBtn) {
            reportBtn.addEventListener('click', () => {
                if (!this.currentRegion) {
                    this.showNotification('ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                this.showReportModal();
            });
        }
        
        // ì‹ ê³  ëª¨ë‹¬ ë‹«ê¸°
        const closeReportModal = document.getElementById('close-report-modal');
        if (closeReportModal) {
            closeReportModal.addEventListener('click', () => {
                document.getElementById('report-modal')?.classList.add('hidden');
            });
        }
        
        // ì‹ ê³  ì œì¶œ
        const submitReportBtn = document.getElementById('submit-report-btn');
        if (submitReportBtn) {
            submitReportBtn.addEventListener('click', async () => {
                if (!this.currentRegion) return;
                
                const reason = document.getElementById('report-reason')?.value;
                const details = document.getElementById('report-details')?.value;
                
                if (!reason) {
                    this.showNotification('ì‹ ê³  ì‚¬ìœ ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                    return;
                }
                
                await this.reportPixelArt(this.currentRegion.id, reason, details);
                document.getElementById('report-modal')?.classList.add('hidden');
            });
        }
        
        // ëª¨ë”ë ˆì´ì…˜ íŒ¨ë„
        const moderationBtn = document.getElementById('side-moderation-btn');
        if (moderationBtn) {
            moderationBtn.addEventListener('click', () => {
                this.showModerationPanel();
            });
        }
        
        const closeModerationPanel = document.getElementById('close-moderation-panel');
        if (closeModerationPanel) {
            closeModerationPanel.addEventListener('click', () => {
                document.getElementById('moderation-panel')?.classList.add('hidden');
            });
        }
        
        // ëª¨ë”ë ˆì´ì…˜ íƒ­ ì „í™˜
        const moderationTabs = document.querySelectorAll('.moderation-tabs .tab-btn');
        moderationTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                moderationTabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                this.loadModerationReports(tab.dataset.tab);
            });
        });
        
        // ì´ë²¤íŠ¸ ë° ì›”ê°„ë¦¬í¬íŠ¸ ëª¨ë‹¬ ì œê±°ë¨
    }
    
    /**
     * ì‹ ê³  ëª¨ë‹¬ í‘œì‹œ
     */
    showReportModal() {
        const modal = document.getElementById('report-modal');
        if (modal) {
            modal.classList.remove('hidden');
            // í¼ ì´ˆê¸°í™”
            document.getElementById('report-reason').value = 'inappropriate';
            document.getElementById('report-details').value = '';
        }
    }
    
    /**
     * ëª¨ë”ë ˆì´ì…˜ íŒ¨ë„ í‘œì‹œ
     */
    async showModerationPanel() {
        if (!this.isModerator()) {
            this.showNotification('ëª¨ë”ë ˆì´í„° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
            return;
        }
        
        const panel = document.getElementById('moderation-panel');
        if (panel) {
            panel.classList.remove('hidden');
            await this.loadModerationReports('pending');
        }
    }
    
    // ì´ë²¤íŠ¸ ë° ì›”ê°„ë¦¬í¬íŠ¸ ëª¨ë‹¬ í•¨ìˆ˜ ì œê±°ë¨
    
    // ========== ì˜¨ë³´ë”© íˆ¬ì–´ ==========
    
    /**
     * ì˜¨ë³´ë”© íˆ¬ì–´ ì´ˆê¸°í™”
     */
    initOnboardingTour() {
        // ì²« ë°©ë¬¸ ì—¬ë¶€ í™•ì¸ (localStorage)
        const hasSeenTour = localStorage.getItem('hasSeenOnboardingTour');
        if (hasSeenTour === 'true') {
            return; // ì´ë¯¸ ë³¸ ê²½ìš° íˆ¬ì–´ í‘œì‹œ ì•ˆ í•¨
        }
        
        // ì•½ê°„ì˜ ì§€ì—° í›„ íˆ¬ì–´ ì‹œì‘ (ì§€ë„ ë¡œë“œ ì™„ë£Œ í›„)
        setTimeout(() => {
            this.startOnboardingTour();
        }, 2000);
    }
    
    /**
     * ì˜¨ë³´ë”© íˆ¬ì–´ ì‹œì‘
     */
    startOnboardingTour() {
        const tour = document.getElementById('onboarding-tour');
        if (!tour) return;
        
        tour.classList.remove('hidden');
        this.currentTourStep = 1;
        this.updateTourStep();
        this.setupTourEventListeners();
        if (!this.tourResizeHandler) {
            this.tourResizeHandler = () => this.updateTourHighlight();
            window.addEventListener('resize', this.tourResizeHandler);
        }
    }
    
    /**
     * ì˜¨ë³´ë”© íˆ¬ì–´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
     */
    setupTourEventListeners() {
        const tourNext = document.getElementById('tour-next');
        const tourPrev = document.getElementById('tour-prev');
        const tourSkip = document.getElementById('tour-skip');
        const tourClose = document.getElementById('tour-close');
        const tourFinish = document.getElementById('tour-finish');
        
        if (tourNext) {
            tourNext.addEventListener('click', () => this.nextTourStep());
        }
        if (tourPrev) {
            tourPrev.addEventListener('click', () => this.prevTourStep());
        }
        if (tourSkip || tourClose) {
            const skipHandler = () => this.finishTour();
            if (tourSkip) tourSkip.addEventListener('click', skipHandler);
            if (tourClose) tourClose.addEventListener('click', skipHandler);
        }
        if (tourFinish) {
            tourFinish.addEventListener('click', () => this.finishTour());
        }
    }
    
    /**
     * ë‹¤ìŒ íˆ¬ì–´ ë‹¨ê³„
     */
    nextTourStep() {
        if (this.currentTourStep < 4) {
            this.currentTourStep++;
            this.updateTourStep();
        }
    }
    
    /**
     * ì´ì „ íˆ¬ì–´ ë‹¨ê³„
     */
    prevTourStep() {
        if (this.currentTourStep > 1) {
            this.currentTourStep--;
            this.updateTourStep();
        }
    }
    
    /**
     * íˆ¬ì–´ ë‹¨ê³„ ì—…ë°ì´íŠ¸
     */
    updateTourStep() {
        const steps = document.querySelectorAll('.tour-step');
        const tourPrev = document.getElementById('tour-prev');
        const tourNext = document.getElementById('tour-next');
        const tourFinish = document.getElementById('tour-finish');
        const tourSkip = document.getElementById('tour-skip');
        
        steps.forEach((step, index) => {
            if (index + 1 === this.currentTourStep) {
                step.classList.add('active');
            } else {
                step.classList.remove('active');
            }
        });
        
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        if (tourPrev) {
            tourPrev.disabled = this.currentTourStep === 1;
        }
        if (tourNext) {
            tourNext.classList.toggle('hidden', this.currentTourStep === 4);
        }
        if (tourFinish) {
            tourFinish.classList.toggle('hidden', this.currentTourStep !== 4);
        }
        if (tourSkip) {
            tourSkip.classList.toggle('hidden', this.currentTourStep === 4);
        }
        
        // í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸ (ê° ë‹¨ê³„ë³„ë¡œ ë‹¤ë¥¸ ìš”ì†Œ í•˜ì´ë¼ì´íŠ¸)
        this.updateTourHighlight();
    }

    /**
     * í˜„ì¬ íˆ¬ì–´ ë‹¨ê³„ì— ëŒ€í•œ í•˜ì´ë¼ì´íŠ¸ ì„¤ì • ë°˜í™˜
     */
    getTourHighlightConfig(step = this.currentTourStep) {
        const configByStep = {
            1: {
                element: document.getElementById('map-container'),
                padding: 40,
                borderRadius: 24
            },
            2: {
                element: document.getElementById('auction-modal'),
                padding: 24
            },
            3: {
                element: document.getElementById('pixel-studio-modal'),
                padding: 24
            },
            4: {
                element: document.getElementById('side-menu'),
                padding: 20
            }
        };
        const fallback = {
            element: null,
            padding: 16
        };
        const config = configByStep[step] || fallback;
        return {
            ...config,
            minWidth: 140,
            minHeight: 90,
            borderRadius: config.borderRadius ?? 18
        };
    }

    /**
     * ìš”ì†Œê°€ ì‹¤ì œë¡œ í‘œì‹œ ì¤‘ì¸ì§€ í™•ì¸
     */
    isElementHighlightable(element) {
        if (!element) {
            return false;
        }
        const styles = window.getComputedStyle(element);
        if (styles.display === 'none' || styles.visibility === 'hidden' || Number(styles.opacity) === 0) {
            return false;
        }
        if (element.classList && element.classList.contains('hidden')) {
            return false;
        }
        const rect = element.getBoundingClientRect();
        return rect.width > 0 && rect.height > 0;
    }
    
    /**
     * íˆ¬ì–´ í•˜ì´ë¼ì´íŠ¸ ì—…ë°ì´íŠ¸
     */
    updateTourHighlight() {
        const highlightId = `tour-highlight-${this.currentTourStep}`;
        document.querySelectorAll('.tour-highlight').forEach((el) => {
            if (el.id !== highlightId) {
                el.style.display = 'none';
                el.classList.remove('visible');
            }
        });

        const highlight = document.getElementById(highlightId);
        if (!highlight) {
            return;
        }

        const { element, padding, minWidth, minHeight, borderRadius } = this.getTourHighlightConfig(this.currentTourStep);
        if (!this.isElementHighlightable(element)) {
            highlight.style.display = 'none';
            highlight.classList.remove('visible');
            return;
        }

        const rect = element.getBoundingClientRect();
        const viewportPadding = 8;
        const top = Math.max(rect.top - padding, viewportPadding);
        const left = Math.max(rect.left - padding, viewportPadding);
        const width = Math.min(
            rect.width + padding * 2,
            window.innerWidth - left - viewportPadding
        );
        const height = Math.min(
            rect.height + padding * 2,
            window.innerHeight - top - viewportPadding
        );

        highlight.style.top = `${top}px`;
        highlight.style.left = `${left}px`;
        highlight.style.width = `${Math.max(width, minWidth)}px`;
        highlight.style.height = `${Math.max(height, minHeight)}px`;
        highlight.style.borderRadius = `${borderRadius}px`;
        highlight.style.display = 'block';
        highlight.classList.remove('visible');

        requestAnimationFrame(() => {
            if (highlight.style.display === 'block') {
                highlight.classList.add('visible');
            }
        });
    }
    
    /**
     * íˆ¬ì–´ ì™„ë£Œ
     */
    finishTour() {
        const tour = document.getElementById('onboarding-tour');
        if (tour) {
            tour.classList.add('hidden');
        }
        document.querySelectorAll('.tour-highlight').forEach((el) => {
            el.style.display = 'none';
            el.classList.remove('visible');
        });
        if (this.tourResizeHandler) {
            window.removeEventListener('resize', this.tourResizeHandler);
            this.tourResizeHandler = null;
        }
        localStorage.setItem('hasSeenOnboardingTour', 'true');
    }
    
    // ========== ëª¨ë°”ì¼ ìµœì í™” ==========
    
    /**
     * ëª¨ë°”ì¼ ìµœì í™” ì´ˆê¸°í™”
     */
    initMobileOptimization() {
        // ëª¨ë°”ì¼ í™”ë©´ ê°ì§€
        this.checkMobileView();
        
        // ë¦¬ì‚¬ì´ì¦ˆ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        window.addEventListener('resize', () => {
            this.checkMobileView();
        });
        
        // ëª¨ë°”ì¼ ì „í™˜ ë²„íŠ¼ ì´ë²¤íŠ¸
        const mapViewBtn = document.getElementById('mobile-map-view-btn');
        const listViewBtn = document.getElementById('mobile-list-view-btn');
        const listCloseBtn = document.getElementById('mobile-list-close');
        
        if (mapViewBtn) {
            mapViewBtn.addEventListener('click', () => this.switchToMapView());
        }
        if (listViewBtn) {
            listViewBtn.addEventListener('click', () => this.switchToListView());
        }
        if (listCloseBtn) {
            listCloseBtn.addEventListener('click', () => this.switchToMapView());
        }
    }
    
    /**
     * ëª¨ë°”ì¼ í™”ë©´ ê°ì§€
     */
    checkMobileView() {
        const isMobile = window.innerWidth <= 768;
        const toggle = document.getElementById('mobile-view-toggle');
        
        if (toggle) {
            if (isMobile) {
                toggle.classList.remove('hidden');
            } else {
                toggle.classList.add('hidden');
                // ë°ìŠ¤í¬í†±ì—ì„œëŠ” í•­ìƒ ì§€ë„ ë·°
                this.switchToMapView();
            }
        }
    }
    
    /**
     * ì§€ë„ ë·°ë¡œ ì „í™˜
     */
    switchToMapView() {
        const mapContainer = document.getElementById('map-container');
        const listView = document.getElementById('mobile-list-view');
        const mapViewBtn = document.getElementById('mobile-map-view-btn');
        const listViewBtn = document.getElementById('mobile-list-view-btn');
        
        if (mapContainer) {
            mapContainer.classList.remove('mobile-list-mode');
        }
        if (listView) {
            listView.classList.remove('active');
        }
        if (mapViewBtn) {
            mapViewBtn.classList.add('active');
        }
        if (listViewBtn) {
            listViewBtn.classList.remove('active');
        }
    }
    
    /**
     * ë¦¬ìŠ¤íŠ¸ ë·°ë¡œ ì „í™˜
     */
    async switchToListView() {
        const mapContainer = document.getElementById('map-container');
        const listView = document.getElementById('mobile-list-view');
        const mapViewBtn = document.getElementById('mobile-map-view-btn');
        const listViewBtn = document.getElementById('mobile-list-view-btn');
        
        if (mapContainer) {
            mapContainer.classList.add('mobile-list-mode');
        }
        if (listView) {
            listView.classList.add('active');
        }
        if (mapViewBtn) {
            mapViewBtn.classList.remove('active');
        }
        if (listViewBtn) {
            listViewBtn.classList.add('active');
        }
        
        // ì˜¥ì…˜ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
        await this.loadMobileAuctionList();
    }
    
    /**
     * ëª¨ë°”ì¼ ì˜¥ì…˜ ë¦¬ìŠ¤íŠ¸ ë¡œë“œ
     */
    async loadMobileAuctionList() {
        const listContainer = document.getElementById('mobile-auction-list');
        if (!listContainer) return;
        
        // ì˜¥ì…˜ ëŒ€ì‹œë³´ë“œì˜ ì˜¥ì…˜ ë¡œë“œ í•¨ìˆ˜ ì¬ì‚¬ìš©
        await this.loadDashboardAuctions('active');
        
        // ë¡œë“œëœ ì˜¥ì…˜ì„ ëª¨ë°”ì¼ ë¦¬ìŠ¤íŠ¸ì— í‘œì‹œ
        const dashboardList = document.getElementById('dashboard-auction-list');
        if (dashboardList && dashboardList.innerHTML) {
            listContainer.innerHTML = dashboardList.innerHTML;
            
            // ì˜¥ì…˜ í•­ëª© í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            listContainer.querySelectorAll('.dashboard-auction-item').forEach(item => {
                item.addEventListener('click', () => {
                    const auctionId = item.dataset.auctionId;
                    if (auctionId) {
                        this.openAuctionModal(auctionId);
                        this.switchToMapView(); // ì§€ë„ ë·°ë¡œ ëŒì•„ê°€ê¸°
                    }
                });
            });
        }
    }
    
    // ==================== ë©”ëª¨ë¦¬ ìµœì í™” í•¨ìˆ˜ ====================
    
    /**
     * ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ ë° ì •ë¦¬
     */
    initMemoryOptimization() {
        // ì£¼ê¸°ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì •ë¦¬ (5ë¶„ë§ˆë‹¤)
        setInterval(() => {
            this.cleanupMemory();
        }, 5 * 60 * 1000);
        
        // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì‹œ ë©”ëª¨ë¦¬ ì •ë¦¬
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                this.cleanupMemory();
            }
        });
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ëª¨ë‹ˆí„°ë§ (ê°œë°œ ëª¨ë“œ)
        if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
            setInterval(() => {
                this.logMemoryUsage();
            }, 30 * 1000);
        }
    }
    
    /**
     * ë©”ëª¨ë¦¬ ì •ë¦¬ í•¨ìˆ˜
     */
    cleanupMemory() {
        const startTime = performance.now();
        let cleanedCount = 0;
        
        // 1. ì˜¤ë˜ëœ ìºì‹œ ë°ì´í„° ì •ë¦¬
        cleanedCount += this.cleanupOldCache();
        
        // 2. ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
        cleanedCount += this.cleanupUnusedListeners();
        
        // 3. ëª¨ë‹ˆí„°ë§ ë¡œê·¸ ì •ë¦¬
        this.cleanupMonitoringLogs();
        
        // 4. GeoJSON ìºì‹œ í¬ê¸° ì œí•œ
        this.limitGeoJsonCache();
        
        // 5. ì´ë²¤íŠ¸ ë¡œê·¸ ì •ë¦¬
        this.cleanupEventLogs();
        
        const duration = performance.now() - startTime;
        if (cleanedCount > 0) {
            console.log(`[ë©”ëª¨ë¦¬ ì •ë¦¬] ${cleanedCount}ê°œ í•­ëª© ì •ë¦¬ ì™„ë£Œ (${duration.toFixed(2)}ms)`);
        }
    }
    
    /**
     * ì˜¤ë˜ëœ ìºì‹œ ë°ì´í„° ì •ë¦¬
     */
    cleanupOldCache() {
        let cleaned = 0;
        const now = Date.now();
        const maxAge = 30 * 60 * 1000; // 30ë¶„
        
        // regionDataLoadState ì •ë¦¬
        for (const [key, value] of this.regionDataLoadState.entries()) {
            if (value.timestamp && (now - value.timestamp) > maxAge) {
                this.regionDataLoadState.delete(key);
                cleaned++;
            }
        }
        
        // rawGeoJsonCache ì •ë¦¬ (í¬ê¸° ê¸°ë°˜)
        const maxCacheSize = 100 * 1024 * 1024; // 100MB
        let currentSize = 0;
        const cacheEntries = Object.entries(this.rawGeoJsonCache);
        
        // í¬ê¸° ê³„ì‚° ë° ì •ë¦¬
        for (const [key, value] of cacheEntries) {
            const size = JSON.stringify(value).length;
            currentSize += size;
            
            if (currentSize > maxCacheSize) {
                delete this.rawGeoJsonCache[key];
                cleaned++;
                currentSize -= size;
            }
        }
        
        // geoJsonPipeline ìºì‹œ ì •ë¦¬
        if (this.geoJsonPipeline.cache.size > 50) {
            // LRU ë°©ì‹ìœ¼ë¡œ ì˜¤ë˜ëœ í•­ëª© ì œê±°
            const entries = Array.from(this.geoJsonPipeline.cache.entries());
            entries.sort((a, b) => (b[1].lastAccessed || 0) - (a[1].lastAccessed || 0));
            
            // ìƒìœ„ 50ê°œë§Œ ìœ ì§€
            const toKeep = entries.slice(0, 50);
            this.geoJsonPipeline.cache.clear();
            toKeep.forEach(([key, value]) => {
                this.geoJsonPipeline.cache.set(key, value);
            });
            cleaned += entries.length - 50;
        }
        
        return cleaned;
    }
    
    /**
     * ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì‹¤ì‹œê°„ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬
     */
    cleanupUnusedListeners() {
        let cleaned = 0;
        
        // ì˜¥ì…˜ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ (ì¢…ë£Œëœ ì˜¥ì…˜)
        for (const [regionId, listener] of this.auctionListeners.entries()) {
            const auction = this.activeAuctions.get(regionId);
            if (auction && (auction.status === 'ended' || auction.status === 'completed')) {
                listener();
                this.auctionListeners.delete(regionId);
                this.activeAuctions.delete(regionId);
                cleaned++;
            }
        }
        
        // í”½ì…€ ê·¸ë¦¬ë“œ ë¦¬ìŠ¤ë„ˆ ì •ë¦¬ (í˜„ì¬ ë³´ì´ì§€ ì•ŠëŠ” ì§€ì—­)
        if (this.map && this.viewportBounds) {
            for (const [regionId, listener] of this.pixelGridListeners.entries()) {
                // ë·°í¬íŠ¸ ë°–ì— ìˆëŠ” ì§€ì—­ì˜ ë¦¬ìŠ¤ë„ˆëŠ” ìœ ì§€í•˜ë˜, ì˜¤ë˜ëœ ê²ƒì€ ì •ë¦¬
                // ì‹¤ì œë¡œëŠ” ì§€ì—­ì´ ë³´ì¼ ë•Œë§Œ ë¦¬ìŠ¤ë„ˆë¥¼ í™œì„±í™”í•˜ëŠ” ê²ƒì´ ë” ì¢‹ì§€ë§Œ,
                // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœíˆ ë¦¬ìŠ¤ë„ˆ ìˆ˜ë¥¼ ì œí•œ
                if (this.pixelGridListeners.size > 20) {
                    // ê°€ì¥ ì˜¤ë˜ëœ ë¦¬ìŠ¤ë„ˆ ì œê±° (ì‹¤ì œ êµ¬í˜„ ì‹œ íƒ€ì„ìŠ¤íƒ¬í”„ í•„ìš”)
                    listener();
                    this.pixelGridListeners.delete(regionId);
                    cleaned++;
                    break; // í•œ ë²ˆì— í•˜ë‚˜ì”©ë§Œ ì œê±°
                }
            }
        }
        
        return cleaned;
    }
    
    /**
     * ëª¨ë‹ˆí„°ë§ ë¡œê·¸ ì •ë¦¬
     */
    cleanupMonitoringLogs() {
        if (!this.monitoring) return;
        
        // ì´ë²¤íŠ¸ ë¡œê·¸ ì •ë¦¬
        if (this.monitoring.eventLog.length > this.monitoring.maxLogSize) {
            const toRemove = this.monitoring.eventLog.length - this.monitoring.maxLogSize;
            this.monitoring.eventLog.splice(0, toRemove);
        }
        
        // ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì •ë¦¬
        const maxMetrics = 100;
        ['loadTimes', 'renderTimes', 'queryTimes'].forEach(metric => {
            if (this.monitoring.performanceMetrics[metric].length > maxMetrics) {
                const toRemove = this.monitoring.performanceMetrics[metric].length - maxMetrics;
                this.monitoring.performanceMetrics[metric].splice(0, toRemove);
            }
        });
        
        // ì´ìƒ íƒì§€ ë°ì´í„° ì •ë¦¬
        if (this.monitoring.anomalyDetection.suspiciousBids.length > 100) {
            this.monitoring.anomalyDetection.suspiciousBids.splice(0, 50);
        }
    }
    
    /**
     * GeoJSON ìºì‹œ í¬ê¸° ì œí•œ
     */
    limitGeoJsonCache() {
        if (!this.geoJsonPipeline) return;
        
        const maxSize = this.geoJsonPipeline.maxCacheSize || 50 * 1024 * 1024;
        let currentSize = 0;
        const entries = Array.from(this.geoJsonPipeline.cache.entries());
        
        // ê° í•­ëª©ì˜ í¬ê¸° ê³„ì‚°
        const sizedEntries = entries.map(([key, value]) => {
            const size = JSON.stringify(value).length;
            return { key, value, size };
        });
        
        // í¬ê¸° ìˆœìœ¼ë¡œ ì •ë ¬
        sizedEntries.sort((a, b) => b.size - a.size);
        
        // ìµœëŒ€ í¬ê¸° ë‚´ë¡œ ìœ ì§€
        for (const entry of sizedEntries) {
            if (currentSize + entry.size > maxSize) {
                this.geoJsonPipeline.cache.delete(entry.key);
            } else {
                currentSize += entry.size;
            }
        }
    }
    
    /**
     * ì´ë²¤íŠ¸ ë¡œê·¸ ì •ë¦¬
     */
    cleanupEventLogs() {
        // monitoring.eventLogì€ ì´ë¯¸ cleanupMonitoringLogsì—ì„œ ì²˜ë¦¬
        // ì¶”ê°€ë¡œ í•„ìš”í•œ ë¡œê·¸ ì •ë¦¬ ì‘ì—…
    }
    
    /**
     * ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë¡œê¹… (ê°œë°œ ëª¨ë“œ)
     */
    logMemoryUsage() {
        if (!performance.memory) return; // Chromeë§Œ ì§€ì›
        
        const memory = performance.memory;
        const used = (memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
        const total = (memory.totalJSHeapSize / 1024 / 1024).toFixed(2);
        const limit = (memory.jsHeapSizeLimit / 1024 / 1024).toFixed(2);
        
        console.log(`[ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰] ì‚¬ìš©: ${used}MB / ì „ì²´: ${total}MB / ì œí•œ: ${limit}MB`);
        
        // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 80% ì´ìƒì´ë©´ ê²½ê³ 
        if (memory.usedJSHeapSize / memory.jsHeapSizeLimit > 0.8) {
            console.warn('[ë©”ëª¨ë¦¬ ê²½ê³ ] ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ 80%ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤. ì •ë¦¬ë¥¼ ê¶Œì¥í•©ë‹ˆë‹¤.');
            this.cleanupMemory();
        }
    }
    
    /**
     * ë°ì´í„° êµ¬ì¡° ìµœì í™” - ë¶ˆí•„ìš”í•œ ì†ì„± ì œê±°
     */
    optimizeRegionData(regionData) {
        if (!regionData) return regionData;
        
        // ë¶ˆí•„ìš”í•œ ì†ì„± ì œê±° (í•„ìš”í•œ ì†ì„±ë§Œ ìœ ì§€)
        const optimized = {
            id: regionData.id,
            name: regionData.name,
            country: regionData.country,
            population: regionData.population,
            area: regionData.area,
            adminLevel: regionData.adminLevel,
            price: regionData.price,
            status: regionData.status,
            // ê¸°íƒ€ í•„ìˆ˜ ì†ì„±ë§Œ ìœ ì§€
        };
        
        // ì„ íƒì  ì†ì„±ë§Œ ì¶”ê°€
        if (regionData.company) optimized.company = regionData.company;
        if (regionData.logo) optimized.logo = regionData.logo;
        if (regionData.color) optimized.color = regionData.color;
        
        return optimized;
    }
    
    /**
     * GeoJSON ë°ì´í„° ìµœì í™” - ë¶ˆí•„ìš”í•œ ì†ì„± ì œê±°
     */
    optimizeGeoJson(geoJson) {
        if (!geoJson || !geoJson.features) return geoJson;
        
        // ê° featureì˜ properties ìµœì í™” (ì„±ëŠ¥ ìµœì í™” ê°•í™”)
        geoJson.features = geoJson.features.map(feature => {
            if (feature.properties) {
                // í•„ìˆ˜ ì†ì„±ë§Œ ìœ ì§€ (ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ìµœì†Œí™”)
                const optimizedProps = {
                    id: feature.properties.id || feature.properties.regionId, // IDëŠ” í•„ìˆ˜
                };
                
                // ì´ë¦„ì€ ì§§ê²Œ (ìµœëŒ€ 50ì)
                if (feature.properties.name) {
                    optimizedProps.name = String(feature.properties.name).substring(0, 50);
                }
                
                // êµ­ê°€ ì •ë³´ (2ì ì½”ë“œë¡œ ì¶•ì•½ ê°€ëŠ¥)
                if (feature.properties.country) {
                    optimizedProps.country = String(feature.properties.country).substring(0, 30);
                }
                
                // êµ­ê°€ë³„ ìƒ‰ìƒ ì •ë³´ ìœ ì§€ (ì¤‘ìš”!)
                if (feature.properties.country_color) optimizedProps.country_color = feature.properties.country_color;
                if (feature.properties.color) optimizedProps.color = feature.properties.color;
                
                // ê´‘ê³  ìƒíƒœ ë° ì˜¥ì…˜ ìƒíƒœ ìœ ì§€ (ì§§ì€ ë¬¸ìì—´ë§Œ)
                if (feature.properties.ad_status) optimizedProps.ad_status = feature.properties.ad_status;
                if (feature.properties.auction_status) optimizedProps.auction_status = feature.properties.auction_status;
                
                // ìˆ«ì ë°ì´í„°ëŠ” ì •ìˆ˜ë¡œ ë³€í™˜í•˜ì—¬ ë©”ëª¨ë¦¬ ì ˆì•½
                if (feature.properties.population) {
                    const pop = parseInt(feature.properties.population);
                    if (!isNaN(pop) && pop > 0) optimizedProps.population = pop;
                }
                if (feature.properties.area) {
                    const area = parseFloat(feature.properties.area);
                    if (!isNaN(area) && area > 0) optimizedProps.area = Math.round(area * 100) / 100; // ì†Œìˆ˜ì  2ìë¦¬
                }
                
                // geometry ì¢Œí‘œ ì •ë°€ë„ ê°ì†Œ (ì„±ëŠ¥ í–¥ìƒ)
                if (feature.geometry && feature.geometry.coordinates) {
                    feature.geometry = this.simplifyGeometry(feature.geometry);
                }
                
                feature.properties = optimizedProps;
            }
            return feature;
        });
        
        return geoJson;
    }
    
    /**
     * Geometry ì¢Œí‘œ ì •ë°€ë„ ê°ì†Œ (ì„±ëŠ¥ ìµœì í™”)
     */
    simplifyGeometry(geometry) {
        if (!geometry || !geometry.coordinates) return geometry;
        
        const precision = 6; // ì†Œìˆ˜ì  6ìë¦¬ë¡œ ì œí•œ (ì•½ 10cm ì •ë°€ë„)
        
        const simplifyCoords = (coords) => {
            if (Array.isArray(coords[0])) {
                return coords.map(coord => simplifyCoords(coord));
            } else {
                return coords.map(coord => 
                    typeof coord === 'number' ? parseFloat(coord.toFixed(precision)) : coord
                );
            }
        };
        
        try {
            const simplified = JSON.parse(JSON.stringify(geometry));
            simplified.coordinates = simplifyCoords(geometry.coordinates);
            return simplified;
        } catch (e) {
            console.warn('[Geometry ìµœì í™” ì‹¤íŒ¨]:', e);
            return geometry;
        }
    }
    
    
}

// ì „ì—­ ì˜¤ë¥˜ í•¸ë“¤ëŸ¬: COOP ê´€ë ¨ ì˜¤ë¥˜ ë¬´ì‹œ (Firebase SDK ë‚´ë¶€ ì˜¤ë¥˜)
window.addEventListener('error', (event) => {
    // Cross-Origin-Opener-Policy ê´€ë ¨ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ (ì‹¤ì œ ê¸°ëŠ¥ì—ëŠ” ì˜í–¥ ì—†ìŒ)
    if (event.message && (
        event.message.includes('Cross-Origin-Opener-Policy') ||
        event.message.includes('window.close') ||
        event.message.includes('window.closed') ||
        event.message.includes('popup.ts')
    )) {
        event.preventDefault(); // ì½˜ì†”ì— ì˜¤ë¥˜ê°€ í‘œì‹œë˜ì§€ ì•Šë„ë¡
        event.stopPropagation(); // ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€
        return true;
    }
});

// Promise rejection í•¸ë“¤ëŸ¬: COOP ê´€ë ¨ ì˜¤ë¥˜ ë¬´ì‹œ
window.addEventListener('unhandledrejection', (event) => {
    const error = event.reason;
    const errorMessage = error?.message || error?.toString() || '';
    if (errorMessage.includes('Cross-Origin-Opener-Policy') ||
        errorMessage.includes('window.close') ||
        errorMessage.includes('window.closed') ||
        errorMessage.includes('popup.ts')) {
        event.preventDefault(); // ì½˜ì†”ì— ì˜¤ë¥˜ê°€ í‘œì‹œë˜ì§€ ì•Šë„ë¡
        return true;
    }
});

// console.error ì˜¤ë²„ë¼ì´ë“œ: COOP ê´€ë ¨ ì˜¤ë¥˜ í•„í„°ë§
const originalConsoleError = console.error;
console.error = function(...args) {
    const message = args.join(' ');
    if (message.includes('Cross-Origin-Opener-Policy') ||
        message.includes('window.close') ||
        message.includes('window.closed') ||
        message.includes('popup.ts')) {
        // COOP ê´€ë ¨ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
        return;
    }
    // ë‹¤ë¥¸ ì˜¤ë¥˜ëŠ” ì •ìƒì ìœ¼ë¡œ ì¶œë ¥
    originalConsoleError.apply(console, args);
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
        new BillionaireMap();
    });
} else {
    // DOMì´ ì´ë¯¸ ë¡œë“œëœ ê²½ìš°
    new BillionaireMap();
}


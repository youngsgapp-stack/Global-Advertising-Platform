// Mr.Young's Billionaire Homepage - Interactive World Map
class BillionaireMap {
    constructor() {
        this.map = null;
        this.currentRegion = null;
        this.regionData = new Map();
        this.uniformAdPrice = 1000;
        this.regionPopularity = new Map(); // ì§€ì—­ë³„ ì¸ê¸° ì§€í‘œ (ì…ì°° íšŸìˆ˜, ì¡°íšŒìˆ˜ ë“±)
        this.priceAdjustmentFactor = 1.0; // ê°€ê²© ì¡°ì ˆ ê³„ìˆ˜
        this.advertisingData = new Map();
        this.logoData = {}; // ê°„ë‹¨í•œ ê°ì²´ë¡œ ë³€ê²½
        this.colorData = {}; // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        this.companyData = {}; // ê¸°ì—… ì •ë³´ ë°ì´í„° ì €ì¥
        this.koreaLogoData = {}; // í•œêµ­ ë¡œê³  ë°ì´í„°
        this.koreaColorData = {}; // í•œêµ­ ìƒ‰ìƒ ë°ì´í„°
        this.koreaCompanyData = {}; // í•œêµ­ ê¸°ì—… ì •ë³´ ë°ì´í„°
        this.japanLogoData = {}; // ì¼ë³¸ ë¡œê³  ë°ì´í„°
        this.japanColorData = {}; // ì¼ë³¸ ìƒ‰ìƒ ë°ì´í„°
        this.japanCompanyData = {}; // ì¼ë³¸ ê¸°ì—… ì •ë³´ ë°ì´í„°
        this.currentMapMode = 'global'; // ì „ ì„¸ê³„ í–‰ì •êµ¬ì—­ í†µí•© ëª¨ë“œ
        this.adminMode = false;
        // Firebase ê´€ë ¨ ë³€ìˆ˜
        this.firebaseApp = null;
        this.firebaseAuth = null;
        this.firestore = null;
        this.firebaseFunctions = null;
        this.callableTopAuctions = null;
        this.currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì
        this.isFirebaseInitialized = false;
        // ì„±ëŠ¥ ìµœì í™”: ë°ì´í„° ìºì‹±
        this.cachedGeoJsonData = {
            'usa': null,
            'korea': null,
            'japan': null,
            'china': null,
            'russia': null,
            'india': null,
            'canada': null,
            'germany': null,
            'uk': null,
            'france': null,
            'italy': null,
            'brazil': null,
            'australia': null,
            'mexico': null,
            'indonesia': null,
            'saudi-arabia': null,
            'turkey': null,
            'south-africa': null,
            'argentina': null,
            'european-union': null,
            'spain': null,
            'netherlands': null,
            'poland': null,
            'belgium': null,
            'sweden': null,
            'austria': null,
            'denmark': null,
            'finland': null,
            'ireland': null,
            'portugal': null,
            'greece': null,
            'czech-republic': null,
            'romania': null,
            'hungary': null,
            'bulgaria': null
        };
        this.rawGeoJsonCache = {};
        this.assetBaseUrl = this.resolveAssetBaseUrl();
        console.log('[BillionaireMap] assetBaseUrl ì´ˆê¸°í™”:', this.assetBaseUrl);
        this.eventListenersAdded = false; // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¤‘ë³µ ì¶”ê°€ ë°©ì§€
        this.currentHoverRegionId = null; // í˜„ì¬ hoverëœ ì§€ì—­ ID ì¶”ì 
        this.isAdminLoggedIn = false; // ê´€ë¦¬ì ë¡œê·¸ì¸ ìƒíƒœ
        this.selectedStateId = null; // í˜„ì¬ ì„ íƒëœ ì£¼ ID
        this.uiVisible = false; // UI ìš”ì†Œ í‘œì‹œ ìƒíƒœ
        this.pKeyCount = 0; // Pí‚¤ ì—°íƒ€ ì¹´ìš´íŠ¸
        this.pKeyTimer = null; // Pí‚¤ íƒ€ì´ë¨¸
        this.isGlobeMode = false; // 3D ì§€êµ¬ë³¸ ëª¨ë“œ ìƒíƒœ (initializeMapì—ì„œ ì´ˆê¸°í™”)
        this.globeRotationInterval = null; // ì§€êµ¬ë³¸ ìë™ íšŒì „ ì¸í„°ë²Œ
        this.cloudRotation = 0; // êµ¬ë¦„ íšŒì „ ê°ë„
        this.cloudImage = null; // êµ¬ë¦„ ì´ë¯¸ì§€
        this.cloudAnimationId = null; // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ID
        this.dynamicColorSetup = false; // ë™ì  ìƒ‰ìƒ ì¡°ì • ì„¤ì • ì—¬ë¶€
        this.southAfricaProvinceMapping = null; // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ì£¼-ì§€êµ¬ ë§¤í•‘
        this.argentinaProvinceMapping = null; // ì•„ë¥´í—¨í‹°ë‚˜ ì£¼ ë§¤í•‘
        this.spainAutonomousCommunityMapping = null; // ìŠ¤í˜ì¸ ìì¹˜ì§€ì—­-ì£¼ ë§¤í•‘
        this.globalViewMode = true; // êµ­ê°€ ì„ íƒ ì—†ì´ ì „ì²´ í–‰ì •êµ¬ì—­ í‘œì‹œ
        this.globalRegionsGeoJson = { type: 'FeatureCollection', features: [] }; // í†µí•© GeoJSON
        this.globalRegionIdSet = new Set(); // ì „ ì„¸ê³„ í–‰ì •êµ¬ì—­ ID ì¤‘ë³µ ë°©ì§€
        this.auctionData = new Map(); // ì§€ì—­ë³„ ì˜¥ì…˜ ì •ë³´ ìºì‹œ
        this.auctionUnsubscribe = null; // ì‹¤ì‹œê°„ êµ¬ë… í•´ì œ í•¸ë“¤ëŸ¬
        this.auctionConfig = {
            minIncrementPercent: 0.05, // ìµœì†Œ 5% ì¸ìƒ
            protectionHours: 12, // ë³´í˜¸ ì‹œê°„(ì‹œê°„)
            roundingUnit: 100 // ì…ì°° ê¸ˆì•¡ ë°˜ì˜¬ë¦¼ ë‹¨ìœ„
        };
        this.pixelBundleCache = new Map(); // ì§€ì—­ë³„ í”½ì…€ ìŠ¤í† ë¦¬
        this.pixelBundleUnsubscribe = null;
        this.activePixelSubscriptionRegion = null;
        this.pixelLayerVisible = false;
        this.pixelExperienceInitialized = false;
        this.pixelProtectionHours = 12;
        this.pixelDetailMode = false; // í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œ
        this.pixelDetailRegionId = null; // í”½ì…€ ìƒì„¸ ë³´ê¸° ì¤‘ì¸ ì§€ì—­ ID
        this.pixelEditorState = {
            mode: 'canvas',
            canvasSize: 16,
            brushColor: '#ff6b6b',
            brushSize: 1,
            pixelMatrix: [],
            imageDataUrl: '',
            messageText: '',
            messageLink: '',
            isDrawing: false
        };
        this.pixelPreviewCanvas = null;
        this.pixelPreviewCtx = null;
        this.pixelEditorCanvas = null;
        this.pixelEditorCtx = null;
        this.isSavingPixelBundle = false;
        this.leaderboardFilterState = { season: 'all', country: 'all' };
        this.leaderboardCache = new Map();
        this.leaderboardRemoteThreshold = 200;
        this.leaderboardPendingRequest = null;
        this.lastRenderedLeaderboardSource = 'local';
        this.leaderboardDefaultLimit = 5;
        this.realtimeLeaderboard = null;
        this.leaderboardRealtimeUnsubscribe = null;
        this.realtimeLeaderboardEnabled = true;
        this.latestServerLeaderboardTimestamp = null;
        this.adminValidationConfig = [];
        this.adminValidationInitialized = false;
        this.auctionAnimationFrame = null; // ê²½í•© ìƒíƒœ ì• ë‹ˆë©”ì´ì…˜ í”„ë ˆì„
        this.auctionAnimationTime = 0; // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ ì¶”ì 
        
        // ì‹œì¦Œ ì‹œìŠ¤í…œ ê´€ë ¨ ë³€ìˆ˜
        this.currentSeason = {
            id: '2025-S1',
            name: 'ì‹œì¦Œ 1',
            startDate: new Date('2025-01-01'),
            endDate: new Date('2025-12-31'),
            totalPixels: 10000,
            soldPixels: 0,
            participants: 0
        };
        this.seasonData = new Map(); // ì‹œì¦Œë³„ ë°ì´í„° ìºì‹œ
        this.communityMissions = []; // ì»¤ë®¤ë‹ˆí‹° ë¯¸ì…˜ ëª©ë¡
        this.userPoints = 0; // ì‚¬ìš©ì í¬ì¸íŠ¸
        this.userBadges = []; // ì‚¬ìš©ì ë±ƒì§€ ëª©ë¡
        this.achievements = []; // ì—…ì  ëª©ë¡
        this.seasonTimeline = []; // ì‹œì¦Œ íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ëª©ë¡
        this.regionConquestHistory = new Map(); // êµ¬ì—­ë³„ ì ë ¹ íˆìŠ¤í† ë¦¬
        this.transparencyData = {
            totalRevenue: 0,
            totalExpenses: 0,
            serverCost: 0,
            surplus: 0,
            lastUpdated: new Date()
        };
        this.landingOverlayVisible = true; // ëœë”© ì˜¤ë²„ë ˆì´ í‘œì‹œ ì—¬ë¶€
        this.currentFlashChallenge = null; // í˜„ì¬ í”Œë˜ì‹œ ì±Œë¦°ì§€
        
        // G20 êµ­ê°€ ì„¤ì •
        this.g20Countries = {
            'usa': { name: 'United States', center: [-95, 35], zoom: 4, flag: 'ğŸ‡ºğŸ‡¸' },
            'china': { name: 'China', center: [104, 35], zoom: 4, flag: 'ğŸ‡¨ğŸ‡³' },
            'japan': { name: 'Japan', center: [139, 36], zoom: 6, flag: 'ğŸ‡¯ğŸ‡µ' },
            'germany': { name: 'Germany', center: [10, 51], zoom: 6, flag: 'ğŸ‡©ğŸ‡ª' },
            'india': { name: 'India', center: [77, 20], zoom: 4, flag: 'ğŸ‡®ğŸ‡³' },
            'uk': { name: 'United Kingdom', center: [-3, 54], zoom: 6, flag: 'ğŸ‡¬ğŸ‡§' },
            'france': { name: 'France', center: [2, 46], zoom: 6, flag: 'ğŸ‡«ğŸ‡·' },
            'italy': { name: 'Italy', center: [12, 42], zoom: 6, flag: 'ğŸ‡®ğŸ‡¹' },
            'brazil': { name: 'Brazil', center: [-55, -15], zoom: 4, flag: 'ğŸ‡§ğŸ‡·' },
            'canada': { name: 'Canada', center: [-106, 56], zoom: 4, flag: 'ğŸ‡¨ğŸ‡¦' },
            'russia': { name: 'Russia', center: [100, 60], zoom: 3, flag: 'ğŸ‡·ğŸ‡º' },
            'australia': { name: 'Australia', center: [133, -27], zoom: 4, flag: 'ğŸ‡¦ğŸ‡º' },
            'mexico': { name: 'Mexico', center: [-102, 23], zoom: 5, flag: 'ğŸ‡²ğŸ‡½' },
            'south-korea': { name: 'South Korea', center: [127, 36], zoom: 6, flag: 'ğŸ‡°ğŸ‡·' },
            'indonesia': { name: 'Indonesia', center: [113, -5], zoom: 5, flag: 'ğŸ‡®ğŸ‡©' },
            'saudi-arabia': { name: 'Saudi Arabia', center: [45, 24], zoom: 5, flag: 'ğŸ‡¸ğŸ‡¦' },
            'turkey': { name: 'Turkey', center: [35, 39], zoom: 5, flag: 'ğŸ‡¹ğŸ‡·' },
            'south-africa': { name: 'South Africa', center: [22, -30], zoom: 5, flag: 'ğŸ‡¿ğŸ‡¦' },
            'argentina': { name: 'Argentina', center: [-63, -38], zoom: 4, flag: 'ğŸ‡¦ğŸ‡·' },
            'european-union': { name: 'European Union', center: [10, 50], zoom: 4, flag: 'ğŸ‡ªğŸ‡º' },
            'spain': { name: 'Spain', center: [-3, 40], zoom: 5, flag: 'ğŸ‡ªğŸ‡¸' },
            'netherlands': { name: 'Netherlands', center: [5, 52], zoom: 6, flag: 'ğŸ‡³ğŸ‡±' },
            'poland': { name: 'Poland', center: [19, 52], zoom: 5, flag: 'ğŸ‡µğŸ‡±' },
            'belgium': { name: 'Belgium', center: [4.5, 50.5], zoom: 6, flag: 'ğŸ‡§ğŸ‡ª' },
            'sweden': { name: 'Sweden', center: [18, 60], zoom: 5, flag: 'ğŸ‡¸ğŸ‡ª' },
            'austria': { name: 'Austria', center: [13, 47.5], zoom: 6, flag: 'ğŸ‡¦ğŸ‡¹' },
            'denmark': { name: 'Denmark', center: [10, 56], zoom: 6, flag: 'ğŸ‡©ğŸ‡°' },
            'finland': { name: 'Finland', center: [26, 64], zoom: 5, flag: 'ğŸ‡«ğŸ‡®' },
            'ireland': { name: 'Ireland', center: [-8, 53], zoom: 6, flag: 'ğŸ‡®ğŸ‡ª' },
            'portugal': { name: 'Portugal', center: [-8, 39.5], zoom: 6, flag: 'ğŸ‡µğŸ‡¹' },
            'greece': { name: 'Greece', center: [23, 38], zoom: 6, flag: 'ğŸ‡¬ğŸ‡·' },
            'czech-republic': { name: 'Czech Republic', center: [15, 49.75], zoom: 6, flag: 'ğŸ‡¨ğŸ‡¿' },
            'romania': { name: 'Romania', center: [25, 46], zoom: 6, flag: 'ğŸ‡·ğŸ‡´' },
            'hungary': { name: 'Hungary', center: [19.5, 47.5], zoom: 6, flag: 'ğŸ‡­ğŸ‡º' },
            'bulgaria': { name: 'Bulgaria', center: [25, 43], zoom: 6, flag: 'ğŸ‡§ğŸ‡¬' }
        };
        
        // G20 êµ­ê°€ë³„ ì–¸ì–´ ë§¤í•‘ (ì£¼ìš” ì–¸ì–´ + ì˜ì–´)
        this.countryLanguages = {
            'usa': { 
                primary: { 
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'china': {
                primary: {
                    'Region Information': 'åœ°åŒºä¿¡æ¯',
                    'Population': 'äººå£',
                    'Area': 'é¢ç§¯',
                    'Administrative Level': 'è¡Œæ”¿åŒºåˆ’',
                    'Advertising Price': 'å¹¿å‘Šä»·æ ¼',
                    'Status': 'çŠ¶æ€',
                    'Available': 'å¯ç”¨',
                    'Occupied': 'å·²å ç”¨',
                    'This region is available for advertisement registration.': 'æ­¤åœ°åŒºç›®å‰å¯ä»¥æ³¨å†Œå¹¿å‘Šã€‚',
                    'This region is currently occupied by an advertisement.': 'æ­¤åœ°åŒºç›®å‰å·²è¢«å¹¿å‘Šå ç”¨ã€‚',
                    'Purchase This Region': 'è´­ä¹°æ­¤åœ°åŒº',
                    'Company Information': 'ä¼ä¸šä¿¡æ¯',
                    'Industry': 'è¡Œä¸š',
                    'Founded': 'æˆç«‹å¹´ä»½',
                    'Employees': 'å‘˜å·¥æ•°',
                    'Website': 'ç½‘ç«™',
                    'Company Description': 'ä¼ä¸šä»‹ç»',
                    'Key Features': 'ä¸»è¦ç‰¹ç‚¹',
                    'Region': 'åœ°åŒº'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'japan': {
                primary: {
                    'Region Information': 'åœ°åŸŸæƒ…å ±',
                    'Population': 'äººå£',
                    'Area': 'é¢ç©',
                    'Administrative Level': 'è¡Œæ”¿åŒºç”»',
                    'Advertising Price': 'åºƒå‘Šä¾¡æ ¼',
                    'Status': 'ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹',
                    'Available': 'åˆ©ç”¨å¯èƒ½',
                    'Occupied': 'å æœ‰ä¸­',
                    'This region is available for advertisement registration.': 'ã“ã®åœ°åŸŸã¯ç¾åœ¨åºƒå‘Šç™»éŒ²ãŒå¯èƒ½ã§ã™ã€‚',
                    'This region is currently occupied by an advertisement.': 'ã“ã®åœ°åŸŸã¯ç¾åœ¨åºƒå‘Šã«å æœ‰ã•ã‚Œã¦ã„ã¾ã™ã€‚',
                    'Purchase This Region': 'ã“ã®åœ°åŸŸã‚’è³¼å…¥',
                    'Company Information': 'ä¼æ¥­æƒ…å ±',
                    'Industry': 'æ¥­ç•Œ',
                    'Founded': 'è¨­ç«‹å¹´',
                    'Employees': 'å¾“æ¥­å“¡æ•°',
                    'Website': 'ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ',
                    'Company Description': 'ä¼æ¥­ç´¹ä»‹',
                    'Key Features': 'ä¸»ãªç‰¹å¾´',
                    'Region': 'åœ°åŸŸ'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'germany': {
                primary: {
                    'Region Information': 'Regionsinformationen',
                    'Population': 'BevÃ¶lkerung',
                    'Area': 'FlÃ¤che',
                    'Administrative Level': 'Verwaltungsebene',
                    'Advertising Price': 'Werbekosten',
                    'Status': 'Status',
                    'Available': 'VerfÃ¼gbar',
                    'Occupied': 'Besetzt',
                    'This region is available for advertisement registration.': 'Diese Region ist fÃ¼r Werbeanmeldungen verfÃ¼gbar.',
                    'This region is currently occupied by an advertisement.': 'Diese Region ist derzeit von einer Werbung belegt.',
                    'Purchase This Region': 'Diese Region kaufen',
                    'Company Information': 'Unternehmensinformationen',
                    'Industry': 'Branche',
                    'Founded': 'GegrÃ¼ndet',
                    'Employees': 'Mitarbeiter',
                    'Website': 'Website',
                    'Company Description': 'Unternehmensbeschreibung',
                    'Key Features': 'Hauptmerkmale',
                    'Region': 'Region'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'india': {
                primary: {
                    'Region Information': 'à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',
                    'Population': 'à¤œà¤¨à¤¸à¤‚à¤–à¥à¤¯à¤¾',
                    'Area': 'à¤•à¥à¤·à¥‡à¤¤à¥à¤°à¤«à¤²',
                    'Administrative Level': 'à¤ªà¥à¤°à¤¶à¤¾à¤¸à¤¨à¤¿à¤• à¤¸à¥à¤¤à¤°',
                    'Advertising Price': 'à¤µà¤¿à¤œà¥à¤à¤¾à¤ªà¤¨ à¤®à¥‚à¤²à¥à¤¯',
                    'Status': 'à¤¸à¥à¤¥à¤¿à¤¤à¤¿',
                    'Available': 'à¤‰à¤ªà¤²à¤¬à¥à¤§',
                    'Occupied': 'à¤…à¤§à¤¿à¤•à¥ƒà¤¤',
                    'This region is available for advertisement registration.': 'à¤¯à¤¹ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤µà¤¿à¤œà¥à¤à¤¾à¤ªà¤¨ à¤ªà¤‚à¤œà¥€à¤•à¤°à¤£ à¤•à¥‡ à¤²à¤¿à¤ à¤‰à¤ªà¤²à¤¬à¥à¤§ à¤¹à¥ˆà¥¤',
                    'This region is currently occupied by an advertisement.': 'à¤¯à¤¹ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤à¤• à¤µà¤¿à¤œà¥à¤à¤¾à¤ªà¤¨ à¤¦à¥à¤µà¤¾à¤°à¤¾ à¤…à¤§à¤¿à¤•à¥ƒà¤¤ à¤¹à¥ˆà¥¤',
                    'Purchase This Region': 'à¤‡à¤¸ à¤•à¥à¤·à¥‡à¤¤à¥à¤° à¤•à¥‹ à¤–à¤°à¥€à¤¦à¥‡à¤‚',
                    'Company Information': 'à¤•à¤‚à¤ªà¤¨à¥€ à¤œà¤¾à¤¨à¤•à¤¾à¤°à¥€',
                    'Industry': 'à¤‰à¤¦à¥à¤¯à¥‹à¤—',
                    'Founded': 'à¤¸à¥à¤¥à¤¾à¤ªà¤¨à¤¾ à¤µà¤°à¥à¤·',
                    'Employees': 'à¤•à¤°à¥à¤®à¤šà¤¾à¤°à¥€',
                    'Website': 'à¤µà¥‡à¤¬à¤¸à¤¾à¤‡à¤Ÿ',
                    'Company Description': 'à¤•à¤‚à¤ªà¤¨à¥€ à¤µà¤¿à¤µà¤°à¤£',
                    'Key Features': 'à¤®à¥à¤–à¥à¤¯ à¤µà¤¿à¤¶à¥‡à¤·à¤¤à¤¾à¤à¤‚',
                    'Region': 'à¤•à¥à¤·à¥‡à¤¤à¥à¤°'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'uk': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'france': {
                primary: {
                    'Region Information': 'Informations sur la rÃ©gion',
                    'Population': 'Population',
                    'Area': 'Superficie',
                    'Administrative Level': 'Niveau administratif',
                    'Advertising Price': 'Prix de la publicitÃ©',
                    'Status': 'Statut',
                    'Available': 'Disponible',
                    'Occupied': 'OccupÃ©',
                    'This region is available for advertisement registration.': 'Cette rÃ©gion est actuellement disponible pour l\'enregistrement de publicitÃ©s.',
                    'This region is currently occupied by an advertisement.': 'Cette rÃ©gion est actuellement occupÃ©e par une publicitÃ©.',
                    'Purchase This Region': 'Acheter cette rÃ©gion',
                    'Company Information': 'Informations sur l\'entreprise',
                    'Industry': 'Industrie',
                    'Founded': 'FondÃ©e',
                    'Employees': 'EmployÃ©s',
                    'Website': 'Site web',
                    'Company Description': 'Description de l\'entreprise',
                    'Key Features': 'CaractÃ©ristiques principales',
                    'Region': 'RÃ©gion'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'italy': {
                primary: {
                    'Region Information': 'Informazioni sulla regione',
                    'Population': 'Popolazione',
                    'Area': 'Area',
                    'Administrative Level': 'Livello amministrativo',
                    'Advertising Price': 'Prezzo pubblicitario',
                    'Status': 'Stato',
                    'Available': 'Disponibile',
                    'Occupied': 'Occupato',
                    'This region is available for advertisement registration.': 'Questa regione Ã¨ attualmente disponibile per la registrazione pubblicitaria.',
                    'This region is currently occupied by an advertisement.': 'Questa regione Ã¨ attualmente occupata da una pubblicitÃ .',
                    'Purchase This Region': 'Acquista questa regione',
                    'Company Information': 'Informazioni sull\'azienda',
                    'Industry': 'Settore',
                    'Founded': 'Fondata',
                    'Employees': 'Dipendenti',
                    'Website': 'Sito web',
                    'Company Description': 'Descrizione dell\'azienda',
                    'Key Features': 'Caratteristiche principali',
                    'Region': 'Regione'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'brazil': {
                primary: {
                    'Region Information': 'InformaÃ§Ãµes da regiÃ£o',
                    'Population': 'PopulaÃ§Ã£o',
                    'Area': 'Ãrea',
                    'Administrative Level': 'NÃ­vel administrativo',
                    'Advertising Price': 'PreÃ§o de publicidade',
                    'Status': 'Status',
                    'Available': 'DisponÃ­vel',
                    'Occupied': 'Ocupado',
                    'This region is available for advertisement registration.': 'Esta regiÃ£o estÃ¡ atualmente disponÃ­vel para registro de publicidade.',
                    'This region is currently occupied by an advertisement.': 'Esta regiÃ£o estÃ¡ atualmente ocupada por uma publicidade.',
                    'Purchase This Region': 'Comprar esta regiÃ£o',
                    'Company Information': 'InformaÃ§Ãµes da empresa',
                    'Industry': 'IndÃºstria',
                    'Founded': 'Fundada',
                    'Employees': 'FuncionÃ¡rios',
                    'Website': 'Site',
                    'Company Description': 'DescriÃ§Ã£o da empresa',
                    'Key Features': 'CaracterÃ­sticas principais',
                    'Region': 'RegiÃ£o'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'canada': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'russia': {
                primary: {
                    'Region Information': 'Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½Ğµ',
                    'Population': 'ĞĞ°ÑĞµĞ»ĞµĞ½Ğ¸Ğµ',
                    'Area': 'ĞŸĞ»Ğ¾Ñ‰Ğ°Ğ´ÑŒ',
                    'Administrative Level': 'ĞĞ´Ğ¼Ğ¸Ğ½Ğ¸ÑÑ‚Ñ€Ğ°Ñ‚Ğ¸Ğ²Ğ½Ñ‹Ğ¹ ÑƒÑ€Ğ¾Ğ²ĞµĞ½ÑŒ',
                    'Advertising Price': 'Ğ¡Ñ‚Ğ¾Ğ¸Ğ¼Ğ¾ÑÑ‚ÑŒ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹',
                    'Status': 'Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ',
                    'Available': 'Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾',
                    'Occupied': 'Ğ—Ğ°Ğ½ÑÑ‚Ğ¾',
                    'This region is available for advertisement registration.': 'Ğ­Ñ‚Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ² Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿ĞµĞ½ Ğ´Ğ»Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ñ‹.',
                    'This region is currently occupied by an advertisement.': 'Ğ­Ñ‚Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½ Ğ² Ğ½Ğ°ÑÑ‚Ğ¾ÑÑ‰ĞµĞµ Ğ²Ñ€ĞµĞ¼Ñ Ğ·Ğ°Ğ½ÑÑ‚ Ñ€ĞµĞºĞ»Ğ°Ğ¼Ğ¾Ğ¹.',
                    'Purchase This Region': 'ĞšÑƒĞ¿Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ¾Ñ‚ Ñ€ĞµĞ³Ğ¸Ğ¾Ğ½',
                    'Company Information': 'Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸',
                    'Industry': 'ĞÑ‚Ñ€Ğ°ÑĞ»ÑŒ',
                    'Founded': 'ĞÑĞ½Ğ¾Ğ²Ğ°Ğ½Ğ°',
                    'Employees': 'Ğ¡Ğ¾Ñ‚Ñ€ÑƒĞ´Ğ½Ğ¸ĞºĞ¸',
                    'Website': 'Ğ’ĞµĞ±-ÑĞ°Ğ¹Ñ‚',
                    'Company Description': 'ĞĞ¿Ğ¸ÑĞ°Ğ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ¿Ğ°Ğ½Ğ¸Ğ¸',
                    'Key Features': 'ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ Ğ¾ÑĞ¾Ğ±ĞµĞ½Ğ½Ğ¾ÑÑ‚Ğ¸',
                    'Region': 'Ğ ĞµĞ³Ğ¸Ğ¾Ğ½'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'australia': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'mexico': {
                primary: {
                    'Region Information': 'InformaciÃ³n de la regiÃ³n',
                    'Population': 'PoblaciÃ³n',
                    'Area': 'Ãrea',
                    'Administrative Level': 'Nivel administrativo',
                    'Advertising Price': 'Precio de publicidad',
                    'Status': 'Estado',
                    'Available': 'Disponible',
                    'Occupied': 'Ocupado',
                    'This region is available for advertisement registration.': 'Esta regiÃ³n estÃ¡ disponible para el registro de publicidad.',
                    'This region is currently occupied by an advertisement.': 'Esta regiÃ³n estÃ¡ ocupada por una publicidad.',
                    'Purchase This Region': 'Comprar esta regiÃ³n',
                    'Company Information': 'InformaciÃ³n de la empresa',
                    'Industry': 'Industria',
                    'Founded': 'Fundada',
                    'Employees': 'Empleados',
                    'Website': 'Sitio web',
                    'Company Description': 'DescripciÃ³n de la empresa',
                    'Key Features': 'CaracterÃ­sticas principales',
                    'Region': 'RegiÃ³n'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'south-korea': {
                primary: {
                    'Region Information': 'ì§€ì—­ ì •ë³´',
                    'Population': 'ì¸êµ¬',
                    'Area': 'ë©´ì ',
                    'Administrative Level': 'í–‰ì •êµ¬ì—­',
                    'Advertising Price': 'ê´‘ê³  ê°€ê²©',
                    'Status': 'ìƒíƒœ',
                    'Available': 'ì‚¬ìš© ê°€ëŠ¥',
                    'Occupied': 'ê´‘ê³  ì¤‘',
                    'This region is available for advertisement registration.': 'ì´ ì§€ì—­ì€ í˜„ì¬ ê´‘ê³ ë¥¼ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.',
                    'This region is currently occupied by an advertisement.': 'ì´ ì§€ì—­ì€ í˜„ì¬ ê´‘ê³ ê°€ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.',
                    'Purchase This Region': 'ì´ ì§€ì—­ êµ¬ë§¤í•˜ê¸°',
                    'Company Information': 'ê¸°ì—… ì •ë³´',
                    'Industry': 'ì‚°ì—… ë¶„ì•¼',
                    'Founded': 'ì„¤ë¦½ë…„ë„',
                    'Employees': 'ì§ì› ìˆ˜',
                    'Website': 'ì›¹ì‚¬ì´íŠ¸',
                    'Company Description': 'ê¸°ì—… ì†Œê°œ',
                    'Key Features': 'ì£¼ìš” íŠ¹ì§•',
                    'Region': 'ì§€ì—­ëª…'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'indonesia': {
                primary: {
                    'Region Information': 'Informasi Wilayah',
                    'Population': 'Populasi',
                    'Area': 'Luas',
                    'Administrative Level': 'Tingkat Administratif',
                    'Advertising Price': 'Harga Iklan',
                    'Status': 'Status',
                    'Available': 'Tersedia',
                    'Occupied': 'Terisi',
                    'This region is available for advertisement registration.': 'Wilayah ini saat ini tersedia untuk pendaftaran iklan.',
                    'This region is currently occupied by an advertisement.': 'Wilayah ini saat ini ditempati oleh iklan.',
                    'Purchase This Region': 'Beli Wilayah Ini',
                    'Company Information': 'Informasi Perusahaan',
                    'Industry': 'Industri',
                    'Founded': 'Didirikan',
                    'Employees': 'Karyawan',
                    'Website': 'Situs Web',
                    'Company Description': 'Deskripsi Perusahaan',
                    'Key Features': 'Fitur Utama',
                    'Region': 'Wilayah'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'saudi-arabia': {
                primary: {
                    'Region Information': 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                    'Population': 'Ø§Ù„Ø³ÙƒØ§Ù†',
                    'Area': 'Ø§Ù„Ù…Ø³Ø§Ø­Ø©',
                    'Administrative Level': 'Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ',
                    'Advertising Price': 'Ø³Ø¹Ø± Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†',
                    'Status': 'Ø§Ù„Ø­Ø§Ù„Ø©',
                    'Available': 'Ù…ØªØ§Ø­',
                    'Occupied': 'Ù…Ø­ØªÙ„',
                    'This region is available for advertisement registration.': 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù†Ø§Øª.',
                    'This region is currently occupied by an advertisement.': 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø© Ù…Ø­ØªÙ„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹ Ø¨Ø¥Ø¹Ù„Ø§Ù†.',
                    'Purchase This Region': 'Ø´Ø±Ø§Ø¡ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ù†Ø·Ù‚Ø©',
                    'Company Information': 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø±ÙƒØ©',
                    'Industry': 'Ø§Ù„ØµÙ†Ø§Ø¹Ø©',
                    'Founded': 'ØªØ£Ø³Ø³Øª',
                    'Employees': 'Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†',
                    'Website': 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ',
                    'Company Description': 'ÙˆØµÙ Ø§Ù„Ø´Ø±ÙƒØ©',
                    'Key Features': 'Ø§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
                    'Region': 'Ø§Ù„Ù…Ù†Ø·Ù‚Ø©'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'turkey': {
                primary: {
                    'Region Information': 'BÃ¶lge Bilgisi',
                    'Population': 'NÃ¼fus',
                    'Area': 'Alan',
                    'Administrative Level': 'Ä°dari Seviye',
                    'Advertising Price': 'Reklam FiyatÄ±',
                    'Status': 'Durum',
                    'Available': 'MÃ¼sait',
                    'Occupied': 'Dolu',
                    'This region is available for advertisement registration.': 'Bu bÃ¶lge ÅŸu anda reklam kaydÄ± iÃ§in mÃ¼sait.',
                    'This region is currently occupied by an advertisement.': 'Bu bÃ¶lge ÅŸu anda bir reklam tarafÄ±ndan iÅŸgal edilmiÅŸ.',
                    'Purchase This Region': 'Bu BÃ¶lgeyi SatÄ±n Al',
                    'Company Information': 'Åirket Bilgileri',
                    'Industry': 'EndÃ¼stri',
                    'Founded': 'KuruluÅŸ',
                    'Employees': 'Ã‡alÄ±ÅŸanlar',
                    'Website': 'Web Sitesi',
                    'Company Description': 'Åirket AÃ§Ä±klamasÄ±',
                    'Key Features': 'Ana Ã–zellikler',
                    'Region': 'BÃ¶lge'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            },
            'south-africa': {
                primary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                },
                secondary: {}
            },
            'argentina': {
                primary: {
                    'Region Information': 'InformaciÃ³n de la regiÃ³n',
                    'Population': 'PoblaciÃ³n',
                    'Area': 'Ãrea',
                    'Administrative Level': 'Nivel administrativo',
                    'Advertising Price': 'Precio de publicidad',
                    'Status': 'Estado',
                    'Available': 'Disponible',
                    'Occupied': 'Ocupado',
                    'This region is available for advertisement registration.': 'Esta regiÃ³n estÃ¡ disponible para el registro de publicidad.',
                    'This region is currently occupied by an advertisement.': 'Esta regiÃ³n estÃ¡ ocupada por una publicidad.',
                    'Purchase This Region': 'Comprar esta regiÃ³n',
                    'Company Information': 'InformaciÃ³n de la empresa',
                    'Industry': 'Industria',
                    'Founded': 'Fundada',
                    'Employees': 'Empleados',
                    'Website': 'Sitio web',
                    'Company Description': 'DescripciÃ³n de la empresa',
                    'Key Features': 'CaracterÃ­sticas principales',
                    'Region': 'RegiÃ³n'
                },
                secondary: {
                    'Region Information': 'Region Information',
                    'Population': 'Population',
                    'Area': 'Area',
                    'Administrative Level': 'Administrative Level',
                    'Advertising Price': 'Advertising Price',
                    'Status': 'Status',
                    'Available': 'Available',
                    'Occupied': 'Occupied',
                    'This region is available for advertisement registration.': 'This region is available for advertisement registration.',
                    'This region is currently occupied by an advertisement.': 'This region is currently occupied by an advertisement.',
                    'Purchase This Region': 'Purchase This Region',
                    'Company Information': 'Company Information',
                    'Industry': 'Industry',
                    'Founded': 'Founded',
                    'Employees': 'Employees',
                    'Website': 'Website',
                    'Company Description': 'Company Description',
                    'Key Features': 'Key Features',
                    'Region': 'Region'
                }
            }
        };
        this.zoomLevels = {
            world: 2,
            country: 4,
            region: 6
        };
        
        this.init();
    }

    resolveAssetBaseUrl() {
        const ensureDir = (inputUrl) => {
            try {
                const url = new URL(inputUrl, window.location.href);
                return new URL('.', url).href;
            } catch (error) {
                console.warn('[BillionaireMap] base URL ê³„ì‚° ì‹¤íŒ¨:', inputUrl, error);
                return null;
            }
        };
        
        const candidates = [];
        
        if (window.__ASSET_BASE_URL__) {
            candidates.push(window.__ASSET_BASE_URL__);
        }
        
        if (typeof document !== 'undefined') {
            const baseTag = document.querySelector('base[href]');
            if (baseTag) {
                candidates.push(baseTag.href);
            }
            if (document.currentScript && document.currentScript.src) {
                candidates.push(new URL('.', document.currentScript.src).href);
            }
            if (document.baseURI) {
                candidates.push(document.baseURI);
            }
        }
        
        candidates.push(window.location.href);
        
        for (const candidate of candidates) {
            const dir = ensureDir(candidate);
            if (dir) {
                return dir;
            }
        }
        
        return `${window.location.origin}/`;
    }

    getAssetUrl(relativePath) {
        if (!relativePath) return relativePath;
        if (/^https?:\/\//i.test(relativePath)) return relativePath;
        
        // ìƒëŒ€ ê²½ë¡œ ì •ê·œí™” (./ ì œê±°, ì•ì˜ / ì œê±°)
        let sanitizedPath = relativePath.startsWith('./') ? relativePath.slice(2) : relativePath;
        sanitizedPath = sanitizedPath.replace(/^\/+/, '');
        
        try {
            // assetBaseUrlì€ ì´ë¯¸ ë””ë ‰í„°ë¦¬ ê²½ë¡œë¡œ ëë‚˜ë„ë¡ ë³´ì¥ë¨
            const baseUrl = this.assetBaseUrl.endsWith('/') ? this.assetBaseUrl : this.assetBaseUrl + '/';
            const fullUrl = new URL(sanitizedPath, baseUrl).toString();
            console.log(`[getAssetUrl] ${relativePath} -> ${fullUrl} (base: ${baseUrl})`);
            return fullUrl;
        } catch (error) {
            console.warn('ì—ì…‹ ê²½ë¡œë¥¼ í•´ê²°í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', sanitizedPath, error);
            // í´ë°±: ìƒëŒ€ ê²½ë¡œë¥¼ ê·¸ëŒ€ë¡œ ë°˜í™˜ (ë¸Œë¼ìš°ì €ê°€ í˜„ì¬ í˜ì´ì§€ ê¸°ì¤€ìœ¼ë¡œ í•´ì„)
            return sanitizedPath;
        }
    }
    
    initializeLeaderboardFilters() {
        if (!this.leaderboardFilterState) {
            this.leaderboardFilterState = { season: 'all', country: 'all' };
        }
        this.refreshLeaderboardFilterTabs([]);
    }
    
    buildLeaderboardDataset(auctionsArray) {
        return auctionsArray
            .map(([regionId, auction]) => {
                const region = this.regionData.get(regionId);
                const displayName = auction.regionName
                    || (region ? this.getRegionDisplayName(region) : regionId);
                const bidder = auction.currentBidder
                    ? (auction.currentBidder.displayName || auction.currentBidder.email || 'ìµëª…')
                    : '-';
                const seasonValueRaw = auction?.season
                    || auction?.seasonId
                    || region?.seasonTag
                    || region?.season
                    || 'default';
                const seasonValue = seasonValueRaw.toString();
                const seasonLabel = seasonValue === 'default' ? 'í˜„ì¬ ì‹œì¦Œ' : seasonValue;
                const countryValueRaw = auction?.country || region?.country || 'Global';
                const countryValue = countryValueRaw.toString().trim() || 'Global';
                return {
                    regionId,
                    regionName: displayName,
                    bidder,
                    amount: auction.currentBid || 0,
                    seasonValue,
                    seasonLabel,
                    countryValue,
                    countryLabel: countryValue
                };
            })
            .filter(item => item.amount > 0)
            .sort((a, b) => b.amount - a.amount);
    }
    
    applyLeaderboardFilters(dataset, filters) {
        if (!filters) return dataset;
        return dataset.filter(entry => {
            const seasonMatch = filters.season === 'all' || entry.seasonValue === filters.season;
            const countryMatch = filters.country === 'all' || entry.countryValue === filters.country;
            return seasonMatch && countryMatch;
        });
    }
    
    refreshLeaderboardFilterTabs(dataset) {
        const seasons = new Map();
        const countries = new Map();
        dataset.forEach(item => {
            if (!seasons.has(item.seasonValue)) {
                seasons.set(item.seasonValue, item.seasonLabel);
            }
            if (!countries.has(item.countryValue)) {
                countries.set(item.countryValue, item.countryLabel);
            }
        });
        this.renderFilterTabs('season', seasons, 'ì „ì²´ ì‹œì¦Œ');
        this.renderFilterTabs('country', countries, 'ì „ì²´ êµ­ê°€');
    }
    
    renderFilterTabs(type, entriesMap, defaultLabel) {
        const containerId = type === 'season' ? 'leaderboard-season-tabs' : 'leaderboard-country-tabs';
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const normalizedEntries = entriesMap instanceof Map ? entriesMap : new Map();
        
        const entries = Array.from(normalizedEntries.entries())
            .filter(([value]) => value && value !== 'default')
            .map(([value, label]) => ({ value, label }));
        const hasDefault = normalizedEntries.has('default');
        const defaultOptionLabel = hasDefault ? normalizedEntries.get('default') : defaultLabel;
        const activeValue = this.leaderboardFilterState?.[type] || 'all';
        
        if (activeValue !== 'all' && !entries.some(entry => entry.value === activeValue)) {
            this.leaderboardFilterState[type] = 'all';
        }
        
        container.innerHTML = '';
        container.appendChild(this.createFilterButton(type, 'all', defaultLabel));
        
        if (hasDefault) {
            container.appendChild(this.createFilterButton(type, 'default', defaultOptionLabel));
        }
        
        entries
            .sort((a, b) => a.label.localeCompare(b.label, 'ko-KR', { numeric: true }))
            .forEach(entry => {
                container.appendChild(this.createFilterButton(type, entry.value, entry.label));
            });
    }
    
    createFilterButton(type, value, label) {
        if (!this.leaderboardFilterState) {
            this.leaderboardFilterState = { season: 'all', country: 'all' };
        }
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'leaderboard-tab';
        btn.dataset.filterType = type;
        btn.dataset.filterValue = value;
        btn.textContent = label;
        
        if (this.leaderboardFilterState && this.leaderboardFilterState[type] === value) {
            btn.classList.add('active');
        }
        
        btn.addEventListener('click', () => {
            if (!this.leaderboardFilterState) {
                this.leaderboardFilterState = { season: 'all', country: 'all' };
            }
            if (this.leaderboardFilterState[type] === value) return;
            this.leaderboardFilterState[type] = value;
            this.updateAuctionWidgets();
        });
        
        return btn;
    }
    
    renderLeaderboardList(data, source = 'local') {
        const leaderboardEl = document.getElementById('auction-leaderboard-list');
        if (!leaderboardEl) return;
        this.lastRenderedLeaderboardSource = source;
        leaderboardEl.innerHTML = '';
        
        if (!data || data.length === 0) {
            leaderboardEl.innerHTML = '<li class="empty">ì•„ì§ ì…ì°°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            this.updateLeaderboardTimestamp(source);
            return;
        }
        
        data.forEach((entry, index) => {
            const li = document.createElement('li');
            li.className = 'leaderboard-item';
            li.innerHTML = `
                <span class="leaderboard-rank">${index + 1}</span>
                <div class="leaderboard-entry">
                    <strong>${entry.regionName}</strong>
                    <span>${entry.bidder || '-'}</span>
                </div>
                <span class="leaderboard-amount">${this.formatCurrency(entry.amount)}</span>
            `;
            leaderboardEl.appendChild(li);
        });
        this.updateLeaderboardTimestamp(source);
    }
    
    updateLeaderboardTimestamp(source = 'local') {
        const updatedLabel = document.getElementById('auction-leaderboard-updated');
        if (!updatedLabel) return;
        const timestamp = source === 'server' && this.latestServerLeaderboardTimestamp
            ? this.latestServerLeaderboardTimestamp
            : Date.now();
        const now = new Date(timestamp);
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const suffix = source === 'server' ? ' Â· ì„œë²„ì§‘ê³„' : '';
        updatedLabel.textContent = `${hours}:${minutes}${suffix}`;
    }
    
    shouldUseServerSideLeaderboard(totalEntries) {
        return !!this.callableTopAuctions && totalEntries > this.leaderboardRemoteThreshold;
    }

    canUseRealtimeLeaderboard(filters) {
        if (!this.realtimeLeaderboardEnabled) return false;
        const seasonFilter = (filters?.season || 'all');
        const countryFilter = (filters?.country || 'all');
        return seasonFilter === 'all' && countryFilter === 'all';
    }
    
    async fetchLeaderboardFromCloud(filters) {
        if (!this.callableTopAuctions) return;
        const effectiveFilters = {
            season: filters?.season || 'all',
            country: filters?.country || 'all'
        };
        if (this.canUseRealtimeLeaderboard(effectiveFilters)) {
            return;
        }
        const cacheKey = JSON.stringify(effectiveFilters);
        const cached = this.leaderboardCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < 15000) {
            this.renderLeaderboardList(cached.data, 'server');
            return;
        }
        if (this.leaderboardPendingRequest === cacheKey) {
            return;
        }
        this.leaderboardPendingRequest = cacheKey;
        try {
            const payload = {
                season: effectiveFilters.season === 'all' ? null : effectiveFilters.season,
                country: effectiveFilters.country === 'all' ? null : effectiveFilters.country,
                limit: this.leaderboardDefaultLimit
            };
            const response = await this.callableTopAuctions(payload);
            const entries = (response?.data?.leaderboard || []).map(item => ({
                regionId: item.regionId,
                regionName: item.regionName || item.regionId,
                bidder: item.bidder || '-',
                amount: item.amount || 0,
                seasonValue: item.season || 'default',
                seasonLabel: item.seasonLabel || (item.season && item.season !== 'default' ? item.season : 'í˜„ì¬ ì‹œì¦Œ'),
                countryValue: item.country || 'Global',
                countryLabel: item.country || 'Global'
            }));
            const fetchedAt = Number(response?.data?.fetchedAt);
            this.latestServerLeaderboardTimestamp = Number.isFinite(fetchedAt) ? fetchedAt : Date.now();
            this.leaderboardCache.set(cacheKey, { data: entries, timestamp: Date.now() });
            if (
                this.leaderboardFilterState &&
                this.leaderboardFilterState.season === effectiveFilters.season &&
                this.leaderboardFilterState.country === effectiveFilters.country
            ) {
                this.renderLeaderboardList(entries, 'server');
            }
        } catch (error) {
            console.warn('ì›ê²© ë¦¬ë”ë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤:', error);
        } finally {
            if (this.leaderboardPendingRequest === cacheKey) {
                this.leaderboardPendingRequest = null;
            }
        }
    }
    
    async init() {
        try {
            // 1ë‹¨ê³„: ì¦‰ì‹œ í‘œì‹œí•  í•„ìˆ˜ ìš”ì†Œë§Œ ì´ˆê¸°í™”
            this.initStarsBackground();
            this.switchToUserMode();
            this.addMapModeToggle();
            this.updateUserUI();
            
            // 2ë‹¨ê³„: ì§€ë„ ì´ˆê¸°í™” (ì‚¬ìš©ìê°€ ë°”ë¡œ ë³¼ ìˆ˜ ìˆë„ë¡ ìš°ì„ )
            await this.initializeMap();
            
            // ì§€ë„ ì´ˆê¸°í™” í›„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
            if (!this.eventListenersAdded) {
                this.setupEventListeners();
                this.eventListenersAdded = true;
            }
            
            await this.loadGlobalAdministrativeRegions();
            this.hideLoading(); // ì§€ë„ê°€ ë¡œë“œë˜ë©´ ë¡œë”© í™”ë©´ ìˆ¨ê¹€
            
            // 3ë‹¨ê³„: Firebase ì´ˆê¸°í™”ëŠ” ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¹„ë™ê¸°ë¡œ (ì§€ë„ í‘œì‹œ í›„)
            this.initializeFirebase().catch(err => {
                console.warn('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
            }).then(() => {
                // Firebase ì´ˆê¸°í™” ì™„ë£Œ í›„ ë°ì´í„° ë¡œë“œ
                if (this.isFirebaseInitialized) {
                    this.loadRegionDataFromFirestore().catch(err => {
                        console.warn('Firestore ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
                    });
                    this.subscribeAuctionUpdates().catch(err => {
                        console.warn('ì˜¥ì…˜ ì—…ë°ì´íŠ¸ êµ¬ë… ì‹¤íŒ¨:', err);
                    });
                    this.subscribeRealtimeLeaderboard().catch(err => {
                        console.warn('ë¦¬ë”ë³´ë“œ êµ¬ë… ì‹¤íŒ¨:', err);
                    });
                }
            });
            
            // ëª¨ë“  ì§€ì—­ ê°€ê²©ì„ 1000ë‹¬ëŸ¬ë¡œ í†µì¼ (ë¡œì»¬ ë©”ëª¨ë¦¬)
            this.setAllRegionsPriceToUniform();
            
            // 4ë‹¨ê³„: UI ì´ˆê¸°í™”ëŠ” ì§€ì—° ë¡œë”©ìœ¼ë¡œ (requestIdleCallback ì‚¬ìš©)
            if (window.requestIdleCallback) {
                requestIdleCallback(() => {
                    this.initializeDelayedUI();
                }, { timeout: 2000 });
            } else {
                // requestIdleCallback ë¯¸ì§€ì› ì‹œ setTimeoutìœ¼ë¡œ ëŒ€ì²´
                setTimeout(() => {
                    this.initializeDelayedUI();
                }, 100);
            }
            
            // ì˜¥ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ë¥¼ ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ (ë³´í˜¸ ì‹œê°„ ì¢…ë£Œ ì‹œ ìƒ‰ìƒ ë³€ê²½)
            setInterval(() => {
                this.updateAuctionStatusForAllRegions();
                this.updateMapAuctionColors();
            }, 60000); // 1ë¶„ë§ˆë‹¤
            
            // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì• ë‹ˆë©”ì´ì…˜ ì •ë¦¬
            window.addEventListener('beforeunload', () => {
                this.stopAuctionAnimation();
            });
            
            // ì´ˆê¸°í™” ì‹œ ê´€ë¦¬ì ì„¹ì…˜ ìˆ¨ê¸°ê¸°
            const sideAdminSection = document.getElementById('side-admin-section');
            if (sideAdminSection) {
                sideAdminSection.style.display = 'none';
            }
        } catch (error) {
            console.error('ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            this.showError('ì§€ë„ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }
    
    // ì§€ì—° ë¡œë”© UI ì´ˆê¸°í™”
    initializeDelayedUI() {
        this.setupColorPresetListeners();
        this.initializePixelExperienceUI();
        this.initializeLeaderboardFilters();
        this.initializeLeaderboardToggle(); // ë¦¬ë”ë³´ë“œ ìµœì†Œí™” ê¸°ëŠ¥ ì´ˆê¸°í™”
        this.initializeLandingPage();
        this.initializeSeasonDashboard();
        this.initializeCommunityMissions().catch(err => {
            console.warn('ì»¤ë®¤ë‹ˆí‹° ë¯¸ì…˜ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        });
        this.initializeTransparencyDashboard();
        this.initializeFlashChallenge().catch(err => {
            console.warn('í”Œë˜ì‹œ ì±Œë¦°ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', err);
        });
        this.initializeSeasonArchive();
        this.setupPixelStoryModalEvents();
        this.initializeMinimap();
        
        // ì˜¥ì…˜ ìœ„ì ¯ ì—…ë°ì´íŠ¸ëŠ” ì§€ì—°
        setTimeout(() => {
            this.updateAuctionWidgets();
            this.updateMapAuctionColors();
        }, 500);
    }
    
    // ë¦¬ë”ë³´ë“œ ìµœì†Œí™” ê¸°ëŠ¥ ì´ˆê¸°í™”
    initializeLeaderboardToggle() {
        const toggleBtn = document.getElementById('leaderboard-toggle-btn');
        const leaderboardContent = document.getElementById('leaderboard-content');
        
        if (!toggleBtn || !leaderboardContent) return;
        
        // ì´ˆê¸° ìƒíƒœëŠ” í™•ì¥ë¨
        this.leaderboardCollapsed = false;
        
        toggleBtn.addEventListener('click', () => {
            this.leaderboardCollapsed = !this.leaderboardCollapsed;
            
            if (this.leaderboardCollapsed) {
                leaderboardContent.classList.add('collapsed');
                toggleBtn.textContent = '+';
                toggleBtn.title = 'í™•ì¥';
            } else {
                leaderboardContent.classList.remove('collapsed');
                toggleBtn.textContent = 'âˆ’';
                toggleBtn.title = 'ìµœì†Œí™”';
            }
        });
    }
    
    // ë³„ ë°°ê²½ ì´ˆê¸°í™” (Canvas ê¸°ë°˜)
    initStarsBackground() {
        const canvas = document.getElementById('stars-canvas');
        if (!canvas) {
            console.error('ë³„ ìº”ë²„ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        const ctx = canvas.getContext('2d');
        const numStars = 800; // ë³„ ê°œìˆ˜ ì¦ê°€ (ë” í’ë¶€í•˜ê²Œ)
        const stars = [];
        
        // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
        const resizeCanvas = () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // ë¦¬ì‚¬ì´ì¦ˆ ì‹œ ë³„ ìœ„ì¹˜ ì¬ê³„ì‚°
            if (this.stars && this.stars.length > 0) {
                this.stars.forEach(star => {
                    star.x = Math.random() * canvas.width;
                    star.y = Math.random() * canvas.height;
                });
            }
            if (this.stars) this.drawStars();
        };
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);
        
        // ë³„ ìƒì„± (í¬ê¸°ì™€ ë°ê¸° ë‹¤ì–‘í™”)
        for (let i = 0; i < numStars; i++) {
            stars.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 2 + 0.3, // ë” ì‘ì€ ë³„ë„ í¬í•¨
                opacity: Math.random() * 0.9 + 0.1, // ë” ë°ê²Œ
                twinkleSpeed: Math.random() * 0.03 + 0.005,
                currentOpacity: Math.random() * 0.9 + 0.1,
                color: Math.random() > 0.8 ? '#87CEEB' : '#FFFFFF' // ì¼ë¶€ ë³„ì€ í•˜ëŠ˜ìƒ‰
            });
        }
        
        this.stars = stars;
        this.starsCanvas = canvas;
        this.starsCtx = ctx;
        
        // ë³„ ê·¸ë¦¬ê¸°
        this.drawStars();
        
        // ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜
        this.animateStars();
        
        console.log(`${numStars}ê°œì˜ ë³„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤`);
    }
    
    // ë³„ ê·¸ë¦¬ê¸°
    drawStars() {
        if (!this.starsCtx || !this.starsCanvas || !this.stars) return;
        
        const ctx = this.starsCtx;
        const canvas = this.starsCanvas;
        
        // ìº”ë²„ìŠ¤ í´ë¦¬ì–´
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // ë³„ ê·¸ë¦¬ê¸° (ë” ë°ê³  ì„ ëª…í•˜ê²Œ)
        this.stars.forEach(star => {
            const opacity = star.currentOpacity || star.opacity;
            const color = star.color || '#FFFFFF';
            
            // ë³„ ì¤‘ì‹¬
            ctx.beginPath();
            ctx.arc(star.x, star.y, star.radius, 0, Math.PI * 2);
            
            // ìƒ‰ìƒì— ë§ì¶˜ íˆ¬ëª…ë„ ì ìš©
            if (color === '#87CEEB') {
                ctx.fillStyle = `rgba(135, 206, 235, ${opacity})`;
            } else {
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity})`;
            }
            ctx.fill();
            
            // í° ë³„ì€ í›„ê´‘ íš¨ê³¼ ì¶”ê°€
            if (star.radius > 1.5) {
                ctx.beginPath();
                ctx.arc(star.x, star.y, star.radius * 1.5, 0, Math.PI * 2);
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.3})`;
                ctx.fill();
            }
        });
    }
    
    // ë³„ ë°˜ì§ì„ ì• ë‹ˆë©”ì´ì…˜
    animateStars() {
        if (!this.stars) return;
        
        this.stars.forEach(star => {
            if (!star.currentOpacity) star.currentOpacity = star.opacity;
            star.currentOpacity += star.twinkleSpeed;
            if (star.currentOpacity > star.opacity + 0.3 || star.currentOpacity < star.opacity - 0.3) {
                star.twinkleSpeed = -star.twinkleSpeed;
            }
        });
        
        this.drawStars();
        requestAnimationFrame(() => this.animateStars());
    }
    
    // Firebase ì´ˆê¸°í™”
    async initializeFirebase() {
        try {
            // Firebase ëª¨ë“ˆì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            if (!window.firebaseModules) {
                console.warn('Firebase ëª¨ë“ˆì´ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.');
                setTimeout(() => this.initializeFirebase(), 1000);
                return;
            }

            const { initializeApp, getAuth, getFirestore, getFunctions, httpsCallable, firebaseConfig } = window.firebaseModules;
            
            // Firebase ì„¤ì •ì´ ì‹¤ì œ ê°’ìœ¼ë¡œ êµì²´ë˜ì—ˆëŠ”ì§€ í™•ì¸
            if (firebaseConfig.apiKey === "YOUR_API_KEY" || !firebaseConfig.apiKey) {
                console.warn('Firebase ì„¤ì •ì´ ì•„ì§ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. index.htmlì—ì„œ firebaseConfigë¥¼ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”.');
                this.showNotification('Firebase ì„¤ì •ì´ í•„ìš”í•©ë‹ˆë‹¤. index.htmlì—ì„œ Firebase ì„¤ì •ì„ ì—…ë°ì´íŠ¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            // Firebase ì•± ì´ˆê¸°í™”
            this.firebaseApp = initializeApp(firebaseConfig);
            this.firebaseAuth = getAuth(this.firebaseApp);
            this.firestore = getFirestore(this.firebaseApp);
            if (typeof getFunctions === 'function' && typeof httpsCallable === 'function') {
                try {
                    this.firebaseFunctions = getFunctions(this.firebaseApp);
                    this.callableTopAuctions = httpsCallable(this.firebaseFunctions, 'getTopAuctions');
                } catch (fnError) {
                    console.warn('Firebase Functions ì´ˆê¸°í™” ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', fnError);
                }
            }
            this.isFirebaseInitialized = true;

            // ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€
            this.firebaseAuth.onAuthStateChanged((user) => {
                const wasLoggedOut = !this.currentUser && user; // ë¡œê·¸ì•„ì›ƒ ìƒíƒœì—ì„œ ë¡œê·¸ì¸ìœ¼ë¡œ ë³€ê²½
                this.currentUser = user;
                if (user) {
                    console.log('ì‚¬ìš©ì ë¡œê·¸ì¸:', user.email);
                    // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ì— PayPal ë²„íŠ¼ ìë™ ë Œë”ë§
                    if (wasLoggedOut && this.currentRegion) {
                        this.autoRenderPayPalButtons();
                    }
                } else {
                    console.log('ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ');
                }
                // UI ì—…ë°ì´íŠ¸
                this.updateUserUI();
            });

            console.log('Firebase ì´ˆê¸°í™” ì™„ë£Œ');
            await this.subscribeAuctionUpdates();
            await this.subscribeRealtimeLeaderboard();
        } catch (error) {
            console.error('Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            this.showNotification('Firebase ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¼ë¶€ ê¸°ëŠ¥ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
        }
    }

    // êµ¬ë§¤ ê¸°ë¡ì„ Firestoreì— ì €ì¥
    async savePurchaseToFirestore(regionId, regionName, paypalOrderId, buyerEmail, amount) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ êµ¬ë§¤ ê¸°ë¡ì„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const { collection, addDoc, serverTimestamp, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const purchaseData = {
                regionId: regionId,
                regionName: regionName,
                paypalOrderId: paypalOrderId,
                buyerEmail: buyerEmail,
                amount: amount,
                purchaseDate: serverTimestamp(),
                status: 'completed'
            };
            
            // ì²« ì ë ¹ì í™•ì¸ (ì´ì „ êµ¬ë§¤ ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸)
            const previousPurchasesQuery = query(
                collection(this.firestore, 'purchases'),
                where('regionId', '==', regionId)
            );
            const previousPurchases = await getDocs(previousPurchasesQuery);
            const isFirstConquest = previousPurchases.empty;
            
            // ì¸ê¸° êµ¬ì—­ í™•ì¸ (ì¸ê¸° ì§€í‘œ í™•ì¸)
            const popularity = this.regionPopularity.get(regionId);
            const isPopularRegion = popularity && (
                (popularity.bids >= 5) || 
                (popularity.views >= 20) ||
                (popularity.popularityScore >= 50)
            );
            
            // ì‹œì¦Œ íƒ€ì„ë¼ì¸ì— êµ¬ë§¤ ì´ë²¤íŠ¸ ê¸°ë¡
            await this.recordTimelineEvent({
                type: 'conquest',
                regionId: regionId,
                regionName: regionName,
                buyerEmail: buyerEmail,
                amount: amount,
                method: 'purchase'
            });

            const docRef = await addDoc(collection(this.firestore, 'purchases'), purchaseData);
            console.log('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ ì™„ë£Œ:', docRef.id);
            
            // ë³´ìƒ ì§€ê¸‰
            const userQuery = query(
                collection(this.firestore, 'users'),
                where('email', '==', buyerEmail)
            );
            const userSnapshot = await getDocs(userQuery);
            if (!userSnapshot.empty) {
                const userId = userSnapshot.docs[0].id;
                
                // ì²« ì ë ¹ì ë³´ìƒ
                if (isFirstConquest) {
                    const firstConquestReward = 100; // ì²« ì ë ¹ì ë³´ìƒ: 100 í¬ì¸íŠ¸
                    await this.giveReward(
                        userId,
                        'first_conquest',
                        firstConquestReward,
                        {
                            regionId: regionId,
                            regionName: regionName,
                            amount: amount
                        }
                    );
                }
                
                // ì¸ê¸° êµ¬ì—­ ì ë ¹ ë³´ìƒ
                if (isPopularRegion) {
                    const popularRegionReward = 75; // ì¸ê¸° êµ¬ì—­ ì ë ¹ ë³´ìƒ: 75 í¬ì¸íŠ¸
                    await this.giveReward(
                        userId,
                        'popular_region_conquest',
                        popularRegionReward,
                        {
                            regionId: regionId,
                            regionName: regionName,
                            amount: amount,
                            popularityScore: popularity?.popularityScore || 0
                        }
                    );
                }
            }
            
            return docRef.id;
        } catch (error) {
            console.error('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ ì˜¤ë¥˜:', error);
            this.showNotification('êµ¬ë§¤ ê¸°ë¡ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // íŠ¹ì • ì§€ì—­ì˜ ì†Œìœ ì í™•ì¸
    async checkRegionOwnership(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore || !this.currentUser) {
            return false;
        }

        try {
            const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const q = query(
                collection(this.firestore, 'purchases'),
                where('regionId', '==', regionId),
                where('buyerEmail', '==', this.currentUser.email),
                where('status', '==', 'completed')
            );

            const querySnapshot = await getDocs(q);
            return !querySnapshot.empty; // êµ¬ë§¤ ê¸°ë¡ì´ ìˆìœ¼ë©´ ì†Œìœ ì
        } catch (error) {
            console.error('ì†Œìœ ê¶Œ í™•ì¸ ì˜¤ë¥˜:', error);
            return false;
        }
    }

    // ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥
    async saveRegionDataToFirestore(regionId, regionData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì§€ì—­ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return false;
        }

        try {
            const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ì €ì¥í•  ë°ì´í„° (Firestoreì— ì €ì¥í•  í•„ë“œë§Œ ì¶”ì¶œ)
            const firestoreData = {
                regionId: regionId,
                name_ko: regionData.name_ko || '',
                name_en: regionData.name_en || regionData.name || '',
                country: regionData.country || '',
                admin_level: regionData.admin_level || '',
                population: regionData.population || 0,
                area: regionData.area || 0,
                ad_price: regionData.ad_price || this.uniformAdPrice || 1000,
                ad_status: regionData.ad_status || 'available',
                updatedAt: serverTimestamp()
            };
            
            if (regionData.seasonTag) {
                firestoreData.seasonTag = regionData.seasonTag;
            } else {
                firestoreData.seasonTag = null;
            }
            
            if (regionData.auctionConfig && Object.keys(regionData.auctionConfig).length > 0) {
                firestoreData.auctionConfig = regionData.auctionConfig;
            } else {
                firestoreData.auctionConfig = null;
            }

            // ì§€ì—­ IDë¥¼ ë¬¸ì„œ IDë¡œ ì‚¬ìš©í•˜ì—¬ ì €ì¥ (ë®ì–´ì“°ê¸°)
            const regionRef = doc(this.firestore, 'regions', regionId);
            await setDoc(regionRef, firestoreData, { merge: true });
            
            console.log('Firestoreì— ì§€ì—­ ë°ì´í„° ì €ì¥ ì™„ë£Œ:', regionId, firestoreData);
            return true;
        } catch (error) {
            console.error('Firestore ì§€ì—­ ë°ì´í„° ì €ì¥ ì˜¤ë¥˜:', error);
            this.showNotification('Firestoreì— ì§€ì—­ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            return false;
        }
    }

    // Firestoreì—ì„œ ëª¨ë“  ì§€ì—­ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
    async loadRegionDataFromFirestore() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ Firestoreì—ì„œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }

        try {
            const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const regionsSnapshot = await getDocs(collection(this.firestore, 'regions'));
            
            let loadedCount = 0;
            let mergedCount = 0;
            regionsSnapshot.forEach((doc) => {
                const data = doc.data();
                const regionId = data.regionId || doc.id;
                
                // ë©”ëª¨ë¦¬ì˜ regionDataì— ë³‘í•© (Firestore ë°ì´í„° ìš°ì„ , íŠ¹íˆ ì¸êµ¬/ë©´ì  ë°ì´í„°)
                const existingData = this.regionData.get(regionId) || {};
                
                // Firestore ë°ì´í„°ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ì‚¬ìš© (ì¸êµ¬/ë©´ì  ë°ì´í„°ëŠ” Firestore ìš°ì„ )
                const mergedData = {
                    ...existingData,  // ê¸°ë³¸ì€ ë¡œì»¬ ë°ì´í„°
                    ...data,  // Firestore ë°ì´í„°ë¡œ ë®ì–´ì”€ (Firestore ìš°ì„ )
                    // ì¸êµ¬/ë©´ì ì€ Firestoreì— ê°’ì´ ìˆìœ¼ë©´ Firestore ìš°ì„ 
                    population: (data.population !== undefined && data.population !== null && data.population > 0)
                        ? data.population 
                        : (existingData.population || 0),
                    area: (data.area !== undefined && data.area !== null && data.area > 0)
                        ? data.area 
                        : (existingData.area || 0),
                    // ê°€ê²©ì€ í˜„ì¬ ë©”ëª¨ë¦¬ ìƒíƒœ ìœ ì§€ (ë™ê¸°í™” ë²„íŠ¼ì—ì„œ í†µì¼í•  ë•Œê¹Œì§€)
                    ad_price: existingData.ad_price !== undefined && existingData.ad_price !== null 
                        ? existingData.ad_price 
                        : (data.ad_price !== undefined ? data.ad_price : this.uniformAdPrice || 1000),
                    // ê¸°íƒ€ í•„ë“œëŠ” Firestore ìš°ì„ , ì—†ìœ¼ë©´ ë¡œì»¬
                    name_ko: data.name_ko || existingData.name_ko || '',
                    name_en: data.name_en || existingData.name_en || existingData.name || '',
                    country: data.country || existingData.country || '',
                    admin_level: data.admin_level || existingData.admin_level || '',
                    ad_status: data.ad_status || existingData.ad_status || 'available'
                };
                
                // ë¡œì»¬ ë°ì´í„°ê°€ ìˆì—ˆëŠ”ì§€ í™•ì¸
                if (Object.keys(existingData).length > 0) {
                    mergedCount++;
                }
                
                this.regionData.set(regionId, mergedData);
                loadedCount++;
            });

            console.log(`Firestoreì—ì„œ ${loadedCount}ê°œì˜ ì§€ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. (ë¡œì»¬ ë°ì´í„°ì™€ ë³‘í•©: ${mergedCount}ê°œ)`);

            // ì§€ë„ ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
            this.updateMapSourcesWithRegionData();
            
        } catch (error) {
            console.error('Firestore ì§€ì—­ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° ì˜¤ë¥˜:', error);
            // ì˜¤ë¥˜ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰ (ë¡œì»¬ ë°ì´í„° ì‚¬ìš©)
        }
    }
    
    async subscribeAuctionUpdates() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì˜¥ì…˜ ë°ì´í„°ë¥¼ êµ¬ë…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        const { collection, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const auctionsRef = collection(this.firestore, 'auctions');
        
        if (this.auctionUnsubscribe) {
            this.auctionUnsubscribe();
        }
        
        this.auctionUnsubscribe = onSnapshot(auctionsRef, (snapshot) => {
            snapshot.docChanges().forEach(change => {
                const data = change.doc.data();
                const regionId = data.regionId || change.doc.id;
                if (!regionId) return;
                
                if (change.type === 'removed') {
                    this.auctionData.delete(regionId);
                    this.applyAuctionDataToRegion(regionId, null);
                } else {
                    const normalized = { ...data, regionId };
                    this.auctionData.set(regionId, normalized);
                    this.applyAuctionDataToRegion(regionId, normalized);
                }
            });
            this.updateAuctionWidgets();
        }, (error) => {
            console.error('ì˜¥ì…˜ ë°ì´í„° êµ¬ë… ì˜¤ë¥˜:', error);
        });
    }

    async subscribeRealtimeLeaderboard() {
        if (!this.isFirebaseInitialized || !this.firestore || !this.realtimeLeaderboardEnabled) {
            return;
        }

        const { doc, onSnapshot } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const leaderboardRef = doc(this.firestore, 'realtimePanels', 'leaderboard');

        if (this.leaderboardRealtimeUnsubscribe) {
            this.leaderboardRealtimeUnsubscribe();
        }

        this.leaderboardRealtimeUnsubscribe = onSnapshot(leaderboardRef, (snapshot) => {
            if (!snapshot.exists()) {
                this.realtimeLeaderboard = null;
                return;
            }
            const data = snapshot.data() || {};
            const normalizedEntries = (data.leaderboard || []).map(item => ({
                regionId: item.regionId,
                regionName: item.regionName || item.regionId,
                bidder: item.bidder || '-',
                amount: item.amount || 0,
                seasonValue: item.season || 'default',
                seasonLabel: item.seasonLabel || (item.season && item.season !== 'default' ? item.season : 'í˜„ì¬ ì‹œì¦Œ'),
                countryValue: item.country || 'Global',
                countryLabel: item.country || 'Global'
            }));

            const updatedAtMillis = (() => {
                const updatedAt = data.updatedAt;
                if (!updatedAt) return Date.now();
                if (typeof updatedAt.toMillis === 'function') return updatedAt.toMillis();
                if (updatedAt instanceof Date) return updatedAt.getTime();
                if (updatedAt.seconds !== undefined) {
                    return (updatedAt.seconds * 1000) + Math.floor((updatedAt.nanoseconds || 0) / 1e6);
                }
                return Date.now();
            })();

            this.realtimeLeaderboard = {
                entries: normalizedEntries,
                updatedAt: updatedAtMillis
            };
            this.latestServerLeaderboardTimestamp = updatedAtMillis;
            this.updateRealtimeLeaderboardViewIfActive(true);
        }, (error) => {
            console.error('ë¦¬ë”ë³´ë“œ ì‹¤ì‹œê°„ êµ¬ë… ì˜¤ë¥˜:', error);
        });
    }

    updateRealtimeLeaderboardViewIfActive(forceRender = false) {
        if (!this.realtimeLeaderboard || !this.realtimeLeaderboard.entries?.length) {
            return;
        }
        const filters = this.leaderboardFilterState || { season: 'all', country: 'all' };
        if (!this.canUseRealtimeLeaderboard(filters)) {
            return;
        }
        const limited = this.realtimeLeaderboard.entries.slice(0, this.leaderboardDefaultLimit);
        this.renderLeaderboardList(limited, 'server');
        this.lastRenderedLeaderboardSource = 'server';
    }
    
    // ì‹œì¦Œ íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ê¸°ë¡
    async recordTimelineEvent(eventData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            // Firebaseê°€ ì—†ì–´ë„ ë©”ëª¨ë¦¬ì— ì €ì¥
            const event = {
                ...eventData,
                timestamp: Date.now(),
                seasonId: this.currentSeason.id
            };
            this.seasonTimeline.push(event);
            
            // êµ¬ì—­ë³„ ì ë ¹ íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
            if (eventData.type === 'conquest' && eventData.regionId) {
                const history = this.regionConquestHistory.get(eventData.regionId) || [];
                history.push(event);
                this.regionConquestHistory.set(eventData.regionId, history);
            }
            return;
        }
        
        try {
            const { collection, addDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            const timelineEvent = {
                ...eventData,
                seasonId: this.currentSeason.id,
                timestamp: serverTimestamp(),
                createdAt: serverTimestamp()
            };
            
            // Firestoreì— ì €ì¥
            const timelineRef = collection(this.firestore, 'seasons', this.currentSeason.id, 'timeline');
            await addDoc(timelineRef, timelineEvent);
            
            // ë©”ëª¨ë¦¬ì—ë„ ì €ì¥
            const event = {
                ...eventData,
                timestamp: Date.now(),
                seasonId: this.currentSeason.id
            };
            this.seasonTimeline.push(event);
            
            // êµ¬ì—­ë³„ ì ë ¹ íˆìŠ¤í† ë¦¬ ì—…ë°ì´íŠ¸
            if (eventData.type === 'conquest' && eventData.regionId) {
                const history = this.regionConquestHistory.get(eventData.regionId) || [];
                history.push(event);
                this.regionConquestHistory.set(eventData.regionId, history);
            }
        } catch (error) {
            console.error('íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ê¸°ë¡ ì‹¤íŒ¨:', error);
        }
    }
    
    applyAuctionDataToRegion(regionId, auctionData) {
        const region = this.regionData.get(regionId);
        if (!region) return;
        
        // ì´ì „ ì˜¥ì…˜ ë°ì´í„° í™•ì¸ (ë‚™ì°° ê°ì§€ìš©)
        const previousAuction = region.auction;
        const wasOccupied = region.ad_status === 'occupied';
        
        if (auctionData) {
            region.auction = auctionData;
            if (region.ad_status !== 'occupied') {
                region.ad_status = auctionData.currentBid ? 'auction' : (region.ad_status || 'available');
            }
            
            // ë‚™ì°° ê°ì§€: ì´ì „ì— ì…ì°°ì´ ìˆì—ˆê³  í˜„ì¬ ì ìœ  ìƒíƒœë¡œ ë³€ê²½ëœ ê²½ìš°
            if (!wasOccupied && region.ad_status === 'occupied' && auctionData.currentBidder) {
                // ì´ì „ ì†Œìœ ì í™•ì¸ (ë°©ì–´ ì‹¤íŒ¨ ë³´ìƒ ì§€ê¸‰ìš©)
                const previousOwner = previousAuction?.currentBidder;
                if (previousOwner && previousOwner.uid !== auctionData.currentBidder.uid) {
                    // ì´ì „ ì†Œìœ ìì—ê²Œ ë°©ì–´ ì‹¤íŒ¨ ë³´ìƒ ì§€ê¸‰
                    const defenseFailureReward = 25; // ë°©ì–´ ì‹¤íŒ¨ ë³´ìƒ: 25 í¬ì¸íŠ¸
                    this.giveReward(
                        previousOwner.uid,
                        'defense_failure',
                        defenseFailureReward,
                        {
                            regionId: regionId,
                            regionName: this.getRegionDisplayName(region),
                            newOwner: auctionData.currentBidder.email,
                            bidAmount: auctionData.currentBid
                        }
                    ).catch(err => console.error('ë°©ì–´ ì‹¤íŒ¨ ë³´ìƒ ì§€ê¸‰ ì‹¤íŒ¨:', err));
                }
                
                // ì²« ì ë ¹ì ë° ì¸ê¸° êµ¬ì—­ ì ë ¹ ë³´ìƒ í™•ì¸ (ë‚™ì°° ì‹œ)
                this.checkAndGiveConquestRewards(
                    regionId,
                    this.getRegionDisplayName(region),
                    auctionData.currentBidder.uid,
                    auctionData.currentBidder.email,
                    auctionData.currentBid
                ).catch(err => console.error('ì ë ¹ ë³´ìƒ ì§€ê¸‰ ì‹¤íŒ¨:', err));
                
                this.recordTimelineEvent({
                    type: 'conquest',
                    regionId: regionId,
                    regionName: this.getRegionDisplayName(region),
                    buyerEmail: auctionData.currentBidder.email,
                    amount: auctionData.currentBid,
                    method: 'auction'
                }).catch(err => console.error('ë‚™ì°° íƒ€ì„ë¼ì¸ ê¸°ë¡ ì‹¤íŒ¨:', err));
            }
            
            // ì˜¥ì…˜ ìƒíƒœ ì •ë³´ ì¶”ê°€ (ì§€ë„ ì‹œê°í™”ìš©)
            const hasProtection = this.isProtectionActive(auctionData.protectionEndsAt);
            region.auction_status = hasProtection ? 'protected' : (auctionData.currentBid ? 'bidding' : 'available');
        } else {
            delete region.auction;
            delete region.auction_status;
            if (region.ad_status === 'auction') {
                region.ad_status = 'available';
            }
        }
        
        this.regionData.set(regionId, region);
        this.updateMapSourcesWithRegionData();
        this.updateMapAuctionColors();
        
        if (this.currentRegion && this.currentRegion.id === regionId) {
            this.currentRegion = region;
            this.updateAuctionPanel(region);
            this.updateCompanyModalAuctionSection(regionId);
        }
    }

    // ì§€ë„ ì†ŒìŠ¤ë“¤ì„ regionDataë¡œ ì—…ë°ì´íŠ¸
    updateMapSourcesWithRegionData() {
        if (!this.map) return;

        // ëª¨ë“  ê°€ëŠ¥í•œ ì†ŒìŠ¤ ID ëª©ë¡
        const sourceIds = [
            'world-regions', 'korea-regions', 'japan-regions', 'china-regions',
            'russia-regions', 'india-regions', 'canada-regions', 'germany-regions',
            'uk-regions', 'france-regions', 'italy-regions', 'brazil-regions',
            'australia-regions', 'mexico-regions', 'indonesia-regions',
            'saudi-arabia-regions', 'turkey-regions', 'south-africa-regions',
            'argentina-regions', 'european-union-regions', 'spain-regions',
            'netherlands-regions', 'poland-regions', 'belgium-regions',
            'sweden-regions', 'austria-regions', 'denmark-regions',
            'finland-regions', 'ireland-regions', 'portugal-regions',
            'greece-regions', 'czech-republic-regions', 'romania-regions',
            'hungary-regions', 'bulgaria-regions'
        ];

        sourceIds.forEach(sourceId => {
            const source = this.map.getSource(sourceId);
            if (source && source._data && source._data.features) {
                let updated = false;
                source._data.features.forEach(feature => {
                    const regionId = feature.properties.id;
                    if (regionId && this.regionData.has(regionId)) {
                        const updatedData = this.regionData.get(regionId);
                        Object.assign(feature.properties, updatedData);
                        
                        // ì˜¥ì…˜ ìƒíƒœ ì •ë³´ ì—…ë°ì´íŠ¸
                        if (updatedData.auction) {
                            const hasProtection = this.isProtectionActive(updatedData.auction.protectionEndsAt);
                            feature.properties.auction_status = hasProtection ? 'protected' : (updatedData.auction.currentBid ? 'bidding' : 'available');
                        } else {
                            delete feature.properties.auction_status;
                        }
                        
                        updated = true;
                    }
                });
                
                if (updated) {
                    source.setData(source._data);
                }
            }
        });
    }
    
    // ì˜¥ì…˜ ìƒíƒœì— ë”°ë¼ ì§€ë„ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    updateMapAuctionColors() {
        if (!this.map || !this.map.getLayer('regions-fill')) return;
        
        // ì§€ë„ ë ˆì´ì–´ì˜ fill-color ì†ì„±ì„ ì—…ë°ì´íŠ¸í•˜ì—¬ ì˜¥ì…˜ ìƒíƒœì— ë”°ë¼ ìƒ‰ìƒ ë³€ê²½
        this.map.setPaintProperty('regions-fill', 'fill-color', [
            'case',
            // ë‚™ì°°/ì ìœ  ìƒíƒœ - ë¹¨ê°„ìƒ‰
            ['==', ['get', 'ad_status'], 'occupied'],
            '#ff6b6b',
            // ë³´í˜¸ ì¤‘ - ë…¸ë€ìƒ‰ (ê¹œë¹¡ì´ëŠ” íš¨ê³¼ë¥¼ ìœ„í•œ ë°ì€ ë…¸ë€ìƒ‰)
            ['==', ['get', 'auction_status'], 'protected'],
            '#ffd93d',
            // ì…ì°° ì¤‘ - ì£¼í™©ìƒ‰
            ['==', ['get', 'auction_status'], 'bidding'],
            '#ff9f43',
            // ì˜¥ì…˜ ì§„í–‰ ì¤‘ (ê¸°ë³¸) - ë…¸ë€ìƒ‰
            ['==', ['get', 'ad_status'], 'auction'],
            '#feca57',
            // ì‚¬ìš© ê°€ëŠ¥ - ê¸°ë³¸ ìƒ‰ìƒ
            ['coalesce', ['get', 'color'], '#4ecdc4']
        ]);
        
        // ê²½í•© ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
        this.updateAuctionStatusIcons();
        
        // ê²½í•© ìƒíƒœ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        this.startAuctionAnimation();
    }
    
    // ê²½í•© ìƒíƒœ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
    updateAuctionStatusIcons() {
        if (!this.map) return;
        
        // ì˜¥ì…˜ ìƒíƒœ ì•„ì´ì½˜ì„ ìœ„í•œ GeoJSON ë°ì´í„° ìƒì„±
        const iconFeatures = [];
        
        this.regionData.forEach((region, regionId) => {
            if (!region.auction && region.ad_status !== 'occupied') return;
            
            // ì§€ì—­ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
            const source = this.map.getSource('world-regions');
            if (!source || !source._data) return;
            
            const feature = source._data.features.find(f => f.properties.id === regionId);
            if (!feature || !feature.geometry) return;
            
            let center = null;
            if (feature.geometry.type === 'Polygon') {
                const coords = feature.geometry.coordinates[0];
                const lons = coords.map(c => c[0]);
                const lats = coords.map(c => c[1]);
                center = [
                    (Math.min(...lons) + Math.max(...lons)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                ];
            } else if (feature.geometry.type === 'MultiPolygon') {
                const allCoords = feature.geometry.coordinates.flat();
                const lons = allCoords.flat().map(c => c[0]);
                const lats = allCoords.flat().map(c => c[1]);
                center = [
                    (Math.min(...lons) + Math.max(...lons)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                ];
            }
            
            if (center) {
                // ìƒíƒœì— ë”°ë¥¸ ì•„ì´ì½˜ ê²°ì •
                let icon = '';
                if (region.ad_status === 'occupied') {
                    icon = 'âœ…';
                } else if (region.auction_status === 'protected') {
                    icon = 'ğŸ›¡ï¸';
                } else if (region.auction_status === 'bidding' || region.ad_status === 'auction') {
                    icon = 'âš¡';
                }
                
                if (icon) {
                    iconFeatures.push({
                        type: 'Feature',
                        geometry: {
                            type: 'Point',
                            coordinates: center
                        },
                        properties: {
                            regionId: regionId,
                            icon: icon,
                            status: region.auction_status || region.ad_status
                        }
                    });
                }
            }
        });
        
        // ì•„ì´ì½˜ ì†ŒìŠ¤ ì¶”ê°€/ì—…ë°ì´íŠ¸
        const iconSourceId = 'auction-status-icons';
        if (this.map.getSource(iconSourceId)) {
            this.map.getSource(iconSourceId).setData({
                type: 'FeatureCollection',
                features: iconFeatures
            });
        } else {
            this.map.addSource(iconSourceId, {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: iconFeatures
                }
            });
        }
        
        // ì•„ì´ì½˜ ë ˆì´ì–´ ì¶”ê°€
        if (!this.map.getLayer('auction-status-icons')) {
            this.map.addLayer({
                id: 'auction-status-icons',
                type: 'symbol',
                source: iconSourceId,
                layout: {
                    'text-field': ['get', 'icon'],
                    'text-size': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        5, 16,
                        10, 24,
                        15, 32
                    ],
                    'text-anchor': 'center',
                    'text-allow-overlap': true,
                    'text-ignore-placement': true
                },
                paint: {
                    'text-color': '#ffffff',
                    'text-halo-color': '#000000',
                    'text-halo-width': 2,
                    'text-opacity': [
                        'case',
                        ['==', ['get', 'status'], 'protected'],
                        0.8,
                        ['==', ['get', 'status'], 'bidding'],
                        0.9,
                        1.0
                    ]
                }
            });
        }
    }
    
    // ê²½í•© ìƒíƒœ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    startAuctionAnimation() {
        if (this.auctionAnimationFrame) return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì´ë©´ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
        
        const animate = (timestamp) => {
            if (!this.map || !this.map.getLayer('regions-fill')) {
                this.auctionAnimationFrame = null;
                return;
            }
            
            // ì• ë‹ˆë©”ì´ì…˜ ì‹œê°„ ì—…ë°ì´íŠ¸ (ë°€ë¦¬ì´ˆë¥¼ ì´ˆë¡œ ë³€í™˜)
            this.auctionAnimationTime = timestamp / 1000;
            
            // ë³´í˜¸ ì¤‘ ìƒíƒœ: ëŠë¦° ê¹œë¹¡ì„ (1ì´ˆ ì£¼ê¸°)
            const protectedOpacity = 0.6 + 0.4 * Math.sin(this.auctionAnimationTime * Math.PI * 2);
            
            // ì…ì°° ì¤‘ ìƒíƒœ: ë¹ ë¥¸ ê¹œë¹¡ì„ (0.5ì´ˆ ì£¼ê¸°)
            const biddingOpacity = 0.5 + 0.5 * Math.sin(this.auctionAnimationTime * Math.PI * 4);
            
            // ì˜¥ì…˜ ì§„í–‰ ì¤‘ ìƒíƒœ: ì¤‘ê°„ ì†ë„ ê¹œë¹¡ì„ (0.75ì´ˆ ì£¼ê¸°)
            const auctionOpacity = 0.7 + 0.3 * Math.sin(this.auctionAnimationTime * Math.PI * 2.67);
            
            // fill-opacity ì†ì„±ì„ ìƒíƒœë³„ë¡œ ì—…ë°ì´íŠ¸
            this.map.setPaintProperty('regions-fill', 'fill-opacity', [
                'case',
                // ë‚™ì°°/ì ìœ  ìƒíƒœ - ê³ ì • ë¶ˆíˆ¬ëª…ë„
                ['==', ['get', 'ad_status'], 'occupied'],
                0.9,
                // ë³´í˜¸ ì¤‘ - ëŠë¦° ê¹œë¹¡ì„
                ['==', ['get', 'auction_status'], 'protected'],
                protectedOpacity,
                // ì…ì°° ì¤‘ - ë¹ ë¥¸ ê¹œë¹¡ì„
                ['==', ['get', 'auction_status'], 'bidding'],
                biddingOpacity,
                // ì˜¥ì…˜ ì§„í–‰ ì¤‘ - ì¤‘ê°„ ì†ë„ ê¹œë¹¡ì„
                ['==', ['get', 'ad_status'], 'auction'],
                auctionOpacity,
                // ì‚¬ìš© ê°€ëŠ¥ - ê³ ì • ë¶ˆíˆ¬ëª…ë„
                0.8
            ]);
            
            // ë‹¤ìŒ í”„ë ˆì„ ìš”ì²­
            this.auctionAnimationFrame = requestAnimationFrame(animate);
        };
        
        // ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        this.auctionAnimationFrame = requestAnimationFrame(animate);
    }
    
    // ê²½í•© ìƒíƒœ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
    stopAuctionAnimation() {
        if (this.auctionAnimationFrame) {
            cancelAnimationFrame(this.auctionAnimationFrame);
            this.auctionAnimationFrame = null;
        }
    }
    
    // ëª¨ë“  ì§€ì—­ì˜ ì˜¥ì…˜ ìƒíƒœ ì—…ë°ì´íŠ¸ (ë³´í˜¸ ì‹œê°„ ì¢…ë£Œ í™•ì¸)
    updateAuctionStatusForAllRegions() {
        let updated = false;
        this.regionData.forEach((region, regionId) => {
            if (region.auction) {
                const hasProtection = this.isProtectionActive(region.auction.protectionEndsAt);
                const newStatus = hasProtection ? 'protected' : (region.auction.currentBid ? 'bidding' : 'available');
                if (region.auction_status !== newStatus) {
                    region.auction_status = newStatus;
                    this.regionData.set(regionId, region);
                    updated = true;
                }
            }
        });
        
        if (updated) {
            this.updateMapSourcesWithRegionData();
        }
    }
    
    // ì§€ì—­ ì¸ê¸° ì§€í‘œ ì—…ë°ì´íŠ¸
    updateRegionPopularity(regionId, type = 'view') {
        if (!regionId) return;
        
        const popularity = this.regionPopularity.get(regionId) || {
            views: 0,
            bids: 0,
            lastUpdated: Date.now()
        };
        
        if (type === 'view') {
            popularity.views += 1;
        } else if (type === 'bid') {
            popularity.bids += 1;
        }
        
        popularity.lastUpdated = Date.now();
        this.regionPopularity.set(regionId, popularity);
        
        // ì¸ê¸° ì§€í‘œì— ë”°ë¼ ê°€ê²© ìë™ ì¡°ì ˆ
        this.adjustPriceByPopularity(regionId);
    }
    
    // ì¸ê¸° ì§€í‘œì— ë”°ë¥¸ ê°€ê²© ìë™ ì¡°ì ˆ
    adjustPriceByPopularity(regionId) {
        const region = this.regionData.get(regionId);
        if (!region) return;
        
        const popularity = this.regionPopularity.get(regionId);
        if (!popularity) return;
        
        const basePrice = region.ad_price || this.uniformAdPrice || 1000;
        
        // ì¸ê¸° ì§€í‘œ ê³„ì‚° (ì…ì°° íšŸìˆ˜ì™€ ì¡°íšŒìˆ˜ ê°€ì¤‘ í‰ê· )
        const bidWeight = 0.7; // ì…ì°° íšŸìˆ˜ ê°€ì¤‘ì¹˜
        const viewWeight = 0.3; // ì¡°íšŒìˆ˜ ê°€ì¤‘ì¹˜
        
        // ì •ê·œí™”ëœ ì¸ê¸° ì ìˆ˜ (0~1)
        const normalizedBids = Math.min(popularity.bids / 10, 1); // ìµœëŒ€ 10íšŒ ì…ì°° ì‹œ 1.0
        const normalizedViews = Math.min(popularity.views / 50, 1); // ìµœëŒ€ 50íšŒ ì¡°íšŒ ì‹œ 1.0
        
        const popularityScore = (normalizedBids * bidWeight) + (normalizedViews * viewWeight);
        
        // ê°€ê²© ì¡°ì ˆ ê³„ìˆ˜ (ì¸ê¸° ì ìˆ˜ì— ë”°ë¼ 1.0 ~ 2.0)
        const priceMultiplier = 1.0 + (popularityScore * 1.0); // ìµœëŒ€ 2ë°°ê¹Œì§€ ìƒìŠ¹
        
        // ìƒˆë¡œìš´ ê°€ê²© ê³„ì‚° (ê¸°ë³¸ ê°€ê²©ì˜ ìµœëŒ€ 2ë°°ê¹Œì§€)
        const adjustedPrice = Math.floor(basePrice * priceMultiplier);
        
        // ê°€ê²© ì—…ë°ì´íŠ¸ (ê¸°ì¡´ ê°€ê²©ë³´ë‹¤ ë†’ì„ ë•Œë§Œ)
        if (adjustedPrice > basePrice) {
            region.ad_price = adjustedPrice;
            this.regionData.set(regionId, region);
            this.updateMapSourcesWithRegionData();
        }
    }
    
    // ì§€ì—­ í´ë¦­ ì‹œ ì¡°íšŒìˆ˜ ì¦ê°€
    onRegionClick(regionId) {
        this.updateRegionPopularity(regionId, 'view');
    }

    // ëª¨ë“  ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ 1000ë‹¬ëŸ¬ë¡œ í†µì¼
    setAllRegionsPriceToUniform() {
        let updatedCount = 0;
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.ad_price !== this.uniformAdPrice) {
                regionData.ad_price = this.uniformAdPrice;
                this.regionData.set(regionId, regionData);
                updatedCount++;
            }
        });

        // ì§€ë„ ì†ŒìŠ¤ë„ ì—…ë°ì´íŠ¸
        this.updateMapSourcesWithRegionData();

        console.log(`${updatedCount}ê°œ ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ ${this.uniformAdPrice}ë‹¬ëŸ¬ë¡œ í†µì¼í–ˆìŠµë‹ˆë‹¤.`);
        return updatedCount;
    }

    // ì§€ë„ì— ë¡œë“œëœ ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
    collectAllRegionsFromMapSources() {
        if (!this.map) {
            console.warn('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return 0;
        }

        let collectedCount = 0;
        let preservedCount = 0;
        
        // ëª¨ë“  ê°€ëŠ¥í•œ ì†ŒìŠ¤ ID ëª©ë¡
        const sourceIds = [
            'world-regions', 'korea-regions', 'japan-regions', 'china-regions',
            'russia-regions', 'india-regions', 'canada-regions', 'germany-regions',
            'uk-regions', 'france-regions', 'italy-regions', 'brazil-regions',
            'australia-regions', 'mexico-regions', 'indonesia-regions',
            'saudi-arabia-regions', 'turkey-regions', 'south-africa-regions',
            'argentina-regions', 'european-union-regions', 'spain-regions',
            'netherlands-regions', 'poland-regions', 'belgium-regions',
            'sweden-regions', 'austria-regions', 'denmark-regions',
            'finland-regions', 'ireland-regions', 'portugal-regions',
            'greece-regions', 'czech-republic-regions', 'romania-regions',
            'hungary-regions', 'bulgaria-regions'
        ];

        // ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        sourceIds.forEach(sourceId => {
            const source = this.map.getSource(sourceId);
            if (source && source._data && source._data.features) {
                source._data.features.forEach(feature => {
                    const props = feature.properties;
                    const regionId = props.id;
                    
                    if (regionId) {
                        // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë³‘í•©, ì—†ìœ¼ë©´ ìƒˆë¡œ ì¶”ê°€
                        const existingData = this.regionData.get(regionId) || {};
                        
                        // Firestoreì—ì„œ ë¶ˆëŸ¬ì˜¨ ì¸êµ¬/ë©´ì  ë°ì´í„°ë¥¼ ìš°ì„ ì ìœ¼ë¡œ ìœ ì§€
                        const firestorePopulation = existingData.population && existingData.population > 0 ? existingData.population : null;
                        const firestoreArea = existingData.area && existingData.area > 0 ? existingData.area : null;
                        
                        // GeoJSON propertiesì—ì„œ ì§€ì—­ ë°ì´í„° ì¶”ì¶œ
                        const regionData = {
                            id: regionId,
                            // ê¸°ë³¸ ì •ë³´ëŠ” GeoJSONì—ì„œ ê°€ì ¸ì˜¤ë˜, Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€
                            name_ko: existingData.name_ko || props.name_ko || '',
                            name_en: existingData.name_en || props.name_en || props.name || '',
                            country: existingData.country || props.country || '',
                            admin_level: existingData.admin_level || props.admin_level || '',
                            // ì¸êµ¬/ë©´ì ì€ Firestore ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìš°ì„  ìœ ì§€, ì—†ìœ¼ë©´ GeoJSON ì‚¬ìš©
                            population: firestorePopulation !== null ? firestorePopulation : (props.population !== undefined && props.population !== null ? props.population : 0),
                            area: firestoreArea !== null ? firestoreArea : (props.area !== undefined && props.area !== null ? props.area : 0),
                            // ê°€ê²©ì€ ê¸°ì¡´ ë°ì´í„° ìš°ì„ , ì—†ìœ¼ë©´ GeoJSON, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                            ad_price: existingData.ad_price !== undefined && existingData.ad_price !== null ? existingData.ad_price : (props.ad_price !== undefined && props.ad_price !== null ? props.ad_price : this.uniformAdPrice || 1000),
                            ad_status: existingData.ad_status || props.ad_status || (props.occupied ? 'occupied' : 'available')
                        };

                        // Firestore ë°ì´í„°ë¥¼ ë³´ì¡´í–ˆëŠ”ì§€ í™•ì¸
                        if (firestorePopulation !== null || firestoreArea !== null) {
                            preservedCount++;
                        }

                        // ìƒˆë¡œìš´ ë°ì´í„°ë§Œ ì¹´ìš´íŠ¸
                        if (!this.regionData.has(regionId)) {
                            collectedCount++;
                        }
                        
                        this.regionData.set(regionId, regionData);
                    }
                });
            }
        });

        console.log(`ì§€ë„ ì†ŒìŠ¤ì—ì„œ ${collectedCount}ê°œì˜ ìƒˆë¡œìš´ ì§€ì—­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤. (Firestore ë°ì´í„° ë³´ì¡´: ${preservedCount}ê°œ)`);
        return collectedCount;
    }

    // ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì¼ê´„ ì €ì¥
    async saveAllRegionsToFirestore() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì§€ì—­ ë°ì´í„°ë¥¼ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•„ ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: 0 };
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        if (!this.currentUser) {
            console.warn('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•˜ì§€ ì•Šì•„ Firestoreì— ì €ì¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            this.showNotification('Firestoreì— ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.', 'warning');
            return { success: 0, failed: 0 };
        }

        try {
            // ë¨¼ì € ì§€ë„ì— ë¡œë“œëœ ëª¨ë“  ì†ŒìŠ¤ì—ì„œ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
            const collectedCount = this.collectAllRegionsFromMapSources();
            console.log(`ì´ ìˆ˜ì§‘ëœ ì§€ì—­: ${this.regionData.size}ê°œ (ì‹ ê·œ: ${collectedCount}ê°œ)`);

            const { doc, setDoc, serverTimestamp, writeBatch } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            let successCount = 0;
            let failedCount = 0;
            const batchSize = 500; // Firestore ë°°ì¹˜ ì œí•œ (500ê°œ)
            const regions = Array.from(this.regionData.entries());
            const totalRegions = regions.length;

            this.showNotification(`ì´ ${totalRegions}ê°œ ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥ ì¤‘...`, 'info');

            // ë°°ì¹˜ ë‹¨ìœ„ë¡œ ë‚˜ëˆ„ì–´ ì €ì¥
            for (let i = 0; i < regions.length; i += batchSize) {
                const batch = writeBatch(this.firestore);
                const batchRegions = regions.slice(i, i + batchSize);
                
                for (const [regionId, regionData] of batchRegions) {
                    try {
                        // ì €ì¥í•  ë°ì´í„° (Firestoreì— ì €ì¥í•  í•„ë“œë§Œ ì¶”ì¶œ)
                        const firestoreData = {
                            regionId: regionId,
                            name_ko: regionData.name_ko || '',
                            name_en: regionData.name_en || regionData.name || '',
                            country: regionData.country || '',
                            admin_level: regionData.admin_level || '',
                            population: regionData.population || 0,
                            area: regionData.area || 0,
                            ad_price: regionData.ad_price || this.uniformAdPrice || 1000,
                            ad_status: regionData.ad_status || 'available',
                            updatedAt: serverTimestamp()
                        };

                        const regionRef = doc(this.firestore, 'regions', regionId);
                        batch.set(regionRef, firestoreData, { merge: true });
                    } catch (error) {
                        console.error(`ì§€ì—­ ${regionId} ë°°ì¹˜ ì¶”ê°€ ì˜¤ë¥˜:`, error);
                        failedCount++;
                    }
                }

                try {
                    await batch.commit();
                    successCount += batchRegions.length;
                    console.log(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì €ì¥ ì™„ë£Œ: ${batchRegions.length}ê°œ ì§€ì—­`);
                    
                    // ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸
                    const progress = Math.round((successCount / totalRegions) * 100);
                    this.showNotification(`Firestore ì €ì¥ ì¤‘... ${progress}% (${successCount}/${totalRegions})`, 'info');
                } catch (error) {
                    console.error(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì €ì¥ ì˜¤ë¥˜:`, error);
                    
                    // ê¶Œí•œ ì˜¤ë¥˜ì¸ ê²½ìš° ë” ìì„¸í•œ ì •ë³´ ì¶œë ¥
                    if (error.code === 'permission-denied' || error.message?.includes('permissions')) {
                        console.error('Firestore ê¶Œí•œ ì˜¤ë¥˜:', error);
                        console.error('- ë¡œê·¸ì¸ ìƒíƒœ:', this.currentUser ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ ì•ˆë¨');
                        console.error('- ì‚¬ìš©ì ì´ë©”ì¼:', this.currentUser?.email || 'ì—†ìŒ');
                        console.error('- Firestore ê·œì¹™ í™•ì¸: regions ì»¬ë ‰ì…˜ì— ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                        this.showNotification(`Firestore ê¶Œí•œ ì˜¤ë¥˜: ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”. (í˜„ì¬: ${this.currentUser ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì¸ ì•ˆë¨'})`, 'error');
                    } else {
                        this.showNotification(`ë°°ì¹˜ ${Math.floor(i / batchSize) + 1} ì €ì¥ ì˜¤ë¥˜: ${error.message}`, 'error');
                    }
                    
                    failedCount += batchRegions.length;
                }
            }

            this.showNotification(`Firestore ì €ì¥ ì™„ë£Œ: ${successCount}ê°œ ì„±ê³µ, ${failedCount}ê°œ ì‹¤íŒ¨`, successCount > 0 ? 'success' : 'error');
            console.log(`ëª¨ë“  ì§€ì—­ ë°ì´í„° Firestore ì €ì¥ ì™„ë£Œ: ${successCount}ê°œ ì„±ê³µ, ${failedCount}ê°œ ì‹¤íŒ¨`);
            
            return { success: successCount, failed: failedCount, collected: collectedCount };
        } catch (error) {
            console.error('ëª¨ë“  ì§€ì—­ ë°ì´í„° Firestore ì €ì¥ ì˜¤ë¥˜:', error);
            this.showNotification('Firestore ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: this.regionData.size, collected: 0 };
        }
    }

    // ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ ë™ê¸°í™” (ê°€ê²© í†µì¼ + Firestore ì €ì¥)
    async syncAllRegionsToFirestore() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: 0, collected: 0, priceUpdated: 0 };
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        if (!this.currentUser) {
            this.showNotification('Firestoreì— ì €ì¥í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤. ì‚¬ìš©ì ë¡œê·¸ì¸ì„ ë¨¼ì € í•´ì£¼ì„¸ìš”.', 'warning');
            // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸°
            const userLoginModal = document.getElementById('user-login-modal');
            if (userLoginModal) {
                userLoginModal.classList.remove('hidden');
            }
            return { success: 0, failed: 0, collected: 0, priceUpdated: 0 };
        }

        try {
            this.showNotification('ì „ì„¸ê³„ ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ë¡œë“œí•˜ëŠ” ì¤‘...', 'info');
            
            // 1. ë¨¼ì € Firestoreì—ì„œ ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
            const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionsSnapshot = await getDocs(collection(this.firestore, 'regions'));
            
            // Firestore ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ë¡œ ë¡œë“œ (ì¸êµ¬/ë©´ì  ë°ì´í„° ë³´ì¡´)
            const firestoreDataMap = new Map();
            regionsSnapshot.forEach((doc) => {
                const data = doc.data();
                const regionId = data.regionId || doc.id;
                firestoreDataMap.set(regionId, {
                    population: data.population || 0,
                    area: data.area || 0,
                    name_ko: data.name_ko || '',
                    name_en: data.name_en || '',
                    country: data.country || '',
                    admin_level: data.admin_level || '',
                    ad_status: data.ad_status || 'available'
                });
            });
            
            console.log(`Firestoreì—ì„œ ${firestoreDataMap.size}ê°œ ì§€ì—­ì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.`);
            
            // 2. ëª¨ë“  êµ­ê°€ì˜ ë°ì´í„°ë¥¼ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¡œë“œ (ì§€ë„ì— í‘œì‹œí•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ë§Œ ìˆ˜ì§‘)
            this.showNotification('ëª¨ë“  êµ­ê°€ì˜ í–‰ì •êµ¬ì—­ ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ëŠ” ì¤‘...', 'info');
            await this.loadAllCountriesDataForSync();
            
            // 3. ì§€ë„ ì†ŒìŠ¤ì—ì„œ ëª¨ë“  ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘ (ëª¨ë“  êµ­ê°€ í¬í•¨)
            const collectedCount = this.collectAllRegionsFromMapSources();
            console.log(`ì§€ë„ ì†ŒìŠ¤ì—ì„œ ${collectedCount}ê°œ ìƒˆë¡œìš´ ì§€ì—­ì„ ìˆ˜ì§‘í–ˆìŠµë‹ˆë‹¤.`);
            
            // 4. Firestore ë°ì´í„°ì™€ ì§€ë„ ì†ŒìŠ¤ ë°ì´í„° ë³‘í•© (Firestore ì¸êµ¬/ë©´ì  ë°ì´í„° ìš°ì„ )
            let mergeCount = 0;
            this.regionData.forEach((regionData, regionId) => {
                const firestoreData = firestoreDataMap.get(regionId);
                if (firestoreData) {
                    // Firestoreì— ì €ì¥ëœ ì¸êµ¬/ë©´ì  ë°ì´í„°ê°€ ìˆìœ¼ë©´ ìœ ì§€
                    if (firestoreData.population > 0) {
                        regionData.population = firestoreData.population;
                    }
                    if (firestoreData.area > 0) {
                        regionData.area = firestoreData.area;
                    }
                    // ê¸°íƒ€ í•„ë“œë„ Firestore ë°ì´í„° ìš°ì„ 
                    if (firestoreData.name_ko) regionData.name_ko = firestoreData.name_ko;
                    if (firestoreData.name_en) regionData.name_en = firestoreData.name_en;
                    if (firestoreData.country) regionData.country = firestoreData.country;
                    if (firestoreData.admin_level) regionData.admin_level = firestoreData.admin_level;
                    if (firestoreData.ad_status) regionData.ad_status = firestoreData.ad_status;
                    mergeCount++;
                }
                
                // 5. ëª¨ë“  ì§€ì—­ ê°€ê²©ì„ 1000ë‹¬ëŸ¬ë¡œ í†µì¼
                regionData.ad_price = this.uniformAdPrice || 1000;
                this.regionData.set(regionId, regionData);
            });
            
            console.log(`${mergeCount}ê°œ ì§€ì—­ì˜ Firestore ë°ì´í„°ë¥¼ ë³‘í•©í–ˆìŠµë‹ˆë‹¤. ì´ ${this.regionData.size}ê°œ ì§€ì—­ì´ ìˆìŠµë‹ˆë‹¤.`);
            
            // 6. ì§€ë„ ì†ŒìŠ¤ ì—…ë°ì´íŠ¸
            this.updateMapSourcesWithRegionData();
            
            // 7. ëª¨ë“  ì§€ì—­ ë°ì´í„°ë¥¼ Firestoreì— ì €ì¥
            const result = await this.saveAllRegionsToFirestore();
            
            return { 
                ...result, 
                priceUpdated: this.regionData.size,
                merged: mergeCount 
            };
        } catch (error) {
            console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
            this.showNotification('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            return { success: 0, failed: 0, collected: 0, priceUpdated: 0 };
        }
    }

    // ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ë™ê¸°í™”ìš©ìœ¼ë¡œ ë¡œë“œ (ì§€ë„ì— í‘œì‹œí•˜ì§€ ì•Šê³  ë©”ëª¨ë¦¬ì—ë§Œ ìˆ˜ì§‘)
    async loadAllCountriesDataForSync() {
        if (!this.map) {
            console.warn('ì§€ë„ê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }

        const loadFunctions = [
            () => this.loadWorldData(),
            () => this.loadKoreaData(),
            () => this.loadJapanData(),
            () => this.loadChinaData(),
            () => this.loadRussiaData(),
            () => this.loadIndiaData(),
            () => this.loadCanadaData(),
            () => this.loadGermanyData(),
            () => this.loadUKData(),
            () => this.loadFranceData(),
            () => this.loadItalyData(),
            () => this.loadBrazilData(),
            () => this.loadAustraliaData(),
            () => this.loadMexicoData(),
            () => this.loadIndonesiaData(),
            () => this.loadSaudiArabiaData(),
            () => this.loadTurkeyData(),
            () => this.loadSouthAfricaData(),
            () => this.loadArgentinaData(),
            () => this.loadEuropeanUnionData(),
            () => this.loadSpainData(),
            () => this.loadNetherlandsData(),
            () => this.loadPolandData(),
            () => this.loadBelgiumData(),
            () => this.loadSwedenData(),
            () => this.loadAustriaData(),
            () => this.loadDenmarkData(),
            () => this.loadFinlandData(),
            () => this.loadIrelandData(),
            () => this.loadPortugalData(),
            () => this.loadGreeceData(),
            () => this.loadCzechRepublicData(),
            () => this.loadRomaniaData(),
            () => this.loadHungaryData(),
            () => this.loadBulgariaData()
        ];

        // ëª¨ë“  êµ­ê°€ ë°ì´í„°ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ë¡œë“œ (ì—ëŸ¬ê°€ ë‚˜ë„ ê³„ì† ì§„í–‰)
        let loadedCount = 0;
        for (const loadFn of loadFunctions) {
            try {
                await loadFn();
                loadedCount++;
                console.log(`êµ­ê°€ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${loadedCount}/${loadFunctions.length}`);
            } catch (error) {
                console.warn('êµ­ê°€ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜ (ê³„ì† ì§„í–‰):', error);
            }
        }

        console.log(`ì´ ${loadedCount}ê°œ êµ­ê°€ì˜ ë°ì´í„°ë¥¼ ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
    }

    // ì‚¬ìš©ì ë¡œê·¸ì¸ (ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸)
    async loginUser(email, password) {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const { signInWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await signInWithEmailAndPassword(this.firebaseAuth, email, password);
            this.showNotification('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            this.updateUserUI();
            this.hideUserLoginModal();
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ì— PayPal ë²„íŠ¼ ìë™ ë Œë”ë§
            if (this.currentRegion) {
                this.autoRenderPayPalButtons();
            }
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            const errorMsg = error.code === 'auth/user-not-found' ? 'ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì…ë‹ˆë‹¤.' 
                : error.code === 'auth/wrong-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤.'
                : 'ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ í™•ì¸í•˜ì„¸ìš”.';
            this.showNotification(errorMsg, 'error');
        }
    }

    // ì‚¬ìš©ì íšŒì›ê°€ì…
    async signUpUser(email, password) {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        try {
            const { createUserWithEmailAndPassword } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await createUserWithEmailAndPassword(this.firebaseAuth, email, password);
            this.showNotification('íšŒì›ê°€ì… ì„±ê³µ!', 'success');
            this.updateUserUI();
        } catch (error) {
            console.error('íšŒì›ê°€ì… ì˜¤ë¥˜:', error);
            const errorMsg = error.code === 'auth/email-already-in-use' ? 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.'
                : error.code === 'auth/weak-password' ? 'ë¹„ë°€ë²ˆí˜¸ê°€ ë„ˆë¬´ ì•½í•©ë‹ˆë‹¤. (ìµœì†Œ 6ì)'
                : 'íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            this.showNotification(errorMsg, 'error');
        }
    }
    
    // êµ¬ê¸€ ë¡œê·¸ì¸/íšŒì›ê°€ì…
    async signInWithGoogle() {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            this.showNotification('Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. Firebase ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”. index.htmlì—ì„œ firebaseConfigë¥¼ ì—…ë°ì´íŠ¸í•´ì•¼ í•©ë‹ˆë‹¤.', 'error');
            console.error('Firebase ì´ˆê¸°í™” ìƒíƒœ:', {
                isFirebaseInitialized: this.isFirebaseInitialized,
                firebaseAuth: this.firebaseAuth,
                firebaseConfig: window.firebaseModules?.firebaseConfig
            });
            return;
        }

        try {
            const { GoogleAuthProvider, signInWithPopup } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            const provider = new GoogleAuthProvider();
            const result = await signInWithPopup(this.firebaseAuth, provider);
            
            // ë¡œê·¸ì¸ ì„±ê³µ
            this.currentUser = result.user;
            this.updateUserUI();
            this.hideUserLoginModal();
            this.showNotification('êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
            console.log('êµ¬ê¸€ ë¡œê·¸ì¸ ì„±ê³µ:', result.user.email);
            // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ì— PayPal ë²„íŠ¼ ìë™ ë Œë”ë§
            if (this.currentRegion) {
                this.autoRenderPayPalButtons();
            }
        } catch (error) {
            console.error('êµ¬ê¸€ ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
            const errorMsg = error.code === 'auth/popup-closed-by-user' ? 'ë¡œê·¸ì¸ ì°½ì´ ë‹«í˜”ìŠµë‹ˆë‹¤.'
                : error.code === 'auth/popup-blocked' ? 'íŒì—…ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.'
                : 'êµ¬ê¸€ ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
            this.showNotification(errorMsg, 'error');
        }
    }

    // ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ
    async logoutUser() {
        if (!this.isFirebaseInitialized || !this.firebaseAuth) {
            return;
        }

        try {
            const { signOut } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js');
            await signOut(this.firebaseAuth);
            this.showNotification('ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
            this.updateUserUI();
        } catch (error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
        }
    }

    async initializeMap() {
        // MapLibre GL JS ì´ˆê¸°í™” (ë¬´ë£Œ ì˜¤í”ˆì†ŒìŠ¤ ë²„ì „ ì‚¬ìš©)
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';
        
        // 3D ì§€êµ¬ë³¸ ëª¨ë“œ í™œì„±í™” (ê¸°ë³¸ê°’)
        this.isGlobeMode = true;
        
        this.map = new mapboxgl.Map({
            container: 'map',
            style: {
                version: 8,
                glyphs: 'mapbox://fonts/mapbox/{fontstack}/{range}.pbf',
                sources: {
                    'raster-tiles': {
                        type: 'raster',
                        tiles: [
                            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                        ],
                        tileSize: 256,
                        wrapX: true, // ì§€êµ¬ë³¸ì´ë¼ ì–‘ìª½ ë ì—°ê²°
                        attribution: 'Â© Esri'
                    }
                },
                layers: [
                    {
                        id: 'background',
                        type: 'raster',
                        source: 'raster-tiles',
                        paint: {
                            'raster-opacity': 1,
                            'raster-brightness-min': 0.5,   // ì°¨ë¶„í•œ ë°ê¸° (ì•¼ê´‘ íš¨ê³¼ ì œê±°)
                            'raster-brightness-max': 0.85,  // ìµœëŒ€ ë°ê¸°ë„ ë‚®ì¶¤
                            'raster-saturation': 0.65,      // ì‹¤ì œ ìœ„ì„± ì§€ë„ì²˜ëŸ¼ ë‚®ì€ ì±„ë„
                            'raster-contrast': 0.35,        // ì„ ëª…í•œ ëŒ€ë¹„ë¡œ ì‹¤ì œ ì§€ë„ì²˜ëŸ¼
                            'raster-hue-rotate': -5,          // ì•½ê°„ ë”°ëœ»í•œ í†¤ (êµ¬ê¸€ ì–´ìŠ¤ ìŠ¤íƒ€ì¼)
                            'raster-resampling': 'linear'    // ë¶€ë“œëŸ¬ìš´ ë Œë”ë§
                        }
                    }
                ],
                // ëŒ€ê¸° ë° ì¡°ëª… íš¨ê³¼ (êµ¬ê¸€ì–´ìŠ¤/nullschool ìŠ¤íƒ€ì¼)
                lights: [
                    {
                        id: 'sun-light',
                        type: 'directional',
                        anchor: 'viewport',
                        color: '#ffffff',
                        intensity: 0.4,
                        position: [0.3, 0.3, 1.2]
                    }
                ],
                sky: {
                    'sky-type': 'atmosphere',
                    'sky-atmosphere-sun': [0.0, 0.0],
                    'sky-atmosphere-sun-intensity': 12, // ì°¨ë¶„í•œ íƒœì–‘ ê°•ë„
                    'sky-atmosphere-color': [
                        'interpolate',
                        ['linear'],
                        ['sky-radial-progress'],
                        0.0, '#6BA8D6',  // ì§€í‰ì„  ê·¼ì²˜ëŠ” ì°¨ë¶„í•œ í•˜ëŠ˜ìƒ‰
                        0.3, '#4A6FA5',  // ì¤‘ê°„ì€ ì°¨ë¶„í•œ íŒŒë€ìƒ‰
                        0.7, '#2A3D5C',  // ë” ì§„í•œ ë‚¨ìƒ‰
                        1.0, '#0a0a1a'   // ìš°ì£¼ëŠ” ì–´ë‘ìš´ ë‚¨ìƒ‰
                    ],
                    'sky-atmosphere-halo-color': '#ffffff',
                    'sky-atmosphere-space-color': '#0a0a1a',
                    'sky-atmosphere-star-intensity': 0.5,
                    'sky-atmosphere-fog-density': 0.08, // ì•½ê°„ ë” ë‘êº¼ìš´ ëŒ€ê¸° (ìì—°ìŠ¤ëŸ¬ìš´ ëŠë‚Œ)
                    'sky-atmosphere-fog-height': 0.25 // ëŒ€ê¸° ë†’ì´ ì¦ê°€
                }
            },
            center: [0, 0], // ì§€êµ¬ë³¸ ì¤‘ì•™ìœ¼ë¡œ ì´ˆê¸°í™”
            zoom: 1.5, // ì „ì²´ ì§€êµ¬ë³¸ì´ ë³´ì´ë„ë¡ ì¤Œ ë ˆë²¨ ì¡°ì •
            maxZoom: 20, // ë” ë§ì´ í™•ëŒ€ ê°€ëŠ¥
            minZoom: 0.5, // ë” ë§ì´ ì¶•ì†Œ ê°€ëŠ¥ (ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸°)
            // ë¶€ë“œëŸ¬ìš´ ì¤Œ ì• ë‹ˆë©”ì´ì…˜
            transition: {
                duration: 400,
                delay: 0
            },
            // ì§€êµ¬ë³¸ ë Œë”ë§ ì˜µì…˜
            antialias: true,
            preserveDrawingBuffer: true,
            fadeDuration: 300,
            // 3D ì§€êµ¬ë³¸ ëª¨ë“œ í™œì„±í™”
            projection: 'globe',
            // ì´ˆê¸° ì‹œì•¼ê° ì„¤ì • (ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸°)
            pitch: 0,
            bearing: 0,
            // 2D ëª¨ë“œì—ì„œ ì„¸ê³„ì§€ë„ í•œ ë²ˆë§Œ í‘œì‹œ (3D ëª¨ë“œì—ëŠ” ì˜í–¥ ì—†ìŒ)
            renderWorldCopies: false
        });
        
        // ì§€ë„ ë¡œë“œ ì™„ë£Œ ëŒ€ê¸°
        return new Promise((resolve) => {
            this.map.on('load', () => {
                console.log('ì§€ë„ ë¡œë“œ ì™„ë£Œ');
                
                // 3D ì§€êµ¬ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
                this.setupGlobeStyle();
                
                // ì¤Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ë¡œê³  í¬ê¸° ì¡°ì ˆìš©) - ìµœì í™”ëœ ë²„ì „
                this.map.on('zoomend', () => {
                    this.updateAllLogoSizes();
                });
                
                this.map.on('moveend', () => {
                    this.updateAllLogoSizes();
                });
                
                // 2D ëª¨ë“œì—ì„œ ìµœì†Œ ì¤Œ ì œí•œ (ì„¸ê³„ì§€ë„ê°€ ì—¬ëŸ¬ ë²ˆ ë³´ì´ì§€ ì•Šë„ë¡)
                this.map.on('zoom', () => {
                    if (!this.isGlobeMode && this.map.getZoom() < 1.5) {
                        this.map.setZoom(1.5);
                    }
                });
                
                // ì§€ë„ ë¡œë“œ í›„ ì´ˆê¸° ì¤Œ ì„¤ì • ë³´ì¥
                setTimeout(() => {
                    if (this.isGlobeMode) {
                        this.map.easeTo({
                            center: [0, 0],
                            zoom: 1.5,
                            pitch: 0,
                            duration: 1000
                        });
                    }
                }, 100);
                
                resolve();
            });
        });
    }
    
    async loadGlobalAdministrativeRegions() {
        try {
            this.showNotification('ì „ ì„¸ê³„ í–‰ì •êµ¬ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...', 'info');
            this.regionData.clear();
            this.globalRegionIdSet.clear();
            
            const configs = this.getGlobalCountryConfigs();
            const aggregatedFeatures = [];
            
            for (const config of configs) {
                try {
                    const geoJsonData = await this.fetchCountryGeoJson(
                        config.key,
                        config.displayName,
                        config.iso3,
                        config.candidateUrls || []
                    );
                    const processedFeatures = this.processCountryFeatures(config, geoJsonData);
                    aggregatedFeatures.push(...processedFeatures);
                } catch (error) {
                    console.warn(`[GlobalRegions] ${config.displayName} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
                }
            }
            
            if (aggregatedFeatures.length === 0) {
                throw new Error('ì „ ì„¸ê³„ í–‰ì •êµ¬ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            }
            
            this.globalRegionsGeoJson = {
                type: 'FeatureCollection',
                features: aggregatedFeatures
            };
            
            this.ensureGlobalRegionLayers(this.globalRegionsGeoJson);
            this.collectAllRegionsFromMapSources();
            this.updateStatistics();
            
            this.showNotification(`ì´ ${aggregatedFeatures.length}ê°œ í–‰ì •êµ¬ì—­ ë¡œë“œ ì™„ë£Œ`, 'success');
        } catch (error) {
            console.error('ì „ ì„¸ê³„ í–‰ì •êµ¬ì—­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì „ ì„¸ê³„ í–‰ì •êµ¬ì—­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            throw error;
        }
    }
    
    getGlobalCountryConfigs() {
        // êµ­ê°€ë³„ ê³ ìœ  ìƒ‰ìƒ ë§µ (ë” ëª…í™•í•œ êµ¬ë¶„ì„ ìœ„í•´ ë‹¤ì–‘í•œ ìƒ‰ìƒ ì‚¬ìš©)
        return [
            { key: 'usa', displayName: 'United States', iso3: 'USA', adminLevel: 'State', basePrice: 1500, baseColor: '#4ecdc4' }, // ì²­ë¡ìƒ‰
            { key: 'korea', displayName: 'South Korea', iso3: 'KOR', adminLevel: 'Province/City', basePrice: 2000, baseColor: '#ff6b9d' }, // í•‘í¬
            { key: 'japan', displayName: 'Japan', iso3: 'JPN', adminLevel: 'Prefecture', basePrice: 1900, baseColor: '#a29bfe' }, // ë³´ë¼ìƒ‰
            { key: 'china', displayName: 'China', iso3: 'CHN', adminLevel: 'Province', basePrice: 2100, baseColor: '#ff6b6b' }, // ë¹¨ê°„ìƒ‰
            { key: 'india', displayName: 'India', iso3: 'IND', adminLevel: 'State', basePrice: 1600, baseColor: '#10ac84' }, // ë…¹ìƒ‰
            { key: 'russia', displayName: 'Russia', iso3: 'RUS', adminLevel: 'Federal Subject', basePrice: 1800, baseColor: '#54a0ff' }, // íŒŒë€ìƒ‰
            { key: 'canada', displayName: 'Canada', iso3: 'CAN', adminLevel: 'Province', basePrice: 1700, baseColor: '#1dd1a1' }, // ë¯¼íŠ¸ìƒ‰
            { key: 'germany', displayName: 'Germany', iso3: 'DEU', adminLevel: 'State', basePrice: 1800, baseColor: '#ff9ff3' }, // ë¶„í™ìƒ‰
            { key: 'uk', displayName: 'United Kingdom', iso3: 'GBR', adminLevel: 'Region', basePrice: 1700, baseColor: '#48dbfb' }, // í•˜ëŠ˜ìƒ‰
            { key: 'france', displayName: 'France', iso3: 'FRA', adminLevel: 'Region', basePrice: 1750, baseColor: '#feca57' }, // ë…¸ë€ìƒ‰
            { key: 'italy', displayName: 'Italy', iso3: 'ITA', adminLevel: 'Region', basePrice: 1650, baseColor: '#ff9f43' }, // ì£¼í™©ìƒ‰
            { key: 'brazil', displayName: 'Brazil', iso3: 'BRA', adminLevel: 'State', basePrice: 1500, baseColor: '#1dd1a1' }, // ë¯¼íŠ¸ìƒ‰
            { key: 'australia', displayName: 'Australia', iso3: 'AUS', adminLevel: 'State', basePrice: 1500, baseColor: '#54a0ff' }, // íŒŒë€ìƒ‰
            { key: 'mexico', displayName: 'Mexico', iso3: 'MEX', adminLevel: 'State', basePrice: 1400, baseColor: '#8395a7' }, // íšŒìƒ‰
            { key: 'indonesia', displayName: 'Indonesia', iso3: 'IDN', adminLevel: 'Province', basePrice: 1350, baseColor: '#ee5253' }, // ì§„í•œ ë¹¨ê°„ìƒ‰
            { key: 'saudi-arabia', displayName: 'Saudi Arabia', iso3: 'SAU', adminLevel: 'Province', basePrice: 1650, baseColor: '#576574' }, // ì–´ë‘ìš´ íšŒìƒ‰
            { key: 'turkey', displayName: 'Turkey', iso3: 'TUR', adminLevel: 'Province', basePrice: 1500, baseColor: '#ff9f43' }, // ì£¼í™©ìƒ‰
            { key: 'south-africa', displayName: 'South Africa', iso3: 'ZAF', adminLevel: 'Province', basePrice: 1300, baseColor: '#222f3e' }, // ë§¤ìš° ì–´ë‘ìš´ íšŒìƒ‰
            { key: 'argentina', displayName: 'Argentina', iso3: 'ARG', adminLevel: 'Province', basePrice: 1400, baseColor: '#48dbfb' }, // í•˜ëŠ˜ìƒ‰
            { key: 'spain', displayName: 'Spain', iso3: 'ESP', adminLevel: 'Autonomous Community', basePrice: 1600, baseColor: '#f368e0' }, // ìí™ìƒ‰
            { key: 'netherlands', displayName: 'Netherlands', iso3: 'NLD', adminLevel: 'Province', basePrice: 1550, baseColor: '#00d2d3' } // ì²­ë¡ìƒ‰
        ];
    }
    
    processCountryFeatures(config, geoJsonData) {
        if (!geoJsonData || !Array.isArray(geoJsonData.features)) {
            return [];
        }
        
        const processed = [];
        
        geoJsonData.features.forEach((feature, index) => {
            if (!feature || !feature.geometry) {
                return;
            }
            
            const props = feature.properties || {};
            const rawName = props.name || props.NAME_1 || props.NAME || props.admin || `Region_${index + 1}`;
            const englishName = rawName;
            const normalizedIdBase = this.normalizeRegionKey(`${config.key}_${rawName}`) || `${config.key}_region_${index + 1}`;
            const regionId = this.ensureUniqueGlobalRegionId(normalizedIdBase);
            
            const population = this.extractPopulationValue(props);
            const area = this.extractAreaValue(props);
            const adPrice = this.calculateRegionPrice(area, population, config.basePrice);
            
            const regionProps = {
                ...props,
                id: regionId,
                name: englishName,
                name_en: englishName,
                name_local: props.name_local || englishName,
                name_ko: props.name_ko || englishName,
                country: config.displayName,
                country_code: config.iso3.substring(0, 2).toUpperCase(),
                admin_level: config.adminLevel,
                population,
                area,
                ad_price: adPrice,
                ad_status: props.ad_status || (props.occupied ? 'occupied' : 'available'),
                color: props.color || config.baseColor || '#4ecdc4',
                border_color: props.border_color || '#ffffff',
                border_width: props.border_width || 1,
                base_country: config.key
            };
            
            feature.properties = regionProps;
            this.regionData.set(regionId, regionProps);
            processed.push(feature);
        });
        
        return processed;
    }
    
    ensureGlobalRegionLayers(geoJsonData) {
        if (this.map.getSource('world-regions')) {
            this.map.getSource('world-regions').setData(geoJsonData);
        } else {
            this.map.addSource('world-regions', {
                type: 'geojson',
                data: geoJsonData
            });
        }
        
        if (!this.map.getLayer('regions-fill')) {
            this.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': [
                        'case',
                        // ë‚™ì°°/ì ìœ  ìƒíƒœ - ë¹¨ê°„ìƒ‰
                        ['==', ['get', 'ad_status'], 'occupied'],
                        '#ff6b6b',
                        // ë³´í˜¸ ì¤‘ - ë…¸ë€ìƒ‰ (ê¹œë¹¡ì´ëŠ” íš¨ê³¼ë¥¼ ìœ„í•œ ë°ì€ ë…¸ë€ìƒ‰)
                        ['==', ['get', 'auction_status'], 'protected'],
                        '#ffd93d',
                        // ì…ì°° ì¤‘ - ì£¼í™©ìƒ‰
                        ['==', ['get', 'auction_status'], 'bidding'],
                        '#ff9f43',
                        // ì˜¥ì…˜ ì§„í–‰ ì¤‘ (ê¸°ë³¸) - ë…¸ë€ìƒ‰
                        ['==', ['get', 'ad_status'], 'auction'],
                        '#feca57',
                        // ì‚¬ìš© ê°€ëŠ¥ - ê¸°ë³¸ ìƒ‰ìƒ
                        ['coalesce', ['get', 'color'], '#4ecdc4']
                    ],
                    'fill-opacity': 0.7
                }
            });
            
            this.map.addLayer({
                id: 'regions-border',
                type: 'line',
                source: 'world-regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        0, 0.5,
                        5, 1,
                        10, 1.5
                    ],
                    'line-opacity': 0.9
                }
            });
            
            this.map.addLayer({
                id: 'regions-hover',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': '#feca57',
                    'fill-opacity': 0
                }
            });
            
            // ê²½í•© ìƒíƒœ ì•„ì´ì½˜ ë ˆì´ì–´ ì¶”ê°€
            this.map.addLayer({
                id: 'auction-status-icons',
                type: 'symbol',
                source: 'world-regions',
                layout: {
                    'text-field': [
                        'case',
                        ['==', ['get', 'auction_status'], 'protected'],
                        'ğŸ›¡ï¸',
                        ['==', ['get', 'auction_status'], 'bidding'],
                        'âš¡',
                        ['==', ['get', 'ad_status'], 'occupied'],
                        'âœ…',
                        ''
                    ],
                    'text-size': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        3, 12,
                        6, 16,
                        10, 20
                    ],
                    'text-anchor': 'center',
                    'text-allow-overlap': true,
                    'text-ignore-placement': true
                },
                paint: {
                    'text-color': [
                        'case',
                        ['==', ['get', 'auction_status'], 'protected'],
                        '#ffd93d',
                        ['==', ['get', 'auction_status'], 'bidding'],
                        '#ff9f43',
                        ['==', ['get', 'ad_status'], 'occupied'],
                        '#ff6b6b',
                        '#4ecdc4'
                    ],
                    'text-opacity': [
                        'case',
                        ['==', ['get', 'auction_status'], 'protected'],
                        0.9,
                        ['==', ['get', 'auction_status'], 'bidding'],
                        0.9,
                        ['==', ['get', 'ad_status'], 'occupied'],
                        0.8,
                        0
                    ]
                },
                filter: [
                    'any',
                    ['==', ['get', 'auction_status'], 'protected'],
                    ['==', ['get', 'auction_status'], 'bidding'],
                    ['==', ['get', 'ad_status'], 'occupied']
                ]
            });
            
            if (!this.eventListenersAdded) {
                this.setupEventListeners();
                this.eventListenersAdded = true;
            }
        }
    }
    
    ensureUniqueGlobalRegionId(baseId) {
        let finalId = baseId || `region_${this.globalRegionIdSet.size + 1}`;
        let duplicateIndex = 1;
        while (this.globalRegionIdSet.has(finalId)) {
            finalId = `${baseId}_${duplicateIndex++}`;
        }
        this.globalRegionIdSet.add(finalId);
        return finalId;
    }
    
    extractPopulationValue(props = {}) {
        const candidates = [
            props.population,
            props.POPULATION,
            props.POP_EST,
            props.pop_est,
            props.pop,
            props.Population
        ];
        const population = candidates.find(value => typeof value === 'number' && value > 0);
        if (population) return Math.round(population);
        return Math.floor(Math.random() * 7000000) + 300000;
    }
    
    extractAreaValue(props = {}) {
        const candidates = [
            props.area,
            props.AREA,
            props.Shape_Area,
            props.shape_area,
            props.geom_area
        ];
        const area = candidates.find(value => typeof value === 'number' && value > 0);
        if (area) return Math.round(area);
        return Math.floor(Math.random() * 250000) + 5000;
    }
    
    calculateRegionPrice(area, population, basePrice = 1000) {
        const areaScore = Math.log(Math.max(area, 1) + 1);
        const populationScore = Math.log(Math.max(population, 1) + 1);
        const weightedScore = (areaScore * 0.6) + (populationScore * 0.4);
        const rawPrice = basePrice * weightedScore;
        const rounded = Math.round(rawPrice / 100) * 100;
        return Math.max(basePrice, rounded);
    }
    
    async loadWorldData() {
        try {
            let geoJsonData;
            
            // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            if (this.cachedGeoJsonData['usa']) {
                geoJsonData = this.cachedGeoJsonData['usa'];
            } else {
                // ì‹¤ì œ ë¯¸êµ­ ì£¼ ê²½ê³„ì„  ë°ì´í„°ë¥¼ ê³µê°œ APIì—ì„œ ë¡œë“œ
                try {
                    const response = await fetch('https://raw.githubusercontent.com/PublicaMundi/MappingAPI/master/data/geojson/us-states.json');
                    geoJsonData = await response.json();
                } catch (error) {
                    console.error('API ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    const localResponse = await fetch('data/us-states.geojson');
                    geoJsonData = await localResponse.json();
                }
                
                // ë¯¸êµ­ ì£¼ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const usaStateData = {
                    'California': { population: 39029000, area: 423967 },
                    'Texas': { population: 30503000, area: 695662 },
                    'Florida': { population: 22610000, area: 170312 },
                    'New York': { population: 19677000, area: 141297 },
                    'Pennsylvania': { population: 12982000, area: 119280 },
                    'Illinois': { population: 12480000, area: 149995 },
                    'Ohio': { population: 11792000, area: 116098 },
                    'Georgia': { population: 11029000, area: 153910 },
                    'North Carolina': { population: 10855000, area: 139391 },
                    'Michigan': { population: 10270000, area: 250487 },
                    'New Jersey': { population: 9255000, area: 22591 },
                    'Virginia': { population: 8717000, area: 110787 },
                    'Washington': { population: 7999000, area: 184661 },
                    'Arizona': { population: 7636000, area: 295234 },
                    'Tennessee': { population: 7222000, area: 109153 },
                    'Indiana': { population: 6864000, area: 94326 },
                    'Massachusetts': { population: 6992000, area: 27336 },
                    'Missouri': { population: 6168000, area: 180540 },
                    'Maryland': { population: 6247000, area: 32131 },
                    'Wisconsin': { population: 5944000, area: 169635 },
                    'Colorado': { population: 5979000, area: 269601 },
                    'Minnesota': { population: 5773000, area: 225163 },
                    'South Carolina': { population: 5437000, area: 82933 },
                    'Alabama': { population: 5154000, area: 135767 },
                    'Louisiana': { population: 4554000, area: 135659 },
                    'Kentucky': { population: 4525000, area: 104656 },
                    'Oregon': { population: 4325000, area: 254800 },
                    'Oklahoma': { population: 4050000, area: 181037 },
                    'Connecticut': { population: 3625000, area: 14357 },
                    'Utah': { population: 3497000, area: 219882 },
                    'Iowa': { population: 3223000, area: 145746 },
                    'Nevada': { population: 3195000, area: 286380 },
                    'Arkansas': { population: 3086000, area: 137732 },
                    'Mississippi': { population: 2931000, area: 125438 },
                    'Kansas': { population: 2942000, area: 213100 },
                    'New Mexico': { population: 2119000, area: 314917 },
                    'Nebraska': { population: 1979000, area: 200330 },
                    'Idaho': { population: 1967000, area: 216443 },
                    'West Virginia': { population: 1775000, area: 62756 },
                    'Hawaii': { population: 1417000, area: 28311 },
                    'Maine': { population: 1396000, area: 91633 },
                    'New Hampshire': { population: 1395000, area: 24214 },
                    'Montana': { population: 1142000, area: 380831 },
                    'Rhode Island': { population: 1100000, area: 4001 },
                    'Delaware': { population: 1018000, area: 6446 },
                    'South Dakota': { population: 919000, area: 199729 },
                    'North Dakota': { population: 784000, area: 183108 },
                    'Alaska': { population: 734000, area: 1723337 },
                    'Vermont': { population: 650000, area: 24906 },
                    'Wyoming': { population: 583000, area: 253335 }
                };
                
                // ê° ì£¼ì— ê´‘ê³  ì •ë³´ ì¶”ê°€
                geoJsonData.features.forEach((feature, index) => {
                    const props = feature.properties;
                    const stateName = props.name;
                    const stateId = stateName.toLowerCase().replace(/\s+/g, '_');
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const stateData = usaStateData[stateName] || { 
                        population: Math.floor(Math.random() * 10000000) + 1000000, 
                        area: Math.floor(Math.random() * 500000) + 50000 
                    };
                    
                    feature.properties = {
                        ...props,
                        id: stateId,
                        name_en: stateName,
                        name_ko: this.getKoreanStateName(stateName),
                        country: 'USA',
                        country_code: 'US',
                        admin_level: 'State',
                        population: stateData.population,
                        area: stateData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#4ecdc4',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    
                    // regionDataì— ì €ì¥
                    this.regionData.set(stateId, feature.properties);
                });
                
                // ìºì‹œì— ì €ì¥
                this.cachedGeoJsonData['usa'] = geoJsonData;
            }
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (ë” ë¹ ë¦„)
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                // ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                this.map.addSource('world-regions', {
                    type: 'geojson',
                    data: geoJsonData
                });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            '#4ecdc4'
                        ],
                        'fill-opacity': 0.7  // ì§€êµ¬ë³¸ì—ì„œ ë” ì„ ëª…í•˜ê²Œ ë³´ì´ë„ë¡ ì¦ê°€
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': [
                            'interpolate',
                            ['linear'],
                            ['zoom'],
                            0, 0.5,
                            5, 1,
                            10, 1.5
                        ],
                        'line-opacity': 0.9
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    }
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•œ ë²ˆë§Œ ì¶”ê°€
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ë¯¸êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            
            // ì´ˆê¸° í†µê³„ ì—…ë°ì´íŠ¸
            this.updateStatistics();
        } catch (error) {
            console.error('ë¯¸êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë¯¸êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // 3D ì§€êµ¬ë³¸ ìŠ¤íƒ€ì¼ ì„¤ì •
    setupGlobeStyle() {
        if (!this.isGlobeMode) return;
        
        // êµ¬ë¦„ íš¨ê³¼ ì¶”ê°€
        this.addCloudLayer();
        
        // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
        this.startCloudAnimation();
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ë™ì  ìƒ‰ìƒ ì¡°ì • (êµ¬ê¸€ ì–´ìŠ¤ì²˜ëŸ¼)
        this.setupDynamicColorAdjustment();
        
        console.log('3D ì§€êµ¬ë³¸ ëª¨ë“œ í™œì„±í™” (êµ¬ë¦„ íš¨ê³¼ í¬í•¨, ì°¨ë¶„í•œ ìœ„ì„± ì§€ë„ ìŠ¤íƒ€ì¼)');
    }
    
    // ë™ì  ìƒ‰ìƒ ì¡°ì • ì„¤ì • (ì¤Œ ë ˆë²¨ì— ë”°ë¼)
    setupDynamicColorAdjustment() {
        if (!this.map || !this.map.getLayer('background')) return;
        if (this.dynamicColorSetup) return; // ì´ë¯¸ ì„¤ì •ë˜ì—ˆìœ¼ë©´ ë°˜í™˜
        
        // ì´ˆê¸° ì„¤ì • ì ìš©
        this.updateGlobeColorsByZoom();
        
        // ì¤Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (í•œ ë²ˆë§Œ)
        this.map.on('zoom', () => {
            this.updateGlobeColorsByZoom();
        });
        
        this.dynamicColorSetup = true;
    }
    
    // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ì§€êµ¬ë³¸ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
    updateGlobeColorsByZoom() {
        if (!this.map || !this.map.getLayer('background')) return;
        
        const zoom = this.map.getZoom();
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¼ ë°ê¸°, ì±„ë„, ëŒ€ë¹„ ì¡°ì •
        let brightnessMin, saturation, contrast;
        
        if (zoom < 2) {
            // ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸° - ë§¤ìš° ì°¨ë¶„í•˜ê²Œ
            brightnessMin = 0.45;
            saturation = 0.6;
            contrast = 0.3;
        } else if (zoom < 5) {
            // ëŒ€ë¥™ ì „ì²´ ë³´ê¸° - ì°¨ë¶„í•˜ê²Œ
            brightnessMin = 0.5;
            saturation = 0.65;
            contrast = 0.35;
        } else if (zoom < 10) {
            // êµ­ê°€/ì§€ì—­ ë³´ê¸° - ìì—°ìŠ¤ëŸ½ê²Œ
            brightnessMin = 0.55;
            saturation = 0.7;
            contrast = 0.4;
        } else {
            // ìƒì„¸ ë³´ê¸° - ë” ì„ ëª…í•˜ê²Œ (ì‹¤ì œ ìœ„ì„± ì§€ë„ ëŠë‚Œ)
            brightnessMin = 0.6;
            saturation = 0.75;
            contrast = 0.45;
        }
        
        // ìƒ‰ìƒ ì†ì„± ì—…ë°ì´íŠ¸
        if (this.map.getPaintProperty) {
            this.map.setPaintProperty('background', 'raster-brightness-min', brightnessMin);
            this.map.setPaintProperty('background', 'raster-brightness-max', Math.min(brightnessMin + 0.3, 0.9));
            this.map.setPaintProperty('background', 'raster-saturation', saturation);
            this.map.setPaintProperty('background', 'raster-contrast', contrast);
        }
    }
    
    // êµ¬ë¦„ í…ìŠ¤ì²˜ ìƒì„±
    createCloudTexture() {
        const canvas = document.createElement('canvas');
        canvas.width = 2048;
        canvas.height = 1024;
        const ctx = canvas.getContext('2d');
        
        // ê·¸ë¼ë°ì´ì…˜ ë°°ê²½ (ë°˜íˆ¬ëª…)
        const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
        gradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
        gradient.addColorStop(0.3, 'rgba(255, 255, 255, 0.15)');
        gradient.addColorStop(0.7, 'rgba(255, 255, 255, 0.25)');
        gradient.addColorStop(1, 'rgba(255, 255, 255, 0.1)');
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ë¦„ íŒ¨í„´ ìƒì„± (ì°¨ë¶„í•œ ìƒ‰ìƒ)
        const clouds = [];
        for (let i = 0; i < 80; i++) {
            clouds.push({
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                radius: Math.random() * 150 + 80,
                opacity: Math.random() * 0.35 + 0.15  // ì•½ê°„ ë” íˆ¬ëª…í•˜ê²Œ
            });
        }
        
        // êµ¬ë¦„ ê·¸ë¦¬ê¸° (í¼ì§€ íš¨ê³¼, ì•½ê°„ íšŒìƒ‰ë¹›)
        clouds.forEach(cloud => {
            const gradient = ctx.createRadialGradient(
                cloud.x, cloud.y, 0,
                cloud.x, cloud.y, cloud.radius
            );
            // ì•½ê°„ íšŒìƒ‰ë¹› êµ¬ë¦„ (ì‹¤ì œ ìœ„ì„± ì§€ë„ì²˜ëŸ¼)
            gradient.addColorStop(0, `rgba(245, 248, 255, ${cloud.opacity})`);
            gradient.addColorStop(0.5, `rgba(235, 240, 250, ${cloud.opacity * 0.5})`);
            gradient.addColorStop(1, 'rgba(245, 248, 255, 0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(cloud.x, cloud.y, cloud.radius, 0, Math.PI * 2);
            ctx.fill();
        });
        
        // ì¶”ê°€ ìì—°ìŠ¤ëŸ¬ìš´ êµ¬ë¦„ íŒ¨í„´
        for (let i = 0; i < 40; i++) {
            const x = Math.random() * canvas.width;
            const y = Math.random() * canvas.height;
            const radius = Math.random() * 100 + 50;
            const opacity = Math.random() * 0.25 + 0.08;
            
            const gradient = ctx.createRadialGradient(x, y, 0, x, y, radius);
            // ì•½ê°„ íšŒìƒ‰ë¹› êµ¬ë¦„
            gradient.addColorStop(0, `rgba(240, 245, 252, ${opacity})`);
            gradient.addColorStop(1, 'rgba(240, 245, 252, 0)');
            
            ctx.fillStyle = gradient;
            ctx.beginPath();
            ctx.arc(x, y, radius, 0, Math.PI * 2);
            ctx.fill();
        }
        
        return canvas.toDataURL();
    }
    
    // êµ¬ë¦„ ë ˆì´ì–´ ì¶”ê°€
    addCloudLayer() {
        if (!this.map.getLayer('clouds-layer')) {
            // êµ¬ë¦„ í…ìŠ¤ì²˜ ìƒì„±
            const cloudDataUrl = this.createCloudTexture();
            
            // êµ¬ë¦„ ì´ë¯¸ì§€ ë¡œë“œ
            this.map.loadImage(cloudDataUrl, (error, image) => {
                if (error) {
                    console.error('êµ¬ë¦„ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                    return;
                }
                
                this.cloudImage = image;
                
                // êµ¬ë¦„ ì†ŒìŠ¤ ì¶”ê°€
                if (this.map.getSource('clouds')) {
                    this.map.removeSource('clouds');
                }
                
                this.map.addSource('clouds', {
                    type: 'image',
                    url: cloudDataUrl,
                    coordinates: [
                        [-180, 85], // ì¢Œìƒë‹¨
                        [180, 85],  // ìš°ìƒë‹¨
                        [180, -85], // ìš°í•˜ë‹¨
                        [-180, -85] // ì¢Œí•˜ë‹¨
                    ]
                });
                
                // êµ¬ë¦„ ë ˆì´ì–´ ì¶”ê°€
                if (!this.map.getLayer('clouds-layer')) {
                    this.map.addLayer({
                        id: 'clouds-layer',
                        type: 'raster',
                        source: 'clouds',
                        paint: {
                            'raster-opacity': [
                                'interpolate',
                                ['linear'],
                                ['zoom'],
                                0, 0.28,  // ì‘ì€ ì¤Œì—ì„œëŠ” ì•½ê°„ íˆ¬ëª… (ì°¨ë¶„í•œ ëŠë‚Œ)
                                3, 0.35,  // ì¤‘ê°„ ì¤Œì—ì„œëŠ” ìì—°ìŠ¤ëŸ½ê²Œ
                                10, 0.25  // í° ì¤Œì—ì„œëŠ” ë” íˆ¬ëª…í•˜ê²Œ
                            ],
                            'raster-resampling': 'linear',
                            'raster-fade-duration': 0
                        },
                        minzoom: 0,
                        maxzoom: 22
                    });
                }
            });
        }
    }
    
    // êµ¬ë¦„ íšŒì „ ì• ë‹ˆë©”ì´ì…˜ ì‹œì‘
    startCloudAnimation() {
        if (this.cloudAnimationId) {
            cancelAnimationFrame(this.cloudAnimationId);
        }
        
        const animate = () => {
            if (!this.isGlobeMode || !this.map || !this.map.getSource('clouds')) {
                this.cloudAnimationId = null;
                return;
            }
            
            // êµ¬ë¦„ì„ ì§€êµ¬ë³¸ë³´ë‹¤ ì¡°ê¸ˆ ëŠë¦¬ê²Œ íšŒì „ (ìì—°ìŠ¤ëŸ¬ìš´ íš¨ê³¼)
            this.cloudRotation += 0.00015;
            
            // êµ¬ë¦„ ì¢Œí‘œ ì—…ë°ì´íŠ¸ (íšŒì „ íš¨ê³¼)
            const source = this.map.getSource('clouds');
            if (source && source.setCoordinates) {
                const angle = this.cloudRotation;
                
                // ê²½ë„ ê¸°ì¤€ìœ¼ë¡œ íšŒì „ (ì§€êµ¬ë³¸ ì¶• íšŒì „ê³¼ ë™ì¼)
                const baseCoords = [
                    [-180, 85],
                    [180, 85],
                    [180, -85],
                    [-180, -85]
                ];
                
                // ê²½ë„ë¥¼ íšŒì „ì‹œì¼œ êµ¬ë¦„ ì´ë™ íš¨ê³¼ ìƒì„±
                const rotatedCoords = baseCoords.map(coord => {
                    const rotatedLng = (coord[0] + angle * 360 / (Math.PI * 2)) % 360;
                    const normalizedLng = rotatedLng > 180 ? rotatedLng - 360 : rotatedLng;
                    return [normalizedLng, coord[1]];
                });
                
                source.setCoordinates(rotatedCoords);
            }
            
            this.cloudAnimationId = requestAnimationFrame(animate);
        };
        
        animate();
    }
    
    // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€
    stopCloudAnimation() {
        if (this.cloudAnimationId) {
            cancelAnimationFrame(this.cloudAnimationId);
            this.cloudAnimationId = null;
        }
    }
    
    // 2D/3D ëª¨ë“œ ì „í™˜
    toggleGlobeMode() {
        this.isGlobeMode = !this.isGlobeMode;
        
        if (this.isGlobeMode) {
            // 3D ì§€êµ¬ë³¸ ëª¨ë“œë¡œ ì „í™˜
            this.map.setProjection('globe');
            
            // 3D ëª¨ë“œì—ì„œëŠ” ì„¸ê³„ì§€ë„ ë³µì‚¬ë³¸ì„ í™œì„±í™” (ì§€êµ¬ë³¸ í‘œì‹œìš©)
            if (this.map.setRenderWorldCopies) {
                this.map.setRenderWorldCopies(true);
            }
            
            // ì§€êµ¬ë³¸ì„ í™”ë©´ ì¤‘ì•™ì— ë°°ì¹˜ (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
            this.map.easeTo({
                center: [0, 0],
                pitch: 0, // ì „ì²´ ì§€êµ¬ë³¸ ë³´ê¸°
                zoom: 1.5,
                duration: 1500,
                easing: (t) => t * (2 - t) // ease-out ì»¤ë¸Œ
            });
            
            // ì§€êµ¬ë³¸ ìŠ¤íƒ€ì¼ ì¬ì„¤ì •
            this.setupGlobeStyle();
            
            this.showNotification('3D ì§€êµ¬ë³¸ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        } else {
            // 2D í‰ë©´ ëª¨ë“œë¡œ ì „í™˜
            this.map.setProjection('mercator');
            
            // 2D ëª¨ë“œì—ì„œ ì„¸ê³„ì§€ë„ë¥¼ í•œ ë²ˆë§Œ í‘œì‹œí•˜ë„ë¡ ì„¤ì •
            if (this.map.setRenderWorldCopies) {
                this.map.setRenderWorldCopies(false);
            }
            
            // 2D ëª¨ë“œì—ì„œ ìµœì†Œ ì¤Œ ì œí•œ (ë„ˆë¬´ ë§ì´ ì¶•ì†Œë˜ì–´ ì§€ë„ê°€ ì—¬ëŸ¬ ë²ˆ ë³´ì´ì§€ ì•Šë„ë¡)
            const currentZoom = this.map.getZoom();
            const minZoom2D = 1.5; // 2D ëª¨ë“œ ìµœì†Œ ì¤Œ ë ˆë²¨
            if (currentZoom < minZoom2D) {
                this.map.setZoom(minZoom2D);
            }
            
            // êµ¬ë¦„ ì• ë‹ˆë©”ì´ì…˜ ì¤‘ì§€ ë° ë ˆì´ì–´ ì œê±°
            this.stopCloudAnimation();
            if (this.map.getLayer('clouds-layer')) {
                this.map.removeLayer('clouds-layer');
            }
            if (this.map.getSource('clouds')) {
                this.map.removeSource('clouds');
            }
            
            // ì‹œì•¼ê° ì´ˆê¸°í™” (ë¶€ë“œëŸ¬ìš´ ì „í™˜)
            this.map.easeTo({
                pitch: 0,
                zoom: Math.max(this.map.getZoom(), minZoom2D),
                duration: 1500,
                easing: (t) => t * (2 - t) // ease-out ì»¤ë¸Œ
            });
            
            this.showNotification('2D í‰ë©´ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }
        
        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        this.updateModeButtons();
        const globeBtn = document.getElementById('globe-mode-btn');
        if (globeBtn) {
            globeBtn.innerHTML = this.isGlobeMode ? 'ğŸŒ 3D ì§€êµ¬ë³¸' : 'ğŸ—ºï¸ 2D í‰ë©´';
        }
    }
    
    // ì§€êµ¬ë³¸ ìë™ íšŒì „ (ì„ íƒì‚¬í•­)
    startGlobeRotation() {
        if (!this.isGlobeMode || this.globeRotationInterval) return;
        
        this.globeRotationInterval = setInterval(() => {
            const currentBearing = this.map.getBearing();
            this.map.setBearing(currentBearing + 0.5);
        }, 50);
    }
    
    stopGlobeRotation() {
        if (this.globeRotationInterval) {
            clearInterval(this.globeRotationInterval);
            this.globeRotationInterval = null;
        }
    }
    
    // ì§€ë„ ëª¨ë“œ ì „í™˜ ë²„íŠ¼ ì¶”ê°€
    addMapModeToggle() {
        const mapModeToggle = document.createElement('div');
        mapModeToggle.id = 'map-mode-toggle';
        mapModeToggle.className = 'map-mode-toggle';
        
        // 3D/2D í† ê¸€ ë²„íŠ¼ (ë“œë¡­ë‹¤ìš´ ì˜†ì— ë³„ë„ë¡œ ë°°ì¹˜)
        const globeBtn = document.createElement('button');
        globeBtn.id = 'globe-mode-btn';
        globeBtn.className = 'mode-btn';
        globeBtn.textContent = 'ğŸŒ 3D ì§€êµ¬ë³¸';
        
        if (this.globalViewMode) {
            const globalLabel = document.createElement('span');
            globalLabel.className = 'g20-label';
            globalLabel.textContent = 'GLOBAL';
            mapModeToggle.appendChild(globeBtn);
            mapModeToggle.appendChild(globalLabel);
            document.body.appendChild(mapModeToggle);
            globeBtn.addEventListener('click', () => {
                this.toggleGlobeMode();
            });
            return;
        }
        
        // G20 ë¼ë²¨ ìƒì„±
        const g20Label = document.createElement('span');
        g20Label.className = 'g20-label';
        g20Label.textContent = 'G20';
        
        // G20 êµ­ê°€ ë“œë¡­ë‹¤ìš´ ìƒì„±
        const countryDropdown = document.createElement('select');
        countryDropdown.id = 'country-selector-dropdown';
        countryDropdown.className = 'country-dropdown';
        
        // ê¸°ë³¸ ì„ íƒ ì˜µì…˜ ì¶”ê°€
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = 'êµ­ê°€ ì„ íƒ';
        defaultOption.selected = true;
        countryDropdown.appendChild(defaultOption);
        
        // êµ¬ë¶„ì„  ì¶”ê°€
        const separator = document.createElement('option');
        separator.disabled = true;
        separator.textContent = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';
        countryDropdown.appendChild(separator);
        
        // G20 êµ­ê°€ ì˜µì…˜ ì¶”ê°€ (í–‰ì •êµ¬ì—­ì´ êµ¬í˜„ëœ êµ­ê°€ëŠ” ì•ì—, ë‚˜ë¨¸ì§€ëŠ” ë’¤ì—)
        // ì£¼ì˜: G20 ì„¤ì •ì—ì„œëŠ” 'south-korea'ë¥¼ ì‚¬ìš©í•˜ì§€ë§Œ, ë‚´ë¶€ì ìœ¼ë¡œëŠ” 'korea'ë¥¼ ì‚¬ìš©
        const europeanCountries = [
            'spain', 'netherlands', 'poland', 'belgium', 'sweden',
            'austria', 'denmark', 'finland', 'ireland', 'portugal',
            'greece', 'czech-republic', 'romania', 'hungary', 'bulgaria'
        ];
        const implementedCountries = ['usa', 'south-korea', 'japan', 'china', 'russia', 'india', 'canada', 'germany', 'uk', 'france', 'italy', 'brazil', 'australia', 'mexico', 'indonesia', 'saudi-arabia', 'turkey', 'south-africa', 'argentina', 'european-union', ...europeanCountries];
        const otherCountries = Object.keys(this.g20Countries).filter(c => !implementedCountries.includes(c) && !europeanCountries.includes(c));
        
        // êµ¬í˜„ëœ êµ­ê°€ ë¨¼ì € ì¶”ê°€ (ìœ ëŸ½ì—°í•©ê³¼ ìœ ëŸ½ 15ê°œ êµ­ê°€ ì œì™¸)
        const europeanUnionIndex = implementedCountries.indexOf('european-union');
        const countriesBeforeEU = implementedCountries.slice(0, europeanUnionIndex);
        const countriesAfterEU = implementedCountries.slice(europeanUnionIndex + 1).filter(c => !europeanCountries.includes(c));
        
        countriesBeforeEU.forEach(countryCode => {
            if (this.g20Countries[countryCode]) {
                const option = document.createElement('option');
                option.value = countryCode;
                option.textContent = `${this.g20Countries[countryCode].flag} ${this.g20Countries[countryCode].name}`;
                countryDropdown.appendChild(option);
            }
        });
        
        // ìœ ëŸ½ì—°í•© ì¶”ê°€
        if (this.g20Countries['european-union']) {
            const option = document.createElement('option');
            option.value = 'european-union';
            option.textContent = `${this.g20Countries['european-union'].flag} ${this.g20Countries['european-union'].name}`;
            countryDropdown.appendChild(option);
        }
        
        // ìœ ëŸ½ì—°í•© í•˜ìœ„ì— 15ê°œ êµ­ê°€ ì¶”ê°€ (ìœ„ì—ì„œ ì´ë¯¸ ì •ì˜ëœ europeanCountries ì‚¬ìš©)
        europeanCountries.forEach(countryCode => {
            if (this.g20Countries[countryCode]) {
                const option = document.createElement('option');
                option.value = countryCode;
                option.textContent = `  â”” ${this.g20Countries[countryCode].flag} ${this.g20Countries[countryCode].name}`;
                countryDropdown.appendChild(option);
            }
        });
        
        // ë‚˜ë¨¸ì§€ êµ­ê°€ ì¶”ê°€ (ìœ ëŸ½ 15ê°œ êµ­ê°€ ì œì™¸)
        countriesAfterEU.forEach(countryCode => {
            if (this.g20Countries[countryCode] && !europeanCountries.includes(countryCode)) {
                const option = document.createElement('option');
                option.value = countryCode;
                option.textContent = `${this.g20Countries[countryCode].flag} ${this.g20Countries[countryCode].name}`;
                countryDropdown.appendChild(option);
            }
        });
        
        // êµ¬ë¶„ì„  ì¶”ê°€
        const separator2 = document.createElement('option');
        separator2.disabled = true;
        separator2.textContent = 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”';
        countryDropdown.appendChild(separator2);
        
        // ë‚˜ë¨¸ì§€ G20 êµ­ê°€ ì¶”ê°€
        otherCountries.forEach(countryCode => {
            const option = document.createElement('option');
            option.value = countryCode;
            option.textContent = `${this.g20Countries[countryCode].flag} ${this.g20Countries[countryCode].name}`;
            countryDropdown.appendChild(option);
        });
        
        // ìš”ì†Œë“¤ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
        mapModeToggle.appendChild(globeBtn);
        mapModeToggle.appendChild(g20Label);
        mapModeToggle.appendChild(countryDropdown);
        
        // ê¸°ì¡´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ìœ ì§€ (í•˜ìœ„ í˜¸í™˜ì„±)
        const usaBtn = document.createElement('button');
        usaBtn.id = 'usa-mode-btn';
        usaBtn.className = 'mode-btn hidden';
        usaBtn.textContent = 'ğŸ‡ºğŸ‡¸ ë¯¸êµ­';
        
        const koreaBtn = document.createElement('button');
        koreaBtn.id = 'korea-mode-btn';
        koreaBtn.className = 'mode-btn hidden';
        koreaBtn.textContent = 'ğŸ‡°ğŸ‡· í•œêµ­';
        
        const japanBtn = document.createElement('button');
        japanBtn.id = 'japan-mode-btn';
        japanBtn.className = 'mode-btn hidden';
        japanBtn.textContent = 'ğŸ‡¯ğŸ‡µ ì¼ë³¸';
        
        const chinaBtn = document.createElement('button');
        chinaBtn.id = 'china-mode-btn';
        chinaBtn.className = 'mode-btn hidden';
        chinaBtn.textContent = 'ğŸ‡¨ğŸ‡³ ì¤‘êµ­';

        const russiaBtn = document.createElement('button');
        russiaBtn.id = 'russia-mode-btn';
        russiaBtn.className = 'mode-btn hidden';
        russiaBtn.textContent = 'ğŸ‡·ğŸ‡º ëŸ¬ì‹œì•„';

        const indiaBtn = document.createElement('button');
        indiaBtn.id = 'india-mode-btn';
        indiaBtn.className = 'mode-btn hidden';
        indiaBtn.textContent = 'ğŸ‡®ğŸ‡³ ì¸ë„';

        const canadaBtn = document.createElement('button');
        canadaBtn.id = 'canada-mode-btn';
        canadaBtn.className = 'mode-btn hidden';
        canadaBtn.textContent = 'ğŸ‡¨ğŸ‡¦ ìºë‚˜ë‹¤';

        const germanyBtn = document.createElement('button');
        germanyBtn.id = 'germany-mode-btn';
        germanyBtn.className = 'mode-btn hidden';
        germanyBtn.textContent = 'ğŸ‡©ğŸ‡ª ë…ì¼';

        const ukBtn = document.createElement('button');
        ukBtn.id = 'uk-mode-btn';
        ukBtn.className = 'mode-btn hidden';
        ukBtn.textContent = 'ğŸ‡¬ğŸ‡§ ì˜êµ­';

        const franceBtn = document.createElement('button');
        franceBtn.id = 'france-mode-btn';
        franceBtn.className = 'mode-btn hidden';
        franceBtn.textContent = 'ğŸ‡«ğŸ‡· í”„ë‘ìŠ¤';

        const italyBtn = document.createElement('button');
        italyBtn.id = 'italy-mode-btn';
        italyBtn.className = 'mode-btn hidden';
        italyBtn.textContent = 'ğŸ‡®ğŸ‡¹ ì´íƒˆë¦¬ì•„';

        const brazilBtn = document.createElement('button');
        brazilBtn.id = 'brazil-mode-btn';
        brazilBtn.className = 'mode-btn hidden';
        brazilBtn.textContent = 'ğŸ‡§ğŸ‡· ë¸Œë¼ì§ˆ';

        const australiaBtn = document.createElement('button');
        australiaBtn.id = 'australia-mode-btn';
        australiaBtn.className = 'mode-btn hidden';
        australiaBtn.textContent = 'ğŸ‡¦ğŸ‡º í˜¸ì£¼';

        const mexicoBtn = document.createElement('button');
        mexicoBtn.id = 'mexico-mode-btn';
        mexicoBtn.className = 'mode-btn hidden';
        mexicoBtn.textContent = 'ğŸ‡²ğŸ‡½ ë©•ì‹œì½”';

        const indonesiaBtn = document.createElement('button');
        indonesiaBtn.id = 'indonesia-mode-btn';
        indonesiaBtn.className = 'mode-btn hidden';
        indonesiaBtn.textContent = 'ğŸ‡®ğŸ‡© ì¸ë„ë„¤ì‹œì•„';

        const saudiArabiaBtn = document.createElement('button');
        saudiArabiaBtn.id = 'saudi-arabia-mode-btn';
        saudiArabiaBtn.className = 'mode-btn hidden';
        saudiArabiaBtn.textContent = 'ğŸ‡¸ğŸ‡¦ ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„';

        const turkeyBtn = document.createElement('button');
        turkeyBtn.id = 'turkey-mode-btn';
        turkeyBtn.className = 'mode-btn hidden';
        turkeyBtn.textContent = 'ğŸ‡¹ğŸ‡· í„°í‚¤';

        const southAfricaBtn = document.createElement('button');
        southAfricaBtn.id = 'south-africa-mode-btn';
        southAfricaBtn.className = 'mode-btn hidden';
        southAfricaBtn.textContent = 'ğŸ‡¿ğŸ‡¦ ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­';

        const argentinaBtn = document.createElement('button');
        argentinaBtn.id = 'argentina-mode-btn';
        argentinaBtn.className = 'mode-btn hidden';
        argentinaBtn.textContent = 'ğŸ‡¦ğŸ‡· ì•„ë¥´í—¨í‹°ë‚˜';
        
        mapModeToggle.appendChild(usaBtn);
        mapModeToggle.appendChild(koreaBtn);
        mapModeToggle.appendChild(japanBtn);
        mapModeToggle.appendChild(chinaBtn);
        mapModeToggle.appendChild(russiaBtn);
        mapModeToggle.appendChild(indiaBtn);
        mapModeToggle.appendChild(canadaBtn);
        mapModeToggle.appendChild(germanyBtn);
        mapModeToggle.appendChild(ukBtn);
        mapModeToggle.appendChild(franceBtn);
        mapModeToggle.appendChild(italyBtn);
        mapModeToggle.appendChild(brazilBtn);
        mapModeToggle.appendChild(australiaBtn);
        mapModeToggle.appendChild(mexicoBtn);
        mapModeToggle.appendChild(indonesiaBtn);
        mapModeToggle.appendChild(saudiArabiaBtn);
        mapModeToggle.appendChild(turkeyBtn);
        mapModeToggle.appendChild(southAfricaBtn);
        mapModeToggle.appendChild(argentinaBtn);
        
        document.body.appendChild(mapModeToggle);
        
        // 3D/2D í† ê¸€ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        globeBtn.addEventListener('click', () => {
            this.toggleGlobeMode();
        });
        
        // ë“œë¡­ë‹¤ìš´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        countryDropdown.addEventListener('change', (e) => {
            const selectedCountry = e.target.value;
            if (selectedCountry && selectedCountry !== '') {
                this.switchToCountryMode(selectedCountry);
            }
        });
        
        // ê¸°ì¡´ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•˜ìœ„ í˜¸í™˜ì„±)
        usaBtn.addEventListener('click', () => {
            this.switchToUSAMode();
        });
        
        koreaBtn.addEventListener('click', () => {
            this.switchToKoreaMode();
        });
        
        japanBtn.addEventListener('click', () => {
            this.switchToJapanMode();
        });
        
        chinaBtn.addEventListener('click', () => {
            this.switchToChinaMode();
        });

        russiaBtn.addEventListener('click', () => {
            this.switchToRussiaMode();
        });

        indiaBtn.addEventListener('click', () => {
            this.switchToIndiaMode();
        });

        canadaBtn.addEventListener('click', () => {
            this.switchToCanadaMode();
        });

        germanyBtn.addEventListener('click', () => {
            this.switchToGermanyMode();
        });

        ukBtn.addEventListener('click', () => {
            this.switchToUKMode();
        });

        franceBtn.addEventListener('click', () => {
            this.switchToFranceMode();
        });

        italyBtn.addEventListener('click', () => {
            this.switchToItalyMode();
        });

        brazilBtn.addEventListener('click', () => {
            this.switchToBrazilMode();
        });

        australiaBtn.addEventListener('click', () => {
            this.switchToAustraliaMode();
        });

        mexicoBtn.addEventListener('click', () => {
            this.switchToMexicoMode();
        });

        indonesiaBtn.addEventListener('click', () => {
            this.switchToIndonesiaMode();
        });

        saudiArabiaBtn.addEventListener('click', () => {
            this.switchToSaudiArabiaMode();
        });

        turkeyBtn.addEventListener('click', () => {
            this.switchToTurkeyMode();
        });

        southAfricaBtn.addEventListener('click', () => {
            this.switchToSouthAfricaMode();
        });

        argentinaBtn.addEventListener('click', () => {
            this.switchToArgentinaMode();
        });
    }
    
    // ë¯¸êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToUSAMode() {
        if (this.currentMapMode === 'usa') return; // ì´ë¯¸ ë¯¸êµ­ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'usa';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [-95, 35],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadWorldData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë¯¸êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í•œêµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToKoreaMode() {
        if (this.currentMapMode === 'korea') return; // ì´ë¯¸ í•œêµ­ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'korea';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [127.5, 36.0],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadKoreaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í•œêµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì¼ë³¸ ëª¨ë“œë¡œ ì „í™˜
    async switchToJapanMode() {
        if (this.currentMapMode === 'japan') return; // ì´ë¯¸ ì¼ë³¸ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'japan';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [138.0, 36.0],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadJapanData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¼ë³¸ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì¤‘êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToChinaMode() {
        if (this.currentMapMode === 'china') return; // ì´ë¯¸ ì¤‘êµ­ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'china';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™ (ë°ì´í„° ë¡œë”©ê³¼ ë³‘ë ¬)
        this.map.easeTo({
            center: [104, 35],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadChinaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¤‘êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }

    // ì¸ë„ ëª¨ë“œë¡œ ì „í™˜
    async switchToIndiaMode() {
        if (this.currentMapMode === 'india') return; // ì´ë¯¸ ì¸ë„ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'india';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [77, 20],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadIndiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¸ë„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìºë‚˜ë‹¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToCanadaMode() {
        if (this.currentMapMode === 'canada') return; // ì´ë¯¸ ìºë‚˜ë‹¤ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'canada';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-106, 56],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadCanadaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìºë‚˜ë‹¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë…ì¼ ëª¨ë“œë¡œ ì „í™˜
    async switchToGermanyMode() {
        if (this.currentMapMode === 'germany') return;
        
        this.currentMapMode = 'germany';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [10, 51],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadGermanyData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë…ì¼ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì˜êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToUKMode() {
        if (this.currentMapMode === 'uk') return;
        
        this.currentMapMode = 'uk';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-3, 54],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadUKData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì˜êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í”„ë‘ìŠ¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToFranceMode() {
        if (this.currentMapMode === 'france') return;
        
        this.currentMapMode = 'france';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [2, 46],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadFranceData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í”„ë‘ìŠ¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì´íƒˆë¦¬ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToItalyMode() {
        if (this.currentMapMode === 'italy') return;
        
        this.currentMapMode = 'italy';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [12, 42],
            zoom: 6,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadItalyData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì´íƒˆë¦¬ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë¸Œë¼ì§ˆ ëª¨ë“œë¡œ ì „í™˜
    async switchToBrazilMode() {
        if (this.currentMapMode === 'brazil') return;
        
        this.currentMapMode = 'brazil';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-55, -15],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadBrazilData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë¸Œë¼ì§ˆ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í˜¸ì£¼ ëª¨ë“œë¡œ ì „í™˜
    async switchToAustraliaMode() {
        if (this.currentMapMode === 'australia') return;
        
        this.currentMapMode = 'australia';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [133, -27],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadAustraliaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í˜¸ì£¼ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë©•ì‹œì½” ëª¨ë“œë¡œ ì „í™˜
    async switchToMexicoMode() {
        if (this.currentMapMode === 'mexico') return;
        
        this.currentMapMode = 'mexico';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-102, 23],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadMexicoData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë©•ì‹œì½” ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì¸ë„ë„¤ì‹œì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToIndonesiaMode() {
        if (this.currentMapMode === 'indonesia') return;
        
        this.currentMapMode = 'indonesia';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [113, -5],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadIndonesiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì¸ë„ë„¤ì‹œì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToSaudiArabiaMode() {
        if (this.currentMapMode === 'saudi-arabia') return;
        
        this.currentMapMode = 'saudi-arabia';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [45, 24],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadSaudiArabiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í„°í‚¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToTurkeyMode() {
        if (this.currentMapMode === 'turkey') return;
        
        this.currentMapMode = 'turkey';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [35, 39],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadTurkeyData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í„°í‚¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ëª¨ë“œë¡œ ì „í™˜
    async switchToSouthAfricaMode() {
        if (this.currentMapMode === 'south-africa') return;
        
        this.currentMapMode = 'south-africa';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [22, -30],
            zoom: 5,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadSouthAfricaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì•„ë¥´í—¨í‹°ë‚˜ ëª¨ë“œë¡œ ì „í™˜
    async switchToArgentinaMode() {
        if (this.currentMapMode === 'argentina') return;
        
        this.currentMapMode = 'argentina';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [-63, -38],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadArgentinaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì•„ë¥´í—¨í‹°ë‚˜ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìœ ëŸ½ì—°í•© ëª¨ë“œë¡œ ì „í™˜
    async switchToEuropeanUnionMode() {
        if (this.currentMapMode === 'european-union') return;
        
        this.currentMapMode = 'european-union';
        this.updateModeButtons();
        
        this.map.easeTo({
            center: [10, 50],
            zoom: 4,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadEuropeanUnionData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìœ ëŸ½ì—°í•© ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìŠ¤í˜ì¸ ëª¨ë“œë¡œ ì „í™˜
    async switchToSpainMode() {
        if (this.currentMapMode === 'spain') return;
        this.currentMapMode = 'spain';
        this.updateModeButtons();
        this.map.easeTo({ center: [-3, 40], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadSpainData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìŠ¤í˜ì¸ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë„¤ëœë€ë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToNetherlandsMode() {
        if (this.currentMapMode === 'netherlands') return;
        this.currentMapMode = 'netherlands';
        this.updateModeButtons();
        this.map.easeTo({ center: [5, 52], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadNetherlandsData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë„¤ëœë€ë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í´ë€ë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToPolandMode() {
        if (this.currentMapMode === 'poland') return;
        this.currentMapMode = 'poland';
        this.updateModeButtons();
        this.map.easeTo({ center: [19, 52], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadPolandData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í´ë€ë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë²¨ê¸°ì— ëª¨ë“œë¡œ ì „í™˜
    async switchToBelgiumMode() {
        if (this.currentMapMode === 'belgium') return;
        this.currentMapMode = 'belgium';
        this.updateModeButtons();
        this.map.easeTo({ center: [4.5, 50.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadBelgiumData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë²¨ê¸°ì— ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ìŠ¤ì›¨ë´ ëª¨ë“œë¡œ ì „í™˜
    async switchToSwedenMode() {
        if (this.currentMapMode === 'sweden') return;
        this.currentMapMode = 'sweden';
        this.updateModeButtons();
        this.map.easeTo({ center: [18, 60], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadSwedenData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ìŠ¤ì›¨ë´ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToAustriaMode() {
        if (this.currentMapMode === 'austria') return;
        this.currentMapMode = 'austria';
        this.updateModeButtons();
        this.map.easeTo({ center: [13, 47.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadAustriaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë´ë§ˆí¬ ëª¨ë“œë¡œ ì „í™˜
    async switchToDenmarkMode() {
        if (this.currentMapMode === 'denmark') return;
        this.currentMapMode = 'denmark';
        this.updateModeButtons();
        this.map.easeTo({ center: [10, 56], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadDenmarkData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë´ë§ˆí¬ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í•€ë€ë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToFinlandMode() {
        if (this.currentMapMode === 'finland') return;
        this.currentMapMode = 'finland';
        this.updateModeButtons();
        this.map.easeTo({ center: [26, 64], zoom: 5, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadFinlandData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í•€ë€ë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì•„ì¼ëœë“œ ëª¨ë“œë¡œ ì „í™˜
    async switchToIrelandMode() {
        if (this.currentMapMode === 'ireland') return;
        this.currentMapMode = 'ireland';
        this.updateModeButtons();
        this.map.easeTo({ center: [-8, 53], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadIrelandData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì•„ì¼ëœë“œ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í¬ë¥´íˆ¬ê°ˆ ëª¨ë“œë¡œ ì „í™˜
    async switchToPortugalMode() {
        if (this.currentMapMode === 'portugal') return;
        this.currentMapMode = 'portugal';
        this.updateModeButtons();
        this.map.easeTo({ center: [-8, 39.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadPortugalData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í¬ë¥´íˆ¬ê°ˆ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ê·¸ë¦¬ìŠ¤ ëª¨ë“œë¡œ ì „í™˜
    async switchToGreeceMode() {
        if (this.currentMapMode === 'greece') return;
        this.currentMapMode = 'greece';
        this.updateModeButtons();
        this.map.easeTo({ center: [23, 38], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadGreeceData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ê·¸ë¦¬ìŠ¤ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ì²´ì½” ëª¨ë“œë¡œ ì „í™˜
    async switchToCzechRepublicMode() {
        if (this.currentMapMode === 'czech-republic') return;
        this.currentMapMode = 'czech-republic';
        this.updateModeButtons();
        this.map.easeTo({ center: [15, 49.75], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadCzechRepublicData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ì²´ì½” ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë£¨ë§ˆë‹ˆì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToRomaniaMode() {
        if (this.currentMapMode === 'romania') return;
        this.currentMapMode = 'romania';
        this.updateModeButtons();
        this.map.easeTo({ center: [25, 46], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadRomaniaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë£¨ë§ˆë‹ˆì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í—ê°€ë¦¬ ëª¨ë“œë¡œ ì „í™˜
    async switchToHungaryMode() {
        if (this.currentMapMode === 'hungary') return;
        this.currentMapMode = 'hungary';
        this.updateModeButtons();
        this.map.easeTo({ center: [19.5, 47.5], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadHungaryData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('í—ê°€ë¦¬ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ë¶ˆê°€ë¦¬ì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToBulgariaMode() {
        if (this.currentMapMode === 'bulgaria') return;
        this.currentMapMode = 'bulgaria';
        this.updateModeButtons();
        this.map.easeTo({ center: [25, 43], zoom: 6, duration: 600 });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadBulgariaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ë¶ˆê°€ë¦¬ì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // ëŸ¬ì‹œì•„ ëª¨ë“œë¡œ ì „í™˜
    async switchToRussiaMode() {
        if (this.currentMapMode === 'russia') return; // ì´ë¯¸ ëŸ¬ì‹œì•„ ëª¨ë“œë©´ ì¤‘ë‹¨
        
        this.currentMapMode = 'russia';
        this.updateModeButtons();
        
        // ë¹ ë¥¸ ì „í™˜ì„ ìœ„í•´ ì¦‰ì‹œ ì§€ë„ ì´ë™
        this.map.easeTo({
            center: [100, 60],
            zoom: 3,
            duration: 600
        });
        
        // Firestore ë°ì´í„°ë¥¼ ë¨¼ì € ë¡œë“œ (ì´ì „ì— ì…ë ¥í•œ ì¸êµ¬/ë©´ì  ë°ì´í„° ìœ ì§€)
        if (this.isFirebaseInitialized) {
            await this.loadRegionDataFromFirestore();
        }
        
        await this.loadRussiaData();
        
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ë°ì´í„° ìˆ˜ì§‘ (Firestore ë°ì´í„° ìš°ì„  ìœ ì§€)
        this.collectAllRegionsFromMapSources();
        
        // Firestore ë°ì´í„° ì ìš©
        if (this.isFirebaseInitialized) {
            this.updateMapSourcesWithRegionData();
        }
        this.showNotification('ëŸ¬ì‹œì•„ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // êµ­ê°€ ëª¨ë“œë¡œ ì „í™˜ (ì¼ë°˜í™”ëœ í•¨ìˆ˜)
    async switchToCountryMode(countryCode) {
        // ê°’ ë³´ì •: 'cn' â†’ 'china', 'ru' â†’ 'russia'
        if (countryCode && countryCode.toLowerCase() === 'cn') countryCode = 'china';
        if (countryCode && countryCode.toLowerCase() === 'ru') countryCode = 'russia';
        const country = this.g20Countries[countryCode];
        if (!country) {
            console.error('Unknown country code:', countryCode);
            return;
        }
        
        // ì´ë¯¸ í•´ë‹¹ êµ­ê°€ ëª¨ë“œë©´ ì¤‘ë‹¨
        if (this.currentMapMode === countryCode) return;
        
        // íŠ¹ë³„ ì²˜ë¦¬: ë¯¸êµ­, í•œêµ­, ì¼ë³¸ì€ ê¸°ì¡´ í•¨ìˆ˜ ì‚¬ìš©
        if (countryCode === 'usa') {
            await this.switchToUSAMode();
            return;
        } else if (countryCode === 'south-korea') {
            // 'south-korea'ë¥¼ 'korea'ë¡œ ë§¤í•‘
            await this.switchToKoreaMode();
            return;
        } else if (countryCode === 'japan') {
            await this.switchToJapanMode();
            return;
        } else if (countryCode === 'china') {
            await this.switchToChinaMode();
            return;
        } else if (countryCode === 'russia' || countryCode === 'ru') {
            await this.switchToRussiaMode();
            return;
        } else if (countryCode === 'india' || countryCode === 'in') {
            await this.switchToIndiaMode();
            return;
        } else if (countryCode === 'canada' || countryCode === 'ca') {
            await this.switchToCanadaMode();
            return;
        } else if (countryCode === 'germany' || countryCode === 'de') {
            await this.switchToGermanyMode();
            return;
        } else if (countryCode === 'uk' || countryCode === 'gb') {
            await this.switchToUKMode();
            return;
        } else if (countryCode === 'france' || countryCode === 'fr') {
            await this.switchToFranceMode();
            return;
        } else if (countryCode === 'italy' || countryCode === 'it') {
            await this.switchToItalyMode();
            return;
        } else if (countryCode === 'brazil' || countryCode === 'br') {
            await this.switchToBrazilMode();
            return;
        } else if (countryCode === 'australia' || countryCode === 'au') {
            await this.switchToAustraliaMode();
            return;
        } else if (countryCode === 'mexico' || countryCode === 'mx') {
            await this.switchToMexicoMode();
            return;
        } else if (countryCode === 'indonesia' || countryCode === 'id') {
            await this.switchToIndonesiaMode();
            return;
        } else if (countryCode === 'saudi-arabia' || countryCode === 'sa') {
            await this.switchToSaudiArabiaMode();
            return;
        } else if (countryCode === 'turkey' || countryCode === 'tr') {
            await this.switchToTurkeyMode();
            return;
        } else if (countryCode === 'south-africa' || countryCode === 'za') {
            await this.switchToSouthAfricaMode();
            return;
        } else if (countryCode === 'argentina' || countryCode === 'ar') {
            await this.switchToArgentinaMode();
            return;
        } else if (countryCode === 'european-union' || countryCode === 'eu') {
            await this.switchToEuropeanUnionMode();
            return;
        } else if (countryCode === 'spain' || countryCode === 'es') {
            await this.switchToSpainMode();
            return;
        } else if (countryCode === 'netherlands' || countryCode === 'nl') {
            await this.switchToNetherlandsMode();
            return;
        } else if (countryCode === 'poland' || countryCode === 'pl') {
            await this.switchToPolandMode();
            return;
        } else if (countryCode === 'belgium' || countryCode === 'be') {
            await this.switchToBelgiumMode();
            return;
        } else if (countryCode === 'sweden' || countryCode === 'se') {
            await this.switchToSwedenMode();
            return;
        } else if (countryCode === 'austria' || countryCode === 'at') {
            await this.switchToAustriaMode();
            return;
        } else if (countryCode === 'denmark' || countryCode === 'dk') {
            await this.switchToDenmarkMode();
            return;
        } else if (countryCode === 'finland' || countryCode === 'fi') {
            await this.switchToFinlandMode();
            return;
        } else if (countryCode === 'ireland' || countryCode === 'ie') {
            await this.switchToIrelandMode();
            return;
        } else if (countryCode === 'portugal' || countryCode === 'pt') {
            await this.switchToPortugalMode();
            return;
        } else if (countryCode === 'greece' || countryCode === 'gr') {
            await this.switchToGreeceMode();
            return;
        } else if (countryCode === 'czech-republic' || countryCode === 'cz') {
            await this.switchToCzechRepublicMode();
            return;
        } else if (countryCode === 'romania' || countryCode === 'ro') {
            await this.switchToRomaniaMode();
            return;
        } else if (countryCode === 'hungary' || countryCode === 'hu') {
            await this.switchToHungaryMode();
            return;
        } else if (countryCode === 'bulgaria' || countryCode === 'bg') {
            await this.switchToBulgariaMode();
            return;
        }
        
        // ê¸°íƒ€ êµ­ê°€: ê¸°ë³¸ ì§€ë„ ëª¨ë“œë¡œ ì „í™˜
        this.currentMapMode = countryCode;
        this.updateModeButtons();
        
        // ì§€ë„ ì´ë™
        this.map.easeTo({
            center: country.center,
            zoom: country.zoom,
            duration: 600
        });
        
        // ì„¸ê³„ ë°ì´í„° ë¡œë“œ (í•´ë‹¹ êµ­ê°€ì˜ ê²½ê³„ì„ ë§Œ í‘œì‹œ)
        await this.loadWorldData();
        
        this.showNotification(`${country.name} ì§€ë„ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'info');
    }
    
    // ëª¨ë“œ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
    updateModeButtons() {
        const dropdown = document.getElementById('country-selector-dropdown');
        const usaBtn = document.getElementById('usa-mode-btn');
        const koreaBtn = document.getElementById('korea-mode-btn');
        const japanBtn = document.getElementById('japan-mode-btn');
        const chinaBtn = document.getElementById('china-mode-btn');
        const russiaBtn = document.getElementById('russia-mode-btn');
        const indiaBtn = document.getElementById('india-mode-btn');
        const canadaBtn = document.getElementById('canada-mode-btn');
        const germanyBtn = document.getElementById('germany-mode-btn');
        const ukBtn = document.getElementById('uk-mode-btn');
        const franceBtn = document.getElementById('france-mode-btn');
        const italyBtn = document.getElementById('italy-mode-btn');
        const brazilBtn = document.getElementById('brazil-mode-btn');
        const australiaBtn = document.getElementById('australia-mode-btn');
        const mexicoBtn = document.getElementById('mexico-mode-btn');
        const indonesiaBtn = document.getElementById('indonesia-mode-btn');
        const saudiArabiaBtn = document.getElementById('saudi-arabia-mode-btn');
        const turkeyBtn = document.getElementById('turkey-mode-btn');
        const southAfricaBtn = document.getElementById('south-africa-mode-btn');
        const argentinaBtn = document.getElementById('argentina-mode-btn');
        const globeBtn = document.getElementById('globe-mode-btn');
        
        // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì—…ë°ì´íŠ¸
        if (dropdown) {
            if (this.isGlobeMode) {
                dropdown.value = '';
            } else {
                // currentMapModeì™€ ë“œë¡­ë‹¤ìš´ ê°’ ë§¤í•‘
                let dropdownValue = this.currentMapMode;
                if (this.currentMapMode === 'korea') {
                    dropdownValue = 'south-korea';
                }
                dropdown.value = dropdownValue;
            }
        }
        
        // ëª¨ë“  ë²„íŠ¼ì—ì„œ active í´ë˜ìŠ¤ ì œê±°
        if (usaBtn) usaBtn.classList.remove('active');
        if (koreaBtn) koreaBtn.classList.remove('active');
        if (japanBtn) japanBtn.classList.remove('active');
        if (chinaBtn) chinaBtn.classList.remove('active');
        if (russiaBtn) russiaBtn.classList.remove('active');
        if (indiaBtn) indiaBtn.classList.remove('active');
        if (canadaBtn) canadaBtn.classList.remove('active');
        if (germanyBtn) germanyBtn.classList.remove('active');
        if (ukBtn) ukBtn.classList.remove('active');
        if (franceBtn) franceBtn.classList.remove('active');
        if (italyBtn) italyBtn.classList.remove('active');
        if (brazilBtn) brazilBtn.classList.remove('active');
        if (australiaBtn) australiaBtn.classList.remove('active');
        if (mexicoBtn) mexicoBtn.classList.remove('active');
        if (indonesiaBtn) indonesiaBtn.classList.remove('active');
        if (saudiArabiaBtn) saudiArabiaBtn.classList.remove('active');
        if (turkeyBtn) turkeyBtn.classList.remove('active');
        if (southAfricaBtn) southAfricaBtn.classList.remove('active');
        if (argentinaBtn) argentinaBtn.classList.remove('active');
        if (globeBtn) globeBtn.classList.remove('active');
        
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ active í´ë˜ìŠ¤ ì¶”ê°€
        if (this.isGlobeMode && globeBtn) {
            globeBtn.classList.add('active');
        } else if (this.currentMapMode === 'usa' && usaBtn) {
            usaBtn.classList.add('active');
        } else if (this.currentMapMode === 'korea' && koreaBtn) {
            koreaBtn.classList.add('active');
        } else if (this.currentMapMode === 'japan' && japanBtn) {
            japanBtn.classList.add('active');
        } else if (this.currentMapMode === 'china' && chinaBtn) {
            chinaBtn.classList.add('active');
        } else if (this.currentMapMode === 'russia' && russiaBtn) {
            russiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'india' && indiaBtn) {
            indiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'canada' && canadaBtn) {
            canadaBtn.classList.add('active');
        } else if (this.currentMapMode === 'germany' && germanyBtn) {
            germanyBtn.classList.add('active');
        } else if (this.currentMapMode === 'uk' && ukBtn) {
            ukBtn.classList.add('active');
        } else if (this.currentMapMode === 'france' && franceBtn) {
            franceBtn.classList.add('active');
        } else if (this.currentMapMode === 'italy' && italyBtn) {
            italyBtn.classList.add('active');
        } else if (this.currentMapMode === 'brazil' && brazilBtn) {
            brazilBtn.classList.add('active');
        } else if (this.currentMapMode === 'australia' && australiaBtn) {
            australiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'mexico' && mexicoBtn) {
            mexicoBtn.classList.add('active');
        } else if (this.currentMapMode === 'indonesia' && indonesiaBtn) {
            indonesiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'saudi-arabia' && saudiArabiaBtn) {
            saudiArabiaBtn.classList.add('active');
        } else if (this.currentMapMode === 'turkey' && turkeyBtn) {
            turkeyBtn.classList.add('active');
        } else if (this.currentMapMode === 'south-africa' && southAfricaBtn) {
            southAfricaBtn.classList.add('active');
        } else if (this.currentMapMode === 'argentina' && argentinaBtn) {
            argentinaBtn.classList.add('active');
        }
    }
    
    // ì¼ë³¸ ë°ì´í„° ë¡œë“œ
    async loadJapanData() {
        try {
            let geoJsonData;
            
            // ìºì‹œëœ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì‚¬ìš©
            if (this.cachedGeoJsonData['japan']) {
                geoJsonData = this.cachedGeoJsonData['japan'];
            } else {
                // ì¼ë³¸ ë°ì´í„° ë¡œë“œ (ë„ë„ë¶€í˜„ ë‹¨ìœ„) - ì •í™•í•œ ê²½ê³„ ë°ì´í„° ì‚¬ìš©
                const japanUrl = this.getAssetUrl('data/japan-prefectures-accurate.geojson');
                console.log('[loadJapanData] ìš”ì²­ URL:', japanUrl);
                const response = await fetch(japanUrl, { cache: 'no-store' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[loadJapanData] HTTP ì—ëŸ¬:', response.status, response.statusText);
                    console.error('[loadJapanData] ì‘ë‹µ ë‚´ìš©:', errorText.substring(0, 200));
                    throw new Error(`ì¼ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: HTTP ${response.status} ${response.statusText}`);
                }
                
                geoJsonData = await response.json();
                
                // ê° ì§€ì—­ì— ê´‘ê³  ì •ë³´ ì¶”ê°€ (ë„ë„ë¶€í˜„ ë‹¨ìœ„)
                geoJsonData.features.forEach((feature, index) => {
                const props = feature.properties;
                
                // ìƒˆë¡œìš´ ë°ì´í„° êµ¬ì¡°ì— ë§ê²Œ ì†ì„± ë§¤í•‘
                const prefectureNameJa = props.nam_ja || props.name || `Prefecture_${index}`;
                const prefectureNameEn = props.nam || props.name_en || prefectureNameJa;
                const prefectureId = props.id ? `prefecture_${props.id}` : `prefecture_${index}`;
                
                // ì¼ë³¸ ë„ë„ë¶€í˜„ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (ì‹¤ì œ ë°ì´í„°ë¡œ ì—…ë°ì´íŠ¸)
                const prefectureData = {
                    1: { name: "Hokkaido", name_ja: "åŒ—æµ·é“", population: 5179000, area: 83424 },
                    2: { name: "Aomori", name_ja: "é’æ£®çœŒ", population: 1175000, area: 9645 },
                    3: { name: "Iwate", name_ja: "å²©æ‰‹çœŒ", population: 1187000, area: 15275 },
                    4: { name: "Miyagi", name_ja: "å®®åŸçœŒ", population: 2265000, area: 7282 },
                    5: { name: "Akita", name_ja: "ç§‹ç”°çœŒ", population: 915000, area: 11637 },
                    6: { name: "Yamagata", name_ja: "å±±å½¢çœŒ", population: 1050000, area: 9323 },
                    7: { name: "Fukushima", name_ja: "ç¦å³¶çœŒ", population: 1780000, area: 13783 },
                    8: { name: "Ibaraki", name_ja: "èŒ¨åŸçœŒ", population: 2824000, area: 6096 },
                    9: { name: "Tochigi", name_ja: "æ ƒæœ¨çœŒ", population: 1928000, area: 6408 },
                    10: { name: "Gunma", name_ja: "ç¾¤é¦¬çœŒ", population: 1933000, area: 6363 },
                    11: { name: "Saitama", name_ja: "åŸ¼ç‰çœŒ", population: 7389000, area: 3798 },
                    12: { name: "Chiba", name_ja: "åƒè‘‰çœŒ", population: 6364000, area: 5157 },
                    13: { name: "Tokyo", name_ja: "æ±äº¬éƒ½", population: 14049000, area: 2194 },
                    14: { name: "Kanagawa", name_ja: "ç¥å¥ˆå·çœŒ", population: 9232000, area: 2416 },
                    15: { name: "Niigata", name_ja: "æ–°æ½ŸçœŒ", population: 2117000, area: 12583 },
                    16: { name: "Toyama", name_ja: "å¯Œå±±çœŒ", population: 1016000, area: 4247 },
                    17: { name: "Ishikawa", name_ja: "çŸ³å·çœŒ", population: 1100000, area: 4186 },
                    18: { name: "Fukui", name_ja: "ç¦äº•çœŒ", population: 750000, area: 4189 },
                    19: { name: "Yamanashi", name_ja: "å±±æ¢¨çœŒ", population: 800000, area: 4465 },
                    20: { name: "Nagano", name_ja: "é•·é‡çœŒ", population: 2000000, area: 13562 },
                    21: { name: "Gifu", name_ja: "å²é˜œçœŒ", population: 1970000, area: 10621 },
                    22: { name: "Shizuoka", name_ja: "é™å²¡çœŒ", population: 3588000, area: 7777 },
                    23: { name: "Aichi", name_ja: "æ„›çŸ¥çœŒ", population: 7552000, area: 5172 },
                    24: { name: "Mie", name_ja: "ä¸‰é‡çœŒ", population: 1726000, area: 5774 },
                    25: { name: "Shiga", name_ja: "æ»‹è³€çœŒ", population: 1405000, area: 4017 },
                    26: { name: "Kyoto", name_ja: "äº¬éƒ½åºœ", population: 2525000, area: 4613 },
                    27: { name: "Osaka", name_ja: "å¤§é˜ªåºœ", population: 8783000, area: 1905 },
                    28: { name: "Hyogo", name_ja: "å…µåº«çœŒ", population: 5418000, area: 8400 },
                    29: { name: "Nara", name_ja: "å¥ˆè‰¯çœŒ", population: 1298000, area: 3691 },
                    30: { name: "Wakayama", name_ja: "å’Œæ­Œå±±çœŒ", population: 897000, area: 4726 },
                    31: { name: "Tottori", name_ja: "é³¥å–çœŒ", population: 538000, area: 3507 },
                    32: { name: "Shimane", name_ja: "å³¶æ ¹çœŒ", population: 656000, area: 6708 },
                    33: { name: "Okayama", name_ja: "å²¡å±±çœŒ", population: 1871000, area: 7114 },
                    34: { name: "Hiroshima", name_ja: "åºƒå³¶çœŒ", population: 2777000, area: 8480 },
                    35: { name: "Yamaguchi", name_ja: "å±±å£çœŒ", population: 1285000, area: 6113 },
                    36: { name: "Tokushima", name_ja: "å¾³å³¶çœŒ", population: 713000, area: 4147 },
                    37: { name: "Kagawa", name_ja: "é¦™å·çœŒ", population: 944000, area: 1877 },
                    38: { name: "Ehime", name_ja: "æ„›åª›çœŒ", population: 1305000, area: 5676 },
                    39: { name: "Kochi", name_ja: "é«˜çŸ¥çœŒ", population: 670000, area: 7104 },
                    40: { name: "Fukuoka", name_ja: "ç¦å²¡çœŒ", population: 5095000, area: 4987 },
                    41: { name: "Saga", name_ja: "ä½è³€çœŒ", population: 812000, area: 2440 },
                    42: { name: "Nagasaki", name_ja: "é•·å´çœŒ", population: 1260000, area: 4132 },
                    43: { name: "Kumamoto", name_ja: "ç†Šæœ¬çœŒ", population: 1725000, area: 7409 },
                    44: { name: "Oita", name_ja: "å¤§åˆ†çœŒ", population: 1116000, area: 6341 },
                    45: { name: "Miyazaki", name_ja: "å®®å´çœŒ", population: 1046000, area: 7735 },
                    46: { name: "Kagoshima", name_ja: "é¹¿å…å³¶çœŒ", population: 1537000, area: 9188 },
                    47: { name: "Okinawa", name_ja: "æ²–ç¸„çœŒ", population: 1464000, area: 2282 }
                };
                
                const data = prefectureData[props.id] || { name: prefectureNameJa, name_ja: prefectureNameJa, population: 1000000, area: 5000 };
                
                feature.properties = {
                    ...props,
                    id: prefectureId,
                    name: data.name, // ì˜ì–´ ì´ë¦„ì„ ë©”ì¸ìœ¼ë¡œ í‘œì‹œ
                    name_en: data.name,
                    name_ja: data.name_ja, // ì¼ë³¸ì–´ ì´ë¦„ë„ ë³´ì¡´
                    country: 'Japan',
                    admin_level: 'Prefecture',
                    population: data.population,
                    area: data.area,
                    ad_status: 'available',
                    ad_price: Math.floor(Math.random() * 100000) + 10000,
                    revenue: 0,
                    company: null,
                    logo: null,
                    color: '#4ecdc4',
                    border_color: '#ffffff',
                    border_width: 1
                };
                
                this.regionData.set(prefectureId, feature.properties);
            });
            
            // ìºì‹œì— ì €ì¥
            this.cachedGeoJsonData['japan'] = geoJsonData;
            }
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (ë” ë¹ ë¦„)
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                // ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
                this.map.addSource('world-regions', {
                    type: 'geojson',
                    data: geoJsonData
                });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            ['==', ['get', 'ad_status'], 'selected'],
                            '#feca57',
                            '#4ecdc4'
                        ],
                        'fill-opacity': 0.7
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•œ ë²ˆë§Œ ì¶”ê°€
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ì¼ë³¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ë„ë„ë¶€í˜„');
            
        } catch (error) {
            console.error('ì¼ë³¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¼ë³¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¤‘êµ­ ì„± í•œêµ­ì–´ í‘œê¸° ë§¤í•‘
    getKoreanProvinceName(rawName) {
        if (!rawName) return rawName;
        const mapZhToKo = {
            'åŒ—äº¬å¸‚': 'ë² ì´ì§•ì‹œ',
            'å¤©æ´¥å¸‚': 'í†ˆì§„ì‹œ',
            'æ²³åŒ—çœ': 'í—ˆë² ì´ì„±',
            'å±±è¥¿çœ': 'ì‚°ì‹œì„±',
            'å†…è’™å¤è‡ªæ²»åŒº': 'ë‚´ëª½ê³¨ìì¹˜êµ¬',
            'è¾½å®çœ': 'ë´ì˜¤ë‹ì„±',
            'å‰æ—çœ': 'ì§€ë¦°ì„±',
            'é»‘é¾™æ±Ÿçœ': 'í—¤ì´ë£½ì¥ì„±',
            'ä¸Šæµ·å¸‚': 'ìƒí•˜ì´ì‹œ',
            'æ±Ÿè‹çœ': 'ì¥ì‘¤ì„±',
            'æµ™æ±Ÿçœ': 'ì €ì¥ì„±',
            'å®‰å¾½çœ': 'ì•ˆí›„ì´ì„±',
            'ç¦å»ºçœ': 'í‘¸ì  ì„±',
            'æ±Ÿè¥¿çœ': 'ì¥ì‹œì„±',
            'å±±ä¸œçœ': 'ì‚°ë‘¥ì„±',
            'æ²³å—çœ': 'í—ˆë‚œì„±',
            'æ¹–åŒ—çœ': 'í›„ë² ì´ì„±',
            'æ¹–å—çœ': 'í›„ë‚œì„±',
            'å¹¿ä¸œçœ': 'ê´‘ë‘¥ì„±',
            'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': 'ê´‘ì‹œì¢¡ì¡±ìì¹˜êµ¬',
            'æµ·å—çœ': 'í•˜ì´ë‚œì„±',
            'é‡åº†å¸‚': 'ì¶©ì¹­ì‹œ',
            'å››å·çœ': 'ì“°ì´¨ì„±',
            'è´µå·çœ': 'êµ¬ì´ì €ìš°ì„±',
            'äº‘å—çœ': 'ìœˆë‚œì„±',
            'è¥¿è—è‡ªæ²»åŒº': 'í‹°ë² íŠ¸ìì¹˜êµ¬',
            'é™•è¥¿çœ': 'ì‚°ì‹œì„±(ì„¬ì„œ)',
            'ç”˜è‚ƒçœ': 'ê°„ì‘¤ì„±',
            'é’æµ·çœ': 'ì¹­í•˜ì´ì„±',
            'å®å¤å›æ—è‡ªæ²»åŒº': 'ë‹ìƒ¤í›„ì´ì¡±ìì¹˜êµ¬',
            'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': 'ì‹ ì¥ìœ„êµ¬ë¥´ìì¹˜êµ¬',
            'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': 'í™ì½©íŠ¹ë³„í–‰ì •êµ¬',
            'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': 'ë§ˆì¹´ì˜¤íŠ¹ë³„í–‰ì •êµ¬',
            'å°æ¹¾çœ': 'íƒ€ì´ì™„'
        };
        const mapEnToKo = {
            'Beijing': 'ë² ì´ì§•ì‹œ',
            'Tianjin': 'í†ˆì§„ì‹œ',
            'Hebei': 'í—ˆë² ì´ì„±',
            'Shanxi': 'ì‚°ì‹œì„±',
            'Inner Mongolia': 'ë‚´ëª½ê³¨ìì¹˜êµ¬',
            'Liaoning': 'ë´ì˜¤ë‹ì„±',
            'Jilin': 'ì§€ë¦°ì„±',
            'Heilongjiang': 'í—¤ì´ë£½ì¥ì„±',
            'Shanghai': 'ìƒí•˜ì´ì‹œ',
            'Jiangsu': 'ì¥ì‘¤ì„±',
            'Zhejiang': 'ì €ì¥ì„±',
            'Anhui': 'ì•ˆí›„ì´ì„±',
            'Fujian': 'í‘¸ì  ì„±',
            'Jiangxi': 'ì¥ì‹œì„±',
            'Shandong': 'ì‚°ë‘¥ì„±',
            'Henan': 'í—ˆë‚œì„±',
            'Hubei': 'í›„ë² ì´ì„±',
            'Hunan': 'í›„ë‚œì„±',
            'Guangdong': 'ê´‘ë‘¥ì„±',
            'Guangxi': 'ê´‘ì‹œì¢¡ì¡±ìì¹˜êµ¬',
            'Hainan': 'í•˜ì´ë‚œì„±',
            'Chongqing': 'ì¶©ì¹­ì‹œ',
            'Sichuan': 'ì“°ì´¨ì„±',
            'Guizhou': 'êµ¬ì´ì €ìš°ì„±',
            'Yunnan': 'ìœˆë‚œì„±',
            'Tibet': 'í‹°ë² íŠ¸ìì¹˜êµ¬',
            'Shaanxi': 'ì‚°ì‹œì„±(ì„¬ì„œ)',
            'Gansu': 'ê°„ì‘¤ì„±',
            'Qinghai': 'ì¹­í•˜ì´ì„±',
            'Ningxia': 'ë‹ìƒ¤í›„ì´ì¡±ìì¹˜êµ¬',
            'Xinjiang': 'ì‹ ì¥ìœ„êµ¬ë¥´ìì¹˜êµ¬',
            'Hong Kong': 'í™ì½©íŠ¹ë³„í–‰ì •êµ¬',
            'Macau': 'ë§ˆì¹´ì˜¤íŠ¹ë³„í–‰ì •êµ¬',
            'Taiwan': 'íƒ€ì´ì™„'
        };
        if (mapZhToKo[rawName]) return mapZhToKo[rawName];
        if (mapEnToKo[rawName]) return mapEnToKo[rawName];
        return rawName;
    }

    // ì¤‘êµ­ ë°ì´í„° ë¡œë“œ (ì„± ë‹¨ìœ„)
    async loadChinaData() {
        try {
            let geoJsonData;
            
            if (this.cachedGeoJsonData['china']) {
                geoJsonData = this.cachedGeoJsonData['china'];
            } else {
                // ì¤‘êµ­ ì„±ê¸‰ ê²½ê³„ ë°ì´í„° ë‹¤ì¤‘ ì†ŒìŠ¤ ì‹œë„
                const candidateUrls = [
                    // DataV GeoJSON API (ê¶Œì¥) - ì¼ë¶€ í™˜ê²½ì—ì„œ 403 ë°œìƒ ê°€ëŠ¥
                    'https://geo.datav.aliyun.com/areas_v3/bound/geojson?code=100000_full',
                    // DataV ì •ì  JSON (ë™ì¼ ë°ì´í„° ë‹¤ë¥¸ ì—”ë“œí¬ì¸íŠ¸)
                    'https://geo.datav.aliyun.com/areas_v3/bound/100000_full.json',
                    // Apache ECharts ê³µì‹ ì˜ˆì œ ë°ì´í„°
                    'https://echarts.apache.org/examples/data/asset/geo/CHN.json',
                    // GitHub: ì¤‘êµ­ ì„± GeoJSON (province level)
                    'https://raw.githubusercontent.com/modood/Administrative-divisions-of-China/master/dist/geojson/areas/provinces.geojson',
                    // GitHub: china province geojson alternative
                    'https://raw.githubusercontent.com/hesongshy/China_Province_Line_GeoJSON/master/china_province.geojson',
                    // GitHub: longwosion repo
                    'https://raw.githubusercontent.com/longwosion/geojson-map-china/master/china.json'
                ];
                
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const response = await fetch(url, { cache: 'no-store' });
                        if (!response.ok) throw new Error(`HTTP ${response.status}`);
                        const data = await response.json();
                        // í˜•ì‹ ë‹¨ìˆœ ì •ê·œí™” (FeatureCollection ë³´ì¥)
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = data;
                            console.log('[China] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        // ì¼ë¶€ ì†ŒìŠ¤ëŠ” {features: [...]} í˜•íƒœë§Œ ì œê³µ
                        if (!data.type && Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[China] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        // ECharts ì¼ë¶€ ë°ì´í„°ëŠ” ê°ì²´ì— geoJson í‚¤ë¥¼ ê°€ì§
                        if (data && data.geoJson && data.geoJson.type === 'FeatureCollection' && Array.isArray(data.geoJson.features)) {
                            geoJsonData = data.geoJson;
                            console.log('[China] Loaded (geoJson key) from', url, 'features:', geoJsonData.features.length);
                            break;
                        }
                        // ì¼ë¶€ ì €ì¥ì†ŒëŠ” { geometry: {...}, properties: {...} }ì˜ ë°°ì—´ë§Œ ì œê³µ
                        if (Array.isArray(data) && data.length > 10 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[China] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (err) {
                        lastError = err;
                        console.warn('[China] Failed loading from', url, err);
                    }
                }
                // ë¡œì»¬ í´ë°±
                if (!geoJsonData) {
                    try {
                        const localResp = await fetch('data/china-provinces.geojson', { cache: 'no-store' });
                        if (!localResp.ok) throw new Error(`Local HTTP ${localResp.status}`);
                        const localData = await localResp.json();
                        if (localData && Array.isArray(localData.features) && localData.features.length > 10) {
                            geoJsonData = localData.type ? localData : { type: 'FeatureCollection', features: localData.features };
                            console.log('[China] Loaded from local fallback data/china-provinces.geojson');
                        }
                    } catch (e) {
                        console.warn('[China] Local fallback missing or invalid', e);
                    }
                }
                if (!geoJsonData) {
                    throw lastError || new Error('No China dataset available');
                }
                
                // ì¤‘êµ­ ì„±ê¸‰ í–‰ì •êµ¬ì—­ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const chinaProvinceData = {
                    // í•œì í‘œê¸°
                    'åŒ—äº¬å¸‚': { population: 21893000, area: 16410 },
                    'å¤©æ´¥å¸‚': { population: 13870000, area: 11946 },
                    'ä¸Šæµ·å¸‚': { population: 24870000, area: 6341 },
                    'é‡åº†å¸‚': { population: 32130000, area: 82403 },
                    'æ²³åŒ—çœ': { population: 74610000, area: 187700 },
                    'å±±è¥¿çœ': { population: 34900000, area: 156700 },
                    'è¾½å®çœ': { population: 42380000, area: 148000 },
                    'å‰æ—çœ': { population: 23920000, area: 187400 },
                    'é»‘é¾™æ±Ÿçœ': { population: 30380000, area: 473000 },
                    'æ±Ÿè‹çœ': { population: 85120000, area: 102600 },
                    'æµ™æ±Ÿçœ': { population: 65770000, area: 105500 },
                    'å®‰å¾½çœ': { population: 61130000, area: 139400 },
                    'ç¦å»ºçœ': { population: 42890000, area: 121400 },
                    'æ±Ÿè¥¿çœ': { population: 45380000, area: 166900 },
                    'å±±ä¸œçœ': { population: 101700000, area: 157100 },
                    'æ²³å—çœ': { population: 99000000, area: 167000 },
                    'æ¹–åŒ—çœ': { population: 58060000, area: 185900 },
                    'æ¹–å—çœ': { population: 66440000, area: 211800 },
                    'å¹¿ä¸œçœ': { population: 127000000, area: 179700 },
                    'æµ·å—çœ': { population: 10420000, area: 35400 },
                    'å››å·çœ': { population: 83670000, area: 485000 },
                    'è´µå·çœ': { population: 38640000, area: 176000 },
                    'äº‘å—çœ': { population: 47680000, area: 394000 },
                    'é™•è¥¿çœ': { population: 39520000, area: 205600 },
                    'ç”˜è‚ƒçœ': { population: 25030000, area: 425800 },
                    'é’æµ·çœ': { population: 5920000, area: 721000 },
                    'å†…è’™å¤è‡ªæ²»åŒº': { population: 24040000, area: 1183000 },
                    'å¹¿è¥¿å£®æ—è‡ªæ²»åŒº': { population: 50120000, area: 236700 },
                    'è¥¿è—è‡ªæ²»åŒº': { population: 3660000, area: 1228000 },
                    'å®å¤å›æ—è‡ªæ²»åŒº': { population: 7320000, area: 66400 },
                    'æ–°ç–†ç»´å¾å°”è‡ªæ²»åŒº': { population: 25900000, area: 1664900 },
                    'é¦™æ¸¯ç‰¹åˆ«è¡Œæ”¿åŒº': { population: 7493000, area: 1106 },
                    'æ¾³é—¨ç‰¹åˆ«è¡Œæ”¿åŒº': { population: 682000, area: 33 },
                    'å°æ¹¾çœ': { population: 23410000, area: 36193 },
                    // ì˜ì–´ ì´ë¦„
                    'Beijing': { population: 21893000, area: 16410 },
                    'Tianjin': { population: 13870000, area: 11946 },
                    'Shanghai': { population: 24870000, area: 6341 },
                    'Chongqing': { population: 32130000, area: 82403 },
                    'Hebei': { population: 74610000, area: 187700 },
                    'Shanxi': { population: 34900000, area: 156700 },
                    'Liaoning': { population: 42380000, area: 148000 },
                    'Jilin': { population: 23920000, area: 187400 },
                    'Heilongjiang': { population: 30380000, area: 473000 },
                    'Jiangsu': { population: 85120000, area: 102600 },
                    'Zhejiang': { population: 65770000, area: 105500 },
                    'Anhui': { population: 61130000, area: 139400 },
                    'Fujian': { population: 42890000, area: 121400 },
                    'Jiangxi': { population: 45380000, area: 166900 },
                    'Shandong': { population: 101700000, area: 157100 },
                    'Henan': { population: 99000000, area: 167000 },
                    'Hubei': { population: 58060000, area: 185900 },
                    'Hunan': { population: 66440000, area: 211800 },
                    'Guangdong': { population: 127000000, area: 179700 },
                    'Hainan': { population: 10420000, area: 35400 },
                    'Sichuan': { population: 83670000, area: 485000 },
                    'Guizhou': { population: 38640000, area: 176000 },
                    'Yunnan': { population: 47680000, area: 394000 },
                    'Shaanxi': { population: 39520000, area: 205600 },
                    'Gansu': { population: 25030000, area: 425800 },
                    'Qinghai': { population: 5920000, area: 721000 },
                    'Inner Mongolia': { population: 24040000, area: 1183000 },
                    'Guangxi': { population: 50120000, area: 236700 },
                    'Tibet': { population: 3660000, area: 1228000 },
                    'Ningxia': { population: 7320000, area: 66400 },
                    'Xinjiang': { population: 25900000, area: 1664900 },
                    'Hong Kong': { population: 7493000, area: 1106 },
                    'Macau': { population: 682000, area: 33 },
                    'Taiwan': { population: 23410000, area: 36193 }
                };
                
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const props = feature.properties || {};
                    const rawName = props.name || props.NL_NAME_1 || `Province_${index}`; // ì¤‘êµ­ì–´ëª…
                    const adcode = props.adcode || props.adcode99 || props.ID || `CN_${index}`;
                    const nameEn = props.name_en || props.NAME_1 || '';
                    
                    // ì§€ì—­ ë°ì´í„° ë§¤ì¹­ (ì—¬ëŸ¬ ì´ë¦„ íŒ¨í„´ ì‹œë„)
                    let regionData = null;
                    const searchKeys = [
                        rawName, // í•œì í‘œê¸°
                        nameEn, // ì˜ì–´ ì´ë¦„
                        this.getKoreanProvinceName(rawName) // í•œêµ­ì–´ ì´ë¦„ (í•œìë¡œ ì—­ë³€í™˜ ì‹œë„ëŠ” ì•ˆí•¨)
                    ];
                    
                    for (const key of searchKeys) {
                        if (key && chinaProvinceData[key]) {
                            regionData = chinaProvinceData[key];
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const population = regionData ? regionData.population : (props.population || Math.floor(Math.random() * 30000000) + 3000000);
                    const area = regionData ? regionData.area : (props.area || Math.floor(Math.random() * 500000) + 50000);
                    
                    // ê³ ìœ  ID ìƒì„± (í•œê¸€/ì¤‘ë¬¸ í¬í•¨ ì‹œ ì•ˆì „í•œ í‚¤ë¡œ ë³€í™˜)
                    const baseId = (rawName || adcode).toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    let finalId = baseId || `cn_province_${index}`;
                    let counter = 1;
                    while (idSet.has(finalId)) {
                        finalId = `${baseId}_${counter++}`;
                    }
                    idSet.add(finalId);
                    
                    feature.properties = {
                        ...props,
                        id: finalId,
                        name: rawName,
                        name_ko: this.getKoreanProvinceName(rawName),
                        name_en: nameEn || rawName,
                        country: 'China',
                        country_code: 'CN',
                        admin_level: 'Province',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#45b7d1',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    
                    this.regionData.set(finalId, feature.properties);
                });
                
                this.cachedGeoJsonData['china'] = geoJsonData;
            }
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', {
                    type: 'geojson',
                    data: geoJsonData
                });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            '#45b7d1'
                        ],
                        'fill-opacity': 0.6
                    }
                });
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ì¤‘êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì„±/ìì¹˜êµ¬/ì‹œ');
            this.showNotification(`ì¤‘êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì¤‘êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¤‘êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ (ì—°ë°©ì£¼ì²´ ë‹¨ìœ„: Oblast, Krai, Republic, Federal city ë“±)
    async loadRussiaData() {
        try {
            let geoJsonData;
            
            if (this.cachedGeoJsonData['russia']) {
                geoJsonData = this.cachedGeoJsonData['russia'];
            } else {
                const candidateUrls = [
                    // geoBoundaries RUS ADM1 (ì‹ ë¢°ë„ ë†’ìŒ)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/RUS/ADM1/geoBoundaries-RUS-ADM1.geojson',
                    // Natural Earth admin-1 (ê²½ê³„ í’ˆì§ˆ ì¢‹ìŒ, í¬ë§· ë‹¤ë¥¼ ìˆ˜ ìˆìŒ)
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson',
                    // click_that_hood ëŸ¬ì‹œì•„
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/russia.geojson'
                ];
                
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 50) {
                            geoJsonData = data;
                            console.log('[Russia] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 50) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Russia] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 50 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Russia] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Russia] Failed loading from', url, e);
                    }
                }
                // ë¡œì»¬ í´ë°±
                if (!geoJsonData) {
                    try {
                        const localResp = await fetch('data/russia-regions.geojson', { cache: 'no-store' });
                        if (!localResp.ok) throw new Error(`Local HTTP ${localResp.status}`);
                        const localData = await localResp.json();
                        geoJsonData = localData.type ? localData : { type: 'FeatureCollection', features: localData.features };
                        console.log('[Russia] Loaded from local fallback data/russia-regions.geojson');
                    } catch (e) {
                        console.warn('[Russia] Local fallback missing or invalid', e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Russia dataset available');
                
                // í•„ìš” ì‹œ ëŸ¬ì‹œì•„ë§Œ í•„í„°ë§ (ì¼ë¶€ ì†ŒìŠ¤ëŠ” ì „ì„¸ê³„ admin-1ì„ ë°˜í™˜)
                if (geoJsonData && Array.isArray(geoJsonData.features) && geoJsonData.features.length > 300) {
                    const filtered = geoJsonData.features.filter((feature) => {
                        const p = feature.properties || {};
                        const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                        const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                        const iso2 = (p.iso_a2 || '').toUpperCase();
                        return a3 === 'RUS' || admin === 'Russia' || iso2 === 'RU';
                    });
                    if (filtered.length > 0) {
                        console.log(`[Russia] Filtered Natural Earth/global dataset to Russia only: ${filtered.length} features`);
                        geoJsonData = { type: 'FeatureCollection', features: filtered };
                    }
                }

                // ëŸ¬ì‹œì•„ ì—°ë°©ì£¼ì²´ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const russiaRegionData = {
                    // ì—°ë°©ì‹œ (3ê°œ)
                    'Moscow': { population: 13010000, area: 2561 },
                    'Saint Petersburg': { population: 5617000, area: 1439 },
                    'Sevastopol': { population: 547000, area: 864 },
                    'ĞœĞ¾ÑĞºĞ²Ğ°': { population: 13010000, area: 2561 },
                    'Ğ¡Ğ°Ğ½ĞºÑ‚-ĞŸĞµÑ‚ĞµÑ€Ğ±ÑƒÑ€Ğ³': { population: 5617000, area: 1439 },
                    'Ğ¡ĞµĞ²Ğ°ÑÑ‚Ğ¾Ğ¿Ğ¾Ğ»ÑŒ': { population: 547000, area: 864 },
                    // ê³µí™”êµ­ (22ê°œ)
                    'Republic of Adygea': { population: 447000, area: 7792 },
                    'Republic of Altai': { population: 212000, area: 92600 },
                    'Republic of Bashkortostan': { population: 4040000, area: 142947 },
                    'Republic of Buryatia': { population: 955000, area: 351334 },
                    'Republic of Dagestan': { population: 3160000, area: 50300 },
                    'Republic of Ingushetia': { population: 532000, area: 3625 },
                    'Kabardino-Balkar Republic': { population: 903000, area: 12500 },
                    'Republic of Kalmykia': { population: 271000, area: 74731 },
                    'Karachay-Cherkess Republic': { population: 464000, area: 14100 },
                    'Republic of Karelia': { population: 539000, area: 172400 },
                    'Republic of Komi': { population: 738000, area: 416800 },
                    'Republic of Mari El': { population: 663000, area: 23400 },
                    'Republic of Mordovia': { population: 717000, area: 26200 },
                    'Republic of Sakha (Yakutia)': { population: 991000, area: 3083523 },
                    'Republic of North Ossetiaâ€“Alania': { population: 699000, area: 8000 },
                    'Republic of Tatarstan': { population: 3900000, area: 67836 },
                    'Republic of Tuva': { population: 342000, area: 170500 },
                    'Udmurt Republic': { population: 1460000, area: 42100 },
                    'Republic of Khakassia': { population: 523000, area: 61900 },
                    'Chechen Republic': { population: 1500000, area: 15300 },
                    'Chuvash Republic': { population: 1180000, area: 18300 },
                    'Republic of Crimea': { population: 2420000, area: 26100 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞĞ´Ñ‹Ğ³ĞµÑ': { population: 447000, area: 7792 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞĞ»Ñ‚Ğ°Ğ¹': { population: 212000, area: 92600 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ‘Ğ°ÑˆĞºĞ¾Ñ€Ñ‚Ğ¾ÑÑ‚Ğ°Ğ½': { population: 4040000, area: 142947 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ‘ÑƒÑ€ÑÑ‚Ğ¸Ñ': { population: 955000, area: 351334 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ”Ğ°Ğ³ĞµÑÑ‚Ğ°Ğ½': { population: 3160000, area: 50300 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ˜Ğ½Ğ³ÑƒÑˆĞµÑ‚Ğ¸Ñ': { population: 532000, area: 3625 },
                    'ĞšĞ°Ğ±Ğ°Ñ€Ğ´Ğ¸Ğ½Ğ¾-Ğ‘Ğ°Ğ»ĞºĞ°Ñ€ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 903000, area: 12500 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ°Ğ»Ğ¼Ñ‹ĞºĞ¸Ñ': { population: 271000, area: 74731 },
                    'ĞšĞ°Ñ€Ğ°Ñ‡Ğ°ĞµĞ²Ğ¾-Ğ§ĞµÑ€ĞºĞµÑÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 464000, area: 14100 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ°Ñ€ĞµĞ»Ğ¸Ñ': { population: 539000, area: 172400 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšĞ¾Ğ¼Ğ¸': { population: 738000, area: 416800 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞœĞ°Ñ€Ğ¸Ğ¹ Ğ­Ğ»': { population: 663000, area: 23400 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞœĞ¾Ñ€Ğ´Ğ¾Ğ²Ğ¸Ñ': { population: 717000, area: 26200 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¡Ğ°Ñ…Ğ° (Ğ¯ĞºÑƒÑ‚Ğ¸Ñ)': { population: 991000, area: 3083523 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¡ĞµĞ²ĞµÑ€Ğ½Ğ°Ñ ĞÑĞµÑ‚Ğ¸Ñâ€“ĞĞ»Ğ°Ğ½Ğ¸Ñ': { population: 699000, area: 8000 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¢Ğ°Ñ‚Ğ°Ñ€ÑÑ‚Ğ°Ğ½': { population: 3900000, area: 67836 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¢Ñ‹Ğ²Ğ°': { population: 342000, area: 170500 },
                    'Ğ£Ğ´Ğ¼ÑƒÑ€Ñ‚ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 1460000, area: 42100 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° Ğ¥Ğ°ĞºĞ°ÑĞ¸Ñ': { population: 523000, area: 61900 },
                    'Ğ§ĞµÑ‡ĞµĞ½ÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 1500000, area: 15300 },
                    'Ğ§ÑƒĞ²Ğ°ÑˆÑĞºĞ°Ñ Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ°': { population: 1180000, area: 18300 },
                    'Ğ ĞµÑĞ¿ÑƒĞ±Ğ»Ğ¸ĞºĞ° ĞšÑ€Ñ‹Ğ¼': { population: 2420000, area: 26100 },
                    // ë³€ê²½ì£¼ (9ê°œ)
                    'Altai Krai': { population: 2240000, area: 167996 },
                    'Zabaykalsky Krai': { population: 1030000, area: 431892 },
                    'Kamchatka Krai': { population: 291000, area: 472300 },
                    'Krasnodar Krai': { population: 5830000, area: 76000 },
                    'Krasnoyarsk Krai': { population: 2810000, area: 2366800 },
                    'Perm Krai': { population: 2600000, area: 160600 },
                    'Primorsky Krai': { population: 1890000, area: 165900 },
                    'Stavropol Krai': { population: 2730000, area: 66500 },
                    'Khabarovsk Krai': { population: 1240000, area: 787600 },
                    'ĞĞ»Ñ‚Ğ°Ğ¹ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2240000, area: 167996 },
                    'Ğ—Ğ°Ğ±Ğ°Ğ¹ĞºĞ°Ğ»ÑŒÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 1030000, area: 431892 },
                    'ĞšĞ°Ğ¼Ñ‡Ğ°Ñ‚ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 291000, area: 472300 },
                    'ĞšÑ€Ğ°ÑĞ½Ğ¾Ğ´Ğ°Ñ€ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 5830000, area: 76000 },
                    'ĞšÑ€Ğ°ÑĞ½Ğ¾ÑÑ€ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2810000, area: 2366800 },
                    'ĞŸĞµÑ€Ğ¼ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2600000, area: 160600 },
                    'ĞŸÑ€Ğ¸Ğ¼Ğ¾Ñ€ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 1890000, area: 165900 },
                    'Ğ¡Ñ‚Ğ°Ğ²Ñ€Ğ¾Ğ¿Ğ¾Ğ»ÑŒÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 2730000, area: 66500 },
                    'Ğ¥Ğ°Ğ±Ğ°Ñ€Ğ¾Ğ²ÑĞºĞ¸Ğ¹ ĞºÑ€Ğ°Ğ¹': { population: 1240000, area: 787600 },
                    // ì£¼ (46ê°œ)
                    'Amur Oblast': { population: 780000, area: 363700 },
                    'Arkhangelsk Oblast': { population: 1080000, area: 587400 },
                    'Astrakhan Oblast': { population: 991000, area: 44100 },
                    'Belgorod Oblast': { population: 1550000, area: 27100 },
                    'Bryansk Oblast': { population: 1150000, area: 34900 },
                    'Chelyabinsk Oblast': { population: 3350000, area: 88500 },
                    'Irkutsk Oblast': { population: 2310000, area: 767900 },
                    'Ivanovo Oblast': { population: 990000, area: 21400 },
                    'Kaliningrad Oblast': { population: 1030000, area: 15100 },
                    'Kaluga Oblast': { population: 1010000, area: 29900 },
                    'Kemerovo Oblast': { population: 2530000, area: 95700 },
                    'Kirov Oblast': { population: 1200000, area: 120800 },
                    'Kostroma Oblast': { population: 600000, area: 60200 },
                    'Kurgan Oblast': { population: 780000, area: 71000 },
                    'Kursk Oblast': { population: 1060000, area: 29800 },
                    'Leningrad Oblast': { population: 1940000, area: 83900 },
                    'Lipetsk Oblast': { population: 1110000, area: 24000 },
                    'Magadan Oblast': { population: 130000, area: 462500 },
                    'Moscow Oblast': { population: 8300000, area: 44300 },
                    'Murmansk Oblast': { population: 730000, area: 144900 },
                    'Nizhny Novgorod Oblast': { population: 3130000, area: 74800 },
                    'Novosibirsk Oblast': { population: 2790000, area: 177800 },
                    'Omsk Oblast': { population: 1870000, area: 139700 },
                    'Orenburg Oblast': { population: 1950000, area: 123700 },
                    'Oryol Oblast': { population: 700000, area: 24700 },
                    'Penza Oblast': { population: 1220000, area: 43200 },
                    'Pskov Oblast': { population: 570000, area: 55400 },
                    'Rostov Oblast': { population: 4100000, area: 100800 },
                    'Ryazan Oblast': { population: 1080000, area: 39600 },
                    'Samara Oblast': { population: 3150000, area: 53600 },
                    'Saratov Oblast': { population: 2340000, area: 101200 },
                    'Sakhalin Oblast': { population: 470000, area: 87100 },
                    'Sverdlovsk Oblast': { population: 4230000, area: 194300 },
                    'Smolensk Oblast': { population: 900000, area: 49800 },
                    'Tambov Oblast': { population: 970000, area: 34500 },
                    'Tomsk Oblast': { population: 1050000, area: 314400 },
                    'Tula Oblast': { population: 1460000, area: 25700 },
                    'Tyumen Oblast': { population: 1700000, area: 160100 },
                    'Ulyanovsk Oblast': { population: 1170000, area: 37300 },
                    'Vladimir Oblast': { population: 1320000, area: 29000 },
                    'Volgograd Oblast': { population: 2460000, area: 113900 },
                    'Vologda Oblast': { population: 1080000, area: 145700 },
                    'Voronezh Oblast': { population: 2250000, area: 52200 },
                    'Yaroslavl Oblast': { population: 1200000, area: 36400 },
                    'ĞĞ¼ÑƒÑ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 780000, area: 363700 },
                    'ĞÑ€Ñ…Ğ°Ğ½Ğ³ĞµĞ»ÑŒÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1080000, area: 587400 },
                    'ĞÑÑ‚Ñ€Ğ°Ñ…Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 991000, area: 44100 },
                    'Ğ‘ĞµĞ»Ğ³Ğ¾Ñ€Ğ¾Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1550000, area: 27100 },
                    'Ğ‘Ñ€ÑĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1150000, area: 34900 },
                    'Ğ§ĞµĞ»ÑĞ±Ğ¸Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 3350000, area: 88500 },
                    'Ğ˜Ñ€ĞºÑƒÑ‚ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2310000, area: 767900 },
                    'Ğ˜Ğ²Ğ°Ğ½Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 990000, area: 21400 },
                    'ĞšĞ°Ğ»Ğ¸Ğ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1030000, area: 15100 },
                    'ĞšĞ°Ğ»ÑƒĞ¶ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1010000, area: 29900 },
                    'ĞšĞµĞ¼ĞµÑ€Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2530000, area: 95700 },
                    'ĞšĞ¸Ñ€Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1200000, area: 120800 },
                    'ĞšĞ¾ÑÑ‚Ñ€Ğ¾Ğ¼ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 600000, area: 60200 },
                    'ĞšÑƒÑ€Ğ³Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 780000, area: 71000 },
                    'ĞšÑƒÑ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1060000, area: 29800 },
                    'Ğ›ĞµĞ½Ğ¸Ğ½Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1940000, area: 83900 },
                    'Ğ›Ğ¸Ğ¿ĞµÑ†ĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1110000, area: 24000 },
                    'ĞœĞ°Ğ³Ğ°Ğ´Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 130000, area: 462500 },
                    'ĞœĞ¾ÑĞºĞ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 8300000, area: 44300 },
                    'ĞœÑƒÑ€Ğ¼Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 730000, area: 144900 },
                    'ĞĞ¸Ğ¶ĞµĞ³Ğ¾Ñ€Ğ¾Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 3130000, area: 74800 },
                    'ĞĞ¾Ğ²Ğ¾ÑĞ¸Ğ±Ğ¸Ñ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2790000, area: 177800 },
                    'ĞĞ¼ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1870000, area: 139700 },
                    'ĞÑ€ĞµĞ½Ğ±ÑƒÑ€Ğ³ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1950000, area: 123700 },
                    'ĞÑ€Ğ»Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 700000, area: 24700 },
                    'ĞŸĞµĞ½Ğ·ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1220000, area: 43200 },
                    'ĞŸÑĞºĞ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 570000, area: 55400 },
                    'Ğ Ğ¾ÑÑ‚Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 4100000, area: 100800 },
                    'Ğ ÑĞ·Ğ°Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1080000, area: 39600 },
                    'Ğ¡Ğ°Ğ¼Ğ°Ñ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 3150000, area: 53600 },
                    'Ğ¡Ğ°Ñ€Ğ°Ñ‚Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2340000, area: 101200 },
                    'Ğ¡Ğ°Ñ…Ğ°Ğ»Ğ¸Ğ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 470000, area: 87100 },
                    'Ğ¡Ğ²ĞµÑ€Ğ´Ğ»Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 4230000, area: 194300 },
                    'Ğ¡Ğ¼Ğ¾Ğ»ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 900000, area: 49800 },
                    'Ğ¢Ğ°Ğ¼Ğ±Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 970000, area: 34500 },
                    'Ğ¢Ğ¾Ğ¼ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1050000, area: 314400 },
                    'Ğ¢ÑƒĞ»ÑŒÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1460000, area: 25700 },
                    'Ğ¢ÑĞ¼ĞµĞ½ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1700000, area: 160100 },
                    'Ğ£Ğ»ÑŒÑĞ½Ğ¾Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1170000, area: 37300 },
                    'Ğ’Ğ»Ğ°Ğ´Ğ¸Ğ¼Ğ¸Ñ€ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1320000, area: 29000 },
                    'Ğ’Ğ¾Ğ»Ğ³Ğ¾Ğ³Ñ€Ğ°Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2460000, area: 113900 },
                    'Ğ’Ğ¾Ğ»Ğ¾Ğ³Ğ¾Ğ´ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1080000, area: 145700 },
                    'Ğ’Ğ¾Ñ€Ğ¾Ğ½ĞµĞ¶ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 2250000, area: 52200 },
                    'Ğ¯Ñ€Ğ¾ÑĞ»Ğ°Ğ²ÑĞºĞ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 1200000, area: 36400 },
                    // ìì¹˜ì£¼ (1ê°œ)
                    'Jewish Autonomous Oblast': { population: 153000, area: 36266 },
                    'Ğ•Ğ²Ñ€ĞµĞ¹ÑĞºĞ°Ñ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ğ°Ñ Ğ¾Ğ±Ğ»Ğ°ÑÑ‚ÑŒ': { population: 153000, area: 36266 },
                    // ìì¹˜êµ¬ (4ê°œ)
                    'Chukotka Autonomous Okrug': { population: 50000, area: 721500 },
                    'Khanty-Mansi Autonomous Okrug': { population: 1670000, area: 534800 },
                    'Nenets Autonomous Okrug': { population: 45000, area: 176800 },
                    'Yamalo-Nenets Autonomous Okrug': { population: 540000, area: 769300 },
                    'Ğ§ÑƒĞºĞ¾Ñ‚ÑĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 50000, area: 721500 },
                    'Ğ¥Ğ°Ğ½Ñ‚Ñ‹-ĞœĞ°Ğ½ÑĞ¸Ğ¹ÑĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 1670000, area: 534800 },
                    'ĞĞµĞ½ĞµÑ†ĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 45000, area: 176800 },
                    'Ğ¯Ğ¼Ğ°Ğ»Ğ¾-ĞĞµĞ½ĞµÑ†ĞºĞ¸Ğ¹ Ğ°Ğ²Ñ‚Ğ¾Ğ½Ğ¾Ğ¼Ğ½Ñ‹Ğ¹ Ğ¾ĞºÑ€ÑƒĞ³': { population: 540000, area: 769300 }
                };

                // ì†ì„± ì •ê·œí™”
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const nameCandidates = [p.shapeName, p.name, p.NAME_1, p.NAME, p.region, p.admin, p.provname, `Region_${index}`];
                    const rawName = nameCandidates.find(Boolean);
                    const nameEn = p.NAME_1 || p.name || rawName;
                    
                    // ì§€ì—­ ë°ì´í„° ë§¤ì¹­ (ì—¬ëŸ¬ ì´ë¦„ íŒ¨í„´ ì‹œë„)
                    let regionData = null;
                    const searchKeys = [
                        rawName, // ì›ë³¸ ì´ë¦„
                        nameEn, // ì˜ì–´ ì´ë¦„
                        p.shapeName, // shapeName
                        p.NAME_1, // NAME_1
                        p.NAME // NAME
                    ];
                    
                    for (const key of searchKeys) {
                        if (key && russiaRegionData[key]) {
                            regionData = russiaRegionData[key];
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const population = regionData ? regionData.population : (p.population || Math.floor(Math.random() * 4000000) + 500000);
                    const area = regionData ? regionData.area : (p.area || Math.floor(Math.random() * 800000) + 20000);
                    
                    const baseIdSrc = p.shapeID || p.shapeISO || p.hasc || rawName || `RUS_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `rus_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName, // ì¶”í›„ í•œêµ­ì–´ ë§¤í•‘ ê°€ëŠ¥
                        name_en: nameEn,
                        country: 'Russia',
                        country_code: 'RU',
                        admin_level: 'Federal Subject',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 250000) + 120000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#7d5fff',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['russia'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'], '#ff6b6b', '#7d5fff'
                        ],
                        'fill-opacity': 0.6
                    }
                });
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 }
                });
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: { 'fill-color': '#feca57', 'fill-opacity': 0 },
                    filter: ['==', 'id', '']
                });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì—°ë°©ì£¼ì²´');
            this.showNotification(`ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ëŸ¬ì‹œì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ëŸ¬ì‹œì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¸ë„ ë°ì´í„° ë¡œë“œ (ì£¼/ì—°ë°©ë ¹ ë‹¨ìœ„)
    async loadIndiaData() {
        try {
            let geoJsonData;
            
            // ì¸ë„ ì£¼/ì—°ë°©ë ¹ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
            const indiaRegionData = {
                // ì£¼ (28ê°œ)
                'Andhra Pradesh': { population: 52000000, area: 162970 },
                'Arunachal Pradesh': { population: 1700000, area: 83743 },
                'Assam': { population: 36100000, area: 78438 },
                'Bihar': { population: 128000000, area: 94163 },
                'Chhattisgarh': { population: 30000000, area: 135194 },
                'Goa': { population: 1600000, area: 3702 },
                'Gujarat': { population: 70600000, area: 196024 },
                'Haryana': { population: 29000000, area: 44212 },
                'Himachal Pradesh': { population: 7700000, area: 55673 },
                'Jharkhand': { population: 39500000, area: 79714 },
                'Karnataka': { population: 67600000, area: 191791 },
                'Kerala': { population: 35400000, area: 38852 },
                'Madhya Pradesh': { population: 85300000, area: 308252 },
                'Maharashtra': { population: 126700000, area: 307713 },
                'Manipur': { population: 3300000, area: 22327 },
                'Meghalaya': { population: 3600000, area: 22429 },
                'Mizoram': { population: 1300000, area: 21081 },
                'Nagaland': { population: 2200000, area: 16579 },
                'Odisha': { population: 47500000, area: 155707 },
                'Punjab': { population: 30300000, area: 50362 },
                'Rajasthan': { population: 81000000, area: 342239 },
                'Sikkim': { population: 700000, area: 7096 },
                'Tamil Nadu': { population: 78800000, area: 130058 },
                'Telangana': { population: 39100000, area: 112077 },
                'Tripura': { population: 4200000, area: 10486 },
                'Uttar Pradesh': { population: 240000000, area: 240928 },
                'Uttarakhand': { population: 11500000, area: 53483 },
                'West Bengal': { population: 100300000, area: 88752 },
                // ì—°ë°©ë ¹ (8ê°œ)
                'Andaman and Nicobar Islands': { population: 380000, area: 8249 },
                'Chandigarh': { population: 1200000, area: 114 },
                'Dadra and Nagar Haveli and Daman and Diu': { population: 970000, area: 603 },
                'Delhi': { population: 19600000, area: 1484 },
                'Delhi (National Capital Territory)': { population: 19600000, area: 1484 },
                'Jammu and Kashmir': { population: 13600000, area: 55538 },
                'Ladakh': { population: 320000, area: 59146 },
                'Lakshadweep': { population: 70000, area: 32 },
                'Puducherry': { population: 1700000, area: 490 },
                // íŒë””ì–´ ì´ë¦„ë„ ë§¤ì¹­ ê°€ëŠ¥í•˜ë„ë¡ ì¶”ê°€
                'à¤†à¤‚à¤§à¥à¤° à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 52000000, area: 162970 },
                'à¤…à¤°à¥à¤£à¤¾à¤šà¤² à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 1700000, area: 83743 },
                'à¤…à¤¸à¤®': { population: 36100000, area: 78438 },
                'à¤¬à¤¿à¤¹à¤¾à¤°': { population: 128000000, area: 94163 },
                'à¤›à¤¤à¥à¤¤à¥€à¤¸à¤—à¤¢à¤¼': { population: 30000000, area: 135194 },
                'à¤—à¥‹à¤µà¤¾': { population: 1600000, area: 3702 },
                'à¤—à¥à¤œà¤°à¤¾à¤¤': { population: 70600000, area: 196024 },
                'à¤¹à¤°à¤¿à¤¯à¤¾à¤£à¤¾': { population: 29000000, area: 44212 },
                'à¤¹à¤¿à¤®à¤¾à¤šà¤² à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 7700000, area: 55673 },
                'à¤à¤¾à¤°à¤–à¤‚à¤¡': { population: 39500000, area: 79714 },
                'à¤•à¤°à¥à¤¨à¤¾à¤Ÿà¤•': { population: 67600000, area: 191791 },
                'à¤•à¥‡à¤°à¤²': { population: 35400000, area: 38852 },
                'à¤®à¤§à¥à¤¯ à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 85300000, area: 308252 },
                'à¤®à¤¹à¤¾à¤°à¤¾à¤·à¥à¤Ÿà¥à¤°': { population: 126700000, area: 307713 },
                'à¤®à¤£à¤¿à¤ªà¥à¤°': { population: 3300000, area: 22327 },
                'à¤®à¥‡à¤˜à¤¾à¤²à¤¯': { population: 3600000, area: 22429 },
                'à¤®à¤¿à¤œà¤¼à¥‹à¤°à¤®': { population: 1300000, area: 21081 },
                'à¤¨à¤¾à¤—à¤¾à¤²à¥ˆà¤‚à¤¡': { population: 2200000, area: 16579 },
                'à¤“à¤¡à¤¿à¤¶à¤¾': { population: 47500000, area: 155707 },
                'à¤ªà¤‚à¤œà¤¾à¤¬': { population: 30300000, area: 50362 },
                'à¤°à¤¾à¤œà¤¸à¥à¤¥à¤¾à¤¨': { population: 81000000, area: 342239 },
                'à¤¸à¤¿à¤•à¥à¤•à¤¿à¤®': { population: 700000, area: 7096 },
                'à¤¤à¤®à¤¿à¤²à¤¨à¤¾à¤¡à¥': { population: 78800000, area: 130058 },
                'à¤¤à¥‡à¤²à¤‚à¤—à¤¾à¤¨à¤¾': { population: 39100000, area: 112077 },
                'à¤¤à¥à¤°à¤¿à¤ªà¥à¤°à¤¾': { population: 4200000, area: 10486 },
                'à¤‰à¤¤à¥à¤¤à¤° à¤ªà¥à¤°à¤¦à¥‡à¤¶': { population: 240000000, area: 240928 },
                'à¤‰à¤¤à¥à¤¤à¤°à¤¾à¤–à¤‚à¤¡': { population: 11500000, area: 53483 },
                'à¤ªà¤¶à¥à¤šà¤¿à¤® à¤¬à¤‚à¤—à¤¾à¤²': { population: 100300000, area: 88752 },
                'à¤…à¤‚à¤¡à¤®à¤¾à¤¨ à¤”à¤° à¤¨à¤¿à¤•à¥‹à¤¬à¤¾à¤° à¤¦à¥à¤µà¥€à¤ªà¤¸à¤®à¥‚à¤¹': { population: 380000, area: 8249 },
                'à¤šà¤‚à¤¡à¥€à¤—à¤¢à¤¼': { population: 1200000, area: 114 },
                'à¤¦à¤¾à¤¦à¤°à¤¾ à¤”à¤° à¤¨à¤—à¤° à¤¹à¤µà¥‡à¤²à¥€ à¤”à¤° à¤¦à¤®à¤¨ à¤”à¤° à¤¦à¥€à¤µ': { population: 970000, area: 603 },
                'à¤¦à¤¿à¤²à¥à¤²à¥€': { population: 19600000, area: 1484 },
                'à¤œà¤®à¥à¤®à¥‚ à¤”à¤° à¤•à¤¶à¥à¤®à¥€à¤°': { population: 13600000, area: 55538 },
                'à¤²à¤¦à¥à¤¦à¤¾à¤–à¤¼': { population: 320000, area: 59146 },
                'à¤²à¤•à¥à¤·à¤¦à¥à¤µà¥€à¤ª': { population: 70000, area: 32 },
                'à¤ªà¥à¤¦à¥à¤šà¥‡à¤°à¥€': { population: 1700000, area: 490 }
            };
            
            if (this.cachedGeoJsonData['india']) {
                geoJsonData = this.cachedGeoJsonData['india'];
            } else {
                const candidateUrls = [
                    // geoBoundaries IND ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/IND/ADM1/geoBoundaries-IND-ADM1.geojson',
                    // click_that_hood india
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/india.geojson',
                    // Humanitarian Data Exchange mirror via GitHub
                    'https://raw.githubusercontent.com/datasets/geo-admin1-us/master/data/india_states.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 25) {
                            geoJsonData = data;
                            console.log('[India] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 25) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[India] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 25 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[India] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[India] Failed loading from', url, e);
                    }
                }
                // ë¡œì»¬ í´ë°±
                if (!geoJsonData) {
                    try {
                        const localResp = await fetch('data/india-states.geojson', { cache: 'no-store' });
                        if (!localResp.ok) throw new Error(`Local HTTP ${localResp.status}`);
                        const localData = await localResp.json();
                        geoJsonData = localData.type ? localData : { type: 'FeatureCollection', features: localData.features };
                        console.log('[India] Loaded from local fallback data/india-states.geojson');
                    } catch (e) {
                        console.warn('[India] Local fallback missing or invalid', e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No India dataset available');
                
                // ì†ì„± ì •ê·œí™”
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.st_nm || p.state || p.NAME_1 || p.name || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `IND_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `ind_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                    const searchKeys = [
                        rawName,
                        p.st_nm,
                        p.state,
                        p.NAME_1,
                        p.name,
                        p.name_en,
                        p.name_hi,
                        rawName.trim(),
                        rawName.replace(/\s+/g, ' '),
                        rawName.replace(/\(.*?\)/g, '').trim() // ê´„í˜¸ ë‚´ìš© ì œê±°
                    ].filter(key => key && typeof key === 'string');
                    
                    let regionData = null;
                    for (const key of searchKeys) {
                        if (indiaRegionData[key]) {
                            regionData = indiaRegionData[key];
                            break;
                        }
                    }
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const stateData = regionData || { 
                        population: Math.floor(Math.random() * 30000000) + 500000, 
                        area: Math.floor(Math.random() * 400000) + 10000 
                    };
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName, // ì¶”í›„ í•œêµ­ì–´ í‘œê¸° ë§¤í•‘ ê°€ëŠ¥
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'India',
                        country_code: 'IN',
                        admin_level: 'State/UT',
                        population: stateData.population,
                        area: stateData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ff9f43',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['india'] = geoJsonData;
            }
            
            // ìºì‹œì—ì„œ ë¡œë“œí•œ ê²½ìš°ì—ë„ ì¸êµ¬/ë©´ì  ì—…ë°ì´íŠ¸ (ë°ì´í„° ê°ì²´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            if (geoJsonData && geoJsonData.features) {
                geoJsonData.features.forEach((feature) => {
                    const p = feature.properties || {};
                    const rawName = p.st_nm || p.state || p.NAME_1 || p.name || p.name_en;
                    
                    if (rawName) {
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.st_nm,
                            p.state,
                            p.NAME_1,
                            p.name,
                            p.name_en,
                            p.name_hi,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' '),
                            rawName.replace(/\(.*?\)/g, '').trim() // ê´„í˜¸ ë‚´ìš© ì œê±°
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (indiaRegionData[key]) {
                                regionData = indiaRegionData[key];
                                break;
                            }
                        }
                        
                        if (regionData) {
                            feature.properties.population = regionData.population;
                            feature.properties.area = regionData.area;
                            // regionDataë„ ì—…ë°ì´íŠ¸
                            if (feature.properties.id) {
                                const regionInfo = this.regionData.get(feature.properties.id);
                                if (regionInfo) {
                                    regionInfo.population = regionData.population;
                                    regionInfo.area = regionData.area;
                                    this.regionData.set(feature.properties.id, regionInfo);
                                }
                            }
                        }
                    }
                });
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ff9f43'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì¸ë„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼/ì—°ë°©ë ¹');
            this.showNotification(`ì¸ë„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì¸ë„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¸ë„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ (ì£¼/ì˜í†  ë‹¨ìœ„)
    async loadCanadaData() {
        try {
            let geoJsonData;
            
            // ìºë‚˜ë‹¤ ì£¼/ì˜í† ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
            const canadaRegionData = {
                // ì£¼ (10ê°œ)
                'Ontario': { population: 15996989, area: 1076395 },
                'Quebec': { population: 9030684, area: 1542056 },
                'British Columbia': { population: 5646467, area: 944735 },
                'Alberta': { population: 4849906, area: 661848 },
                'Manitoba': { population: 1484135, area: 647797 },
                'Saskatchewan': { population: 1231043, area: 591670 },
                'Nova Scotia': { population: 1072545, area: 55284 },
                'New Brunswick': { population: 850894, area: 71388 },
                'Newfoundland and Labrador': { population: 541391, area: 405212 },
                'Prince Edward Island': { population: 177081, area: 5660 },
                // ì˜í†  (3ê°œ)
                'Northwest Territories': { population: 46000, area: 1346106 },
                'Nunavut': { population: 40000, area: 2093190 },
                'Yukon': { population: 45000, area: 482443 }
            };
            
            if (this.cachedGeoJsonData['canada']) {
                geoJsonData = this.cachedGeoJsonData['canada'];
            } else {
                const candidateUrls = [
                    // geoBoundaries CAN ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/CAN/ADM1/geoBoundaries-CAN-ADM1.geojson',
                    // click_that_hood canada
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/canada.geojson',
                    // Natural Earth Canada provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ìºë‚˜ë‹¤ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'CAN' || admin === 'Canada' || iso2 === 'CA';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Canada] Filtered Natural Earth/global dataset to Canada only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = data;
                            console.log('[Canada] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Canada] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 10 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Canada] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Canada] Failed loading from', url, e);
                    }
                }
                // ë¡œì»¬ í´ë°±
                if (!geoJsonData) {
                    try {
                        const localResp = await fetch('data/canada-provinces.geojson', { cache: 'no-store' });
                        if (!localResp.ok) throw new Error(`Local HTTP ${localResp.status}`);
                        const localData = await localResp.json();
                        geoJsonData = localData.type ? localData : { type: 'FeatureCollection', features: localData.features };
                        console.log('[Canada] Loaded from local fallback data/canada-provinces.geojson');
                    } catch (e) {
                        console.warn('[Canada] Local fallback missing or invalid', e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Canada dataset available');
                
                // ì†ì„± ì •ê·œí™”
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || p.shapeName || `Province_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || p.shapeISO || rawName || `CAN_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `can_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                    const searchKeys = [
                        rawName,
                        p.name,
                        p.NAME_1,
                        p.province,
                        p.shapeName,
                        rawName.trim(),
                        rawName.replace(/\s+/g, ' ')
                    ].filter(key => key && typeof key === 'string');
                    
                    let regionData = null;
                    for (const key of searchKeys) {
                        if (canadaRegionData[key]) {
                            regionData = canadaRegionData[key];
                            break;
                        }
                    }
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const provinceData = regionData || { 
                        population: Math.floor(Math.random() * 5000000) + 50000, 
                        area: Math.floor(Math.random() * 1500000) + 50000 
                    };
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName, // ì¶”í›„ í•œêµ­ì–´ í‘œê¸° ë§¤í•‘ ê°€ëŠ¥
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Canada',
                        country_code: 'CA',
                        admin_level: 'Province/Territory',
                        population: provinceData.population,
                        area: provinceData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#e74c3c',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['canada'] = geoJsonData;
            }
            
            // ìºì‹œì—ì„œ ë¡œë“œí•œ ê²½ìš°ì—ë„ ì¸êµ¬/ë©´ì  ì—…ë°ì´íŠ¸ (ë°ì´í„° ê°ì²´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            if (geoJsonData && geoJsonData.features) {
                geoJsonData.features.forEach((feature) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || p.shapeName || p.name_en;
                    
                    if (rawName) {
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.name,
                            p.NAME_1,
                            p.province,
                            p.shapeName,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' ')
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (canadaRegionData[key]) {
                                regionData = canadaRegionData[key];
                                break;
                            }
                        }
                        
                        if (regionData) {
                            feature.properties.population = regionData.population;
                            feature.properties.area = regionData.area;
                            // regionDataë„ ì—…ë°ì´íŠ¸
                            if (feature.properties.id) {
                                const regionInfo = this.regionData.get(feature.properties.id);
                                if (regionInfo) {
                                    regionInfo.population = regionData.population;
                                    regionInfo.area = regionData.area;
                                    this.regionData.set(feature.properties.id, regionInfo);
                                }
                            }
                        }
                    }
                });
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#e74c3c'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼/ì˜í† ');
            this.showNotification(`ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìºë‚˜ë‹¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìºë‚˜ë‹¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë…ì¼ ë°ì´í„° ë¡œë“œ (ì£¼/Bundesland ë‹¨ìœ„)
    async loadGermanyData() {
        try {
            let geoJsonData;
            
            // ë…ì¼ ì£¼ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
            const germanyRegionData = {
                'Baden-WÃ¼rttemberg': { population: 11350000, area: 35751 },
                'Bayern': { population: 13450000, area: 70550 },
                'Bavaria': { population: 13450000, area: 70550 },
                'Berlin': { population: 3850000, area: 891 },
                'Brandenburg': { population: 2610000, area: 29654 },
                'Bremen': { population: 680000, area: 419 },
                'Hamburg': { population: 1910000, area: 755 },
                'Hessen': { population: 6390000, area: 21115 },
                'Hesse': { population: 6390000, area: 21115 },
                'Mecklenburg-Vorpommern': { population: 1610000, area: 23295 },
                'Niedersachsen': { population: 8050000, area: 47614 },
                'Lower Saxony': { population: 8050000, area: 47614 },
                'Nordrhein-Westfalen': { population: 18220000, area: 34112 },
                'North Rhine-Westphalia': { population: 18220000, area: 34112 },
                'Rheinland-Pfalz': { population: 4180000, area: 19854 },
                'Rhineland-Palatinate': { population: 4180000, area: 19854 },
                'Saarland': { population: 970000, area: 2569 },
                'Sachsen': { population: 4080000, area: 18415 },
                'Saxony': { population: 4080000, area: 18415 },
                'Sachsen-Anhalt': { population: 2150000, area: 20451 },
                'Saxony-Anhalt': { population: 2150000, area: 20451 },
                'Schleswig-Holstein': { population: 2950000, area: 15802 },
                'ThÃ¼ringen': { population: 2070000, area: 16172 },
                'Thuringia': { population: 2070000, area: 16172 }
            };
            
            if (this.cachedGeoJsonData['germany']) {
                geoJsonData = this.cachedGeoJsonData['germany'];
            } else {
                const candidateUrls = [
                    // geoBoundaries DEU ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/DEU/ADM1/geoBoundaries-DEU-ADM1.geojson',
                    // click_that_hood germany
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/germany.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = data;
                            console.log('[Germany] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Germany] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 10 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Germany] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Germany] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Germany dataset available');
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `DEU_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `deu_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                    const searchKeys = [
                        rawName,
                        p.name,
                        p.NAME_1,
                        p.state,
                        rawName.trim(),
                        rawName.replace(/\s+/g, ' ')
                    ].filter(key => key && typeof key === 'string');
                    
                    let regionData = null;
                    for (const key of searchKeys) {
                        if (germanyRegionData[key]) {
                            regionData = germanyRegionData[key];
                            break;
                        }
                    }
                    
                    // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©)
                    const stateData = regionData || { 
                        population: Math.floor(Math.random() * 3000000) + 500000, 
                        area: Math.floor(Math.random() * 50000) + 2000 
                    };
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Germany',
                        country_code: 'DE',
                        admin_level: 'State',
                        population: stateData.population,
                        area: stateData.area,
                        ad_status: 'available',
                        ad_price: 50000 + (index * 5000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ffd93d',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['germany'] = geoJsonData;
            }
            
            // ìºì‹œì—ì„œ ë¡œë“œí•œ ê²½ìš°ì—ë„ ì¸êµ¬/ë©´ì  ì—…ë°ì´íŠ¸ (ë°ì´í„° ê°ì²´ëŠ” ì´ë¯¸ ìœ„ì—ì„œ ì •ì˜ë¨)
            if (geoJsonData && geoJsonData.features) {
                geoJsonData.features.forEach((feature) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || p.name_en;
                    
                    if (rawName) {
                        // ì‹¤ì œ ë°ì´í„°ì—ì„œ ê°’ ì°¾ê¸° (ì—¬ëŸ¬ ì´ë¦„ ë³€í˜• ì‹œë„)
                        const searchKeys = [
                            rawName,
                            p.name,
                            p.NAME_1,
                            p.state,
                            rawName.trim(),
                            rawName.replace(/\s+/g, ' ')
                        ].filter(key => key && typeof key === 'string');
                        
                        let regionData = null;
                        for (const key of searchKeys) {
                            if (germanyRegionData[key]) {
                                regionData = germanyRegionData[key];
                                break;
                            }
                        }
                        
                        if (regionData) {
                            feature.properties.population = regionData.population;
                            feature.properties.area = regionData.area;
                            // regionDataë„ ì—…ë°ì´íŠ¸
                            if (feature.properties.id) {
                                const regionInfo = this.regionData.get(feature.properties.id);
                                if (regionInfo) {
                                    regionInfo.population = regionData.population;
                                    regionInfo.area = regionData.area;
                                    this.regionData.set(feature.properties.id, regionInfo);
                                }
                            }
                        }
                    }
                });
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ffd93d'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë…ì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë…ì¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë…ì¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë…ì¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì˜êµ­ ë°ì´í„° ë¡œë“œ (ì§€ì—­/ì¹´ìš´í‹° ë‹¨ìœ„)
    async loadUKData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['uk']) {
                geoJsonData = this.cachedGeoJsonData['uk'];
            } else {
                const candidateUrls = [
                    // geoBoundaries GBR ADM1 (ìƒìœ„ ë ˆë²¨ í–‰ì •êµ¬ì—­)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/GBR/ADM1/geoBoundaries-GBR-ADM1.geojson',
                    // Natural Earth UK regions (í•„í„°ë§ í•„ìš”)
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // geoBoundaries ADM1 ë°ì´í„°ëŠ” ì´ë¯¸ í° ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ ìˆìŒ
                        if (url.includes('geoBoundaries') && data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 2 && data.features.length < 50) {
                            geoJsonData = data;
                            console.log('[UK] Loaded from geoBoundaries ADM1:', url, 'features:', data.features.length);
                            break;
                        }
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì˜êµ­ë§Œ í•„í„°ë§ (í° ë‹¨ìœ„ë¡œ ê·¸ë£¹í™” í•„ìš”)
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'GBR' || admin === 'United Kingdom' || iso2 === 'GB';
                            });
                            if (filtered.length > 0 && filtered.length < 50) {
                                // ì´ë¯¸ í° ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                                console.log(`[UK] Filtered Natural Earth/global dataset to UK only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            } else if (filtered.length > 50) {
                                // ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ë‰˜ì–´ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš”
                                console.log(`[UK] Filtered Natural Earth/global dataset to UK: ${filtered.length} features - will group`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                // ì•„ë˜ ê·¸ë£¹í™” ë¡œì§ìœ¼ë¡œ ì§„í–‰
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 2) {
                            geoJsonData = data;
                            console.log('[UK] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 2) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[UK] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 2 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[UK] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[UK] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No UK dataset available');
                
                // 50ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš”
                const needsGrouping = geoJsonData.features && geoJsonData.features.length > 50;
                
                if (needsGrouping) {
                // ì˜êµ­ ì§€ì—­ì„ ë” í° ë‹¨ìœ„ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                // ì‰ê¸€ëœë“œ ì§€ì—­ë“¤ì„ 9ê°œ ì§€ì—­ìœ¼ë¡œ, ìŠ¤ì½”í‹€ëœë“œ/ì›¨ì¼ìŠ¤/ë¶ì•„ì¼ëœë“œëŠ” ê°ê° í•˜ë‚˜ë¡œ í†µí•©
                const ukRegionMapping = {
                    // England Regions (9ê°œ)
                    'North East': ['Northumberland', 'County Durham', 'Tyne and Wear', 'Tees Valley', 'North East England'],
                    'North West': ['Greater Manchester', 'Merseyside', 'Lancashire', 'Cumbria', 'Cheshire', 'North West England'],
                    'Yorkshire and the Humber': ['West Yorkshire', 'South Yorkshire', 'East Riding of Yorkshire', 'North Yorkshire', 'Yorkshire and the Humber'],
                    'East Midlands': ['Derbyshire', 'Nottinghamshire', 'Lincolnshire', 'Leicestershire', 'Rutland', 'Northamptonshire', 'East Midlands'],
                    'West Midlands': ['West Midlands', 'Warwickshire', 'Staffordshire', 'Shropshire', 'Herefordshire', 'Worcestershire'],
                    'East of England': ['Norfolk', 'Suffolk', 'Cambridgeshire', 'Essex', 'Hertfordshire', 'Bedfordshire', 'East of England'],
                    'London': ['Greater London', 'London', 'Inner London', 'Outer London'],
                    'South East': ['Kent', 'Surrey', 'East Sussex', 'West Sussex', 'Hampshire', 'Isle of Wight', 'Berkshire', 'Oxfordshire', 'Buckinghamshire', 'South East England'],
                    'South West': ['Gloucestershire', 'Wiltshire', 'Somerset', 'Dorset', 'Devon', 'Cornwall', 'South West England'],
                    // Scotland
                    'Scotland': ['Scotland', 'Highland', 'Aberdeenshire', 'Perth and Kinross', 'Argyll and Bute', 'Scottish Borders', 'Dumfries and Galloway', 'Fife', 'Edinburgh', 'Glasgow'],
                    // Wales
                    'Wales': ['Wales', 'Gwynedd', 'Conwy', 'Denbighshire', 'Flintshire', 'Wrexham', 'Powys', 'Ceredigion', 'Pembrokeshire', 'Carmarthenshire', 'Swansea', 'Cardiff'],
                    // Northern Ireland
                    'Northern Ireland': ['Northern Ireland', 'Antrim', 'Armagh', 'Down', 'Fermanagh', 'Londonderry', 'Tyrone', 'Belfast']
                };
                
                // ì—­ë§¤í•‘ ìƒì„± (ì†Œì§€ì—­ -> ëŒ€ì§€ì—­)
                const reverseMapping = {};
                Object.keys(ukRegionMapping).forEach(region => {
                    ukRegionMapping[region].forEach(subRegion => {
                        reverseMapping[subRegion.toLowerCase()] = region;
                        // ì—¬ëŸ¬ ë³€í˜•ë„ ì¶”ê°€
                        reverseMapping[subRegion.toLowerCase().replace(/\s+/g, ' ')] = region;
                        reverseMapping[subRegion.toLowerCase().replace(/[^\w\s]/g, '')] = region;
                    });
                });
                
                // ì§€ì—­ ê·¸ë£¹í™”
                const groupedFeatures = new Map();
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.country || `Region_${index}`;
                    const nameLower = rawName.toLowerCase().trim();
                    
                    // ê·¸ë£¹ ì°¾ê¸°
                    let groupName = null;
                    for (const [key, value] of Object.entries(reverseMapping)) {
                        if (nameLower.includes(key) || key.includes(nameLower)) {
                            groupName = value;
                            break;
                        }
                    }
                    
                    // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                    if (!groupName) {
                        if (nameLower.includes('england') || nameLower.includes('london') || 
                            nameLower.includes('yorkshire') || nameLower.includes('midlands') ||
                            nameLower.includes('south') || nameLower.includes('north') ||
                            nameLower.includes('east') || nameLower.includes('west')) {
                            // ì‰ê¸€ëœë“œ ì§€ì—­ ë§¤ì¹­ ì‹œë„
                            for (const [region, subRegions] of Object.entries(ukRegionMapping)) {
                                if (region !== 'Scotland' && region !== 'Wales' && region !== 'Northern Ireland') {
                                    if (subRegions.some(sub => nameLower.includes(sub.toLowerCase()))) {
                                        groupName = region;
                                        break;
                                    }
                                }
                            }
                            if (!groupName) {
                                // ì‰ê¸€ëœë“œ ì§€ì—­ëª… ì§ì ‘ ë§¤ì¹­
                                if (nameLower.includes('london')) groupName = 'London';
                                else if (nameLower.includes('north east')) groupName = 'North East';
                                else if (nameLower.includes('north west')) groupName = 'North West';
                                else if (nameLower.includes('yorkshire')) groupName = 'Yorkshire and the Humber';
                                else if (nameLower.includes('east midlands')) groupName = 'East Midlands';
                                else if (nameLower.includes('west midlands')) groupName = 'West Midlands';
                                else if (nameLower.includes('east of england')) groupName = 'East of England';
                                else if (nameLower.includes('south east')) groupName = 'South East';
                                else if (nameLower.includes('south west')) groupName = 'South West';
                            }
                        } else if (nameLower.includes('scotland') || nameLower.includes('scottish') || nameLower.includes('edinburgh') || nameLower.includes('glasgow')) {
                            groupName = 'Scotland';
                        } else if (nameLower.includes('wales') || nameLower.includes('welsh') || nameLower.includes('cardiff')) {
                            groupName = 'Wales';
                        } else if (nameLower.includes('northern ireland') || nameLower.includes('belfast')) {
                            groupName = 'Northern Ireland';
                        }
                    }
                    
                    // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš°
                    if (!groupName) {
                        // ì§€ì—­ëª…ì„ ì½˜ì†”ì— ì¶œë ¥í•˜ì—¬ ë§¤í•‘ ì¶”ê°€ í•„ìš” ì—¬ë¶€ í™•ì¸
                        console.warn(`[UK] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­: "${rawName}"`);
                        // ì¼ë‹¨ Englandë¡œ ë¶„ë¥˜í•˜ë˜, ë‚˜ì¤‘ì— ìˆ˜ë™ìœ¼ë¡œ ë§¤í•‘ ê°€ëŠ¥í•˜ë„ë¡
                        groupName = 'Unmatched';
                    }
                    
                    if (!groupedFeatures.has(groupName)) {
                        groupedFeatures.set(groupName, {
                            features: [],
                            totalPopulation: 0,
                            totalArea: 0
                        });
                    }
                    
                    const group = groupedFeatures.get(groupName);
                    group.features.push(feature);
                    group.totalPopulation += (p.population || 0);
                    group.totalArea += (p.area || 0);
                });
                
                // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                const mergedFeatures = [];
                const unmatchedGroups = [];
                
                groupedFeatures.forEach((group, groupName) => {
                    if (group.features.length === 0) return;
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê·¸ë£¹ì€ ê±´ë„ˆë›°ê¸°
                    if (groupName === 'Unmatched') {
                        unmatchedGroups.push(group);
                        return;
                    }
                    
                    // Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                    const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                    
                    if (geometries.length === 0) {
                        console.warn(`[UK] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                        return;
                    }
                    
                    let mergedGeometry;
                    if (geometries.length === 1) {
                        mergedGeometry = geometries[0];
                    } else {
                        const allCoordinates = [];
                        geometries.forEach(g => {
                            if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                allCoordinates.push(g.coordinates);
                            } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                allCoordinates.push(...g.coordinates);
                            }
                        });
                        if (allCoordinates.length === 1) {
                            mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                        } else if (allCoordinates.length > 1) {
                            mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                        } else {
                            // geometryê°€ ì—†ìœ¼ë©´ ì²« ë²ˆì§¸ featureì˜ geometry ì‚¬ìš©
                            mergedGeometry = geometries[0];
                        }
                    }
                    
                    // Geometry ê²€ì¦
                    if (!mergedGeometry || !mergedGeometry.coordinates || 
                        (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                        (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                        console.warn(`[UK] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                        return;
                    }
                    
                    const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                    let finalId = baseId;
                    let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    mergedFeatures.push({
                        type: 'Feature',
                        geometry: mergedGeometry,
                        properties: {
                        id: finalId,
                            name: groupName,
                            name_ko: groupName,
                            name_en: groupName,
                        country: 'United Kingdom',
                        country_code: 'GB',
                        admin_level: 'Region/Country',
                            population: Math.max(group.totalPopulation, Math.floor(Math.random() * 10000000) + 1000000),
                            area: Math.max(group.totalArea, Math.floor(Math.random() * 200000) + 10000),
                        ad_status: 'available',
                            ad_price: 50000 + (mergedFeatures.length * 10000),
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#6c5ce7',
                        border_color: '#ffffff',
                            border_width: 1,
                            original_count: group.features.length // ì›ë³¸ ì§€ì—­ ê°œìˆ˜
                        }
                    });
                    
                    this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                });
                
                // ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­ë“¤ ì²˜ë¦¬
                if (unmatchedGroups.length > 0) {
                    console.warn(`[UK] ${unmatchedGroups.reduce((sum, g) => sum + g.features.length, 0)}ê°œ ì§€ì—­ì´ ë§¤ì¹­ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                    unmatchedGroups.forEach(group => {
                        group.features.forEach(feature => {
                            const p = feature.properties || {};
                            console.warn(`  - "${p.name || p.NAME_1 || 'Unknown'}"`);
                        });
                    });
                }
                
                console.log(`[UK] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${geoJsonData.features.length}ê°œ)`);
                
                geoJsonData = {
                    type: 'FeatureCollection',
                    features: mergedFeatures
                };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    const idSet = new Set();
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.country || `Region_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `GBR_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `gbr_region_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'United Kingdom',
                            country_code: 'GB',
                            admin_level: 'Region/Country',
                            population: p.population || Math.floor(Math.random() * 10000000) + 1000000,
                            area: p.area || Math.floor(Math.random() * 200000) + 10000,
                            ad_status: 'available',
                            ad_price: 50000 + (index * 10000),
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#6c5ce7',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                
                this.cachedGeoJsonData['uk'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#6c5ce7'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì˜êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
            console.log('ì˜êµ­ ë°ì´í„° ìƒ˜í”Œ:', geoJsonData.features.slice(0, 3).map(f => ({
                name: f.properties.name,
                hasGeometry: !!f.geometry,
                geometryType: f.geometry?.type,
                coordinatesLength: f.geometry?.coordinates?.length
            })));
            
            // Geometry ê²€ì¦
            const invalidFeatures = geoJsonData.features.filter(f => !f.geometry || !f.geometry.coordinates || f.geometry.coordinates.length === 0);
            if (invalidFeatures.length > 0) {
                console.warn(`[UK] ${invalidFeatures.length}ê°œ featureì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤:`, invalidFeatures.map(f => f.properties.name));
            }
            
            if (geoJsonData.features.length === 0) {
                throw new Error('ì˜êµ­ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            }
            
            this.showNotification(`ì˜êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì˜êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('ì˜êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', error.stack || error.message);
            this.showNotification(`ì˜êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    // í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ (ë ˆì§€ì˜¹ ë‹¨ìœ„)
    async loadFranceData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['france']) {
                geoJsonData = this.cachedGeoJsonData['france'];
            } else {
                const candidateUrls = [
                    // geoBoundaries FRA ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/FRA/ADM1/geoBoundaries-FRA-ADM1.geojson',
                    // click_that_hood france
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/france.geojson',
                    // Natural Earth France regions
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í”„ë‘ìŠ¤ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'FRA' || admin === 'France' || iso2 === 'FR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[France] Filtered Natural Earth/global dataset to France only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = data;
                            console.log('[France] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[France] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 5 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[France] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[France] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No France dataset available');
                
                // 50ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš” (ë°íŒŒë¥´íŠ¸ë§ -> ë ˆì§€ì˜¹)
                const needsGrouping = geoJsonData.features && geoJsonData.features.length > 50;
                
                if (needsGrouping) {
                    // í”„ë‘ìŠ¤ ë ˆì§€ì˜¹ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                    const franceRegionData = {
                        'Auvergne-RhÃ´ne-Alpes': { population: 8200000, area: 69711, name_ko: 'ì˜¤ë² ë¥´ë‰´-ë¡ -ì•Œí”„ìŠ¤' },
                        'Bourgogne-Franche-ComtÃ©': { population: 2790000, area: 47784, name_ko: 'ë¶€ë¥´ê³ ë‰´-í”„ë‘ìŠˆ-ì½©í…Œ' },
                        'Bretagne': { population: 3460000, area: 27208, name_ko: 'ë¸Œë¥´íƒ€ë‰´' },
                        'Centre-Val de Loire': { population: 2550000, area: 39151, name_ko: 'ìƒíŠ¸ë¥´-ë°œ ë“œ ë£¨ì•„ë¥´' },
                        'Corse': { population: 350000, area: 8680, name_ko: 'ì½”ë¥´ì‹œì¹´' },
                        'Grand Est': { population: 5540000, area: 57441, name_ko: 'ê·¸ë‘í…ŒìŠ¤íŠ¸' },
                        'Hauts-de-France': { population: 5960000, area: 31813, name_ko: 'ì˜¤ë“œí”„ë‘ìŠ¤' },
                        'Ãle-de-France': { population: 12320000, area: 12012, name_ko: 'ì¼ë“œí”„ë‘ìŠ¤' },
                        'Normandie': { population: 3350000, area: 29906, name_ko: 'ë…¸ë¥´ë§ë””' },
                        'Nouvelle-Aquitaine': { population: 6080000, area: 84036, name_ko: 'ëˆ„ë²¨ì•„í‚¤í…' },
                        'Occitanie': { population: 6080000, area: 72724, name_ko: 'ì˜¥ì‹œíƒ€ë‹ˆ' },
                        'Pays de la Loire': { population: 3900000, area: 32082, name_ko: 'í˜ì´ë“œë¼ë£¨ì•„ë¥´' },
                        'Provence-Alpes-CÃ´te d\'Azur': { population: 5100000, area: 31400, name_ko: 'í”„ë¡œë°©ìŠ¤-ì•Œí”„-ì½”íŠ¸ë‹¤ì¥ë¥´' }
                    };
                    
                    // í”„ë‘ìŠ¤ ë°íŒŒë¥´íŠ¸ë§ì„ 13ê°œ ë ˆì§€ì˜¹ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    const franceRegionMapping = {
                        'Auvergne-RhÃ´ne-Alpes': ['Ain', 'Allier', 'ArdÃ¨che', 'Cantal', 'DrÃ´me', 'IsÃ¨re', 'Loire', 'Haute-Loire', 'Puy-de-DÃ´me', 'RhÃ´ne', 'Savoie', 'Haute-Savoie'],
                        'Bourgogne-Franche-ComtÃ©': ['CÃ´te-d\'Or', 'Doubs', 'Jura', 'NiÃ¨vre', 'Haute-SaÃ´ne', 'SaÃ´ne-et-Loire', 'Yonne', 'Territoire de Belfort'],
                        'Bretagne': ['CÃ´tes-d\'Armor', 'FinistÃ¨re', 'Ille-et-Vilaine', 'Morbihan'],
                        'Centre-Val de Loire': ['Cher', 'Eure-et-Loir', 'Indre', 'Indre-et-Loire', 'Loir-et-Cher', 'Loiret'],
                        'Corse': ['Corse-du-Sud', 'Haute-Corse'],
                        'Grand Est': ['Ardennes', 'Aube', 'Marne', 'Haute-Marne', 'Meurthe-et-Moselle', 'Meuse', 'Moselle', 'Bas-Rhin', 'Haut-Rhin', 'Vosges'],
                        'Hauts-de-France': ['Aisne', 'Nord', 'Oise', 'Pas-de-Calais', 'Somme'],
                        'Ãle-de-France': ['Paris', 'Seine-et-Marne', 'Yvelines', 'Essonne', 'Hauts-de-Seine', 'Seine-Saint-Denis', 'Val-de-Marne', 'Val-d\'Oise'],
                        'Normandie': ['Calvados', 'Eure', 'Manche', 'Orne', 'Seine-Maritime'],
                        'Nouvelle-Aquitaine': ['Charente', 'Charente-Maritime', 'CorrÃ¨ze', 'Creuse', 'Dordogne', 'Gironde', 'Landes', 'Lot-et-Garonne', 'PyrÃ©nÃ©es-Atlantiques', 'Deux-SÃ¨vres', 'Vienne', 'Haute-Vienne'],
                        'Occitanie': ['AriÃ¨ge', 'Aude', 'Aveyron', 'Gard', 'Haute-Garonne', 'Gers', 'HÃ©rault', 'Lot', 'LozÃ¨re', 'Hautes-PyrÃ©nÃ©es', 'PyrÃ©nÃ©es-Orientales', 'Tarn', 'Tarn-et-Garonne'],
                        'Pays de la Loire': ['Loire-Atlantique', 'Maine-et-Loire', 'Mayenne', 'Sarthe', 'VendÃ©e'],
                        'Provence-Alpes-CÃ´te d\'Azur': ['Alpes-de-Haute-Provence', 'Hautes-Alpes', 'Alpes-Maritimes', 'Bouches-du-RhÃ´ne', 'Var', 'Vaucluse']
                    };
                    
                    // ì—­ë§¤í•‘ ìƒì„± (ë°íŒŒë¥´íŠ¸ë§ -> ë ˆì§€ì˜¹)
                    const reverseMapping = {};
                    Object.keys(franceRegionMapping).forEach(region => {
                        franceRegionMapping[region].forEach(departement => {
                            const depLower = departement.toLowerCase();
                            reverseMapping[depLower] = region;
                            // í•˜ì´í”ˆ/ê³µë°± ì œê±° ë³€í˜•
                            reverseMapping[depLower.replace(/[-\s]+/g, ' ').trim()] = region;
                            reverseMapping[depLower.replace(/[^\w\s]/g, '').trim()] = region;
                        });
                    });
                    
                    // ì§€ì—­ ê·¸ë£¹í™”
                    const groupedFeatures = new Map();
                    const idSet = new Set();
                    
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const nameLower = rawName.toLowerCase().trim();
                        
                        // ì •í™•í•œ ë§¤ì¹­ ë¨¼ì € ì‹œë„
                        let groupName = reverseMapping[nameLower] || null;
                        
                        // ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [key, value] of Object.entries(reverseMapping)) {
                                if (key.length > 3 && (nameLower.includes(key) || key.includes(nameLower))) {
                                    groupName = value;
                                    break;
                                }
                            }
                        }
                        
                        // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [region, departements] of Object.entries(franceRegionMapping)) {
                                for (const dep of departements) {
                                    const depLower = dep.toLowerCase();
                                    if (nameLower === depLower || nameLower.includes(depLower) || depLower.includes(nameLower)) {
                                        groupName = region;
                                        break;
                                    }
                                }
                                if (groupName) break;
                            }
                        }
                        
                        // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬
                        if (!groupName) {
                            console.warn(`[France] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­: "${rawName}" - ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬`);
                            groupName = rawName;
                        }
                        
                        if (!groupedFeatures.has(groupName)) {
                            groupedFeatures.set(groupName, {
                                features: [],
                                totalPopulation: 0,
                                totalArea: 0
                            });
                        }
                        
                        const group = groupedFeatures.get(groupName);
                        group.features.push(feature);
                        group.totalPopulation += (p.population || 0);
                        group.totalArea += (p.area || 0);
                    });
                    
                    // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                    const mergedFeatures = [];
                    
                    groupedFeatures.forEach((group, groupName) => {
                        if (group.features.length === 0) return;
                        
                        // ê°œë³„ ì§€ì—­ì¸ ê²½ìš° (ê·¸ë£¹ëª…ì´ ì›ë³¸ ì§€ì—­ëª…ê³¼ ê°™ì€ ê²½ìš°) - ê·¸ë£¹í™”í•˜ì§€ ì•Šê³  ê°œë³„ë¡œ ì²˜ë¦¬
                        const isIndividualRegion = group.features.length === 1 || 
                                                   !Object.keys(franceRegionMapping).includes(groupName);
                        
                        if (isIndividualRegion) {
                            // ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                            group.features.forEach((feature, idx) => {
                                const p = feature.properties || {};
                                const rawName = p.name || p.NAME_1 || p.region || groupName || `Region_${idx}`;
                                
                                if (!feature.geometry || !feature.geometry.coordinates) {
                                    console.warn(`[France] "${rawName}" ì§€ì—­ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                    return;
                                }
                                
                                const baseIdSrc = p.hasc || p.shapeID || rawName || `fra_${idx}`;
                                let baseId = baseIdSrc.toString().toLowerCase()
                                    .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                                    .replace(/__+/g, '_')
                                    .replace(/^_|_$/g, '');
                                if (!baseId) baseId = `fra_region_${mergedFeatures.length}`;
                                let finalId = baseId;
                                let c = 1;
                                while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                                idSet.add(finalId);
                                
                                mergedFeatures.push({
                                    type: 'Feature',
                                    geometry: feature.geometry,
                                    properties: {
                                        ...p,
                                        id: finalId,
                                        name: rawName,
                                        name_ko: rawName,
                                        name_en: rawName,
                                        country: 'France',
                                        country_code: 'FR',
                                        admin_level: 'DÃ©partement',
                                        population: p.population || Math.floor(Math.random() * 500000) + 50000,
                                        area: p.area || Math.floor(Math.random() * 5000) + 1000,
                                        ad_status: 'available',
                                        ad_price: 50000 + (mergedFeatures.length * 5000),
                                        revenue: 0,
                                        company: null,
                                        logo: null,
                                        color: '#5dade2',
                                        border_color: '#ffffff',
                                        border_width: 1
                                    }
                                });
                                
                                this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                            });
                            return;
                        }
                        
                        // ê·¸ë£¹í™”ëœ ì§€ì—­ì¸ ê²½ìš° - Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                        const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                        
                        if (geometries.length === 0) {
                            console.warn(`[France] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        let mergedGeometry;
                        if (geometries.length === 1) {
                            mergedGeometry = geometries[0];
                        } else {
                            const allCoordinates = [];
                            geometries.forEach(g => {
                                if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(g.coordinates);
                                } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(...g.coordinates);
                                }
                            });
                            if (allCoordinates.length === 1) {
                                mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                            } else if (allCoordinates.length > 1) {
                                mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                            } else {
                                mergedGeometry = geometries[0];
                            }
                        }
                        
                        // Geometry ê²€ì¦
                        if (!mergedGeometry || !mergedGeometry.coordinates || 
                            (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                            (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                            console.warn(`[France] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                            return;
                        }
                        
                        const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê³„ì‚°ëœ ê°’ ì‚¬ìš©)
                        const regionInfo = franceRegionData[groupName] || {};
                        const population = regionInfo.population || Math.max(group.totalPopulation, 1000000);
                        const area = regionInfo.area || Math.max(group.totalArea, 10000);
                        const name_ko = regionInfo.name_ko || groupName;
                        
                        mergedFeatures.push({
                            type: 'Feature',
                            geometry: mergedGeometry,
                            properties: {
                                id: finalId,
                                name: groupName,
                                name_ko: name_ko,
                                name_en: groupName,
                                country: 'France',
                                country_code: 'FR',
                                admin_level: 'Region',
                                population: population,
                                area: area,
                                ad_status: 'available',
                                ad_price: 50000 + (mergedFeatures.length * 10000),
                                revenue: 0,
                                company: null,
                                logo: null,
                                color: '#5dade2',
                                border_color: '#ffffff',
                                border_width: 1,
                                original_count: group.features.length
                            }
                        });
                        
                        this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                    });
                    
                    console.log(`[France] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${geoJsonData.features.length}ê°œ)`);
                    
                    geoJsonData = {
                        type: 'FeatureCollection',
                        features: mergedFeatures
                    };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    const idSet = new Set();
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `FRA_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `fra_region_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'France',
                            country_code: 'FR',
                            admin_level: 'Region',
                            population: p.population || Math.floor(Math.random() * 5000000) + 500000,
                            area: p.area || Math.floor(Math.random() * 50000) + 5000,
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 250000) + 180000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#5dade2',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                this.cachedGeoJsonData['france'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#5dade2'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ë ˆì§€ì˜¹');
            console.log('í”„ë‘ìŠ¤ ë°ì´í„° ìƒ˜í”Œ:', geoJsonData.features.slice(0, 3).map(f => f.properties));
            
            // ëª¨ë“  í”„ë‘ìŠ¤ ì§€ì—­ëª… ë¦¬ìŠ¤íŠ¸ì—…
            const franceRegions = geoJsonData.features.map((f, idx) => {
                const p = f.properties;
                return `${idx + 1}. ${p.name || p.NAME_1 || p.region || `Region_${idx}`}`;
            });
            console.log('[France] ëª¨ë“  ì§€ì—­ëª… ë¦¬ìŠ¤íŠ¸:');
            console.log(franceRegions.join('\n'));
            
            if (geoJsonData.features.length === 0) {
                throw new Error('í”„ë‘ìŠ¤ ë°ì´í„°ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.');
            }
            
            this.showNotification(`í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('í”„ë‘ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ìƒì„¸:', error.stack || error.message);
            this.showNotification(`í”„ë‘ìŠ¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'error');
        }
    }

    // ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ (ë ˆì§€ì˜¤ë„¤ ë‹¨ìœ„)
    async loadItalyData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['italy']) {
                geoJsonData = this.cachedGeoJsonData['italy'];
            } else {
                const candidateUrls = [
                    // geoBoundaries ITA ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ITA/ADM1/geoBoundaries-ITA-ADM1.geojson',
                    // click_that_hood italy
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/italy.geojson',
                    // Natural Earth Italy regions
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì´íƒˆë¦¬ì•„ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ITA' || admin === 'Italy' || iso2 === 'IT';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Italy] Filtered Natural Earth/global dataset to Italy only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = data;
                            console.log('[Italy] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Italy] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 5 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Italy] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Italy] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Italy dataset available');
                
                // 50ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš” (í”„ë¡œë¹ˆì¹˜ì•„ -> ë ˆì§€ì˜¤ë„¤)
                const needsGrouping = geoJsonData.features && geoJsonData.features.length > 50;
                
                if (needsGrouping) {
                    // ì´íƒˆë¦¬ì•„ í”„ë¡œë¹ˆì¹˜ì•„ë¥¼ 20ê°œ ë ˆì§€ì˜¤ë„¤ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    const italyRegionMapping = {
                        'Abruzzo': ['Chieti', 'L\'Aquila', 'Pescara', 'Teramo'],
                        'Basilicata': ['Matera', 'Potenza'],
                        'Calabria': ['Catanzaro', 'Cosenza', 'Crotone', 'Reggio Calabria', 'Vibo Valentia'],
                        'Campania': ['Avellino', 'Benevento', 'Caserta', 'Naples', 'Salerno'],
                        'Emilia-Romagna': ['Bologna', 'Ferrara', 'ForlÃ¬-Cesena', 'Modena', 'Parma', 'Piacenza', 'Ravenna', 'Reggio Emilia', 'Rimini'],
                        'Friuli-Venezia Giulia': ['Gorizia', 'Pordenone', 'Trieste', 'Udine'],
                        'Lazio': ['Frosinone', 'Latina', 'Rieti', 'Rome', 'Viterbo'],
                        'Liguria': ['Genoa', 'Imperia', 'La Spezia', 'Savona'],
                        'Lombardy': ['Bergamo', 'Brescia', 'Como', 'Cremona', 'Mantua', 'Milan', 'Pavia', 'Sondrio', 'Varese'],
                        'Marche': ['Ancona', 'Ascoli Piceno', 'Fermo', 'Macerata', 'Pesaro and Urbino'],
                        'Molise': ['Campobasso', 'Isernia'],
                        'Piedmont': ['Alessandria', 'Asti', 'Biella', 'Cuneo', 'Novara', 'Turin', 'Verbano-Cusio-Ossola', 'Vercelli'],
                        'Puglia': ['Bari', 'Barletta-Andria-Trani', 'Brindisi', 'Foggia', 'Lecce', 'Taranto'],
                        'Sardinia': ['Cagliari', 'Carbonia-Iglesias', 'Medio Campidano', 'Nuoro', 'Ogliastra', 'Olbia-Tempio', 'Oristano', 'Sassari'],
                        'Sicily': ['Agrigento', 'Caltanissetta', 'Catania', 'Enna', 'Messina', 'Palermo', 'Ragusa', 'Syracuse', 'Trapani'],
                        'Trentino-Alto Adige': ['Bolzano', 'Trento'],
                        'Tuscany': ['Arezzo', 'Florence', 'Grosseto', 'Livorno', 'Lucca', 'Massa-Carrara', 'Pisa', 'Pistoia', 'Prato', 'Siena'],
                        'Umbria': ['Perugia', 'Terni'],
                        'Valle d\'Aosta': ['Aosta'],
                        'Veneto': ['Belluno', 'Padua', 'Rovigo', 'Treviso', 'Venice', 'Verona', 'Vicenza']
                    };
                    
                    // ì´íƒˆë¦¬ì•„ ë ˆì§€ì˜¤ë„¤ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                    const italyRegionData = {
                        'Abruzzo': { name_ko: 'ì•„ë¸Œë£¨ì´ˆ', population: 1290000, area: 10832 },
                        'Basilicata': { name_ko: 'ë°”ì‹¤ë¦¬ì¹´íƒ€', population: 530000, area: 9995 },
                        'Calabria': { name_ko: 'ì¹¼ë¼ë¸Œë¦¬ì•„', population: 1870000, area: 15222 },
                        'Campania': { name_ko: 'ìº„íŒŒë‹ˆì•„', population: 5640000, area: 13671 },
                        'Emilia-Romagna': { name_ko: 'ì—ë°€ë¦¬ì•„-ë¡œë§ˆëƒ', population: 4470000, area: 22453 },
                        'Friuli-Venezia Giulia': { name_ko: 'í”„ë¦¬ìš¸ë¦¬-ë² ë„¤ì¹˜ì•„ ì¤„ë¦¬ì•„', population: 1190000, area: 7858 },
                        'Lazio': { name_ko: 'ë¼ì¹˜ì˜¤', population: 5720000, area: 17203 },
                        'Liguria': { name_ko: 'ë¦¬êµ¬ë¦¬ì•„', population: 1520000, area: 5416 },
                        'Lombardy': { name_ko: 'ë¡¬ë°”ë¥´ë””ì•„', population: 10140000, area: 23864 },
                        'Marche': { name_ko: 'ë§ˆë¥´ì¼€', population: 1470000, area: 9366 },
                        'Molise': { name_ko: 'ëª°ë¦¬ì œ', population: 290000, area: 4438 },
                        'Piedmont': { name_ko: 'í”¼ì—ëª¬í…Œ', population: 4280000, area: 25402 },
                        'Puglia': { name_ko: 'í’€ë¦¬ì•„', population: 3940000, area: 19358 },
                        'Sardinia': { name_ko: 'ì‚¬ë¥´ë°ëƒ', population: 1580000, area: 24090 },
                        'Sicily': { name_ko: 'ì‹œì¹ ë¦¬ì•„', population: 4780000, area: 25711 },
                        'Trentino-Alto Adige': { name_ko: 'íŠ¸ë Œí‹°ë…¸-ì•Œí†  ì•„ë””ì œ', population: 1090000, area: 13606 },
                        'Tuscany': { name_ko: 'í† ìŠ¤ì¹´ë‚˜', population: 3660000, area: 22987 },
                        'Umbria': { name_ko: 'ì›€ë¸Œë¦¬ì•„', population: 850000, area: 8456 },
                        'Valle d\'Aosta': { name_ko: 'ë°œë ˆë‹¤ì˜¤ìŠ¤íƒ€', population: 123000, area: 3263 },
                        'Veneto': { name_ko: 'ë² ë„¤í† ', population: 4880000, area: 18345 }
                    };
                    
                    // ì—­ë§¤í•‘ ìƒì„± (í”„ë¡œë¹ˆì¹˜ì•„ -> ë ˆì§€ì˜¤ë„¤)
                    const reverseMapping = {};
                    Object.keys(italyRegionMapping).forEach(region => {
                        italyRegionMapping[region].forEach(province => {
                            const provLower = province.toLowerCase();
                            reverseMapping[provLower] = region;
                            // í•˜ì´í”ˆ/ê³µë°± ì œê±° ë³€í˜•
                            reverseMapping[provLower.replace(/[-\s]+/g, ' ').trim()] = region;
                            reverseMapping[provLower.replace(/[^\w\s]/g, '').trim()] = region;
                            // ì£¼ìš” ë„ì‹œëª…ë„ ì¶”ê°€
                            if (province.includes('-')) {
                                const parts = province.split('-');
                                parts.forEach(part => {
                                    if (part.length > 3) {
                                        reverseMapping[part.toLowerCase().trim()] = region;
                                    }
                                });
                            }
                        });
                    });
                    
                    // ì§€ì—­ ê·¸ë£¹í™”
                    const groupedFeatures = new Map();
                    const idSet = new Set();
                    
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const nameLower = rawName.toLowerCase().trim();
                        
                        // ì •í™•í•œ ë§¤ì¹­ ë¨¼ì € ì‹œë„
                        let groupName = reverseMapping[nameLower] || null;
                        
                        // ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [key, value] of Object.entries(reverseMapping)) {
                                if (key.length > 3 && (nameLower.includes(key) || key.includes(nameLower))) {
                                    groupName = value;
                                    break;
                                }
                            }
                        }
                        
                        // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [region, provinces] of Object.entries(italyRegionMapping)) {
                                for (const prov of provinces) {
                                    const provLower = prov.toLowerCase();
                                    if (nameLower === provLower || nameLower.includes(provLower) || provLower.includes(nameLower)) {
                                        groupName = region;
                                        break;
                                    }
                                }
                                if (groupName) break;
                            }
                        }
                        
                        // ë ˆì§€ì˜¤ë„¤ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            const regionNames = Object.keys(italyRegionMapping);
                            for (const region of regionNames) {
                                const regionLower = region.toLowerCase();
                                if (nameLower === regionLower || nameLower.includes(regionLower) || regionLower.includes(nameLower)) {
                                    groupName = region;
                                    break;
                                }
                            }
                        }
                        
                        // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬
                        if (!groupName) {
                            console.warn(`[Italy] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì§€ì—­: "${rawName}" - ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬`);
                            groupName = rawName;
                        }
                        
                        if (!groupedFeatures.has(groupName)) {
                            groupedFeatures.set(groupName, {
                                features: [],
                                totalPopulation: 0,
                                totalArea: 0
                            });
                        }
                        
                        const group = groupedFeatures.get(groupName);
                        group.features.push(feature);
                        group.totalPopulation += (p.population || 0);
                        group.totalArea += (p.area || 0);
                    });
                    
                    // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                    const mergedFeatures = [];
                    
                    groupedFeatures.forEach((group, groupName) => {
                        if (group.features.length === 0) return;
                        
                        // ê°œë³„ ì§€ì—­ì¸ ê²½ìš° (ê·¸ë£¹ëª…ì´ ì›ë³¸ ì§€ì—­ëª…ê³¼ ê°™ì€ ê²½ìš°) - ê·¸ë£¹í™”í•˜ì§€ ì•Šê³  ê°œë³„ë¡œ ì²˜ë¦¬
                        const isIndividualRegion = group.features.length === 1 || 
                                                   !Object.keys(italyRegionMapping).includes(groupName);
                        
                        if (isIndividualRegion) {
                            // ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                            group.features.forEach((feature, idx) => {
                                const p = feature.properties || {};
                                const rawName = p.name || p.NAME_1 || p.region || groupName || `Region_${idx}`;
                                
                                if (!feature.geometry || !feature.geometry.coordinates) {
                                    console.warn(`[Italy] "${rawName}" ì§€ì—­ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                    return;
                                }
                                
                                const baseIdSrc = p.hasc || p.shapeID || rawName || `ita_${idx}`;
                                let baseId = baseIdSrc.toString().toLowerCase()
                                    .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                                    .replace(/__+/g, '_')
                                    .replace(/^_|_$/g, '');
                                if (!baseId) baseId = `ita_region_${mergedFeatures.length}`;
                                let finalId = baseId;
                                let c = 1;
                                while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                                idSet.add(finalId);
                                
                                mergedFeatures.push({
                                    type: 'Feature',
                                    geometry: feature.geometry,
                                    properties: {
                                        ...p,
                                        id: finalId,
                                        name: rawName,
                                        name_ko: rawName,
                                        name_en: rawName,
                                        country: 'Italy',
                                        country_code: 'IT',
                                        admin_level: 'Province',
                                        population: p.population || Math.floor(Math.random() * 500000) + 50000,
                                        area: p.area || Math.floor(Math.random() * 5000) + 1000,
                                        ad_status: 'available',
                                        ad_price: 50000 + (mergedFeatures.length * 5000),
                                        revenue: 0,
                                        company: null,
                                        logo: null,
                                        color: '#00d2d3',
                                        border_color: '#ffffff',
                                        border_width: 1
                                    }
                                });
                                
                                this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                            });
                            return;
                        }
                        
                        // ê·¸ë£¹í™”ëœ ì§€ì—­ì¸ ê²½ìš° - Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                        const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                        
                        if (geometries.length === 0) {
                            console.warn(`[Italy] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        let mergedGeometry;
                        if (geometries.length === 1) {
                            mergedGeometry = geometries[0];
                        } else {
                            const allCoordinates = [];
                            geometries.forEach(g => {
                                if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(g.coordinates);
                                } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(...g.coordinates);
                                }
                            });
                            if (allCoordinates.length === 1) {
                                mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                            } else if (allCoordinates.length > 1) {
                                mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                            } else {
                                mergedGeometry = geometries[0];
                            }
                        }
                        
                        // Geometry ê²€ì¦
                        if (!mergedGeometry || !mergedGeometry.coordinates || 
                            (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                            (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                            console.warn(`[Italy] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                            return;
                        }
                        
                        const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ë ˆì§€ì˜¤ë„¤ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        const regionInfo = italyRegionData[groupName] || {};
                        const regionPopulation = regionInfo.population || Math.max(group.totalPopulation, Math.floor(Math.random() * 5000000) + 500000);
                        const regionArea = regionInfo.area || Math.max(group.totalArea, Math.floor(Math.random() * 30000) + 3000);
                        const regionNameKo = regionInfo.name_ko || groupName;
                        
                        mergedFeatures.push({
                            type: 'Feature',
                            geometry: mergedGeometry,
                            properties: {
                                id: finalId,
                                name: groupName,
                                name_ko: regionNameKo,
                                name_en: groupName,
                                country: 'Italy',
                                country_code: 'IT',
                                admin_level: 'Region',
                                population: regionPopulation,
                                area: regionArea,
                                ad_status: 'available',
                                ad_price: 50000 + (mergedFeatures.length * 10000),
                                revenue: 0,
                                company: null,
                                logo: null,
                                color: '#00d2d3',
                                border_color: '#ffffff',
                                border_width: 1,
                                original_count: group.features.length
                            }
                        });
                        
                        this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                    });
                    
                    console.log(`[Italy] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${geoJsonData.features.length}ê°œ)`);
                    
                    geoJsonData = {
                        type: 'FeatureCollection',
                        features: mergedFeatures
                    };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    // ì´íƒˆë¦¬ì•„ ë ˆì§€ì˜¤ë„¤ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                    const italyRegionData = {
                        'Abruzzo': { name_ko: 'ì•„ë¸Œë£¨ì´ˆ', population: 1290000, area: 10832 },
                        'Basilicata': { name_ko: 'ë°”ì‹¤ë¦¬ì¹´íƒ€', population: 530000, area: 9995 },
                        'Calabria': { name_ko: 'ì¹¼ë¼ë¸Œë¦¬ì•„', population: 1870000, area: 15222 },
                        'Campania': { name_ko: 'ìº„íŒŒë‹ˆì•„', population: 5640000, area: 13671 },
                        'Emilia-Romagna': { name_ko: 'ì—ë°€ë¦¬ì•„-ë¡œë§ˆëƒ', population: 4470000, area: 22453 },
                        'Friuli-Venezia Giulia': { name_ko: 'í”„ë¦¬ìš¸ë¦¬-ë² ë„¤ì¹˜ì•„ ì¤„ë¦¬ì•„', population: 1190000, area: 7858 },
                        'Lazio': { name_ko: 'ë¼ì¹˜ì˜¤', population: 5720000, area: 17203 },
                        'Liguria': { name_ko: 'ë¦¬êµ¬ë¦¬ì•„', population: 1520000, area: 5416 },
                        'Lombardy': { name_ko: 'ë¡¬ë°”ë¥´ë””ì•„', population: 10140000, area: 23864 },
                        'Marche': { name_ko: 'ë§ˆë¥´ì¼€', population: 1470000, area: 9366 },
                        'Molise': { name_ko: 'ëª°ë¦¬ì œ', population: 290000, area: 4438 },
                        'Piedmont': { name_ko: 'í”¼ì—ëª¬í…Œ', population: 4280000, area: 25402 },
                        'Puglia': { name_ko: 'í’€ë¦¬ì•„', population: 3940000, area: 19358 },
                        'Sardinia': { name_ko: 'ì‚¬ë¥´ë°ëƒ', population: 1580000, area: 24090 },
                        'Sicily': { name_ko: 'ì‹œì¹ ë¦¬ì•„', population: 4780000, area: 25711 },
                        'Trentino-Alto Adige': { name_ko: 'íŠ¸ë Œí‹°ë…¸-ì•Œí†  ì•„ë””ì œ', population: 1090000, area: 13606 },
                        'Tuscany': { name_ko: 'í† ìŠ¤ì¹´ë‚˜', population: 3660000, area: 22987 },
                        'Umbria': { name_ko: 'ì›€ë¸Œë¦¬ì•„', population: 850000, area: 8456 },
                        'Valle d\'Aosta': { name_ko: 'ë°œë ˆë‹¤ì˜¤ìŠ¤íƒ€', population: 123000, area: 3263 },
                        'Veneto': { name_ko: 'ë² ë„¤í† ', population: 4880000, area: 18345 }
                    };
                    
                    const idSet = new Set();
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.region || `Region_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `ITA_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `ita_region_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ë ˆì§€ì˜¤ë„¤ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                        let regionInfo = null;
                        for (const [regionName, regionData] of Object.entries(italyRegionData)) {
                            if (rawName.toLowerCase() === regionName.toLowerCase() || 
                                rawName.toLowerCase().includes(regionName.toLowerCase()) ||
                                regionName.toLowerCase().includes(rawName.toLowerCase())) {
                                regionInfo = regionData;
                                break;
                            }
                        }
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: regionInfo ? regionInfo.name_ko : rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'Italy',
                            country_code: 'IT',
                            admin_level: 'Region',
                            population: regionInfo ? regionInfo.population : (p.population || Math.floor(Math.random() * 5000000) + 500000),
                            area: regionInfo ? regionInfo.area : (p.area || Math.floor(Math.random() * 30000) + 3000),
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 220000) + 160000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#00d2d3',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                this.cachedGeoJsonData['italy'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#00d2d3'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ë ˆì§€ì˜¤ë„¤');
            this.showNotification(`ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì´íƒˆë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì´íƒˆë¦¬ì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ (ì£¼/Estado ë‹¨ìœ„)
    async loadBrazilData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['brazil']) {
                geoJsonData = this.cachedGeoJsonData['brazil'];
            } else {
                const candidateUrls = [
                    // geoBoundaries BRA ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/BRA/ADM1/geoBoundaries-BRA-ADM1.geojson',
                    // click_that_hood brazil
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/brazil.geojson',
                    // Natural Earth Brazil states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë¸Œë¼ì§ˆë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'BRA' || admin === 'Brazil' || iso2 === 'BR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Brazil] Filtered Natural Earth/global dataset to Brazil only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 15) {
                            geoJsonData = data;
                            console.log('[Brazil] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 15) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Brazil] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 15 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Brazil] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Brazil] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Brazil dataset available');
                
                // ë¸Œë¼ì§ˆ ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                const brazilStateData = {
                    'Acre': { name_ko: 'ì•„í¬ë¦¬', code: 'AC', population: 910000, area: 164123 },
                    'Alagoas': { name_ko: 'ì•Œë¼ê³ ì•„ìŠ¤', code: 'AL', population: 3350000, area: 27778 },
                    'AmapÃ¡': { name_ko: 'ì•„ë§ˆíŒŒ', code: 'AP', population: 920000, area: 142814 },
                    'Amazonas': { name_ko: 'ì•„ë§ˆì¡°ë‚˜ìŠ¤', code: 'AM', population: 4270000, area: 1559168 },
                    'Bahia': { name_ko: 'ë°”ì´ì•„', code: 'BA', population: 15050000, area: 564760 },
                    'CearÃ¡': { name_ko: 'ì„¸ì•„ë¼', code: 'CE', population: 9550000, area: 148894 },
                    'Distrito Federal': { name_ko: 'ì—°ë°©êµ¬', code: 'DF', population: 3250000, area: 5802 },
                    'EspÃ­rito Santo': { name_ko: 'ì´ìŠ¤í”¼ë¦¬íˆ¬ ì‚°íˆ¬', code: 'ES', population: 4180000, area: 46077 },
                    'GoiÃ¡s': { name_ko: 'ê³ ì´ì•„ìŠ¤', code: 'GO', population: 7360000, area: 340112 },
                    'MaranhÃ£o': { name_ko: 'ë§ˆë¼ëƒ¥', code: 'MA', population: 7240000, area: 331936 },
                    'Mato Grosso': { name_ko: 'ë§ˆíˆ¬ ê·¸ë¡œìˆ˜', code: 'MT', population: 3780000, area: 903357 },
                    'Mato Grosso do Sul': { name_ko: 'ë§ˆíˆ¬ ê·¸ë¡œìˆ˜ ë‘ ìˆ ', code: 'MS', population: 2940000, area: 357145 },
                    'Minas Gerais': { name_ko: 'ë¯¸ë‚˜ìŠ¤ ì œë¼ì´ìŠ¤', code: 'MG', population: 20540000, area: 586521 },
                    'ParÃ¡': { name_ko: 'íŒŒë¼', code: 'PA', population: 9220000, area: 1247689 },
                    'ParaÃ­ba': { name_ko: 'íŒŒë¼ì´ë°”', code: 'PB', population: 4150000, area: 56439 },
                    'ParanÃ¡': { name_ko: 'íŒŒë¼ë‚˜', code: 'PR', population: 11740000, area: 199307 },
                    'Pernambuco': { name_ko: 'í˜ë¥´ë‚¨ë¶€ì¿ ', code: 'PE', population: 9760000, area: 98312 },
                    'PiauÃ­': { name_ko: 'í”¼ì•„ìš°ì´', code: 'PI', population: 3320000, area: 251529 },
                    'Rio de Janeiro': { name_ko: 'ë¦¬ìš°ë°ìë„¤ì´ë£¨', code: 'RJ', population: 16420000, area: 43696 },
                    'Rio Grande do Norte': { name_ko: 'ë¦¬ìš° ê·¸ë€ì§€ ë‘ ë…¸ë¥´ì¹˜', code: 'RN', population: 3560000, area: 52811 },
                    'Rio Grande do Sul': { name_ko: 'ë¦¬ìš° ê·¸ë€ì§€ ë‘ ìˆ ', code: 'RS', population: 10980000, area: 281707 },
                    'RondÃ´nia': { name_ko: 'ë¡ ë„ë‹ˆì•„', code: 'RO', population: 1620000, area: 237765 },
                    'Roraima': { name_ko: 'ë¡œë¼ì´ë§ˆ', code: 'RR', population: 660000, area: 224301 },
                    'Santa Catarina': { name_ko: 'ì‚°íƒ€ ì¹´íƒ€ë¦¬ë‚˜', code: 'SC', population: 7760000, area: 95730 },
                    'SÃ£o Paulo': { name_ko: 'ìƒíŒŒìš¸ë£¨', code: 'SP', population: 46250000, area: 248222 },
                    'Sergipe': { name_ko: 'ì„¸ë¥´ì§€í”¼', code: 'SE', population: 2390000, area: 21910 },
                    'Tocantins': { name_ko: 'í† ì¹¸ì¹­ìŠ¤', code: 'TO', population: 1620000, area: 277720 }
                };
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `BRA_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `bra_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    let stateInfo = null;
                    for (const [stateName, stateData] of Object.entries(brazilStateData)) {
                        const stateLower = stateName.toLowerCase();
                        const rawLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === stateLower || 
                            rawLower.includes(stateLower) || 
                            stateLower.includes(rawLower) ||
                            rawLower === stateData.code.toLowerCase() ||
                            rawLower.includes(stateData.code.toLowerCase())) {
                            stateInfo = stateData;
                            break;
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Brazil',
                        country_code: 'BR',
                        admin_level: 'State',
                        population: stateInfo ? stateInfo.population : (p.population || Math.floor(Math.random() * 15000000) + 1000000),
                        area: stateInfo ? stateInfo.area : (p.area || Math.floor(Math.random() * 500000) + 20000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 280000) + 180000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#feca57',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['brazil'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#feca57'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë¸Œë¼ì§ˆ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë¸Œë¼ì§ˆ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í˜¸ì£¼ ë°ì´í„° ë¡œë“œ (ì£¼/State ë‹¨ìœ„)
    async loadAustraliaData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['australia']) {
                geoJsonData = this.cachedGeoJsonData['australia'];
            } else {
                const candidateUrls = [
                    // geoBoundaries AUS ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/AUS/ADM1/geoBoundaries-AUS-ADM1.geojson',
                    // click_that_hood australia
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/australia.geojson',
                    // Natural Earth Australia states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í˜¸ì£¼ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'AUS' || admin === 'Australia' || iso2 === 'AU';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Australia] Filtered Natural Earth/global dataset to Australia only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = data;
                            console.log('[Australia] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Australia] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 5 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Australia] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Australia] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Australia dataset available');
                
                // í˜¸ì£¼ ì£¼Â·ì¤€ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                const australiaStateData = {
                    'New South Wales': { name_ko: 'ë‰´ì‚¬ìš°ìŠ¤ì›¨ì¼ìŠ¤', code: 'NSW', population: 8480000, area: 801150 },
                    'Victoria': { name_ko: 'ë¹…í† ë¦¬ì•„', code: 'VIC', population: 6900000, area: 227444 },
                    'Queensland': { name_ko: 'í€¸ì¦ëœë“œ', code: 'QLD', population: 5550000, area: 1729742 },
                    'Western Australia': { name_ko: 'ì„œí˜¸ì£¼', code: 'WA', population: 2910000, area: 2527013 },
                    'South Australia': { name_ko: 'ë‚¨í˜¸ì£¼', code: 'SA', population: 1830000, area: 984321 },
                    'Tasmania': { name_ko: 'íƒ€ìŠ¤ë§ˆë‹ˆì•„', code: 'TAS', population: 550000, area: 68401 },
                    'Northern Territory': { name_ko: 'ë…¸ë˜ ì¤€ì£¼', code: 'NT', population: 250000, area: 1347791 },
                    'Australian Capital Territory': { name_ko: 'ì˜¤ìŠ¤íŠ¸ë ˆì¼ë¦¬ì•ˆ ìˆ˜ë„ ì¤€ì£¼', code: 'ACT', population: 460000, area: 2358 }
                };
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `AUS_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `aus_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼/ì¤€ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    let stateInfo = null;
                    for (const [stateName, stateData] of Object.entries(australiaStateData)) {
                        const stateLower = stateName.toLowerCase();
                        const rawLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === stateLower || 
                            rawLower.includes(stateLower) || 
                            stateLower.includes(rawLower) ||
                            rawLower === stateData.code.toLowerCase() ||
                            rawLower.includes(stateData.code.toLowerCase())) {
                            stateInfo = stateData;
                            break;
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Australia',
                        country_code: 'AU',
                        admin_level: 'State/Territory',
                        population: stateInfo ? stateInfo.population : (p.population || Math.floor(Math.random() * 5000000) + 200000),
                        area: stateInfo ? stateInfo.area : (p.area || Math.floor(Math.random() * 1500000) + 50000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 240000) + 160000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ff6348',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['australia'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ff6348'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í˜¸ì£¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼/ì˜í† ');
            this.showNotification(`í˜¸ì£¼ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í˜¸ì£¼ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í˜¸ì£¼ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ (ì£¼/Estado ë‹¨ìœ„)
    async loadMexicoData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['mexico']) {
                geoJsonData = this.cachedGeoJsonData['mexico'];
            } else {
                const candidateUrls = [
                    // geoBoundaries MEX ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/MEX/ADM1/geoBoundaries-MEX-ADM1.geojson',
                    // click_that_hood mexico
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/mexico.geojson',
                    // Natural Earth Mexico states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë©•ì‹œì½”ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'MEX' || admin === 'Mexico' || iso2 === 'MX';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Mexico] Filtered Natural Earth/global dataset to Mexico only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 20) {
                            geoJsonData = data;
                            console.log('[Mexico] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 20) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Mexico] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 20 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Mexico] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Mexico] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Mexico dataset available');
                
                // ë©•ì‹œì½” ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ê¸°ì¤€)
                const mexicoStateData = {
                    'Aguascalientes': { name_ko: 'ì•„ê³¼ìŠ¤ì¹¼ë¦¬ì—”í…ŒìŠ¤', code: 'AGU', population: 1500000, area: 5618 },
                    'Baja California': { name_ko: 'ë°”í•˜ì¹¼ë¦¬í¬ë¥´ë‹ˆì•„', code: 'BC', population: 4000000, area: 71450 },
                    'Baja California Sur': { name_ko: 'ë°”í•˜ì¹¼ë¦¬í¬ë¥´ë‹ˆì•„ ìˆ˜ë¥´', code: 'BCS', population: 860000, area: 73922 },
                    'Campeche': { name_ko: 'ìº„í˜ì²´', code: 'CAM', population: 980000, area: 57507 },
                    'Chiapas': { name_ko: 'ì¹˜ì•„íŒŒìŠ¤', code: 'CHIS', population: 5750000, area: 73311 },
                    'Chihuahua': { name_ko: 'ì¹˜ì™€ì™€', code: 'CHIH', population: 3950000, area: 247460 },
                    'Coahuila': { name_ko: 'ì½”ì•„ìš°ì¼ë¼', code: 'COAH', population: 3300000, area: 151563 },
                    'Colima': { name_ko: 'ì½œë¦¬ë§ˆ', code: 'COL', population: 760000, area: 5191 },
                    'Durango': { name_ko: 'ë‘ë‘ê³ ', code: 'DGO', population: 1800000, area: 123451 },
                    'Guanajuato': { name_ko: 'ê³¼ë‚˜í›„ì•„í† ', code: 'GTO', population: 6400000, area: 30608 },
                    'Guerrero': { name_ko: 'ê²Œë ˆë¡œ', code: 'GRO', population: 3600000, area: 63596 },
                    'Hidalgo': { name_ko: 'ì´ë‹¬ê³ ', code: 'HGO', population: 3100000, area: 20813 },
                    'Jalisco': { name_ko: 'í• ë¦¬ìŠ¤ì½”', code: 'JAL', population: 8600000, area: 78599 },
                    'MÃ©xico': { name_ko: 'ë©•ì‹œì½” ì£¼', code: 'MEX', population: 18200000, area: 22357 },
                    'Mexico': { name_ko: 'ë©•ì‹œì½” ì£¼', code: 'MEX', population: 18200000, area: 22357 },
                    'MichoacÃ¡n': { name_ko: 'ë¯¸ì´ˆì•„ì¹¸', code: 'MICH', population: 5000000, area: 58599 },
                    'Michoacan': { name_ko: 'ë¯¸ì´ˆì•„ì¹¸', code: 'MICH', population: 5000000, area: 58599 },
                    'Morelos': { name_ko: 'ëª¨ë ë¡œìŠ¤', code: 'MOR', population: 2100000, area: 4893 },
                    'Nayarit': { name_ko: 'ë‚˜ì•¼ë¦¬íŠ¸', code: 'NAY', population: 1400000, area: 27857 },
                    'Nuevo LeÃ³n': { name_ko: 'ëˆ„ì—ë³´ë ˆì˜¨', code: 'NL', population: 6000000, area: 64555 },
                    'Nuevo Leon': { name_ko: 'ëˆ„ì—ë³´ë ˆì˜¨', code: 'NL', population: 6000000, area: 64555 },
                    'Oaxaca': { name_ko: 'ì˜¤ì•„í•˜ì¹´', code: 'OAX', population: 4300000, area: 93757 },
                    'Puebla': { name_ko: 'í‘¸ì—ë¸”ë¼', code: 'PUE', population: 6900000, area: 34306 },
                    'QuerÃ©taro': { name_ko: 'ì¼€ë ˆíƒ€ë¡œ', code: 'QRO', population: 2500000, area: 11690 },
                    'Queretaro': { name_ko: 'ì¼€ë ˆíƒ€ë¡œ', code: 'QRO', population: 2500000, area: 11690 },
                    'Quintana Roo': { name_ko: 'í‚¨íƒ€ë‚˜ë¡œì˜¤', code: 'QROO', population: 2100000, area: 50351 },
                    'San Luis PotosÃ­': { name_ko: 'ì‚°ë£¨ì´ìŠ¤í¬í† ì‹œ', code: 'SLP', population: 2900000, area: 60983 },
                    'San Luis Potosi': { name_ko: 'ì‚°ë£¨ì´ìŠ¤í¬í† ì‹œ', code: 'SLP', population: 2900000, area: 60983 },
                    'Sinaloa': { name_ko: 'ì‹œë‚ ë¡œì•„', code: 'SIN', population: 3200000, area: 58092 },
                    'Sonora': { name_ko: 'ì†Œë…¸ë¼', code: 'SON', population: 3200000, area: 179503 },
                    'Tabasco': { name_ko: 'íƒ€ë°”ìŠ¤ì½”', code: 'TAB', population: 2500000, area: 25267 },
                    'Tamaulipas': { name_ko: 'íƒ€ë§ˆìš¸ë¦¬íŒŒìŠ¤', code: 'TAMPS', population: 3800000, area: 80175 },
                    'Tlaxcala': { name_ko: 'í‹€ë½ìŠ¤ì¹¼ë¼', code: 'TLAX', population: 1400000, area: 4016 },
                    'Veracruz': { name_ko: 'ë² ë¼í¬ë£¨ìŠ¤', code: 'VER', population: 8000000, area: 71820 },
                    'YucatÃ¡n': { name_ko: 'ìœ ì¹´íƒ„', code: 'YUC', population: 2500000, area: 39524 },
                    'Yucatan': { name_ko: 'ìœ ì¹´íƒ„', code: 'YUC', population: 2500000, area: 39524 },
                    'Zacatecas': { name_ko: 'ì‚¬ì¹´í…Œì¹´ìŠ¤', code: 'ZAC', population: 1700000, area: 75539 },
                    'Ciudad de MÃ©xico': { name_ko: 'ë©•ì‹œì½”ì‹œí‹°', code: 'CDMX', population: 9500000, area: 1495 },
                    'Mexico City': { name_ko: 'ë©•ì‹œì½”ì‹œí‹°', code: 'CDMX', population: 9500000, area: 1495 },
                    'Distrito Federal': { name_ko: 'ë©•ì‹œì½”ì‹œí‹°', code: 'CDMX', population: 9500000, area: 1495 }
                };
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.state || `State_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `MEX_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `mex_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    let stateInfo = null;
                    for (const [stateName, stateData] of Object.entries(mexicoStateData)) {
                        const stateLower = stateName.toLowerCase();
                        const rawLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === stateLower || 
                            rawLower.includes(stateLower) || 
                            stateLower.includes(rawLower) ||
                            rawLower === stateData.code.toLowerCase() ||
                            rawLower.includes(stateData.code.toLowerCase())) {
                            stateInfo = stateData;
                            break;
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Mexico',
                        country_code: 'MX',
                        admin_level: 'State',
                        population: stateInfo ? stateInfo.population : (p.population || Math.floor(Math.random() * 8000000) + 500000),
                        area: stateInfo ? stateInfo.area : (p.area || Math.floor(Math.random() * 200000) + 10000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 230000) + 170000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#10ac84',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['mexico'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#10ac84'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë©•ì‹œì½” ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë©•ì‹œì½” ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ (ì£¼/Provinsi ë‹¨ìœ„)
    async loadIndonesiaData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['indonesia']) {
                geoJsonData = this.cachedGeoJsonData['indonesia'];
            } else {
                const candidateUrls = [
                    // geoBoundaries IDN ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/IDN/ADM1/geoBoundaries-IDN-ADM1.geojson',
                    // click_that_hood indonesia
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/indonesia.geojson',
                    // Natural Earth Indonesia provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì¸ë„ë„¤ì‹œì•„ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'IDN' || admin === 'Indonesia' || iso2 === 'ID';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Indonesia] Filtered Natural Earth/global dataset to Indonesia only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = data;
                            console.log('[Indonesia] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 10) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Indonesia] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 10 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Indonesia] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Indonesia] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Indonesia dataset available');
                
                // ì¸ë„ë„¤ì‹œì•„ ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (mid-2024 ê¸°ì¤€)
                const indonesiaProvinceData = {
                    'Aceh': { name_ko: 'ì•„ì²´', code: 'AC', population: 5554800, area: 56835 },
                    'North Sumatra': { name_ko: 'ë¶ë¶€ ìˆ˜ë§ˆíŠ¸ë¼', code: 'SU', population: 15588500, area: 72981 },
                    'West Sumatra': { name_ko: 'ì„œë¶€ ìˆ˜ë§ˆíŠ¸ë¼', code: 'SB', population: 5836200, area: 42120 },
                    'Riau': { name_ko: 'ë¦¬ì•„ìš°', code: 'RI', population: 6728100, area: 89936 },
                    'Jambi': { name_ko: 'ì ë¹„', code: 'JA', population: 3724300, area: 49027 },
                    'South Sumatra': { name_ko: 'ë‚¨ë¶€ ìˆ˜ë§ˆíŠ¸ë¼', code: 'SS', population: 8837300, area: 86772 },
                    'Bengkulu': { name_ko: 'ë²µì¿¨ë£¨', code: 'BE', population: 2112200, area: 20128 },
                    'Lampung': { name_ko: 'ëŒí’', code: 'LA', population: 9419600, area: 33570 },
                    'Bangka Belitung Islands': { name_ko: 'ë°©ì¹´ ë¸”ë¦¬í‰ ì œë„', code: 'BB', population: 1531500, area: 16690 },
                    'Riau Islands': { name_ko: 'ë¦¬ì•„ìš° ì œë„', code: 'KR', population: 2183300, area: 8270 },
                    'Jakarta': { name_ko: 'ìì¹´ë¥´íƒ€ íŠ¹ë³„ìˆ˜ë„ì§€ì—­', code: 'JK', population: 10684900, area: 661 },
                    'DKI Jakarta': { name_ko: 'ìì¹´ë¥´íƒ€ íŠ¹ë³„ìˆ˜ë„ì§€ì—­', code: 'JK', population: 10684900, area: 661 },
                    'Jakarta Special Capital Region': { name_ko: 'ìì¹´ë¥´íƒ€ íŠ¹ë³„ìˆ˜ë„ì§€ì—­', code: 'JK', population: 10684900, area: 661 },
                    'West Java': { name_ko: 'ì„œë¶€ ìë°”', code: 'JB', population: 50345200, area: 37045 },
                    'Central Java': { name_ko: 'ì¤‘ë¶€ ìë°”', code: 'JT', population: 37892300, area: 34337 },
                    'Yogyakarta': { name_ko: 'ìš•ì•¼ì¹´ë¥´íƒ€ íŠ¹ë³„ì§€ì—­', code: 'YO', population: 3759500, area: 3171 },
                    'Daerah Istimewa Yogyakarta': { name_ko: 'ìš•ì•¼ì¹´ë¥´íƒ€ íŠ¹ë³„ì§€ì—­', code: 'YO', population: 3759500, area: 3171 },
                    'East Java': { name_ko: 'ë™ë¶€ ìë°”', code: 'JI', population: 41814500, area: 48037 },
                    'Banten': { name_ko: 'ë°˜í…', code: 'BT', population: 12431400, area: 9353 },
                    'Bali': { name_ko: 'ë°œë¦¬', code: 'BA', population: 4433300, area: 5590 },
                    'West Nusa Tenggara': { name_ko: 'ì„œë¶€ ëˆ„ì‚¬ í…¡ê°€ë¼', code: 'NB', population: 5646000, area: 19676 },
                    'East Nusa Tenggara': { name_ko: 'ë™ë¶€ ëˆ„ì‚¬ í…¡ê°€ë¼', code: 'NT', population: 5656000, area: 46447 },
                    'West Kalimantan': { name_ko: 'ì„œë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KB', population: 5695500, area: 147037 },
                    'Central Kalimantan': { name_ko: 'ì¤‘ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KT', population: 2809700, area: 153444 },
                    'South Kalimantan': { name_ko: 'ë‚¨ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KS', population: 4273400, area: 37135 },
                    'East Kalimantan': { name_ko: 'ë™ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KI', population: 4045900, area: 126981 },
                    'North Kalimantan': { name_ko: 'ë¶ë¶€ ì¹¼ë¦¬ë§Œíƒ„', code: 'KU', population: 739800, area: 70101 },
                    'North Sulawesi': { name_ko: 'ë¶ë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'SA', population: 2701800, area: 14500 },
                    'Central Sulawesi': { name_ko: 'ì¤‘ë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'ST', population: 3121800, area: 61606 },
                    'South Sulawesi': { name_ko: 'ë‚¨ë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'SN', population: 9463400, area: 45331 },
                    'Southeast Sulawesi': { name_ko: 'ë™ë‚¨ ìˆ ë¼ì›¨ì‹œ', code: 'SG', population: 2793100, area: 36160 },
                    'Gorontalo': { name_ko: 'ê³ ë¡ íƒˆë¡œ', code: 'GO', population: 1227800, area: 12025 },
                    'West Sulawesi': { name_ko: 'ì„œë¶€ ìˆ ë¼ì›¨ì‹œ', code: 'SR', population: 1503200, area: 16595 },
                    'Maluku': { name_ko: 'ë§ë£¨ì¿ ', code: 'MA', population: 1945600, area: 46158 },
                    'North Maluku': { name_ko: 'ë¶ë¶€ ë§ë£¨ì¿ ', code: 'MU', population: 1355600, area: 32999 },
                    'Papua': { name_ko: 'íŒŒí‘¸ì•„', code: 'PA', population: 1060600, area: 82681 },
                    'West Papua': { name_ko: 'ì„œë¶€ íŒŒí‘¸ì•„', code: 'PB', population: 578700, area: 60275 }
                };
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `IDN_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `idn_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    let provinceInfo = null;
                    for (const [provinceName, provinceData] of Object.entries(indonesiaProvinceData)) {
                        const provinceLower = provinceName.toLowerCase();
                        const rawLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­, ì•½ì–´ ë§¤ì¹­
                        if (rawLower === provinceLower || 
                            rawLower.includes(provinceLower) || 
                            provinceLower.includes(rawLower) ||
                            rawLower === provinceData.code.toLowerCase() ||
                            rawLower.includes(provinceData.code.toLowerCase())) {
                            provinceInfo = provinceData;
                            break;
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceInfo ? provinceInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Indonesia',
                        country_code: 'ID',
                        admin_level: 'Province',
                        population: provinceInfo ? provinceInfo.population : (p.population || Math.floor(Math.random() * 8000000) + 500000),
                        area: provinceInfo ? provinceInfo.area : (p.area || Math.floor(Math.random() * 200000) + 10000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 200000) + 120000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ffa502',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['indonesia'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ffa502'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì¸ë„ë„¤ì‹œì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì¸ë„ë„¤ì‹œì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ (ì£¼/Province ë‹¨ìœ„)
    async loadSaudiArabiaData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['saudi-arabia']) {
                geoJsonData = this.cachedGeoJsonData['saudi-arabia'];
            } else {
                const candidateUrls = [
                    // geoBoundaries SAU ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/SAU/ADM1/geoBoundaries-SAU-ADM1.geojson',
                    // click_that_hood saudi-arabia
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/saudi-arabia.geojson',
                    // Natural Earth Saudi Arabia provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'SAU' || admin === 'Saudi Arabia' || iso2 === 'SA';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Saudi Arabia] Filtered Natural Earth/global dataset to Saudi Arabia only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = data;
                            console.log('[Saudi Arabia] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Saudi Arabia] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 5 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Saudi Arabia] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Saudi Arabia] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Saudi Arabia dataset available');
                
                // ì‚¬ìš°ë”” ì•„ë¼ë¹„ì•„ ì£¼ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2022 ê¸°ì¤€)
                const saudiArabiaProvinceData = {
                    'Riyadh': { name_ko: 'ë¦¬ì•¼ë“œ', population: 8591748, area: 404240 },
                    'Makkah': { name_ko: 'ë©”ì¹´', population: 7769994, area: 153128 },
                    'Madinah': { name_ko: 'ë©”ë””ë‚˜', population: 2389452, area: 151990 },
                    'Al-Qassim': { name_ko: 'ì¹´ì‹¬', population: 1336179, area: 58046 },
                    'Eastern Province': { name_ko: 'ë™ë¶€ ì£¼', population: 5125254, area: 672522 },
                    'Al-Sharqiyah': { name_ko: 'ì•Œìƒ¤ë¥´í‚¤ì•¼', population: 5125254, area: 672522 },
                    'Asir': { name_ko: 'ì•„ì‹œë¥´', population: 2024285, area: 76693 },
                    'Tabuk': { name_ko: 'íƒ€ë¶€í¬', population: 886036, area: 146072 },
                    'Hail': { name_ko: 'í•˜ì¼', population: 746406, area: 103887 },
                    'Northern Borders': { name_ko: 'ë¶ë¶€ ë³€ê²½ ì£¼', population: 373577, area: 111797 },
                    'Al-Hudud ash-Shamaliyah': { name_ko: 'ì•Œí›„ë‘ë“œ ì•„ìƒ¤ë§ë¦¬ì•¼', population: 373577, area: 111797 },
                    'Jazan': { name_ko: 'ìì”', population: 1404997, area: 11671 },
                    'Jizan': { name_ko: 'ìì”', population: 1404997, area: 11671 },
                    'Najran': { name_ko: 'ë‚˜ì¦ˆë€', population: 592300, area: 149511 },
                    'Al-Baha': { name_ko: 'ë°”í•˜', population: 339174, area: 9921 },
                    'Al-Jawf': { name_ko: 'ì•Œììš°í”„', population: 500000, area: 100212 }
                };
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `SAU_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `sau_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ë°ì´í„° ë§¤ì¹­ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ, ë‹¤ì–‘í•œ ë³€í˜• ì§€ì›)
                    let provinceInfo = null;
                    for (const [provinceName, provinceData] of Object.entries(saudiArabiaProvinceData)) {
                        const provinceLower = provinceName.toLowerCase();
                        const rawLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­, ë¶€ë¶„ ë§¤ì¹­
                        if (rawLower === provinceLower || 
                            rawLower.includes(provinceLower) || 
                            provinceLower.includes(rawLower)) {
                            provinceInfo = provinceData;
                            break;
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceInfo ? provinceInfo.name_ko : rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Saudi Arabia',
                        country_code: 'SA',
                        admin_level: 'Province',
                        population: provinceInfo ? provinceInfo.population : (p.population || Math.floor(Math.random() * 5000000) + 300000),
                        area: provinceInfo ? provinceInfo.area : (p.area || Math.floor(Math.random() * 500000) + 50000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 250000) + 200000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#0652DD',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['saudi-arabia'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#0652DD'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì‚¬ìš°ë””ì•„ë¼ë¹„ì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í„°í‚¤ ë°ì´í„° ë¡œë“œ (ì£¼/Province ë‹¨ìœ„)
    async loadTurkeyData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['turkey']) {
                geoJsonData = this.cachedGeoJsonData['turkey'];
            } else {
                const candidateUrls = [
                    // geoBoundaries TUR ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/TUR/ADM1/geoBoundaries-TUR-ADM1.geojson',
                    // click_that_hood turkey
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/turkey.geojson',
                    // Natural Earth Turkey provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í„°í‚¤ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'TUR' || admin === 'Turkey' || iso2 === 'TR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Turkey] Filtered Natural Earth/global dataset to Turkey only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 50) {
                            geoJsonData = data;
                            console.log('[Turkey] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 50) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Turkey] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 50 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Turkey] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Turkey] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Turkey dataset available');
                
                // 81ê°œ ì´ìƒì˜ featureê°€ ìˆìœ¼ë©´ ê·¸ë£¹í™” í•„ìš” (ì£¼ -> ì§€ì—­)
                const needsGrouping = geoJsonData.features && geoJsonData.features.length > 50;
                
                if (needsGrouping) {
                    // íŠ€ë¥´í‚¤ì˜ˆ ì£¼ë¥¼ 7ê°œ ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”í•˜ëŠ” ë§¤í•‘
                    const turkeyRegionMapping = {
                        'Marmara Region': ['BalÄ±kesir', 'Bilecik', 'Bursa', 'Ã‡anakkale', 'Edirne', 'Ä°stanbul', 'Istanbul', 'KÄ±rklareli', 'Kocaeli', 'Sakarya', 'TekirdaÄŸ', 'Tekirdag', 'Yalova'],
                        'Aegean Region': ['Afyonkarahisar', 'AydÄ±n', 'Aydin', 'Denizli', 'Ä°zmir', 'Izmir', 'KÃ¼tahya', 'Kutahya', 'Manisa', 'MuÄŸla', 'Mugla', 'UÅŸak', 'Usak'],
                        'Mediterranean Region': ['Adana', 'Antalya', 'Burdur', 'Hatay', 'Isparta', 'Mersin', 'Osmaniye', 'KahramanmaraÅŸ', 'KahramanmaraÅŸ', 'Kahramanmaras'],
                        'Central Anatolia Region': ['Aksaray', 'Ankara', 'Ã‡ankÄ±rÄ±', 'Cankiri', 'EskiÅŸehir', 'Eskisehir', 'Karaman', 'Kayseri', 'KÄ±rÄ±kkale', 'Kirikkale', 'KÄ±rÅŸehir', 'Kirsehir', 'Konya', 'NevÅŸehir', 'Nevsehir', 'NiÄŸde', 'Nigde', 'Sivas', 'Yozgat'],
                        'Black Sea Region': ['Amasya', 'Artvin', 'BartÄ±n', 'Bartin', 'Bayburt', 'Bolu', 'Ã‡orum', 'Corum', 'DÃ¼zce', 'Duzce', 'Giresun', 'GÃ¼mÃ¼ÅŸhane', 'Gumushane', 'KarabÃ¼k', 'Karabuk', 'Kastamonu', 'Ordu', 'Rize', 'Samsun', 'Sinop', 'Tokat', 'Trabzon', 'Zonguldak'],
                        'Eastern Anatolia Region': ['AÄŸrÄ±', 'Agri', 'Ardahan', 'BingÃ¶l', 'Bingol', 'Bitlis', 'ElazÄ±ÄŸ', 'Elazig', 'Erzincan', 'Erzurum', 'HakkÃ¢ri', 'Hakkari', 'IÄŸdÄ±r', 'Igdir', 'Kars', 'Malatya', 'MuÅŸ', 'Mus', 'Tunceli', 'Van'],
                        'Southeastern Anatolia Region': ['AdÄ±yaman', 'Adiyaman', 'Batman', 'DiyarbakÄ±r', 'Diyarbakir', 'Gaziantep', 'Kilis', 'Mardin', 'Siirt', 'ÅanlÄ±urfa', 'Sanliurfa', 'ÅÄ±rnak', 'Sirnak']
                    };
                    
                    // íŠ€ë¥´í‚¤ì˜ˆ ì§€ì—­ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                    const turkeyRegionData = {
                        'Marmara Region': { name_ko: 'ë§ˆë¥´ë§ˆë¼', population: 26650000, area: 67000 },
                        'Aegean Region': { name_ko: 'ì—ê²Œí•´', population: 10974000, area: 90000 },
                        'Mediterranean Region': { name_ko: 'ì§€ì¤‘í•´', population: 10584000, area: 89500 },
                        'Central Anatolia Region': { name_ko: 'ì¤‘ì•™ ì•„ë‚˜í†¨ë¦¬ì•„', population: 12000000, area: 65000 },
                        'Black Sea Region': { name_ko: 'í‘í•´', population: 8500000, area: 70000 },
                        'Eastern Anatolia Region': { name_ko: 'ë™ë¶€ ì•„ë‚˜í†¨ë¦¬ì•„', population: 6500000, area: 165000 },
                        'Southeastern Anatolia Region': { name_ko: 'ë™ë‚¨ë¶€ ì•„ë‚˜í†¨ë¦¬ì•„', population: 9490000, area: 76200 }
                    };
                    
                    // ì—­ë§¤í•‘ ìƒì„± (ì£¼ -> ì§€ì—­)
                    const reverseMapping = {};
                    Object.keys(turkeyRegionMapping).forEach(region => {
                        turkeyRegionMapping[region].forEach(province => {
                            const provLower = province.toLowerCase();
                            reverseMapping[provLower] = region;
                            // í„°í‚¤ì–´ íŠ¹ìˆ˜ë¬¸ì ì œê±° ë³€í˜•
                            reverseMapping[provLower.replace(/[Ã§ÄŸÄ±Ã¶ÅŸÃ¼Ã‡ÄIÄ°Ã–ÅÃœ]/g, (m) => {
                                const map = { 'Ã§': 'c', 'ÄŸ': 'g', 'Ä±': 'i', 'Ã¶': 'o', 'ÅŸ': 's', 'Ã¼': 'u',
                                             'Ã‡': 'c', 'Ä': 'g', 'Ä°': 'i', 'Ã–': 'o', 'Å': 's', 'Ãœ': 'u' };
                                return map[m] || m;
                            })] = region;
                        });
                    });
                    
                    // ì§€ì—­ ê·¸ë£¹í™”
                    const groupedFeatures = new Map();
                    const idSet = new Set();
                    
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                        const nameLower = rawName.toLowerCase();
                        
                        // ì •í™•í•œ ë§¤ì¹­ ë¨¼ì € ì‹œë„
                        let groupName = reverseMapping[nameLower] || null;
                        
                        // ì •í™•í•œ ë§¤ì¹­ì´ ì—†ìœ¼ë©´ ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [key, value] of Object.entries(reverseMapping)) {
                                if (key.length > 3 && (nameLower.includes(key) || key.includes(nameLower))) {
                                    groupName = value;
                                    break;
                                }
                            }
                        }
                        
                        // ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            for (const [region, provinces] of Object.entries(turkeyRegionMapping)) {
                                for (const prov of provinces) {
                                    const provLower = prov.toLowerCase();
                                    if (nameLower === provLower || nameLower.includes(provLower) || provLower.includes(nameLower)) {
                                        groupName = region;
                                        break;
                                    }
                                }
                                if (groupName) break;
                            }
                        }
                        
                        // ì§€ì—­ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ë§¤ì¹­ ì‹œë„
                        if (!groupName) {
                            const regionNames = Object.keys(turkeyRegionMapping);
                            for (const region of regionNames) {
                                const regionLower = region.toLowerCase();
                                if (nameLower === regionLower || nameLower.includes(regionLower) || regionLower.includes(nameLower)) {
                                    groupName = region;
                                    break;
                                }
                            }
                        }
                        
                        // ê¸°ë³¸ê°’: ê·¸ë£¹ì„ ì°¾ì§€ ëª»í•œ ê²½ìš° ê°œë³„ ì§€ì—­ìœ¼ë¡œ ì²˜ë¦¬
                        if (!groupName) {
                            console.warn(`[Turkey] ë§¤ì¹­ë˜ì§€ ì•Šì€ ì£¼: "${rawName}" - ê°œë³„ ì£¼ë¡œ ì²˜ë¦¬`);
                            groupName = rawName;
                        }
                        
                        if (!groupedFeatures.has(groupName)) {
                            groupedFeatures.set(groupName, {
                                features: [],
                                totalPopulation: 0,
                                totalArea: 0
                            });
                        }
                        
                        const group = groupedFeatures.get(groupName);
                        group.features.push(feature);
                        group.totalPopulation += (p.population || 0);
                        group.totalArea += (p.area || 0);
                    });
                    
                    // ê·¸ë£¹í™”ëœ featuresë¥¼ í•˜ë‚˜ì˜ featureë¡œ í†µí•©
                    const mergedFeatures = [];
                    
                    groupedFeatures.forEach((group, groupName) => {
                        if (group.features.length === 0) return;
                        
                        // ê°œë³„ ì£¼ì¸ ê²½ìš° (ê·¸ë£¹ëª…ì´ ì›ë³¸ ì£¼ëª…ê³¼ ê°™ì€ ê²½ìš°) - ê·¸ë£¹í™”í•˜ì§€ ì•Šê³  ê°œë³„ë¡œ ì²˜ë¦¬
                        const isIndividualProvince = group.features.length === 1 || 
                                                   !Object.keys(turkeyRegionMapping).includes(groupName);
                        
                        if (isIndividualProvince) {
                            // ê°œë³„ ì£¼ë¡œ ì²˜ë¦¬ (ê·¸ë£¹í™”í•˜ì§€ ì•ŠìŒ)
                            group.features.forEach((feature, idx) => {
                                const p = feature.properties || {};
                                const rawName = p.name || p.NAME_1 || p.province || groupName || `Province_${idx}`;
                                
                                if (!feature.geometry || !feature.geometry.coordinates) {
                                    console.warn(`[Turkey] "${rawName}" ì£¼ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                                    return;
                                }
                                
                                const baseIdSrc = p.hasc || p.shapeID || rawName || `tur_${idx}`;
                                let baseId = baseIdSrc.toString().toLowerCase()
                                    .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                                    .replace(/__+/g, '_')
                                    .replace(/^_|_$/g, '');
                                if (!baseId) baseId = `tur_province_${mergedFeatures.length}`;
                                let finalId = baseId;
                                let c = 1;
                                while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                                idSet.add(finalId);
                                
                                mergedFeatures.push({
                                    type: 'Feature',
                                    geometry: feature.geometry,
                                    properties: {
                                        ...p,
                                        id: finalId,
                                        name: rawName,
                                        name_ko: rawName,
                                        name_en: rawName,
                                        country: 'Turkey',
                                        country_code: 'TR',
                                        admin_level: 'Province',
                                        population: p.population || Math.floor(Math.random() * 3000000) + 200000,
                                        area: p.area || Math.floor(Math.random() * 50000) + 5000,
                                        ad_status: 'available',
                                        ad_price: 150000 + (mergedFeatures.length * 5000),
                                        revenue: 0,
                                        company: null,
                                        logo: null,
                                        color: '#ee5a6f',
                                        border_color: '#ffffff',
                                        border_width: 1
                                    }
                                });
                                
                                this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                            });
                            return;
                        }
                        
                        // ê·¸ë£¹í™”ëœ ì§€ì—­ì¸ ê²½ìš° - Geometry í†µí•© (MultiPolygonìœ¼ë¡œ)
                        const geometries = group.features.map(f => f.geometry).filter(g => g && g.coordinates);
                        
                        if (geometries.length === 0) {
                            console.warn(`[Turkey] "${groupName}" ê·¸ë£¹ì— ìœ íš¨í•œ geometryê°€ ì—†ìŠµë‹ˆë‹¤.`);
                            return;
                        }
                        
                        let mergedGeometry;
                        if (geometries.length === 1) {
                            mergedGeometry = geometries[0];
                        } else {
                            const allCoordinates = [];
                            geometries.forEach(g => {
                                if (g.type === 'Polygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(g.coordinates);
                                } else if (g.type === 'MultiPolygon' && g.coordinates && Array.isArray(g.coordinates) && g.coordinates.length > 0) {
                                    allCoordinates.push(...g.coordinates);
                                }
                            });
                            if (allCoordinates.length === 1) {
                                mergedGeometry = { type: 'Polygon', coordinates: allCoordinates[0] };
                            } else if (allCoordinates.length > 1) {
                                mergedGeometry = { type: 'MultiPolygon', coordinates: allCoordinates };
                            } else {
                                mergedGeometry = geometries[0];
                            }
                        }
                        
                        // Geometry ê²€ì¦
                        if (!mergedGeometry || !mergedGeometry.coordinates || 
                            (mergedGeometry.type === 'Polygon' && mergedGeometry.coordinates.length === 0) ||
                            (mergedGeometry.type === 'MultiPolygon' && mergedGeometry.coordinates.length === 0)) {
                            console.warn(`[Turkey] "${groupName}" ê·¸ë£¹ì˜ geometry í†µí•© ì‹¤íŒ¨`);
                            return;
                        }
                        
                        const baseId = groupName.toLowerCase().replace(/[^\w\uAC00-\uD7A3]/g, '_').replace(/__+/g, '_');
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        // ì§€ì—­ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                        const regionInfo = turkeyRegionData[groupName] || {};
                        const regionPopulation = regionInfo.population || Math.max(group.totalPopulation, Math.floor(Math.random() * 10000000) + 5000000);
                        const regionArea = regionInfo.area || Math.max(group.totalArea, Math.floor(Math.random() * 100000) + 50000);
                        const regionNameKo = regionInfo.name_ko || groupName;
                        
                        mergedFeatures.push({
                            type: 'Feature',
                            geometry: mergedGeometry,
                            properties: {
                                id: finalId,
                                name: groupName,
                                name_ko: regionNameKo,
                                name_en: groupName,
                                country: 'Turkey',
                                country_code: 'TR',
                                admin_level: 'Region',
                                population: regionPopulation,
                                area: regionArea,
                                ad_status: 'available',
                                ad_price: 150000 + (mergedFeatures.length * 15000),
                                revenue: 0,
                                company: null,
                                logo: null,
                                color: '#ee5a6f',
                                border_color: '#ffffff',
                                border_width: 1,
                                original_count: group.features.length
                            }
                        });
                        
                        this.regionData.set(finalId, mergedFeatures[mergedFeatures.length - 1].properties);
                    });
                    
                    console.log(`[Turkey] ìµœì¢… í†µí•©: ${mergedFeatures.length}ê°œ ì§€ì—­ (ì›ë³¸: ${geoJsonData.features.length}ê°œ)`);
                    
                    geoJsonData = {
                        type: 'FeatureCollection',
                        features: mergedFeatures
                    };
                } else {
                    // ê·¸ë£¹í™”ê°€ í•„ìš” ì—†ìœ¼ë©´ ì›ë³¸ ë°ì´í„° ì†ì„±ë§Œ ì •ê·œí™”
                    const idSet = new Set();
                    geoJsonData.features.forEach((feature, index) => {
                        const p = feature.properties || {};
                        const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                        const baseIdSrc = p.hasc || p.shapeID || rawName || `TUR_${index}`;
                        let baseId = baseIdSrc.toString().toLowerCase()
                            .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                        if (!baseId) baseId = `tur_province_${index}`;
                        let finalId = baseId; let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: rawName,
                            name_en: p.NAME_1 || p.name || rawName,
                            country: 'Turkey',
                            country_code: 'TR',
                            admin_level: 'Province',
                            population: p.population || Math.floor(Math.random() * 3000000) + 200000,
                            area: p.area || Math.floor(Math.random() * 50000) + 5000,
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 210000) + 150000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#ee5a6f',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        this.regionData.set(finalId, feature.properties);
                    });
                }
                this.cachedGeoJsonData['turkey'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ee5a6f'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í„°í‚¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`í„°í‚¤ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í„°í‚¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í„°í‚¤ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ (ì§€êµ¬/District ë‹¨ìœ„ - 52ê°œ í–‰ì •êµ¬ì—­)
    async loadSouthAfricaData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['south-africa']) {
                geoJsonData = this.cachedGeoJsonData['south-africa'];
            } else {
                // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ 9ê°œ ì£¼ì™€ 52ê°œ ì§€êµ¬ ë§¤í•‘ (2024 ì¶”ì • ì¸êµ¬ ë° ë©´ì )
                const southAfricaProvinceMapping = {
                    'Eastern Cape': {
                        name_ko: 'ì´ìŠ¤í„´ì¼€ì´í”„',
                        population: 6700000,
                        area: 168966,
                        districts: [
                            'Buffalo City', 'Nelson Mandela Bay', 'Sarah Baartman', 'Amathole', 
                            'Chris Hani', 'Joe Gqabi', 'OR Tambo', 'Alfred Nzo'
                        ]
                    },
                    'Free State': {
                        name_ko: 'í”„ë¦¬ìŠ¤í…Œì´íŠ¸',
                        population: 3000000,
                        area: 129825,
                        districts: [
                            'Mangaung', 'Fezile Dabi', 'Lejweleputswa', 'Thabo Mofutsanyana', 'Xhariep'
                        ]
                    },
                    'Gauteng': {
                        name_ko: 'í•˜ìš°í…¡',
                        population: 16500000,
                        area: 18176,
                        districts: [
                            'City of Johannesburg', 'City of Tshwane', 'City of Ekurhuleni', 
                            'West Rand', 'Sedibeng', 'Metsweding'
                        ]
                    },
                    'KwaZulu-Natal': {
                        name_ko: 'ì½°ì¤„ë£¨ë‚˜íƒˆ',
                        population: 12400000,
                        area: 94361,
                        districts: [
                            'eThekwini', 'iLembe', 'Ugu', 'uMgungundlovu', 'uMzinyathi', 
                            'uThukela', 'Amajuba', 'Zululand', 'uMkhanyakude', 'uThungulu', 
                            'King Cetshwayo'
                        ]
                    },
                    'Limpopo': {
                        name_ko: 'ë¦¼í¬í¬',
                        population: 6200000,
                        area: 125754,
                        districts: [
                            'Mopani', 'Vhembe', 'Capricorn', 'Waterberg', 'Sekhukhune'
                        ]
                    },
                    'Mpumalanga': {
                        name_ko: 'ìŒí’€ë§ë‘ê°€',
                        population: 4900000,
                        area: 76495,
                        districts: [
                            'Gert Sibande', 'Nkangala', 'Ehlanzeni'
                        ]
                    },
                    'Northern Cape': {
                        name_ko: 'ë…¸ë˜ì¼€ì´í”„',
                        population: 1400000,
                        area: 372889,
                        districts: [
                            'Namakwa', 'Pixley ka Seme', 'Siyanda', 'Frances Baard', 'Kgalagadi'
                        ]
                    },
                    'North West': {
                        name_ko: 'ë…¸ìŠ¤ì›¨ìŠ¤íŠ¸',
                        population: 4300000,
                        area: 104882,
                        districts: [
                            'Bojanala Platinum', 'Ngaka Modiri Molema', 'Dr Ruth Segomotsi Mompati', 
                            'Dr Kenneth Kaunda'
                        ]
                    },
                    'Western Cape': {
                        name_ko: 'ì›¨ìŠ¤í„´ì¼€ì´í”„',
                        population: 7400000,
                        area: 129462,
                        districts: [
                            'City of Cape Town', 'West Coast', 'Cape Winelands', 'Overberg', 
                            'Garden Route', 'Central Karoo'
                        ]
                    }
                };

                const candidateUrls = [
                    // geoBoundaries ZAF ADM2 (52ê°œ ì§€êµ¬)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ZAF/ADM2/geoBoundaries-ZAF-ADM2.geojson',
                    // geoBoundaries ZAF ADM1 (9ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ZAF/ADM1/geoBoundaries-ZAF-ADM1.geojson',
                    // click_that_hood south-africa
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/south-africa.geojson',
                    // Natural Earth South Africa provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ZAF' || admin === 'South Africa' || iso2 === 'ZA';
                            });
                            if (filtered.length > 0) {
                                console.log(`[South Africa] Filtered Natural Earth/global dataset to South Africa only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = data;
                            console.log('[South Africa] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 5) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[South Africa] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 5 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[South Africa] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[South Africa] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No South Africa dataset available');
                
                // ì£¼-ì§€êµ¬ ë§¤í•‘ì„ í´ë˜ìŠ¤ì— ì €ì¥
                this.southAfricaProvinceMapping = southAfricaProvinceMapping;
                
                // ì§€êµ¬ ì´ë¦„ì„ ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const districtToProvinceMap = {};
                Object.keys(southAfricaProvinceMapping).forEach(provinceName => {
                    const province = southAfricaProvinceMapping[provinceName];
                    province.districts.forEach(district => {
                        districtToProvinceMap[district.toLowerCase()] = {
                            province: provinceName,
                            province_ko: province.name_ko
                        };
                    });
                });
                
                const idSet = new Set();
                const isDistrictLevel = geoJsonData.features.length > 40; // ADM2 ë°ì´í„°ì¸ ê²½ìš° (52ê°œ ì§€êµ¬)
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_2 || p.NAME_1 || p.province || p.district || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `ZAF_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = isDistrictLevel ? `zaf_district_${index}` : `zaf_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì§€êµ¬ ì´ë¦„ìœ¼ë¡œ ì£¼ ì°¾ê¸°
                    let provinceInfo = null;
                    let provinceData = null;
                    if (isDistrictLevel) {
                        const districtNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (districtToProvinceMap[districtNameLower]) {
                            provinceInfo = districtToProvinceMap[districtNameLower];
                            provinceData = southAfricaProvinceMapping[provinceInfo.province];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [districtKey, provInfo] of Object.entries(districtToProvinceMap)) {
                                if (districtNameLower.includes(districtKey) || districtKey.includes(districtNameLower)) {
                                    provinceInfo = provInfo;
                                    provinceData = southAfricaProvinceMapping[provInfo.province];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!provinceInfo && p.NAME_1) {
                            const provinceName = p.NAME_1;
                            if (southAfricaProvinceMapping[provinceName]) {
                                provinceInfo = {
                                    province: provinceName,
                                    province_ko: southAfricaProvinceMapping[provinceName].name_ko
                                };
                                provinceData = southAfricaProvinceMapping[provinceName];
                            }
                        }
                    } else {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && southAfricaProvinceMapping[p.NAME_1]) {
                            provinceData = southAfricaProvinceMapping[p.NAME_1];
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isDistrictLevel && provinceData) {
                        // ì£¼ì˜ ì´ ì¸êµ¬/ë©´ì ì„ ì§€êµ¬ ìˆ˜ë¡œ ë‚˜ëˆ„ì–´ í‰ê·  ê³„ì‚°
                        const districtCount = provinceData.districts.length;
                        population = p.population || Math.floor(provinceData.population / districtCount);
                        area = p.area || Math.floor(provinceData.area / districtCount);
                    } else if (!isDistrictLevel && provinceData) {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        population = p.population || provinceData.population;
                        area = p.area || provinceData.area;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isDistrictLevel ? 2000000 : 8000000)) + (isDistrictLevel ? 100000 : 500000);
                        area = p.area || Math.floor(Math.random() * (isDistrictLevel ? 50000 : 200000)) + (isDistrictLevel ? 5000 : 30000);
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName,
                        name_en: p.NAME_2 || p.NAME_1 || p.name || rawName,
                        country: 'South Africa',
                        country_code: 'ZA',
                        admin_level: isDistrictLevel ? 'District' : 'Province',
                        province: provinceInfo ? provinceInfo.province : (p.NAME_1 || null),
                        province_ko: provinceInfo ? provinceInfo.province_ko : (southAfricaProvinceMapping[p.NAME_1] ? southAfricaProvinceMapping[p.NAME_1].name_ko : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 220000) + 160000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#f39c12',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displaySouthAfricaGroupedRegions();
                
                this.cachedGeoJsonData['south-africa'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#f39c12'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isDistrictLevel = geoJsonData.features.length > 40;
            const adminType = isDistrictLevel ? 'ì§€êµ¬' : 'ì£¼';
            console.log('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displaySouthAfricaGroupedRegions() {
        if (!this.southAfricaProvinceMapping) {
            console.log('[South Africa] Province mapping not available');
            return;
        }

        console.log('\n=== ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼, 52ê°œ ì§€êµ¬) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ 9ê°œ ì£¼ (Provinces) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(90));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(35) + '| ì§€êµ¬ ìˆ˜ | ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(90));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(this.southAfricaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.southAfricaProvinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} â€“ ${province.name_ko}`.padEnd(33);
            const districts = province.districts.length.toString().padEnd(7);
            const population = province.population.toLocaleString().padEnd(23);
            const area = province.area.toLocaleString();
            console.log(`${seq} | ${name} | ${districts} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(90));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalDistricts = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'South Africa') {
                const province = regionData.province || 'Unknown';
                if (!groupedRegions[province]) {
                    groupedRegions[province] = {
                        name_ko: regionData.province_ko || province,
                        districts: []
                    };
                }
                groupedRegions[province].districts.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalDistricts++;
            }
        });

        // ì£¼ë³„ë¡œ ì¶œë ¥
        Object.keys(this.southAfricaProvinceMapping).forEach(provinceName => {
            const province = this.southAfricaProvinceMapping[provinceName];
            const loadedDistricts = groupedRegions[provinceName] || { districts: [] };
            
            console.log(`\nğŸ“Œ ${provinceName} (${province.name_ko})`);
            console.log(`   ì¸êµ¬: ${province.population.toLocaleString()}ëª… (2024 ì¶”ì •)`);
            console.log(`   ë©´ì : ${province.area.toLocaleString()} ã¢`);
            console.log(`   ì§€êµ¬ ìˆ˜: ì´ ${province.districts.length}ê°œ (ë¡œë“œë¨: ${loadedDistricts.districts.length}ê°œ)`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // ì˜ˆìƒ ì§€êµ¬ ëª©ë¡
            province.districts.forEach((districtName, idx) => {
                const loadedDistrict = loadedDistricts.districts.find(d => 
                    d.name.toLowerCase().includes(districtName.toLowerCase()) ||
                    districtName.toLowerCase().includes(d.name.toLowerCase())
                );
                
                if (loadedDistrict) {
                    console.log(`   ${idx + 1}. ${districtName} âœ“`);
                    console.log(`      â””â”€ ë¡œë“œëœ ì´ë¦„: ${loadedDistrict.name}`);
                    console.log(`      â””â”€ ID: ${loadedDistrict.id}`);
                    console.log(`      â””â”€ ì¸êµ¬: ${loadedDistrict.population.toLocaleString()}ëª…`);
                    console.log(`      â””â”€ ë©´ì : ${loadedDistrict.area.toLocaleString()} kmÂ²`);
                } else {
                    console.log(`   ${idx + 1}. ${districtName} (ë°ì´í„° ì—†ìŒ)`);
                }
            });
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Provinces): ${Object.keys(this.southAfricaProvinceMapping).length}ê°œ`);
        console.log(`   â€¢ ì§€êµ¬ (Districts): ${totalDistricts}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateSouthAfricaGroupedHTML(groupedRegions);
        console.log('%cë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #4ecdc4; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateSouthAfricaGroupedHTML(groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #4ecdc4; margin-top: 0;">ë‚¨ì•„í”„ë¦¬ì¹´ê³µí™”êµ­ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼, 52ê°œ ì§€êµ¬)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<div style="margin-bottom: 20px; overflow-x: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
        html += '<thead><tr style="background: rgba(78, 205, 196, 0.2);">';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(78, 205, 196, 0.3);">ìˆœë²ˆ</th>';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(78, 205, 196, 0.3);">ì£¼ (ì˜ë¬¸ / í•œê¸€)</th>';
        html += '<th style="padding: 8px; text-align: center; border: 1px solid rgba(78, 205, 196, 0.3);">ì§€êµ¬ ìˆ˜</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.3);">ì¸êµ¬ (ëª…, 2024 ì¶”ì •)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.3);">ë©´ì  (ã¢)</th>';
        html += '</tr></thead><tbody>';
        
        Object.keys(this.southAfricaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.southAfricaProvinceMapping[provinceName];
            html += '<tr style="border-bottom: 1px solid rgba(78, 205, 196, 0.1);">';
            html += `<td style="padding: 8px; border: 1px solid rgba(78, 205, 196, 0.1);">${idx + 1}</td>`;
            html += `<td style="padding: 8px; border: 1px solid rgba(78, 205, 196, 0.1);">${provinceName} â€“ ${province.name_ko}</td>`;
            html += `<td style="padding: 8px; text-align: center; border: 1px solid rgba(78, 205, 196, 0.1);">${province.districts.length}</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.1);">${province.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(78, 205, 196, 0.1);">${province.area.toLocaleString()}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        
        Object.keys(this.southAfricaProvinceMapping).forEach((provinceName, pIdx) => {
            const province = this.southAfricaProvinceMapping[provinceName];
            const loadedDistricts = groupedRegions[provinceName] || { districts: [] };
            
            html += `<div style="margin-bottom: 20px; padding: 15px; background: rgba(78, 205, 196, 0.1); border-left: 4px solid #4ecdc4; border-radius: 4px;">`;
            html += `<h4 style="color: #feca57; margin: 0 0 10px 0;">${pIdx + 1}. ${provinceName} (${province.name_ko})</h4>`;
            html += `<p style="color: #aaa; margin: 0 0 5px 0; font-size: 12px;">ì¸êµ¬: <span style="color: #4ecdc4;">${province.population.toLocaleString()}ëª…</span> (2024 ì¶”ì •) | ë©´ì : <span style="color: #4ecdc4;">${province.area.toLocaleString()} ã¢</span></p>`;
            html += `<p style="color: #aaa; margin: 0 0 10px 0; font-size: 12px;">ì§€êµ¬ ìˆ˜: ì´ ${province.districts.length}ê°œ (ë¡œë“œë¨: ${loadedDistricts.districts.length}ê°œ)</p>`;
            html += `<ul style="margin: 0; padding-left: 20px; list-style: none;">`;
            
            province.districts.forEach((districtName, dIdx) => {
                const loadedDistrict = loadedDistricts.districts.find(d => 
                    d.name.toLowerCase().includes(districtName.toLowerCase()) ||
                    districtName.toLowerCase().includes(d.name.toLowerCase())
                );
                
                html += `<li style="margin: 5px 0; color: ${loadedDistrict ? '#4ecdc4' : '#666'};">
                    ${dIdx + 1}. ${districtName} ${loadedDistrict ? 'âœ“' : '(ë°ì´í„° ì—†ìŒ)'}
                    ${loadedDistrict ? `<span style="color: #aaa; font-size: 11px;"> - ì¸êµ¬: ${loadedDistrict.population.toLocaleString()}ëª…, ë©´ì : ${loadedDistrict.area.toLocaleString()} kmÂ²</span>` : ''}
                </li>`;
            });
            
            html += `</ul></div>`;
        });
        
        html += '</div>';
        return html;
    }

    // ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ (ì£¼/Provincia ë‹¨ìœ„ - 23ê°œ ì£¼)
    async loadArgentinaData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['argentina']) {
                geoJsonData = this.cachedGeoJsonData['argentina'];
            } else {
                // ì•„ë¥´í—¨í‹°ë‚˜ 23ê°œ ì£¼ ë§¤í•‘ (2024 ì¶”ì • ì¸êµ¬ ë° ë©´ì )
                const argentinaProvinceMapping = {
                    'Buenos Aires': {
                        name_ko: 'ë¶€ì—ë…¸ìŠ¤ì•„ì´ë ˆìŠ¤',
                        population: 17500000,
                        area: 307571
                    },
                    'Catamarca': {
                        name_ko: 'ì¹´íƒ€ë§ˆë¥´ì¹´',
                        population: 430000,
                        area: 102602
                    },
                    'Chaco': {
                        name_ko: 'ì°¨ì½”',
                        population: 1200000,
                        area: 99633
                    },
                    'Chubut': {
                        name_ko: 'ì¶”ë¶€íŠ¸',
                        population: 600000,
                        area: 224686
                    },
                    'CÃ³rdoba': {
                        name_ko: 'ì½”ë¥´ë„ë°”',
                        population: 3800000,
                        area: 165321
                    },
                    'Corrientes': {
                        name_ko: 'ì½”ë¦¬ì—”í…ŒìŠ¤',
                        population: 1300000,
                        area: 88199
                    },
                    'Entre RÃ­os': {
                        name_ko: 'ì—”íŠ¸ë ˆë¦¬ì˜¤ìŠ¤',
                        population: 1400000,
                        area: 78781
                    },
                    'Formosa': {
                        name_ko: 'í¬ë¥´ëª¨ì‚¬',
                        population: 600000,
                        area: 72066
                    },
                    'Jujuy': {
                        name_ko: 'í›„í›„ì´',
                        population: 800000,
                        area: 53219
                    },
                    'La Pampa': {
                        name_ko: 'ë¼íŒœíŒŒ',
                        population: 360000,
                        area: 143440
                    },
                    'La Rioja': {
                        name_ko: 'ë¼ë¦¬ì˜¤í•˜',
                        population: 420000,
                        area: 89680
                    },
                    'Mendoza': {
                        name_ko: 'ë©˜ë„ì‚¬',
                        population: 2000000,
                        area: 148827
                    },
                    'Misiones': {
                        name_ko: 'ë¯¸ì‹œì˜¤ë„¤ìŠ¤',
                        population: 1300000,
                        area: 29801
                    },
                    'NeuquÃ©n': {
                        name_ko: 'ë„¤ìš°ì¼„',
                        population: 700000,
                        area: 94078
                    },
                    'RÃ­o Negro': {
                        name_ko: 'ë¦¬ì˜¤ë„¤ê·¸ë¡œ',
                        population: 750000,
                        area: 203013
                    },
                    'Salta': {
                        name_ko: 'ì‚´íƒ€',
                        population: 1500000,
                        area: 155488
                    },
                    'San Juan': {
                        name_ko: 'ì‚°í›„ì•ˆ',
                        population: 850000,
                        area: 89651
                    },
                    'San Luis': {
                        name_ko: 'ì‚°ë£¨ì´ìŠ¤',
                        population: 550000,
                        area: 76748
                    },
                    'Santa Cruz': {
                        name_ko: 'ì‚°íƒ€í¬ë£¨ìŠ¤',
                        population: 350000,
                        area: 243943
                    },
                    'Santa Fe': {
                        name_ko: 'ì‚°íƒ€í˜',
                        population: 3600000,
                        area: 133007
                    },
                    'Santiago del Estero': {
                        name_ko: 'ì‚°í‹°ì•„ê³ ë¸ì—ìŠ¤í…Œë¡œ',
                        population: 1000000,
                        area: 136351
                    },
                    'Tierra del Fuego': {
                        name_ko: 'í‹°ì—ë¼ë¸í‘¸ì—ê³ ',
                        population: 190000,
                        area: 21263
                    },
                    'TucumÃ¡n': {
                        name_ko: 'íˆ¬ì¿ ë§Œ',
                        population: 1800000,
                        area: 22524
                    }
                };

                const candidateUrls = [
                    // geoBoundaries ARG ADM1
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ARG/ADM1/geoBoundaries-ARG-ADM1.geojson',
                    // click_that_hood argentina
                    'https://raw.githubusercontent.com/codeforgermany/click_that_hood/master/public/data/argentina.geojson',
                    // Natural Earth Argentina provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì•„ë¥´í—¨í‹°ë‚˜ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ARG' || admin === 'Argentina' || iso2 === 'AR';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Argentina] Filtered Natural Earth/global dataset to Argentina only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 15) {
                            geoJsonData = data;
                            console.log('[Argentina] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 15) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Argentina] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 15 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Argentina] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Argentina] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Argentina dataset available');
                
                // ì£¼ ë§¤í•‘ì„ í´ë˜ìŠ¤ì— ì €ì¥
                this.argentinaProvinceMapping = argentinaProvinceMapping;
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Province_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `ARG_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `arg_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ì •ë³´ ì°¾ê¸°
                    let provinceData = null;
                    const provinceName = rawName;
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    if (argentinaProvinceMapping[provinceName]) {
                        provinceData = argentinaProvinceMapping[provinceName];
                    } else {
                        // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„ (ëŒ€ì†Œë¬¸ì ë¬´ì‹œ)
                        const provinceNameLower = provinceName.toLowerCase();
                        for (const [key, value] of Object.entries(argentinaProvinceMapping)) {
                            if (key.toLowerCase() === provinceNameLower || 
                                provinceNameLower.includes(key.toLowerCase()) ||
                                key.toLowerCase().includes(provinceNameLower)) {
                                provinceData = value;
                                break;
                            }
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    const population = p.population || (provinceData ? provinceData.population : Math.floor(Math.random() * 4000000) + 300000);
                    const area = p.area || (provinceData ? provinceData.area : Math.floor(Math.random() * 300000) + 50000);
                    const name_ko = provinceData ? provinceData.name_ko : rawName;
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: name_ko,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: 'Argentina',
                        country_code: 'AR',
                        admin_level: 'Province',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 210000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#74b9ff',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayArgentinaGroupedRegions();
                
                this.cachedGeoJsonData['argentina'] = geoJsonData;
            }

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#74b9ff'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì•„ë¥´í—¨í‹°ë‚˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì•„ë¥´í—¨í‹°ë‚˜ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displayArgentinaGroupedRegions() {
        if (!this.argentinaProvinceMapping) {
            console.log('[Argentina] Province mapping not available');
            return;
        }

        console.log('\n=== ì•„ë¥´í—¨í‹°ë‚˜ í–‰ì •êµ¬ì—­ (23ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ì•„ë¥´í—¨í‹°ë‚˜ 23ê°œ ì£¼ ì¸êµ¬ ë° ë©´ì  (2024 ì¶”ì •)');
        console.log('â”€'.repeat(90));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(35) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(90));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(this.argentinaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.argentinaProvinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} (${province.name_ko})`.padEnd(33);
            const population = province.population.toLocaleString().padEnd(23);
            const area = province.area.toLocaleString();
            console.log(`${seq} | ${name} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(90));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const loadedProvinces = [];
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Argentina') {
                loadedProvinces.push({
                    name: regionData.name,
                    name_ko: regionData.name_ko,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
            }
        });

        console.log(`\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Provinces): ${Object.keys(this.argentinaProvinceMapping).length}ê°œ`);
        console.log(`   â€¢ ë¡œë“œëœ í–‰ì •êµ¬ì—­: ${loadedProvinces.length}ê°œ`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateArgentinaGroupedHTML(loadedProvinces);
        console.log('%cì•„ë¥´í—¨í‹°ë‚˜ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #74b9ff; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateArgentinaGroupedHTML(loadedProvinces) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #74b9ff; margin-top: 0;">ì•„ë¥´í—¨í‹°ë‚˜ í–‰ì •êµ¬ì—­ (23ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<div style="margin-bottom: 20px; overflow-x: auto;">';
        html += '<table style="width: 100%; border-collapse: collapse; font-size: 12px;">';
        html += '<thead><tr style="background: rgba(116, 185, 255, 0.2);">';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(116, 185, 255, 0.3);">ìˆœë²ˆ</th>';
        html += '<th style="padding: 8px; text-align: left; border: 1px solid rgba(116, 185, 255, 0.3);">ì£¼ (ì˜ë¬¸ / í•œê¸€)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.3);">ì¸êµ¬ (ëª…, 2024 ì¶”ì •)</th>';
        html += '<th style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.3);">ë©´ì  (ã¢)</th>';
        html += '</tr></thead><tbody>';
        
        Object.keys(this.argentinaProvinceMapping).forEach((provinceName, idx) => {
            const province = this.argentinaProvinceMapping[provinceName];
            html += '<tr style="border-bottom: 1px solid rgba(116, 185, 255, 0.1);">';
            html += `<td style="padding: 8px; border: 1px solid rgba(116, 185, 255, 0.1);">${idx + 1}</td>`;
            html += `<td style="padding: 8px; border: 1px solid rgba(116, 185, 255, 0.1);">${provinceName} (${province.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.1);">${province.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right; border: 1px solid rgba(116, 185, 255, 0.1);">${province.area.toLocaleString()}</td>`;
            html += '</tr>';
        });
        
        html += '</tbody></table></div>';
        html += '</div>';
        return html;
    }

    async loadEuropeanUnionData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['european-union']) {
                geoJsonData = this.cachedGeoJsonData['european-union'];
            } else {
                // EU íšŒì›êµ­ ëª©ë¡ (ì£¼ìš” 27ê°œ íšŒì›êµ­)
                const euCountries = [
                    { code: 'DEU', name: 'Germany', name_ko: 'ë…ì¼' },
                    { code: 'FRA', name: 'France', name_ko: 'í”„ë‘ìŠ¤' },
                    { code: 'ITA', name: 'Italy', name_ko: 'ì´íƒˆë¦¬ì•„' },
                    { code: 'ESP', name: 'Spain', name_ko: 'ìŠ¤í˜ì¸' },
                    { code: 'POL', name: 'Poland', name_ko: 'í´ë€ë“œ' },
                    { code: 'NLD', name: 'Netherlands', name_ko: 'ë„¤ëœë€ë“œ' },
                    { code: 'BEL', name: 'Belgium', name_ko: 'ë²¨ê¸°ì—' },
                    { code: 'GRC', name: 'Greece', name_ko: 'ê·¸ë¦¬ìŠ¤' },
                    { code: 'PRT', name: 'Portugal', name_ko: 'í¬ë¥´íˆ¬ê°ˆ' },
                    { code: 'CZE', name: 'Czech Republic', name_ko: 'ì²´ì½”' },
                    { code: 'HUN', name: 'Hungary', name_ko: 'í—ê°€ë¦¬' },
                    { code: 'SWE', name: 'Sweden', name_ko: 'ìŠ¤ì›¨ë´' },
                    { code: 'AUT', name: 'Austria', name_ko: 'ì˜¤ìŠ¤íŠ¸ë¦¬ì•„' },
                    { code: 'DNK', name: 'Denmark', name_ko: 'ë´ë§ˆí¬' },
                    { code: 'FIN', name: 'Finland', name_ko: 'í•€ë€ë“œ' },
                    { code: 'ROU', name: 'Romania', name_ko: 'ë£¨ë§ˆë‹ˆì•„' },
                    { code: 'BGR', name: 'Bulgaria', name_ko: 'ë¶ˆê°€ë¦¬ì•„' },
                    { code: 'HRV', name: 'Croatia', name_ko: 'í¬ë¡œì•„í‹°ì•„' },
                    { code: 'SVK', name: 'Slovakia', name_ko: 'ìŠ¬ë¡œë°”í‚¤ì•„' },
                    { code: 'IRL', name: 'Ireland', name_ko: 'ì•„ì¼ëœë“œ' },
                    { code: 'LTU', name: 'Lithuania', name_ko: 'ë¦¬íˆ¬ì•„ë‹ˆì•„' },
                    { code: 'SVN', name: 'Slovenia', name_ko: 'ìŠ¬ë¡œë² ë‹ˆì•„' },
                    { code: 'LVA', name: 'Latvia', name_ko: 'ë¼íŠ¸ë¹„ì•„' },
                    { code: 'EST', name: 'Estonia', name_ko: 'ì—ìŠ¤í† ë‹ˆì•„' },
                    { code: 'CYP', name: 'Cyprus', name_ko: 'í‚¤í”„ë¡œìŠ¤' },
                    { code: 'LUX', name: 'Luxembourg', name_ko: 'ë£©ì…ˆë¶€ë¥´í¬' },
                    { code: 'MLT', name: 'Malta', name_ko: 'ëª°íƒ€' }
                ];
                
                const allFeatures = [];
                const idSet = new Set();
                
                // EU êµ­ê°€ ISO ì½”ë“œ ë§¤í•‘ (2ìë¦¬ ì½”ë“œ)
                const iso2Codes = {
                    'DEU': 'DE', 'FRA': 'FR', 'ITA': 'IT', 'ESP': 'ES', 'POL': 'PL',
                    'NLD': 'NL', 'BEL': 'BE', 'GRC': 'GR', 'PRT': 'PT', 'CZE': 'CZ',
                    'HUN': 'HU', 'SWE': 'SE', 'AUT': 'AT', 'DNK': 'DK', 'FIN': 'FI',
                    'ROU': 'RO', 'BGR': 'BG', 'HRV': 'HR', 'SVK': 'SK', 'IRL': 'IE',
                    'LTU': 'LT', 'SVN': 'SI', 'LVA': 'LV', 'EST': 'EE', 'CYP': 'CY',
                    'LUX': 'LU', 'MLT': 'MT'
                };
                
                // ë¨¼ì € ì „ì„¸ê³„ ì§€ë„ í•œ ë²ˆë§Œ ë¡œë“œ ì‹œë„ (ë” íš¨ìœ¨ì )
                let worldData = null;
                try {
                    const worldResp = await fetch('https://raw.githubusercontent.com/holtzy/D3-graph-gallery/master/DATA/world.geojson', { cache: 'no-store' });
                    if (worldResp.ok) {
                        worldData = await worldResp.json();
                        console.log('[EU] Loaded world data for filtering');
                    }
                } catch (e) {
                    console.warn('[EU] Failed to load world data:', e.message);
                }
                
                // ê° êµ­ê°€ ë°ì´í„°ë¥¼ ë³‘ë ¬ë¡œ ë¡œë“œ
                const loadPromises = euCountries.map(async (country, index) => {
                    const iso2 = iso2Codes[country.code] || country.code.substring(0, 2);
                    let countryData = null;
                    
                    // ë°©ë²• 1: ì „ì„¸ê³„ ì§€ë„ì—ì„œ í•„í„°ë§ (ê°€ì¥ ì•ˆì •ì )
                    if (worldData && worldData.features) {
                        const filtered = worldData.features.filter(f => {
                            const props = f.properties || {};
                            const name = (props.name || props.NAME || props.NAME_0 || '').toLowerCase();
                            const code = (props.ISO_A2 || props.ISO_A3 || props.ADM0_A3 || props.iso_a2 || props.iso_a3 || '').toUpperCase();
                            const iso2Upper = iso2.toUpperCase();
                            const countryNameLower = country.name.toLowerCase();
                            
                            return name === countryNameLower ||
                                   name.includes(countryNameLower.split(' ')[0]) ||
                                   code === country.code ||
                                   code === iso2Upper ||
                                   (code.length === 2 && code === iso2Upper);
                        });
                        
                        if (filtered.length > 0) {
                            countryData = filtered;
                            console.log(`[EU] Loaded ${country.name} from world data`);
                        }
                    }
                    
                    // ë°©ë²• 2: ê°œë³„ êµ­ê°€ íŒŒì¼ ì‹œë„
                    if (!countryData) {
                        const candidateUrls = [
                            `https://raw.githubusercontent.com/johan/world.geo.json/master/countries/${iso2.toLowerCase()}.geo.json`,
                            `https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/${country.code}/ADM1/geoBoundaries-${country.code}-ADM1.geojson`
                        ];
                        
                        for (const url of candidateUrls) {
                            try {
                                const resp = await fetch(url, { cache: 'no-store' });
                                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                                const data = await resp.json();
                                
                                if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                                    countryData = data.features;
                                    console.log(`[EU] Loaded ${country.name} from ${url}`);
                                    break;
                                } else if (data && data.type === 'Feature') {
                                    countryData = [data];
                                    console.log(`[EU] Loaded ${country.name} as single feature`);
                                    break;
                                }
                            } catch (e) {
                                continue;
                            }
                        }
                    }
                    
                    // ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨ ì‹œ í•´ë‹¹ êµ­ê°€ ê±´ë„ˆë›°ê¸°
                    if (!countryData || countryData.length === 0) {
                        console.warn(`[EU] Failed to load ${country.name} (${country.code}), skipping`);
                        return null;
                    }
                    
                    // ê° featureì— EU ì†ì„± ì¶”ê°€
                    countryData.forEach((feature, featureIndex) => {
                        const p = feature.properties || {};
                        const rawName = p.NAME_0 || p.NAME || p.name || p.NAME_EN || country.name;
                        const baseIdSrc = p.ISO_A3 || p.ISO_A2 || p.ADM0_A3 || country.code || rawName;
                        let baseId = `${baseIdSrc.toString().toLowerCase().replace(/[^a-z0-9]/g, '_')}_eu`;
                        let finalId = baseId;
                        let c = 1;
                        while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                        idSet.add(finalId);
                        
                        feature.properties = {
                            ...p,
                            id: finalId,
                            name: rawName,
                            name_ko: country.name_ko,
                            name_en: country.name,
                            country: 'European Union',
                            country_code: 'EU',
                            eu_member: true,
                            admin_level: 'Country',
                            population: p.population || Math.floor(Math.random() * 10000000) + 1000000,
                            area: p.area || Math.floor(Math.random() * 500000) + 10000,
                            ad_status: 'available',
                            ad_price: Math.floor(Math.random() * 500000) + 200000,
                            revenue: 0,
                            company: null,
                            logo: null,
                            color: '#4ecdc4',
                            border_color: '#ffffff',
                            border_width: 1
                        };
                        
                        allFeatures.push(feature);
                    });
                    
                    return countryData; // ì„±ê³µì ìœ¼ë¡œ ë¡œë“œëœ ë°ì´í„° ë°˜í™˜
                });
                
                const loadedCountries = await Promise.all(loadPromises);
                
                // null ê°’ í•„í„°ë§ (ë¡œë“œ ì‹¤íŒ¨í•œ êµ­ê°€ ì œì™¸)
                const validFeatures = allFeatures.filter(f => f !== null && f !== undefined);
                
                geoJsonData = {
                    type: 'FeatureCollection',
                    features: validFeatures
                };
                
                console.log(`[EU] Loaded ${validFeatures.length} features from ${euCountries.length} countries`);
                this.cachedGeoJsonData['european-union'] = geoJsonData;
                
                // regionDataì— ì €ì¥ (ìœ íš¨í•œ featuresë§Œ)
                validFeatures.forEach(feature => {
                    if (feature && feature.properties && feature.properties.id) {
                        this.regionData.set(feature.properties.id, feature.properties);
                    }
                });
            }
            
            // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            
            // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': [
                            'case',
                            ['==', ['get', 'ad_status'], 'occupied'],
                            '#ff6b6b',
                            ['==', ['get', 'ad_status'], 'selected'],
                            '#feca57',
                            '#4ecdc4'
                        ],
                        'fill-opacity': 0.6
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            }
            
            console.log('ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ êµ­ê°€');
            this.showNotification(`ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ êµ­ê°€`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìœ ëŸ½ì—°í•© ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìœ ëŸ½ì—°í•© ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // 15ê°œ ì£¼ìš” ìœ ëŸ½ ê²½ì œêµ­ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜ë“¤
    async loadEuropeanCountryData(countryCode, countryName, countryNameKo, countryCodeIso, color) {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData[countryCode]) {
                geoJsonData = this.cachedGeoJsonData[countryCode];
            } else {
                // ì—¬ëŸ¬ ë°ì´í„° ì†ŒìŠ¤ ì‹œë„ (í”„ë‘ìŠ¤/ë…ì¼ê³¼ ê°™ì€ ë°©ì‹ - ADM1 í–‰ì •êµ¬ì—­ ë°ì´í„° ìš°ì„ )
                const iso2 = countryCodeIso.substring(0, 2);
                const candidateUrls = [
                    `https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/${countryCodeIso}/ADM1/geoBoundaries-${countryCodeIso}-ADM1.geojson`,
                    `https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson`
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ì „ì„¸ê³„ ë°ì´í„°ì¸ ê²½ìš° í•´ë‹¹ êµ­ê°€ í–‰ì •êµ¬ì—­ë§Œ í•„í„°ë§
                        if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2Code = (p.iso_a2 || '').toUpperCase();
                                return a3 === countryCodeIso || admin === countryName || iso2Code === iso2.toUpperCase();
                            });
                            if (filtered.length > 0) {
                                console.log(`[${countryName}] Filtered Natural Earth/global dataset to ${countryName} only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        // ADM1 ë°ì´í„°ì¸ ê²½ìš° (í–‰ì •êµ¬ì—­ ë ˆë²¨)
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                            // ADM1 ë°ì´í„°ëŠ” ë³´í†µ 5ê°œ ì´ìƒì˜ í–‰ì •êµ¬ì—­ì„ ê°€ì§
                            if (data.features.length >= 1) {
                                geoJsonData = data;
                                console.log(`[${countryName}] Loaded ADM1 from`, url, 'features:', data.features.length);
                                break;
                            }
                        }
                        
                        if (Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log(`[${countryName}] Loaded (normalized) from`, url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log(`[${countryName}] Loaded (array -> FC) from`, url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn(`[${countryName}] Failed loading from`, url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error(`No ${countryName} dataset available`);
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `${countryCodeIso}_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `${countryCode.toLowerCase()}_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: rawName,
                        name_en: p.NAME_1 || p.name || rawName,
                        country: countryName,
                        country_code: countryCodeIso.substring(0, 2),
                        admin_level: 'Region/Province',
                        population: p.population || Math.floor(Math.random() * 5000000) + 100000,
                        area: p.area || Math.floor(Math.random() * 50000) + 1000,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: color,
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData[countryCode] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', color], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ:`, geoJsonData.features.length, 'ê°œ í–‰ì •êµ¬ì—­');
            this.showNotification(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
            this.showNotification(`${countryNameKo} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
        }
    }
    
    normalizeRegionKey(value) {
        if (!value && value !== 0) return '';
        return value.toString()
            .trim()
            .toLowerCase()
            .normalize('NFD')
            .replace(/[\u0300-\u036f]/g, '')
            .replace(/[^a-z0-9\s\-]/g, ' ')
            .replace(/\s+/g, ' ')
            .trim();
    }

    async fetchCountryGeoJson(countryKey, countryName, countryCodeIso, candidateUrls = []) {
        if (!this.rawGeoJsonCache) {
            this.rawGeoJsonCache = {};
        }
        if (this.rawGeoJsonCache[countryKey]) {
            return JSON.parse(JSON.stringify(this.rawGeoJsonCache[countryKey]));
        }

        const iso3 = countryCodeIso.toUpperCase();
        const iso2 = iso3.substring(0, 2).toUpperCase();
        const defaultUrls = [
            `https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/${iso3}/ADM1/geoBoundaries-${iso3}-ADM1.geojson`,
            `https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson`
        ];
        const urls = [...candidateUrls, ...defaultUrls].filter((url, idx, arr) => arr.indexOf(url) === idx);

        let geoJsonData = null;
        let lastError = null;

        for (const url of urls) {
            try {
                const resp = await fetch(url, { cache: 'no-store' });
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();

                if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                    const filtered = data.features.filter((feature) => {
                        const p = feature.properties || {};
                        const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                        const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                        const iso2Code = (p.iso_a2 || '').toUpperCase();
                        return a3 === iso3 || admin === countryName || iso2Code === iso2;
                    });
                    if (filtered.length > 0) {
                        console.log(`[${countryName}] Filtered Natural Earth/global dataset to ${countryName} only: ${filtered.length} features`);
                        geoJsonData = { type: 'FeatureCollection', features: filtered };
                        break;
                    }
                }

                if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                    geoJsonData = data;
                    console.log(`[${countryName}] Loaded from`, url, 'features:', data.features.length);
                    break;
                }
                if (Array.isArray(data.features) && data.features.length > 0) {
                    geoJsonData = { type: 'FeatureCollection', features: data.features };
                    console.log(`[${countryName}] Loaded (normalized) from`, url, 'features:', data.features.length);
                    break;
                }
                if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                    geoJsonData = { type: 'FeatureCollection', features: data };
                    console.log(`[${countryName}] Loaded (array -> FC) from`, url, 'features:', data.length);
                    break;
                }
                lastError = new Error('Invalid data shape');
            } catch (error) {
                lastError = error;
                console.warn(`[${countryName}] Failed loading from`, url, error);
            }
        }

        if (!geoJsonData) {
            throw lastError || new Error(`No ${countryName} dataset available`);
        }

        this.rawGeoJsonCache[countryKey] = geoJsonData;
        return JSON.parse(JSON.stringify(geoJsonData));
    }

    async loadCustomEuropeanCountry(options) {
        const {
            countryKey,
            countryName,
            countryNameKo,
            countryCodeIso,
            defaultColor = '#27ae60',
            adminLevel = 'Region/Province',
            mapping,
            candidateUrls = [],
            onAfterProcess
        } = options;

        try {
            let geoJsonData;
            if (this.cachedGeoJsonData[countryKey]) {
                geoJsonData = this.cachedGeoJsonData[countryKey];
            } else {
                geoJsonData = await this.fetchCountryGeoJson(countryKey, countryName, countryCodeIso, candidateUrls);

                const aliasMap = new Map();
                Object.entries(mapping).forEach(([key, meta]) => {
                    const aliases = [
                        key,
                        meta.name_en,
                        meta.name_local,
                        meta.name_native,
                        ...(meta.aliases || [])
                    ];
                    aliases.forEach((alias) => {
                        if (!alias) return;
                        const normalized = this.normalizeRegionKey(alias);
                        if (normalized && !aliasMap.has(normalized)) {
                            aliasMap.set(normalized, key);
                        }
                    });
                });

                const idSet = new Set();
                const iso2 = countryCodeIso.substring(0, 2).toUpperCase();

                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = (p.name || p.NAME_1 || p.NAME || p.NAME_2 || p.admin || `Region_${index}`).toString();
                    const normalizedRaw = this.normalizeRegionKey(rawName);

                    let matchedKey = aliasMap.get(normalizedRaw);
                    if (!matchedKey) {
                        for (const [aliasKey, regionKey] of aliasMap.entries()) {
                            if (!aliasKey) continue;
                            if (normalizedRaw.includes(aliasKey) || aliasKey.includes(normalizedRaw)) {
                                matchedKey = regionKey;
                                break;
                            }
                        }
                    }

                    const meta = matchedKey ? mapping[matchedKey] : null;
                    if (!meta) {
                        console.warn(`[${countryName}] Unmatched region in dataset: ${rawName}`);
                    }

                    const baseIdSrc = p.hasc || p.shapeID || rawName || `${countryCodeIso}_${index}`;
                    let baseId = this.normalizeRegionKey(baseIdSrc).replace(/\s+/g, '_');
                    if (!baseId) baseId = `${countryKey}_region_${index}`;
                    let finalId = baseId;
                    let duplicateIndex = 1;
                    while (idSet.has(finalId)) {
                        finalId = `${baseId}_${duplicateIndex++}`;
                    }
                    idSet.add(finalId);

                    const population = meta?.population ?? p.population ?? (Math.floor(Math.random() * 500000) + 200000);
                    const area = meta?.area ?? p.area ?? (Math.floor(Math.random() * 5000) + 2000);
                    const englishName = meta?.name_en || rawName;
                    const localName = meta?.name_local || rawName;

                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: englishName,
                        name_en: englishName,
                        name_local: localName,
                        name_ko: meta?.name_ko || rawName,
                        country: countryName,
                        country_code: iso2,
                        admin_level: meta?.admin_level || adminLevel,
                        population,
                        area,
                        ad_status: 'available',
                        ad_price: meta?.ad_price || Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: meta?.color || defaultColor,
                        border_color: '#ffffff',
                        border_width: 1
                    };

                    if (meta?.extra && typeof meta.extra === 'object') {
                        Object.assign(feature.properties, meta.extra);
                    }

                    this.regionData.set(finalId, feature.properties);
                });

                this.cachedGeoJsonData[countryKey] = geoJsonData;

                if (typeof onAfterProcess === 'function') {
                    onAfterProcess(geoJsonData, mapping);
                }
            }

            const fillColorExpression = ['case', ['==', ['get', 'ad_status'], 'occupied'], '#ff6b6b', ['coalesce', ['get', 'color'], defaultColor]];

            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }

            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({
                    id: 'regions-fill',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': fillColorExpression,
                        'fill-opacity': 0.6
                    }
                });
                this.map.addLayer({
                    id: 'regions-border',
                    type: 'line',
                    source: 'world-regions',
                    paint: {
                        'line-color': '#ffffff',
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
                this.map.addLayer({
                    id: 'regions-hover',
                    type: 'fill',
                    source: 'world-regions',
                    paint: {
                        'fill-color': '#feca57',
                        'fill-opacity': 0
                    },
                    filter: ['==', 'id', '']
                });
                if (!this.eventListenersAdded) {
                    this.setupEventListeners();
                    this.eventListenersAdded = true;
                }
            } else {
                this.map.setPaintProperty('regions-fill', 'fill-color', fillColorExpression);
            }

            console.log(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ:`, geoJsonData.features.length, 'ê°œ í–‰ì •êµ¬ì—­');
            this.showNotification(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error(`${countryNameKo} ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:`, error);
            this.showNotification(`${countryNameKo} ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.`, 'error');
        }
    }

    // ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ (17ê°œ ìì¹˜ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)
    async loadSpainData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['spain']) {
                geoJsonData = this.cachedGeoJsonData['spain'];
            } else {
                // ìŠ¤í˜ì¸ 17ê°œ ìì¹˜ì§€ì—­ê³¼ 52ê°œ ì£¼ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const spainAutonomousCommunityMapping = {
                    'AndalucÃ­a': {
                        name_ko: 'ì•ˆë‹¬ë£¨ì‹œì•„',
                        name_en: 'AndalucÃ­a',
                        population: 8600000,
                        area: 87268,
                        provinces: [
                            'AlmerÃ­a', 'CÃ¡diz', 'CÃ³rdoba', 'Granada', 'Huelva', 'JaÃ©n', 'MÃ¡laga', 'Sevilla'
                        ]
                    },
                    'AragÃ³n': {
                        name_ko: 'ì•„ë¼ê³¤',
                        name_en: 'AragÃ³n',
                        population: 1350000,
                        area: 47720,
                        provinces: [
                            'Huesca', 'Zaragoza', 'Teruel'
                        ]
                    },
                    'Asturias': {
                        name_ko: 'ì•„ìŠ¤íˆ¬ë¦¬ì•„ìŠ¤',
                        name_en: 'Asturias',
                        population: 1000000,
                        area: 10603,
                        provinces: [
                            'Asturias', 'Oviedo'
                        ]
                    },
                    'Islas Baleares': {
                        name_ko: 'ë°œë ˆì•„ë ˆìŠ¤ ì œë„',
                        name_en: 'Balearic Islands',
                        population: 1250000,
                        area: 4992,
                        provinces: [
                            'Islas Baleares', 'Balears', 'Palma de Mallorca'
                        ]
                    },
                    'PaÃ­s Vasco': {
                        name_ko: 'ë°”ìŠ¤í¬ ì§€ë°©',
                        name_en: 'Basque Country',
                        population: 2200000,
                        area: 7234,
                        provinces: [
                            'Ãlava', 'Gipuzkoa', 'Bizkaia', 'Vizcaya', 'GuipÃºzcoa'
                        ]
                    },
                    'Islas Canarias': {
                        name_ko: 'ì¹´ë‚˜ë¦¬ì•„ ì œë„',
                        name_en: 'Canary Islands',
                        population: 2250000,
                        area: 7447,
                        provinces: [
                            'Las Palmas', 'Santa Cruz de Tenerife'
                        ]
                    },
                    'Cantabria': {
                        name_ko: 'ì¹¸íƒ€ë¸Œë¦¬ì•„',
                        name_en: 'Cantabria',
                        population: 590000,
                        area: 5321,
                        provinces: [
                            'Cantabria', 'Santander'
                        ]
                    },
                    'Castilla-La Mancha': {
                        name_ko: 'ì¹´ìŠ¤í‹°ì•¼ ë¼ ë§Œì°¨',
                        name_en: 'Castilla-La Mancha',
                        population: 2100000,
                        area: 79463,
                        provinces: [
                            'Albacete', 'Ciudad Real', 'Cuenca', 'Guadalajara', 'Toledo'
                        ]
                    },
                    'Castilla y LeÃ³n': {
                        name_ko: 'ì¹´ìŠ¤í‹°ì•¼ ì´ ë ˆì˜¨',
                        name_en: 'Castilla y LeÃ³n',
                        population: 2350000,
                        area: 94224,
                        provinces: [
                            'Ãvila', 'Burgos', 'LeÃ³n', 'Palencia', 'Salamanca', 'Segovia', 'Soria', 'Valladolid', 'Zamora'
                        ]
                    },
                    'CataluÃ±a': {
                        name_ko: 'ì¹´íƒˆë£¨ëƒ',
                        name_en: 'Catalonia',
                        population: 7900000,
                        area: 32114,
                        provinces: [
                            'Barcelona', 'Girona', 'Lleida', 'Tarragona'
                        ]
                    },
                    'Extremadura': {
                        name_ko: 'ì—ìŠ¤íŠ¸ë ˆë§ˆë‘ë¼',
                        name_en: 'Extremadura',
                        population: 1050000,
                        area: 41634,
                        provinces: [
                            'Badajoz', 'CÃ¡ceres'
                        ]
                    },
                    'Galicia': {
                        name_ko: 'ê°ˆë¦¬ì‹œì•„',
                        name_en: 'Galicia',
                        population: 2700000,
                        area: 29574,
                        provinces: [
                            'A CoruÃ±a', 'Lugo', 'Ourense', 'Pontevedra'
                        ]
                    },
                    'Madrid': {
                        name_ko: 'ë§ˆë“œë¦¬ë“œ',
                        name_en: 'Madrid',
                        population: 6900000,
                        area: 8028,
                        provinces: [
                            'Madrid'
                        ]
                    },
                    'Murcia': {
                        name_ko: 'ë¬´ë¥´ì‹œì•„',
                        name_en: 'Murcia',
                        population: 1600000,
                        area: 11313,
                        provinces: [
                            'Murcia'
                        ]
                    },
                    'Navarra': {
                        name_ko: 'ë‚˜ë°”ë¼',
                        name_en: 'Navarre',
                        population: 690000,
                        area: 10391,
                        provinces: [
                            'Navarra', 'Navarre', 'Pamplona'
                        ]
                    },
                    'La Rioja': {
                        name_ko: 'ë¼ë¦¬ì˜¤í•˜',
                        name_en: 'La Rioja',
                        population: 320000,
                        area: 5045,
                        provinces: [
                            'La Rioja', 'LogroÃ±o'
                        ]
                    },
                    'Comunidad Valenciana': {
                        name_ko: 'ë°œë Œì‹œì•„ ê³µë™ì²´',
                        name_en: 'Valencian Community',
                        population: 5200000,
                        area: 23255,
                        provinces: [
                            'Alicante', 'CastellÃ³n', 'Valencia'
                        ]
                    }
                };

                const candidateUrls = [
                    // geoBoundaries ESP ADM1 (17ê°œ ìì¹˜ì§€ì—­ ë˜ëŠ” 50ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ESP/ADM1/geoBoundaries-ESP-ADM1.geojson',
                    // geoBoundaries ESP ADM2 (52ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/ESP/ADM2/geoBoundaries-ESP-ADM2.geojson',
                    // Natural Earth Spain provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ìŠ¤í˜ì¸ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'ESP' || admin === 'Spain' || iso2 === 'ES';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Spain] Filtered Natural Earth/global dataset to Spain only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = data;
                            console.log('[Spain] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Spain] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 1 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Spain] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Spain] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Spain dataset available');
                
                // ìì¹˜ì§€ì—­-ì£¼ ë§¤í•‘ì„ í´ë˜ìŠ¤ì— ì €ì¥
                this.spainAutonomousCommunityMapping = spainAutonomousCommunityMapping;
                
                // ì£¼ ì´ë¦„ì„ ìì¹˜ì§€ì—­ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const provinceToCommunityMap = {};
                Object.keys(spainAutonomousCommunityMapping).forEach(communityName => {
                    const community = spainAutonomousCommunityMapping[communityName];
                    community.provinces.forEach(province => {
                        provinceToCommunityMap[province.toLowerCase()] = {
                            community: communityName,
                            community_ko: community.name_ko,
                            community_en: community.name_en
                        };
                    });
                });
                
                const idSet = new Set();
                const isProvinceLevel = geoJsonData.features.length > 40; // ADM2 ë°ì´í„°ì¸ ê²½ìš° (52ê°œ ì£¼)
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME_2 || p.province || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `ESP_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = isProvinceLevel ? `esp_province_${index}` : `esp_community_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ìì¹˜ì§€ì—­ ì°¾ê¸°
                    let communityInfo = null;
                    let communityData = null;
                    if (isProvinceLevel) {
                        const provinceNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (provinceToCommunityMap[provinceNameLower]) {
                            communityInfo = provinceToCommunityMap[provinceNameLower];
                            communityData = spainAutonomousCommunityMapping[communityInfo.community];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [provinceKey, commInfo] of Object.entries(provinceToCommunityMap)) {
                                if (provinceNameLower.includes(provinceKey) || provinceKey.includes(provinceNameLower)) {
                                    communityInfo = commInfo;
                                    communityData = spainAutonomousCommunityMapping[commInfo.community];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ ìì¹˜ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!communityInfo && p.NAME_1) {
                            const communityName = p.NAME_1;
                            if (spainAutonomousCommunityMapping[communityName]) {
                                communityInfo = {
                                    community: communityName,
                                    community_ko: spainAutonomousCommunityMapping[communityName].name_ko,
                                    community_en: spainAutonomousCommunityMapping[communityName].name_en
                                };
                                communityData = spainAutonomousCommunityMapping[communityName];
                            }
                        }
                    } else {
                        // ìì¹˜ì§€ì—­ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && spainAutonomousCommunityMapping[p.NAME_1]) {
                            communityData = spainAutonomousCommunityMapping[p.NAME_1];
                        }
                    }
                    
                    // ìì¹˜ì§€ì—­ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isProvinceLevel && communityData) {
                        // ìì¹˜ì§€ì—­ì˜ ì´ ì¸êµ¬/ë©´ì ì„ ì£¼ ìˆ˜ë¡œ ë‚˜ëˆ„ì–´ í‰ê·  ê³„ì‚°
                        const provinceCount = communityData.provinces.length;
                        population = p.population || Math.floor(communityData.population / provinceCount);
                        area = p.area || Math.floor(communityData.area / provinceCount);
                    } else if (!isProvinceLevel && communityData) {
                        // ìì¹˜ì§€ì—­ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        population = p.population || communityData.population;
                        area = p.area || communityData.area;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isProvinceLevel ? 2000000 : 8000000)) + (isProvinceLevel ? 100000 : 500000);
                        area = p.area || Math.floor(Math.random() * (isProvinceLevel ? 50000 : 200000)) + (isProvinceLevel ? 5000 : 30000);
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: communityInfo ? communityInfo.community_ko : (communityData ? communityData.name_ko : rawName),
                        name_en: communityInfo ? communityInfo.community_en : (communityData ? communityData.name_en : (p.NAME_1 || p.name || rawName)),
                        country: 'Spain',
                        country_code: 'ES',
                        admin_level: isProvinceLevel ? 'Province' : 'Autonomous Community',
                        autonomous_community: communityInfo ? communityInfo.community : (p.NAME_1 || null),
                        autonomous_community_ko: communityInfo ? communityInfo.community_ko : (communityData ? communityData.name_ko : null),
                        autonomous_community_en: communityInfo ? communityInfo.community_en : (communityData ? communityData.name_en : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#e74c3c',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displaySpainGroupedRegions();
                
                this.cachedGeoJsonData['spain'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#e74c3c'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isProvinceLevel = geoJsonData.features.length > 40;
            const adminType = isProvinceLevel ? 'ì£¼' : 'ìì¹˜ì§€ì—­';
            console.log('ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (17ê°œ ìì¹˜ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìŠ¤í˜ì¸ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìŠ¤í˜ì¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ìŠ¤í˜ì¸ ìì¹˜ì§€ì—­ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displaySpainGroupedRegions() {
        if (!this.spainAutonomousCommunityMapping) {
            console.log('[Spain] Autonomous community mapping not available');
            return;
        }

        console.log('\n=== ìŠ¤í˜ì¸ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (17ê°œ ìì¹˜ì§€ì—­, 52ê°œ ì£¼) ===\n');
        
        // ìì¹˜ì§€ì—­ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ìŠ¤í˜ì¸ 17ê°œ ìì¹˜ì§€ì—­ (Comunidades AutÃ³nomas) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | ìì¹˜ì§€ì—­ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì£¼ ìˆ˜ | ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(95));
        
        // ìì¹˜ì§€ì—­ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(this.spainAutonomousCommunityMapping).forEach((communityName, idx) => {
            const community = this.spainAutonomousCommunityMapping[communityName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${communityName} (${community.name_ko})`.padEnd(38);
            const provinces = community.provinces.length.toString().padEnd(5);
            const population = community.population.toLocaleString().padEnd(23);
            const area = community.area.toLocaleString();
            console.log(`${seq} | ${name} | ${provinces} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalProvinces = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Spain') {
                const community = regionData.autonomous_community || 'Unknown';
                if (!groupedRegions[community]) {
                    groupedRegions[community] = {
                        name_ko: regionData.autonomous_community_ko || community,
                        name_en: regionData.autonomous_community_en || community,
                        provinces: []
                    };
                }
                groupedRegions[community].provinces.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalProvinces++;
            }
        });

        // ìì¹˜ì§€ì—­ë³„ë¡œ ì¶œë ¥
        Object.keys(this.spainAutonomousCommunityMapping).forEach(communityName => {
            const community = this.spainAutonomousCommunityMapping[communityName];
            const loadedProvinces = groupedRegions[communityName] || { provinces: [] };
            
            console.log(`\nğŸ“Œ ${communityName} (${community.name_ko})`);
            console.log(`   ì¸êµ¬: ${community.population.toLocaleString()}ëª… (2024 ì¶”ì •)`);
            console.log(`   ë©´ì : ${community.area.toLocaleString()} ã¢`);
            console.log(`   ì£¼ ìˆ˜: ì´ ${community.provinces.length}ê°œ (ë¡œë“œë¨: ${loadedProvinces.provinces.length}ê°œ)`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // ì˜ˆìƒ ì£¼ ëª©ë¡
            community.provinces.forEach((provinceName, idx) => {
                const loadedProvince = loadedProvinces.provinces.find(p => 
                    p.name.toLowerCase().includes(provinceName.toLowerCase()) ||
                    provinceName.toLowerCase().includes(p.name.toLowerCase())
                );
                
                if (loadedProvince) {
                    console.log(`   ${idx + 1}. ${provinceName} âœ“`);
                    console.log(`      â””â”€ ë¡œë“œëœ ì´ë¦„: ${loadedProvince.name}`);
                    console.log(`      â””â”€ ID: ${loadedProvince.id}`);
                    console.log(`      â””â”€ ì¸êµ¬: ${loadedProvince.population.toLocaleString()}ëª…`);
                    console.log(`      â””â”€ ë©´ì : ${loadedProvince.area.toLocaleString()} kmÂ²`);
                } else {
                    console.log(`   ${idx + 1}. ${provinceName} (ë°ì´í„° ì—†ìŒ)`);
                }
            });
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ìì¹˜ì§€ì—­ (Comunidades AutÃ³nomas): ${Object.keys(this.spainAutonomousCommunityMapping).length}ê°œ`);
        console.log(`   â€¢ ì£¼ (Provincias): ${totalProvinces}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateSpainGroupedHTML(groupedRegions);
        console.log('%cìŠ¤í˜ì¸ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #e74c3c; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateSpainGroupedHTML(groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #e74c3c; margin-top: 0;">ìŠ¤í˜ì¸ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (17ê°œ ìì¹˜ì§€ì—­, 52ê°œ ì£¼)</h3>';
        
        // ìì¹˜ì§€ì—­ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ìì¹˜ì§€ì—­</th><th style="padding: 8px; text-align: right;">ì£¼ ìˆ˜</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(this.spainAutonomousCommunityMapping).forEach((communityName, idx) => {
            const community = this.spainAutonomousCommunityMapping[communityName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${communityName} (${community.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right;">${community.provinces.length}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${community.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${community.area.toLocaleString()}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ (12ê°œ ì£¼)
    async loadNetherlandsData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['netherlands']) {
                geoJsonData = this.cachedGeoJsonData['netherlands'];
            } else {
                // ë„¤ëœë€ë“œ 12ê°œ ì£¼ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const netherlandsProvinceMapping = {
                    'Drenthe': {
                        name_ko: 'ë“œë Œí„°',
                        name_nl: 'Drenthe',
                        population: 503000,
                        area: 2680
                    },
                    'Friesland': {
                        name_ko: 'í”„ë¦¬ìŠ¬ë€íŠ¸',
                        name_nl: 'Friesland',
                        population: 650000,
                        area: 5741
                    },
                    'Gelderland': {
                        name_ko: 'í—¬ë°ë¥¼ë€íŠ¸',
                        name_nl: 'Gelderland',
                        population: 2100000,
                        area: 5136
                    },
                    'Groningen': {
                        name_ko: 'íë¡œë‹ì–¸',
                        name_nl: 'Groningen',
                        population: 600000,
                        area: 2960
                    },
                    'Limburg': {
                        name_ko: 'ë¦¼ë·”ë¥´í',
                        name_nl: 'Limburg',
                        population: 1130000,
                        area: 2209
                    },
                    'Noord-Brabant': {
                        name_ko: 'ë…¸ë¥´íŠ¸ë¸Œë¼ë°˜íŠ¸',
                        name_nl: 'Noord-Brabant',
                        population: 2600000,
                        area: 5082
                    },
                    'Noord-Holland': {
                        name_ko: 'ë…¸ë¥´íŠ¸í™€ë€íŠ¸',
                        name_nl: 'Noord-Holland',
                        population: 2950000,
                        area: 2662
                    },
                    'Overijssel': {
                        name_ko: 'ì˜¤ë²„ë ˆì´ì„¤',
                        name_nl: 'Overijssel',
                        population: 1200000,
                        area: 3420
                    },
                    'Utrecht': {
                        name_ko: 'ìœ„íŠ¸ë ˆííŠ¸',
                        name_nl: 'Utrecht',
                        population: 1400000,
                        area: 1560
                    },
                    'Zeeland': {
                        name_ko: 'ì œì¼ë€íŠ¸',
                        name_nl: 'Zeeland',
                        population: 390000,
                        area: 1788
                    },
                    'Zuid-Holland': {
                        name_ko: 'ììœ„íŠ¸í™€ë€íŠ¸',
                        name_nl: 'Zuid-Holland',
                        population: 3800000,
                        area: 2872
                    },
                    'Flevoland': {
                        name_ko: 'í”Œë ˆë³¼ë€íŠ¸',
                        name_nl: 'Flevoland',
                        population: 450000,
                        area: 2412
                    }
                };

                const candidateUrls = [
                    // geoBoundaries NLD ADM1 (12ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/NLD/ADM1/geoBoundaries-NLD-ADM1.geojson',
                    // Natural Earth Netherlands provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë„¤ëœë€ë“œë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'NLD' || admin === 'Netherlands' || iso2 === 'NL';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Netherlands] Filtered Natural Earth/global dataset to Netherlands only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = data;
                            console.log('[Netherlands] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Netherlands] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 1 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Netherlands] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Netherlands] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Netherlands dataset available');
                
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `NLD_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `nld_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ë°ì´í„° ì°¾ê¸°
                    let provinceData = null;
                    const provinceNameLower = rawName.toLowerCase();
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    for (const [provinceKey, provinceInfo] of Object.entries(netherlandsProvinceMapping)) {
                        if (provinceNameLower === provinceKey.toLowerCase() || 
                            provinceNameLower === provinceInfo.name_nl.toLowerCase()) {
                            provinceData = { key: provinceKey, ...provinceInfo };
                            break;
                        }
                    }
                    
                    // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                    if (!provinceData) {
                        for (const [provinceKey, provinceInfo] of Object.entries(netherlandsProvinceMapping)) {
                            if (provinceNameLower.includes(provinceKey.toLowerCase()) || 
                                provinceKey.toLowerCase().includes(provinceNameLower) ||
                                provinceNameLower.includes(provinceInfo.name_nl.toLowerCase()) ||
                                provinceInfo.name_nl.toLowerCase().includes(provinceNameLower)) {
                                provinceData = { key: provinceKey, ...provinceInfo };
                                break;
                            }
                        }
                    }
                    
                    // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!provinceData && p.NAME_1) {
                        const provinceName = p.NAME_1;
                        if (netherlandsProvinceMapping[provinceName]) {
                            provinceData = { key: provinceName, ...netherlandsProvinceMapping[provinceName] };
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    const population = provinceData ? provinceData.population : (p.population || Math.floor(Math.random() * 3000000) + 300000);
                    const area = provinceData ? provinceData.area : (p.area || Math.floor(Math.random() * 5000) + 1000);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceData ? provinceData.name_ko : rawName,
                        name_en: provinceData ? provinceData.name_nl : (p.NAME_1 || p.name || rawName),
                        country: 'Netherlands',
                        country_code: 'NL',
                        admin_level: 'Province',
                        province: provinceData ? provinceData.key : rawName,
                        province_ko: provinceData ? provinceData.name_ko : null,
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#ff9f43',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayNetherlandsGroupedRegions(netherlandsProvinceMapping);
                
                this.cachedGeoJsonData['netherlands'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#ff9f43'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì£¼`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë„¤ëœë€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë„¤ëœë€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë„¤ëœë€ë“œ ì£¼ ëª©ë¡ í‘œì‹œ
    displayNetherlandsGroupedRegions(provinceMapping) {
        console.log('\n=== ë„¤ëœë€ë“œ í–‰ì •êµ¬ì—­ (12ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ë„¤ëœë€ë“œ 12ê°œ ì£¼ (Provinces) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(95));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(provinceMapping).forEach((provinceName, idx) => {
            const province = provinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} (${province.name_ko})`.padEnd(38);
            const population = province.population.toLocaleString().padEnd(23);
            const area = province.area.toLocaleString();
            console.log(`${seq} | ${name} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const loadedProvinces = [];
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Netherlands') {
                loadedProvinces.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    name_ko: regionData.name_ko,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
            }
        });

        console.log(`\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Provinces): ${Object.keys(provinceMapping).length}ê°œ`);
        console.log(`   â€¢ ë¡œë“œëœ ì£¼: ${loadedProvinces.length}ê°œ`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateNetherlandsGroupedHTML(provinceMapping, loadedProvinces);
        console.log('%cë„¤ëœë€ë“œ í–‰ì •êµ¬ì—­', 'color: #ff9f43; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateNetherlandsGroupedHTML(provinceMapping, loadedProvinces) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #ff9f43; margin-top: 0;">ë„¤ëœë€ë“œ í–‰ì •êµ¬ì—­ (12ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(provinceMapping).forEach((provinceName, idx) => {
            const province = provinceMapping[provinceName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${provinceName} (${province.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right;">${province.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${province.area.toLocaleString()}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // í´ë€ë“œ ë°ì´í„° ë¡œë“œ (16ê°œ ì£¼)
    async loadPolandData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['poland']) {
                geoJsonData = this.cachedGeoJsonData['poland'];
            } else {
                // í´ë€ë“œ 16ê°œ ì£¼ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const polandVoivodeshipMapping = {
                    'Wielkopolskie': {
                        name_ko: 'ê·¸ë ˆì´í„°í´ë€ë“œ',
                        name_en: 'Greater Poland',
                        name_pl: 'Wielkopolskie',
                        population: 3470000,
                        area: 29826
                    },
                    'Kujawsko-Pomorskie': {
                        name_ko: 'ì¿ ì•¼ë¹„ì•ˆí¬ëª¨ì œ',
                        name_en: 'Kuyavian-Pomeranian',
                        name_pl: 'Kujawsko-Pomorskie',
                        population: 2030000,
                        area: 17972
                    },
                    'MaÅ‚opolskie': {
                        name_ko: 'ë ˆì„œí´ë€ë“œ',
                        name_en: 'Lesser Poland',
                        name_pl: 'MaÅ‚opolskie',
                        population: 3430000,
                        area: 15190
                    },
                    'ÅÃ³dzkie': {
                        name_ko: 'ìš°ì¹˜',
                        name_en: 'ÅÃ³dÅº',
                        name_pl: 'ÅÃ³dzkie',
                        population: 2360000,
                        area: 18219
                    },
                    'DolnoÅ›lÄ…skie': {
                        name_ko: 'ë¡œì›Œì‹¤ë ˆì‹œì•„',
                        name_en: 'Lower Silesian',
                        name_pl: 'DolnoÅ›lÄ…skie',
                        population: 2850000,
                        area: 19947
                    },
                    'Lubelskie': {
                        name_ko: 'ë£¨ë¸”ë¦°',
                        name_en: 'Lublin',
                        name_pl: 'Lubelskie',
                        population: 2070000,
                        area: 25122
                    },
                    'Lubuskie': {
                        name_ko: 'ë£¨ë¶€ì‹œ',
                        name_en: 'Lubusz',
                        name_pl: 'Lubuskie',
                        population: 1020000,
                        area: 13987
                    },
                    'Mazowieckie': {
                        name_ko: 'ë§ˆì¡°ë¹„ì•„',
                        name_en: 'Masovian',
                        name_pl: 'Mazowieckie',
                        population: 5500000,
                        area: 35558
                    },
                    'Opolskie': {
                        name_ko: 'ì˜¤í´ë ˆ',
                        name_en: 'Opole',
                        name_pl: 'Opolskie',
                        population: 960000,
                        area: 9412
                    },
                    'Podlaskie': {
                        name_ko: 'í¬ë“¤ë¼ìŠ¤í‚¤ì—',
                        name_en: 'Podlaskie',
                        name_pl: 'Podlaskie',
                        population: 1140000,
                        area: 20187
                    },
                    'Pomorskie': {
                        name_ko: 'í¬ë©”ë¼ë‹ˆì•ˆ',
                        name_en: 'Pomeranian',
                        name_pl: 'Pomorskie',
                        population: 2450000,
                        area: 18310
                    },
                    'ÅšlÄ…skie': {
                        name_ko: 'ì‹¤ë ˆì‹œì•„',
                        name_en: 'Silesian',
                        name_pl: 'ÅšlÄ…skie',
                        population: 4440000,
                        area: 12333
                    },
                    'Podkarpackie': {
                        name_ko: 'ì„œë¸Œì¹´ë¥´íŒŒí‹°ì•„',
                        name_en: 'Subcarpathian',
                        name_pl: 'Podkarpackie',
                        population: 2110000,
                        area: 17846
                    },
                    'ÅšwiÄ™tokrzyskie': {
                        name_ko: 'ì‹œë¹„ì—¥í† í¬ì‹œìŠ¤í‚¤ì—',
                        name_en: 'ÅšwiÄ™tokrzyskie',
                        name_pl: 'ÅšwiÄ™tokrzyskie',
                        population: 1140000,
                        area: 11672
                    },
                    'WarmiÅ„sko-Mazurskie': {
                        name_ko: 'ë°”ë¥´ë¯¸ì•„ë§ˆì£¼ë¦¬',
                        name_en: 'Warmian-Masurian',
                        name_pl: 'WarmiÅ„sko-Mazurskie',
                        population: 1370000,
                        area: 24173
                    },
                    'Zachodniopomorskie': {
                        name_ko: 'ì„œí¬ë©”ë¼ë‹ˆì•ˆ',
                        name_en: 'West Pomeranian',
                        name_pl: 'Zachodniopomorskie',
                        population: 1660000,
                        area: 22892
                    }
                };

                const candidateUrls = [
                    // geoBoundaries POL ADM1 (16ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/POL/ADM1/geoBoundaries-POL-ADM1.geojson',
                    // Natural Earth Poland voivodeships
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° í´ë€ë“œë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'POL' || admin === 'Poland' || iso2 === 'PL';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Poland] Filtered Natural Earth/global dataset to Poland only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = data;
                            console.log('[Poland] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Poland] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 1 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Poland] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Poland] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Poland dataset available');
                
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.voivodeship || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `POL_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `pol_voivodeship_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ë°ì´í„° ì°¾ê¸°
                    let voivodeshipData = null;
                    const voivodeshipNameLower = rawName.toLowerCase();
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    for (const [voivodeshipKey, voivodeshipInfo] of Object.entries(polandVoivodeshipMapping)) {
                        if (voivodeshipNameLower === voivodeshipKey.toLowerCase() || 
                            voivodeshipNameLower === voivodeshipInfo.name_pl.toLowerCase() ||
                            voivodeshipNameLower === voivodeshipInfo.name_en.toLowerCase()) {
                            voivodeshipData = { key: voivodeshipKey, ...voivodeshipInfo };
                            break;
                        }
                    }
                    
                    // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                    if (!voivodeshipData) {
                        for (const [voivodeshipKey, voivodeshipInfo] of Object.entries(polandVoivodeshipMapping)) {
                            if (voivodeshipNameLower.includes(voivodeshipKey.toLowerCase()) || 
                                voivodeshipKey.toLowerCase().includes(voivodeshipNameLower) ||
                                voivodeshipNameLower.includes(voivodeshipInfo.name_pl.toLowerCase()) ||
                                voivodeshipInfo.name_pl.toLowerCase().includes(voivodeshipNameLower) ||
                                voivodeshipNameLower.includes(voivodeshipInfo.name_en.toLowerCase()) ||
                                voivodeshipInfo.name_en.toLowerCase().includes(voivodeshipNameLower)) {
                                voivodeshipData = { key: voivodeshipKey, ...voivodeshipInfo };
                                break;
                            }
                        }
                    }
                    
                    // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!voivodeshipData && p.NAME_1) {
                        const voivodeshipName = p.NAME_1;
                        if (polandVoivodeshipMapping[voivodeshipName]) {
                            voivodeshipData = { key: voivodeshipName, ...polandVoivodeshipMapping[voivodeshipName] };
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    const population = voivodeshipData ? voivodeshipData.population : (p.population || Math.floor(Math.random() * 4000000) + 1000000);
                    const area = voivodeshipData ? voivodeshipData.area : (p.area || Math.floor(Math.random() * 30000) + 10000);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: voivodeshipData ? voivodeshipData.name_ko : rawName,
                        name_en: voivodeshipData ? voivodeshipData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Poland',
                        country_code: 'PL',
                        admin_level: 'Voivodeship',
                        voivodeship: voivodeshipData ? voivodeshipData.key : rawName,
                        voivodeship_ko: voivodeshipData ? voivodeshipData.name_ko : null,
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#feca57',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayPolandGroupedRegions(polandVoivodeshipMapping);
                
                this.cachedGeoJsonData['poland'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#feca57'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í´ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`í´ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì£¼`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í´ë€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í´ë€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // í´ë€ë“œ ì£¼ ëª©ë¡ í‘œì‹œ
    displayPolandGroupedRegions(voivodeshipMapping) {
        console.log('\n=== í´ë€ë“œ í–‰ì •êµ¬ì—­ (16ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š í´ë€ë“œ 16ê°œ ì£¼ (Voivodeships) ì¸êµ¬ ë° ë©´ì  ìš”ì•½');
        console.log('â”€'.repeat(100));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(45) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
        console.log('â”€'.repeat(100));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(voivodeshipMapping).forEach((voivodeshipName, idx) => {
            const voivodeship = voivodeshipMapping[voivodeshipName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${voivodeship.name_en} (${voivodeship.name_ko})`.padEnd(43);
            const population = voivodeship.population.toLocaleString().padEnd(23);
            const area = voivodeship.area.toLocaleString();
            console.log(`${seq} | ${name} | ${population} | ${area}`);
        });
        console.log('â”€'.repeat(100));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const loadedVoivodeships = [];
        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Poland') {
                loadedVoivodeships.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    name_ko: regionData.name_ko,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
            }
        });

        console.log(`\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì£¼ (Voivodeships): ${Object.keys(voivodeshipMapping).length}ê°œ`);
        console.log(`   â€¢ ë¡œë“œëœ ì£¼: ${loadedVoivodeships.length}ê°œ`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generatePolandGroupedHTML(voivodeshipMapping, loadedVoivodeships);
        console.log('%cí´ë€ë“œ í–‰ì •êµ¬ì—­', 'color: #feca57; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generatePolandGroupedHTML(voivodeshipMapping, loadedVoivodeships) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #feca57; margin-top: 0;">í´ë€ë“œ í–‰ì •êµ¬ì—­ (16ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(voivodeshipMapping).forEach((voivodeshipName, idx) => {
            const voivodeship = voivodeshipMapping[voivodeshipName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${voivodeship.name_en} (${voivodeship.name_ko})</td>`;
            html += `<td style="padding: 8px; text-align: right;">${voivodeship.population.toLocaleString()}</td>`;
            html += `<td style="padding: 8px; text-align: right;">${voivodeship.area.toLocaleString()}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­)
    async loadBelgiumData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['belgium']) {
                geoJsonData = this.cachedGeoJsonData['belgium'];
            } else {
                // ë²¨ê¸°ì— 10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­ ë§¤í•‘ (2024 ê¸°ì¤€ ì¸êµ¬ ë° ë©´ì )
                const belgiumProvinceMapping = {
                    // í”Œë‘ë“œë¥´ ì§€ì—­
                    'Antwerpen': {
                        name_ko: 'ì•ˆíŠ¸ë² ë¥´íœ',
                        name_en: 'Antwerpen',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1940000,
                        area: 2876
                    },
                    'Limburg': {
                        name_ko: 'ë¦¼ë·”ë¥´í',
                        name_en: 'Limburg',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 900000,
                        area: 2427
                    },
                    'Oost-Vlaanderen': {
                        name_ko: 'ì˜¤ìŠ¤íŠ¸í”Œë€ë°ëŸ°',
                        name_en: 'East Flanders',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1540000,
                        area: 2982
                    },
                    'Vlaams-Brabant': {
                        name_ko: 'í”ŒëŒìŠ¤ë¸Œë¼ë°˜íŠ¸',
                        name_en: 'Flemish Brabant',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1200000,
                        area: 2106
                    },
                    'West-Vlaanderen': {
                        name_ko: 'ë² ìŠ¤íŠ¸í”Œë€ë°ëŸ°',
                        name_en: 'West Flanders',
                        region: 'Flanders',
                        region_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­',
                        population: 1210000,
                        area: 3125
                    },
                    // ì™ˆë¡± ì§€ì—­
                    'Brabant Wallon': {
                        name_ko: 'ë¸Œë¼ë°©ì™ˆë¡±',
                        name_en: 'Walloon Brabant',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 420000,
                        area: 1090
                    },
                    'Hainaut': {
                        name_ko: 'ì—ë…¸',
                        name_en: 'Hainaut',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 1340000,
                        area: 3787
                    },
                    'LiÃ¨ge': {
                        name_ko: 'ë¦¬ì—ì£¼',
                        name_en: 'LiÃ¨ge',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 1110000,
                        area: 3857
                    },
                    'Luxembourg': {
                        name_ko: 'ë¤½ìƒë¶€ë¥´',
                        name_en: 'Luxembourg',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 290000,
                        area: 4443
                    },
                    'Namur': {
                        name_ko: 'ë‚˜ë®ˆë¥´',
                        name_en: 'Namur',
                        region: 'Walloon',
                        region_ko: 'ì™ˆë¡± ì§€ì—­',
                        population: 520000,
                        area: 3666
                    },
                    // ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­
                    'Brussels-Capital': {
                        name_ko: 'ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­',
                        name_en: 'Brussels-Capital Region',
                        region: 'Brussels-Capital',
                        region_ko: 'ë¸Œë¤¼ì…€ ìˆ˜ë„ ì§€ì—­',
                        population: 1240000,
                        area: 162
                    }
                };

                const candidateUrls = [
                    // geoBoundaries BEL ADM1 (10ê°œ ì£¼ + ë¸Œë¤¼ì…€)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/BEL/ADM1/geoBoundaries-BEL-ADM1.geojson',
                    // Natural Earth Belgium provinces
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ë²¨ê¸°ì—ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'BEL' || admin === 'Belgium' || iso2 === 'BE';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Belgium] Filtered Natural Earth/global dataset to Belgium only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = data;
                            console.log('[Belgium] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Belgium] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 1 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Belgium] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Belgium] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Belgium dataset available');
                
                const idSet = new Set();
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.province || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `BEL_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `bel_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ ë°ì´í„° ì°¾ê¸°
                    let provinceData = null;
                    const provinceNameLower = rawName.toLowerCase();
                    
                    // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                    for (const [provinceKey, provinceInfo] of Object.entries(belgiumProvinceMapping)) {
                        if (provinceNameLower === provinceKey.toLowerCase() || 
                            provinceNameLower === provinceInfo.name_en.toLowerCase() ||
                            provinceNameLower.includes('brussels') && provinceKey === 'Brussels-Capital') {
                            provinceData = { key: provinceKey, ...provinceInfo };
                            break;
                        }
                    }
                    
                    // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                    if (!provinceData) {
                        for (const [provinceKey, provinceInfo] of Object.entries(belgiumProvinceMapping)) {
                            if (provinceNameLower.includes(provinceKey.toLowerCase()) || 
                                provinceKey.toLowerCase().includes(provinceNameLower) ||
                                provinceNameLower.includes(provinceInfo.name_en.toLowerCase()) ||
                                provinceInfo.name_en.toLowerCase().includes(provinceNameLower)) {
                                provinceData = { key: provinceKey, ...provinceInfo };
                                break;
                            }
                        }
                    }
                    
                    // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                    if (!provinceData && p.NAME_1) {
                        const provinceName = p.NAME_1;
                        if (belgiumProvinceMapping[provinceName]) {
                            provinceData = { key: provinceName, ...belgiumProvinceMapping[provinceName] };
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ì„¤ì •
                    const population = provinceData ? provinceData.population : (p.population || Math.floor(Math.random() * 2000000) + 300000);
                    const area = provinceData ? provinceData.area : (p.area || Math.floor(Math.random() * 4000) + 1000);
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: provinceData ? provinceData.name_ko : rawName,
                        name_en: provinceData ? provinceData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Belgium',
                        country_code: 'BE',
                        admin_level: provinceData && provinceData.key === 'Brussels-Capital' ? 'Capital Region' : 'Province',
                        province: provinceData ? provinceData.key : rawName,
                        province_ko: provinceData ? provinceData.name_ko : null,
                        region: provinceData ? provinceData.region : null,
                        region_ko: provinceData ? provinceData.region_ko : null,
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#5dade2',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayBelgiumGroupedRegions(belgiumProvinceMapping);
                
                this.cachedGeoJsonData['belgium'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#5dade2'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ í–‰ì •êµ¬ì—­');
            this.showNotification(`ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë²¨ê¸°ì— ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë²¨ê¸°ì— ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ë²¨ê¸°ì— ì£¼ ëª©ë¡ í‘œì‹œ
    displayBelgiumGroupedRegions(provinceMapping) {
        console.log('\n=== ë²¨ê¸°ì— í–‰ì •êµ¬ì—­ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­) ===\n');
        
        // ì§€ì—­ë³„ë¡œ ê·¸ë£¹í™”
        const regions = {
            'Flanders': { name_ko: 'í”Œë‘ë“œë¥´ ì§€ì—­', provinces: [] },
            'Walloon': { name_ko: 'ì™ˆë¡± ì§€ì—­', provinces: [] },
            'Brussels-Capital': { name_ko: 'ë¸Œë¤¼ì…€ ìˆ˜ë„ ì§€ì—­', provinces: [] }
        };
        
        Object.keys(provinceMapping).forEach(provinceKey => {
            const province = provinceMapping[provinceKey];
            if (regions[province.region]) {
                regions[province.region].provinces.push({ key: provinceKey, ...province });
            }
        });
        
        // ì§€ì—­ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(regions).forEach(regionKey => {
            const region = regions[regionKey];
            console.log(`\nğŸ“Œ ${region.name_ko} (${regionKey} Region)`);
            console.log('â”€'.repeat(95));
            console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì¸êµ¬ (ëª…, 2024 ì¶”ì •)'.padEnd(25) + '| ë©´ì  (ã¢)');
            console.log('â”€'.repeat(95));
            
            region.provinces.forEach((province, idx) => {
                const seq = (idx + 1).toString().padEnd(5);
                const name = `${province.name_en} (${province.name_ko})`.padEnd(38);
                const population = province.population.toLocaleString().padEnd(23);
                const area = province.area.toLocaleString();
                console.log(`${seq} | ${name} | ${population} | ${area}`);
            });
        });
        
        console.log('\nğŸ“Š ì´ê³„:');
        console.log(`   â€¢ ì§€ì—­ (Regions): 3ê°œ`);
        console.log(`   â€¢ ì£¼ (Provinces): 10ê°œ`);
        console.log(`   â€¢ ìˆ˜ë„ì§€ì—­: 1ê°œ (ë¸Œë¤¼ì…€)`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateBelgiumGroupedHTML(provinceMapping, regions);
        console.log('%cë²¨ê¸°ì— í–‰ì •êµ¬ì—­', 'color: #5dade2; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateBelgiumGroupedHTML(provinceMapping, regions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #5dade2; margin-top: 0;">ë²¨ê¸°ì— í–‰ì •êµ¬ì—­ (10ê°œ ì£¼ + ë¸Œë¤¼ì…€ ìˆ˜ë„ì§€ì—­)</h3>';
        
        // ì§€ì—­ë³„ ìš”ì•½ í…Œì´ë¸”
        Object.keys(regions).forEach(regionKey => {
            const region = regions[regionKey];
            html += `<h4 style="color: #5dade2; margin-top: 20px;">${region.name_ko}</h4>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: right;">ì¸êµ¬ (ëª…)</th><th style="padding: 8px; text-align: right;">ë©´ì  (ã¢)</th></tr></thead>';
            html += '<tbody>';
            
            region.provinces.forEach((province, idx) => {
                html += `<tr style="border-bottom: 1px solid #333;">`;
                html += `<td style="padding: 8px;">${idx + 1}</td>`;
                html += `<td style="padding: 8px;">${province.name_en} (${province.name_ko})</td>`;
                html += `<td style="padding: 8px; text-align: right;">${province.population.toLocaleString()}</td>`;
                html += `<td style="padding: 8px; text-align: right;">${province.area.toLocaleString()}</td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
        });
        
        html += '</div>';
        return html;
    }
    
    // ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ (21ê°œ ì£¼ë¡œ ê·¸ë£¹í™”)
    async loadSwedenData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['sweden']) {
                geoJsonData = this.cachedGeoJsonData['sweden'];
            } else {
                // ìŠ¤ì›¨ë´ 21ê°œ ì£¼(LÃ¤n) ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const swedenCountyMapping = {
                    'Stockholm': { name_ko: 'ìŠ¤í†¡í™€ë¦„ ì£¼', name_en: 'Stockholm', name_sv: 'Stockholms lÃ¤n', population: 2460000, area: 6519 },
                    'Uppsala': { name_ko: 'ì›ì‚´ë¼ ì£¼', name_en: 'Uppsala', name_sv: 'Uppsala lÃ¤n', population: 410000, area: 8207 },
                    'SÃ¶dermanland': { name_ko: 'ì‡ ë°ë¥´ë§Œë€ë“œ ì£¼', name_en: 'SÃ¶dermanland', name_sv: 'SÃ¶dermanlands lÃ¤n', population: 305000, area: 6072 },
                    'Ã–stergÃ¶tland': { name_ko: 'ì™¸ìŠ¤í…Œë¥´ì˜ˆí‹€ë€ë“œ ì£¼', name_en: 'Ã–stergÃ¶tland', name_sv: 'Ã–stergÃ¶tlands lÃ¤n', population: 480000, area: 10562 },
                    'JÃ¶nkÃ¶ping': { name_ko: 'ì˜Œì…°í•‘ ì£¼', name_en: 'JÃ¶nkÃ¶ping', name_sv: 'JÃ¶nkÃ¶pings lÃ¤n', population: 370000, area: 10494 },
                    'Kronoberg': { name_ko: 'í¬ë¡œë…¸ë² ë¦¬ ì£¼', name_en: 'Kronoberg', name_sv: 'Kronobergs lÃ¤n', population: 210000, area: 8457 },
                    'Kalmar': { name_ko: 'ì¹¼ë§ˆë¥´ ì£¼', name_en: 'Kalmar', name_sv: 'Kalmar lÃ¤n', population: 250000, area: 11163 },
                    'Gotland': { name_ko: 'ê³ í‹€ë€ë“œ ì£¼', name_en: 'Gotland', name_sv: 'Gotlands lÃ¤n', population: 60000, area: 3184 },
                    'Blekinge': { name_ko: 'ë¸”ë ˆí‚¹ì— ì£¼', name_en: 'Blekinge', name_sv: 'Blekinge lÃ¤n', population: 160000, area: 3039 },
                    'SkÃ¥ne': { name_ko: 'ìŠ¤ì½”ë„¤ ì£¼', name_en: 'SkÃ¥ne', name_sv: 'SkÃ¥ne lÃ¤n', population: 1420000, area: 11303 },
                    'Halland': { name_ko: 'í• ë€ë“œ ì£¼', name_en: 'Halland', name_sv: 'Hallands lÃ¤n', population: 345000, area: 5427 },
                    'VÃ¤stra GÃ¶taland': { name_ko: 'ë² ìŠ¤íŠ¸ë¼ì˜ˆíƒˆë€ë“œ ì£¼', name_en: 'VÃ¤stra GÃ¶taland', name_sv: 'VÃ¤stra GÃ¶talands lÃ¤n', population: 1800000, area: 23942 },
                    'VÃ¤rmland': { name_ko: 'ë² ë¥´ë¯ˆë€ë“œ ì£¼', name_en: 'VÃ¤rmland', name_sv: 'VÃ¤rmlands lÃ¤n', population: 285000, area: 17583 },
                    'Ã–rebro': { name_ko: 'ì™¸ë ˆë¸Œë¡œ ì£¼', name_en: 'Ã–rebro', name_sv: 'Ã–rebro lÃ¤n', population: 320000, area: 8555 },
                    'VÃ¤stmanland': { name_ko: 'ë² ìŠ¤íŠ¸ë§Œë€ë“œ ì£¼', name_en: 'VÃ¤stmanland', name_sv: 'VÃ¤stmanlands lÃ¤n', population: 290000, area: 5146 },
                    'Dalarna': { name_ko: 'ë‹¬ë¼ë¥´ë‚˜ ì£¼', name_en: 'Dalarna', name_sv: 'Dalarnas lÃ¤n', population: 285000, area: 28194 },
                    'GÃ¤vleborg': { name_ko: 'ì˜ˆë¸”ë ˆë³´ë¦¬ ì£¼', name_en: 'GÃ¤vleborg', name_sv: 'GÃ¤vleborgs lÃ¤n', population: 290000, area: 18186 },
                    'VÃ¤sternorrland': { name_ko: 'ë² ìŠ¤í…Œë¥´ë…¸ë¥¼ë€ë“œ ì£¼', name_en: 'VÃ¤sternorrland', name_sv: 'VÃ¤sternorrlands lÃ¤n', population: 230000, area: 21683 },
                    'JÃ¤mtland': { name_ko: 'ì˜˜í‹€ë€ë“œ ì£¼', name_en: 'JÃ¤mtland', name_sv: 'JÃ¤mtlands lÃ¤n', population: 130000, area: 49443 },
                    'VÃ¤sterbotten': { name_ko: 'ë² ìŠ¤í…Œë¥´ë³´í… ì£¼', name_en: 'VÃ¤sterbotten', name_sv: 'VÃ¤sterbottens lÃ¤n', population: 280000, area: 55186 },
                    'Norrbotten': { name_ko: 'ë…¸ë¥¼ë³´í… ì£¼', name_en: 'Norrbotten', name_sv: 'Norrbottens lÃ¤n', population: 250000, area: 106211 }
                };

                const candidateUrls = [
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/SWE/ADM1/geoBoundaries-SWE-ADM1.geojson',
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'SWE' || admin === 'Sweden' || iso2 === 'SE';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Sweden] Filtered Natural Earth/global dataset to Sweden only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = data;
                            console.log('[Sweden] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Sweden] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Sweden] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Sweden] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Sweden dataset available');
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `SWE_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `swe_county_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // í–‰ì •êµ¬ì—­ ì´ë¦„ ë§¤ì¹­
                    let countyData = null;
                    const rawNameLower = rawName.toLowerCase();
                    for (const [countyKey, countyInfo] of Object.entries(swedenCountyMapping)) {
                        const countyKeyLower = countyKey.toLowerCase();
                        const nameEnLower = countyInfo.name_en.toLowerCase();
                        const nameSvLower = countyInfo.name_sv.toLowerCase();
                        if (rawNameLower.includes(countyKeyLower) || countyKeyLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameEnLower) || nameEnLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameSvLower) || nameSvLower.includes(rawNameLower)) {
                            countyData = countyInfo;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° NAME_1ì—ì„œë„ í™•ì¸
                    if (!countyData && p.NAME_1) {
                        const name1Lower = p.NAME_1.toLowerCase();
                        for (const [countyKey, countyInfo] of Object.entries(swedenCountyMapping)) {
                            const countyKeyLower = countyKey.toLowerCase();
                            const nameEnLower = countyInfo.name_en.toLowerCase();
                            const nameSvLower = countyInfo.name_sv.toLowerCase();
                            if (name1Lower.includes(countyKeyLower) || countyKeyLower.includes(name1Lower) ||
                                name1Lower.includes(nameEnLower) || nameEnLower.includes(name1Lower) ||
                                name1Lower.includes(nameSvLower) || nameSvLower.includes(name1Lower)) {
                                countyData = countyInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: countyData ? countyData.name_ko : rawName,
                        name_en: countyData ? countyData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Sweden',
                        country_code: 'SE',
                        admin_level: 'County (LÃ¤n)',
                        population: countyData ? countyData.population : (p.population || Math.floor(Math.random() * 500000) + 50000),
                        area: countyData ? countyData.area : (p.area || Math.floor(Math.random() * 10000) + 1000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#3498db',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['sweden'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#3498db'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì£¼');
            this.showNotification(`ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì£¼ (LÃ¤n)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ìŠ¤ì›¨ë´ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ìŠ¤ì›¨ë´ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ (9ê°œ ì£¼ë¡œ ê·¸ë£¹í™”)
    async loadAustriaData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['austria']) {
                geoJsonData = this.cachedGeoJsonData['austria'];
            } else {
                // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ 9ê°œ ì—°ë°©ì£¼ ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const austriaStateMapping = {
                    'Wien': {
                        name_ko: 'ë¹ˆ',
                        name_en: 'Vienna',
                        name_de: 'Wien',
                        population: 1985000,
                        area: 415,
                        districts: ['Wien', 'Vienna']
                    },
                    'NiederÃ¶sterreich': {
                        name_ko: 'ë‹ˆë”ì™¸ìŠ¤í„°ë¼ì´íˆ',
                        name_en: 'Lower Austria',
                        name_de: 'NiederÃ¶sterreich',
                        population: 1720000,
                        area: 19186,
                        districts: ['NiederÃ¶sterreich', 'Lower Austria', 'NÃ–', 'NOE']
                    },
                    'OberÃ¶sterreich': {
                        name_ko: 'ì˜¤ë²„ì™¸ìŠ¤í„°ë¼ì´íˆ',
                        name_en: 'Upper Austria',
                        name_de: 'OberÃ¶sterreich',
                        population: 1520000,
                        area: 11982,
                        districts: ['OberÃ¶sterreich', 'Upper Austria', 'OÃ–', 'OOE']
                    },
                    'Steiermark': {
                        name_ko: 'ìŠˆíƒ€ì´ì–´ë§ˆë¥´í¬',
                        name_en: 'Styria',
                        name_de: 'Steiermark',
                        population: 1260000,
                        area: 16401,
                        districts: ['Steiermark', 'Styria', 'ST']
                    },
                    'Tirol': {
                        name_ko: 'í‹°ë¡¤',
                        name_en: 'Tyrol',
                        name_de: 'Tirol',
                        population: 770000,
                        area: 12648,
                        districts: ['Tirol', 'Tyrol', 'T']
                    },
                    'KÃ¤rnten': {
                        name_ko: 'ì¼€ë¥¸í…',
                        name_en: 'Carinthia',
                        name_de: 'KÃ¤rnten',
                        population: 570000,
                        area: 9537,
                        districts: ['KÃ¤rnten', 'Carinthia', 'K']
                    },
                    'Salzburg': {
                        name_ko: 'ì˜ì¸ ë¶€ë¥´í¬',
                        name_en: 'Salzburg',
                        name_de: 'Salzburg',
                        population: 570000,
                        area: 7156,
                        districts: ['Salzburg']
                    },
                    'Vorarlberg': {
                        name_ko: 'í¬ì–´ì•„ë¥¼ë² ë¥´í¬',
                        name_en: 'Vorarlberg',
                        name_de: 'Vorarlberg',
                        population: 410000,
                        area: 2601,
                        districts: ['Vorarlberg', 'V']
                    },
                    'Burgenland': {
                        name_ko: 'ë¶€ë¥´ê²ë€íŠ¸',
                        name_en: 'Burgenland',
                        name_de: 'Burgenland',
                        population: 310000,
                        area: 3965,
                        districts: ['Burgenland', 'B']
                    }
                };

                const candidateUrls = [
                    // geoBoundaries AUT ADM1 (9ê°œ ì£¼)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/AUT/ADM1/geoBoundaries-AUT-ADM1.geojson',
                    // geoBoundaries AUT ADM2 (21ê°œ êµ¬)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/AUT/ADM2/geoBoundaries-AUT-ADM2.geojson',
                    // Natural Earth Austria states
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'AUT' || admin === 'Austria' || iso2 === 'AT';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Austria] Filtered Natural Earth/global dataset to Austria only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = data;
                            console.log('[Austria] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Austria] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 1 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Austria] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Austria] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Austria dataset available');
                
                // êµ¬ ì´ë¦„ì„ ì£¼ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const districtToStateMap = {};
                Object.keys(austriaStateMapping).forEach(stateName => {
                    const state = austriaStateMapping[stateName];
                    state.districts.forEach(district => {
                        districtToStateMap[district.toLowerCase()] = {
                            state: stateName,
                            state_ko: state.name_ko,
                            state_en: state.name_en
                        };
                    });
                });
                
                const idSet = new Set();
                const isDistrictLevel = geoJsonData.features.length > 15; // ADM2 ë°ì´í„°ì¸ ê²½ìš° (21ê°œ êµ¬)
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME_2 || p.district || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `AUT_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = isDistrictLevel ? `aut_district_${index}` : `aut_state_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // êµ¬ ì´ë¦„ìœ¼ë¡œ ì£¼ ì°¾ê¸°
                    let stateInfo = null;
                    let stateData = null;
                    if (isDistrictLevel) {
                        const districtNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (districtToStateMap[districtNameLower]) {
                            stateInfo = districtToStateMap[districtNameLower];
                            stateData = austriaStateMapping[stateInfo.state];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [districtKey, stInfo] of Object.entries(districtToStateMap)) {
                                if (districtNameLower.includes(districtKey) || districtKey.includes(districtNameLower)) {
                                    stateInfo = stInfo;
                                    stateData = austriaStateMapping[stInfo.state];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ ì£¼ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!stateInfo && p.NAME_1) {
                            const stateName = p.NAME_1;
                            if (austriaStateMapping[stateName]) {
                                stateInfo = {
                                    state: stateName,
                                    state_ko: austriaStateMapping[stateName].name_ko,
                                    state_en: austriaStateMapping[stateName].name_en
                                };
                                stateData = austriaStateMapping[stateName];
                            } else {
                                // NAME_1ì´ ì£¼ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                                for (const [stateKey, stateInfoData] of Object.entries(austriaStateMapping)) {
                                    if (stateName.toLowerCase().includes(stateKey.toLowerCase()) || 
                                        stateKey.toLowerCase().includes(stateName.toLowerCase()) ||
                                        stateInfoData.name_en.toLowerCase().includes(stateName.toLowerCase()) ||
                                        stateInfoData.name_de.toLowerCase().includes(stateName.toLowerCase())) {
                                        stateInfo = {
                                            state: stateKey,
                                            state_ko: stateInfoData.name_ko,
                                            state_en: stateInfoData.name_en
                                        };
                                        stateData = stateInfoData;
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && austriaStateMapping[p.NAME_1]) {
                            stateData = austriaStateMapping[p.NAME_1];
                        } else if (p.NAME_1) {
                            // NAME_1ì´ ì£¼ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                            for (const [stateKey, stateInfoData] of Object.entries(austriaStateMapping)) {
                                if (p.NAME_1.toLowerCase().includes(stateKey.toLowerCase()) || 
                                    stateKey.toLowerCase().includes(p.NAME_1.toLowerCase()) ||
                                    stateInfoData.name_en.toLowerCase().includes(p.NAME_1.toLowerCase()) ||
                                    stateInfoData.name_de.toLowerCase().includes(p.NAME_1.toLowerCase())) {
                                    stateData = stateInfoData;
                                    stateInfo = {
                                        state: stateKey,
                                        state_ko: stateInfoData.name_ko,
                                        state_en: stateInfoData.name_en
                                    };
                                    break;
                                }
                            }
                        }
                    }
                    
                    // ì£¼ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isDistrictLevel && stateData) {
                        // êµ¬ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° ì£¼ì˜ í‰ê·  ì¸êµ¬/ë©´ì  ì‚¬ìš©
                        const avgPopulation = stateData.population ? Math.floor(stateData.population / stateData.districts.length) : (p.population || Math.floor(Math.random() * 500000) + 50000);
                        const avgArea = stateData.area ? Math.floor(stateData.area / stateData.districts.length) : (p.area || Math.floor(Math.random() * 2000) + 500);
                        population = p.population || avgPopulation;
                        area = p.area || avgArea;
                    } else if (!isDistrictLevel && stateData) {
                        // ì£¼ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° - ë§¤í•‘ëœ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©
                        population = p.population || stateData.population || Math.floor(Math.random() * 2000000) + 200000;
                        area = p.area || stateData.area || Math.floor(Math.random() * 10000) + 2000;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isDistrictLevel ? 500000 : 2000000)) + (isDistrictLevel ? 50000 : 200000);
                        area = p.area || Math.floor(Math.random() * (isDistrictLevel ? 2000 : 10000)) + (isDistrictLevel ? 500 : 2000);
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: stateInfo ? stateInfo.state_ko : (stateData ? stateData.name_ko : rawName),
                        name_en: stateInfo ? stateInfo.state_en : (stateData ? stateData.name_en : (p.NAME_1 || p.name || rawName)),
                        country: 'Austria',
                        country_code: 'AT',
                        admin_level: isDistrictLevel ? 'District' : 'State',
                        state: stateInfo ? stateInfo.state : (p.NAME_1 || null),
                        state_ko: stateInfo ? stateInfo.state_ko : (stateData ? stateData.name_ko : null),
                        state_en: stateInfo ? stateInfo.state_en : (stateData ? stateData.name_en : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#9b59b6',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayAustriaGroupedRegions(austriaStateMapping);
                
                this.cachedGeoJsonData['austria'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#9b59b6'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isDistrictLevel = geoJsonData.features.length > 15;
            const adminType = isDistrictLevel ? 'êµ¬' : 'ì£¼';
            console.log('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (9ê°œ ì£¼ë¡œ ê·¸ë£¹í™”)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ ì£¼ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displayAustriaGroupedRegions(stateMapping) {
        console.log('\n=== ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼) ===\n');
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ 9ê°œ ì—°ë°©ì£¼ (BundeslÃ¤nder) ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | ì£¼ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ë…ì¼ì–´ëª…'.padEnd(20) + '| êµ¬ ìˆ˜ (ì¶”ì •)');
        console.log('â”€'.repeat(95));
        
        // ì£¼ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(stateMapping).forEach((stateName, idx) => {
            const state = stateMapping[stateName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${state.name_en} (${state.name_ko})`.padEnd(38);
            const nameDe = state.name_de.padEnd(18);
            const districtCount = state.districts.length.toString().padEnd(10);
            console.log(`${seq} | ${name} | ${nameDe} | ${districtCount}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalDistricts = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Austria') {
                const state = regionData.state || 'Unknown';
                if (!groupedRegions[state]) {
                    groupedRegions[state] = {
                        name_ko: regionData.state_ko || state,
                        name_en: regionData.state_en || state,
                        districts: []
                    };
                }
                groupedRegions[state].districts.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalDistricts++;
            }
        });

        // ì£¼ë³„ë¡œ ì¶œë ¥
        Object.keys(stateMapping).forEach(stateName => {
            const state = stateMapping[stateName];
            const loadedDistricts = groupedRegions[stateName] || { districts: [] };
            
            console.log(`\nğŸ“Œ ${state.name_en} (${state.name_ko})`);
            console.log(`   ë…ì¼ì–´ëª…: ${state.name_de}`);
            console.log(`   êµ¬ ìˆ˜: ë¡œë“œë¨ ${loadedDistricts.districts.length}ê°œ`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ ì—°ë°©ì£¼ (BundeslÃ¤nder): ${Object.keys(stateMapping).length}ê°œ`);
        console.log(`   â€¢ êµ¬ (Bezirke): ${totalDistricts}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateAustriaGroupedHTML(stateMapping, groupedRegions);
        console.log('%cì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #9b59b6; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateAustriaGroupedHTML(stateMapping, groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #9b59b6; margin-top: 0;">ì˜¤ìŠ¤íŠ¸ë¦¬ì•„ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (9ê°œ ì£¼)</h3>';
        
        // ì£¼ë³„ ìš”ì•½ í…Œì´ë¸”
        html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
        html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì£¼</th><th style="padding: 8px; text-align: left;">ë…ì¼ì–´ëª…</th></tr></thead>';
        html += '<tbody>';
        
        Object.keys(stateMapping).forEach((stateName, idx) => {
            const state = stateMapping[stateName];
            html += `<tr style="border-bottom: 1px solid #333;">`;
            html += `<td style="padding: 8px;">${idx + 1}</td>`;
            html += `<td style="padding: 8px;">${state.name_en} (${state.name_ko})</td>`;
            html += `<td style="padding: 8px;">${state.name_de}</td>`;
            html += `</tr>`;
        });
        
        html += '</tbody></table>';
        html += '</div>';
        return html;
    }
    
    // ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ (5ê°œ ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)
    async loadDenmarkData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['denmark']) {
                geoJsonData = this.cachedGeoJsonData['denmark'];
            } else {
                // ë´ë§ˆí¬ 5ê°œ ì§€ì—­(Regioner) ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const denmarkRegionMapping = {
                    'Hovedstaden': { name_ko: 'ìˆ˜ë„ ì§€ì—­', name_en: 'Capital Region', name_da: 'Region Hovedstaden', population: 1900000, area: 2560 },
                    'SjÃ¦lland': { name_ko: 'ì…€ë€ ì§€ì—­', name_en: 'Zealand Region', name_da: 'Region SjÃ¦lland', population: 850000, area: 7274 },
                    'Syddanmark': { name_ko: 'ë‚¨ë´ë§ˆí¬ ì§€ì—­', name_en: 'Southern Denmark', name_da: 'Region Syddanmark', population: 1250000, area: 12192 },
                    'Midtjylland': { name_ko: 'ì¤‘ë¶€ ìœ í‹€ë€ë“œ ì§€ì—­', name_en: 'Central Jutland', name_da: 'Region Midtjylland', population: 1350000, area: 13142 },
                    'Nordjylland': { name_ko: 'ë¶ìœ í‹€ë€ë“œ ì§€ì—­', name_en: 'North Jutland', name_da: 'Region Nordjylland', population: 600000, area: 7874 }
                };

                const candidateUrls = [
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/DNK/ADM1/geoBoundaries-DNK-ADM1.geojson',
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'DNK' || admin === 'Denmark' || iso2 === 'DK';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Denmark] Filtered Natural Earth/global dataset to Denmark only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = data;
                            console.log('[Denmark] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Denmark] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Denmark] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Denmark] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Denmark dataset available');
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `DNK_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `dnk_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // í–‰ì •êµ¬ì—­ ì´ë¦„ ë§¤ì¹­
                    let regionData = null;
                    const rawNameLower = rawName.toLowerCase();
                    for (const [regionKey, regionInfo] of Object.entries(denmarkRegionMapping)) {
                        const regionKeyLower = regionKey.toLowerCase();
                        const nameEnLower = regionInfo.name_en.toLowerCase();
                        const nameDaLower = regionInfo.name_da.toLowerCase();
                        if (rawNameLower.includes(regionKeyLower) || regionKeyLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameEnLower) || nameEnLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameDaLower) || nameDaLower.includes(rawNameLower)) {
                            regionData = regionInfo;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° NAME_1ì—ì„œë„ í™•ì¸
                    if (!regionData && p.NAME_1) {
                        const name1Lower = p.NAME_1.toLowerCase();
                        for (const [regionKey, regionInfo] of Object.entries(denmarkRegionMapping)) {
                            const regionKeyLower = regionKey.toLowerCase();
                            const nameEnLower = regionInfo.name_en.toLowerCase();
                            const nameDaLower = regionInfo.name_da.toLowerCase();
                            if (name1Lower.includes(regionKeyLower) || regionKeyLower.includes(name1Lower) ||
                                name1Lower.includes(nameEnLower) || nameEnLower.includes(name1Lower) ||
                                name1Lower.includes(nameDaLower) || nameDaLower.includes(name1Lower)) {
                                regionData = regionInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: regionData ? regionData.name_ko : rawName,
                        name_en: regionData ? regionData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Denmark',
                        country_code: 'DK',
                        admin_level: 'Region',
                        population: regionData ? regionData.population : (p.population || Math.floor(Math.random() * 2000000) + 300000),
                        area: regionData ? regionData.area : (p.area || Math.floor(Math.random() * 15000) + 2000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#1abc9c',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['denmark'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#1abc9c'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
            this.showNotification(`ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì§€ì—­ (Regioner)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ë´ë§ˆí¬ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ë´ë§ˆí¬ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // í•€ë€ë“œ ë°ì´í„° ë¡œë“œ (19ê°œ ì§€ì—­ìœ¼ë¡œ ê·¸ë£¹í™”)
    async loadFinlandData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['finland']) {
                geoJsonData = this.cachedGeoJsonData['finland'];
            } else {
                // í•€ë€ë“œ 19ê°œ ì§€ì—­(Maakunta) ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const finlandRegionMapping = {
                    'Uusimaa': { name_ko: 'ìš°ì‹œë§ˆ', name_en: 'Uusimaa', name_fi: 'Uusimaa', population: 1750000, area: 9100 },
                    'Varsinais-Suomi': { name_ko: 'ë‚¨ì„œí•€ë€ë“œ', name_en: 'Southwest Finland', name_fi: 'Varsinais-Suomi', population: 490000, area: 10900 },
                    'Satakunta': { name_ko: 'ì‚¬íƒ€ì¿¤íƒ€', name_en: 'Satakunta', name_fi: 'Satakunta', population: 215000, area: 8200 },
                    'Kanta-HÃ¤me': { name_ko: 'ì¹¸íƒ€í—¤ë©”', name_en: 'Tavastia Proper', name_fi: 'Kanta-HÃ¤me', population: 185000, area: 5200 },
                    'PÃ¤ijÃ¤t-HÃ¤me': { name_ko: 'íŒŒì´ì–˜íŠ¸í•´ë©”', name_en: 'PÃ¤ijÃ¤nne Tavastia', name_fi: 'PÃ¤ijÃ¤t-HÃ¤me', population: 210000, area: 5100 },
                    'Kymenlaakso': { name_ko: 'í‚¤ë©”ë„¬ë½ì†Œ', name_en: 'Kymenlaakso', name_fi: 'Kymenlaakso', population: 155000, area: 5100 },
                    'EtelÃ¤-Karjala': { name_ko: 'ë‚¨ì¹´ë¦¬ì•Œë¼', name_en: 'South Karelia', name_fi: 'EtelÃ¤-Karjala', population: 125000, area: 5700 },
                    'EtelÃ¤-Savo': { name_ko: 'ë‚¨ì‚¬ë³´', name_en: 'South Savo', name_fi: 'EtelÃ¤-Savo', population: 140000, area: 18800 },
                    'Pohjois-Savo': { name_ko: 'ë¶ì‚¬ë³´', name_en: 'North Savo', name_fi: 'Pohjois-Savo', population: 240000, area: 20400 },
                    'Pohjois-Karjala': { name_ko: 'ë¶ì¹´ë¦¬ì•Œë¼', name_en: 'North Karelia', name_fi: 'Pohjois-Karjala', population: 160000, area: 21600 },
                    'Keski-Suomi': { name_ko: 'ì¤‘ë¶€í•€ë€ë“œ', name_en: 'Central Finland', name_fi: 'Keski-Suomi', population: 280000, area: 19900 },
                    'EtelÃ¤-Pohjanmaa': { name_ko: 'ë‚¨ì˜¤ìŠ¤íŠ¸ë¡œë³´ìŠ¤ë‹ˆì•„', name_en: 'South Ostrobothnia', name_fi: 'EtelÃ¤-Pohjanmaa', population: 195000, area: 14400 },
                    'Pohjanmaa': { name_ko: 'í¬íì–€ë§ˆ', name_en: 'Ostrobothnia', name_fi: 'Pohjanmaa', population: 180000, area: 7800 },
                    'Keski-Pohjanmaa': { name_ko: 'ì¤‘ë¶€ì˜¤ìŠ¤íŠ¸ë¡œë³´ìŠ¤ë‹ˆì•„', name_en: 'Central Ostrobothnia', name_fi: 'Keski-Pohjanmaa', population: 70000, area: 5700 },
                    'Pohjois-Pohjanmaa': { name_ko: 'ë¶ì˜¤ìŠ¤íŠ¸ë¡œë³´ìŠ¤ë‹ˆì•„', name_en: 'North Ostrobothnia', name_fi: 'Pohjois-Pohjanmaa', population: 420000, area: 37100 },
                    'Kainuu': { name_ko: 'ì¹´ì´ëˆ„', name_en: 'Kainuu', name_fi: 'Kainuu', population: 70000, area: 22600 },
                    'Lappi': { name_ko: 'ë¼í”Œë€ë“œ', name_en: 'Lapland', name_fi: 'Lappi', population: 175000, area: 98000 },
                    'Pirkanmaa': { name_ko: 'í”¼ë¥´ì¹¸ë§ˆ', name_en: 'Pirkanmaa', name_fi: 'Pirkanmaa', population: 550000, area: 12300 },
                    'Ahvenanmaa': { name_ko: 'ì˜¬ë€ë“œ ì œë„', name_en: 'Ã…land', name_fi: 'Ahvenanmaa', population: 30000, area: 1550 }
                };

                const candidateUrls = [
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/FIN/ADM1/geoBoundaries-FIN-ADM1.geojson',
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        if (url.includes('natural-earth') && data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'FIN' || admin === 'Finland' || iso2 === 'FI';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Finland] Filtered Natural Earth/global dataset to Finland only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = data;
                            console.log('[Finland] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 0) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Finland] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 0 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Finland] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Finland] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Finland dataset available');
                
                const idSet = new Set();
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.NAME || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `FIN_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = `fin_region_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // í–‰ì •êµ¬ì—­ ì´ë¦„ ë§¤ì¹­
                    let regionData = null;
                    const rawNameLower = rawName.toLowerCase();
                    for (const [regionKey, regionInfo] of Object.entries(finlandRegionMapping)) {
                        const regionKeyLower = regionKey.toLowerCase();
                        const nameEnLower = regionInfo.name_en.toLowerCase();
                        const nameFiLower = regionInfo.name_fi.toLowerCase();
                        if (rawNameLower.includes(regionKeyLower) || regionKeyLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameEnLower) || nameEnLower.includes(rawNameLower) ||
                            rawNameLower.includes(nameFiLower) || nameFiLower.includes(rawNameLower)) {
                            regionData = regionInfo;
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° NAME_1ì—ì„œë„ í™•ì¸
                    if (!regionData && p.NAME_1) {
                        const name1Lower = p.NAME_1.toLowerCase();
                        for (const [regionKey, regionInfo] of Object.entries(finlandRegionMapping)) {
                            const regionKeyLower = regionKey.toLowerCase();
                            const nameEnLower = regionInfo.name_en.toLowerCase();
                            const nameFiLower = regionInfo.name_fi.toLowerCase();
                            if (name1Lower.includes(regionKeyLower) || regionKeyLower.includes(name1Lower) ||
                                name1Lower.includes(nameEnLower) || nameEnLower.includes(name1Lower) ||
                                name1Lower.includes(nameFiLower) || nameFiLower.includes(name1Lower)) {
                                regionData = regionInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: regionData ? regionData.name_ko : rawName,
                        name_en: regionData ? regionData.name_en : (p.NAME_1 || p.name || rawName),
                        country: 'Finland',
                        country_code: 'FI',
                        admin_level: 'Region (Maakunta)',
                        population: regionData ? regionData.population : (p.population || Math.floor(Math.random() * 500000) + 50000),
                        area: regionData ? regionData.area : (p.area || Math.floor(Math.random() * 10000) + 1000),
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#34495e',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                this.cachedGeoJsonData['finland'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#34495e'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            console.log('í•€ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
            this.showNotification(`í•€ë€ë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ ì§€ì—­ (Maakunta)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('í•€ë€ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í•€ë€ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ (4ê°œ í”„ë¡œë¹ˆìŠ¤ë¡œ ê·¸ë£¹í™”)
    async loadIrelandData() {
        try {
            let geoJsonData;
            if (this.cachedGeoJsonData['ireland']) {
                geoJsonData = this.cachedGeoJsonData['ireland'];
            } else {
                // ì•„ì¼ëœë“œ 4ê°œ í”„ë¡œë¹ˆìŠ¤ì™€ 26ê°œ ì¹´ìš´í‹° ë§¤í•‘ (ì¸êµ¬ ë° ë©´ì  í¬í•¨, 2024 ì¶”ì •)
                const irelandProvinceMapping = {
                    'Leinster': {
                        name_ko: 'ë ŒìŠ¤í„°',
                        name_en: 'Leinster',
                        population: 3200000,
                        area: 19800,
                        counties: [
                            'Carlow', 'Dublin', 'Kildare', 'Kilkenny', 'Laois', 
                            'Longford', 'Louth', 'Meath', 'Offaly', 'Westmeath', 
                            'Wexford', 'Wicklow'
                        ]
                    },
                    'Munster': {
                        name_ko: 'ë¨¼ìŠ¤í„°',
                        name_en: 'Munster',
                        population: 1350000,
                        area: 24700,
                        counties: [
                            'Clare', 'Cork', 'Kerry', 'Limerick', 'Tipperary', 'Waterford'
                        ]
                    },
                    'Connacht': {
                        name_ko: 'ì½”ë…¸íŠ¸',
                        name_en: 'Connacht',
                        population: 590000,
                        area: 17700,
                        counties: [
                            'Galway', 'Leitrim', 'Mayo', 'Roscommon', 'Sligo'
                        ]
                    },
                    'Ulster': {
                        name_ko: 'ì–¼ìŠ¤í„°',
                        name_en: 'Ulster',
                        population: 300000,
                        area: 8300,
                        counties: [
                            'Cavan', 'Donegal', 'Monaghan'
                        ]
                    }
                };
                
                // ì•„ì¼ëœë“œ 26ê°œ ì¹´ìš´í‹°ë³„ ì¸êµ¬ ë° ë©´ì  ë°ì´í„° (2024 ì¶”ì •)
                const irelandCountyData = {
                    'Carlow': { name_ko: 'ì¹¼ë¡œìš°', population: 65000, area: 900 },
                    'Cavan': { name_ko: 'ìºë²ˆ', population: 81000, area: 1930 },
                    'Clare': { name_ko: 'í´ë ˆì–´', population: 128000, area: 3450 },
                    'Cork': { name_ko: 'ì½”í¬', population: 580000, area: 7500 },
                    'Donegal': { name_ko: 'ë„ë„¤ê³¨', population: 165000, area: 4860 },
                    'Dublin': { name_ko: 'ë”ë¸”ë¦°', population: 1450000, area: 920 },
                    'Galway': { name_ko: 'ê³¨ì›¨ì´', population: 280000, area: 6150 },
                    'Kerry': { name_ko: 'ì¼€ë¦¬', population: 155000, area: 4800 },
                    'Kildare': { name_ko: 'í‚¬ë°ì–´', population: 250000, area: 1690 },
                    'Kilkenny': { name_ko: 'í‚¬ì¼€ë‹ˆ', population: 105000, area: 2070 },
                    'Laois': { name_ko: 'ë¼ì˜¤ì´ìŠ¤', population: 95000, area: 1720 },
                    'Leitrim': { name_ko: 'ë¦¬íŠ¸ë¦¼', population: 35000, area: 1580 },
                    'Limerick': { name_ko: 'ë¦¬ë¨¸ë¦­', population: 210000, area: 2750 },
                    'Longford': { name_ko: 'ë¡±í¼ë“œ', population: 47000, area: 1090 },
                    'Louth': { name_ko: 'ë¼ìš°ìŠ¤', population: 140000, area: 820 },
                    'Mayo': { name_ko: 'ë©”ì´ì˜¤', population: 135000, area: 5400 },
                    'Meath': { name_ko: 'ë¯¸ìŠ¤', population: 225000, area: 2330 },
                    'Monaghan': { name_ko: 'ëª¨ë‚˜í•œ', population: 65000, area: 1290 },
                    'Offaly': { name_ko: 'ì˜¤í„ë¦¬', population: 85000, area: 2000 },
                    'Roscommon': { name_ko: 'ë¡œìŠ¤ì½”ë¨¼', population: 70000, area: 2500 },
                    'Sligo': { name_ko: 'ìŠ¬ë¼ì´ê³ ', population: 65000, area: 1800 },
                    'Tipperary': { name_ko: 'í‹°í¼ë ˆë¦¬', population: 165000, area: 4300 },
                    'Waterford': { name_ko: 'ì›Œí„°í¼ë“œ', population: 125000, area: 1850 },
                    'Westmeath': { name_ko: 'ì›¨ìŠ¤íŠ¸ë¯¸ìŠ¤', population: 96000, area: 1840 },
                    'Wexford': { name_ko: 'ì›©ìŠ¤í¼ë“œ', population: 165000, area: 2350 },
                    'Wicklow': { name_ko: 'ìœ…ë¡œìš°', population: 155000, area: 2030 }
                };

                const candidateUrls = [
                    // geoBoundaries IRL ADM1 (26ê°œ ì¹´ìš´í‹°)
                    'https://raw.githubusercontent.com/wmgeolab/geoBoundaries/main/releaseData/gbOpen/IRL/ADM1/geoBoundaries-IRL-ADM1.geojson',
                    // Natural Earth Ireland counties
                    'https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_10m_admin_1_states_provinces.geojson'
                ];
                let lastError = null;
                for (const url of candidateUrls) {
                    try {
                        const resp = await fetch(url, { cache: 'no-store' });
                        if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                        const data = await resp.json();
                        
                        // Natural Earth ë°ì´í„°ì¸ ê²½ìš° ì•„ì¼ëœë“œë§Œ í•„í„°ë§
                        if (data && Array.isArray(data.features) && data.features.length > 300) {
                            const filtered = data.features.filter((feature) => {
                                const p = feature.properties || {};
                                const a3 = (p.adm0_a3 || p.ADM0_A3 || p.sr_adm0_a3 || p.gu_a3 || '').toUpperCase();
                                const admin = (p.admin || p.geonunit || p.ADM0_A3 || '').toString();
                                const iso2 = (p.iso_a2 || '').toUpperCase();
                                return a3 === 'IRL' || admin === 'Ireland' || iso2 === 'IE';
                            });
                            if (filtered.length > 0) {
                                console.log(`[Ireland] Filtered Natural Earth/global dataset to Ireland only: ${filtered.length} features`);
                                geoJsonData = { type: 'FeatureCollection', features: filtered };
                                break;
                            }
                        }
                        
                        if (data && data.type === 'FeatureCollection' && Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = data;
                            console.log('[Ireland] Loaded from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data.features) && data.features.length > 1) {
                            geoJsonData = { type: 'FeatureCollection', features: data.features };
                            console.log('[Ireland] Loaded (normalized) from', url, 'features:', data.features.length);
                            break;
                        }
                        if (Array.isArray(data) && data.length > 1 && data[0].geometry) {
                            geoJsonData = { type: 'FeatureCollection', features: data };
                            console.log('[Ireland] Loaded (array -> FC) from', url, 'features:', data.length);
                            break;
                        }
                        lastError = new Error('Invalid data shape');
                    } catch (e) {
                        lastError = e;
                        console.warn('[Ireland] Failed loading from', url, e);
                    }
                }
                if (!geoJsonData) throw lastError || new Error('No Ireland dataset available');
                
                // ì¹´ìš´í‹° ì´ë¦„ì„ í”„ë¡œë¹ˆìŠ¤ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘í•˜ëŠ” ì—­ë°©í–¥ ë§µ ìƒì„±
                const countyToProvinceMap = {};
                Object.keys(irelandProvinceMapping).forEach(provinceName => {
                    const province = irelandProvinceMapping[provinceName];
                    province.counties.forEach(county => {
                        countyToProvinceMap[county.toLowerCase()] = {
                            province: provinceName,
                            province_ko: province.name_ko,
                            province_en: province.name_en
                        };
                    });
                });
                
                const idSet = new Set();
                const isCountyLevel = geoJsonData.features.length > 10; // ì¹´ìš´í‹° ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° (26ê°œ ì¹´ìš´í‹°)
                
                geoJsonData.features.forEach((feature, index) => {
                    const p = feature.properties || {};
                    const rawName = p.name || p.NAME_1 || p.county || `Region_${index}`;
                    const baseIdSrc = p.hasc || p.shapeID || rawName || `IRL_${index}`;
                    let baseId = baseIdSrc.toString().toLowerCase()
                        .replace(/[^\w\uAC00-\uD7A3]/g, '_')
                        .replace(/__+/g, '_')
                        .replace(/^_|_$/g, '');
                    if (!baseId) baseId = isCountyLevel ? `irl_county_${index}` : `irl_province_${index}`;
                    let finalId = baseId; let c = 1;
                    while (idSet.has(finalId)) finalId = `${baseId}_${c++}`;
                    idSet.add(finalId);
                    
                    // ì¹´ìš´í‹° ì´ë¦„ìœ¼ë¡œ í”„ë¡œë¹ˆìŠ¤ ì°¾ê¸°
                    let provinceInfo = null;
                    let provinceData = null;
                    if (isCountyLevel) {
                        const countyNameLower = rawName.toLowerCase();
                        // ì •í™•í•œ ë§¤ì¹­ ì‹œë„
                        if (countyToProvinceMap[countyNameLower]) {
                            provinceInfo = countyToProvinceMap[countyNameLower];
                            provinceData = irelandProvinceMapping[provinceInfo.province];
                        } else {
                            // ë¶€ë¶„ ë§¤ì¹­ ì‹œë„
                            for (const [countyKey, provInfo] of Object.entries(countyToProvinceMap)) {
                                if (countyNameLower.includes(countyKey) || countyKey.includes(countyNameLower)) {
                                    provinceInfo = provInfo;
                                    provinceData = irelandProvinceMapping[provInfo.province];
                                    break;
                                }
                            }
                        }
                        // NAME_1ì—ì„œ í”„ë¡œë¹ˆìŠ¤ ì •ë³´ ê°€ì ¸ì˜¤ê¸° ì‹œë„
                        if (!provinceInfo && p.NAME_1) {
                            const provinceName = p.NAME_1;
                            if (irelandProvinceMapping[provinceName]) {
                                provinceInfo = {
                                    province: provinceName,
                                    province_ko: irelandProvinceMapping[provinceName].name_ko,
                                    province_en: irelandProvinceMapping[provinceName].name_en
                                };
                                provinceData = irelandProvinceMapping[provinceName];
                            } else {
                                // NAME_1ì´ í”„ë¡œë¹ˆìŠ¤ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                                for (const [provinceKey, provinceInfoData] of Object.entries(irelandProvinceMapping)) {
                                    if (provinceName.toLowerCase().includes(provinceKey.toLowerCase()) || 
                                        provinceKey.toLowerCase().includes(provinceName.toLowerCase()) ||
                                        provinceInfoData.name_en.toLowerCase().includes(provinceName.toLowerCase())) {
                                        provinceInfo = {
                                            province: provinceKey,
                                            province_ko: provinceInfoData.name_ko,
                                            province_en: provinceInfoData.name_en
                                        };
                                        provinceData = provinceInfoData;
                                        break;
                                    }
                                }
                            }
                        }
                    } else {
                        // í”„ë¡œë¹ˆìŠ¤ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš°
                        if (p.NAME_1 && irelandProvinceMapping[p.NAME_1]) {
                            provinceData = irelandProvinceMapping[p.NAME_1];
                        } else if (p.NAME_1) {
                            // NAME_1ì´ í”„ë¡œë¹ˆìŠ¤ ì´ë¦„ê³¼ ë¶€ë¶„ ë§¤ì¹­ë˜ëŠ”ì§€ í™•ì¸
                            for (const [provinceKey, provinceInfoData] of Object.entries(irelandProvinceMapping)) {
                                if (p.NAME_1.toLowerCase().includes(provinceKey.toLowerCase()) || 
                                    provinceKey.toLowerCase().includes(p.NAME_1.toLowerCase()) ||
                                    provinceInfoData.name_en.toLowerCase().includes(p.NAME_1.toLowerCase())) {
                                    provinceData = provinceInfoData;
                                    provinceInfo = {
                                        province: provinceKey,
                                        province_ko: provinceInfoData.name_ko,
                                        province_en: provinceInfoData.name_en
                                    };
                                    break;
                                }
                            }
                        }
                    }
                    
                    // í”„ë¡œë¹ˆìŠ¤ ì •ë³´ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì¸êµ¬ì™€ ë©´ì  ê³„ì‚°
                    let population, area;
                    if (isCountyLevel) {
                        // ì¹´ìš´í‹° ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° - ì‹¤ì œ ì¹´ìš´í‹° ë°ì´í„° ì‚¬ìš©
                        const countyNameLower = rawName.toLowerCase();
                        let countyData = null;
                        for (const [countyKey, countyInfo] of Object.entries(irelandCountyData)) {
                            if (countyNameLower === countyKey.toLowerCase() || countyNameLower.includes(countyKey.toLowerCase()) || countyKey.toLowerCase().includes(countyNameLower)) {
                                countyData = countyInfo;
                                break;
                            }
                        }
                        if (countyData) {
                            population = p.population || countyData.population;
                            area = p.area || countyData.area;
                        } else {
                            // ë§¤ì¹­ë˜ì§€ ì•Šì€ ê²½ìš° í”„ë¡œë¹ˆìŠ¤ì˜ í‰ê·  ì¸êµ¬/ë©´ì  ì‚¬ìš©
                            const avgPopulation = provinceData && provinceData.population ? Math.floor(provinceData.population / provinceData.counties.length) : (p.population || Math.floor(Math.random() * 300000) + 30000);
                            const avgArea = provinceData && provinceData.area ? Math.floor(provinceData.area / provinceData.counties.length) : (p.area || Math.floor(Math.random() * 3000) + 500);
                            population = p.population || avgPopulation;
                            area = p.area || avgArea;
                        }
                    } else if (!isCountyLevel && provinceData) {
                        // í”„ë¡œë¹ˆìŠ¤ ë ˆë²¨ ë°ì´í„°ì¸ ê²½ìš° - ë§¤í•‘ëœ ì‹¤ì œ ë°ì´í„° ì‚¬ìš©
                        population = p.population || provinceData.population || Math.floor(Math.random() * 2000000) + 200000;
                        area = p.area || provinceData.area || Math.floor(Math.random() * 15000) + 5000;
                    } else {
                        // ê¸°ë³¸ê°’
                        population = p.population || Math.floor(Math.random() * (isCountyLevel ? 300000 : 2000000)) + (isCountyLevel ? 30000 : 200000);
                        area = p.area || Math.floor(Math.random() * (isCountyLevel ? 3000 : 15000)) + (isCountyLevel ? 500 : 5000);
                    }
                    
                    // ì¹´ìš´í‹° ë°ì´í„°ì—ì„œ ì´ë¦„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                    const countyNameLower = rawName.toLowerCase();
                    let matchedCountyData = null;
                    if (isCountyLevel) {
                        for (const [countyKey, countyInfo] of Object.entries(irelandCountyData)) {
                            if (countyNameLower === countyKey.toLowerCase() || countyNameLower.includes(countyKey.toLowerCase()) || countyKey.toLowerCase().includes(countyNameLower)) {
                                matchedCountyData = countyInfo;
                                break;
                            }
                        }
                    }
                    
                    feature.properties = {
                        ...p,
                        id: finalId,
                        name: rawName,
                        name_ko: isCountyLevel && matchedCountyData ? matchedCountyData.name_ko : (provinceInfo ? provinceInfo.province_ko : (provinceData ? provinceData.name_ko : rawName)),
                        name_en: isCountyLevel ? (p.NAME_1 || p.name || rawName) : (provinceInfo ? provinceInfo.province_en : (provinceData ? provinceData.name_en : (p.NAME_1 || p.name || rawName))),
                        country: 'Ireland',
                        country_code: 'IE',
                        admin_level: isCountyLevel ? 'County' : 'Province',
                        province: provinceInfo ? provinceInfo.province : (p.NAME_1 || null),
                        province_ko: provinceInfo ? provinceInfo.province_ko : (provinceData ? provinceData.name_ko : null),
                        province_en: provinceInfo ? provinceInfo.province_en : (provinceData ? provinceData.name_en : null),
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 300000) + 150000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#16a085',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    this.regionData.set(finalId, feature.properties);
                });
                
                // ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ì¶œë ¥
                this.displayIrelandGroupedRegions(irelandProvinceMapping);
                
                this.cachedGeoJsonData['ireland'] = geoJsonData;
            }
            
            if (this.map.getSource('world-regions')) {
                this.map.getSource('world-regions').setData(geoJsonData);
            } else {
                this.map.addSource('world-regions', { type: 'geojson', data: geoJsonData });
            }
            if (!this.map.getLayer('regions-fill')) {
                this.map.addLayer({ id: 'regions-fill', type: 'fill', source: 'world-regions', paint: { 'fill-color': ['case', ['==', ['get','ad_status'], 'occupied'], '#ff6b6b', '#16a085'], 'fill-opacity': 0.6 } });
                this.map.addLayer({ id: 'regions-border', type: 'line', source: 'world-regions', paint: { 'line-color': '#ffffff', 'line-width': 1, 'line-opacity': 0.8 } });
                this.map.addLayer({ id: 'regions-hover', type: 'fill', source: 'world-regions', paint: { 'fill-color': '#feca57', 'fill-opacity': 0 }, filter: ['==', 'id', ''] });
                if (!this.eventListenersAdded) { this.setupEventListeners(); this.eventListenersAdded = true; }
            }
            const isCountyLevel = geoJsonData.features.length > 10;
            const adminType = isCountyLevel ? 'ì¹´ìš´í‹°' : 'í”„ë¡œë¹ˆìŠ¤';
            console.log('ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, `ê°œ ${adminType}`);
            this.showNotification(`ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${geoJsonData.features.length}ê°œ í–‰ì •êµ¬ì—­ (4ê°œ í”„ë¡œë¹ˆìŠ¤ë¡œ ê·¸ë£¹í™”)`, 'info');
            this.updateStatistics();
        } catch (error) {
            console.error('ì•„ì¼ëœë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('ì•„ì¼ëœë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }

    // ì•„ì¼ëœë“œ í”„ë¡œë¹ˆìŠ¤ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ í‘œì‹œ
    displayIrelandGroupedRegions(provinceMapping) {
        console.log('\n=== ì•„ì¼ëœë“œ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (4ê°œ í”„ë¡œë¹ˆìŠ¤, 26ê°œ ì¹´ìš´í‹°) ===\n');
        
        // í”„ë¡œë¹ˆìŠ¤ë³„ ìš”ì•½ í…Œì´ë¸” í—¤ë”
        console.log('ğŸ“Š ì•„ì¼ëœë“œ 4ê°œ í”„ë¡œë¹ˆìŠ¤ (Provinces) ìš”ì•½');
        console.log('â”€'.repeat(95));
        console.log('ìˆœë²ˆ | í”„ë¡œë¹ˆìŠ¤ (ì˜ë¬¸ / í•œê¸€)'.padEnd(40) + '| ì¹´ìš´í‹° ìˆ˜'.padEnd(15) + '| ì¹´ìš´í‹° ëª©ë¡');
        console.log('â”€'.repeat(95));
        
        // í”„ë¡œë¹ˆìŠ¤ë³„ ìš”ì•½ ì¶œë ¥
        Object.keys(provinceMapping).forEach((provinceName, idx) => {
            const province = provinceMapping[provinceName];
            const seq = (idx + 1).toString().padEnd(5);
            const name = `${provinceName} (${province.name_ko})`.padEnd(38);
            const countyCount = province.counties.length.toString().padEnd(13);
            const counties = province.counties.join(', ');
            console.log(`${seq} | ${name} | ${countyCount} | ${counties}`);
        });
        console.log('â”€'.repeat(95));
        console.log('');
        
        // ì‹¤ì œ ë¡œë“œëœ ì§€ì—­ ë°ì´í„° ìˆ˜ì§‘
        const groupedRegions = {};
        let totalCounties = 0;

        this.regionData.forEach((regionData, regionId) => {
            if (regionData.country === 'Ireland') {
                const province = regionData.province || 'Unknown';
                if (!groupedRegions[province]) {
                    groupedRegions[province] = {
                        name_ko: regionData.province_ko || province,
                        name_en: regionData.province_en || province,
                        counties: []
                    };
                }
                groupedRegions[province].counties.push({
                    name: regionData.name,
                    name_en: regionData.name_en,
                    id: regionId,
                    population: regionData.population,
                    area: regionData.area
                });
                totalCounties++;
            }
        });

        // í”„ë¡œë¹ˆìŠ¤ë³„ë¡œ ì¶œë ¥
        Object.keys(provinceMapping).forEach(provinceName => {
            const province = provinceMapping[provinceName];
            const loadedCounties = groupedRegions[provinceName] || { counties: [] };
            
            console.log(`\nğŸ“Œ ${provinceName} (${province.name_ko})`);
            console.log(`   ì¹´ìš´í‹° ìˆ˜: ì´ ${province.counties.length}ê°œ (ë¡œë“œë¨: ${loadedCounties.counties.length}ê°œ)`);
            console.log('   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€');
            
            // ì˜ˆìƒ ì¹´ìš´í‹° ëª©ë¡
            province.counties.forEach((countyName, idx) => {
                const loadedCounty = loadedCounties.counties.find(c => 
                    c.name.toLowerCase().includes(countyName.toLowerCase()) ||
                    countyName.toLowerCase().includes(c.name.toLowerCase())
                );
                
                if (loadedCounty) {
                    console.log(`   ${idx + 1}. ${countyName} âœ“`);
                    console.log(`      â””â”€ ë¡œë“œëœ ì´ë¦„: ${loadedCounty.name}`);
                    console.log(`      â””â”€ ì¸êµ¬: ${loadedCounty.population.toLocaleString()}ëª…`);
                    console.log(`      â””â”€ ë©´ì : ${loadedCounty.area.toLocaleString()} kmÂ²`);
                } else {
                    console.log(`   ${idx + 1}. ${countyName} (ë°ì´í„° ì—†ìŒ)`);
                }
            });
        });

        console.log(`\n\nğŸ“Š ì´ê³„:`);
        console.log(`   â€¢ í”„ë¡œë¹ˆìŠ¤ (Provinces): ${Object.keys(provinceMapping).length}ê°œ`);
        console.log(`   â€¢ ì¹´ìš´í‹° (Counties): ${totalCounties}ê°œ ë¡œë“œë¨`);
        console.log(`\n==========================================\n`);

        // HTML ì½˜ì†”ì—ë„ í‘œì‹œ (ë¸Œë¼ìš°ì € ê°œë°œì ë„êµ¬)
        const groupedHtml = this.generateIrelandGroupedHTML(provinceMapping, groupedRegions);
        console.log('%cì•„ì¼ëœë“œ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™”', 'color: #16a085; font-size: 16px; font-weight: bold;');
        console.log(groupedHtml);
    }

    // HTML í˜•ì‹ìœ¼ë¡œ ê·¸ë£¹í™”ëœ ì§€ì—­ ëª©ë¡ ìƒì„±
    generateIrelandGroupedHTML(provinceMapping, groupedRegions) {
        let html = '<div style="font-family: monospace; background: #1a1a1a; padding: 20px; border-radius: 8px; color: #fff;">';
        html += '<h3 style="color: #16a085; margin-top: 0;">ì•„ì¼ëœë“œ í–‰ì •êµ¬ì—­ ê·¸ë£¹í™” (4ê°œ í”„ë¡œë¹ˆìŠ¤, 26ê°œ ì¹´ìš´í‹°)</h3>';
        
        // í”„ë¡œë¹ˆìŠ¤ë³„ ìš”ì•½ í…Œì´ë¸”
        Object.keys(provinceMapping).forEach(provinceName => {
            const province = provinceMapping[provinceName];
            const loadedCounties = groupedRegions[provinceName] || { counties: [] };
            
            html += `<h4 style="color: #16a085; margin-top: 20px;">${provinceName} (${province.name_ko})</h4>`;
            html += `<p style="color: #aaa; margin: 0 0 10px 0; font-size: 12px;">ì¹´ìš´í‹° ìˆ˜: ì´ ${province.counties.length}ê°œ (ë¡œë“œë¨: ${loadedCounties.counties.length}ê°œ)</p>`;
            html += '<table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">';
            html += '<thead><tr style="background: #2a2a2a;"><th style="padding: 8px; text-align: left;">ìˆœë²ˆ</th><th style="padding: 8px; text-align: left;">ì¹´ìš´í‹°</th></tr></thead>';
            html += '<tbody>';
            
            province.counties.forEach((countyName, idx) => {
                const loadedCounty = loadedCounties.counties.find(c => 
                    c.name.toLowerCase().includes(countyName.toLowerCase()) ||
                    countyName.toLowerCase().includes(c.name.toLowerCase())
                );
                
                html += `<tr style="border-bottom: 1px solid #333;">`;
                html += `<td style="padding: 8px;">${idx + 1}</td>`;
                html += `<td style="padding: 8px; color: ${loadedCounty ? '#16a085' : '#666'};">
                    ${countyName} ${loadedCounty ? 'âœ“' : '(ë°ì´í„° ì—†ìŒ)'}
                </td>`;
                html += `</tr>`;
            });
            
            html += '</tbody></table>';
        });
        
        html += '</div>';
        return html;
    }
    
    async loadPortugalData() {
        const portugalRegions = {
            'lisboa': { name_en: 'Lisboa', name_local: 'Lisboa', name_ko: 'ë¦¬ìŠ¤ë³´ì•„', population: 2300000, area: 2761, aliases: ['lisbon', 'distrito de lisboa'] },
            'porto': { name_en: 'Porto', name_local: 'Porto', name_ko: 'í¬ë¥´íˆ¬', population: 1780000, area: 2395, aliases: ['oporto', 'distrito do porto'] },
            'braga': { name_en: 'Braga', name_local: 'Braga', name_ko: 'ë¸Œë¼ê°€', population: 850000, area: 2673 },
            'aveiro': { name_en: 'Aveiro', name_local: 'Aveiro', name_ko: 'ì•„ë² ì´ë£¨', population: 720000, area: 2808 },
            'setubal': { name_en: 'SetÃºbal', name_local: 'SetÃºbal', name_ko: 'ì„¸íˆ¬ë°œ', population: 910000, area: 5064, aliases: ['setubal'] },
            'leiria': { name_en: 'Leiria', name_local: 'Leiria', name_ko: 'ë ˆì´ë¦¬ì•„', population: 460000, area: 3515 },
            'santarem': { name_en: 'SantarÃ©m', name_local: 'SantarÃ©m', name_ko: 'ì‚°íƒ€ë ˜', population: 420000, area: 6747, aliases: ['santarem'] },
            'coimbra': { name_en: 'Coimbra', name_local: 'Coimbra', name_ko: 'ì½”ì„ë¸Œë¼', population: 420000, area: 3947 },
            'faro': { name_en: 'Faro', name_local: 'Faro', name_ko: 'íŒŒë£¨', population: 460000, area: 4960, aliases: ['algarve'] },
            'viseu': { name_en: 'Viseu', name_local: 'Viseu', name_ko: 'ë¹„ì œìš°', population: 370000, area: 5007 },
            'vila_real': { name_en: 'Vila Real', name_local: 'Vila Real', name_ko: 'ë¹Œë¼ ë ˆì•Œ', population: 185000, area: 4328 },
            'viana_do_castelo': { name_en: 'Viana do Castelo', name_local: 'Viana do Castelo', name_ko: 'ë¹„ì•„ë‚˜ ë‘ ì¹´ìŠ¤í…”ë£¨', population: 240000, area: 2255 },
            'braganca': { name_en: 'BraganÃ§a', name_local: 'BraganÃ§a', name_ko: 'ë¸Œë¼ê°„ì‚¬', population: 120000, area: 6608, aliases: ['braganca'] },
            'guarda': { name_en: 'Guarda', name_local: 'Guarda', name_ko: 'ê³¼ë¥´ë‹¤', population: 140000, area: 5518 },
            'castelo_branco': { name_en: 'Castelo Branco', name_local: 'Castelo Branco', name_ko: 'ì¹´ìŠ¤í…”ë£¨ ë¸Œë‘ì¿ ', population: 170000, area: 6675 },
            'portalegre': { name_en: 'Portalegre', name_local: 'Portalegre', name_ko: 'í¬ë¥´íƒˆë ˆê·¸ë¦¬', population: 115000, area: 6065 },
            'evora': { name_en: 'Ã‰vora', name_local: 'Ã‰vora', name_ko: 'ì—ë³´ë¼', population: 150000, area: 7393, aliases: ['evora'] },
            'beja': { name_en: 'Beja', name_local: 'Beja', name_ko: 'ë² ì', population: 140000, area: 10263 },
            'acores': { name_en: 'Azores', name_local: 'RegiÃ£o AutÃ³noma dos AÃ§ores', name_ko: 'ì•„ì¡°ë ˆìŠ¤ ì œë„', population: 240000, area: 2333, aliases: ['regiao autonoma dos acores', 'acores', 'azores', 'ilha dos acores'] },
            'madeira': { name_en: 'Madeira', name_local: 'RegiÃ£o AutÃ³noma da Madeira', name_ko: 'ë§ˆë°ì´ë¼ ì œë„', population: 260000, area: 801, aliases: ['regiao autonoma da madeira', 'madeira'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'portugal',
            countryName: 'Portugal',
            countryNameKo: 'í¬ë¥´íˆ¬ê°ˆ',
            countryCodeIso: 'PRT',
            defaultColor: '#27ae60',
            adminLevel: 'District / Autonomous Region',
            mapping: portugalRegions
        });
    }
    
    async loadGreeceData() {
        const greeceRegions = {
            'attica': { name_en: 'Attica', name_local: 'Î‘Ï„Ï„Î¹ÎºÎ®', name_ko: 'ì•„í‹°í‚¤', population: 3780000, area: 3808, aliases: ['attiki', 'region of attica'] },
            'central_macedonia': { name_en: 'Central Macedonia', name_local: 'ÎšÎµÎ½Ï„ÏÎ¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', name_ko: 'ì¤‘ì•™ë§ˆì¼€ë„ë‹ˆì•„', population: 1870000, area: 18810, aliases: ['kentriki makedonia'] },
            'eastern_macedonia_thrace': { name_en: 'Eastern Macedonia and Thrace', name_local: 'Î‘Î½Î±Ï„Î¿Î»Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î± ÎºÎ±Î¹ Î˜ÏÎ¬ÎºÎ·', name_ko: 'ë™ë§ˆì¼€ë„ë‹ˆì•„ íŠ¸ë¼í‚¤ì•„', population: 600000, area: 14150, aliases: ['anatoliki makedonia kai thraki'] },
            'western_macedonia': { name_en: 'Western Macedonia', name_local: 'Î”Ï…Ï„Î¹ÎºÎ® ÎœÎ±ÎºÎµÎ´Î¿Î½Î¯Î±', name_ko: 'ì„œë§ˆì¼€ë„ë‹ˆì•„', population: 250000, area: 9450, aliases: ['dytiki makedonia'] },
            'epirus': { name_en: 'Epirus', name_local: 'Î‰Ï€ÎµÎ¹ÏÎ¿Ï‚', name_ko: 'ì´í”¼ë¡œìŠ¤', population: 330000, area: 9200, aliases: ['ipeiros'] },
            'thessaly': { name_en: 'Thessaly', name_local: 'Î˜ÎµÏƒÏƒÎ±Î»Î¯Î±', name_ko: 'í…Œì‚´ë¦¬ì•„', population: 720000, area: 14030, aliases: ['thessalia'] },
            'western_greece': { name_en: 'Western Greece', name_local: 'Î”Ï…Ï„Î¹ÎºÎ® Î•Î»Î»Î¬Î´Î±', name_ko: 'ì„œê·¸ë¦¬ìŠ¤', population: 670000, area: 11300, aliases: ['dytiki ellada'] },
            'central_greece': { name_en: 'Central Greece', name_local: 'Î£Ï„ÎµÏÎµÎ¬ Î•Î»Î»Î¬Î´Î±', name_ko: 'ì¤‘ë¶€ê·¸ë¦¬ìŠ¤', population: 540000, area: 15500, aliases: ['sterea ellada'] },
            'peloponnese': { name_en: 'Peloponnese', name_local: 'Î ÎµÎ»Î¿Ï€ÏŒÎ½Î½Î·ÏƒÎ¿Ï‚', name_ko: 'í ë¡œí°ë„¤ì†ŒìŠ¤', population: 570000, area: 15490, aliases: ['peloponnisos'] },
            'ionian_islands': { name_en: 'Ionian Islands', name_local: 'Î™ÏŒÎ½Î¹Î± ÎÎ·ÏƒÎ¹Î¬', name_ko: 'ì´ì˜¤ë‹ˆì•„ ì œë„', population: 210000, area: 2300, aliases: ['ionia nisia', 'region of ionian islands'] },
            'north_aegean': { name_en: 'North Aegean', name_local: 'Î’ÏŒÏÎµÎ¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', name_ko: 'ë¶ì—ê²Œ ì œë„', population: 190000, area: 3800, aliases: ['voreio aigaio'] },
            'south_aegean': { name_en: 'South Aegean', name_local: 'ÎÏŒÏ„Î¹Î¿ Î‘Î¹Î³Î±Î¯Î¿', name_ko: 'ë‚¨ì—ê²Œ ì œë„', population: 310000, area: 5900, aliases: ['notio aigaio'] },
            'crete': { name_en: 'Crete', name_local: 'ÎšÏÎ®Ï„Î·', name_ko: 'í¬ë ˆíƒ€', population: 620000, area: 8336, aliases: ['kriti'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'greece',
            countryName: 'Greece',
            countryNameKo: 'ê·¸ë¦¬ìŠ¤',
            countryCodeIso: 'GRC',
            defaultColor: '#2980b9',
            adminLevel: 'Region',
            mapping: greeceRegions
        });
    }
    
    async loadCzechRepublicData() {
        const czechRegions = {
            'prague': { name_en: 'Prague', name_local: 'HlavnÃ­ mÄ›sto Praha', name_ko: 'í”„ë¼í•˜', population: 1360000, area: 496, aliases: ['hlavni mesto praha', 'praha'] },
            'central_bohemian': { name_en: 'Central Bohemian', name_local: 'StÅ™edoÄeskÃ½ kraj', name_ko: 'ì¤‘ë¶€ë³´í—¤ë¯¸ì•„', population: 1450000, area: 10929, aliases: ['stredocesky kraj'] },
            'south_bohemian': { name_en: 'South Bohemian', name_local: 'JihoÄeskÃ½ kraj', name_ko: 'ë‚¨ë¶€ë³´í—¤ë¯¸ì•„', population: 640000, area: 10056, aliases: ['jihocesky kraj'] },
            'plzen': { name_en: 'PlzeÅˆ', name_local: 'PlzeÅˆskÃ½ kraj', name_ko: 'í”Œì  ', population: 580000, area: 7561, aliases: ['plzensky kraj', 'plzen'] },
            'karlovy_vary': { name_en: 'Karlovy Vary', name_local: 'KarlovarskÃ½ kraj', name_ko: 'ì¹´ë¥¼ë¡œë¹„ë°”ë¦¬', population: 290000, area: 3314, aliases: ['karlovarsky kraj'] },
            'usti_nad_labem': { name_en: 'ÃšstÃ­ nad Labem', name_local: 'ÃšsteckÃ½ kraj', name_ko: 'ìš°ìŠ¤í‹°', population: 810000, area: 5335, aliases: ['ustecky kraj', 'usti nad labem'] },
            'liberec': { name_en: 'Liberec', name_local: 'LibereckÃ½ kraj', name_ko: 'ë¦¬ë² ë ˆì¸ ', population: 460000, area: 3163, aliases: ['liberecky kraj'] },
            'hradec_kralove': { name_en: 'Hradec KrÃ¡lovÃ©', name_local: 'KrÃ¡lovÃ©hradeckÃ½ kraj', name_ko: 'íë¼ë°ì¸ í¬ë„ë¡œë² ', population: 550000, area: 4758, aliases: ['kralovehradecky kraj', 'hradec kralove'] },
            'pardubice': { name_en: 'Pardubice', name_local: 'PardubickÃ½ kraj', name_ko: 'íŒŒë¥´ë‘ë¹„ì²´', population: 520000, area: 4519, aliases: ['pardubicky kraj'] },
            'vysocina': { name_en: 'VysoÄina', name_local: 'Kraj VysoÄina', name_ko: 'ë¹„ì†Œì¹˜ë‚˜', population: 505000, area: 6796, aliases: ['kraj vysocina', 'vysocina'] },
            'south_moravian': { name_en: 'South Moravian', name_local: 'JihomoravskÃ½ kraj', name_ko: 'ë‚¨ë¶€ëª¨ë¼ë¹„ì•„', population: 1200000, area: 7196, aliases: ['jihomoravsky kraj'] },
            'olomouc': { name_en: 'Olomouc', name_local: 'OlomouckÃ½ kraj', name_ko: 'ì˜¬ë¡œëª¨ìš°ì¸ ', population: 630000, area: 5206, aliases: ['olomoucky kraj'] },
            'zlin': { name_en: 'ZlÃ­n', name_local: 'ZlÃ­nskÃ½ kraj', name_ko: 'ì¦ë¦°', population: 570000, area: 3964, aliases: ['zlinsky kraj'] },
            'moravian_silesian': { name_en: 'Moravian-Silesian', name_local: 'MoravskoslezskÃ½ kraj', name_ko: 'ëª¨ë¼ë¹„ì•„ìŠ¬ë ˆìŠ¤ì¹´', population: 1160000, area: 5427, aliases: ['moravskoslezsky kraj', 'moravian silesian'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'czech-republic',
            countryName: 'Czech Republic',
            countryNameKo: 'ì²´ì½”',
            countryCodeIso: 'CZE',
            defaultColor: '#8e44ad',
            adminLevel: 'Region (Kraj)',
            mapping: czechRegions
        });
    }
    
    async loadRomaniaData() {
        const romaniaRegions = {
            'alba': { name_en: 'Alba', name_local: 'Alba', name_ko: 'ì•Œë°”', population: 320000, area: 6242 },
            'arad': { name_en: 'Arad', name_local: 'Arad', name_ko: 'ì•„ë¼ë“œ', population: 470000, area: 7754 },
            'arges': { name_en: 'ArgeÈ™', name_local: 'ArgeÈ™', name_ko: 'ì•„ë¥´ì œìŠˆ', population: 610000, area: 6826, aliases: ['arges'] },
            'bacau': { name_en: 'BacÄƒu', name_local: 'BacÄƒu', name_ko: 'ë°”ì»¤ìš°', population: 610000, area: 6621, aliases: ['bacau'] },
            'bihor': { name_en: 'Bihor', name_local: 'Bihor', name_ko: 'ë¹„í˜¸ë¥´', population: 590000, area: 7544 },
            'bistrita_nasaud': { name_en: 'BistriÈ›a-NÄƒsÄƒud', name_local: 'BistriÈ›a-NÄƒsÄƒud', name_ko: 'ë¹„ìŠ¤íŠ¸ë¦¬ì°¨ë„ˆì„œìš°ë“œ', population: 280000, area: 5355, aliases: ['bistrita-nasaud', 'bistrita nasaud'] },
            'botosani': { name_en: 'BotoÈ™ani', name_local: 'BotoÈ™ani', name_ko: 'ë³´í† ìƒ¤ë‹ˆ', population: 370000, area: 4986, aliases: ['botosani'] },
            'brasov': { name_en: 'BraÈ™ov', name_local: 'BraÈ™ov', name_ko: 'ë¸Œë¼ì‡¼ë¸Œ', population: 570000, area: 5363, aliases: ['brasov'] },
            'braila': { name_en: 'BrÄƒila', name_local: 'BrÄƒila', name_ko: 'ë¸ŒëŸ¬ì¼ë¼', population: 300000, area: 4766, aliases: ['braila'] },
            'buzau': { name_en: 'BuzÄƒu', name_local: 'BuzÄƒu', name_ko: 'ë¶€ì €ìš°', population: 430000, area: 6103, aliases: ['buzau'] },
            'caras_severin': { name_en: 'CaraÈ™-Severin', name_local: 'CaraÈ™-Severin', name_ko: 'ì¹´ë¼ìŠˆì„¸ë² ë¦°', population: 270000, area: 8514, aliases: ['caras severin', 'caras-severin'] },
            'calarasi': { name_en: 'CÄƒlÄƒraÈ™i', name_local: 'CÄƒlÄƒraÈ™i', name_ko: 'ì»¬ëŸ¬ë¼ì‹œ', population: 270000, area: 5088, aliases: ['calarasi'] },
            'cluj': { name_en: 'Cluj', name_local: 'Cluj', name_ko: 'í´ë£¨ì§€', population: 740000, area: 6674 },
            'constanta': { name_en: 'ConstanÈ›a', name_local: 'ConstanÈ›a', name_ko: 'ì½˜ìŠ¤íƒ„ì°¨', population: 700000, area: 7071, aliases: ['constanta'] },
            'covasna': { name_en: 'Covasna', name_local: 'Covasna', name_ko: 'ì½”ë°”ìŠ¤ë‚˜', population: 200000, area: 3710 },
            'dambovita': { name_en: 'DÃ¢mboviÈ›a', name_local: 'DÃ¢mboviÈ›a', name_ko: 'ë¤ë³´ë¹„ì°¨', population: 500000, area: 4054, aliases: ['dambovita'] },
            'dolj': { name_en: 'Dolj', name_local: 'Dolj', name_ko: 'ëŒì§€', population: 580000, area: 7414 },
            'galati': { name_en: 'GalaÈ›i', name_local: 'GalaÈ›i', name_ko: 'ê°ˆë¼ì¹˜', population: 530000, area: 4466, aliases: ['galati'] },
            'giurgiu': { name_en: 'Giurgiu', name_local: 'Giurgiu', name_ko: 'ì§€ìš°ë¥´ì§€ìš°', population: 250000, area: 3526 },
            'gorj': { name_en: 'Gorj', name_local: 'Gorj', name_ko: 'ê³ ë¥´ì§€', population: 320000, area: 5602 },
            'harghita': { name_en: 'Harghita', name_local: 'Harghita', name_ko: 'í•˜ë¥´ê¸°íƒ€', population: 280000, area: 6639 },
            'hunedoara': { name_en: 'Hunedoara', name_local: 'Hunedoara', name_ko: 'í›„ë„¤ë„ì•„ë¼', population: 380000, area: 7063 },
            'ialomita': { name_en: 'IalomiÈ›a', name_local: 'IalomiÈ›a', name_ko: 'ì´ì•Œë¡œë¯¸ì°¨', population: 250000, area: 4453, aliases: ['ialomita'] },
            'iasi': { name_en: 'IaÈ™i', name_local: 'IaÈ™i', name_ko: 'ì•¼ì‹œ', population: 750000, area: 5476, aliases: ['iasi'] },
            'ilfov': { name_en: 'Ilfov', name_local: 'Ilfov', name_ko: 'ì¼í¬ë¸Œ', population: 550000, area: 1583 },
            'maramures': { name_en: 'MaramureÈ™', name_local: 'MaramureÈ™', name_ko: 'ë§ˆë¼ë¬´ë ˆìŠˆ', population: 470000, area: 6304, aliases: ['maramures'] },
            'mehedinti': { name_en: 'MehedinÈ›i', name_local: 'MehedinÈ›i', name_ko: 'ë©”í—¤ë”˜ì¹˜', population: 260000, area: 4933, aliases: ['mehedinti'] },
            'mures': { name_en: 'MureÈ™', name_local: 'MureÈ™', name_ko: 'ë¬´ë ˆìŠˆ', population: 540000, area: 6714, aliases: ['mures'] },
            'neamt': { name_en: 'NeamÈ›', name_local: 'NeamÈ›', name_ko: 'ë„¤ì•”ì¸ ', population: 470000, area: 5896, aliases: ['neamt'] },
            'olt': { name_en: 'Olt', name_local: 'Olt', name_ko: 'ì˜¬íŠ¸', population: 420000, area: 5498 },
            'prahova': { name_en: 'Prahova', name_local: 'Prahova', name_ko: 'í”„ë¼í˜¸ë°”', population: 800000, area: 4716 },
            'satu_mare': { name_en: 'Satu Mare', name_local: 'Satu Mare', name_ko: 'ì‚¬íˆ¬ë§ˆë ˆ', population: 330000, area: 4418 },
            'salaj': { name_en: 'SÄƒlaj', name_local: 'SÄƒlaj', name_ko: 'ì„¤ë¼ì£¼', population: 200000, area: 3850, aliases: ['salaj'] },
            'sibiu': { name_en: 'Sibiu', name_local: 'Sibiu', name_ko: 'ì‹œë¹„ìš°', population: 410000, area: 5432 },
            'suceava': { name_en: 'Suceava', name_local: 'Suceava', name_ko: 'ìˆ˜ì²´ì•„ë°”', population: 620000, area: 8553 },
            'teleorman': { name_en: 'Teleorman', name_local: 'Teleorman', name_ko: 'í…”ë ˆì˜¤ë¥´ë§Œ', population: 320000, area: 5790 },
            'timis': { name_en: 'TimiÈ™', name_local: 'TimiÈ™', name_ko: 'í‹°ë¯¸ìŠˆ', population: 760000, area: 8697, aliases: ['timis'] },
            'tulcea': { name_en: 'Tulcea', name_local: 'Tulcea', name_ko: 'íˆ´ì²´ì•„', population: 200000, area: 8499 },
            'vaslui': { name_en: 'Vaslui', name_local: 'Vaslui', name_ko: 'ë°”ìŠ¬ë£¨ì´', population: 370000, area: 5318 },
            'valcea': { name_en: 'VÃ¢lcea', name_local: 'VÃ¢lcea', name_ko: 'ë¸”ì²´ì•„', population: 370000, area: 5768, aliases: ['valcea'] },
            'vrancea': { name_en: 'Vrancea', name_local: 'Vrancea', name_ko: 'ë¸Œë€ì²´ì•„', population: 330000, area: 4857 },
            'bucharest': { name_en: 'Bucharest', name_local: 'Municipiul BucureÈ™ti', name_ko: 'ë¶€ì¿ ë ˆìŠˆí‹°', population: 1700000, area: 228, aliases: ['municipiul bucuresti', 'bucuresti', 'bucharest'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'romania',
            countryName: 'Romania',
            countryNameKo: 'ë£¨ë§ˆë‹ˆì•„',
            countryCodeIso: 'ROU',
            defaultColor: '#c0392b',
            adminLevel: 'County (JudeÈ›)',
            mapping: romaniaRegions
        });
    }
    
    // í—ê°€ë¦¬ ë°ì´í„° ë¡œë“œ (20ê°œ ì£¼)
    async loadHungaryData() {
        const hungaryRegions = {
            'budapest': { name_en: 'Budapest', name_local: 'Budapest', name_ko: 'ë¶€ë‹¤í˜ìŠ¤íŠ¸', population: 1720000, area: 525, admin_level: 'Capital City', aliases: ['budapest fovaros', 'budapest fÅ‘vÃ¡ros'] },
            'bacs_kiskun': { name_en: 'BÃ¡cs-Kiskun', name_local: 'BÃ¡cs-Kiskun', name_ko: 'ë²„ì¹˜í‚¤ìŠˆì¿¤', population: 490000, area: 8445, aliases: ['bacs-kiskun', 'bacs kiskun'] },
            'baranya': { name_en: 'Baranya', name_local: 'Baranya', name_ko: 'ë²„ëŸ¬ë…€', population: 360000, area: 4430 },
            'bekes': { name_en: 'BÃ©kÃ©s', name_local: 'BÃ©kÃ©s', name_ko: 'ë² ì¼€ì‹œ', population: 330000, area: 5630, aliases: ['bekes'] },
            'borsod_abauj_zemplen': { name_en: 'Borsod-AbaÃºj-ZemplÃ©n', name_local: 'Borsod-AbaÃºj-ZemplÃ©n', name_ko: 'ë³´ë¥´ì‡¼ë“œì–´ë²„ìš°ì´ì  í”Œë Œ', population: 630000, area: 7247, aliases: ['borsod-abauj-zemplen', 'borsod abauj zemplen'] },
            'csongrad_csanad': { name_en: 'CsongrÃ¡d-CsanÃ¡d', name_local: 'CsongrÃ¡d-CsanÃ¡d', name_ko: 'ì´Œê·¸ë¼ë“œ-ì°¨ë‚˜ë“œ', population: 390000, area: 4263, aliases: ['csongrad-csanad', 'csongrad csanad', 'csongrad'] },
            'fejer': { name_en: 'FejÃ©r', name_local: 'FejÃ©r', name_ko: 'í˜ì˜ˆë¥´', population: 420000, area: 4358, aliases: ['fejer'] },
            'gyor_moson_sopron': { name_en: 'GyÅ‘r-Moson-Sopron', name_local: 'GyÅ‘r-Moson-Sopron', name_ko: 'ì£„ë¥´-ëª¨ìˆ€-ì‡¼í”„ë¡ ', population: 480000, area: 4208, aliases: ['gyor-moson-sopron', 'gyor moson sopron'] },
            'hajdu_bihar': { name_en: 'HajdÃº-Bihar', name_local: 'HajdÃº-Bihar', name_ko: 'í•˜ì´ë‘ë¹„í—ˆë¥´', population: 530000, area: 6210, aliases: ['hajdu-bihar', 'hajdu bihar'] },
            'heves': { name_en: 'Heves', name_local: 'Heves', name_ko: 'í—¤ë² ì‹œ', population: 280000, area: 3637 },
            'jasz_nagykun_szolnok': { name_en: 'JÃ¡sz-Nagykun-Szolnok', name_local: 'JÃ¡sz-Nagykun-Szolnok', name_ko: 'ì•¼ìŠ¤ë„ˆì§€ì¿¤ì†”ë…¸í¬', population: 360000, area: 5582, aliases: ['jasz-nagykun-szolnok', 'jasz nagykun szolnok'] },
            'komarom_esztergom': { name_en: 'KomÃ¡rom-Esztergom', name_local: 'KomÃ¡rom-Esztergom', name_ko: 'ì½”ë§ˆë¡¬-ì—ìŠ¤í…Œë¥´ê³°', population: 300000, area: 2265, aliases: ['komarom-esztergom', 'komarom esztergom'] },
            'nograd': { name_en: 'NÃ³grÃ¡d', name_local: 'NÃ³grÃ¡d', name_ko: 'ë…¸ê·¸ë¼ë“œ', population: 180000, area: 2544, aliases: ['nograd'] },
            'pest': { name_en: 'Pest', name_local: 'Pest', name_ko: 'í˜ìŠˆíŠ¸', population: 1350000, area: 6394 },
            'somogy': { name_en: 'Somogy', name_local: 'Somogy', name_ko: 'ì‡¼ë¨¸ì§€', population: 280000, area: 6036 },
            'szabolcs_szatmar_bereg': { name_en: 'Szabolcs-SzatmÃ¡r-Bereg', name_local: 'Szabolcs-SzatmÃ¡r-Bereg', name_ko: 'ì„œë³¼ì¸ -ì„œíŠ¸ë¨¸ë¥´-ë² ë ˆê·¸', population: 525000, area: 5935, aliases: ['szabolcs-szatmar-bereg', 'szabolcs szatmar bereg'] },
            'tolna': { name_en: 'Tolna', name_local: 'Tolna', name_ko: 'í†¨ë„ˆ', population: 210000, area: 3703 },
            'vas': { name_en: 'Vas', name_local: 'Vas', name_ko: 'ë²„ì‹œ', population: 250000, area: 3336 },
            'veszprem': { name_en: 'VeszprÃ©m', name_local: 'VeszprÃ©m', name_ko: 'ë² ìŠ¤í”„ë ˜', population: 340000, area: 4463, aliases: ['veszprem'] },
            'zala': { name_en: 'Zala', name_local: 'Zala', name_ko: 'ì¡¸ëŸ¬', population: 260000, area: 3784 }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'hungary',
            countryName: 'Hungary',
            countryNameKo: 'í—ê°€ë¦¬',
            countryCodeIso: 'HUN',
            defaultColor: '#d35400',
            adminLevel: 'County (Megye)',
            mapping: hungaryRegions
        });
    }

    async loadBulgariaData() {
        const bulgariaRegions = {
            'sofia_capital': { name_en: 'Sofia (Capital)', name_local: 'Ğ¡Ğ¾Ñ„Ğ¸Ñ-Ğ³Ñ€Ğ°Ğ´', name_ko: 'ì†Œí”¼ì•„ ì‹œ', population: 1310000, area: 1349, admin_level: 'Capital Municipality', aliases: ['sofia grad', 'sofia-city', 'sofia city'] },
            'sofia_province': { name_en: 'Sofia Province', name_local: 'Ğ¡Ğ¾Ñ„Ğ¸Ğ¹ÑĞºĞ° Ğ¾Ğ±Ğ»Ğ°ÑÑ‚', name_ko: 'ì†Œí”¼ì•„ ì£¼', population: 220000, area: 7059, aliases: ['sofiyska oblast', 'sofia oblast'] },
            'plovdiv': { name_en: 'Plovdiv', name_local: 'ĞŸĞ»Ğ¾Ğ²Ğ´Ğ¸Ğ²', name_ko: 'í”Œë¡œë¸Œë””í”„', population: 620000, area: 5972 },
            'varna': { name_en: 'Varna', name_local: 'Ğ’Ğ°Ñ€Ğ½Ğ°', name_ko: 'ë°”ë¥´ë‚˜', population: 470000, area: 3819 },
            'burgas': { name_en: 'Burgas', name_local: 'Ğ‘ÑƒÑ€Ğ³Ğ°Ñ', name_ko: 'ë¶€ë¥´ê°€ìŠ¤', population: 390000, area: 7748 },
            'stara_zagora': { name_en: 'Stara Zagora', name_local: 'Ğ¡Ñ‚Ğ°Ñ€Ğ° Ğ—Ğ°Ğ³Ğ¾Ñ€Ğ°', name_ko: 'ìŠ¤íƒ€ë¼ìê³ ë¼', population: 300000, area: 5151, aliases: ['stara zagora'] },
            'blagoevgrad': { name_en: 'Blagoevgrad', name_local: 'Ğ‘Ğ»Ğ°Ğ³Ğ¾ĞµĞ²Ğ³Ñ€Ğ°Ğ´', name_ko: 'ë¸”ë¼ê³ ì—ë¸Œê·¸ë¼ë“œ', population: 280000, area: 6449 },
            'pleven': { name_en: 'Pleven', name_local: 'ĞŸĞ»ĞµĞ²ĞµĞ½', name_ko: 'í”Œë ˆë²¤', population: 240000, area: 4653 },
            'sliven': { name_en: 'Sliven', name_local: 'Ğ¡Ğ»Ğ¸Ğ²ĞµĞ½', name_ko: 'ìŠ¬ë¦¬ë²¤', population: 180000, area: 3554 },
            'dobrich': { name_en: 'Dobrich', name_local: 'Ğ”Ğ¾Ğ±Ñ€Ğ¸Ñ‡', name_ko: 'ë„ë¸Œë¦¬ì¹˜', population: 160000, area: 4719 },
            'veliko_tarnovo': { name_en: 'Veliko Tarnovo', name_local: 'Ğ’ĞµĞ»Ğ¸ĞºĞ¾ Ğ¢ÑŠÑ€Ğ½Ğ¾Ğ²Ğ¾', name_ko: 'ë²¨ë¦¬ì½”í„°ë¥´ë…¸ë³´', population: 220000, area: 4662, aliases: ['veliko tarnovo', 'veliko turnovo'] },
            'haskovo': { name_en: 'Haskovo', name_local: 'Ğ¥Ğ°ÑĞºĞ¾Ğ²Ğ¾', name_ko: 'í•˜ìŠ¤ì½”ë³´', population: 210000, area: 5543 },
            'shumen': { name_en: 'Shumen', name_local: 'Ğ¨ÑƒĞ¼ĞµĞ½', name_ko: 'ìŠˆë©˜', population: 170000, area: 3389 },
            'yambol': { name_en: 'Yambol', name_local: 'Ğ¯Ğ¼Ğ±Ğ¾Ğ»', name_ko: 'ì–Œë³¼', population: 110000, area: 3333 },
            'ruse': { name_en: 'Ruse', name_local: 'Ğ ÑƒÑĞµ', name_ko: 'ë£¨ì„¸', population: 200000, area: 2621, aliases: ['rousse', 'ruse'] },
            'pernik': { name_en: 'Pernik', name_local: 'ĞŸĞµÑ€Ğ½Ğ¸Ğº', name_ko: 'í˜ë¥´ë‹ˆí¬', population: 110000, area: 2392 },
            'kyustendil': { name_en: 'Kyustendil', name_local: 'ĞšÑÑÑ‚ĞµĞ½Ğ´Ğ¸Ğ»', name_ko: 'íìŠ¤í…ë”œ', population: 115000, area: 3084, aliases: ['kyustendil', 'kjustendil'] },
            'gabrovo': { name_en: 'Gabrovo', name_local: 'Ğ“Ğ°Ğ±Ñ€Ğ¾Ğ²Ğ¾', name_ko: 'ê°€ë¸Œë¡œë³´', population: 100000, area: 2023 },
            'montana': { name_en: 'Montana', name_local: 'ĞœĞ¾Ğ½Ñ‚Ğ°Ğ½Ğ°', name_ko: 'ëª¬íƒ€ë‚˜', population: 125000, area: 3635 },
            'vratsa': { name_en: 'Vratsa', name_local: 'Ğ’Ñ€Ğ°Ñ†Ğ°', name_ko: 'ë¸Œë¼ì°¨', population: 155000, area: 3619 },
            'vidin': { name_en: 'Vidin', name_local: 'Ğ’Ğ¸Ğ´Ğ¸Ğ½', name_ko: 'ë¹„ë”˜', population: 80000, area: 3032 },
            'lovech': { name_en: 'Lovech', name_local: 'Ğ›Ğ¾Ğ²ĞµÑ‡', name_ko: 'ë¡œë² ì¹˜', population: 120000, area: 4128 },
            'targovishte': { name_en: 'Targovishte', name_local: 'Ğ¢ÑŠÑ€Ğ³Ğ¾Ğ²Ğ¸Ñ‰Ğµ', name_ko: 'í„°ë¥´ê³ ë¹„ì‰¬í…Œ', population: 110000, area: 2716, aliases: ['targovishte', 'turgovishte'] },
            'razgrad': { name_en: 'Razgrad', name_local: 'Ğ Ğ°Ğ·Ğ³Ñ€Ğ°Ğ´', name_ko: 'ë¼ì¦ˆê·¸ë¼ë“œ', population: 110000, area: 2639 },
            'silistra': { name_en: 'Silistra', name_local: 'Ğ¡Ğ¸Ğ»Ğ¸ÑÑ‚Ñ€Ğ°', name_ko: 'ì‹¤ë¦¬ìŠ¤íŠ¸ë¼', population: 105000, area: 2846 },
            'smolyan': { name_en: 'Smolyan', name_local: 'Ğ¡Ğ¼Ğ¾Ğ»ÑĞ½', name_ko: 'ìŠ¤ëª°ë¸', population: 100000, area: 3193, aliases: ['smoljan'] },
            'kardzhali': { name_en: 'Kardzhali', name_local: 'ĞšÑŠÑ€Ğ´Ğ¶Ğ°Ğ»Ğ¸', name_ko: 'ì»¤ë¥´ì˜ë¦¬', population: 150000, area: 3209, aliases: ['kardjali', 'kurdzhali'] },
            'pazardzhik': { name_en: 'Pazardzhik', name_local: 'ĞŸĞ°Ğ·Ğ°Ñ€Ğ´Ğ¶Ğ¸Ğº', name_ko: 'íŒŒìë¥´ì§€í¬', population: 270000, area: 4480, aliases: ['pazardjik', 'pazardzhik'] }
        };

        await this.loadCustomEuropeanCountry({
            countryKey: 'bulgaria',
            countryName: 'Bulgaria',
            countryNameKo: 'ë¶ˆê°€ë¦¬ì•„',
            countryCodeIso: 'BGR',
            defaultColor: '#7f8c8d',
            adminLevel: 'Province (Oblast)',
            mapping: bulgariaRegions
        });
    }

    async loadKoreaData() {
        try {
            let geoJsonData;
            
            // ìºì‹œëœ ë°ì´í„° ë¬´ì‹œí•˜ê³  í•­ìƒ ìƒˆë¡œ ë¡œë“œ (ë””ë²„ê¹…ìš©)
            // TODO: ë‚˜ì¤‘ì— ë‹¤ì‹œ ìºì‹± í™œì„±í™”
            // if (this.cachedGeoJsonData['korea']) {
            //     geoJsonData = this.cachedGeoJsonData['korea'];
            // } else {
                // í•œêµ­ ë°ì´í„° ë¡œë“œ (ì‹œ ë‹¨ìœ„ ê³µì‹ ê²½ê³„ ë°ì´í„° ì‚¬ìš©)
                const koreaUrl = this.getAssetUrl('data/korea-cities-official.geojson');
                console.log('[loadKoreaData] ìš”ì²­ URL:', koreaUrl);
                const response = await fetch(koreaUrl, { cache: 'no-store' });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('[loadKoreaData] HTTP ì—ëŸ¬:', response.status, response.statusText);
                    console.error('[loadKoreaData] ì‘ë‹µ ë‚´ìš©:', errorText.substring(0, 200));
                    throw new Error(`í•œêµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: HTTP ${response.status} ${response.statusText}`);
                }
                
                geoJsonData = await response.json();
                
                // í•œêµ­ í–‰ì •êµ¬ì—­ë³„ ì‹¤ì œ ì¸êµ¬ ë° ë©´ì  ë°ì´í„°
                const koreaRegionData = {
                    // ì„œìš¸íŠ¹ë³„ì‹œ
                    'ì¢…ë¡œêµ¬': { population: 139272, area: 23.91 },
                    'ì¤‘êµ¬': { population: 123766, area: 9.96 },
                    'ìš©ì‚°êµ¬': { population: 235326, area: 21.87 },
                    'ì„±ë™êµ¬': { population: 286490, area: 16.85 },
                    'ê´‘ì§„êµ¬': { population: 342710, area: 17.06 },
                    'ë™ëŒ€ë¬¸êµ¬': { population: 342715, area: 14.22 },
                    'ì¤‘ë‘êµ¬': { population: 394214, area: 18.50 },
                    'ì„±ë¶êµ¬': { population: 440186, area: 24.57 },
                    'ê°•ë¶êµ¬': { population: 298527, area: 23.60 },
                    'ë„ë´‰êµ¬': { population: 316856, area: 20.71 },
                    'ë…¸ì›êµ¬': { population: 540540, area: 35.44 },
                    'ì€í‰êµ¬': { population: 456023, area: 29.71 },
                    'ì„œëŒ€ë¬¸êµ¬': { population: 312823, area: 17.62 },
                    'ë§ˆí¬êµ¬': { population: 374756, area: 23.86 },
                    'ì–‘ì²œêµ¬': { population: 438640, area: 17.41 },
                    'ê°•ì„œêµ¬': { population: 565785, area: 41.44 },
                    'êµ¬ë¡œêµ¬': { population: 409129, area: 20.12 },
                    'ê¸ˆì²œêµ¬': { population: 238168, area: 13.01 },
                    'ì˜ë“±í¬êµ¬': { population: 385291, area: 24.56 },
                    'ë™ì‘êµ¬': { population: 392823, area: 16.36 },
                    'ê´€ì•…êµ¬': { population: 500005, area: 29.57 },
                    'ì„œì´ˆêµ¬': { population: 405407, area: 47.00 },
                    'ê°•ë‚¨êµ¬': { population: 537294, area: 39.55 },
                    'ì†¡íŒŒêµ¬': { population: 655238, area: 33.89 },
                    'ê°•ë™êµ¬': { population: 453970, area: 24.59 },
                    // ë¶€ì‚°ê´‘ì—­ì‹œ
                    'ë¶€ì‚° ì¤‘êµ¬': { population: 38423, area: 2.84 },
                    'ë¶€ì‚° ì„œêµ¬': { population: 98703, area: 14.15 },
                    'ë¶€ì‚° ë™êµ¬': { population: 82653, area: 9.77 },
                    'ì˜ë„êµ¬': { population: 114202, area: 14.15 },
                    'ë¶€ì‚°ì§„êµ¬': { population: 343091, area: 29.70 },
                    'ë™ë˜êµ¬': { population: 259604, area: 16.63 },
                    'ë¶€ì‚° ë‚¨êµ¬': { population: 270264, area: 26.81 },
                    'ë¶€ì‚° ë¶êµ¬': { population: 301908, area: 39.37 },
                    'í•´ìš´ëŒ€êµ¬': { population: 397996, area: 51.41 },
                    'ì‚¬í•˜êµ¬': { population: 309070, area: 40.64 },
                    'ê¸ˆì •êµ¬': { population: 227568, area: 65.19 },
                    'ë¶€ì‚° ê°•ì„œêµ¬': { population: 169059, area: 181.58 },
                    'ì—°ì œêµ¬': { population: 214771, area: 12.38 },
                    'ìˆ˜ì˜êµ¬': { population: 171423, area: 10.16 },
                    'ì‚¬ìƒêµ¬': { population: 213193, area: 35.56 },
                    'ê¸°ì¥êµ°': { population: 169799, area: 218.02 },
                    // ëŒ€êµ¬ê´‘ì—­ì‹œ
                    'ëŒ€êµ¬ ì¤‘êµ¬': { population: 69595, area: 7.06 },
                    'ëŒ€êµ¬ ë™êµ¬': { population: 345558, area: 182.35 },
                    'ëŒ€êµ¬ ì„œêµ¬': { population: 169819, area: 17.32 },
                    'ëŒ€êµ¬ ë‚¨êµ¬': { population: 131412, area: 17.43 },
                    'ëŒ€êµ¬ ë¶êµ¬': { population: 432714, area: 93.99 },
                    'ìˆ˜ì„±êµ¬': { population: 418466, area: 76.54 },
                    'ë‹¬ì„œêµ¬': { population: 567112, area: 62.35 },
                    'ë‹¬ì„±êµ°': { population: 278185, area: 426.16 },
                    // ì¸ì²œê´‘ì—­ì‹œ
                    'ì¸ì²œ ì¤‘êµ¬': { population: 139047, area: 128.17 },
                    'ì¸ì²œ ë™êµ¬': { population: 63152, area: 7.19 },
                    'ë¯¸ì¶”í™€êµ¬': { population: 377101, area: 24.38 },
                    'ì—°ìˆ˜êµ¬': { population: 385676, area: 50.77 },
                    'ë‚¨ë™êµ¬': { population: 534299, area: 57.99 },
                    'ë¶€í‰êµ¬': { population: 532184, area: 32.91 },
                    'ê³„ì–‘êµ¬': { population: 310581, area: 45.61 },
                    'ì¸ì²œ ì„œêµ¬': { population: 642268, area: 122.49 },
                    'ê°•í™”êµ°': { population: 69500, area: 411.35 },
                    'ì˜¹ì§„êµ°': { population: 20800, area: 1141.19 },
                    // ê´‘ì£¼ê´‘ì—­ì‹œ
                    'ê´‘ì£¼ ë™êµ¬': { population: 93284, area: 48.31 },
                    'ê´‘ì£¼ ì„œêµ¬': { population: 208347, area: 47.83 },
                    'ê´‘ì£¼ ë‚¨êµ¬': { population: 213655, area: 61.14 },
                    'ê´‘ì£¼ ë¶êµ¬': { population: 440297, area: 92.56 },
                    'ê´‘ì‚°êµ¬': { population: 434509, area: 222.89 },
                    // ëŒ€ì „ê´‘ì—­ì‹œ
                    'ëŒ€ì „ ë™êµ¬': { population: 189176, area: 136.61 },
                    'ëŒ€ì „ ì¤‘êµ¬': { population: 230245, area: 62.09 },
                    'ëŒ€ì „ ì„œêµ¬': { population: 493225, area: 95.35 },
                    'ìœ ì„±êµ¬': { population: 362377, area: 176.47 },
                    'ëŒ€ë•êµ¬': { population: 166249, area: 68.27 },
                    // ìš¸ì‚°ê´‘ì—­ì‹œ
                    'ìš¸ì‚° ì¤‘êµ¬': { population: 205018, area: 37.18 },
                    'ìš¸ì‚° ë‚¨êµ¬': { population: 341218, area: 72.06 },
                    'ìš¸ì‚° ë™êµ¬': { population: 167280, area: 36.94 },
                    'ìš¸ì‚° ë¶êµ¬': { population: 212050, area: 80.31 },
                    'ìš¸ì£¼êµ°': { population: 236680, area: 733.14 },
                    // ì„¸ì¢…íŠ¹ë³„ìì¹˜ì‹œ
                    'ì„¸ì¢…ì‹œ': { population: 396141, area: 465.23 },
                    // ê²½ê¸°ë„
                    'ìˆ˜ì›ì‹œì¥ì•ˆêµ¬': { population: 281250, area: 36.06 },
                    'ìˆ˜ì›ì‹œê¶Œì„ êµ¬': { population: 351590, area: 47.10 },
                    'ìˆ˜ì›ì‹œíŒ”ë‹¬êµ¬': { population: 174390, area: 22.76 },
                    'ìˆ˜ì›ì‹œì˜í†µêµ¬': { population: 393808, area: 26.65 },
                    'ì„±ë‚¨ì‹œìˆ˜ì •êµ¬': { population: 240471, area: 42.86 },
                    'ì„±ë‚¨ì‹œì¤‘ì›êµ¬': { population: 221787, area: 28.03 },
                    'ì„±ë‚¨ì‹œë¶„ë‹¹êµ¬': { population: 445109, area: 66.73 },
                    'ì˜ì •ë¶€ì‹œ': { population: 446070, area: 81.53 },
                    'ì•ˆì–‘ì‹œë§Œì•ˆêµ¬': { population: 186421, area: 16.58 },
                    'ì•ˆì–‘ì‹œë™ì•ˆêµ¬': { population: 345620, area: 36.43 },
                    'ë¶€ì²œì‹œ': { population: 789655, area: 53.44 },
                    'ê´‘ëª…ì‹œ': { population: 309756, area: 38.45 },
                    'í‰íƒì‹œ': { population: 583626, area: 452.54 },
                    'ë™ë‘ì²œì‹œ': { population: 95413, area: 95.67 },
                    'ì•ˆì‚°ì‹œìƒë¡êµ¬': { population: 365482, area: 57.31 },
                    'ì•ˆì‚°ì‹œë‹¨ì›êµ¬': { population: 358978, area: 57.35 },
                    'ê³ ì–‘ì‹œë•ì–‘êµ¬': { population: 495325, area: 165.53 },
                    'ê³ ì–‘ì‹œì¼ì‚°ë™êµ¬': { population: 288620, area: 58.89 },
                    'ê³ ì–‘ì‹œì¼ì‚°ì„œêµ¬': { population: 302344, area: 58.89 },
                    'ê³¼ì²œì‹œ': { population: 58412, area: 35.87 },
                    'êµ¬ë¦¬ì‹œ': { population: 185187, area: 33.29 },
                    'ë‚¨ì–‘ì£¼ì‹œ': { population: 754213, area: 458.22 },
                    'ì˜¤ì‚°ì‹œ': { population: 242683, area: 42.74 },
                    'ì‹œí¥ì‹œ': { population: 567198, area: 131.82 },
                    'êµ°í¬ì‹œ': { population: 262667, area: 36.39 },
                    'ì˜ì™•ì‹œ': { population: 169839, area: 54.10 },
                    'í•˜ë‚¨ì‹œ': { population: 366455, area: 93.04 },
                    'ìš©ì¸ì‹œì²˜ì¸êµ¬': { population: 304061, area: 591.25 },
                    'ìš©ì¸ì‹œê¸°í¥êµ¬': { population: 528543, area: 84.46 },
                    'ìš©ì¸ì‹œìˆ˜ì§€êµ¬': { population: 390258, area: 42.38 },
                    'íŒŒì£¼ì‹œ': { population: 514337, area: 672.84 },
                    'ì´ì²œì‹œ': { population: 227452, area: 461.30 },
                    'ì•ˆì„±ì‹œ': { population: 182049, area: 554.20 },
                    'ê¹€í¬ì‹œ': { population: 514880, area: 276.60 },
                    'í™”ì„±ì‹œ': { population: 1011366, area: 845.19 },
                    'ê´‘ì£¼ì‹œ': { population: 396487, area: 431.16 },
                    'ì–‘ì£¼ì‹œ': { population: 235743, area: 310.04 },
                    'í¬ì²œì‹œ': { population: 148682, area: 826.89 },
                    'ì—¬ì£¼ì‹œ': { population: 117456, area: 608.02 },
                    'ì—°ì²œêµ°': { population: 44135, area: 675.22 },
                    'ê°€í‰êµ°': { population: 59202, area: 843.77 },
                    'ì–‘í‰êµ°': { population: 118180, area: 877.43 },
                    // ê°•ì›íŠ¹ë³„ìì¹˜ë„
                    'ì¶˜ì²œì‹œ': { population: 285280, area: 1116.44 },
                    'ì›ì£¼ì‹œ': { population: 374640, area: 867.36 },
                    'ê°•ë¦‰ì‹œ': { population: 213587, area: 1040.78 },
                    'ë™í•´ì‹œ': { population: 90622, area: 180.48 },
                    'íƒœë°±ì‹œ': { population: 39021, area: 303.53 },
                    'ì†ì´ˆì‹œ': { population: 81692, area: 105.43 },
                    'ì‚¼ì²™ì‹œ': { population: 63318, area: 1185.86 },
                    'í™ì²œêµ°': { population: 67825, area: 1819.00 },
                    'íš¡ì„±êµ°': { population: 44986, area: 920.94 },
                    'ì˜ì›”êµ°': { population: 35178, area: 1127.36 },
                    'í‰ì°½êµ°': { population: 38964, area: 1464.14 },
                    'ì •ì„ êµ°': { population: 33693, area: 1219.02 },
                    'ì² ì›êµ°': { population: 43204, area: 889.51 },
                    'í™”ì²œêµ°': { population: 23912, area: 909.48 },
                    'ì–‘êµ¬êµ°': { population: 21332, area: 701.19 },
                    'ì¸ì œêµ°': { population: 33055, area: 1646.56 },
                    'ê³ ì„±êµ°': { population: 26442, area: 664.68 },
                    'ì–‘ì–‘êµ°': { population: 27378, area: 630.56 },
                    // ì¶©ì²­ë¶ë„
                    'ì²­ì£¼ì‹œìƒë‹¹êµ¬': { population: 195024, area: 404.49 },
                    'ì²­ì£¼ì‹œì„œì›êµ¬': { population: 256011, area: 122.17 },
                    'ì²­ì£¼ì‹œí¥ë•êµ¬': { population: 310884, area: 209.54 },
                    'ì²­ì£¼ì‹œì²­ì›êµ¬': { population: 203531, area: 214.99 },
                    'ì¶©ì£¼ì‹œ': { population: 211703, area: 983.84 },
                    'ì œì²œì‹œ': { population: 131977, area: 882.47 },
                    'ë³´ì€êµ°': { population: 29187, area: 584.13 },
                    'ì˜¥ì²œêµ°': { population: 48416, area: 537.65 },
                    'ì˜ë™êµ°': { population: 45162, area: 846.15 },
                    'ì§„ì²œêµ°': { population: 93407, area: 406.65 },
                    'ê´´ì‚°êµ°': { population: 35916, area: 849.87 },
                    'ìŒì„±êµ°': { population: 97311, area: 520.84 },
                    'ë‹¨ì–‘êµ°': { population: 28662, area: 781.06 },
                    'ì¦í‰êµ°': { population: 36210, area: 81.84 },
                    // ì¶©ì²­ë‚¨ë„
                    'ì²œì•ˆì‹œë™ë‚¨êµ¬': { population: 332674, area: 636.22 },
                    'ì²œì•ˆì‹œì„œë¶êµ¬': { population: 493320, area: 401.43 },
                    'ê³µì£¼ì‹œ': { population: 113452, area: 864.11 },
                    'ë³´ë ¹ì‹œ': { population: 104293, area: 569.54 },
                    'ì•„ì‚°ì‹œ': { population: 352616, area: 542.25 },
                    'ì„œì‚°ì‹œ': { population: 177293, area: 741.32 },
                    'ë…¼ì‚°ì‹œ': { population: 114668, area: 554.09 },
                    'ê³„ë£¡ì‹œ': { population: 44928, area: 60.74 },
                    'ë‹¹ì§„ì‹œ': { population: 171149, area: 703.68 },
                    'ê¸ˆì‚°êµ°': { population: 50803, area: 573.54 },
                    'ë¶€ì—¬êµ°': { population: 59010, area: 624.57 },
                    'ì„œì²œêµ°': { population: 49001, area: 359.49 },
                    'ì²­ì–‘êµ°': { population: 29689, area: 479.57 },
                    'í™ì„±êµ°': { population: 94210, area: 443.09 },
                    'ì˜ˆì‚°êµ°': { population: 82391, area: 542.46 },
                    'íƒœì•ˆêµ°': { population: 62075, area: 503.48 },
                    // ì „ë¶íŠ¹ë³„ìì¹˜ë„
                    'ì „ì£¼ì‹œì™„ì‚°êµ¬': { population: 335912, area: 105.29 },
                    'ì „ì£¼ì‹œë•ì§„êµ¬': { population: 287848, area: 81.62 },
                    'êµ°ì‚°ì‹œ': { population: 263044, area: 402.20 },
                    'ìµì‚°ì‹œ': { population: 276497, area: 506.36 },
                    'ì •ìì‹œ': { population: 103965, area: 692.74 },
                    'ë‚¨ì›ì‹œ': { population: 78697, area: 752.69 },
                    'ê¹€ì œì‹œ': { population: 83981, area: 545.94 },
                    'ì™„ì£¼êµ°': { population: 95707, area: 821.07 },
                    'ì§„ì•ˆêµ°': { population: 23434, area: 789.38 },
                    'ë¬´ì£¼êµ°': { population: 24612, area: 631.54 },
                    'ì¥ìˆ˜êµ°': { population: 19469, area: 534.31 },
                    'ì„ì‹¤êµ°': { population: 24317, area: 596.93 },
                    'ìˆœì°½êµ°': { population: 26155, area: 495.74 },
                    'ê³ ì°½êµ°': { population: 52804, area: 608.27 },
                    'ë¶€ì•ˆêµ°': { population: 53994, area: 493.27 },
                    // ì „ë¼ë‚¨ë„
                    'ëª©í¬ì‹œ': { population: 217669, area: 50.12 },
                    'ì—¬ìˆ˜ì‹œ': { population: 271487, area: 512.29 },
                    'ìˆœì²œì‹œ': { population: 275334, area: 910.94 },
                    'ë‚˜ì£¼ì‹œ': { population: 118318, area: 608.22 },
                    'ê´‘ì–‘ì‹œ': { population: 149224, area: 463.24 },
                    'ë‹´ì–‘êµ°': { population: 44266, area: 455.81 },
                    'ê³¡ì„±êµ°': { population: 26324, area: 547.41 },
                    'êµ¬ë¡€êµ°': { population: 24152, area: 443.02 },
                    'ê³ í¥êµ°': { population: 59281, area: 777.65 },
                    'ë³´ì„±êµ°': { population: 38693, area: 664.02 },
                    'í™”ìˆœêµ°': { population: 63759, area: 787.14 },
                    'ì¥í¥êµ°': { population: 38304, area: 618.45 },
                    'ê°•ì§„êµ°': { population: 34578, area: 501.81 },
                    'í•´ë‚¨êµ°': { population: 65864, area: 1010.40 },
                    'ì˜ì•”êµ°': { population: 53620, area: 615.71 },
                    'ë¬´ì•ˆêµ°': { population: 90618, area: 449.63 },
                    'í•¨í‰êµ°': { population: 29639, area: 392.90 },
                    'ì˜ê´‘êµ°': { population: 51004, area: 473.29 },
                    'ì¥ì„±êµ°': { population: 43761, area: 518.06 },
                    'ì™„ë„êµ°': { population: 49210, area: 391.84 },
                    'ì§„ë„êµ°': { population: 29750, area: 439.19 },
                    'ì‹ ì•ˆêµ°': { population: 39020, area: 656.83 },
                    // ê²½ìƒë¶ë„
                    'í¬í•­ì‹œë‚¨êµ¬': { population: 243412, area: 507.41 },
                    'í¬í•­ì‹œë¶êµ¬': { population: 257948, area: 734.45 },
                    'ê²½ì£¼ì‹œ': { population: 243687, area: 1324.94 },
                    'ê¹€ì²œì‹œ': { population: 133298, area: 989.55 },
                    'ì•ˆë™ì‹œ': { population: 156797, area: 1519.14 },
                    'êµ¬ë¯¸ì‹œ': { population: 410775, area: 615.43 },
                    'ì˜ì£¼ì‹œ': { population: 102748, area: 1254.73 },
                    'ì˜ì²œì‹œ': { population: 100780, area: 920.55 },
                    'ìƒì£¼ì‹œ': { population: 94809, area: 1254.40 },
                    'ë¬¸ê²½ì‹œ': { population: 69856, area: 911.95 },
                    'ê²½ì‚°ì‹œ': { population: 278411, area: 395.52 },
                    'êµ°ìœ„êµ°': { population: 22412, area: 614.14 },
                    'ì˜ì„±êµ°': { population: 48355, area: 1175.16 },
                    'ì²­ì†¡êµ°': { population: 23905, area: 846.53 },
                    'ì˜ì–‘êµ°': { population: 15273, area: 815.13 },
                    'ì˜ë•êµ°': { population: 36257, area: 641.08 },
                    'ì²­ë„êµ°': { population: 41246, area: 694.83 },
                    'ê³ ë ¹êµ°': { population: 31944, area: 384.10 },
                    'ì„±ì£¼êµ°': { population: 42155, area: 616.63 },
                    'ì¹ ê³¡êµ°': { population: 104315, area: 451.45 },
                    'ì˜ˆì²œêµ°': { population: 52432, area: 661.55 },
                    'ë´‰í™”êµ°': { population: 31667, area: 1201.89 },
                    'ìš¸ì§„êµ°': { population: 49337, area: 989.51 },
                    'ìš¸ë¦‰êµ°': { population: 9208, area: 72.86 },
                    // ê²½ìƒë‚¨ë„
                    'ì°½ì›ì‹œì˜ì°½êµ¬': { population: 271158, area: 125.91 },
                    'ì°½ì›ì‹œì„±ì‚°êµ¬': { population: 243132, area: 70.73 },
                    'ì°½ì›ì‹œë§ˆì‚°í•©í¬êµ¬': { population: 173118, area: 120.02 },
                    'ì°½ì›ì‹œë§ˆì‚°íšŒì›êµ¬': { population: 191905, area: 67.21 },
                    'ì°½ì›ì‹œì§„í•´êµ¬': { population: 187096, area: 120.33 },
                    'ì§„ì£¼ì‹œ': { population: 354745, area: 712.70 },
                    'í†µì˜ì‹œ': { population: 125563, area: 238.89 },
                    'ì‚¬ì²œì‹œ': { population: 108803, area: 398.57 },
                    'ê¹€í•´ì‹œ': { population: 563397, area: 463.25 },
                    'ë°€ì–‘ì‹œ': { population: 97435, area: 799.24 },
                    'ê±°ì œì‹œ': { population: 238054, area: 401.66 },
                    'ì–‘ì‚°ì‹œ': { population: 374605, area: 485.23 },
                    'ì˜ë ¹êµ°': { population: 24360, area: 482.64 },
                    'í•¨ì•ˆêµ°': { population: 59622, area: 415.89 },
                    'ì°½ë…•êµ°': { population: 58029, area: 532.14 },
                    'ê²½ë‚¨ ê³ ì„±êµ°': { population: 49504, area: 517.98 },
                    'ë‚¨í•´êµ°': { population: 42800, area: 357.71 },
                    'í•˜ë™êµ°': { population: 43675, area: 675.34 },
                    'ì‚°ì²­êµ°': { population: 33753, area: 792.06 },
                    'í•¨ì–‘êµ°': { population: 38027, area: 725.05 },
                    'ê±°ì°½êµ°': { population: 61854, area: 803.05 },
                    'í•©ì²œêµ°': { population: 41917, area: 983.34 },
                    // ì œì£¼íŠ¹ë³„ìì¹˜ë„
                    'ì œì£¼ì‹œ': { population: 493621, area: 977.80 },
                    'ì„œê·€í¬ì‹œ': { population: 190311, area: 870.56 },
                    // ë…ë„
                    'ë…ë„': { population: 2, area: 0.18745 }
                };
                
                // ê° ì§€ì—­ì— ê´‘ê³  ì •ë³´ ì¶”ê°€ (ì‹œ ë‹¨ìœ„)
                const idSet = new Set(); // ì¤‘ë³µ ID ë°©ì§€
                
                geoJsonData.features.forEach((feature, index) => {
                    const props = feature.properties;
                    
                    // ì‹œ/êµ¬ ë‹¨ìœ„ ë°ì´í„°ì˜ ì†ì„± êµ¬ì¡°ì— ë§ê²Œ ì¡°ì •
                    // ë‹¤ì–‘í•œ ì†ì„± ì´ë¦„ íŒ¨í„´ í™•ì¸
                    const sigNameKo = props.SIG_KOR_NM || props.sig_name_ko || props.name_ko || props.name;
                    const sigNameEn = props.SIG_ENG_NM || props.sig_name_en || props.name_en || props.name_eng;
                    let ctpNameKo = props.CTP_KOR_NM || props.ctp_name_ko || '';
                    let ctpNameEn = props.CTP_ENG_NM || props.ctp_name_en || '';
                    
                    // ì²« ë²ˆì§¸ ì§€ì—­ì˜ ì†ì„± êµ¬ì¡° ì¶œë ¥ (ë””ë²„ê¹…)
                    if (index === 0) {
                        console.log('ì²« ë²ˆì§¸ ì§€ì—­ ì†ì„± êµ¬ì¡°:', Object.keys(props));
                        console.log('ì²« ë²ˆì§¸ ì§€ì—­ ì†ì„± ê°’:', {
                            CTP_KOR_NM: props.CTP_KOR_NM,
                            SIG_KOR_NM: props.SIG_KOR_NM,
                            name: props.name,
                            name_ko: props.name_ko,
                            sigNameKo,
                            ctpNameKo
                        });
                    }
                    
                    // ì‹œ/êµ¬ ì´ë¦„ ì¡°í•© ë° í‘œì‹œ ì´ë¦„ ìƒì„±
                    let cityNameKo, cityNameEn;
                    
                    // êµ¬ ì´ë¦„ë§Œ ìˆëŠ” ê²½ìš° - codeë‚˜ name_engì—ì„œ ì‹œ ì´ë¦„ ì¶”ì¶œ (ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œë§Œ)
                    let isMetropolitan = false; // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì—¬ë¶€
                    
                    if (!ctpNameKo && sigNameKo && props.code) {
                        // í–‰ì •êµ¬ì—­ ì½”ë“œë¡œ ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì¶”ì¶œ
                        const codePrefix = props.code.substring(0, 2);
                        // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì½”ë“œë§Œ (ì„œìš¸: 11, ë¶€ì‚°: 21, ëŒ€êµ¬: 22, ì¸ì²œ: 23, ê´‘ì£¼: 24, ëŒ€ì „: 25, ìš¸ì‚°: 26)
                        const metropolitanCityMap = {
                            '11': 'ì„œìš¸', '21': 'ë¶€ì‚°', '22': 'ëŒ€êµ¬', '23': 'ì¸ì²œ',
                            '24': 'ê´‘ì£¼', '25': 'ëŒ€ì „', '26': 'ìš¸ì‚°'
                        };
                        
                        if (metropolitanCityMap[codePrefix]) {
                            ctpNameKo = metropolitanCityMap[codePrefix];
                            isMetropolitan = true;
                        }
                    }
                    
                    // name_engì—ì„œë„ ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œ ì´ë¦„ ì¶”ì¶œ ì‹œë„
                    if (!ctpNameKo && props.name_eng) {
                        const nameEngParts = props.name_eng.split('-');
                        if (nameEngParts.length > 0) {
                            const cityEng = nameEngParts[0].toLowerCase();
                            const metropolitanCityMapEng = {
                                'seoul': 'ì„œìš¸', 'busan': 'ë¶€ì‚°', 'daegu': 'ëŒ€êµ¬', 'incheon': 'ì¸ì²œ',
                                'gwangju': 'ê´‘ì£¼', 'daejeon': 'ëŒ€ì „', 'ulsan': 'ìš¸ì‚°'
                            };
                            if (metropolitanCityMapEng[cityEng]) {
                                ctpNameKo = metropolitanCityMapEng[cityEng];
                                isMetropolitan = true;
                            }
                        }
                    }
                    
                    // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œì¸ ê²½ìš°ë§Œ ì‹œ ì´ë¦„ í¬í•¨
                    if (isMetropolitan && ctpNameKo && sigNameKo && sigNameKo !== ctpNameKo && !sigNameKo.includes(ctpNameKo)) {
                        // ê´‘ì—­ì‹œ/íŠ¹ë³„ì‹œì™€ êµ¬ê°€ ë¶„ë¦¬ëœ ê²½ìš° - í‘œì‹œ ì´ë¦„ì— ì‹œ ì´ë¦„ í¬í•¨
                        cityNameKo = `${ctpNameKo} ${sigNameKo}`;
                        cityNameEn = ctpNameEn && sigNameEn ? `${ctpNameEn} ${sigNameEn}` : 
                                   (sigNameEn || props.name || cityNameKo);
                    } else if (sigNameKo && sigNameKo.endsWith('êµ¬')) {
                        // êµ¬ ë‹¨ìœ„ì¸ë° ì‹œ ì´ë¦„ì´ ì—†ëŠ” ê²½ìš° - nameì—ì„œ ì¶”ì¶œ ì‹œë„
                        // ì˜ˆ: props.name = "ë¶€ì‚°ê´‘ì—­ì‹œ ì‚¬ìƒêµ¬"
                        const nameText = props.name || props.name_ko || '';
                        if (nameText.includes('ê´‘ì—­ì‹œ') || nameText.includes('íŠ¹ë³„ì‹œ')) {
                            const nameParts = nameText.split(/\s+/);
                            const ctpPart = nameParts.find(p => p.includes('ê´‘ì—­ì‹œ') || p.includes('íŠ¹ë³„ì‹œ'));
                            if (ctpPart) {
                                const ctpShort = ctpPart.replace(/ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ/g, '').trim();
                                cityNameKo = `${ctpShort} ${sigNameKo}`;
                            } else {
                                cityNameKo = sigNameKo;
                            }
                        } else {
                            cityNameKo = sigNameKo;
                        }
                        cityNameEn = sigNameEn || props.name_eng || cityNameKo;
                    } else {
                        // ì‹œ/ë„ ë‹¨ìœ„ë§Œ ìˆëŠ” ê²½ìš°
                        cityNameKo = sigNameKo || props.name || `City_${index}`;
                        cityNameEn = sigNameEn || props.name_eng || props.name || cityNameKo;
                    }
                    
                    // ê³ ìœ  ID ìƒì„±: ì‹œ_êµ¬ í˜•íƒœë¡œ ì¡°í•© (ì¤‘ë³µ ë°©ì§€)
                    let finalCityId;
                    if (ctpNameKo && sigNameKo && sigNameKo !== ctpNameKo) {
                        // ì‹œì™€ êµ¬ê°€ ë¶„ë¦¬ëœ ê²½ìš° (ì˜ˆ: ë¶€ì‚°ê´‘ì—­ì‹œ_ë‚¨êµ¬)
                        const fullName = `${ctpNameKo}_${sigNameKo}`;
                        finalCityId = fullName.toLowerCase()
                            .replace(/[^\wê°€-í£]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                    } else {
                        // ì‹œ/ë„ ë‹¨ìœ„ë§Œ ìˆëŠ” ê²½ìš°
                        const idSource = ctpNameKo || sigNameKo || props.name || `City_${index}`;
                        finalCityId = idSource.toLowerCase()
                            .replace(/[^\wê°€-í£]/g, '_')
                            .replace(/__+/g, '_')
                            .replace(/^_|_$/g, '');
                    }
                    
                    // ì¤‘ë³µ ë°©ì§€: ê°™ì€ IDê°€ ìˆìœ¼ë©´ ì¸ë±ìŠ¤ ì¶”ê°€
                    let uniqueId = finalCityId;
                    let counter = 1;
                    while (idSet.has(uniqueId)) {
                        uniqueId = `${finalCityId}_${counter}`;
                        counter++;
                    }
                    idSet.add(uniqueId);
                    finalCityId = uniqueId;
                    
                    // ìµœì¢… IDê°€ ì—†ìœ¼ë©´ ì¸ë±ìŠ¤ ì‚¬ìš©
                    if (!finalCityId) {
                        finalCityId = `korea_region_${index}`;
                    }
                    
                    // ì§€ì—­ ë°ì´í„° ë§¤ì¹­ (ì—¬ëŸ¬ ì´ë¦„ íŒ¨í„´ ì‹œë„)
                    let regionData = null;
                    const searchKeys = [
                        cityNameKo, // ìµœì¢… í‘œì‹œ ì´ë¦„
                        sigNameKo, // ì‹œ/êµ°/êµ¬ ì´ë¦„
                        props.name, // ì›ë³¸ name
                        props.SIG_KOR_NM, // SIG_KOR_NM
                        `${ctpNameKo} ${sigNameKo}`, // ì‹œë„ + ì‹œêµ°êµ¬ ì¡°í•©
                        `${sigNameKo}êµ¬`, // êµ¬ ì´ë¦„ (êµ¬ ì œê±°)
                        `${sigNameKo}ì‹œ`, // ì‹œ ì´ë¦„ (ì‹œ ì œê±°)
                        `${sigNameKo}êµ°` // êµ° ì´ë¦„ (êµ° ì œê±°)
                    ];
                    
                    for (const key of searchKeys) {
                        if (key && koreaRegionData[key]) {
                            regionData = koreaRegionData[key];
                            break;
                        }
                    }
                    
                    // ë§¤ì¹­ë˜ì§€ ì•Šìœ¼ë©´ ê¸°ë³¸ê°’ ì‚¬ìš©
                    const population = regionData ? regionData.population : (props.population || Math.floor(Math.random() * 500000) + 50000);
                    const area = regionData ? regionData.area : (props.area || Math.floor(Math.random() * 1000) + 100);
                    
                    feature.properties = {
                        ...props,
                        id: finalCityId,
                        name: cityNameKo,
                        name_en: cityNameEn,
                        name_ko: cityNameKo,
                        sig_name_ko: sigNameKo,
                        sig_name_en: sigNameEn,
                        ctp_name_ko: ctpNameKo,
                        ctp_name_en: ctpNameEn,
                        country: 'South Korea',
                        country_code: 'KR',
                        admin_level: (sigNameKo && ctpNameKo && sigNameKo !== ctpNameKo) ? 'District' : 'City',
                        population: population,
                        area: area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 500000) + 100000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#4ecdc4',
                        border_color: '#ffffff',
                        border_width: 1
                    };
                    
                    // ë””ë²„ê¹…: êµ¬ê°€ ìˆëŠ” ì§€ì—­ ëª¨ë‘ ì¶œë ¥
                    if (sigNameKo && ctpNameKo && sigNameKo !== ctpNameKo) {
                        console.log(`[${index}] êµ¬ ì´ë¦„ ì²˜ë¦¬:`, {
                            ì›ë³¸_ctp: props.CTP_KOR_NM,
                            ì›ë³¸_sig: props.SIG_KOR_NM,
                            ctpNameKo,
                            sigNameKo,
                            í‘œì‹œì´ë¦„: cityNameKo,
                            finalId: finalCityId
                        });
                    }
                    
                    // regionDataì— ì €ì¥ (ê¸°ì¡´ ì¤‘ë³µ ë®ì–´ì“°ê¸°)
                    this.regionData.set(finalCityId, feature.properties);
                });
                
                // ë…ë„ ë³„ë„ ì¶”ê°€ (ìš¸ë¦‰êµ°ê³¼ ë¶„ë¦¬)
                const dokdoData = koreaRegionData['ë…ë„'] || { population: 2, area: 0.18745 };
                const dokdoFeature = {
                    type: 'Feature',
                    properties: {
                        id: 'dokdo',
                        name: 'ë…ë„',
                        name_en: 'Dokdo',
                        name_ko: 'ë…ë„',
                        sig_name_ko: 'ë…ë„',
                        sig_name_en: 'Dokdo',
                        ctp_name_ko: '',
                        ctp_name_en: '',
                        country: 'South Korea',
                        country_code: 'KR',
                        admin_level: 'Island',
                        population: dokdoData.population,
                        area: dokdoData.area,
                        ad_status: 'available',
                        ad_price: Math.floor(Math.random() * 500000) + 100000,
                        revenue: 0,
                        company: null,
                        logo: null,
                        color: '#4ecdc4',
                        border_color: '#ffffff',
                        border_width: 1
                    },
                    geometry: {
                        type: 'Polygon',
                        // ë…ë„ ìœ„ì¹˜: ê²½ë„ 131.87, ìœ„ë„ 37.24
                        // ì‘ì€ ì„¬ì´ë¯€ë¡œ ì‘ì€ í´ë¦¬ê³¤ìœ¼ë¡œ í‘œí˜„
                        coordinates: [[
                            [131.86, 37.239],
                            [131.88, 37.239],
                            [131.88, 37.241],
                            [131.86, 37.241],
                            [131.86, 37.239]
                        ]]
                    }
                };
                
                // ë…ë„ feature ì¶”ê°€
                geoJsonData.features.push(dokdoFeature);
                this.regionData.set('dokdo', dokdoFeature.properties);
                
                console.log('í•œêµ­ ë°ì´í„° ì²˜ë¦¬ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­, ê³ ìœ  ID:', idSet.size);
                console.log('ì²˜ë¦¬ëœ ì§€ì—­ ìƒ˜í”Œ:', geoJsonData.features.slice(0, 5).map(f => ({
                    id: f.properties.id,
                    name: f.properties.name_ko || f.properties.name,
                    sig: f.properties.sig_name_ko,
                    ctp: f.properties.ctp_name_ko
                })));
                console.log('ë…ë„ê°€ ë³„ë„ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
                // ìºì‹œì— ì €ì¥
                this.cachedGeoJsonData['korea'] = geoJsonData;
            // }
        
        // ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ ë˜ëŠ” ìƒì„±
        if (this.map.getSource('world-regions')) {
            // ê¸°ì¡´ ì†ŒìŠ¤ê°€ ìˆìœ¼ë©´ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸ (ë” ë¹ ë¦„)
            this.map.getSource('world-regions').setData(geoJsonData);
        } else {
            // ì†ŒìŠ¤ê°€ ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            this.map.addSource('world-regions', {
                type: 'geojson',
                data: geoJsonData
            });
        }
        
        // ë ˆì´ì–´ê°€ ì—†ìœ¼ë©´ ì¶”ê°€
        if (!this.map.getLayer('regions-fill')) {
            this.map.addLayer({
                id: 'regions-fill',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': [
                        'case',
                        ['==', ['get', 'ad_status'], 'occupied'],
                        '#ff6b6b',
                        '#4ecdc4'
                    ],
                    'fill-opacity': 0.6
                }
            });
            
            this.map.addLayer({
                id: 'regions-border',
                type: 'line',
                source: 'world-regions',
                paint: {
                    'line-color': '#ffffff',
                    'line-width': 1,
                    'line-opacity': 0.8
                }
            });
            
            this.map.addLayer({
                id: 'regions-hover',
                type: 'fill',
                source: 'world-regions',
                paint: {
                    'fill-color': '#feca57',
                    'fill-opacity': 0
                }
            });
            
            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•œ ë²ˆë§Œ ì¶”ê°€
            if (!this.eventListenersAdded) {
                this.setupEventListeners();
                this.eventListenersAdded = true;
            }
        }
        
        console.log('í•œêµ­ ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', geoJsonData.features.length, 'ê°œ ì§€ì—­');
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        this.updateStatistics();
        
        } catch (error) {
            console.error('í•œêµ­ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            this.showNotification('í•œêµ­ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    generateSampleRegions() {
        // ìƒ˜í”Œ í–‰ì •êµ¬ì—­ ë°ì´í„° ìƒì„±
        const regions = [
            // í•œêµ­
            {
                type: 'Feature',
                properties: {
                    id: 'seoul',
                    name_ko: 'ì„œìš¸íŠ¹ë³„ì‹œ',
                    name_en: 'Seoul',
                    country: 'South Korea',
                    admin_level: 'Metropolitan City',
                    population: 9720846,
                    area: 605.21,
                    occupied: false,
                    price: 50000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[126.8, 37.4], [127.2, 37.4], [127.2, 37.7], [126.8, 37.7], [126.8, 37.4]]]
                }
            },
            {
                type: 'Feature',
                properties: {
                    id: 'busan',
                    name_ko: 'ë¶€ì‚°ê´‘ì—­ì‹œ',
                    name_en: 'Busan',
                    country: 'South Korea',
                    admin_level: 'Metropolitan City',
                    population: 3448737,
                    area: 770.18,
                    occupied: false,
                    price: 30000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[128.8, 35.0], [129.2, 35.0], [129.2, 35.3], [128.8, 35.3], [128.8, 35.0]]]
                }
            },
            // ë¯¸êµ­
            {
                type: 'Feature',
                properties: {
                    id: 'california',
                    name_ko: 'ìº˜ë¦¬í¬ë‹ˆì•„ì£¼',
                    name_en: 'California',
                    country: 'United States',
                    admin_level: 'State',
                    population: 39538223,
                    area: 423967,
                    occupied: false,
                    price: 200000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[-124.5, 32.5], [-114.0, 32.5], [-114.0, 42.0], [-124.5, 42.0], [-124.5, 32.5]]]
                }
            },
            {
                type: 'Feature',
                properties: {
                    id: 'newyork',
                    name_ko: 'ë‰´ìš•ì£¼',
                    name_en: 'New York',
                    country: 'United States',
                    admin_level: 'State',
                    population: 20201249,
                    area: 141297,
                    occupied: false,
                    price: 150000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[-79.8, 40.5], [-71.9, 40.5], [-71.9, 45.0], [-79.8, 45.0], [-79.8, 40.5]]]
                }
            },
            // ì¤‘êµ­
            {
                type: 'Feature',
                properties: {
                    id: 'guangdong',
                    name_ko: 'ê´‘ë‘¥ì„±',
                    name_en: 'Guangdong',
                    country: 'China',
                    admin_level: 'Province',
                    population: 126012510,
                    area: 179800,
                    occupied: false,
                    price: 100000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[109.7, 20.2], [117.2, 20.2], [117.2, 25.5], [109.7, 25.5], [109.7, 20.2]]]
                }
            },
            // ì¼ë³¸
            {
                type: 'Feature',
                properties: {
                    id: 'tokyo',
                    name_ko: 'ë„ì¿„ë„',
                    name_en: 'Tokyo',
                    country: 'Japan',
                    admin_level: 'Prefecture',
                    population: 13929286,
                    area: 2194,
                    occupied: false,
                    price: 80000
                },
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[138.7, 35.5], [139.9, 35.5], [139.9, 35.9], [138.7, 35.9], [138.7, 35.5]]]
                }
            }
        ];
        
        return regions;
    }
    
    setupEventListeners() {
        // mapì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„
        if (!this.map) {
            console.warn('[BillionaireMap] setupEventListeners: mapì´ ì•„ì§ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•©ë‹ˆë‹¤.');
            return;
        }
        
        // ì§€ì—­ í´ë¦­ ì´ë²¤íŠ¸
        this.map.on('click', 'regions-fill', (e) => {
            e.preventDefault();
            const feature = e.features[0];
            this.selectRegion(feature);
        });
        
        // í˜¸ë²„ íš¨ê³¼ - mousemove ê¸°ë°˜ìœ¼ë¡œ ë³€ê²½ (í–‰ì •êµ¬ì—­ê°„ ì´ë™ ì‹¤ì‹œê°„ ê°ì§€)
        let lastHoverRegionId = null;
        let hoverTimeout = null;
        
        // í–‰ì •êµ¬ì—­ ìœ„ì—ì„œ ë§ˆìš°ìŠ¤ ì´ë™ ì‹œ
        this.map.on('mousemove', 'regions-fill', (e) => {
            if (hoverTimeout) {
                clearTimeout(hoverTimeout);
                hoverTimeout = null;
            }
            
            if (!e.features || e.features.length === 0) {
                return;
            }
            
            const feature = e.features[0];
            const properties = feature.properties;
            const regionId = properties.id;
            
            // ê°™ì€ ì§€ì—­ì´ë©´ íˆ´íŒë§Œ ì—…ë°ì´íŠ¸
            if (lastHoverRegionId === regionId) {
                this.showTooltip(e.point, properties);
                return;
            }
            
            // ë‹¤ë¥¸ ì§€ì—­ìœ¼ë¡œ ì´ë™
            if (lastHoverRegionId && lastHoverRegionId !== regionId) {
                this.clearHoverEffectImmediate();
            }
            
            // ìƒˆ ì§€ì—­ì— hover íš¨ê³¼ ì ìš©
            lastHoverRegionId = regionId;
            this.currentHoverRegionId = regionId;
            this.applyHoverEffect(regionId);
            
            // ì»¤ì„œ ë° íˆ´íŒ
            this.map.getCanvas().style.cursor = 'pointer';
            this.showTooltip(e.point, properties);
        });
        
        // í–‰ì •êµ¬ì—­ì—ì„œ ë²—ì–´ë‚  ë•Œ (debounce ì²˜ë¦¬)
        this.map.on('mouseleave', 'regions-fill', () => {
            // ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ì–´ ê²½ê³„ì„ ì„ ë„˜ì–´ê°ˆ ë•Œ flickering ë°©ì§€
            hoverTimeout = setTimeout(() => {
                this.handleRegionHoverExit();
                lastHoverRegionId = null;
            }, 10);
        });
        
        // ì§€ë„ í´ë¦­ ì‹œ ì„ íƒ í•´ì œ
        this.map.on('click', (e) => {
            if (!e.features || e.features.length === 0) {
                this.hideInfoPanel();
            }
        });
        
        // ì¤Œ ì»¨íŠ¸ë¡¤ ì´ë²¤íŠ¸
        document.getElementById('zoom-world').addEventListener('click', () => {
            this.zoomToLevel('world');
        });
        
        document.getElementById('zoom-country').addEventListener('click', () => {
            this.zoomToLevel('country');
        });
        
        document.getElementById('zoom-region').addEventListener('click', () => {
            this.zoomToLevel('region');
        });
        
        // íŒ¨ë„ ë‹«ê¸°
        document.getElementById('close-panel').addEventListener('click', () => {
            this.hideInfoPanel();
        });
        
        // êµ¬ë§¤ ë²„íŠ¼ (ì •ë³´ íŒ¨ë„)
        document.getElementById('purchase-btn').addEventListener('click', () => {
            if (!this.currentRegion) {
                this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            // ë¡œê·¸ì¸ ì²´í¬
            if (!this.currentUser) {
                this.showNotification('êµ¬ë§¤í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                this.showUserLoginModal();
                return;
            }
            this.renderPayPalButtons('paypal-buttons', this.currentRegion);
            const container = document.getElementById('paypal-buttons');
            if (container) container.scrollIntoView({ behavior: 'smooth', block: 'center' });
        });
        
        const auctionBidBtn = document.getElementById('auction-bid-btn');
        if (auctionBidBtn) {
            auctionBidBtn.addEventListener('click', () => this.handleAuctionBid('panel'));
        }
        const auctionBidInput = document.getElementById('auction-bid-input');
        if (auctionBidInput) {
            auctionBidInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    this.handleAuctionBid('panel');
                }
            });
        }
        const auctionBuyNowBtn = document.getElementById('auction-buy-now-btn');
        if (auctionBuyNowBtn) {
            auctionBuyNowBtn.addEventListener('click', () => this.handleAuctionBuyNow('panel'));
        }
        
        // ë„ì›€ë§ ë²„íŠ¼
        document.getElementById('help-btn').addEventListener('click', () => {
            this.showHelp();
        });
        
        
        // ë©”ë‰´ ë‹«ê¸°
        document.getElementById('close-menu').addEventListener('click', () => {
            this.hideMenu();
        });
        
        // í–„ë²„ê±° ë©”ë‰´ ë²„íŠ¼
        const hamburgerMenuBtn = document.getElementById('hamburger-menu-btn');
        if (hamburgerMenuBtn) {
            hamburgerMenuBtn.addEventListener('click', () => {
                this.toggleSideMenu();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë‹«ê¸°
        const closeSideMenu = document.getElementById('close-side-menu');
        if (closeSideMenu) {
            closeSideMenu.addEventListener('click', () => {
                this.hideSideMenu();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸° (ì˜¤ë²„ë ˆì´)
        document.addEventListener('click', (e) => {
            const sideMenu = document.getElementById('side-menu');
            const hamburgerBtn = document.getElementById('hamburger-menu-btn');
            if (sideMenu && !sideMenu.classList.contains('hidden')) {
                // ì‚¬ì´ë“œ ë©”ë‰´ë‚˜ í–„ë²„ê±° ë²„íŠ¼ì´ ì•„ë‹Œ ê³³ì„ í´ë¦­í–ˆì„ ë•Œë§Œ ë‹«ê¸°
                if (!sideMenu.contains(e.target) && !hamburgerBtn.contains(e.target)) {
                    this.hideSideMenu();
                }
            }
        });
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ì‚¬ìš©ì ë¡œê·¸ì¸ ë²„íŠ¼
        const sideUserLoginBtn = document.getElementById('side-user-login-btn');
        if (sideUserLoginBtn) {
            sideUserLoginBtn.addEventListener('click', () => {
                this.showUserLoginModal();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const sideUserLogoutBtn = document.getElementById('side-user-logout-btn');
        if (sideUserLogoutBtn) {
            sideUserLogoutBtn.addEventListener('click', () => {
                this.logoutUser();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼
        const sideAdminLoginBtn = document.getElementById('side-admin-login-btn');
        if (sideAdminLoginBtn) {
            sideAdminLoginBtn.addEventListener('click', () => {
                this.showAdminLoginModal();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const sideAdminLogoutBtn = document.getElementById('side-admin-logout-btn');
        if (sideAdminLogoutBtn) {
            sideAdminLogoutBtn.addEventListener('click', () => {
                this.handleAdminLogout();
            });
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë„ì›€ë§ ë²„íŠ¼
        const sideHelpBtn = document.getElementById('side-help-btn');
        if (sideHelpBtn) {
            sideHelpBtn.addEventListener('click', () => {
                this.showHelp();
            });
        }
        
        // ì‹œì¦Œ ëŒ€ì‹œë³´ë“œ ë²„íŠ¼
        const sideSeasonDashboardBtn = document.getElementById('side-season-dashboard-btn');
        if (sideSeasonDashboardBtn) {
            sideSeasonDashboardBtn.addEventListener('click', () => {
                this.showSeasonDashboard();
            });
        }
        
        // ëŒ€í‘œ í”½ì…€ í•˜ì´ë¼ì´íŠ¸ ë²„íŠ¼
        const sidePixelHighlightsBtn = document.getElementById('side-pixel-highlights-btn');
        if (sidePixelHighlightsBtn) {
            sidePixelHighlightsBtn.addEventListener('click', () => {
                this.showPixelHighlights();
            });
        }
        
        // ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ë²„íŠ¼
        const sideSeasonArchiveBtn = document.getElementById('side-season-archive-btn');
        if (sideSeasonArchiveBtn) {
            sideSeasonArchiveBtn.addEventListener('click', () => {
                this.showSeasonArchive();
            });
        }
        
        // ì°¸ì—¬ ì•ˆë‚´ ë²„íŠ¼
        const sideParticipationGuideBtn = document.getElementById('side-participation-guide-btn');
        if (sideParticipationGuideBtn) {
            sideParticipationGuideBtn.addEventListener('click', () => {
                this.showParticipationGuide();
            });
        }
        
        // íˆ¬ëª…í™” ëŒ€ì‹œë³´ë“œ ë²„íŠ¼
        const sideTransparencyBtn = document.getElementById('side-transparency-btn');
        if (sideTransparencyBtn) {
            sideTransparencyBtn.addEventListener('click', () => {
                this.showTransparencyDashboard();
            });
        }
        
        // ì»¤ë®¤ë‹ˆí‹° ë¯¸ì…˜ ë²„íŠ¼ (ì‚¬ì´ë“œ ë©”ë‰´ì— ì¶”ê°€ í•„ìš”)
        const sideMissionsBtn = document.getElementById('side-missions-btn');
        if (sideMissionsBtn) {
            sideMissionsBtn.addEventListener('click', () => {
                this.showCommunityMissions();
            });
        }
        
        // í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ ë²„íŠ¼
        const joinChallengeBtn = document.getElementById('join-challenge-btn');
        if (joinChallengeBtn) {
            joinChallengeBtn.addEventListener('click', () => {
                this.joinFlashChallenge();
            });
        }
        
        // í”Œë˜ì‹œ ì±Œë¦°ì§€ íŒ¨ë„ ë‹«ê¸°
        const closeFlashChallengeBtn = document.getElementById('close-flash-challenge');
        if (closeFlashChallengeBtn) {
            closeFlashChallengeBtn.addEventListener('click', () => {
                const panel = document.getElementById('flash-challenge-panel');
                if (panel) panel.classList.add('hidden');
            });
        }
        
        // ëŒ€í‘œ í”½ì…€ í•˜ì´ë¼ì´íŠ¸ ëª¨ë‹¬ ë‹«ê¸°
        const closePixelHighlightsBtn = document.getElementById('close-pixel-highlights');
        if (closePixelHighlightsBtn) {
            closePixelHighlightsBtn.addEventListener('click', () => {
                const modal = document.getElementById('pixel-highlights-modal');
                if (modal) modal.classList.add('hidden');
            });
        }
        
        // ì°¸ì—¬ ì•ˆë‚´ ëª¨ë‹¬ ë‹«ê¸°
        const closeParticipationGuideBtn = document.getElementById('close-participation-guide');
        if (closeParticipationGuideBtn) {
            closeParticipationGuideBtn.addEventListener('click', () => {
                const modal = document.getElementById('participation-guide-modal');
                if (modal) modal.classList.add('hidden');
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì¸ ë²„íŠ¼
        const userLoginBtn = document.getElementById('user-login-btn');
        if (userLoginBtn) {
            userLoginBtn.addEventListener('click', () => {
                this.showUserLoginModal();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼
        const userLogoutBtn = document.getElementById('user-logout-btn');
        if (userLogoutBtn) {
            userLogoutBtn.addEventListener('click', () => {
                this.logoutUser();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
        const closeUserLogin = document.getElementById('close-user-login');
        if (closeUserLogin) {
            closeUserLogin.addEventListener('click', () => {
                this.hideUserLoginModal();
            });
        }
        
        // ì‚¬ìš©ì ë¡œê·¸ì¸ ì œì¶œ
        const userLoginSubmit = document.getElementById('user-login-submit');
        if (userLoginSubmit) {
            userLoginSubmit.addEventListener('click', () => {
                const email = document.getElementById('user-email-input').value;
                const password = document.getElementById('user-password-input').value;
                this.loginUser(email, password).then(() => {
                    this.hideUserLoginModal();
                });
            });
        }
        
        // êµ¬ê¸€ íšŒì›ê°€ì…/ë¡œê·¸ì¸ ë²„íŠ¼
        const userGoogleSignupBtn = document.getElementById('user-google-signup-btn');
        if (userGoogleSignupBtn) {
            userGoogleSignupBtn.addEventListener('click', () => {
                this.signInWithGoogle();
            });
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ ë²„íŠ¼
        const adminLoginBtn = document.getElementById('admin-login-btn');
        if (adminLoginBtn) {
            adminLoginBtn.addEventListener('click', () => {
                console.log('Admin ë²„íŠ¼ í´ë¦­ë¨');
                this.showAdminLoginModal();
            });
        } else {
            console.error('admin-login-btn ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ ë‹«ê¸°
        document.getElementById('close-admin-login').addEventListener('click', () => {
            this.hideAdminLoginModal();
        });
        
        // ê´€ë¦¬ì ë¡œê·¸ì¸ ì œì¶œ
        document.getElementById('admin-login-submit').addEventListener('click', () => {
            this.handleAdminLogin();
        });
        
        // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        if (adminLogoutBtn) {
            adminLogoutBtn.addEventListener('click', () => {
                this.handleAdminLogout();
            });
        }
        
        // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        const closeCompanyInfo = document.getElementById('close-company-info');
        if (closeCompanyInfo) {
            closeCompanyInfo.addEventListener('click', () => {
                this.hideCompanyInfoModal();
            });
        }
        
        // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        const closeRegionInfo = document.getElementById('close-region-info');
        if (closeRegionInfo) {
            closeRegionInfo.addEventListener('click', () => {
                this.hideRegionInfoModal();
            });
        }
        
        // ì§€ì—­ êµ¬ë§¤ ë²„íŠ¼ (ëª¨ë‹¬)
        const regionPurchaseBtn = document.getElementById('region-purchase-btn');
        if (regionPurchaseBtn) {
            regionPurchaseBtn.addEventListener('click', () => {
                if (!this.currentRegion) {
                    this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                // ë¡œê·¸ì¸ ì²´í¬
                if (!this.currentUser) {
                    this.showNotification('êµ¬ë§¤í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    this.showUserLoginModal();
                    return;
                }
                this.renderPayPalButtons('region-paypal-buttons', this.currentRegion);
                const container = document.getElementById('region-paypal-buttons');
                if (container) container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }
        const regionBuyNowBtn = document.getElementById('region-auction-buy-now-btn');
        if (regionBuyNowBtn) {
            regionBuyNowBtn.addEventListener('click', () => {
                const region = this.regionData.get(this.selectedStateId) || this.currentRegion;
                this.handleAuctionBuyNow('region', region);
            });
        }
        
        // ê¸°ì—… ì •ë³´ ì €ì¥
        const saveCompanyInfo = document.getElementById('save-company-info');
        if (saveCompanyInfo) {
            saveCompanyInfo.addEventListener('click', () => {
                this.saveCompanyInfo();
            });
        }
        
        // ê¸°ì—… ì •ë³´ ë¯¸ë¦¬ë³´ê¸°
        const previewCompanyInfo = document.getElementById('preview-company-info');
        if (previewCompanyInfo) {
            previewCompanyInfo.addEventListener('click', () => {
                this.previewCompanyInfo();
            });
        }
        
        // ì§€ì—­ ì •ë³´ ì €ì¥
        const saveRegionInfo = document.getElementById('save-region-info');
        if (saveRegionInfo) {
            saveRegionInfo.addEventListener('click', () => {
                this.saveRegionInfo();
            });
        }
        
        // ê´€ë¦¬ì íŒ¨ë„ì˜ í”½ì…€ ì—ë””í„° ì—´ê¸° ë²„íŠ¼
        const adminOpenPixelEditor = document.getElementById('admin-open-pixel-editor');
        if (adminOpenPixelEditor) {
            adminOpenPixelEditor.addEventListener('click', () => {
                if (!this.currentRegion) {
                    this.showNotification('í¸ì§‘í•  ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                this.openPixelEditorModal();
            });
        }

        // ëª¨ë“  ì§€ì—­ Firestore ë™ê¸°í™” ë²„íŠ¼
        const syncAllRegionsBtn = document.getElementById('sync-all-regions-btn');
        if (syncAllRegionsBtn) {
            syncAllRegionsBtn.addEventListener('click', async () => {
                if (!this.isAdminLoggedIn) {
                    this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                const confirmed = confirm('ëª¨ë“  ì§€ì—­ì˜ ê´‘ê³  ê°€ê²©ì„ 1000ë‹¬ëŸ¬ë¡œ í†µì¼í•˜ê³  Firestoreì— ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?');
                if (confirmed) {
                    syncAllRegionsBtn.disabled = true;
                    syncAllRegionsBtn.textContent = 'ë™ê¸°í™” ì¤‘...';
                    try {
                        const result = await this.syncAllRegionsToFirestore();
                        this.showNotification(
                            `ë™ê¸°í™” ì™„ë£Œ: ê°€ê²© ${result.priceUpdated}ê°œ ì—…ë°ì´íŠ¸, Firestore ${result.success}ê°œ ì„±ê³µ, ${result.failed}ê°œ ì‹¤íŒ¨`,
                            result.success > 0 ? 'success' : 'error'
                        );
                    } catch (error) {
                        console.error('ë™ê¸°í™” ì˜¤ë¥˜:', error);
                        this.showNotification('ë™ê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    } finally {
                        syncAllRegionsBtn.disabled = false;
                        syncAllRegionsBtn.textContent = 'ëª¨ë“  ì§€ì—­ Firestore ë™ê¸°í™”';
                    }
                }
            });
        }
        
        // ëª¨ë‹¬ì—ì„œ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        const companyEditBtn = document.getElementById('company-edit-btn');
        if (companyEditBtn) {
            companyEditBtn.addEventListener('click', () => {
                this.openRegionEditFromModal();
            });
        }
        
        // íšŒì‚¬ ëª¨ë‹¬ ë‚´ êµ¬ë§¤ ë²„íŠ¼
        const companyPurchaseBtn = document.getElementById('company-purchase-btn');
        if (companyPurchaseBtn) {
            companyPurchaseBtn.addEventListener('click', () => {
                // ìš°ì„ ìˆœìœ„: ë²„íŠ¼ data-state-id â†’ this.selectedStateId â†’ this.currentRegion?.id
                const btnStateId = companyPurchaseBtn.dataset.stateId;
                const targetStateId = btnStateId || this.selectedStateId || (this.currentRegion && this.currentRegion.id);
                const region = targetStateId ? (this.regionData.get(targetStateId) || this.currentRegion) : this.currentRegion;
                
                if (!region) {
                    this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                if (region.ad_status === 'occupied' || region.occupied) {
                    this.showNotification('ì´ë¯¸ ê´‘ê³ ê°€ ì§„í–‰ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤.', 'info');
                    return;
                }
                // ë¡œê·¸ì¸ ì²´í¬
                if (!this.currentUser) {
                    this.showNotification('êµ¬ë§¤í•˜ë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    this.showUserLoginModal();
                    return;
                }
                this.renderPayPalButtons('company-paypal-buttons', region);
                const container = document.getElementById('company-paypal-buttons');
                if (container) container.scrollIntoView({ behavior: 'smooth', block: 'center' });
            });
        }
        
        const companyAuctionBidBtn = document.getElementById('company-auction-bid-btn');
        if (companyAuctionBidBtn) {
            companyAuctionBidBtn.addEventListener('click', () => this.handleAuctionBid('modal'));
        }
        const companyAuctionBidInput = document.getElementById('company-auction-bid-input');
        if (companyAuctionBidInput) {
            companyAuctionBidInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    this.handleAuctionBid('modal');
                }
            });
        }
        const companyBuyNowBtn = document.getElementById('company-auction-buy-now-btn');
        if (companyBuyNowBtn) {
            companyBuyNowBtn.addEventListener('click', () => this.handleAuctionBuyNow('company'));
        }
        
        const regionEditBtn = document.getElementById('region-edit-btn');
        if (regionEditBtn) {
            regionEditBtn.addEventListener('click', () => {
                this.openRegionEditFromModal();
            });
        }
        
        // ê´€ë¦¬ì íŒ¨ë„ ì´ë²¤íŠ¸ (ìš”ì†Œê°€ ì¡´ì¬í•  ë•Œë§Œ)
        const adminToggle = document.getElementById('admin-toggle');
        if (adminToggle) {
            adminToggle.addEventListener('click', () => {
                this.toggleAdminMode();
            });
        }
        
        const logoEditMode = document.getElementById('logo-edit-mode');
        if (logoEditMode) {
            logoEditMode.addEventListener('click', () => {
                this.toggleLogoEditMode();
            });
        }
        
        const closeAdmin = document.getElementById('close-admin');
        if (closeAdmin) {
            closeAdmin.addEventListener('click', () => {
                this.toggleAdminMode();
            });
        }
        
        const adminExitBtn = document.getElementById('admin-exit-btn');
        if (adminExitBtn) {
            adminExitBtn.addEventListener('click', () => {
                if (!this.isAdminLoggedIn) {
                    this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
                    return;
                }
                this.disableAdminMode();
            });
        }
        
        // ë¡œê³  ê´€ë¦¬ ì´ë²¤íŠ¸
        const uploadLogo = document.getElementById('upload-logo');
        if (uploadLogo) {
            uploadLogo.addEventListener('click', () => {
                this.uploadLogo();
            });
        }
        
        const saveLogo = document.getElementById('save-logo');
        if (saveLogo) {
            saveLogo.addEventListener('click', () => {
                this.saveLogo();
            });
        }
        
        const removeLogo = document.getElementById('remove-logo');
        if (removeLogo) {
            removeLogo.addEventListener('click', () => {
                this.removeLogo();
            });
        }
        
        const resetLogo = document.getElementById('reset-logo');
        if (resetLogo) {
            resetLogo.addEventListener('click', () => {
                this.resetLogo();
            });
        }
        
        // ë¡œê³  ì„¤ì • ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
        const logoSize = document.getElementById('logo-size');
        if (logoSize) {
            logoSize.addEventListener('input', (e) => {
                this.updateLogoPreview();
            });
        }
        
        const logoOpacity = document.getElementById('logo-opacity');
        if (logoOpacity) {
            logoOpacity.addEventListener('input', (e) => {
                this.updateLogoPreview();
            });
        }
        
        const logoRotation = document.getElementById('logo-rotation');
        if (logoRotation) {
            logoRotation.addEventListener('input', (e) => {
                this.updateLogoPreview();
            });
        }
        
        // ìƒ‰ìƒ ì„¤ì • ì´ë²¤íŠ¸ëŠ” setupColorPresetListenersì—ì„œ ì²˜ë¦¬
        
        // ì§€ë„ ì¤Œ ë ˆë²¨ ë³€ê²½ ê°ì§€
        this.map.on('zoom', () => {
            this.updateZoomLevel();
        });
        
        // í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤
        document.addEventListener('keydown', (e) => {
            this.handleKeyboardShortcuts(e);
        });

        this.setupAdminFormValidation();
    }
    
    // êµ­ê°€ ì „í™˜ í•¨ìˆ˜
    switchCountry(countryCode) {
        console.log('êµ­ê°€ ì „í™˜:', countryCode);
        
        const country = this.g20Countries[countryCode];
        if (!country) {
            console.error('ì§€ì›í•˜ì§€ ì•ŠëŠ” êµ­ê°€:', countryCode);
            return;
        }
        
        // ì§€ë„ ì¤‘ì‹¬ê³¼ ì¤Œ ë ˆë²¨ ë³€ê²½
        this.map.flyTo({
            center: country.center,
            zoom: country.zoom,
            duration: 2000,
            essential: true
        });
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œ ì—…ë°ì´íŠ¸
        this.currentMapMode = countryCode;
        
        // ì•Œë¦¼ í‘œì‹œ
        this.showNotification(`${country.flag} ${country.name}ìœ¼ë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
        
        // í•´ë‹¹ êµ­ê°€ì˜ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸í•˜ê³  ë¡œë“œ
        this.loadCountryData(countryCode);
    }
    
    // êµ­ê°€ë³„ ë°ì´í„° ë¡œë“œ í•¨ìˆ˜
    async loadCountryData(countryCode) {
        try {
            // í˜„ì¬ëŠ” ê¸°ë³¸ ë°ì´í„°ë§Œ ë¡œë“œ
            // í–¥í›„ ê° êµ­ê°€ë³„ GeoJSON ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ìˆë„ë¡ í™•ì¥ ê°€ëŠ¥
            console.log(`${countryCode} ë°ì´í„° ë¡œë“œ ì¤‘...`);
            
            // ê¸°ì¡´ ë ˆì´ì–´ ì œê±°
            if (this.map.getLayer('regions-fill')) {
                this.map.removeLayer('regions-fill');
            }
            if (this.map.getSource('world-regions')) {
                this.map.removeSource('world-regions');
            }
            
            // êµ­ê°€ë³„ ë°ì´í„° ë¡œë“œ (í˜„ì¬ëŠ” ê¸°ë³¸ ë°ì´í„° ì‚¬ìš©)
            await this.loadWorldData();
            
        } catch (error) {
            console.error('êµ­ê°€ ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
            this.showNotification('êµ­ê°€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    selectRegion(feature) {
        const regionId = feature.properties.id;
        if (regionId) {
            this.onRegionClick(regionId);
        }
        const properties = feature.properties;
        this.currentRegion = properties;
        this.selectedStateId = properties.id; // ìƒˆë¡œìš´ ë³€ìˆ˜ì— ì €ì¥
        
        console.log('ì§€ì—­ ì„ íƒë¨:', {
            region: properties,
            selectedStateId: this.selectedStateId,
            isAdminLoggedIn: this.isAdminLoggedIn,
            adminMode: this.adminMode,
            currentMapMode: this.currentMapMode
        });
        
        // selectedStateIdê°€ ì œëŒ€ë¡œ ì„¤ì •ë˜ì—ˆëŠ”ì§€ í™•ì¸
        if (!this.selectedStateId) {
            console.error('selectedStateIdê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤!', {
                properties: properties,
                id: properties.id,
                name: properties.name,
                name_ko: properties.name_ko
            });
        }
        
        // ì´ì „ ì„ íƒ í•´ì œ
        this.map.setFilter('regions-hover', ['==', 'id', '']);
        
        // í˜„ì¬ ì§€ì—­ í•˜ì´ë¼ì´íŠ¸
        this.map.setFilter('regions-hover', ['==', 'id', properties.id]);
        this.map.setPaintProperty('regions-hover', 'fill-opacity', 0.3);
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” ê´€ë¦¬ì ê¸°ëŠ¥ë§Œ ì‹¤í–‰
        if (this.isAdminLoggedIn && this.adminMode) {
            console.log('ê´€ë¦¬ì ëª¨ë“œ: ê´€ë¦¬ì íŒ¨ë„ë§Œ í‘œì‹œ (ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ ë¹„í™œì„±í™”)');
            // ê´€ë¦¬ì íŒ¨ë„ì´ ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ì—´ê¸°
            const adminPanel = document.getElementById('admin-panel');
            if (adminPanel && adminPanel.classList.contains('hidden')) {
                this.showAdminPanel();
            }
            this.updateAdminPanelForRegion(properties);
            // ê´€ë¦¬ì ëª¨ë“œì—ì„œëŠ” ê¸°ì—… ì •ë³´ ëª¨ë‹¬ì„ ì ˆëŒ€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            return; // ì—¬ê¸°ì„œ í•¨ìˆ˜ ì¢…ë£Œí•˜ì—¬ ì¼ë°˜ ì‚¬ìš©ì ê¸°ëŠ¥ ì°¨ë‹¨
        }
        
        // ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œì¼ ë•Œë§Œ ê¸°ì—… ì •ë³´ í‘œì‹œ
        console.log('ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ: ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ');
        this.showCompanyInfoModal(properties.id);
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ì„ ì„ íƒëœ ì£¼ì— ë§ê²Œ ì—…ë°ì´íŠ¸
    updateAdminPanelForRegion(region) {
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸:', region);
        
        // ê´€ë¦¬ì íŒ¨ë„ì´ ì—´ë ¤ìˆì§€ ì•Šìœ¼ë©´ ìë™ìœ¼ë¡œ ì—´ê¸°
        const adminPanel = document.getElementById('admin-panel');
        if (adminPanel && adminPanel.classList.contains('hidden')) {
            this.showAdminPanel();
        }
        
        const selectedStateName = document.getElementById('selected-state-name');
        if (selectedStateName) {
            const displayName = this.getRegionDisplayName(region);
            selectedStateName.textContent = displayName;
            console.log('ì„ íƒëœ ì£¼ ì´ë¦„ ì„¤ì •:', displayName);
        } else {
            console.error('selected-state-name ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ì„ íƒëœ ì§€ì—­ ì •ë³´ë¥¼ currentRegionì— ì €ì¥ (ë‹¤ë¥¸ í•¨ìˆ˜ì—ì„œ ì‚¬ìš©)
        this.currentRegion = region;
        
        this.updateLogoPreview();
        this.updateColorPreview();
        this.loadCompanyInfoForEdit(region.id);
        
        // ì§€ì—­ ì •ë³´ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ì íŒ¨ë„ì˜ ì§€ì—­ ì •ë³´ ìˆ˜ì • ì„¹ì…˜)
        this.updateAdminRegionInfoFields(region);
        
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ì˜ ì§€ì—­ ì •ë³´ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
    updateAdminRegionInfoFields(region) {
        // ì§€ì—­ ì •ë³´ ìˆ˜ì • í•„ë“œê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
        const regionNameInput = document.getElementById('region-name-input');
        const regionNameEnInput = document.getElementById('region-name-en-input');
        const regionCountryInput = document.getElementById('region-country-input');
        const regionAdminLevelInput = document.getElementById('region-admin-level-input');
        const regionPopulationInput = document.getElementById('region-population-input');
        const regionAreaInput = document.getElementById('region-area-input');
        const regionAdPriceInput = document.getElementById('region-ad-price-input');
        const regionAdStatusInput = document.getElementById('region-ad-status-input');
        
        if (regionNameInput) {
            regionNameInput.value = region.name_ko || region.name || '';
        }
        if (regionNameEnInput) {
            regionNameEnInput.value = region.name_en || region.name || '';
        }
        if (regionCountryInput) {
            regionCountryInput.value = region.country || '';
        }
        if (regionAdminLevelInput) {
            regionAdminLevelInput.value = region.admin_level || '';
        }
        if (regionPopulationInput) {
            regionPopulationInput.value = region.population || 0;
        }
        if (regionAreaInput) {
            regionAreaInput.value = region.area || 0;
        }
        if (regionAdPriceInput) {
            regionAdPriceInput.value = region.ad_price || this.uniformAdPrice || 1000;
        }
        if (regionAdStatusInput) {
            regionAdStatusInput.value = region.ad_status || 'available';
        }
    }
    
    // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ
    showCompanyInfoModal(stateId) {
        console.log('ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ ì‹œë„:', stateId);
        console.log('í˜„ì¬ ì§€ë„ ëª¨ë“œ:', this.currentMapMode);
        
        if (this.isFirebaseInitialized && this.firestore) {
            this.subscribePixelBundles(stateId);
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const companyData = this.currentMapMode === 'korea' 
            ? this.koreaCompanyData[stateId] 
            : this.currentMapMode === 'japan'
            ? this.japanCompanyData[stateId]
            : this.companyData[stateId];
            
        console.log('í˜„ì¬ companyData:', this.currentMapMode === 'korea' ? this.koreaCompanyData : this.companyData);
        console.log('ì„ íƒëœ stateIdì˜ companyData:', companyData);
        const modal = document.getElementById('company-info-modal');
        if (!modal) {
            console.error('company-info-modal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // ì§€ì—­ëª… ê°€ì ¸ì˜¤ê¸° (êµ­ê°€ë³„ ì–¸ì–´ ìš°ì„ ìˆœìœ„ ì ìš©)
        const regionName = this.getRegionDisplayName(this.currentRegion) || stateId;
        
        console.log('ì§€ì—­ëª…:', regionName, 'currentRegion:', this.currentRegion);
        
        // í•­ìƒ ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (ê¸°ì—… ì •ë³´ê°€ ì—†ì–´ë„ ì§€ì—­ ì •ë³´ í¬í•¨)
        console.log('ê¸°ì—… ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (í†µí•© ëª¨ë‹¬)');
        
        // ëª¨ë‹¬ ì œëª© ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const regionInfoText = this.getLanguageText('Region Information');
        const companyInfoText = this.getLanguageText('Company Information');
        const companyNameElement = document.getElementById('company-name');
        const companyNameTitleElement = document.getElementById('company-name-title');
        if (companyNameElement) {
            const titleText = (companyData && companyData.name) ? companyData.name : regionInfoText.primary;
            companyNameElement.textContent = titleText;
        }
        if (companyNameTitleElement) {
            const titleText = (companyData && companyData.name) ? companyData.name : regionInfoText.primary;
            companyNameTitleElement.textContent = titleText;
        }
        
        // ì§€ì—­ ì •ë³´ ì„¤ì •
        const companyRegionElement = document.getElementById('company-region');
        if (companyRegionElement) {
            companyRegionElement.textContent = regionName;
        }
        
        // ì„¹ì…˜ ì œëª© ë° ë¼ë²¨ ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const updateLabelWithTranslation = (secondaryId, key) => {
            const text = this.getLanguageText(key);
            const secondaryEl = document.getElementById(secondaryId);
            const secondaryParent = secondaryEl?.parentElement;
            const primaryEl = secondaryParent?.querySelector('.label-primary');
            
            if (primaryEl) primaryEl.textContent = text.primary;
            if (secondaryEl) {
                if (text.secondary) {
                    secondaryEl.textContent = ` (${text.secondary})`;
                    secondaryEl.style.display = 'inline';
                } else {
                    secondaryEl.style.display = 'none';
                }
            }
        };
        
        // ì„¹ì…˜ ì œëª© ì—…ë°ì´íŠ¸
        updateLabelWithTranslation('company-region-section-label-en', 'Region Information');
        updateLabelWithTranslation('company-info-section-label-en', 'Company Information');
        
        // ì§€ì—­ ì •ë³´ ë¼ë²¨ ì—…ë°ì´íŠ¸
        updateLabelWithTranslation('company-region-label-en', 'Region');
        updateLabelWithTranslation('company-region-population-label-en', 'Population');
        updateLabelWithTranslation('company-region-area-label-en', 'Area');
        updateLabelWithTranslation('company-region-admin-level-label-en', 'Administrative Level');
        updateLabelWithTranslation('company-region-price-label-en', 'Advertising Price');
        updateLabelWithTranslation('company-region-status-label-en', 'Status');
        
        // ê¸°ì—… ì •ë³´ ë¼ë²¨ ì—…ë°ì´íŠ¸
        updateLabelWithTranslation('company-industry-label-en', 'Industry');
        updateLabelWithTranslation('company-founded-label-en', 'Founded');
        updateLabelWithTranslation('company-employees-label-en', 'Employees');
        updateLabelWithTranslation('company-website-label-en', 'Website');
        updateLabelWithTranslation('company-description-label-en', 'Company Description');
        updateLabelWithTranslation('company-features-label-en', 'Key Features');
        
        if (companyData && companyData.name) {
            // ê¸°ì—… ì •ë³´ ì„¤ì •
            const elements = {
                'company-industry': companyData.industry || '-',
                'company-founded': companyData.founded || '-',
                'company-employees': companyData.employees || '-',
                'company-website': companyData.website || '-'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    if (id === 'company-website') {
                        element.href = companyData.website || '#';
                    }
                }
            });
            
            // ì„¤ëª… ì„¤ì •
            const descriptionElement = document.getElementById('company-description-text');
            if (descriptionElement) {
                descriptionElement.textContent = companyData.description || '-';
            }
            
            // ë¡œê³  í‘œì‹œ
            const logoImg = document.getElementById('company-logo');
            if (logoImg) {
                if (companyData.logo && companyData.logo.trim() !== '') {
                    logoImg.src = companyData.logo;
                    logoImg.style.display = 'block';
                    console.log('ë¡œê³  í‘œì‹œ:', companyData.logo);
                } else {
                    logoImg.style.display = 'none';
                    console.log('ë¡œê³  ì—†ìŒ - ìˆ¨ê¹€');
                }
            }
            
            // íŠ¹ì§• ëª©ë¡
            const featuresList = document.getElementById('company-features-list');
            if (featuresList) {
                if (companyData.features && companyData.features.length > 0) {
                    featuresList.innerHTML = '';
                    companyData.features.forEach(feature => {
                        if (feature && feature.trim() !== '') {
                            const li = document.createElement('li');
                            li.textContent = feature;
                            featuresList.appendChild(li);
                        }
                    });
                } else {
                    const noFeaturesText = this.getLanguageText('Key Features');
                    featuresList.innerHTML = `<li>-</li>`;
                }
            }
        } else {
            // ê¸°ì—… ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ë³¸ê°’ ì„¤ì •
            const elements = {
                'company-industry': '-',
                'company-founded': '-',
                'company-employees': '-',
                'company-website': '-'
            };
            
            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) {
                    element.textContent = value;
                    if (id === 'company-website') {
                        element.href = '#';
                    }
                }
            });
            
            const descriptionElement = document.getElementById('company-description-text');
            if (descriptionElement) {
                // ì–¸ì–´ ë³€í™˜ì€ ê¸°ë³¸ ë©”ì‹œì§€ì´ë¯€ë¡œ ì˜ì–´ë¡œë§Œ í‘œì‹œí•˜ê±°ë‚˜, í•„ìš”ì‹œ ì¶”ê°€
                descriptionElement.textContent = 'No company information available for this region.';
            }
            
            const logoImg = document.getElementById('company-logo');
            if (logoImg) {
                logoImg.style.display = 'none';
            }
            
            const featuresList = document.getElementById('company-features-list');
            if (featuresList) {
                featuresList.innerHTML = '<li>ë“±ë¡ëœ íŠ¹ì§•ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            }
        }
        
        // ì§€ì—­ ì •ë³´ í‘œì‹œ (ëª¨ë“  ê²½ìš°)
        const regionData = this.currentRegion;
        if (regionData) {
            // êµ¬ë§¤ ë²„íŠ¼ì— í˜„ì¬ stateId ì €ì¥ (onclickì—ì„œ í™œìš©)
            const companyPurchaseBtnEl = document.getElementById('company-purchase-btn');
            if (companyPurchaseBtnEl && stateId) {
                companyPurchaseBtnEl.dataset.stateId = stateId;
            }
            
            // ì¸êµ¬, ë©´ì , í–‰ì •êµ¬ì—­ ë ˆë²¨, ê´‘ê³  ê°€ê²© ë“± ì§€ì—­ ì •ë³´ í‘œì‹œ (regionDataì—ì„œ ì •í™•í•œ ê°’ ê°€ì ¸ì˜¤ê¸°)
            const regionDataFromMap = this.regionData.get(stateId) || regionData;
            const populationEl = document.getElementById('company-region-population');
            const areaEl = document.getElementById('company-region-area');
            const adminLevelEl = document.getElementById('company-region-admin-level');
            const priceEl = document.getElementById('company-region-price');
            const statusEl = document.getElementById('company-region-status');
            
            if (populationEl) {
                const population = regionDataFromMap.population || regionData.population || 0;
                populationEl.textContent = population ? population.toLocaleString() : '-';
            }
            if (areaEl) {
                const area = regionDataFromMap.area || regionData.area || 0;
                areaEl.textContent = area ? `${area.toLocaleString()} kmÂ²` : '-';
            }
            if (adminLevelEl) {
                adminLevelEl.textContent = regionDataFromMap.admin_level || regionData.admin_level || '-';
            }
            if (priceEl) {
                const adPrice = regionDataFromMap.ad_price || regionData.ad_price || 0;
                priceEl.textContent = adPrice ? `$${adPrice.toLocaleString()}` : '-';
            }
            if (statusEl) {
                const status = regionDataFromMap.ad_status || regionData.ad_status || 'available';
                const availableText = this.getLanguageText('Available');
                const occupiedText = this.getLanguageText('Occupied');
                statusEl.textContent = status === 'occupied' ? occupiedText.primary : availableText.primary;
                statusEl.style.color = status === 'occupied' ? '#ff6b6b' : '#4ecdc4';
            }
            
            // êµ¬ë§¤ ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ ì œì–´ (ê¸°ì—… ëª¨ë‹¬)
            const companyPurchaseBtn = companyPurchaseBtnEl || document.getElementById('company-purchase-btn');
            if (companyPurchaseBtn) {
                const isOccupied = (regionDataFromMap.ad_status || regionData.ad_status) === 'occupied' || regionDataFromMap.occupied || regionData.occupied;
                if (isOccupied) {
                    companyPurchaseBtn.classList.add('hidden');
                } else {
                    companyPurchaseBtn.classList.remove('hidden');
                }
            }
            
            this.updateCompanyModalAuctionSection(stateId);
            console.log('ì§€ì—­ ì •ë³´ í‘œì‹œ ì™„ë£Œ:', regionData);
        }
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ í¸ì§‘ ë²„íŠ¼ í‘œì‹œ
        const companyEditBtn = document.getElementById('company-edit-btn');
        if (companyEditBtn) {
            if (this.isAdminLoggedIn) {
                companyEditBtn.classList.remove('hidden');
            } else {
                companyEditBtn.classList.add('hidden');
            }
        }
        
        modal.classList.remove('hidden');
        modal.style.display = 'flex'; // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš©
        console.log('í†µí•© ì •ë³´ ëª¨ë‹¬ í‘œì‹œ ì™„ë£Œ');
    }
    
    // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideCompanyInfoModal() {
        const modal = document.getElementById('company-info-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    }
    
    // ê¸°ì—… ì •ë³´ í¸ì§‘ì„ ìœ„í•´ ë¡œë“œ
    loadCompanyInfoForEdit(stateId) {
        const companyData = this.currentMapMode === 'korea' 
            ? (this.koreaCompanyData[stateId] || {})
            : (this.companyData[stateId] || {});
        
        document.getElementById('company-name-input').value = companyData.name || '';
        document.getElementById('company-industry-input').value = companyData.industry || '';
        document.getElementById('company-founded-input').value = companyData.founded || '';
        document.getElementById('company-employees-input').value = companyData.employees || '';
        document.getElementById('company-website-input').value = companyData.website || '';
        document.getElementById('company-description-input').value = companyData.description || '';
        document.getElementById('company-features-input').value = companyData.features ? companyData.features.join('\n') : '';
    }
    
    // ê¸°ì—… ì •ë³´ ì €ì¥
    saveCompanyInfo() {
        console.log('ê¸°ì—… ì •ë³´ ì €ì¥ ì‹œë„:', {
            selectedStateId: this.selectedStateId,
            adminMode: this.adminMode,
            isAdminLoggedIn: this.isAdminLoggedIn
        });
        
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        const companyData = {
            name: document.getElementById('company-name-input').value,
            industry: document.getElementById('company-industry-input').value,
            founded: document.getElementById('company-founded-input').value,
            employees: document.getElementById('company-employees-input').value,
            website: document.getElementById('company-website-input').value,
            description: document.getElementById('company-description-input').value,
            features: document.getElementById('company-features-input').value.split('\n').filter(f => f.trim()),
            region: this.getRegionDisplayName(this.currentRegion),
            logo: this.logoData[this.selectedStateId]?.src || ''
        };
        
        console.log('ì €ì¥í•  ê¸°ì—… ë°ì´í„°:', companyData);
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaCompanyData[this.selectedStateId] = companyData;
        } else {
            this.companyData[this.selectedStateId] = companyData;
        }
        
        this.showNotification('ê¸°ì—… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ê¸°ì—… ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, companyData, 'ëª¨ë“œ:', this.currentMapMode);
    }
    
    // ê¸°ì—… ì •ë³´ ë¯¸ë¦¬ë³´ê¸°
    previewCompanyInfo() {
        if (!this.selectedStateId) {
            this.showNotification('ë¯¸ë¦¬ë³´ê¸°í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ì„ì‹œ ë°ì´í„°ë¡œ ë¯¸ë¦¬ë³´ê¸°
        const tempData = {
            name: document.getElementById('company-name-input').value || 'ê¸°ì—…ëª…',
            industry: document.getElementById('company-industry-input').value || 'ì‚°ì—…',
            founded: document.getElementById('company-founded-input').value || 'ì„¤ë¦½ë…„ë„',
            employees: document.getElementById('company-employees-input').value || 'ì§ì› ìˆ˜',
            website: document.getElementById('company-website-input').value || 'ì›¹ì‚¬ì´íŠ¸',
            description: document.getElementById('company-description-input').value || 'ê¸°ì—… ì†Œê°œ',
            features: document.getElementById('company-features-input').value.split('\n').filter(f => f.trim()),
            region: this.getRegionDisplayName(this.currentRegion),
            logo: this.logoData[this.selectedStateId]?.src || ''
        };
        
        // ì„ì‹œë¡œ ì €ì¥
        const originalData = this.companyData[this.selectedStateId];
        this.companyData[this.selectedStateId] = tempData;
        
        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
        this.showCompanyInfoModal(this.selectedStateId);
        
        // ì›ë˜ ë°ì´í„° ë³µì›
        this.companyData[this.selectedStateId] = originalData;
    }
    
    // ìƒ‰ìƒ ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateColorPreview() {
        if (!this.selectedStateId) return;
        
        const regionColor = document.getElementById('region-color').value;
        const borderColor = document.getElementById('border-color').value;
        const borderWidth = document.getElementById('border-width').value;
        
        // ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
        document.getElementById('region-color-value').textContent = regionColor;
        document.getElementById('border-color-value').textContent = borderColor;
        document.getElementById('border-width-value').textContent = borderWidth + 'px';
        
        // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        this.colorData[this.selectedStateId] = {
            regionColor: regionColor,
            borderColor: borderColor,
            borderWidth: parseInt(borderWidth)
        };
    }
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©
    applyColorPreset(preset) {
        const regionColor = preset.dataset.color;
        const borderColor = preset.dataset.border;
        
        // ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        document.getElementById('region-color').value = regionColor;
        document.getElementById('border-color').value = borderColor;
        
        // í”„ë¦¬ì…‹ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
        preset.classList.add('selected');
        
        // ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        this.updateColorPreview();
        
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©:', regionColor, borderColor);
    }
    
    // ì§€ë„ì— ìƒ‰ìƒ ì ìš©
    applyColorToMap(stateId, colorData) {
        if (!this.map || !colorData) return;
        
        // ì§€ë„ ë ˆì´ì–´ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
        this.map.setPaintProperty('regions-fill', 'fill-color', [
            'case',
            ['==', ['get', 'id'], stateId],
            colorData.regionColor,
            [
                'case',
                ['==', ['get', 'ad_status'], 'occupied'],
                '#ff6b6b',
                '#4ecdc4'
            ]
        ]);
        
        this.map.setPaintProperty('regions-border', 'line-color', [
            'case',
            ['==', ['get', 'id'], stateId],
            colorData.borderColor,
            '#ffffff'
        ]);
        
        this.map.setPaintProperty('regions-border', 'line-width', [
            'case',
            ['==', ['get', 'id'], stateId],
            colorData.borderWidth,
            1
        ]);
        
        console.log('ì§€ë„ì— ìƒ‰ìƒ ì ìš© ì™„ë£Œ:', stateId, colorData);
    }
    
    showInfoPanel(region) {
        const panel = document.getElementById('info-panel');
        const regionName = document.getElementById('region-name');
        const countryName = document.getElementById('country-name');
        const adminLevel = document.getElementById('admin-level');
        const population = document.getElementById('population');
        const area = document.getElementById('area');
        const adStatus = document.getElementById('ad-status');
        const adPrice = document.getElementById('ad-price');
        
        if (!region) {
            panel.classList.add('hidden');
            return;
        }
        
        const regionFromMap = this.regionData.get(region.id) || region;
        this.currentRegion = regionFromMap;
        if (this.isFirebaseInitialized && this.firestore) {
            this.subscribePixelBundles(regionFromMap.id);
        } else {
            this.updatePixelStoryCard(regionFromMap.id);
        }
        
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í‘œì‹œí•  ì´ë¦„ ê²°ì •
        regionName.textContent = this.getRegionDisplayName(regionFromMap);
        
        if (this.currentMapMode === 'japan') {
            adminLevel.textContent = 'Prefecture';
            adStatus.textContent = regionFromMap.ad_status === 'occupied' ? 'Occupied' : (regionFromMap.ad_status === 'auction' ? 'Auction' : 'Available');
        } else if (this.currentMapMode === 'spain' && region.autonomous_community_ko) {
            // ìŠ¤í˜ì¸ì˜ ê²½ìš° ìì¹˜ì§€ì—­ ì •ë³´ í‘œì‹œ
            adminLevel.textContent = `${region.admin_level} (ìì¹˜ì§€ì—­: ${region.autonomous_community_ko})`;
            adStatus.textContent = region.ad_status === 'occupied' ? 'ê´‘ê³  ì¤‘' : 'ì‚¬ìš© ê°€ëŠ¥';
        } else {
            const englishCountries = ['usa', 'uk', 'canada', 'australia', 'south-africa'];
            const isEnglishCountry = englishCountries.includes(this.currentMapMode);
            adminLevel.textContent = regionFromMap.admin_level;
            const statusKey = regionFromMap.ad_status === 'occupied'
                ? (isEnglishCountry ? 'Occupied' : 'ê´‘ê³  ì¤‘')
                : (regionFromMap.ad_status === 'auction'
                    ? (isEnglishCountry ? 'Auction' : 'ê²½ë§¤ ì§„í–‰ ì¤‘')
                    : (isEnglishCountry ? 'Available' : 'ì‚¬ìš© ê°€ëŠ¥'));
            adStatus.textContent = statusKey;
        }
        countryName.textContent = regionFromMap.country;
        population.textContent = regionFromMap.population ? regionFromMap.population.toLocaleString() : '-';
        area.textContent = regionFromMap.area ? `${regionFromMap.area.toLocaleString()} kmÂ²` : '-';
        adStatus.style.color = regionFromMap.ad_status === 'occupied'
            ? '#ff6b6b'
            : (regionFromMap.ad_status === 'auction' ? '#feca57' : '#4ecdc4');
        adPrice.textContent = regionFromMap.ad_price ? `$${regionFromMap.ad_price.toLocaleString()}` : '-';
        
        this.updateAuctionPanel(regionFromMap);
        
        panel.classList.remove('hidden');
    }
    
    updateAuctionPanel(region) {
        const currentBidEl = document.getElementById('auction-current-bid');
        if (!currentBidEl) return;
        
        const minBidEl = document.getElementById('auction-min-bid');
        const protectionEl = document.getElementById('auction-protection');
        const bidderEl = document.getElementById('auction-current-bidder');
        const statusEl = document.getElementById('auction-status-message');
        const bidInput = document.getElementById('auction-bid-input');
        const configProtectionEl = document.getElementById('auction-config-protection');
        const configIncrementEl = document.getElementById('auction-config-increment');
        const configBuyNowEl = document.getElementById('auction-config-buy-now');
        const buyNowBtn = document.getElementById('auction-buy-now-btn');
        
        const auctionInfo = this.getAuctionInfo(region);
        if (!auctionInfo) {
            currentBidEl.textContent = '-';
            minBidEl.textContent = '-';
            protectionEl.textContent = '-';
            bidderEl.textContent = '-';
            if (configProtectionEl) configProtectionEl.textContent = '-';
            if (configIncrementEl) configIncrementEl.textContent = '-';
            if (configBuyNowEl) configBuyNowEl.textContent = '-';
            if (buyNowBtn) buyNowBtn.classList.add('hidden');
            if (statusEl) statusEl.textContent = '';
            if (bidInput) bidInput.placeholder = 'ì…ì°° ê¸ˆì•¡ (USD)';
            return;
        }
        
        currentBidEl.textContent = auctionInfo.currentBid ? this.formatCurrency(auctionInfo.currentBid) : '-';
        minBidEl.textContent = this.formatCurrency(auctionInfo.minBid);
        protectionEl.textContent = auctionInfo.hasActiveProtection
            ? `${this.formatProtectionCountdown(auctionInfo.protectionEndsAt)}`
            : 'ì¦‰ì‹œ ì…ì°° ê°€ëŠ¥';
        bidderEl.textContent = auctionInfo.currentBidder
            ? (auctionInfo.currentBidder.displayName || auctionInfo.currentBidder.email || '-')
            : '-';
        
        if (statusEl) {
            statusEl.textContent = auctionInfo.hasActiveProtection
                ? 'í˜„ì¬ ìµœê³  ì…ì°° ë³´í˜¸ ì‹œê°„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.'
                : '';
        }
        
        if (bidInput) {
            bidInput.placeholder = `${this.formatCurrency(auctionInfo.minBid)} ì´ìƒ`;
            bidInput.min = auctionInfo.minBid || 0;
        }
        
        const config = auctionInfo.config || this.getRegionAuctionConfig(region);
        if (configProtectionEl) {
            configProtectionEl.textContent = config && config.protectionHours
                ? `${config.protectionHours}ì‹œê°„`
                : '-';
        }
        if (configIncrementEl) {
            const percentLabel = (config && typeof config.minIncrementPercent === 'number')
                ? `${Math.round(config.minIncrementPercent * 100)}%`
                : '0%';
            const amountLabel = config && config.minIncrementAmount
                ? ` / +${this.formatCurrency(config.minIncrementAmount)}`
                : '';
            configIncrementEl.textContent = `${percentLabel}${amountLabel}`;
        }
        if (configBuyNowEl) {
            configBuyNowEl.textContent = config && config.buyNowPrice
                ? this.formatCurrency(config.buyNowPrice)
                : '-';
        }
        if (buyNowBtn) {
            if (config && config.buyNowPrice) {
                buyNowBtn.classList.remove('hidden');
                buyNowBtn.textContent = `ì¦‰ì‹œ êµ¬ë§¤ (${this.formatCurrency(config.buyNowPrice)})`;
            } else {
                buyNowBtn.classList.add('hidden');
            }
        }
    }
    
    updateCompanyModalAuctionSection(stateId) {
        const currentBidEl = document.getElementById('company-auction-current-bid');
        if (!currentBidEl) return;
        
        const region = this.regionData.get(stateId) || this.currentRegion;
        const auctionInfo = this.getAuctionInfo(region);
        const minBidEl = document.getElementById('company-auction-min-bid');
        const protectionEl = document.getElementById('company-auction-protection');
        const bidderEl = document.getElementById('company-auction-current-bidder');
        const statusEl = document.getElementById('company-auction-status');
        const bidInput = document.getElementById('company-auction-bid-input');
        const configProtectionEl = document.getElementById('company-auction-config-protection');
        const configIncrementEl = document.getElementById('company-auction-config-increment');
        const configBuyNowEl = document.getElementById('company-auction-config-buy-now');
        const buyNowBtn = document.getElementById('company-auction-buy-now-btn');
        
        if (!auctionInfo) {
            currentBidEl.textContent = '-';
            if (minBidEl) minBidEl.textContent = '-';
            if (protectionEl) protectionEl.textContent = '-';
            if (bidderEl) bidderEl.textContent = '-';
            if (configProtectionEl) configProtectionEl.textContent = '-';
            if (configIncrementEl) configIncrementEl.textContent = '-';
            if (configBuyNowEl) configBuyNowEl.textContent = '-';
            if (buyNowBtn) buyNowBtn.classList.add('hidden');
            if (statusEl) statusEl.textContent = '';
            if (bidInput) bidInput.placeholder = 'ì…ì°° ê¸ˆì•¡ (USD)';
            return;
        }
        
        currentBidEl.textContent = auctionInfo.currentBid ? this.formatCurrency(auctionInfo.currentBid) : '-';
        if (minBidEl) minBidEl.textContent = this.formatCurrency(auctionInfo.minBid);
        if (protectionEl) {
            protectionEl.textContent = auctionInfo.hasActiveProtection
                ? `${this.formatProtectionCountdown(auctionInfo.protectionEndsAt)}`
                : 'ì¦‰ì‹œ ì…ì°° ê°€ëŠ¥';
        }
        if (bidderEl) {
            bidderEl.textContent = auctionInfo.currentBidder
                ? (auctionInfo.currentBidder.displayName || auctionInfo.currentBidder.email || '-')
                : '-';
        }
        if (statusEl) {
            statusEl.textContent = auctionInfo.hasActiveProtection
                ? 'í˜„ì¬ ìµœê³  ì…ì°° ë³´í˜¸ ì‹œê°„ì´ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤.'
                : '';
        }
        if (bidInput) {
            bidInput.placeholder = `${this.formatCurrency(auctionInfo.minBid)} ì´ìƒ`;
            bidInput.min = auctionInfo.minBid || 0;
        }
        
        const config = auctionInfo.config || this.getRegionAuctionConfig(region);
        if (configProtectionEl) {
            configProtectionEl.textContent = config && config.protectionHours
                ? `${config.protectionHours}ì‹œê°„`
                : '-';
        }
        if (configIncrementEl) {
            const percentLabel = (config && typeof config.minIncrementPercent === 'number')
                ? `${Math.round(config.minIncrementPercent * 100)}%`
                : '0%';
            const amountLabel = config && config.minIncrementAmount
                ? ` / +${this.formatCurrency(config.minIncrementAmount)}`
                : '';
            configIncrementEl.textContent = `${percentLabel}${amountLabel}`;
        }
        if (configBuyNowEl) {
            configBuyNowEl.textContent = config && config.buyNowPrice
                ? this.formatCurrency(config.buyNowPrice)
                : '-';
        }
        if (buyNowBtn) {
            if (config && config.buyNowPrice) {
                buyNowBtn.classList.remove('hidden');
                buyNowBtn.textContent = `ì¦‰ì‹œ êµ¬ë§¤ (${this.formatCurrency(config.buyNowPrice)})`;
            } else {
                buyNowBtn.classList.add('hidden');
            }
        }
    }
    
    updateAuctionWidgets() {
        // ì‹œì¦Œ ì¢…ë£Œ ì¹´ìš´íŠ¸ë‹¤ìš´ ì—…ë°ì´íŠ¸
        this.updateSeasonCountdown();
        
        const leaderboardEl = document.getElementById('auction-leaderboard-list');
        const bidLogEl = document.getElementById('auction-bid-log');
        
        const auctionsArray = Array.from(this.auctionData.entries());
        
        if (leaderboardEl) {
            const dataset = this.buildLeaderboardDataset(auctionsArray);
            this.refreshLeaderboardFilterTabs(dataset);
            const filters = this.leaderboardFilterState || { season: 'all', country: 'all' };
            const filtered = this.applyLeaderboardFilters(dataset, filters);
            
            if (this.canUseRealtimeLeaderboard(filters)) {
                if (this.realtimeLeaderboard && this.realtimeLeaderboard.entries?.length) {
                    this.updateRealtimeLeaderboardViewIfActive(true);
                } else {
                    const limitedLocal = filtered.slice(0, this.leaderboardDefaultLimit);
                    this.renderLeaderboardList(limitedLocal, 'local');
                    this.lastRenderedLeaderboardSource = 'local';
                }
            } else {
                const limited = filtered.slice(0, this.leaderboardDefaultLimit);
                this.renderLeaderboardList(limited, 'local');
                
                if (this.shouldUseServerSideLeaderboard(dataset.length)) {
                    this.fetchLeaderboardFromCloud(filters);
                } else {
                    this.lastRenderedLeaderboardSource = 'local';
                }
            }
        }
        
        if (bidLogEl) {
            bidLogEl.innerHTML = '';
            const logData = [];
            auctionsArray.forEach(([regionId, auction]) => {
                const region = this.regionData.get(regionId);
                const regionName = auction.regionName
                    || (region ? this.getRegionDisplayName(region) : regionId);
                (auction.history || []).forEach(entry => {
                    const timestamp = this.getTimestampMillis(entry.timestamp);
                    logData.push({
                        regionName,
                        bidder: entry.bidder || 'ìµëª…',
                        amount: entry.amount || 0,
                        timestamp
                    });
                });
            });
            
            logData.sort((a, b) => b.timestamp - a.timestamp);
            const recentLogs = logData.slice(0, 8);
            
            if (recentLogs.length === 0) {
                bidLogEl.innerHTML = '<li class="empty">ìµœê·¼ ì…ì°°ì´ ì—†ìŠµë‹ˆë‹¤.</li>';
            } else {
                recentLogs.forEach((log) => {
                    const li = document.createElement('li');
                    li.className = 'bid-log-item';
                    li.innerHTML = `
                        <div class="bid-log-entry">
                            <strong>${log.regionName}</strong>
                            <span class="bid-log-meta">${log.bidder} Â· ${this.formatRelativeTime(log.timestamp)}</span>
                        </div>
                        <span class="bid-log-amount">${this.formatCurrency(log.amount)}</span>
                    `;
                    bidLogEl.appendChild(li);
                });
            }
        }
        
    }
    
    getAuctionInfo(region) {
        if (!region) return null;
        const regionData = typeof region === 'string' ? this.regionData.get(region) : region;
        if (!regionData) return null;
        
        const config = this.getRegionAuctionConfig(regionData);
        const auction = regionData.auction || this.auctionData.get(regionData.id) || null;
        const basePrice = regionData.ad_price || this.uniformAdPrice || 1000;
        const hasBid = !!(auction && auction.currentBid);
        const referenceAmount = hasBid ? auction.currentBid : basePrice;
        const minBid = this.calculateMinimumBidAmount(referenceAmount, hasBid, config);
        
        return {
            basePrice,
            currentBid: hasBid ? auction.currentBid : 0,
            minBid,
            currentBidder: auction?.currentBidder || null,
            protectionEndsAt: auction?.protectionEndsAt || null,
            lastBidAt: auction?.lastBidAt || null,
            hasActiveProtection: this.isProtectionActive(auction?.protectionEndsAt),
            buyNowPrice: config.buyNowPrice || null,
            config
        };
    }
    
    getRegionAuctionConfig(region) {
        const regionData = typeof region === 'string' ? this.regionData.get(region) : region;
        const base = this.auctionConfig || {};
        const overrides = regionData?.auctionConfig || regionData?.auction_settings || {};
        const asNumber = (value) => (typeof value === 'number' && Number.isFinite(value) ? value : null);
        
        const result = {
            minIncrementPercent: asNumber(overrides.minIncrementPercent),
            minIncrementAmount: asNumber(overrides.minIncrementAmount),
            protectionHours: asNumber(overrides.protectionHours),
            roundingUnit: asNumber(overrides.roundingUnit),
            buyNowPrice: asNumber(overrides.buyNowPrice),
            instantTransferPercent: asNumber(overrides.instantTransferPercent),
            defenseGraceMinutes: asNumber(overrides.defenseGraceMinutes)
        };
        
        return {
            minIncrementPercent: result.minIncrementPercent ?? base.minIncrementPercent ?? 0.05,
            minIncrementAmount: result.minIncrementAmount ?? 0,
            protectionHours: result.protectionHours ?? base.protectionHours ?? 12,
            roundingUnit: result.roundingUnit ?? base.roundingUnit ?? 100,
            buyNowPrice: result.buyNowPrice ?? (asNumber(base.buyNowPrice) ?? null),
            instantTransferPercent: result.instantTransferPercent ?? base.instantTransferPercent ?? null,
            defenseGraceMinutes: result.defenseGraceMinutes ?? base.defenseGraceMinutes ?? 0
        };
    }
    
    calculateMinimumBidAmount(referenceAmount, hasExistingBid = true, config = null) {
        const roundingUnit = (config && config.roundingUnit) || this.auctionConfig.roundingUnit || 100;
        const incrementPercent = hasExistingBid
            ? ((config && config.minIncrementPercent) ?? this.auctionConfig.minIncrementPercent ?? 0.05)
            : 0;
        const incrementAmount = hasExistingBid ? ((config && config.minIncrementAmount) || 0) : 0;
        const percentIncrease = referenceAmount * incrementPercent;
        const rawAmount = referenceAmount + Math.max(percentIncrease, incrementAmount);
        const rounded = Math.ceil(rawAmount / roundingUnit) * roundingUnit;
        return Math.max(rounded, this.uniformAdPrice || 1000);
    }
    
    formatCurrency(amount) {
        if (!amount || isNaN(amount)) return '$0';
        return `$${Number(amount).toLocaleString()}`;
    }
    
    getTimestampMillis(timestamp) {
        if (!timestamp) return 0;
        if (typeof timestamp.toMillis === 'function') {
            return timestamp.toMillis();
        }
        if (timestamp instanceof Date) {
            return timestamp.getTime();
        }
        if (typeof timestamp === 'number') {
            return timestamp;
        }
        if (timestamp.seconds !== undefined) {
            return timestamp.seconds * 1000 + Math.floor((timestamp.nanoseconds || 0) / 1e6);
        }
        const parsed = new Date(timestamp);
        return parsed.getTime();
    }
    
    isProtectionActive(timestamp) {
        if (!timestamp) return false;
        return this.getTimestampMillis(timestamp) > Date.now();
    }
    
    formatProtectionCountdown(timestamp) {
        if (!timestamp) return 'ë³´í˜¸ ì¢…ë£Œ';
        const remaining = this.getTimestampMillis(timestamp) - Date.now();
        if (remaining <= 0) return 'ë³´í˜¸ ì¢…ë£Œ';
        const hours = Math.floor(remaining / 3600000);
        const minutes = Math.floor((remaining % 3600000) / 60000);
        if (hours > 0) {
            return `${hours}ì‹œê°„ ${minutes}ë¶„ ë‚¨ìŒ`;
        }
        return `${minutes}ë¶„ ë‚¨ìŒ`;
    }
    
    formatSeasonCountdown(endDate) {
        if (!endDate) return 'ì¢…ë£Œë¨';
        const end = endDate instanceof Date ? endDate : new Date(endDate);
        const now = new Date();
        const diff = end - now;
        
        if (diff <= 0) return 'ì¢…ë£Œë¨';
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        if (days > 0) {
            return `${days}ì¼ ${hours}ì‹œê°„`;
        } else if (hours > 0) {
            return `${hours}ì‹œê°„ ${minutes}ë¶„`;
        } else {
            return `${minutes}ë¶„`;
        }
    }
    
    updateSeasonCountdown(seasonData = null) {
        const countdownEl = document.getElementById('season-countdown');
        if (!countdownEl) return;
        
        const season = seasonData || this.currentSeason;
        const countdown = this.formatSeasonCountdown(season.endDate);
        countdownEl.textContent = countdown;
    }
    
    formatRelativeTime(timestampMillis) {
        if (!timestampMillis || Number.isNaN(timestampMillis)) {
            return 'ë°©ê¸ˆ ì „';
        }
        const diff = Date.now() - timestampMillis;
        if (diff < 60000) {
            return 'ë°©ê¸ˆ ì „';
        }
        if (diff < 3600000) {
            const minutes = Math.floor(diff / 60000);
            return `${minutes}ë¶„ ì „`;
        }
        if (diff < 86400000) {
            const hours = Math.floor(diff / 3600000);
            return `${hours}ì‹œê°„ ì „`;
        }
        const days = Math.floor(diff / 86400000);
        return `${days}ì¼ ì „`;
    }
    
    async handleAuctionBid(context = 'panel') {
        const contexts = {
            panel: { inputId: 'auction-bid-input', statusId: 'auction-status-message', buttonId: 'auction-bid-btn' },
            modal: { inputId: 'company-auction-bid-input', statusId: 'company-auction-status', buttonId: 'company-auction-bid-btn' }
        };
        
        const ctx = contexts[context] || contexts.panel;
        const input = document.getElementById(ctx.inputId);
        const statusEl = document.getElementById(ctx.statusId);
        const button = document.getElementById(ctx.buttonId);
        
        if (!input || !this.currentRegion) {
            this.showNotification('ì…ì°°í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        if (!this.currentUser) {
            this.showNotification('ì…ì°°í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            this.showUserLoginModal();
            return;
        }
        
        const bidAmount = parseFloat(input.value);
        if (!isFinite(bidAmount) || bidAmount <= 0) {
            this.showNotification('ìœ íš¨í•œ ì…ì°° ê¸ˆì•¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        if (statusEl) {
            statusEl.textContent = 'ì…ì°° ì§„í–‰ ì¤‘...';
            statusEl.style.color = '#feca57';
        }
        if (button) button.disabled = true;
        
        try {
            await this.placeBid(this.currentRegion.id, bidAmount);
            if (statusEl) {
                statusEl.textContent = 'ì…ì°°ì´ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤!';
                statusEl.style.color = '#1dd1a1';
            }
            input.value = '';
            
            // ì…ì°° ì„±ê³µ í›„ í”½ì…€ ì—ë””í„° ìë™ ì—´ê¸°
            setTimeout(() => {
                this.openPixelEditorModal();
                this.showNotification('ìµœê³  ì…ì°°ìê°€ ë˜ì—ˆìŠµë‹ˆë‹¤! í”½ì…€ ì—ë””í„°ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'info');
            }, 500);
        } catch (error) {
            console.error('ì…ì°° ì˜¤ë¥˜:', error);
            const message = error.message || 'ì…ì°° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            if (statusEl) {
                statusEl.textContent = message;
                statusEl.style.color = '#ff6b6b';
            }
            this.showNotification(message, 'error');
        } finally {
            if (button) button.disabled = false;
        }
    }
    
    handleAuctionBuyNow(context = 'panel', regionOverride = null) {
        const contexts = {
            panel: 'paypal-buttons',
            region: 'region-paypal-buttons',
            company: 'company-paypal-buttons'
        };
        const region = regionOverride || this.currentRegion;
        if (!region) {
            this.showNotification('ì¦‰ì‹œ êµ¬ë§¤í•  ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        const auctionInfo = this.getAuctionInfo(region);
        const buyNowPrice = auctionInfo?.buyNowPrice || auctionInfo?.config?.buyNowPrice;
        if (!buyNowPrice) {
            this.showNotification('ì´ ì§€ì—­ì€ ì¦‰ì‹œ êµ¬ë§¤ ì˜µì…˜ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
            return;
        }
        if (!this.currentUser) {
            this.showNotification('ì¦‰ì‹œ êµ¬ë§¤ë¥¼ ì§„í–‰í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            this.showUserLoginModal();
            return;
        }
        const containerId = contexts[context] || contexts.panel;
        this.renderPayPalButtons(containerId, region, { overrideAmount: buyNowPrice });
        const container = document.getElementById(containerId);
        if (container) {
            container.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    }
    
    async placeBid(regionId, bidAmount) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            throw new Error('Firebase ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
        }
        
        const region = this.regionData.get(regionId);
        if (!region) {
            throw new Error('ì„ íƒí•œ ì§€ì—­ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        }
        
        const { doc, runTransaction, serverTimestamp, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
        const auctionRef = doc(this.firestore, 'auctions', regionId);
        const regionAuctionConfig = this.getRegionAuctionConfig(region);
        const protectionMs = (regionAuctionConfig.protectionHours || 12) * 60 * 60 * 1000;
        const roundingUnit = regionAuctionConfig.roundingUnit || 100;
        const normalizedBidAmount = Math.ceil(bidAmount / roundingUnit) * roundingUnit;
        
        await runTransaction(this.firestore, async (transaction) => {
            const auctionSnap = await transaction.get(auctionRef);
            const auctionData = auctionSnap.exists() ? auctionSnap.data() : null;
            const basePrice = region.ad_price || this.uniformAdPrice || 1000;
            const referenceAmount = auctionData?.currentBid || basePrice;
            const minBid = this.calculateMinimumBidAmount(referenceAmount, !!auctionData?.currentBid, regionAuctionConfig);
            
            if (normalizedBidAmount < minBid) {
                throw new Error(`ìµœì†Œ ì…ì°°ê°€ëŠ” ${this.formatCurrency(minBid)} ì…ë‹ˆë‹¤.`);
            }
            
            // ë°©ì–´ê¶Œ í™•ì¸ (í˜„ì¬ ì†Œìœ ìê°€ ë””íœìŠ¤ ìœ ì˜ˆ ì‹œê°„ ë‚´ì— ë°©ì–´í•  ìˆ˜ ìˆëŠ”ì§€)
            const defenseGraceMinutes = regionAuctionConfig.defenseGraceMinutes || 0;
            const hasDefenseRight = auctionData?.currentBidder?.uid === this.currentUser.uid;
            let canBid = true;
            
            if (auctionData?.protectionEndsAt) {
                const protectionEnds = this.getTimestampMillis(auctionData.protectionEndsAt);
                const now = Date.now();
                const protectionRemaining = protectionEnds - now;
                
                if (protectionRemaining > 0) {
                    // ë³´í˜¸ ì‹œê°„ì´ ì•„ì§ ë‚¨ì•„ìˆëŠ” ê²½ìš°
                    if (hasDefenseRight && defenseGraceMinutes > 0) {
                        // ë°©ì–´ê¶Œì´ ìˆê³  ë””íœìŠ¤ ìœ ì˜ˆ ì‹œê°„ì´ ì„¤ì •ëœ ê²½ìš°
                        const graceMs = defenseGraceMinutes * 60 * 1000;
                        const graceStart = protectionEnds - graceMs;
                        
                        if (now >= graceStart) {
                            // ë””íœìŠ¤ ìœ ì˜ˆ ì‹œê°„ ë‚´ì— ë°©ì–´ê¶Œ ì‚¬ìš© ê°€ëŠ¥
                            canBid = true;
                        } else {
                            // ì•„ì§ ë””íœìŠ¤ ìœ ì˜ˆ ì‹œê°„ì´ ì‹œì‘ë˜ì§€ ì•ŠìŒ
                            throw new Error(`ë°©ì–´ê¶Œì€ ë³´í˜¸ ì‹œê°„ ì¢…ë£Œ ${defenseGraceMinutes}ë¶„ ì „ë¶€í„° ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                        }
                    } else {
                        // ë°©ì–´ê¶Œì´ ì—†ê±°ë‚˜ ë””íœìŠ¤ ìœ ì˜ˆ ì‹œê°„ì´ ì„¤ì •ë˜ì§€ ì•Šì€ ê²½ìš°
                        throw new Error('ë³´í˜¸ ê¸°ê°„ì´ ëë‚œ í›„ ë‹¤ì‹œ ì…ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    }
                }
            }
            
            if (!canBid) {
                throw new Error('ì…ì°°í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const now = Timestamp.now();
            // ë°©ì–´ê¶Œì„ ì‚¬ìš©í•œ ê²½ìš° ë³´í˜¸ ì‹œê°„ ì—°ì¥ ë° ë°©ì–´ ì„±ê³µ ë³´ìƒ ì§€ê¸‰
            let newProtectionMs = protectionMs;
            let defenseSuccess = false;
            if (hasDefenseRight && auctionData?.protectionEndsAt) {
                const protectionEnds = this.getTimestampMillis(auctionData.protectionEndsAt);
                const nowMs = Date.now();
                if (protectionEnds > nowMs) {
                    // ê¸°ì¡´ ë³´í˜¸ ì‹œê°„ì´ ë‚¨ì•„ìˆìœ¼ë©´ ì—°ì¥
                    newProtectionMs = protectionEnds - nowMs + protectionMs;
                    defenseSuccess = true;
                }
            }
            const protectionEndsAt = Timestamp.fromDate(new Date(Date.now() + newProtectionMs));
            const history = (auctionData?.history || []).slice(-9);
            history.push({
                amount: normalizedBidAmount,
                bidder: this.currentUser.displayName || this.currentUser.email,
                timestamp: now
            });
            
            // ì¸ê¸° ì§€í‘œ ì—…ë°ì´íŠ¸ (ì…ì°° íšŸìˆ˜ ì¦ê°€)
            this.updateRegionPopularity(regionId, 'bid');
            
            const payload = {
                regionId,
                regionName: this.getRegionDisplayName(region),
                currentBid: normalizedBidAmount,
                currentBidder: {
                    uid: this.currentUser.uid,
                    email: this.currentUser.email,
                    displayName: this.currentUser.displayName || this.currentUser.email
                },
                lastBidAt: now,
                protectionEndsAt,
                history,
                updatedAt: serverTimestamp(),
                minIncrementPercent: regionAuctionConfig.minIncrementPercent
            };
            
            if (!auctionSnap.exists()) {
                payload.createdAt = serverTimestamp();
            }
            
            transaction.set(auctionRef, payload, { merge: true });
        });
        
        // ë°©ì–´ ì„±ê³µ ë³´ìƒ ì§€ê¸‰ (íŠ¸ëœì­ì…˜ ì™„ë£Œ í›„)
        if (hasDefenseRight && defenseSuccess) {
            const defenseReward = 50; // ë°©ì–´ ì„±ê³µ ë³´ìƒ: 50 í¬ì¸íŠ¸
            this.giveReward(
                this.currentUser.uid,
                'defense_success',
                defenseReward,
                {
                    regionId: regionId,
                    regionName: this.getRegionDisplayName(region),
                    bidAmount: normalizedBidAmount
                }
            ).then(() => {
                // ë°©ì–´ ì„±ê³µ ì•Œë¦¼ ë° íƒ€ì„ë¼ì¸ ê¸°ë¡
                this.showNotification(`ğŸ›¡ï¸ ë°©ì–´ ì„±ê³µ! ${defenseReward} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // íƒ€ì„ë¼ì¸ì— ë°©ì–´ ì„±ê³µ ì´ë²¤íŠ¸ ê¸°ë¡
                this.recordTimelineEvent({
                    type: 'defense',
                    regionId: regionId,
                    regionName: this.getRegionDisplayName(region),
                    buyerEmail: this.currentUser.email,
                    amount: normalizedBidAmount,
                    reward: defenseReward,
                    success: true
                }).catch(err => console.error('ë°©ì–´ ì„±ê³µ íƒ€ì„ë¼ì¸ ê¸°ë¡ ì‹¤íŒ¨:', err));
                
                // í¬ì¸íŠ¸ UI ì—…ë°ì´íŠ¸
                this.updateUserPointsDisplay();
            }).catch(err => {
                console.error('ë°©ì–´ ì„±ê³µ ë³´ìƒ ì§€ê¸‰ ì‹¤íŒ¨:', err);
                this.showNotification('ë°©ì–´ ì„±ê³µ ë³´ìƒ ì§€ê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            });
        }
    }

    initializePixelExperienceUI() {
        if (this.pixelExperienceInitialized) return;
        this.pixelExperienceInitialized = true;
        
        this.pixelPreviewCanvas = document.getElementById('pixel-preview') || null;
        this.pixelPreviewCtx = this.pixelPreviewCanvas ? this.pixelPreviewCanvas.getContext('2d') : null;
        this.clearPixelPreview();
        
        const openButtons = [
            document.getElementById('open-pixel-editor'),
            document.getElementById('region-open-pixel-editor'),
            document.getElementById('company-open-pixel-editor')
        ].filter(Boolean);
        openButtons.forEach((btn) => {
            btn.addEventListener('click', () => this.openPixelEditorModal());
        });
        
        const closeBtn = document.getElementById('close-pixel-editor');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => this.closePixelEditorModal());
        }
        
        const layerToggle = document.getElementById('pixel-layer-toggle');
        if (layerToggle) {
            layerToggle.addEventListener('click', () => {
                this.togglePixelLayerVisibility();
                // í”½ì…€ ë ˆì´ì–´ê°€ í™œì„±í™”ë˜ë©´ í˜„ì¬ ì„ íƒëœ ì§€ì—­ìœ¼ë¡œ ì¤Œì¸
                if (this.pixelLayerVisible && this.currentRegion) {
                    this.zoomToPixelLevel(this.currentRegion.id);
                }
            });
        }
        
        // ESC í‚¤ë¡œ í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œ ì¢…ë£Œ
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && this.pixelDetailMode) {
                this.exitPixelDetailMode();
            }
        });
        
        document.querySelectorAll('.pixel-mode-btn').forEach((btn) => {
            btn.addEventListener('click', () => this.setPixelEditorMode(btn.dataset.mode));
        });
        
        const colorInput = document.getElementById('pixel-color-input');
        if (colorInput) {
            colorInput.addEventListener('input', (event) => this.handlePixelColorChange(event.target.value));
        }
        
        const brushInput = document.getElementById('pixel-brush-size');
        if (brushInput) {
            brushInput.addEventListener('input', (event) => this.handlePixelBrushSize(parseInt(event.target.value, 10) || 1));
        }
        
        const clearBtn = document.getElementById('pixel-clear-btn');
        if (clearBtn) {
            clearBtn.addEventListener('click', () => this.clearPixelCanvas());
        }
        
        const imageInput = document.getElementById('pixel-image-input');
        if (imageInput) {
            imageInput.addEventListener('change', (event) => {
                const file = event.target.files && event.target.files[0];
                this.handlePixelImageUpload(file);
            });
        }
        
        const messageInput = document.getElementById('pixel-message-input');
        if (messageInput) {
            messageInput.addEventListener('input', (event) => this.handlePixelMessageInput(event.target.value));
        }
        
        const linkInput = document.getElementById('pixel-message-link');
        if (linkInput) {
            linkInput.addEventListener('input', (event) => this.handlePixelMessageLinkInput(event.target.value));
        }
        
        const saveBtn = document.getElementById('pixel-save-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', () => this.savePixelBundle());
        }
        
        this.setupPixelCanvas();
        this.updatePixelStoryCard();
    }
    
    setupPixelCanvas() {
        if (this.pixelEditorCanvas) return;
        const canvas = document.getElementById('pixel-editor-canvas');
        if (!canvas) return;
        
        this.pixelEditorCanvas = canvas;
        this.pixelEditorCtx = canvas.getContext('2d');
        this.pixelEditorState.canvasSize = 16;
        this.pixelEditorState.pixelMatrix = this.createEmptyPixelMatrix(this.pixelEditorState.canvasSize);
        
        const pointerDown = (event) => {
            event.preventDefault();
            this.pixelEditorState.isDrawing = true;
            this.paintPixelFromEvent(event);
        };
        const pointerMove = (event) => {
            if (!this.pixelEditorState.isDrawing) return;
            event.preventDefault();
            this.paintPixelFromEvent(event);
        };
        const pointerUp = () => {
            this.pixelEditorState.isDrawing = false;
        };
        
        canvas.addEventListener('mousedown', pointerDown);
        canvas.addEventListener('mousemove', pointerMove);
        window.addEventListener('mouseup', pointerUp);
        
        canvas.addEventListener('touchstart', pointerDown, { passive: false });
        canvas.addEventListener('touchmove', pointerMove, { passive: false });
        window.addEventListener('touchend', pointerUp);
        window.addEventListener('touchcancel', pointerUp);
        
        this.drawPixelEditorMatrix();
    }
    
    createEmptyPixelMatrix(size = 16) {
        return Array.from({ length: size }, () => Array(size).fill('transparent'));
    }
    
    clonePixelMatrix(matrix) {
        if (!Array.isArray(matrix)) {
            return this.createEmptyPixelMatrix(this.pixelEditorState.canvasSize);
        }
        return matrix.map((row) => Array.isArray(row) ? [...row] : Array(this.pixelEditorState.canvasSize).fill('transparent'));
    }
    
    drawPixelEditorMatrix(matrix = this.pixelEditorState.pixelMatrix) {
        this.renderMatrixToCanvas(matrix, this.pixelEditorCtx, this.pixelEditorCanvas);
    }
    
    renderMatrixToCanvas(matrix, ctx, canvas) {
        if (!ctx || !canvas || !matrix || matrix.length === 0) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        const size = matrix.length;
        const cellWidth = canvas.width / size;
        const cellHeight = canvas.height / size;
        
        for (let y = 0; y < size; y++) {
            for (let x = 0; x < size; x++) {
                const color = matrix[y][x];
                if (color && color !== 'transparent') {
                    ctx.fillStyle = color;
                    ctx.fillRect(x * cellWidth, y * cellHeight, cellWidth, cellHeight);
                }
            }
        }
        
        ctx.strokeStyle = 'rgba(255, 255, 255, 0.06)';
        ctx.lineWidth = 1;
        for (let i = 0; i <= size; i++) {
            const posX = i * cellWidth;
            const posY = i * cellHeight;
            ctx.beginPath();
            ctx.moveTo(posX, 0);
            ctx.lineTo(posX, canvas.height);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0, posY);
            ctx.lineTo(canvas.width, posY);
            ctx.stroke();
        }
    }
    
    paintPixelFromEvent(event) {
        if (!this.pixelEditorCanvas) return;
        const rect = this.pixelEditorCanvas.getBoundingClientRect();
        const point = event.touches ? event.touches[0] : event;
        const x = point.clientX - rect.left;
        const y = point.clientY - rect.top;
        const size = this.pixelEditorState.canvasSize;
        const cellWidth = rect.width / size;
        const cellHeight = rect.height / size;
        const col = Math.floor(x / cellWidth);
        const row = Math.floor(y / cellHeight);
        if (col < 0 || col >= size || row < 0 || row >= size) return;
        
        const brush = Math.max(1, this.pixelEditorState.brushSize || 1);
        for (let dy = 0; dy < brush; dy++) {
            for (let dx = 0; dx < brush; dx++) {
                const targetRow = row + dy;
                const targetCol = col + dx;
                if (targetRow < size && targetCol < size) {
                    this.pixelEditorState.pixelMatrix[targetRow][targetCol] = this.pixelEditorState.brushColor;
                }
            }
        }
        
        this.drawPixelEditorMatrix();
    }
    
    clearPixelCanvas() {
        this.pixelEditorState.pixelMatrix = this.createEmptyPixelMatrix(this.pixelEditorState.canvasSize);
        this.drawPixelEditorMatrix();
    }
    
    handlePixelColorChange(value) {
        if (!value) return;
        this.pixelEditorState.brushColor = value;
    }
    
    handlePixelBrushSize(size) {
        this.pixelEditorState.brushSize = size || 1;
    }
    
    handlePixelImageUpload(file) {
        if (!file) {
            this.pixelEditorState.imageDataUrl = '';
            const preview = document.getElementById('pixel-image-preview');
            if (preview) {
                preview.src = '';
                preview.style.display = 'none';
            }
            return;
        }
        
        const reader = new FileReader();
        reader.onload = () => {
            const result = reader.result;
            this.pixelEditorState.imageDataUrl = typeof result === 'string' ? result : '';
            const preview = document.getElementById('pixel-image-preview');
            if (preview) {
                preview.src = this.pixelEditorState.imageDataUrl;
                preview.style.display = 'block';
            }
        };
        reader.readAsDataURL(file);
    }
    
    handlePixelMessageInput(value) {
        this.pixelEditorState.messageText = value || '';
        this.updatePixelMessageCount();
    }
    
    handlePixelMessageLinkInput(value) {
        this.pixelEditorState.messageLink = value || '';
    }
    
    updatePixelMessageCount() {
        const countEl = document.getElementById('pixel-message-count');
        if (countEl) {
            const len = (this.pixelEditorState.messageText || '').length;
            countEl.textContent = `${len} / 140`;
        }
    }
    
    openPixelEditorModal() {
        if (!this.currentRegion) {
            this.showNotification('í¸ì§‘í•  ì§€ì—­ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” ë¡œê·¸ì¸ ì²´í¬ ìš°íšŒ
        if (!this.isAdminLoggedIn && !this.currentUser) {
            this.showNotification('í”½ì…€ì„ í¸ì§‘í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            this.showUserLoginModal();
            return;
        }
        const modal = document.getElementById('pixel-editor-modal');
        if (!modal) return;
        
        this.initializePixelExperienceUI();
        const regionLabel = document.getElementById('pixel-editor-region-label');
        if (regionLabel) {
            const regionName = this.getRegionDisplayName(this.currentRegion);
            if (this.isAdminLoggedIn && this.adminMode) {
                regionLabel.textContent = `[ê´€ë¦¬ì ëª¨ë“œ] ì„ íƒëœ ì§€ì—­: ${regionName}`;
            } else {
                regionLabel.textContent = `ì„ íƒëœ ì§€ì—­: ${regionName}`;
            }
        }
        
        const existingBundle = this.getLatestPixelBundle(this.currentRegion.id);
        this.populatePixelEditorFromBundle(existingBundle);
        modal.classList.remove('hidden');
        modal.style.display = 'flex'; // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš©
    }
    
    closePixelEditorModal() {
        const modal = document.getElementById('pixel-editor-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    }
    
    setPixelEditorMode(mode, options = {}) {
        if (!mode) return;
        this.pixelEditorState.mode = mode;
        document.querySelectorAll('.pixel-mode-btn').forEach((btn) => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        ['canvas', 'image', 'message'].forEach((panelKey) => {
            const panel = document.getElementById(`pixel-panel-${panelKey}`);
            if (panel) {
                panel.classList.toggle('hidden', panelKey !== mode);
            }
        });
        if (!options.skipScroll) {
            const modal = document.getElementById('pixel-editor-modal');
            modal?.scrollTo({ top: 0, behavior: 'smooth' });
        }
    }
    
    populatePixelEditorFromBundle(bundle) {
        const messageInput = document.getElementById('pixel-message-input');
        const linkInput = document.getElementById('pixel-message-link');
        const imagePreview = document.getElementById('pixel-image-preview');
        
        if (!bundle) {
            this.activePixelBundleId = null;
            this.pixelEditorState.pixelMatrix = this.createEmptyPixelMatrix(this.pixelEditorState.canvasSize);
            this.pixelEditorState.imageDataUrl = '';
            this.pixelEditorState.messageText = '';
            this.pixelEditorState.messageLink = '';
            if (messageInput) messageInput.value = '';
            if (linkInput) linkInput.value = '';
            if (imagePreview) {
                imagePreview.src = '';
                imagePreview.style.display = 'none';
            }
            this.setPixelEditorMode('canvas', { skipScroll: true });
            this.drawPixelEditorMatrix();
            this.updatePixelMessageCount();
            this.syncPixelProtectionLabel(null);
            return;
        }
        
        this.activePixelBundleId = bundle.id;
        this.pixelEditorState.messageText = bundle.message || '';
        this.pixelEditorState.messageLink = bundle.messageLink || '';
        if (messageInput) messageInput.value = this.pixelEditorState.messageText;
        if (linkInput) linkInput.value = this.pixelEditorState.messageLink;
        
        if (bundle.artType === 'canvas' && Array.isArray(bundle.pixelMatrix)) {
            this.pixelEditorState.pixelMatrix = this.clonePixelMatrix(bundle.pixelMatrix);
            this.setPixelEditorMode('canvas', { skipScroll: true });
            this.drawPixelEditorMatrix(this.pixelEditorState.pixelMatrix);
        } else if (bundle.artType === 'image' && bundle.imageData) {
            this.pixelEditorState.imageDataUrl = bundle.imageData;
            this.setPixelEditorMode('image', { skipScroll: true });
            if (imagePreview) {
                imagePreview.src = bundle.imageData;
                imagePreview.style.display = 'block';
            }
        } else {
            this.setPixelEditorMode('message', { skipScroll: true });
        }
        
        const ownerLabel = document.getElementById('pixel-editor-owner');
        if (ownerLabel) {
            ownerLabel.textContent = bundle.ownerName ? `ì†Œìœ ì: ${bundle.ownerName}` : '';
        }
        this.syncPixelProtectionLabel(bundle);
        this.updatePixelMessageCount();
    }
    
    syncPixelProtectionLabel(bundle) {
        const protectionChip = document.getElementById('pixel-editor-protection');
        if (!protectionChip) return;
        if (!bundle || !bundle.protectionEndsAt) {
            protectionChip.classList.add('hidden');
            return;
        }
        protectionChip.classList.remove('hidden');
        protectionChip.textContent = `ë³´í˜¸ ${this.formatProtectionCountdown(bundle.protectionEndsAt)}`;
    }
    
    async savePixelBundle() {
        if (!this.currentRegion) {
            this.showNotification('í¸ì§‘í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” ë¡œê·¸ì¸ ì²´í¬ ìš°íšŒ
        if (!this.isAdminLoggedIn && !this.currentUser) {
            this.showNotification('ë¡œê·¸ì¸ í›„ ì €ì¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
            this.showUserLoginModal();
            return;
        }
        if (!this.isFirebaseInitialized || !this.firestore) {
            this.showNotification('Firebase ë™ê¸°í™” í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        if (this.isSavingPixelBundle) return;
        
        const artType = this.pixelEditorState.mode || 'canvas';
        if (artType === 'canvas' && (!this.pixelEditorState.pixelMatrix || this.pixelEditorState.pixelMatrix.length === 0)) {
            this.showNotification('í”½ì…€ ì•„íŠ¸ë¥¼ ë¨¼ì € ê·¸ë ¤ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        if (artType === 'image' && !this.pixelEditorState.imageDataUrl) {
            this.showNotification('ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        if (artType === 'message' && !this.pixelEditorState.messageText) {
            this.showNotification('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        this.isSavingPixelBundle = true;
        try {
            const { doc, setDoc, serverTimestamp, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const regionId = this.currentRegion.id;
            const bundleId = this.activePixelBundleId || 'default';
            const docRef = doc(this.firestore, 'regions', regionId, 'pixelBundles', bundleId);
            const protectionHours = this.pixelProtectionHours || this.auctionConfig.protectionHours || 12;
            const protectionEndsAt = Timestamp.fromDate(new Date(Date.now() + protectionHours * 60 * 60 * 1000));
            
            // ê´€ë¦¬ì ëª¨ë“œì¼ ë•ŒëŠ” ê´€ë¦¬ì ì •ë³´ ì‚¬ìš©, ì¼ë°˜ ì‚¬ìš©ìì¼ ë•ŒëŠ” currentUser ì‚¬ìš©
            const ownerId = this.isAdminLoggedIn && this.adminMode 
                ? 'admin' 
                : (this.currentUser?.uid || 'anonymous');
            const ownerName = this.isAdminLoggedIn && this.adminMode
                ? 'ê´€ë¦¬ì'
                : (this.currentUser?.displayName || this.currentUser?.email || 'ìµëª…');
            
            const payload = {
                ownerId: ownerId,
                ownerName: ownerName,
                artType,
                regionId,
                bundleId,
                message: this.pixelEditorState.messageText || '',
                messageLink: this.pixelEditorState.messageLink || '',
                updatedAt: serverTimestamp(),
                protectionEndsAt,
                isAdminEdit: this.isAdminLoggedIn && this.adminMode // ê´€ë¦¬ì í¸ì§‘ ì—¬ë¶€ í‘œì‹œ
            };
            
            if (artType === 'canvas') {
                payload.pixelMatrix = this.clonePixelMatrix(this.pixelEditorState.pixelMatrix);
            } else if (artType === 'image') {
                payload.imageData = this.pixelEditorState.imageDataUrl;
            }
            
            if (!this.activePixelBundleId) {
                payload.createdAt = serverTimestamp();
            }
            
            await setDoc(docRef, payload, { merge: true });
            
            // í”½ì…€ ìƒì„± ì‹œ ë¯¸ì…˜ ìë™ ì™„ë£Œ ì²˜ë¦¬
            await this.checkAndCompletePixelMissions();
            
            // ì—…ì  í™•ì¸ ë° ë±ƒì§€ ì§€ê¸‰
            await this.checkAchievements();
            
            // ì‹œì¦Œ ë°ì´í„° ì—…ë°ì´íŠ¸ (soldPixels ì¦ê°€)
            await this.incrementSeasonSoldPixels();
            
            this.showNotification('í”½ì…€ ìŠ¤í† ë¦¬ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            this.closePixelEditorModal();
        } catch (error) {
            console.error('í”½ì…€ ìŠ¤í† ë¦¬ ì €ì¥ ì‹¤íŒ¨:', error);
            this.showNotification('í”½ì…€ ìŠ¤í† ë¦¬ë¥¼ ì €ì¥í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
        } finally {
            this.isSavingPixelBundle = false;
        }
    }
    
    // í”½ì…€ ìƒì„± ê´€ë ¨ ë¯¸ì…˜ ìë™ ì™„ë£Œ ì²˜ë¦¬
    async checkAndCompletePixelMissions() {
        if (!this.currentUser) {
            return;
        }
        
        try {
            // 'create_pixel' íƒ€ì… ë¯¸ì…˜ ì°¾ê¸°
            const pixelMission = this.communityMissions.find(m => m.type === 'create_pixel' && !m.completed);
            if (pixelMission) {
                await this.completeMission(pixelMission.id);
            }
            
            // í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ì ì—…ë°ì´íŠ¸
            if (this.currentFlashChallenge) {
                await this.updateFlashChallengeParticipation().catch(err => {
                    console.warn('í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ì ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
                });
            }
        } catch (error) {
            console.error('í”½ì…€ ë¯¸ì…˜ í™•ì¸ ë° ì™„ë£Œ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì‹œì¦Œ soldPixels ì¦ê°€
    async incrementSeasonSoldPixels() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ì‹œì¦Œ í”½ì…€ ìˆ˜ ì—…ë°ì´íŠ¸: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { doc, getDoc, setDoc, increment, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const seasonRef = doc(this.firestore, 'seasons', this.currentSeason.id);
            const seasonDoc = await getDoc(seasonRef);
            
            if (seasonDoc.exists) {
                const currentData = seasonDoc.data();
                const newSoldPixels = (currentData.soldPixels || 0) + 1;
                
                await setDoc(seasonRef, {
                    soldPixels: newSoldPixels,
                    updatedAt: Timestamp.now()
                }, { merge: true });
                
                // ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
                this.currentSeason.soldPixels = newSoldPixels;
                
                // ì™„íŒ ì²´í¬ ë° ìë™ ì•„ì¹´ì´ë¸Œ ì „í™˜
                if (newSoldPixels >= (currentData.totalPixels || this.currentSeason.totalPixels)) {
                    await this.archiveSeasonWhenSoldOut(this.currentSeason.id).catch(err => {
                        console.error('ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ì‹¤íŒ¨:', err);
                    });
                }
            } else {
                console.warn('ì‹œì¦Œ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', this.currentSeason.id);
                // ì‹œì¦Œ ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ìƒì„± ì‹œë„
                await this.createSeasonInFirestore(this.currentSeason).catch(err => {
                    console.error('ì‹œì¦Œ ìƒì„± ì‹¤íŒ¨:', err);
                });
            }
        } catch (error) {
            console.error('ì‹œì¦Œ í”½ì…€ ìˆ˜ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ì‹œì¦Œ í”½ì…€ ìˆ˜ ì—…ë°ì´íŠ¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    async subscribePixelBundles(regionId) {
        if (!this.isFirebaseInitialized || !this.firestore || !regionId) return;
        if (this.activePixelSubscriptionRegion === regionId && this.pixelBundleUnsubscribe) {
            this.updatePixelStoryCard(regionId);
            return;
        }
        if (this.pixelBundleUnsubscribe) {
            this.pixelBundleUnsubscribe();
            this.pixelBundleUnsubscribe = null;
        }
        this.activePixelSubscriptionRegion = regionId;
        
        try {
            const { collection, onSnapshot, orderBy, query } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const bundlesRef = collection(this.firestore, 'regions', regionId, 'pixelBundles');
            const q = query(bundlesRef, orderBy('updatedAt', 'desc'));
            this.pixelBundleUnsubscribe = onSnapshot(q, (snapshot) => {
                const bundles = [];
                snapshot.forEach((docSnap) => bundles.push({ id: docSnap.id, ...docSnap.data() }));
                this.pixelBundleCache.set(regionId, bundles);
                this.updatePixelStoryCard(regionId);
                if (this.currentRegion && this.currentRegion.id === regionId) {
                    this.syncPixelProtectionLabel(this.getLatestPixelBundle(regionId));
                }
                // í”½ì…€ ë ˆì´ì–´ê°€ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                if (this.pixelLayerVisible) {
                    this.renderPixelLayer();
                }
            }, (error) => {
                console.error('í”½ì…€ ë°ì´í„° êµ¬ë… ì˜¤ë¥˜:', error);
                this.showNotification('í”½ì…€ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'warning');
            });
        } catch (error) {
            console.error('í”½ì…€ ë°ì´í„° êµ¬ë… ì‹¤íŒ¨:', error);
        }
    }
    
    getLatestPixelBundle(regionId) {
        if (!regionId) return null;
        const bundles = this.pixelBundleCache.get(regionId);
        if (!bundles || bundles.length === 0) return null;
        return bundles[0];
    }
    
    updatePixelStoryCard(regionId) {
        const targetRegionId = regionId || (this.currentRegion && this.currentRegion.id);
        if (!targetRegionId) return;
        const bundle = this.getLatestPixelBundle(targetRegionId);
        const messageEl = document.getElementById('pixel-story-message');
        const ownerEl = document.getElementById('pixel-story-owner');
        
        if (!messageEl || !ownerEl) return;
        
        if (!bundle) {
            messageEl.textContent = 'ì•„ì§ ë“±ë¡ëœ í”½ì…€ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
            ownerEl.textContent = '';
            this.clearPixelPreview();
            this.updatePixelProtectionChip(null);
            return;
        }
        
        ownerEl.textContent = bundle.ownerName ? `ì†Œìœ ì: ${bundle.ownerName}` : '';
        if (bundle.message) {
            messageEl.textContent = bundle.message;
        } else if (bundle.artType === 'image') {
            messageEl.textContent = 'ì´ë¯¸ì§€ í”½ì…€ ìŠ¤í† ë¦¬ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.';
        } else {
            messageEl.textContent = 'í”½ì…€ ì•„íŠ¸ë¥¼ ê°ìƒí•´ë³´ì„¸ìš”.';
        }
        this.applyPixelBundleToPreview(bundle);
        this.updatePixelProtectionChip(bundle);
        
        // ë¸Œëœë“œ ì •ë³´ í†µí•© í‘œì‹œ
        this.updatePixelStoryBrandInfo(targetRegionId);
    }
    
    // í”½ì…€ ìŠ¤í† ë¦¬ì— ë¸Œëœë“œ ì •ë³´ í†µí•© í‘œì‹œ
    async updatePixelStoryBrandInfo(regionId) {
        const brandSection = document.getElementById('pixel-story-brand');
        const brandNameEl = document.getElementById('brand-name');
        const brandLogoEl = document.getElementById('brand-logo');
        const brandDescEl = document.getElementById('brand-description');
        const brandLinkEl = document.getElementById('brand-link');
        
        if (!brandSection || !brandNameEl || !brandDescEl) return;
        
        try {
            // ê¸°ì—… ì •ë³´ ê°€ì ¸ì˜¤ê¸° (ì§€ì—­ë³„)
            const region = this.regionData.get(regionId);
            if (!region) {
                brandSection.classList.add('hidden');
                return;
            }
            
            // ê¸°ì—… ì •ë³´ í™•ì¸ (country_codeì— ë”°ë¼ ë‹¤ë¥¸ ë°ì´í„° ì†ŒìŠ¤ ì‚¬ìš©)
            const countryCode = region.country_code || region.countryCode;
            let companyData = null;
            
            if (countryCode === 'KR') {
                companyData = this.koreaCompanyData[regionId];
            } else if (countryCode === 'JP') {
                companyData = this.japanCompanyData[regionId];
            } else {
                companyData = this.companyData[regionId];
            }
            
            if (companyData && (companyData.name || companyData.description || companyData.website)) {
                // ë¸Œëœë“œ ì •ë³´ í‘œì‹œ
                brandSection.classList.remove('hidden');
                
                if (companyData.name) {
                    brandNameEl.textContent = companyData.name;
                } else {
                    brandNameEl.textContent = 'ë¸Œëœë“œ ì •ë³´';
                }
                
                if (companyData.logo && brandLogoEl) {
                    brandLogoEl.src = companyData.logo;
                    brandLogoEl.classList.remove('hidden');
                } else if (brandLogoEl) {
                    brandLogoEl.classList.add('hidden');
                }
                
                if (companyData.description) {
                    brandDescEl.textContent = companyData.description;
                } else {
                    brandDescEl.textContent = '';
                }
                
                if (companyData.website && brandLinkEl) {
                    brandLinkEl.href = companyData.website;
                    brandLinkEl.classList.remove('hidden');
                } else if (bundle?.messageLink && brandLinkEl) {
                    // í”½ì…€ ìŠ¤í† ë¦¬ì˜ ë§í¬ ì‚¬ìš©
                    brandLinkEl.href = bundle.messageLink;
                    brandLinkEl.classList.remove('hidden');
                } else if (brandLinkEl) {
                    brandLinkEl.classList.add('hidden');
                }
            } else {
                // í”½ì…€ ìŠ¤í† ë¦¬ì— ë§í¬ê°€ ìˆëŠ” ê²½ìš°ë§Œ í‘œì‹œ
                const bundle = this.getLatestPixelBundle(regionId);
                if (bundle?.messageLink && brandLinkEl) {
                    brandSection.classList.remove('hidden');
                    brandNameEl.textContent = 'ë” ì•Œì•„ë³´ê¸°';
                    brandDescEl.textContent = bundle.message || '';
                    brandLinkEl.href = bundle.messageLink;
                    brandLinkEl.classList.remove('hidden');
                    if (brandLogoEl) brandLogoEl.classList.add('hidden');
                } else {
                    brandSection.classList.add('hidden');
                }
            }
        } catch (error) {
            console.error('ë¸Œëœë“œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            brandSection.classList.add('hidden');
        }
    }
    
    applyPixelBundleToPreview(bundle) {
        if (!this.pixelPreviewCanvas || !this.pixelPreviewCtx) return;
        if (!bundle) {
            this.clearPixelPreview();
            return;
        }
        if (bundle.artType === 'canvas' && Array.isArray(bundle.pixelMatrix)) {
            this.renderMatrixToCanvas(bundle.pixelMatrix, this.pixelPreviewCtx, this.pixelPreviewCanvas);
        } else if (bundle.artType === 'image' && bundle.imageData) {
            this.drawImageOnPreview(bundle.imageData);
        } else {
            this.clearPixelPreview();
        }
    }
    
    clearPixelPreview() {
        if (!this.pixelPreviewCtx || !this.pixelPreviewCanvas) return;
        this.pixelPreviewCtx.clearRect(0, 0, this.pixelPreviewCanvas.width, this.pixelPreviewCanvas.height);
        this.pixelPreviewCtx.fillStyle = '#05070f';
        this.pixelPreviewCtx.fillRect(0, 0, this.pixelPreviewCanvas.width, this.pixelPreviewCanvas.height);
    }
    
    drawImageOnPreview(imageData) {
        if (!this.pixelPreviewCtx || !this.pixelPreviewCanvas) return;
        const img = new Image();
        img.onload = () => {
            this.pixelPreviewCtx.clearRect(0, 0, this.pixelPreviewCanvas.width, this.pixelPreviewCanvas.height);
            this.pixelPreviewCtx.drawImage(img, 0, 0, this.pixelPreviewCanvas.width, this.pixelPreviewCanvas.height);
        };
        img.src = imageData;
    }
    
    updatePixelProtectionChip(bundle) {
        const chip = document.getElementById('pixel-protection-chip');
        if (!chip) return;
        if (!bundle || !bundle.protectionEndsAt) {
            chip.classList.add('hidden');
            return;
        }
        chip.classList.remove('hidden');
        chip.textContent = this.formatProtectionCountdown(bundle.protectionEndsAt);
    }
    
    togglePixelLayerVisibility() {
        this.pixelLayerVisible = !this.pixelLayerVisible;
        const button = document.getElementById('pixel-layer-toggle');
        button?.classList.toggle('active', this.pixelLayerVisible);
        if (!this.map) return;
        
        if (this.pixelLayerVisible) {
            this.renderPixelLayer();
            // í˜„ì¬ ì„ íƒëœ ì§€ì—­ì´ ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì—­ìœ¼ë¡œ í”½ì…€ ë ˆë²¨ ì¤Œ
            if (this.currentRegion) {
                this.zoomToPixelLevel(this.currentRegion.id);
            } else {
                // ì„ íƒëœ ì§€ì—­ì´ ì—†ìœ¼ë©´ ê¸°ë³¸ ì¤Œ
                const targetZoom = Math.max(this.map.getZoom(), 8);
                this.map.easeTo({ zoom: targetZoom, duration: 800 });
            }
            this.showNotification('í”½ì…€ ë ˆë²¨ ë ˆì´ì–´ë¥¼ í‘œì‹œí–ˆìŠµë‹ˆë‹¤.', 'info');
        } else {
            this.hidePixelLayer();
            this.exitPixelDetailMode();
            this.showNotification('í”½ì…€ ë ˆë²¨ ë ˆì´ì–´ë¥¼ ìˆ¨ê²¼ìŠµë‹ˆë‹¤.', 'info');
        }
    }
    
    // í”½ì…€ ë ˆì´ì–´ ë Œë”ë§
    async renderPixelLayer() {
        if (!this.map || !this.pixelLayerVisible) return;
        
        // í”½ì…€ ë§ˆì»¤ë¥¼ ìœ„í•œ GeoJSON ë°ì´í„° ìƒì„±
        const pixelFeatures = [];
        
        this.regionData.forEach((region, regionId) => {
            const bundle = this.getLatestPixelBundle(regionId);
            if (!bundle) return;
            
            // ì§€ì—­ì˜ ì¤‘ì‹¬ì  ê³„ì‚° (ê°„ë‹¨í•˜ê²Œ bounding boxì˜ ì¤‘ì‹¬ ì‚¬ìš©)
            const source = this.map.getSource('world-regions');
            if (!source || !source._data) return;
            
            const feature = source._data.features.find(f => f.properties.id === regionId);
            if (!feature || !feature.geometry) return;
            
            let center = null;
            if (feature.geometry.type === 'Polygon') {
                const coords = feature.geometry.coordinates[0];
                const lons = coords.map(c => c[0]);
                const lats = coords.map(c => c[1]);
                center = [
                    (Math.min(...lons) + Math.max(...lons)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                ];
            } else if (feature.geometry.type === 'MultiPolygon') {
                const allCoords = feature.geometry.coordinates.flat();
                const lons = allCoords.flat().map(c => c[0]);
                const lats = allCoords.flat().map(c => c[1]);
                center = [
                    (Math.min(...lons) + Math.max(...lons)) / 2,
                    (Math.min(...lats) + Math.max(...lats)) / 2
                ];
            }
            
            if (center) {
                pixelFeatures.push({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: center
                    },
                    properties: {
                        regionId: regionId,
                        bundleId: bundle.bundleId || 'default'
                    }
                });
            }
        });
        
        if (pixelFeatures.length === 0) return;
        
        // í”½ì…€ ë§ˆì»¤ ì†ŒìŠ¤ ì¶”ê°€/ì—…ë°ì´íŠ¸
        const pixelSourceId = 'pixel-markers';
        if (this.map.getSource(pixelSourceId)) {
            this.map.getSource(pixelSourceId).setData({
                type: 'FeatureCollection',
                features: pixelFeatures
            });
        } else {
            this.map.addSource(pixelSourceId, {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: pixelFeatures
                }
            });
        }
        
        // í”½ì…€ ë§ˆì»¤ ë ˆì´ì–´ ì¶”ê°€
        if (!this.map.getLayer('pixel-markers')) {
            this.map.addLayer({
                id: 'pixel-markers',
                type: 'circle',
                source: pixelSourceId,
                paint: {
                    'circle-radius': [
                        'interpolate',
                        ['linear'],
                        ['zoom'],
                        5, 8,
                        10, 16,
                        15, 32
                    ],
                    'circle-color': '#4ecdc4',
                    'circle-stroke-width': 2,
                    'circle-stroke-color': '#ffffff',
                    'circle-opacity': 0.8
                }
            });
            
            // í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€ - í”½ì…€ ìŠ¤í† ë¦¬ ì¹´ë“œ í‘œì‹œ
            this.map.on('click', 'pixel-markers', (e) => {
                const regionId = e.features[0].properties.regionId;
                const bundleId = e.features[0].properties.bundleId || 'default';
                const region = this.regionData.get(regionId);
                if (region) {
                    // í”½ì…€ ìŠ¤í† ë¦¬ ì¹´ë“œ í‘œì‹œ
                    this.showPixelStoryCardFromMap(regionId, bundleId);
                    // ì •ë³´ íŒ¨ë„ë„ í‘œì‹œ
                    this.showInfoPanel(region);
                    // í”½ì…€ ë ˆë²¨ë¡œ í™•ëŒ€ (ì¤Œ ë ˆë²¨ 12 ì´ìƒ)
                    this.map.flyTo({
                        center: e.lngLat,
                        zoom: Math.max(this.map.getZoom() + 2, 12),
                        duration: 1000
                    });
                    // í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œ í™œì„±í™”
                    this.enterPixelDetailMode(regionId);
                }
            });
            
            // í˜¸ë²„ íš¨ê³¼
            this.map.on('mouseenter', 'pixel-markers', () => {
                this.map.getCanvas().style.cursor = 'pointer';
            });
            
            this.map.on('mouseleave', 'pixel-markers', () => {
                this.map.getCanvas().style.cursor = '';
            });
        }
    }
    
    // í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œ ì§„ì…
    enterPixelDetailMode(regionId) {
        this.pixelDetailMode = true;
        this.pixelDetailRegionId = regionId;
        
        const region = this.regionData.get(regionId);
        if (region && this.map) {
            // ì§€ì—­ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
            const source = this.map.getSource('world-regions');
            if (source && source._data) {
                const feature = source._data.features.find(f => f.properties.id === regionId);
                if (feature && feature.geometry) {
                    let center = null;
                    if (feature.geometry.type === 'Polygon') {
                        const coords = feature.geometry.coordinates[0];
                        const lons = coords.map(c => c[0]);
                        const lats = coords.map(c => c[1]);
                        center = [
                            (Math.min(...lons) + Math.max(...lons)) / 2,
                            (Math.min(...lats) + Math.max(...lats)) / 2
                        ];
                    } else if (feature.geometry.type === 'MultiPolygon') {
                        const allCoords = feature.geometry.coordinates.flat();
                        const lons = allCoords.flat().map(c => c[0]);
                        const lats = allCoords.flat().map(c => c[1]);
                        center = [
                            (Math.min(...lons) + Math.max(...lons)) / 2,
                            (Math.min(...lats) + Math.max(...lats)) / 2
                        ];
                    }
                    
                    if (center) {
                        // í”½ì…€ ë ˆë²¨ë¡œ í™•ëŒ€ (ì¤Œ ë ˆë²¨ 12 ì´ìƒ)
                        this.map.flyTo({
                            center: center,
                            zoom: Math.max(this.map.getZoom(), 12),
                            duration: 1000
                        });
                    }
                }
            }
            
            // ì•Œë¦¼ í‘œì‹œ
            this.showNotification('í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œë¡œ ì „í™˜ë˜ì—ˆìŠµë‹ˆë‹¤. ESC í‚¤ë¥¼ ëˆŒëŸ¬ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'info');
        }
    }
    
    // í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œ ì¢…ë£Œ
    exitPixelDetailMode() {
        this.pixelDetailMode = false;
        this.pixelDetailRegionId = null;
        this.showNotification('í”½ì…€ ìƒì„¸ ë³´ê¸° ëª¨ë“œê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
    }
    
    // í”½ì…€ ë ˆì´ì–´ ìˆ¨ê¸°ê¸°
    hidePixelLayer() {
        if (!this.map) return;
        
        if (this.map.getLayer('pixel-markers')) {
            this.map.removeLayer('pixel-markers');
        }
        
        if (this.map.getSource('pixel-markers')) {
            this.map.removeSource('pixel-markers');
        }
    }
    
    hideInfoPanel() {
        const panel = document.getElementById('info-panel');
        panel.classList.add('hidden');
        
        // í•˜ì´ë¼ì´íŠ¸ ì œê±°
        this.map.setFilter('regions-hover', ['==', 'id', '']);
        this.currentRegion = null;
    }
    
    // ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ PayPal ë²„íŠ¼ ë Œë”ë§
    autoRenderPayPalButtons() {
        if (!this.currentRegion || !this.currentUser) {
            return;
        }
        
        // í˜„ì¬ ì—´ë ¤ìˆëŠ” ëª¨ë‹¬/íŒ¨ë„ í™•ì¸
        const infoPanel = document.getElementById('info-panel');
        const regionModal = document.getElementById('region-info-modal');
        const companyModal = document.getElementById('company-info-modal');
        
        // ì •ë³´ íŒ¨ë„ì´ ì—´ë ¤ìˆìœ¼ë©´
        if (infoPanel && !infoPanel.classList.contains('hidden')) {
            this.renderPayPalButtons('paypal-buttons', this.currentRegion);
        }
        // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´
        else if (regionModal && !regionModal.classList.contains('hidden')) {
            this.renderPayPalButtons('region-paypal-buttons', this.currentRegion);
        }
        // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ì´ ì—´ë ¤ìˆìœ¼ë©´
        else if (companyModal && !companyModal.classList.contains('hidden')) {
            this.renderPayPalButtons('company-paypal-buttons', this.currentRegion);
        }
    }
    
    // PayPal ë²„íŠ¼ ë Œë”ë§
    renderPayPalButtons(containerId, region, options = {}) {
        try {
            const container = document.getElementById(containerId);
            if (!container) return;
            // ë¹„ì–´ìˆê²Œ ì´ˆê¸°í™” (ì¤‘ë³µ ë Œë” ì œê±°)
            container.innerHTML = '';
            
            if (!(window.paypal && window.paypal.Buttons)) {
                this.showNotification('ê²°ì œ ëª¨ë“ˆì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const regionConfig = this.getRegionAuctionConfig(region);
            const overrideAmount = typeof options.overrideAmount === 'number' ? options.overrideAmount : null;
            const fallbackAmount = (region && typeof region.ad_price === 'number' && region.ad_price > 0)
                ? region.ad_price
                : (this.uniformAdPrice || 1000);
            const preferredBuyNow = regionConfig?.buyNowPrice && region?.ad_status === 'auction'
                ? regionConfig.buyNowPrice
                : null;
            const amount = overrideAmount ?? preferredBuyNow ?? fallbackAmount;
            const description = region
                ? `${region.country} - ${this.getRegionDisplayName(region)} (${region.id})`
                : 'ì„¸ê³„ì§€ë„ ê´‘ê³  êµ¬ë§¤';
            
            window.paypal.Buttons({
                style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },
                createOrder: (data, actions) => {
                    return actions.order.create({
                        purchase_units: [{
                            description: description,
                            amount: {
                                currency_code: 'USD',
                                value: String(amount)
                            }
                        }]
                    });
                },
                onApprove: async (data, actions) => {
                    try {
                        const details = await actions.order.capture();
                        
                        // êµ¬ë§¤ì ì´ë©”ì¼ ì¶”ì¶œ (PayPal ê²°ì œ ì •ë³´ì—ì„œ)
                        const buyerEmail = details.payer?.email_address || details.payer?.payer_info?.email || null;
                        const orderId = details.id;
                        
                        // Firestoreì— êµ¬ë§¤ ê¸°ë¡ ì €ì¥
                        if (this.isFirebaseInitialized) {
                            await this.savePurchaseToFirestore(
                                region.id,
                                this.getRegionDisplayName(region),
                                orderId,
                                buyerEmail || 'unknown@example.com',
                                amount
                            );
                        }
                        
                        // ê²°ì œ ì„±ê³µ ì²˜ë¦¬: ì§€ì—­ ì ìœ ë¡œ í‘œì‹œ
                        region.ad_status = 'occupied';
                        // ì§€ì—­ ìƒíƒœ ì—…ë°ì´íŠ¸
                        this.updateRegionStatus(region.id, true);
                        this.showNotification('êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì§€ì—­ì´ ê´‘ê³  ì¤‘ ìƒíƒœë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                        // íŒ¨ë„/ëª¨ë‹¬ UI ê°±ì‹ 
                        this.showInfoPanel(region);
                        // í†µê³„ ì—…ë°ì´íŠ¸
                        this.updateStatistics();
                        // ë²„íŠ¼ ë¹„í™œì„±í™”
                        container.innerHTML = '<div style="color:#2ecc71;font-weight:600;">ê²°ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.</div>';
                        
                        // êµ¬ë§¤ ì™„ë£Œ í›„ í”½ì…€ ì—ë””í„° ìë™ ì—´ê¸°
                        setTimeout(() => {
                            this.openPixelEditorModal();
                            this.showNotification('í”½ì…€ ì—ë””í„°ê°€ ì—´ë ¸ìŠµë‹ˆë‹¤. ì§€ì—­ì— í”½ì…€ ìŠ¤í† ë¦¬ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!', 'info');
                        }, 500);
                        
                        console.log('PayPal capture result:', details);
                    } catch (err) {
                        console.error('Capture error:', err);
                        this.showNotification('ê²°ì œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                },
                onCancel: () => {
                    this.showNotification('ê²°ì œê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                },
                onError: (err) => {
                    console.error('PayPal error:', err);
                    this.showNotification('ê²°ì œ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            }).render(`#${containerId}`);
        } catch (e) {
            console.error('renderPayPalButtons error:', e);
            this.showNotification('ê²°ì œ ë²„íŠ¼ ë Œë”ë§ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    zoomToLevel(level) {
        const zoom = this.zoomLevels[level];
        this.map.easeTo({
            zoom: zoom,
            duration: 1000
        });
    }
    
    updateZoomLevel() {
        const currentZoom = this.map.getZoom();
        // ë””ë²„ê·¸ ë¡œê·¸ ì œê±° (ì„±ëŠ¥ í–¥ìƒ)
        // console.log('í˜„ì¬ ì¤Œ ë ˆë²¨:', currentZoom);
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í–‰ì •êµ¬ì—­ í‘œì‹œ ì¡°ì •
        if (currentZoom < 3) {
            // ì „ ì„¸ê³„ ë ˆë²¨ - êµ­ê°€ë§Œ í‘œì‹œ
            this.map.setLayoutProperty('regions-fill', 'visibility', 'visible');
        } else if (currentZoom < 6) {
            // êµ­ê°€ ë ˆë²¨ - ì£¼/ì„± ë‹¨ìœ„ í‘œì‹œ
            this.map.setLayoutProperty('regions-fill', 'visibility', 'visible');
        } else {
            // ì§€ì—­ ë ˆë²¨ - ì‹œ/êµ°/êµ¬ ë‹¨ìœ„ í‘œì‹œ
            this.map.setLayoutProperty('regions-fill', 'visibility', 'visible');
        }
    }
    
    purchaseRegion() {
        if (!this.currentRegion) {
            this.showNotification('êµ¬ë§¤í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        if (this.currentRegion.occupied) {
            this.showNotification('ì´ë¯¸ ê´‘ê³ ê°€ ì§„í–‰ ì¤‘ì¸ ì§€ì—­ì…ë‹ˆë‹¤.', 'error');
            return;
        }
        
        // êµ¬ë§¤ í™•ì¸ ëª¨ë‹¬ í‘œì‹œ
        this.showPurchaseModal(this.currentRegion);
    }
    
    showPurchaseModal(region) {
        // ê¸°ì¡´ ëª¨ë‹¬ ì œê±°
        this.hidePurchaseModal();
        
        // ëª¨ë‹¬ ìƒì„±
        const modal = document.createElement('div');
        modal.id = 'purchase-modal';
        modal.className = 'purchase-modal';
        modal.innerHTML = `
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ì§€ì—­ ê´‘ê³  êµ¬ë§¤</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="region-summary">
                        <h4>${this.getRegionDisplayName(region)}</h4>
                        <p><strong>êµ­ê°€:</strong> ${region.country}</p>
                        <p><strong>ì¸êµ¬:</strong> ${region.population.toLocaleString()}ëª…</p>
                        <p><strong>ë©´ì :</strong> ${region.area.toLocaleString()} kmÂ²</p>
                        <p><strong>1ì¸ë‹¹ GDP:</strong> $${region.gdp_per_capita.toLocaleString()}</p>
                    </div>
                    <div class="pricing-info">
                        <h4>ê°€ê²© ì •ë³´</h4>
                        <div class="price-breakdown">
                            <p>ê¸°ë³¸ ê°€ê²©: $${region.price.toLocaleString()}</p>
                            <p>ì¸êµ¬ ê°€ì¤‘ì¹˜: ${(region.population / 1000000).toFixed(1)}M</p>
                            <p>ë©´ì  ê°€ì¤‘ì¹˜: ${(region.area / 1000).toFixed(1)}K kmÂ²</p>
                        </div>
                        <div class="total-price">
                            <strong>ì´ ê°€ê²©: $${region.price.toLocaleString()}</strong>
                        </div>
                    </div>
                    <div class="purchase-form">
                        <h4>ê´‘ê³  ì •ë³´</h4>
                        <input type="text" id="advertiser-name" placeholder="ê´‘ê³ ì£¼ëª…" required>
                        <input type="url" id="advertiser-website" placeholder="ì›¹ì‚¬ì´íŠ¸ URL">
                        <textarea id="ad-description" placeholder="ê´‘ê³  ì„¤ëª… (ì„ íƒì‚¬í•­)" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel">ì·¨ì†Œ</button>
                    <button class="btn-purchase">êµ¬ë§¤í•˜ê¸°</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        modal.querySelector('.modal-close').addEventListener('click', () => {
            this.hidePurchaseModal();
        });
        
        modal.querySelector('.modal-overlay').addEventListener('click', () => {
            this.hidePurchaseModal();
        });
        
        modal.querySelector('.btn-cancel').addEventListener('click', () => {
            this.hidePurchaseModal();
        });
        
        modal.querySelector('.btn-purchase').addEventListener('click', () => {
            this.processPurchase(region);
        });
    }
    
    hidePurchaseModal() {
        const modal = document.getElementById('purchase-modal');
        if (modal) {
            modal.remove();
        }
    }
    
    processPurchase(region) {
        const advertiserName = document.getElementById('advertiser-name').value;
        const advertiserWebsite = document.getElementById('advertiser-website').value;
        const adDescription = document.getElementById('ad-description').value;
        
        if (!advertiserName.trim()) {
            this.showNotification('ê´‘ê³ ì£¼ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // êµ¬ë§¤ ì²˜ë¦¬
        const purchaseData = {
            regionId: region.id,
            regionName: this.getRegionDisplayName(region),
            advertiserName: advertiserName,
            advertiserWebsite: advertiserWebsite,
            adDescription: adDescription,
            price: region.price,
            purchaseDate: new Date().toISOString()
        };
        
        // ì‹¤ì œë¡œëŠ” ì„œë²„ì— êµ¬ë§¤ ìš”ì²­ì„ ë³´ë‚´ì•¼ í•¨
        console.log('êµ¬ë§¤ ë°ì´í„°:', purchaseData);
        
        // ë¡œì»¬ ìƒíƒœ ì—…ë°ì´íŠ¸
        this.currentRegion.occupied = true;
        this.currentRegion.advertiser = advertiserName;
        this.currentRegion.advertiserWebsite = advertiserWebsite;
        this.currentRegion.adDescription = adDescription;
        
        this.updateRegionStatus(this.currentRegion.id, true);
        this.hidePurchaseModal();
        this.showNotification('êµ¬ë§¤ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        this.showInfoPanel(this.currentRegion);
        
        // í†µê³„ ì—…ë°ì´íŠ¸
        this.updateStatistics();
    }
    
    showNotification(message, type = 'info') {
        // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
        this.hideNotification();
        
        const notification = document.createElement('div');
        notification.id = 'notification';
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
            <div class="notification-content">
                <span class="notification-icon">${this.getNotificationIcon(type)}</span>
                <span class="notification-message">${message}</span>
                <button class="notification-close">&times;</button>
            </div>
        `;
        
        document.body.appendChild(notification);
        
        // ìë™ ì œê±°
        setTimeout(() => {
            this.hideNotification();
        }, 5000);
        
        // ìˆ˜ë™ ì œê±°
        notification.querySelector('.notification-close').addEventListener('click', () => {
            this.hideNotification();
        });
    }
    
    hideNotification() {
        const notification = document.getElementById('notification');
        if (notification) {
            notification.remove();
        }
    }
    
    getNotificationIcon(type) {
        const icons = {
            success: 'âœ…',
            error: 'âŒ',
            warning: 'âš ï¸',
            info: 'â„¹ï¸'
        };
        return icons[type] || icons.info;
    }
    
    updateStatistics() {
        // ì§€ë„ ì†ŒìŠ¤ì—ì„œ ì‹¤ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const source = this.map.getSource('world-regions');
        if (!source || !source._data) return;
        
        const features = source._data.features;
        const totalRegions = features.length;
        const occupiedRegions = features.filter(f => f.properties.occupied).length;
        const totalRevenue = features
            .filter(f => f.properties.occupied)
            .reduce((sum, f) => sum + f.properties.price, 0);
        const occupancyRate = totalRegions > 0 ? Math.round((occupiedRegions / totalRegions) * 100) : 0;
        
        // UI ì—…ë°ì´íŠ¸
        document.getElementById('total-regions').textContent = totalRegions;
        document.getElementById('occupied-regions').textContent = occupiedRegions;
        document.getElementById('total-revenue').textContent = `$${totalRevenue.toLocaleString()}`;
        document.getElementById('occupancy-rate').textContent = `${occupancyRate}%`;
        
        console.log(`í†µê³„ ì—…ë°ì´íŠ¸: ${occupiedRegions}/${totalRegions} ì§€ì—­ ê´‘ê³  ì¤‘, ì´ ìˆ˜ìµ: $${totalRevenue.toLocaleString()}, ì ìœ ìœ¨: ${occupancyRate}%`);
    }
    
    updateRegionStatus(regionId, occupied) {
        // ì§€ë„ ë°ì´í„° ì—…ë°ì´íŠ¸
        const source = this.map.getSource('world-regions');
        if (source && source._data) {
            const features = source._data.features;
            const feature = features.find(f => f.properties.id === regionId);
            if (feature) {
                feature.properties.occupied = occupied;
                source.setData(source._data);
            }
        }
    }
    
    hideLoading() {
        const loading = document.getElementById('loading');
        loading.style.display = 'none';
    }
    
    showTooltip(point, properties) {
        // ê¸°ì¡´ íˆ´íŒ ì œê±°
        this.hideTooltip();
        
        // íˆ´íŒ ìš”ì†Œ ìƒì„±
        const tooltip = document.createElement('div');
        tooltip.id = 'map-tooltip';
        tooltip.className = 'map-tooltip';
        // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ í‘œì‹œí•  ì´ë¦„ ê²°ì •
        let displayName, subName;
        
        if (this.currentMapMode === 'japan') {
            displayName = properties.name_en || properties.name;
            subName = properties.name_ja;
        } else if (this.currentMapMode === 'korea') {
            // í•œêµ­ ëª¨ë“œ: name_koê°€ ì´ë¯¸ "ë¶€ì‚° ë¶€ì‚°ì§„êµ¬" í˜•íƒœë¡œ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•¨
            displayName = properties.name_ko || properties.name || properties.sig_name_ko;
            // ì‹œ ì´ë¦„ì´ ë³„ë„ë¡œ ìˆìœ¼ë©´ ì„œë¸Œ ì´ë¦„ìœ¼ë¡œ í‘œì‹œ
            if (properties.ctp_name_ko && properties.sig_name_ko && properties.ctp_name_ko !== properties.sig_name_ko) {
                const ctpShort = properties.ctp_name_ko.replace(/ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ|ì‹œ$/g, '').trim();
                if (!displayName.includes(ctpShort)) {
                    displayName = `${ctpShort} ${displayName}`;
                }
            }
            subName = properties.name_en || properties.sig_name_en;
        } else {
            displayName = properties.name_ko || properties.name;
            subName = properties.name_en;
        }
            
        tooltip.innerHTML = `
            <div class="tooltip-content">
                <h4>${displayName}</h4>
                ${subName ? `<p>${subName}</p>` : ''}
                <p><strong>${properties.country}</strong></p>
                <p>Population: ${properties.population.toLocaleString()}</p>
                <p>Price: $${properties.ad_price.toLocaleString()}</p>
                <p class="status ${properties.ad_status === 'occupied' ? 'occupied' : 'available'}">
                    ${properties.ad_status === 'occupied' ? 'Occupied' : 'Available'}
                </p>
            </div>
        `;
        
        // íˆ´íŒ ìœ„ì¹˜ ì„¤ì •
        tooltip.style.left = point.x + 10 + 'px';
        tooltip.style.top = point.y - 10 + 'px';
        
        document.body.appendChild(tooltip);
    }
    
    hideTooltip() {
        const existingTooltip = document.getElementById('map-tooltip');
        if (existingTooltip) {
            existingTooltip.remove();
        }
    }
    
    handleKeyboardShortcuts(e) {
        // Pí‚¤ ì—°íƒ€ ì²˜ë¦¬
        if (e.key.toLowerCase() === 'p') {
            e.preventDefault();
            this.handlePKeyPress();
            return;
        }
        
        // ESC í‚¤ë¡œ íŒ¨ë„ ë‹«ê¸°
        if (e.key === 'Escape') {
            this.hideInfoPanel();
            this.hidePurchaseModal();
        }
        
        // UIê°€ ë³´ì´ì§€ ì•Šìœ¼ë©´ ë‹¤ë¥¸ ë‹¨ì¶•í‚¤ ë¬´ì‹œ
        if (!this.uiVisible) {
            return;
        }
        
        // ìˆ«ì í‚¤ë¡œ ì¤Œ ë ˆë²¨ ë³€ê²½
        if (e.key === '1') {
            this.zoomToLevel('world');
        } else if (e.key === '2') {
            this.zoomToLevel('country');
        } else if (e.key === '3') {
            this.zoomToLevel('region');
        }
        
        // Enter í‚¤ë¡œ êµ¬ë§¤ (ì„ íƒëœ ì§€ì—­ì´ ìˆì„ ë•Œ)
        if (e.key === 'Enter' && this.currentRegion && !this.currentRegion.occupied) {
            this.purchaseRegion();
        }
        
        // H í‚¤ë¡œ ë„ì›€ë§ í‘œì‹œ
        if (e.key === 'h' || e.key === 'H') {
            this.showHelp();
        }
    }
    
    // Pí‚¤ ì—°íƒ€ ì²˜ë¦¬ - ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    handlePKeyPress() {
        this.pKeyCount++;
        
        // ê¸°ì¡´ íƒ€ì´ë¨¸ í´ë¦¬ì–´
        if (this.pKeyTimer) {
            clearTimeout(this.pKeyTimer);
        }
        
        // 3ë²ˆ ì—°íƒ€ ì‹œ ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
        if (this.pKeyCount >= 3) {
            // ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ ì•Šê±°ë‚˜, ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ë§Œ ê´€ë¦¬ì ëª¨ë“œê°€ ë¹„í™œì„±í™”ëœ ê²½ìš° ëª¨ë‹¬ í‘œì‹œ
            if (!this.isAdminLoggedIn) {
                this.showAdminLoginModal();
                this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ì´ ì—´ë ¸ìŠµë‹ˆë‹¤.', 'info');
            } else if (!this.adminMode) {
                // ë¡œê·¸ì¸ë˜ì–´ ìˆì§€ë§Œ ê´€ë¦¬ì ëª¨ë“œê°€ í•´ì œëœ ê²½ìš°, ê´€ë¦¬ì ëª¨ë“œ ë‹¤ì‹œ í™œì„±í™”
                this.toggleAdminMode();
                this.showNotification('ê´€ë¦¬ì ëª¨ë“œê°€ ë‹¤ì‹œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } else {
                this.showNotification('ì´ë¯¸ ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.', 'info');
            }
            this.pKeyCount = 0;
        } else {
            // 1ì´ˆ í›„ ì¹´ìš´íŠ¸ ë¦¬ì…‹
            this.pKeyTimer = setTimeout(() => {
                this.pKeyCount = 0;
            }, 1000);
        }
    }
    
    // UI í† ê¸€
    toggleUI() {
        this.uiVisible = !this.uiVisible;
        
        if (this.uiVisible) {
            this.showUI();
        } else {
            this.hideUI();
        }
    }
    
    // UI í‘œì‹œ (í—¤ë” ë²„íŠ¼ë“¤ - Pí‚¤ ì—°íƒ€ë¡œ í‘œì‹œ)
    showUI() {
        // í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ í‘œì‹œ
        const helpBtn = document.getElementById('help-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        if (helpBtn) helpBtn.classList.remove('hidden');
        if (adminLoginBtn) adminLoginBtn.classList.remove('hidden');
        
        if (this.isAdminLoggedIn && adminLogoutBtn) {
            adminLogoutBtn.classList.remove('hidden');
            // ê´€ë¦¬ì ë¡œê·¸ì¸ ìƒíƒœì¼ ë•Œë§Œ ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
            this.showAdminPanel();
        }
        
        // í—¤ë” ìë™ ì¡°ì •
        this.adjustHeader();
        
        console.log('UI í‘œì‹œë¨');
    }
    
    // UI ìˆ¨ê¹€ (í—¤ë” ë²„íŠ¼ë“¤ - Pí‚¤ ì—°íƒ€ë¡œ ìˆ¨ê¹€)
    hideUI() {
        // í—¤ë” ì•¡ì…˜ ë²„íŠ¼ë“¤ ìˆ¨ê¹€
        const helpBtn = document.getElementById('help-btn');
        const adminLoginBtn = document.getElementById('admin-login-btn');
        const adminLogoutBtn = document.getElementById('admin-logout-btn');
        
        if (helpBtn) helpBtn.classList.add('hidden');
        if (adminLoginBtn) adminLoginBtn.classList.add('hidden');
        if (adminLogoutBtn) adminLogoutBtn.classList.add('hidden');
        
        // ê´€ë¦¬ì íŒ¨ë„ê³¼ ì¢Œì¸¡ íŒ¨ë„ ìˆ¨ê¹€
        this.hideAdminPanel();
        this.hideMenu();
        
        // í—¤ë” ìë™ ì¡°ì •
        this.adjustHeader();
        
        console.log('UI ìˆ¨ê¹€ë¨');
    }
    
    // í—¤ë” ìë™ ì¡°ì •
    adjustHeader() {
        const header = document.querySelector('.header');
        const headerActions = document.querySelector('.header-actions');
        
        if (this.uiVisible) {
            // UIê°€ ë³´ì¼ ë•ŒëŠ” ì›ë˜ ìŠ¤íƒ€ì¼
            header.style.gap = '30px';
            headerActions.style.display = 'flex';
        } else {
            // UIê°€ ìˆ¨ê²¨ì§ˆ ë•ŒëŠ” ì¤‘ì•™ ì •ë ¬
            header.style.gap = '0';
            headerActions.style.display = 'none';
        }
    }
    
    showHelp() {
        const helpModal = document.createElement('div');
        helpModal.id = 'help-modal';
        helpModal.className = 'purchase-modal';
        helpModal.innerHTML = `
            <div class="modal-overlay"></div>
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ë„ì›€ë§ - í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h3>
                    <button class="modal-close">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="help-section">
                        <h4>ğŸ® ê¸°ë³¸ ì¡°ì‘</h4>
                        <ul>
                            <li><strong>ë§ˆìš°ìŠ¤ íœ :</strong> ì¤Œ ì¸/ì•„ì›ƒ</li>
                            <li><strong>ë“œë˜ê·¸:</strong> ì§€ë„ ì´ë™</li>
                            <li><strong>í´ë¦­:</strong> ì§€ì—­ ì„ íƒ</li>
                            <li><strong>í˜¸ë²„:</strong> ì§€ì—­ ì •ë³´ ë¯¸ë¦¬ë³´ê¸°</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h4>âŒ¨ï¸ í‚¤ë³´ë“œ ë‹¨ì¶•í‚¤</h4>
                        <ul>
                            <li><strong>1:</strong> ì „ ì„¸ê³„ ë³´ê¸°</li>
                            <li><strong>2:</strong> êµ­ê°€ë³„ ë³´ê¸°</li>
                            <li><strong>3:</strong> ì§€ì—­ë³„ ë³´ê¸°</li>
                            <li><strong>Enter:</strong> ì„ íƒëœ ì§€ì—­ êµ¬ë§¤</li>
                            <li><strong>ESC:</strong> íŒ¨ë„ ë‹«ê¸°</li>
                            <li><strong>H:</strong> ì´ ë„ì›€ë§ í‘œì‹œ</li>
                        </ul>
                    </div>
                    <div class="help-section">
                        <h4>ğŸ¨ ìƒ‰ìƒ ì˜ë¯¸</h4>
                        <ul>
                            <li><span style="color: #4ecdc4;">â—</span> ì²­ë¡ìƒ‰: ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì—­</li>
                            <li><span style="color: #ff6b6b;">â—</span> ë¹¨ê°„ìƒ‰: ê´‘ê³  ì¤‘ì¸ ì§€ì—­</li>
                            <li><span style="color: #feca57;">â—</span> ë…¸ë€ìƒ‰: ì„ íƒëœ ì§€ì—­</li>
                        </ul>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel">ë‹«ê¸°</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(helpModal);
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
        helpModal.querySelector('.modal-close').addEventListener('click', () => {
            helpModal.remove();
        });
        
        helpModal.querySelector('.modal-overlay').addEventListener('click', () => {
            helpModal.remove();
        });
        
        helpModal.querySelector('.btn-cancel').addEventListener('click', () => {
            helpModal.remove();
        });
    }
    
    // ê´€ë¦¬ì ëª¨ë“œ í† ê¸€
    // í–„ë²„ê±° ë©”ë‰´ í† ê¸€ (ê´€ë¦¬ì ì „ìš©)
    toggleMenu() {
        if (!this.isAdminLoggedIn) {
            this.showAdminLoginModal();
            return;
        }
        
        const controlPanel = document.getElementById('control-panel');
        controlPanel.classList.toggle('hidden');
    }
    
    // ë©”ë‰´ ìˆ¨ê¸°ê¸°
    hideMenu() {
        const controlPanel = document.getElementById('control-panel');
        controlPanel.classList.add('hidden');
    }
    
    // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    showUserLoginModal() {
        const modal = document.getElementById('user-login-modal');
        if (modal) {
            modal.classList.remove('hidden');
        }
    }
    
    // ì‚¬ìš©ì ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideUserLoginModal() {
        const modal = document.getElementById('user-login-modal');
        if (modal) {
            modal.classList.add('hidden');
            // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const emailInput = document.getElementById('user-email-input');
            const passwordInput = document.getElementById('user-password-input');
            const errorDiv = document.getElementById('user-login-error');
            if (emailInput) emailInput.value = '';
            if (passwordInput) passwordInput.value = '';
            if (errorDiv) errorDiv.classList.add('hidden');
        }
    }
    
    // ì‚¬ìš©ì ìƒíƒœ UI ì—…ë°ì´íŠ¸
    updateUserUI() {
        // í—¤ë”ì˜ ë¡œê·¸ì¸ ë²„íŠ¼ë“¤
        const loginBtn = document.getElementById('user-login-btn');
        const logoutBtn = document.getElementById('user-logout-btn');
        const userEmail = document.getElementById('user-email');
        
        // ì‚¬ì´ë“œ ë©”ë‰´ì˜ ë¡œê·¸ì¸ ë²„íŠ¼ë“¤
        const sideLoginBtn = document.getElementById('side-user-login-btn');
        const sideLogoutBtn = document.getElementById('side-user-logout-btn');
        const sideUserEmail = document.getElementById('side-user-email');
        
        if (this.currentUser) {
            // ë¡œê·¸ì¸ ìƒíƒœ
            if (loginBtn) loginBtn.classList.add('hidden');
            if (logoutBtn) logoutBtn.classList.remove('hidden');
            if (userEmail) {
                userEmail.textContent = this.currentUser.email;
                userEmail.classList.remove('hidden');
            }
            
            // ì‚¬ì´ë“œ ë©”ë‰´ ì—…ë°ì´íŠ¸
            if (sideLoginBtn) sideLoginBtn.classList.add('hidden');
            if (sideLogoutBtn) sideLogoutBtn.classList.remove('hidden');
            if (sideUserEmail) {
                sideUserEmail.textContent = this.currentUser.email;
                sideUserEmail.classList.remove('hidden');
            }
        } else {
            // ë¡œê·¸ì•„ì›ƒ ìƒíƒœ
            if (loginBtn) loginBtn.classList.remove('hidden');
            if (logoutBtn) logoutBtn.classList.add('hidden');
            if (userEmail) {
                userEmail.textContent = '';
                userEmail.classList.add('hidden');
            }
            
            // ì‚¬ì´ë“œ ë©”ë‰´ ì—…ë°ì´íŠ¸
            if (sideLoginBtn) sideLoginBtn.classList.remove('hidden');
            if (sideLogoutBtn) sideLogoutBtn.classList.add('hidden');
            if (sideUserEmail) {
                sideUserEmail.textContent = '';
                sideUserEmail.classList.add('hidden');
            }
        }
    }
    
    // ì‚¬ì´ë“œ ë©”ë‰´ í† ê¸€
    toggleSideMenu() {
        const sideMenu = document.getElementById('side-menu');
        if (sideMenu) {
            sideMenu.classList.toggle('hidden');
        }
    }
    
    // ì‚¬ì´ë“œ ë©”ë‰´ í‘œì‹œ
    showSideMenu() {
        const sideMenu = document.getElementById('side-menu');
        if (sideMenu) {
            sideMenu.classList.remove('hidden');
        }
    }
    
    // ì‚¬ì´ë“œ ë©”ë‰´ ìˆ¨ê¹€
    hideSideMenu() {
        const sideMenu = document.getElementById('side-menu');
        if (sideMenu) {
            sideMenu.classList.add('hidden');
        }
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
    showAdminLoginModal() {
        console.log('ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ ì‹œë„');
        const modal = document.getElementById('admin-login-modal');
        if (modal) {
            modal.classList.remove('hidden');
            console.log('ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œë¨');
        } else {
            console.error('admin-login-modal ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì¸ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideAdminLoginModal() {
        const modal = document.getElementById('admin-login-modal');
        modal.classList.add('hidden');
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById('admin-username').value = '';
        document.getElementById('admin-password').value = '';
        document.getElementById('login-error').classList.add('hidden');
    }
    
    // í•´ì‹œ í•¨ìˆ˜ (SHA-256)
    async hashString(str) {
        const encoder = new TextEncoder();
        const data = encoder.encode(str);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì¸ ì²˜ë¦¬ (ë³´ì•ˆ ê°•í™”: í•´ì‹±ëœ ìê²©ì¦ëª… ì‚¬ìš©)
    async handleAdminLogin() {
        const username = document.getElementById('admin-username').value;
        const password = document.getElementById('admin-password').value;
        const errorDiv = document.getElementById('login-error');
        
        // ì…ë ¥ê°’ ê²€ì¦
        if (!username || !password) {
            errorDiv.classList.remove('hidden');
            this.showNotification('ì‚¬ìš©ìëª…ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
            return;
        }
        
        try {
            // ì…ë ¥ê°’ í•´ì‹±
            const usernameHash = await this.hashString(username.trim());
            const passwordHash = await this.hashString(password);
            
            // í•´ì‹±ëœ ê´€ë¦¬ì ìê²©ì¦ëª… (í‰ë¬¸ ë…¸ì¶œ ë°©ì§€)
            // ì£¼ì˜: ì™„ì „í•œ ë³´ì•ˆì„ ìœ„í•´ì„œëŠ” ì„œë²„ ê¸°ë°˜ ì¸ì¦ ì‹œìŠ¤í…œì´ í•„ìš”í•©ë‹ˆë‹¤.
            // ì´ ë°©ë²•ì€ ìµœì†Œí•œì˜ ë³´ì•ˆ ì¡°ì¹˜ë¡œ, ì†ŒìŠ¤ ì½”ë“œì—ì„œ í‰ë¬¸ ìê²©ì¦ëª…ì„ ìˆ¨ê¹ë‹ˆë‹¤.
            // í•´ì‹œê°’ì€ SHA-256ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìœ¼ë©°, í‰ë¬¸ì€ ì½”ë“œì— í¬í•¨ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
            const ADMIN_USERNAME_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918';
            const ADMIN_PASSWORD_HASH = '240be518fabd2724ddb6f04eeb1da5967448d7e831c08c8fa822809f74c720a9';
            
            // í•´ì‹±ëœ ê°’ ë¹„êµ
            if (usernameHash === ADMIN_USERNAME_HASH && passwordHash === ADMIN_PASSWORD_HASH) {
                this.isAdminLoggedIn = true;
                this.hideAdminLoginModal();
                this.switchToAdminMode();
                
                // ê´€ë¦¬ì ë¡œê·¸ì¸ ì‹œ UI ìë™ í‘œì‹œ
                if (!this.uiVisible) {
                    this.showUI();
                    this.uiVisible = true;
                }
                
                this.showNotification('ê´€ë¦¬ìë¡œ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                // ë³´ì•ˆ: ì½˜ì†”ì— ë¡œê·¸ì¸ ì„±ê³µ ë©”ì‹œì§€ ì¶œë ¥í•˜ì§€ ì•ŠìŒ
            } else {
                errorDiv.classList.remove('hidden');
                this.showNotification('ì˜ëª»ëœ ë¡œê·¸ì¸ ì •ë³´ì…ë‹ˆë‹¤.', 'error');
            }
        } catch (error) {
            console.error('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜:', error);
            errorDiv.classList.remove('hidden');
            this.showNotification('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        }
    }
    
    // ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
    handleAdminLogout() {
        this.isAdminLoggedIn = false;
        this.disableAdminMode({ silent: true });
        
        // ê´€ë¦¬ì ëª¨ë“œì—ì„œ ì—´ë¦° ëª¨ë“  ëª¨ë‹¬ ë‹«ê¸°
        this.hideCompanyInfoModal();
        
        this.switchToUserMode();
        
        // UIê°€ ë³´ì´ëŠ” ìƒíƒœë¼ë©´ UIë„ ìˆ¨ê¸°ê¸°
        if (this.uiVisible) {
            this.hideUI();
        }
        
        this.showNotification('ê´€ë¦¬ìì—ì„œ ë¡œê·¸ì•„ì›ƒë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        console.log('ê´€ë¦¬ì ë¡œê·¸ì•„ì›ƒ');
    }
    
    // ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜
    switchToAdminMode() {
        this.adminMode = true; // ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”
        this.updateAdminModeControls();
        
        // ê¸°ì¡´ì— ì—´ë¦° ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°
        this.hideCompanyInfoModal();
        
        // í—¤ë” ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (UIê°€ ë³´ì¼ ë•Œë§Œ)
        if (this.uiVisible) {
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            if (adminLoginBtn) adminLoginBtn.classList.add('hidden');
            if (adminLogoutBtn) adminLogoutBtn.classList.remove('hidden');
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ê´€ë¦¬ì ì„¹ì…˜ì€ ìˆ¨ê¹€)
        const sideAdminSection = document.getElementById('side-admin-section');
        if (sideAdminSection) {
            sideAdminSection.style.display = 'none'; // ê´€ë¦¬ì ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        }
        
        // ê´€ë¦¬ì íŒ¨ë„ì€ Pí‚¤ ì—°íƒ€ë¡œë§Œ í‘œì‹œ (ì—¬ê¸°ì„œëŠ” í‘œì‹œí•˜ì§€ ì•ŠìŒ)
        // this.showAdminPanel(); // ì œê±°
        
        console.log('ê´€ë¦¬ì ëª¨ë“œë¡œ ì „í™˜');
    }
    
    // ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œë¡œ ì „í™˜
    switchToUserMode() {
        this.disableAdminMode({ silent: true });
        
        // í—¤ë” ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (UIê°€ ë³´ì¼ ë•Œë§Œ)
        if (this.uiVisible) {
            const adminLoginBtn = document.getElementById('admin-login-btn');
            const adminLogoutBtn = document.getElementById('admin-logout-btn');
            if (adminLoginBtn) adminLoginBtn.classList.remove('hidden');
            if (adminLogoutBtn) adminLogoutBtn.classList.add('hidden');
        }
        
        // ì‚¬ì´ë“œ ë©”ë‰´ ë²„íŠ¼ ìƒíƒœ ë³€ê²½ (ê´€ë¦¬ì ì„¹ì…˜ì€ ìˆ¨ê¹€)
        const sideAdminSection = document.getElementById('side-admin-section');
        if (sideAdminSection) {
            sideAdminSection.style.display = 'none'; // ê´€ë¦¬ì ì„¹ì…˜ ìˆ¨ê¸°ê¸°
        }

        // ì¢Œì¸¡ íŒ¨ë„ ìˆ¨ê¸°ê¸°
        this.hideMenu();
        
        console.log('ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œë¡œ ì „í™˜');
    }
    
    updateAdminModeControls() {
        const adminExitBtn = document.getElementById('admin-exit-btn');
        if (adminExitBtn) {
            if (this.isAdminLoggedIn && this.adminMode) {
                adminExitBtn.classList.remove('hidden');
            } else {
                adminExitBtn.classList.add('hidden');
            }
        }
    }
    
    disableAdminMode(options = {}) {
        const { silent = false } = options;
        
        if (!this.adminMode) {
            this.updateAdminModeControls();
            return;
        }
        
        this.adminMode = false;
        this.hideAdminPanel();
        
        if (this.map && this.map.setFilter) {
            try {
                this.map.setFilter('regions-hover', ['==', 'id', '']);
            } catch (error) {
                console.warn('regions-hover í•„í„° ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
            }
        }
        
        this.selectedStateId = null;
        this.currentRegion = null;
        this.updateAdminModeControls();
        
        if (!silent) {
            this.showNotification('ê´€ë¦¬ì ëª¨ë“œê°€ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
        }
    }
    
    toggleAdminMode() {
        if (!this.isAdminLoggedIn) {
            this.showAdminLoginModal();
            return;
        }
        
        if (this.adminMode) {
            this.disableAdminMode();
            return;
        }
        
        this.adminMode = true;
        this.showAdminPanel();
        this.updateAdminModeControls();
        this.showNotification('ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    // ë¡œê³  í¸ì§‘ ëª¨ë“œ í† ê¸€
    toggleLogoEditMode() {
        this.logoEditMode = !this.logoEditMode;
        const logoEditBtn = document.getElementById('logo-edit-mode');
        
        if (this.logoEditMode) {
            logoEditBtn.textContent = 'ë¡œê³  í¸ì§‘ (ON)';
            logoEditBtn.classList.add('active');
            this.map.getCanvas().style.cursor = 'crosshair';
        } else {
            logoEditBtn.textContent = 'ë¡œê³  í¸ì§‘';
            logoEditBtn.classList.remove('active');
            this.map.getCanvas().style.cursor = '';
        }
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
    showAdminPanel() {
        const panel = document.getElementById('admin-panel');
        if (panel) {
            panel.classList.remove('hidden');
            console.log('ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œë¨');
        } else {
            console.error('admin-panel ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
    }
    
    // ê´€ë¦¬ì íŒ¨ë„ ìˆ¨ê¸°ê¸°
    hideAdminPanel() {
        const panel = document.getElementById('admin-panel');
        if (panel) {
            panel.classList.add('hidden');
        }
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì—…ë¡œë“œ
    uploadLogo() {
        if (!this.selectedStateId) {
            this.showNotification('ë¨¼ì € ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        const fileInput = document.getElementById('logo-file-input');
        const file = fileInput.files[0];
        
        if (!file) {
            this.showNotification('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        if (!file.type.startsWith('image/')) {
            this.showNotification('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
            return;
        }
        
        // ê°„ë‹¨í•œ FileReader ì‚¬ìš©
        const reader = new FileReader();
        reader.onload = (e) => {
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë¡œê³  ë°ì´í„° ì €ì¥ì†Œì— ì €ì¥
        const logoData = {
            src: e.target.result,
            size: 80, // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            opacity: 0.8,
            rotation: 0
        };
        
        if (this.currentMapMode === 'korea') {
            this.koreaLogoData[this.selectedStateId] = logoData;
        } else {
            this.logoData[this.selectedStateId] = logoData;
        }
            
            this.updateLogoPreview();
            this.showNotification('ë¡œê³ ê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            console.log('ë¡œê³  ì—…ë¡œë“œ ì™„ë£Œ:', this.selectedStateId);
        };
        
        reader.onerror = () => {
            this.showNotification('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        };
        
        reader.readAsDataURL(file);
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateLogoPreview() {
        if (!this.selectedStateId) return;
        
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[this.selectedStateId]
            : this.logoData[this.selectedStateId];
        const currentLogoImg = document.getElementById('current-logo-img');
        const noLogo = document.getElementById('no-logo');
        const sizeValue = document.getElementById('logo-size-value');
        const opacityValue = document.getElementById('logo-opacity-value');
        const rotationValue = document.getElementById('logo-rotation-value');
        
        if (logoData) {
            currentLogoImg.src = logoData.src;
            currentLogoImg.style.display = 'block';
            noLogo.style.display = 'none';
            
            // ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
            document.getElementById('logo-size').value = logoData.size;
            document.getElementById('logo-opacity').value = logoData.opacity;
            document.getElementById('logo-rotation').value = logoData.rotation;
            
            // ë¯¸ë¦¬ë³´ê¸° ìŠ¤íƒ€ì¼ ì ìš©
            currentLogoImg.style.width = logoData.size + 'px';
            currentLogoImg.style.height = logoData.size + 'px';
            currentLogoImg.style.opacity = logoData.opacity;
            currentLogoImg.style.transform = `rotate(${logoData.rotation}deg)`;
            
            // ê°’ í‘œì‹œ ì—…ë°ì´íŠ¸
            sizeValue.textContent = logoData.size + 'px';
            opacityValue.textContent = Math.round(logoData.opacity * 100) + '%';
            rotationValue.textContent = logoData.rotation + 'Â°';
        } else {
            currentLogoImg.style.display = 'none';
            noLogo.style.display = 'block';
        }
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì €ì¥ (ìƒ‰ìƒ í¬í•¨)
    saveLogo() {
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì €ì¥ì†Œì—ì„œ ê°€ì ¸ì˜¤ê¸°
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanLogoData[this.selectedStateId]
            : this.logoData[this.selectedStateId];
        const colorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanColorData[this.selectedStateId]
            : this.colorData[this.selectedStateId];
        
        // ë¡œê³  ë°ì´í„° ì—…ë°ì´íŠ¸
        if (logoData) {
            logoData.size = parseInt(document.getElementById('logo-size').value) || 80; // ê¸°ë³¸ê°’ì„ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            logoData.opacity = parseFloat(document.getElementById('logo-opacity').value) || 0.8;
            logoData.rotation = parseInt(document.getElementById('logo-rotation').value) || 0;
            
            // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
            if (this.currentMapMode === 'korea') {
                this.koreaLogoData[this.selectedStateId] = logoData;
            } else if (this.currentMapMode === 'japan') {
                this.japanLogoData[this.selectedStateId] = logoData;
            } else {
                this.logoData[this.selectedStateId] = logoData;
            }
            
            // ì§€ë„ì— ë¡œê³  í‘œì‹œ
            this.displayLogoOnMapSimple(this.selectedStateId, logoData);
        }
        
        // ìƒ‰ìƒ ë°ì´í„° ì—…ë°ì´íŠ¸ ë° ì ìš©
        const currentColorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanColorData[this.selectedStateId]
            : this.colorData[this.selectedStateId];
            
        console.log('saveLogoì—ì„œ ìƒ‰ìƒ ë°ì´í„° í™•ì¸:', this.selectedStateId, currentColorData, 'ëª¨ë“œ:', this.currentMapMode);
        console.log('í•œêµ­ ìƒ‰ìƒ ë°ì´í„°:', this.koreaColorData);
        console.log('ë¯¸êµ­ ìƒ‰ìƒ ë°ì´í„°:', this.colorData);
            
        if (currentColorData) {
            // ìƒ‰ìƒ ë°ì´í„° í˜•ì‹ í†µì¼ (regionColor -> fillColor)
            const normalizedColorData = {
                fillColor: currentColorData.fillColor || currentColorData.regionColor || '#4ecdc4',
                borderColor: currentColorData.borderColor || '#ffffff',
                borderWidth: currentColorData.borderWidth || 1
            };
            this.applyColorToMap(this.selectedStateId, normalizedColorData);
        } else {
            console.warn('ìƒ‰ìƒ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.');
            // ê¸°ë³¸ ìƒ‰ìƒ ë°ì´í„° ìƒì„±
            const defaultColorData = {
                fillColor: '#4ecdc4',
                borderColor: '#ffffff',
                borderWidth: 1
            };
            
            // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ìƒ‰ìƒ ë°ì´í„° ì €ì¥
            if (this.currentMapMode === 'korea') {
                this.koreaColorData[this.selectedStateId] = defaultColorData;
            } else if (this.currentMapMode === 'japan') {
                this.japanColorData[this.selectedStateId] = defaultColorData;
            } else {
                this.colorData[this.selectedStateId] = defaultColorData;
            }
            
            this.applyColorToMap(this.selectedStateId, defaultColorData);
        }
        
        this.showNotification('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ë¡œê³  ë° ìƒ‰ìƒ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, { logoData, currentColorData });
    }
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©
    applyPresetColor(fillColor, borderColor) {
        if (!this.selectedStateId) {
            this.showNotification('ìƒ‰ìƒì„ ì ìš©í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš©:', fillColor, borderColor);
        
        // ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
        const regionColorInput = document.getElementById('region-color');
        const borderColorInput = document.getElementById('border-color');
        
        if (regionColorInput) regionColorInput.value = fillColor;
        if (borderColorInput) borderColorInput.value = borderColor;
        
        // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        const colorData = {
            fillColor: fillColor,
            borderColor: borderColor,
            borderWidth: 1
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaColorData[this.selectedStateId] = colorData;
        } else if (this.currentMapMode === 'japan') {
            this.japanColorData[this.selectedStateId] = colorData;
        } else {
            this.colorData[this.selectedStateId] = colorData;
        }
        
        // ì§€ë„ì— ìƒ‰ìƒ ì ìš©
        this.applyColorToMap(this.selectedStateId, colorData);
        
        // ìƒ‰ìƒì´ ì¦‰ì‹œ ì ìš©ë˜ë„ë¡ ì§€ë„ ìƒˆë¡œê³ ì¹¨
        this.map.triggerRepaint();
        
        this.showNotification('ìƒ‰ìƒì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì ìš© ì™„ë£Œ:', this.selectedStateId, colorData);
    }
    
    // ìƒ‰ìƒ í”„ë¦¬ì…‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    setupColorPresetListeners() {
        // ìƒ‰ìƒ í”„ë¦¬ì…‹ ë²„íŠ¼ë“¤ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
        const colorPresets = document.querySelectorAll('.color-preset');
        colorPresets.forEach(preset => {
            preset.addEventListener('click', () => {
                const fillColor = preset.getAttribute('data-color');
                const borderColor = preset.getAttribute('data-border');
                this.applyPresetColor(fillColor, borderColor);
            });
        });
        
        // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        const regionColorInput = document.getElementById('region-color');
        const borderColorInput = document.getElementById('border-color');
        const borderWidthInput = document.getElementById('border-width');
        
        if (regionColorInput) {
            regionColorInput.addEventListener('change', () => {
                this.applyCustomColor();
            });
            regionColorInput.addEventListener('input', () => {
                this.applyCustomColor();
            });
        }
        
        if (borderColorInput) {
            borderColorInput.addEventListener('change', () => {
                this.applyCustomColor();
            });
            borderColorInput.addEventListener('input', () => {
                this.applyCustomColor();
            });
        }
        
        if (borderWidthInput) {
            borderWidthInput.addEventListener('change', () => {
                this.applyCustomColor();
            });
            borderWidthInput.addEventListener('input', () => {
                this.applyCustomColor();
            });
        }
        
        console.log('ìƒ‰ìƒ í”„ë¦¬ì…‹ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ:', colorPresets.length, 'ê°œ');
        console.log('ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ');
    }
    
    // ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©
    applyCustomColor() {
        if (!this.selectedStateId) {
            console.warn('ì„ íƒëœ ì§€ì—­ì´ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        const fillColor = document.getElementById('region-color')?.value || '#4ecdc4';
        const borderColor = document.getElementById('border-color')?.value || '#ffffff';
        const borderWidth = parseInt(document.getElementById('border-width')?.value) || 1;
        
        console.log('ì»¤ìŠ¤í…€ ìƒ‰ìƒ ì ìš©:', fillColor, borderColor, borderWidth);
        
        // ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        const colorData = {
            fillColor: fillColor,
            borderColor: borderColor,
            borderWidth: borderWidth
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaColorData[this.selectedStateId] = colorData;
        } else if (this.currentMapMode === 'japan') {
            this.japanColorData[this.selectedStateId] = colorData;
        } else {
            this.colorData[this.selectedStateId] = colorData;
        }
        
        // ì§€ë„ì— ìƒ‰ìƒ ì ìš©
        this.applyColorToMap(this.selectedStateId, colorData);
        
        this.showNotification('ì»¤ìŠ¤í…€ ìƒ‰ìƒì´ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì œê±° (ìƒ‰ìƒ í¬í•¨)
    removeLogo() {
        if (!this.selectedStateId) {
            this.showNotification('ì œê±°í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ë¡œê³  ì œê±°
        delete this.logoData[this.selectedStateId];
        this.removeLogoFromMap(this.selectedStateId);
        
        // ìƒ‰ìƒ ì œê±° ë° ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
        delete this.colorData[this.selectedStateId];
        this.resetRegionColor(this.selectedStateId);
        
        this.updateLogoPreview();
        this.updateColorPreview();
        this.showNotification('ë¡œê³ ì™€ ìƒ‰ìƒì´ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        console.log('ë¡œê³  ë° ìƒ‰ìƒ ì œê±° ì™„ë£Œ:', this.selectedStateId);
    }
    
    // ì§€ì—­ ìƒ‰ìƒì„ ê¸°ë³¸ê°’ìœ¼ë¡œ ë³µì›
    resetRegionColor(stateId) {
        if (!this.map) return;
        
        // ê¸°ë³¸ ìƒ‰ìƒìœ¼ë¡œ ë³µì›
        this.map.setPaintProperty('regions-fill', 'fill-color', [
            'case',
            ['==', ['get', 'ad_status'], 'occupied'],
            '#ff6b6b',
            '#4ecdc4'
        ]);
        
        this.map.setPaintProperty('regions-border', 'line-color', '#ffffff');
        this.map.setPaintProperty('regions-border', 'line-width', 1);
        
        console.log('ì§€ì—­ ìƒ‰ìƒ ë³µì› ì™„ë£Œ:', stateId);
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  ì„¤ì • ì´ˆê¸°í™” (ìƒ‰ìƒ í¬í•¨)
    resetLogo() {
        if (!this.selectedStateId) return;
        
        // ë¡œê³  ì„¤ì • ì´ˆê¸°í™”
        const logoData = this.logoData[this.selectedStateId];
        if (logoData) {
            logoData.size = 80; // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            logoData.opacity = 0.8;
            logoData.rotation = 0;
            this.logoData[this.selectedStateId] = logoData;
        }
        
        // ìƒ‰ìƒ ì„¤ì • ì´ˆê¸°í™”
        const defaultColorData = {
            regionColor: '#4ecdc4',
            borderColor: '#ffffff',
            borderWidth: 1
        };
        this.colorData[this.selectedStateId] = defaultColorData;
        
        // UI ì´ˆê¸°í™”
        document.getElementById('region-color').value = defaultColorData.regionColor;
        document.getElementById('border-color').value = defaultColorData.borderColor;
        document.getElementById('border-width').value = defaultColorData.borderWidth;
        
        // í”„ë¦¬ì…‹ ì„ íƒ í•´ì œ
        document.querySelectorAll('.color-preset').forEach(p => p.classList.remove('selected'));
        
        this.updateLogoPreview();
        this.updateColorPreview();
        this.showNotification('ëª¨ë“  ì„¤ì •ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
    }
    
    // ìƒˆë¡œìš´ ê°„ë‹¨í•œ ë¡œê³  í‘œì‹œ í•¨ìˆ˜ (ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ì¡°ì •)
    displayLogoOnMapSimple(stateId, logoData) {
        console.log('ë¡œê³  í‘œì‹œ ì‹œì‘:', stateId, logoData);
        
        // ê¸°ì¡´ ë¡œê³  ì œê±°
        this.removeLogoFromMap(stateId);
        
        // ì£¼ì˜ ì¤‘ì‹¬ì ì„ ê°„ë‹¨í•˜ê²Œ ê³„ì‚°
        const centerCoords = this.getStateCenter(stateId);
        if (!centerCoords) {
            console.error('ì£¼ ì¤‘ì‹¬ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        // ë¡œê³  ìš”ì†Œ ìƒì„±
        const logoElement = document.createElement('div');
        logoElement.id = `logo-${stateId}`;
        logoElement.className = 'state-logo';
        logoElement.innerHTML = `<img src="${logoData.src}" alt="${stateId} Logo">`;
        
        // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
        logoElement.style.position = 'absolute';
        logoElement.style.pointerEvents = 'none';
        logoElement.style.zIndex = '1000';
        logoElement.style.opacity = logoData.opacity;
        logoElement.style.transform = `rotate(${logoData.rotation}deg)`;
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ê³„ì‚° í•¨ìˆ˜ (ë” í¬ê²Œ í‘œì‹œ)
        const calculateLogoSize = (zoomLevel) => {
            const baseSize = logoData.size || 80; // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
            const zoomFactor = Math.pow(2, zoomLevel - 4); // ì¤Œ ë ˆë²¨ 4ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•¨
            return Math.max(30, Math.min(300, baseSize * zoomFactor)); // ìµœì†Œ 30px, ìµœëŒ€ 300pxë¡œ ì¦ê°€
        };
        
        // ìœ„ì¹˜ ë° í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updatePositionAndSize = () => {
            const currentZoom = this.map.getZoom();
            const currentSize = calculateLogoSize(currentZoom);
            
            // í¬ê¸° ì—…ë°ì´íŠ¸
            logoElement.style.width = currentSize + 'px';
            logoElement.style.height = currentSize + 'px';
            
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const point = this.map.project(centerCoords);
            logoElement.style.left = (point.x - currentSize / 2) + 'px';
            logoElement.style.top = (point.y - currentSize / 2) + 'px';
            
            console.log(`ë¡œê³  í¬ê¸° ì¡°ì •: ì¤Œ ${currentZoom.toFixed(2)}, í¬ê¸° ${currentSize.toFixed(1)}px`);
        };
        
        // ì´ˆê¸° ì„¤ì •
        updatePositionAndSize();
        
        // ì§€ë„ ì´ë™ ë° ì¤Œ ì‹œ ì—…ë°ì´íŠ¸
        this.map.on('move', updatePositionAndSize);
        this.map.on('zoom', updatePositionAndSize);
        
        // ì§€ë„ì— ì¶”ê°€
        const mapContainer = document.getElementById('map');
        mapContainer.appendChild(logoElement);
        
        console.log('ë¡œê³  í‘œì‹œ ì™„ë£Œ (ì¤Œ ë°˜ì‘í˜•):', stateId);
    }
    
    // ëª¨ë“  ë¡œê³ ì˜ í¬ê¸°ë¥¼ ì¤Œ ë ˆë²¨ì— ë§ê²Œ ì—…ë°ì´íŠ¸
    updateAllLogoSizes() {
        const currentZoom = this.map.getZoom();
        
        // ëª¨ë“  ë¡œê³  ë°ì´í„°ì— ëŒ€í•´ í¬ê¸° ì—…ë°ì´íŠ¸
        Object.keys(this.logoData).forEach(stateId => {
            const logoElement = document.getElementById(`logo-${stateId}`);
            if (logoElement && this.logoData[stateId]) {
                const logoData = this.logoData[stateId];
                const baseSize = logoData.size || 80; // ê¸°ë³¸ í¬ê¸°ë¥¼ 50ì—ì„œ 80ìœ¼ë¡œ ì¦ê°€
                const zoomFactor = Math.pow(2, currentZoom - 4);
                const newSize = Math.max(30, Math.min(300, baseSize * zoomFactor)); // ìµœì†Œ 30px, ìµœëŒ€ 300pxë¡œ ì¦ê°€
                
                // í¬ê¸° ì—…ë°ì´íŠ¸
                logoElement.style.width = newSize + 'px';
                logoElement.style.height = newSize + 'px';
                
                // ìœ„ì¹˜ë„ ë‹¤ì‹œ ê³„ì‚°
                const centerCoords = this.getStateCenter(stateId);
                if (centerCoords) {
                    const point = this.map.project(centerCoords);
                    logoElement.style.left = (point.x - newSize / 2) + 'px';
                    logoElement.style.top = (point.y - newSize / 2) + 'px';
                }
            }
        });
        
    }
    
    // ì£¼ì˜ ì¤‘ì‹¬ì ì„ ê°„ë‹¨í•˜ê²Œ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
    getStateCenter(stateId) {
        const source = this.map.getSource('world-regions');
        if (!source || !source._data) return null;
        
        const feature = source._data.features.find(f => f.properties.id === stateId);
        if (!feature) return null;
        
        const coordinates = feature.geometry.coordinates[0];
        if (!coordinates || coordinates.length === 0) return null;
        
        let centerLng = 0, centerLat = 0;
        coordinates.forEach(coord => {
            centerLng += coord[0];
            centerLat += coord[1];
        });
        
        return [centerLng / coordinates.length, centerLat / coordinates.length];
    }
    
    // ì§€ë„ì—ì„œ ë¡œê³  ì œê±°
    removeLogoFromMap(stateId) {
        const logoElement = document.getElementById(`logo-${stateId}`);
        if (logoElement) {
            logoElement.remove();
        }
    }
    
    getKoreanStateName(englishName) {
        const stateNames = {
            'Alabama': 'ì•¨ë¼ë°°ë§ˆì£¼',
            'Alaska': 'ì•Œë˜ìŠ¤ì¹´ì£¼',
            'Arizona': 'ì• ë¦¬ì¡°ë‚˜ì£¼',
            'Arkansas': 'ì•„ì¹¸ì†Œì£¼',
            'California': 'ìº˜ë¦¬í¬ë‹ˆì•„ì£¼',
            'Colorado': 'ì½œë¡œë¼ë„ì£¼',
            'Connecticut': 'ì½”ë„¤í‹°ì»·ì£¼',
            'Delaware': 'ë¸ë¼ì›¨ì–´ì£¼',
            'Florida': 'í”Œë¡œë¦¬ë‹¤ì£¼',
            'Georgia': 'ì¡°ì§€ì•„ì£¼',
            'Hawaii': 'í•˜ì™€ì´ì£¼',
            'Idaho': 'ì•„ì´ë‹¤í˜¸ì£¼',
            'Illinois': 'ì¼ë¦¬ë…¸ì´ì£¼',
            'Indiana': 'ì¸ë””ì• ë‚˜ì£¼',
            'Iowa': 'ì•„ì´ì˜¤ì™€ì£¼',
            'Kansas': 'ìº”ììŠ¤ì£¼',
            'Kentucky': 'ì¼„í„°í‚¤ì£¼',
            'Louisiana': 'ë£¨ì´ì§€ì• ë‚˜ì£¼',
            'Maine': 'ë©”ì¸ì£¼',
            'Maryland': 'ë©”ë¦´ëœë“œì£¼',
            'Massachusetts': 'ë§¤ì‚¬ì¶”ì„¸ì¸ ì£¼',
            'Michigan': 'ë¯¸ì‹œê°„ì£¼',
            'Minnesota': 'ë¯¸ë„¤ì†Œíƒ€ì£¼',
            'Mississippi': 'ë¯¸ì‹œì‹œí”¼ì£¼',
            'Missouri': 'ë¯¸ì£¼ë¦¬ì£¼',
            'Montana': 'ëª¬íƒœë‚˜ì£¼',
            'Nebraska': 'ë„¤ë¸Œë˜ìŠ¤ì¹´ì£¼',
            'Nevada': 'ë„¤ë°”ë‹¤ì£¼',
            'New Hampshire': 'ë‰´í–„í”„ì…”ì£¼',
            'New Jersey': 'ë‰´ì €ì§€ì£¼',
            'New Mexico': 'ë‰´ë©•ì‹œì½”ì£¼',
            'New York': 'ë‰´ìš•ì£¼',
            'North Carolina': 'ë…¸ìŠ¤ìºë¡¤ë¼ì´ë‚˜ì£¼',
            'North Dakota': 'ë…¸ìŠ¤ë‹¤ì½”íƒ€ì£¼',
            'Ohio': 'ì˜¤í•˜ì´ì˜¤ì£¼',
            'Oklahoma': 'ì˜¤í´ë¼í˜¸ë§ˆì£¼',
            'Oregon': 'ì˜¤ë¦¬ê±´ì£¼',
            'Pennsylvania': 'íœì‹¤ë² ì´ë‹ˆì•„ì£¼',
            'Rhode Island': 'ë¡œë“œì•„ì¼ëœë“œì£¼',
            'South Carolina': 'ì‚¬ìš°ìŠ¤ìºë¡¤ë¼ì´ë‚˜ì£¼',
            'South Dakota': 'ì‚¬ìš°ìŠ¤ë‹¤ì½”íƒ€ì£¼',
            'Tennessee': 'í…Œë„¤ì‹œì£¼',
            'Texas': 'í…ì‚¬ìŠ¤ì£¼',
            'Utah': 'ìœ íƒ€ì£¼',
            'Vermont': 'ë²„ëª¬íŠ¸ì£¼',
            'Virginia': 'ë²„ì§€ë‹ˆì•„ì£¼',
            'Washington': 'ì›Œì‹±í„´ì£¼',
            'West Virginia': 'ì›¨ìŠ¤íŠ¸ë²„ì§€ë‹ˆì•„ì£¼',
            'Wisconsin': 'ìœ„ìŠ¤ì½˜ì‹ ì£¼',
            'Wyoming': 'ì™€ì´ì˜¤ë°ì£¼'
        };
        return stateNames[englishName] || englishName;
    }
    
    // ìƒ‰ìƒì„ ë°ê²Œ ë§Œë“œëŠ” í—¬í¼ í•¨ìˆ˜ (hover íš¨ê³¼ìš©)
    lightenColor(color, percent) {
        // HEX ìƒ‰ìƒì„ RGBë¡œ ë³€í™˜
        const num = parseInt(color.replace("#", ""), 16);
        const r = Math.min(255, ((num >> 16) & 0xff) + Math.round(255 * percent / 100));
        const g = Math.min(255, ((num >> 8) & 0xff) + Math.round(255 * percent / 100));
        const b = Math.min(255, (num & 0xff) + Math.round(255 * percent / 100));
        
        // RGBë¥¼ HEXë¡œ ë³€í™˜
        return "#" + ((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1);
    }
    
    // hover íš¨ê³¼ ì ìš© í•¨ìˆ˜ (ì¦‰ì‹œ ì ìš©)
    applyHoverEffect(regionId) {
        // hover ë ˆì´ì–´ì— í•´ë‹¹ ì§€ì—­ë§Œ í‘œì‹œ
        if (this.map.getLayer('regions-hover')) {
            this.map.setFilter('regions-hover', ['==', 'id', regionId]);
            this.map.setPaintProperty('regions-hover', 'fill-opacity', 0.5);
            this.map.setPaintProperty('regions-hover', 'fill-color', '#feca57');
        }
        
        // ì €ì¥ëœ ìƒ‰ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const currentColorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData 
            : this.currentMapMode === 'japan'
            ? this.japanColorData
            : this.colorData;
        
        // ê²½ê³„ì„  ë‘ê»˜ ê°•ì¡° (ì €ì¥ëœ ë‘ê»˜ + í˜¸ë²„ ê°•ì¡°)
        if (this.map.getLayer('regions-border')) {
            let borderWidthConditions = ['case'];
            
            // ì €ì¥ëœ ìƒ‰ìƒì´ ìˆìœ¼ë©´ í•´ë‹¹ ì§€ì—­ì€ ë‘êº¼ìš´ ê²½ê³„ì„ , ë‚˜ë¨¸ì§€ëŠ” ì €ì¥ëœ ë‘ê»˜
            if (Object.keys(currentColorData).length > 0) {
                Object.keys(currentColorData).forEach(id => {
                    const regionColor = currentColorData[id];
                    if (regionColor && regionColor.borderWidth) {
                        borderWidthConditions.push(['==', ['get', 'id'], id]);
                        borderWidthConditions.push(regionColor.borderWidth);
                    }
                });
            }
            
            // í˜¸ë²„ ì§€ì—­ì€ 3ìœ¼ë¡œ ê°•ì¡°
            borderWidthConditions.push(['==', ['get', 'id'], regionId]);
            borderWidthConditions.push(3);
            borderWidthConditions.push(1); // ê¸°ë³¸ê°’
            
            this.map.setPaintProperty('regions-border', 'line-width', borderWidthConditions);
            this.map.setPaintProperty('regions-border', 'line-opacity', [
                'case',
                ['==', ['get', 'id'], regionId],
                1,
                0.8
            ]);
        }
        
        // fill ìƒ‰ìƒì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ (ì›ë˜ ìƒ‰ìƒ ìœ ì§€)
        // í˜¸ë²„ íš¨ê³¼ëŠ” regions-hover ë ˆì´ì–´ë¡œë§Œ í‘œì‹œ
    }
    
    // hover íš¨ê³¼ ì¦‰ì‹œ ì œê±° í•¨ìˆ˜ (transition ì—†ìŒ)
    clearHoverEffectImmediate() {
        if (!this.currentHoverRegionId) return;
        
        // hover ë ˆì´ì–´ë§Œ ì œê±° (fill ìƒ‰ìƒì€ ì›ë˜ëŒ€ë¡œ ìœ ì§€)
        if (this.map.getLayer('regions-hover')) {
            this.map.setFilter('regions-hover', ['==', 'id', '']);
            this.map.setPaintProperty('regions-hover', 'fill-opacity', 0);
        }
        
        // ê²½ê³„ì„  ì›ë˜ëŒ€ë¡œ ë³µì› (ì €ì¥ëœ ìƒ‰ìƒ ìœ ì§€)
        if (this.map.getLayer('regions-border')) {
            // ì €ì¥ëœ ìƒ‰ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const currentColorData = this.currentMapMode === 'korea' 
                ? this.koreaColorData 
                : this.currentMapMode === 'japan'
                ? this.japanColorData
                : this.colorData;
            
            // ì €ì¥ëœ ê²½ê³„ì„  ìƒ‰ìƒì´ ìˆìœ¼ë©´ ë³µì›, ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
            if (Object.keys(currentColorData).length > 0) {
                let borderColorConditions = ['case'];
                let borderWidthConditions = ['case'];
                
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.borderColor) {
                        borderColorConditions.push(['==', ['get', 'id'], regionId]);
                        borderColorConditions.push(regionColor.borderColor);
                    }
                    if (regionColor && regionColor.borderWidth) {
                        borderWidthConditions.push(['==', ['get', 'id'], regionId]);
                        borderWidthConditions.push(regionColor.borderWidth);
                    }
                });
                borderColorConditions.push('#ffffff');
                borderWidthConditions.push(1);
                
                this.map.setPaintProperty('regions-border', 'line-color', borderColorConditions);
                this.map.setPaintProperty('regions-border', 'line-width', borderWidthConditions);
            } else {
                this.map.setPaintProperty('regions-border', 'line-width', 1);
            }
            this.map.setPaintProperty('regions-border', 'line-opacity', 0.8);
        }
        
        // fill ìƒ‰ìƒì€ ë³€ê²½í•˜ì§€ ì•ŠìŒ (ì›ë˜ ìƒ‰ìƒ ìœ ì§€)
        // í˜¸ë²„ íš¨ê³¼ëŠ” regions-hover ë ˆì´ì–´ë¡œë§Œ í‘œì‹œë˜ë¯€ë¡œ, 
        // hover ë ˆì´ì–´ë§Œ ì œê±°í•˜ë©´ ì›ë˜ ìƒ‰ìƒì´ ìë™ìœ¼ë¡œ í‘œì‹œë¨
        
        this.currentHoverRegionId = null;
    }
    
    // hover íš¨ê³¼ ì œê±° í•¨ìˆ˜ (transition í¬í•¨ - í˜¸í™˜ì„±ìš©)
    clearHoverEffect() {
        this.clearHoverEffectImmediate();
    }
    
    // í–‰ì •êµ¬ì—­ hover ì¢…ë£Œ ì²˜ë¦¬
    handleRegionHoverExit() {
        this.map.getCanvas().style.cursor = '';
        this.clearHoverEffectImmediate();
        this.hideTooltip();
    }
    
    showError(message) {
        const loading = document.getElementById('loading');
        loading.innerHTML = `
            <div style="color: #ff6b6b; font-size: 1.2rem;">
                <p>âŒ ì˜¤ë¥˜ ë°œìƒ</p>
                <p style="font-size: 0.9rem; margin-top: 10px;">${message}</p>
            </div>
        `;
    }
    
    // ì–¸ì–´ ë³€í™˜ í—¬í¼ í•¨ìˆ˜
    getLanguageText(key, includeSecondary = true) {
        let countryCode = this.currentMapMode;
        
        // 'korea' ëª¨ë“œë¥¼ 'south-korea' ì–¸ì–´ ë§¤í•‘ìœ¼ë¡œ ë³€í™˜
        if (countryCode === 'korea') {
            countryCode = 'south-korea';
        }
        
        const langData = this.countryLanguages[countryCode];
        
        if (!langData) {
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ì˜ì–´ ë°˜í™˜
            return {
                primary: key,
                secondary: includeSecondary && Object.keys(this.countryLanguages['usa']?.primary || {}).includes(key) 
                    ? this.countryLanguages['usa'].primary[key] 
                    : null
            };
        }
        
        const primary = langData.primary[key] || key;
        const secondary = includeSecondary && langData.secondary && Object.keys(langData.secondary).length > 0
            ? langData.secondary[key] || null
            : null;
        
        return { primary, secondary };
    }
    
    // ì§€ì—­ í‘œì‹œ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° (êµ­ê°€ë³„ ì–¸ì–´ ìš°ì„ ìˆœìœ„ ì ìš©)
    getRegionDisplayName(regionData) {
        if (!regionData) return '';
        
        const englishCountries = ['usa', 'uk', 'canada', 'australia', 'south-africa'];
        const isEnglishCountry = englishCountries.includes(this.currentMapMode);
        
        if (this.currentMapMode === 'japan') {
            return `${regionData.name_en || ''}${regionData.name_ja ? ` (${regionData.name_ja})` : ''}`;
        } else if (this.currentMapMode === 'korea') {
            let displayName = regionData.name_ko || regionData.name;
            if (regionData.ctp_name_ko && regionData.sig_name_ko && regionData.sig_name_ko !== regionData.ctp_name_ko) {
                const ctpShort = regionData.ctp_name_ko.replace(/ê´‘ì—­ì‹œ|íŠ¹ë³„ì‹œ|ì‹œ$/g, '').trim();
                if (!displayName.includes(ctpShort)) {
                    displayName = `${ctpShort} ${regionData.sig_name_ko || displayName}`;
                }
            }
            return `${displayName}${regionData.name_en ? ` (${regionData.name_en})` : ''}`;
        } else if (isEnglishCountry) {
            // ì˜ì–´ê¶Œ êµ­ê°€: ì˜ì–´ë§Œ í‘œì‹œ
            return regionData.name_en || regionData.name_ko || regionData.name || '';
        } else {
            // ê·¸ ì™¸: í˜„ì§€ì–´ (ì˜ì–´)
            return `${regionData.name_ko || regionData.name}${regionData.name_en ? ` (${regionData.name_en})` : ''}`;
        }
    }
    
    // ìƒ‰ìƒì„ ì§€ë„ì— ì ìš© (í•œêµ­ ëª¨ë“œ ì§€ì›)
    applyColorToMap(stateId, colorData) {
        if (!this.map.getLayer('regions-fill')) {
            console.error('regions-fill ë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // colorDataê°€ ìœ íš¨í•œì§€ í™•ì¸
        if (!colorData || !colorData.fillColor) {
            console.warn('ìœ íš¨í•˜ì§€ ì•Šì€ ìƒ‰ìƒ ë°ì´í„°:', colorData);
            return;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ìƒ‰ìƒ ë°ì´í„° ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaColorData[stateId] = colorData;
        } else if (this.currentMapMode === 'japan') {
            this.japanColorData[stateId] = colorData;
        } else {
            this.colorData[stateId] = colorData;
        }
        
        console.log('ìƒ‰ìƒ ë°ì´í„° ì €ì¥:', stateId, colorData, 'ëª¨ë“œ:', this.currentMapMode);
        
        // ì„ íƒëœ ì§€ì—­ì˜ ìƒ‰ìƒ ì—…ë°ì´íŠ¸ (ë¯¸êµ­ ì§€ë„ì™€ ë™ì¼í•œ ë°©ì‹)
        console.log('ìƒ‰ìƒ ì ìš© ì‹œì‘:', stateId, colorData.fillColor);
        
        // ë ˆì´ì–´ ì¡´ì¬ í™•ì¸
        if (!this.map.getLayer('regions-fill')) {
            console.error('regions-fill ë ˆì´ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            return;
        }
        
        // í˜„ì¬ ëª¨ë“œì˜ ëª¨ë“  ìƒ‰ìƒ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì„œ ì¡°ê±´ ìƒì„±
        const currentColorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData 
            : this.currentMapMode === 'japan'
            ? this.japanColorData
            : this.colorData;
        
        // ìƒ‰ìƒ ì¡°ê±´ì„ ë‹¨ê³„ë³„ë¡œ êµ¬ì„±
        let colorConditions = ['case'];
        
        // ê° ì§€ì—­ì˜ ìƒ‰ìƒ ì¡°ê±´ ì¶”ê°€
        Object.keys(currentColorData).forEach(regionId => {
            const regionColor = currentColorData[regionId];
            if (regionColor && regionColor.fillColor) {
                colorConditions.push(['==', ['get', 'id'], regionId]);
                colorConditions.push(regionColor.fillColor);
                console.log(`ìƒ‰ìƒ ì¡°ê±´ ì¶”ê°€: ${regionId} -> ${regionColor.fillColor}`);
            }
        });
        
        // ê¸°ë³¸ ìƒ‰ìƒ (occupied ìƒíƒœì— ë”°ë¼)
        colorConditions.push([
            'case',
            ['==', ['get', 'ad_status'], 'occupied'],
            '#ff6b6b', // ê´‘ê³  ì¤‘ì¸ ì§€ì—­
            '#4ecdc4'  // ì‚¬ìš© ê°€ëŠ¥í•œ ì§€ì—­
        ]);
        
        console.log('ìµœì¢… ìƒ‰ìƒ ì¡°ê±´:', colorConditions);
        
        // ìƒ‰ìƒ ì ìš©
        try {
            this.map.setPaintProperty('regions-fill', 'fill-color', colorConditions);
            console.log('ìƒ‰ìƒ ì ìš© ì„±ê³µ:', stateId, colorData.fillColor);
            
            // ì§€ë„ ê°•ì œ ìƒˆë¡œê³ ì¹¨
            this.map.triggerRepaint();
            
        } catch (error) {
            console.error('ìƒ‰ìƒ ì ìš© ì‹¤íŒ¨:', error);
        }
        
        console.log('ìƒ‰ìƒ paint property ì—…ë°ì´íŠ¸:', stateId, colorData.fillColor);
        
        // ê²½ê³„ì„  ìƒ‰ìƒê³¼ ë‘ê»˜ëŠ” regions-border ë ˆì´ì–´ì— ì ìš© (ëª¨ë“  ì§€ì—­ í†µí•© ì ìš©)
        if (this.map.getLayer('regions-border')) {
            try {
                // ê²½ê³„ì„  ìƒ‰ìƒ ì¡°ê±´ ìƒì„± (ëª¨ë“  ì§€ì—­ ì ìš©)
                let borderColorConditions = ['case'];
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.borderColor) {
                        borderColorConditions.push(['==', ['get', 'id'], regionId]);
                        borderColorConditions.push(regionColor.borderColor);
                    }
                });
                borderColorConditions.push('#ffffff'); // ê¸°ë³¸ ìƒ‰ìƒ
                
                this.map.setPaintProperty('regions-border', 'line-color', borderColorConditions);
                console.log('ê²½ê³„ì„  ìƒ‰ìƒ ì ìš© ì„±ê³µ');
            } catch (error) {
                console.warn('ê²½ê³„ì„  ìƒ‰ìƒ ì ìš© ì‹¤íŒ¨:', error);
            }
            
            try {
                // ê²½ê³„ì„  ë‘ê»˜ ì¡°ê±´ ìƒì„± (ëª¨ë“  ì§€ì—­ ì ìš©)
                let borderWidthConditions = ['case'];
                Object.keys(currentColorData).forEach(regionId => {
                    const regionColor = currentColorData[regionId];
                    if (regionColor && regionColor.borderWidth) {
                        borderWidthConditions.push(['==', ['get', 'id'], regionId]);
                        borderWidthConditions.push(regionColor.borderWidth);
                    }
                });
                borderWidthConditions.push(1); // ê¸°ë³¸ ë‘ê»˜
                
                this.map.setPaintProperty('regions-border', 'line-width', borderWidthConditions);
                console.log('ê²½ê³„ì„  ë‘ê»˜ ì ìš© ì„±ê³µ');
            } catch (error) {
                console.warn('ê²½ê³„ì„  ë‘ê»˜ ì ìš© ì‹¤íŒ¨:', error);
            }
        }
        
        console.log('ìƒ‰ìƒ ì ìš© ì™„ë£Œ:', stateId, colorData, 'ëª¨ë“œ:', this.currentMapMode);
    }
    
    // ë¡œê³ ë¥¼ ì§€ë„ì— í‘œì‹œ (ê°„ë‹¨í•œ ë²„ì „)
    displayLogoOnMapSimple(stateId, logoData) {
        console.log('ë¡œê³  í‘œì‹œ ì‹œì‘:', stateId, logoData, 'ëª¨ë“œ:', this.currentMapMode);
        
        // ê¸°ì¡´ ë¡œê³  ì œê±°
        this.removeLogoFromMap(stateId);
        
        // ì£¼ì˜ ì¤‘ì‹¬ì ì„ ê°„ë‹¨í•˜ê²Œ ê³„ì‚°
        const centerCoords = this.getStateCenter(stateId);
        if (!centerCoords) {
            console.error('ì£¼ ì¤‘ì‹¬ì ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        console.log('ì¤‘ì‹¬ì  ì¢Œí‘œ:', stateId, centerCoords, 'ëª¨ë“œ:', this.currentMapMode);
        
        // ë¡œê³  ìš”ì†Œ ìƒì„±
        const logoElement = document.createElement('div');
        logoElement.id = `logo-${stateId}`;
        logoElement.className = 'state-logo';
        logoElement.innerHTML = `<img src="${logoData.src}" alt="${stateId} Logo">`;
        
        // ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì ìš©
        logoElement.style.position = 'absolute';
        logoElement.style.pointerEvents = 'none';
        logoElement.style.zIndex = '1000';
        logoElement.style.opacity = logoData.opacity || 0.8;
        logoElement.style.transform = `rotate(${logoData.rotation || 0}deg)`;
        logoElement.style.display = 'block';
        logoElement.style.visibility = 'visible';
        
        // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ í¬ê¸° ê³„ì‚° í•¨ìˆ˜ (ë¯¸êµ­ ì‹œìŠ¤í…œê³¼ ë™ì¼í•œ ë°©ì‹)
        const calculateLogoSize = (zoomLevel) => {
            const baseSize = logoData.size || 80;
            
            // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ë§ (ë¯¸êµ­ ì‹œìŠ¤í…œê³¼ ë™ì¼)
            let scaleFactor;
            if (zoomLevel <= 3) {
                scaleFactor = 0.3; // ë§¤ìš° ì‘ê²Œ
            } else if (zoomLevel <= 4) {
                scaleFactor = 0.5; // ì‘ê²Œ
            } else if (zoomLevel <= 5) {
                scaleFactor = 0.7; // ì¤‘ê°„
            } else if (zoomLevel <= 6) {
                scaleFactor = 1.0; // ê¸°ë³¸ í¬ê¸°
            } else if (zoomLevel <= 7) {
                scaleFactor = 1.3; // í¬ê²Œ
            } else if (zoomLevel <= 8) {
                scaleFactor = 1.6; // ë§¤ìš° í¬ê²Œ
            } else {
                scaleFactor = 2.0; // ìµœëŒ€ í¬ê¸°
            }
            
            const finalSize = baseSize * scaleFactor;
            return Math.max(20, Math.min(400, finalSize)); // ìµœì†Œ 20px, ìµœëŒ€ 400px
        };
        
        // ìœ„ì¹˜ ë° í¬ê¸° ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        const updatePositionAndSize = () => {
            const currentZoom = this.map.getZoom();
            const currentSize = calculateLogoSize(currentZoom);
            
            // í¬ê¸° ì—…ë°ì´íŠ¸
            logoElement.style.width = currentSize + 'px';
            logoElement.style.height = currentSize + 'px';
            
            // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
            const point = this.map.project(centerCoords);
            logoElement.style.left = (point.x - currentSize / 2) + 'px';
            logoElement.style.top = (point.y - currentSize / 2) + 'px';
            
            console.log(`ë¡œê³  í¬ê¸° ì¡°ì •: ì¤Œ ${currentZoom.toFixed(2)}, í¬ê¸° ${currentSize.toFixed(1)}px`);
        };
        
        // ì´ˆê¸° ì„¤ì •
        updatePositionAndSize();
        
        // ì§€ë„ ì´ë™ ë° ì¤Œ ì‹œ ì—…ë°ì´íŠ¸
        this.map.on('move', updatePositionAndSize);
        this.map.on('zoom', updatePositionAndSize);
        
        // ì§€ë„ì— ì¶”ê°€
        const mapContainer = document.getElementById('map');
        mapContainer.appendChild(logoElement);
        
        console.log('ë¡œê³  í‘œì‹œ ì™„ë£Œ (ì¤Œ ë°˜ì‘í˜•):', stateId);
    }
    
    // ë¡œê³ ë¥¼ ì§€ë„ì—ì„œ ì œê±°
    removeLogoFromMap(stateId) {
        const existingLogo = document.getElementById(`logo-${stateId}`);
        if (existingLogo) {
            existingLogo.remove();
        }
    }
    
    // ì£¼ì˜ ì¤‘ì‹¬ì  ê³„ì‚°
    getStateCenter(stateId) {
        // ë¯¸êµ­ ì£¼ ì¤‘ì‹¬ì  ë§¤í•‘
        const usStateCenters = {
            'california': [-119.4179, 36.7783],
            'texas': [-99.9018, 31.9686],
            'florida': [-81.5158, 27.7663],
            'new_york': [-74.9481, 42.1657],
            'pennsylvania': [-77.1945, 41.2033],
            'illinois': [-89.3985, 40.3363],
            'ohio': [-82.7649, 40.3888],
            'georgia': [-83.1136, 32.1656],
            'north_carolina': [-79.0193, 35.6301],
            'michigan': [-84.5467, 43.3266],
            'new_jersey': [-74.4057, 40.2989],
            'virginia': [-78.1694, 37.7693],
            'washington': [-121.4905, 47.4009],
            'arizona': [-111.4312, 33.7298],
            'massachusetts': [-71.5376, 42.2302],
            'tennessee': [-86.7816, 35.7478],
            'indiana': [-86.1349, 39.7909],
            'missouri': [-92.1893, 38.4561],
            'maryland': [-76.8021, 39.0458],
            'wisconsin': [-89.6165, 44.2685],
            'colorado': [-105.3111, 39.0598],
            'minnesota': [-94.6859, 46.7296],
            'south_carolina': [-80.9007, 33.8569],
            'alabama': [-86.7911, 32.8067],
            'louisiana': [-92.4737, 31.1695],
            'kentucky': [-84.6701, 37.6681],
            'oregon': [-122.0709, 44.5721],
            'oklahoma': [-97.5164, 35.5653],
            'connecticut': [-72.7273, 41.5978],
            'utah': [-111.8926, 40.1500],
            'iowa': [-93.6205, 42.0115],
            'nevada': [-117.0554, 38.3135],
            'arkansas': [-92.3731, 34.9697],
            'mississippi': [-89.3985, 32.7416],
            'kansas': [-98.4842, 38.5266],
            'new_mexico': [-106.2485, 34.8405],
            'nebraska': [-99.9018, 41.1254],
            'west_virginia': [-80.9696, 38.3495],
            'idaho': [-114.4788, 44.2405],
            'hawaii': [-157.4983, 21.0943],
            'new_hampshire': [-71.5653, 43.4525],
            'maine': [-69.7653, 44.3235],
            'montana': [-110.4544, 47.0526],
            'rhode_island': [-71.5118, 41.6809],
            'delaware': [-75.5267, 39.3185],
            'south_dakota': [-99.9018, 44.2998],
            'north_dakota': [-101.0020, 47.5289],
            'alaska': [-152.4044, 61.3707],
            'vermont': [-72.7317, 44.0459],
            'wyoming': [-107.3025, 42.7550]
        };
        
        // í•œêµ­ ë„ì‹œ ì¤‘ì‹¬ì  ë§¤í•‘ (ë” ë§ì€ ë„ì‹œ ì¶”ê°€)
        const koreanCityCenters = {
            'í™”ì„±si': [126.8, 37.2],
            'seoul': [126.98, 37.57],
            'busan': [129.08, 35.18],
            'daegu': [128.6, 35.87],
            'incheon': [126.7, 37.46],
            'gwangju': [126.85, 35.16],
            'daejeon': [127.39, 36.35],
            'ulsan': [129.31, 35.54],
            'sejong': [127.29, 36.48],
            'suwon': [127.0, 37.3],
            'yongin': [127.2, 37.2],
            'seongnam': [127.1, 37.4],
            'bucheon': [126.8, 37.5],
            'ansan': [126.8, 37.3],
            'anyang': [126.9, 37.4],
            'namyangju': [127.2, 37.6],
            'hwasong': [126.8, 37.2],
            'pyeongtaek': [127.0, 37.0],
            'siheung': [126.8, 37.4],
            'goyang': [126.8, 37.7],
            'gimpo': [126.7, 37.6],
            'hanam': [127.2, 37.5],
            'osan': [127.1, 37.1],
            'icheon': [127.4, 37.3],
            'yangju': [127.0, 37.8],
            'dongducheon': [127.1, 37.9],
            'guri': [127.1, 37.6],
            'gwangmyeong': [126.9, 37.5],
            'gunpo': [126.9, 37.4],
            'uiwang': [127.0, 37.4],
            'yeoju': [127.6, 37.3],
            'yangpyeong': [127.5, 37.5],
            'gapyeong': [127.5, 37.8],
            'yeoncheon': [127.1, 38.1]
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì¤‘ì‹¬ì  ë°˜í™˜
        if (this.currentMapMode === 'korea') {
            return koreanCityCenters[stateId] || [127.5, 36.0]; // ê¸°ë³¸ê°’: í•œêµ­ ì¤‘ì‹¬
        } else {
            return usStateCenters[stateId] || [-98.5795, 39.8283]; // ê¸°ë³¸ê°’: ë¯¸êµ­ ì¤‘ì‹¬
        }
    }
    
    // ê¸°ì¡´ ë ˆì´ì–´ì™€ ì†ŒìŠ¤ ì œê±°
    removeExistingLayersAndSources() {
        try {
            // ë ˆì´ì–´ ì œê±°
            const layersToRemove = ['regions-fill', 'regions-border', 'regions-hover'];
            layersToRemove.forEach(layerId => {
                if (this.map.getLayer(layerId)) {
                    this.map.removeLayer(layerId);
                    console.log('ë ˆì´ì–´ ì œê±°:', layerId);
                }
            });
            
            // ì†ŒìŠ¤ ì œê±°
            const sourcesToRemove = ['regions', 'world-regions'];
            sourcesToRemove.forEach(sourceId => {
                if (this.map.getSource(sourceId)) {
                    this.map.removeSource(sourceId);
                    console.log('ì†ŒìŠ¤ ì œê±°:', sourceId);
                }
            });
            
            // ê¸°ì¡´ ë¡œê³ ë“¤ ì œê±°
            this.removeAllLogosFromMap();
            
        } catch (error) {
            console.warn('ë ˆì´ì–´/ì†ŒìŠ¤ ì œê±° ì¤‘ ì˜¤ë¥˜:', error);
        }
    }
    
    // ëª¨ë“  ë¡œê³ ë¥¼ ì§€ë„ì—ì„œ ì œê±°
    removeAllLogosFromMap() {
        const mapContainer = document.getElementById('map');
        if (mapContainer) {
            const allLogos = mapContainer.querySelectorAll('.state-logo');
            allLogos.forEach(logo => logo.remove());
            console.log('ëª¨ë“  ë¡œê³  ì œê±° ì™„ë£Œ:', allLogos.length, 'ê°œ');
        }
    }
    
    // í˜„ì¬ ëª¨ë“œì˜ ëª¨ë“  ë¡œê³ ì™€ ìƒ‰ìƒ í‘œì‹œ
    displayAllLogosForCurrentMode() {
        const logoData = this.currentMapMode === 'korea' ? this.koreaLogoData : this.currentMapMode === 'japan' ? this.japanLogoData : this.logoData;
        const colorData = this.currentMapMode === 'korea' ? this.koreaColorData : this.currentMapMode === 'japan' ? this.japanColorData : this.colorData;
        
        // ë¡œê³  í‘œì‹œ
        Object.keys(logoData).forEach(stateId => {
            const logo = logoData[stateId];
            if (logo && logo.src) {
                this.displayLogoOnMapSimple(stateId, logo);
            }
        });
        
        // ìƒ‰ìƒ ë³µì›
        Object.keys(colorData).forEach(stateId => {
            const color = colorData[stateId];
            if (color) {
                // ìƒ‰ìƒ ë°ì´í„° í˜•ì‹ í†µì¼
                const normalizedColorData = {
                    fillColor: color.fillColor || color.regionColor || '#4ecdc4',
                    borderColor: color.borderColor || '#ffffff',
                    borderWidth: color.borderWidth || 1
                };
                this.applyColorToMap(stateId, normalizedColorData);
            }
        });
        
        // ëª¨ë“  ë¡œê³  í¬ê¸° ì—…ë°ì´íŠ¸ (ì¤Œ ë ˆë²¨ì— ë§ê²Œ)
        this.updateAllLogoSizes();
        
        console.log('í˜„ì¬ ëª¨ë“œ ë¡œê³  ë° ìƒ‰ìƒ í‘œì‹œ ì™„ë£Œ:', this.currentMapMode, 
                   'ë¡œê³ :', Object.keys(logoData).length, 'ê°œ', 
                   'ìƒ‰ìƒ:', Object.keys(colorData).length, 'ê°œ');
    }
    
    // ëª¨ë“  ë¡œê³  í¬ê¸° ì—…ë°ì´íŠ¸ (ì¤Œ ë ˆë²¨ì— ë§ê²Œ) - ê°•í™”ëœ ë²„ì „
    updateAllLogoSizes() {
        const logoData = this.currentMapMode === 'korea' ? this.koreaLogoData : this.currentMapMode === 'japan' ? this.japanLogoData : this.logoData;
        const currentZoom = this.map.getZoom();
        
        // ë¡œê³ ê°€ ì—†ìœ¼ë©´ ì—…ë°ì´íŠ¸í•˜ì§€ ì•ŠìŒ
        if (Object.keys(logoData).length === 0) {
            return;
        }
        
        // ëª¨ë“  ë¡œê³  ìš”ì†Œë¥¼ ì§ì ‘ ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
        const allLogoElements = document.querySelectorAll('.state-logo');
        
        // DOMì˜ ëª¨ë“  ë¡œê³  ìš”ì†Œë¥¼ ì§ì ‘ ì—…ë°ì´íŠ¸
        allLogoElements.forEach(logoElement => {
            const stateId = logoElement.id.replace('logo-', '');
            const logo = logoData[stateId];
            
            if (logo && logo.src) {
                const baseSize = logo.size || 80;
                
                // ì¤Œ ë ˆë²¨ì— ë”°ë¥¸ ìŠ¤ì¼€ì¼ë§ (ë¯¸êµ­ ì§€ë„ì™€ ë™ì¼)
                let scaleFactor;
                if (currentZoom <= 3) {
                    scaleFactor = 0.3;
                } else if (currentZoom <= 4) {
                    scaleFactor = 0.5;
                } else if (currentZoom <= 5) {
                    scaleFactor = 0.7;
                } else if (currentZoom <= 6) {
                    scaleFactor = 1.0;
                } else if (currentZoom <= 7) {
                    scaleFactor = 1.3;
                } else if (currentZoom <= 8) {
                    scaleFactor = 1.6;
                } else {
                    scaleFactor = 2.0;
                }
                
                const currentSize = Math.max(20, Math.min(400, baseSize * scaleFactor));
                
                // í¬ê¸° ì—…ë°ì´íŠ¸ (ê°•ì œ ì ìš©)
                logoElement.style.width = currentSize + 'px';
                logoElement.style.height = currentSize + 'px';
                logoElement.style.display = 'block';
                logoElement.style.visibility = 'visible';
                
                // CSS transition ì¶”ê°€ë¡œ ë¶€ë“œëŸ¬ìš´ í¬ê¸° ë³€í™”
                logoElement.style.transition = 'width 0.3s ease, height 0.3s ease, left 0.3s ease, top 0.3s ease';
                
                // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
                const centerCoords = this.getStateCenter(stateId);
                if (centerCoords) {
                    const point = this.map.project(centerCoords);
                    logoElement.style.left = (point.x - currentSize / 2) + 'px';
                    logoElement.style.top = (point.y - currentSize / 2) + 'px';
                }
                
                console.log(`ë¡œê³  í¬ê¸° ì—…ë°ì´íŠ¸: ${stateId}, ì¤Œ ${currentZoom.toFixed(2)}, í¬ê¸° ${currentSize.toFixed(1)}px, ìŠ¤ì¼€ì¼ ${scaleFactor.toFixed(2)}x`);
            }
        });
        
        // ë°ì´í„°ì— ìˆì§€ë§Œ DOMì— ì—†ëŠ” ë¡œê³  ìš”ì†Œë“¤ ì¬ìƒì„±
        Object.keys(logoData).forEach(stateId => {
            const logo = logoData[stateId];
            if (logo && logo.src) {
                const logoElement = document.getElementById(`logo-${stateId}`);
                if (!logoElement) {
                    console.log(`ë¡œê³  ìš”ì†Œê°€ ì—†ì–´ì„œ ë‹¤ì‹œ ìƒì„±: ${stateId}`);
                    this.displayLogoOnMapSimple(stateId, logo);
                }
            }
        });
        
        
        // ê°•ì œë¡œ ì§€ë„ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë³€ê²½ì‚¬í•­ ì ìš©
        this.map.triggerRepaint();
    }
    
    
    // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ (ê´‘ê³ ê°€ ì—†ì„ ë•Œ)
    showRegionInfoModal(stateId) {
        console.log('ì§€ì—­ ì •ë³´ ëª¨ë‹¬ í‘œì‹œ:', stateId, 'ëª¨ë“œ:', this.currentMapMode);
        
        // í˜„ì¬ ì§€ì—­ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const regionData = this.regionData.get(stateId);
        if (!regionData) {
            console.error('ì§€ì—­ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        // êµ­ê°€ë³„ í”Œë˜ê·¸ ì„¤ì •
        const getCountryFlag = (country) => {
            switch(country) {
                case 'USA': return 'ğŸ‡ºğŸ‡¸';
                case 'South Korea': return 'ğŸ‡°ğŸ‡·';
                case 'Japan': return 'ğŸ‡¯ğŸ‡µ';
                default: return 'ğŸ´';
            }
        };
        
        // ëª¨ë‹¬ ì œëª© ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const titleText = this.getLanguageText('Region Information');
        const titlePrimary = document.querySelector('#region-modal-title.label-primary') || document.getElementById('region-modal-title');
        const titleSecondary = document.getElementById('region-modal-title-en');
        if (titlePrimary) titlePrimary.textContent = titleText.primary;
        if (titleSecondary && titleText.secondary) {
            titleSecondary.textContent = ` (${titleText.secondary})`;
            titleSecondary.style.display = 'inline';
        } else if (titleSecondary) {
            titleSecondary.style.display = 'none';
        }
        
        // ì§€ì—­ ì´ë¦„ ì„¤ì • (êµ­ê°€ë³„ ì–¸ì–´ ìš°ì„ ìˆœìœ„ ì ìš©)
        const regionName = this.getRegionDisplayName(regionData);
        document.getElementById('region-modal-name').textContent = regionName;
        
        // êµ­ê°€ ì •ë³´ ì„¤ì •
        document.getElementById('region-modal-country').textContent = regionData.country;
        document.getElementById('region-flag').textContent = getCountryFlag(regionData.country);
        
        // ìƒì„¸ ì •ë³´ ì„¤ì • (regionDataì—ì„œ ì •í™•í•œ ê°’ ê°€ì ¸ì˜¤ê¸°)
        const population = regionData.population || 0;
        const area = regionData.area || 0;
        const adminLevel = regionData.admin_level || (this.currentMapMode === 'japan' 
            ? 'Prefecture'
            : this.currentMapMode === 'korea'
            ? 'City'
            : 'State');
        const adPrice = regionData.ad_price || 0;
        
        document.getElementById('region-modal-population').textContent = population ? population.toLocaleString() : '-';
        document.getElementById('region-modal-area').textContent = area ? `${area.toLocaleString()} kmÂ²` : '-';
        document.getElementById('region-modal-admin-level').textContent = adminLevel;
        document.getElementById('region-modal-price').textContent = adPrice ? `$${adPrice.toLocaleString()}` : '-';
        
        // ë¼ë²¨ í…ìŠ¤íŠ¸ ì„¤ì • (ì–¸ì–´ ë³€í™˜ ì ìš©)
        const regionLabel = this.getLanguageText('Region');
        const populationLabel = this.getLanguageText('Population');
        const areaLabel = this.getLanguageText('Area');
        const adminLevelLabel = this.getLanguageText('Administrative Level');
        const priceLabel = this.getLanguageText('Advertising Price');
        const statusLabel = this.getLanguageText('Status');
        
        // Primary ë¼ë²¨ ì—…ë°ì´íŠ¸
        const updateRegionModalLabel = (secondaryId, text) => {
            const secondaryEl = document.getElementById(secondaryId);
            const primaryEl = secondaryEl?.parentElement?.querySelector('.label-primary');
            if (primaryEl) primaryEl.textContent = text.primary;
        };
        
        // ì§€ì—­ëª… ë¼ë²¨ ì—…ë°ì´íŠ¸ëŠ” region-modal-nameì´ ì§€ì—­ ì´ë¦„ì„ í‘œì‹œí•˜ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” ì œì™¸
        updateRegionModalLabel('region-modal-population-label-en', populationLabel);
        updateRegionModalLabel('region-modal-area-label-en', areaLabel);
        updateRegionModalLabel('region-modal-admin-level-label-en', adminLevelLabel);
        updateRegionModalLabel('region-modal-price-label-en', priceLabel);
        
        // Secondary ë¼ë²¨ ì—…ë°ì´íŠ¸
        const populationLabelEn = document.getElementById('region-modal-population-label-en');
        const areaLabelEn = document.getElementById('region-modal-area-label-en');
        const adminLevelLabelEn = document.getElementById('region-modal-admin-level-label-en');
        const priceLabelEn = document.getElementById('region-modal-price-label-en');
        const statusLabelEn = document.getElementById('region-modal-status-label-en');
        
        if (populationLabelEn) {
            if (populationLabel.secondary) {
                populationLabelEn.textContent = ` (${populationLabel.secondary})`;
                populationLabelEn.style.display = 'inline';
            } else {
                populationLabelEn.style.display = 'none';
            }
        }
        if (areaLabelEn) {
            if (areaLabel.secondary) {
                areaLabelEn.textContent = ` (${areaLabel.secondary})`;
                areaLabelEn.style.display = 'inline';
            } else {
                areaLabelEn.style.display = 'none';
            }
        }
        if (adminLevelLabelEn) {
            if (adminLevelLabel.secondary) {
                adminLevelLabelEn.textContent = ` (${adminLevelLabel.secondary})`;
                adminLevelLabelEn.style.display = 'inline';
            } else {
                adminLevelLabelEn.style.display = 'none';
            }
        }
        if (priceLabelEn) {
            if (priceLabel.secondary) {
                priceLabelEn.textContent = ` (${priceLabel.secondary})`;
                priceLabelEn.style.display = 'inline';
            } else {
                priceLabelEn.style.display = 'none';
            }
        }
        if (statusLabelEn) {
            if (statusLabel.secondary) {
                statusLabelEn.textContent = ` (${statusLabel.secondary})`;
                statusLabelEn.style.display = 'inline';
            } else {
                statusLabelEn.style.display = 'none';
            }
        }
        
        // ê´‘ê³  ìƒíƒœ ì„¤ì •
        const statusElement = document.getElementById('region-modal-status');
        const statusIcon = statusElement.querySelector('.status-icon');
        const statusText = statusElement.querySelector('.status-text');
        
        const availableText = this.getLanguageText('Available');
        const occupiedText = this.getLanguageText('Occupied');
        
        if (regionData.ad_status === 'occupied') {
            statusElement.className = 'status-badge occupied';
            statusIcon.textContent = 'âŒ';
            statusText.textContent = occupiedText.primary;
        } else {
            statusElement.className = 'status-badge available';
            statusIcon.textContent = 'âœ…';
            statusText.textContent = availableText.primary;
        }
        
        // ìƒíƒœ ì„¤ëª… ì„¤ì •
        const statusDescription = document.querySelector('.status-description');
        const descriptionPrimary = statusDescription?.querySelector('.description-primary');
        const descriptionSecondary = document.getElementById('region-modal-status-description-en');
        
        if (regionData.ad_status === 'occupied') {
            const occupiedDesc = this.getLanguageText('This region is currently occupied by an advertisement.');
            if (descriptionPrimary) descriptionPrimary.textContent = occupiedDesc.primary;
            if (descriptionSecondary && occupiedDesc.secondary) {
                descriptionSecondary.textContent = ` (${occupiedDesc.secondary})`;
                descriptionSecondary.style.display = 'inline';
            } else if (descriptionSecondary) {
                descriptionSecondary.style.display = 'none';
            }
        } else {
            const availableDesc = this.getLanguageText('This region is available for advertisement registration.');
            if (descriptionPrimary) descriptionPrimary.textContent = availableDesc.primary;
            if (descriptionSecondary && availableDesc.secondary) {
                descriptionSecondary.textContent = ` (${availableDesc.secondary})`;
                descriptionSecondary.style.display = 'inline';
            } else if (descriptionSecondary) {
                descriptionSecondary.style.display = 'none';
            }
        }
        
        // êµ¬ë§¤ ë²„íŠ¼ í…ìŠ¤íŠ¸ ì„¤ì •
        const purchaseText = this.getLanguageText('Purchase This Region');
        const purchaseBtn = document.getElementById('region-purchase-btn');
        if (purchaseBtn) {
        purchaseBtn.textContent = purchaseText.primary;
        }
        const regionBuyNowBtn = document.getElementById('region-auction-buy-now-btn');
        if (regionBuyNowBtn) {
            const auctionInfo = this.getAuctionInfo(regionData);
            const config = auctionInfo?.config || this.getRegionAuctionConfig(regionData);
            if (config && config.buyNowPrice) {
                regionBuyNowBtn.classList.remove('hidden');
                regionBuyNowBtn.textContent = `ì¦‰ì‹œ êµ¬ë§¤ (${this.formatCurrency(config.buyNowPrice)})`;
            } else {
                regionBuyNowBtn.classList.add('hidden');
            }
        }
        
        // ê´€ë¦¬ì ëª¨ë“œì¼ ë•Œ í¸ì§‘ ë²„íŠ¼ í‘œì‹œ
        const regionEditBtn = document.getElementById('region-edit-btn');
        if (regionEditBtn) {
            if (this.isAdminLoggedIn) {
                regionEditBtn.classList.remove('hidden');
            } else {
                regionEditBtn.classList.add('hidden');
            }
        }
        
        // ëª¨ë‹¬ í‘œì‹œ
        const modal = document.getElementById('region-info-modal');
        if (modal) {
            modal.classList.remove('hidden');
            modal.style.display = 'flex'; // ì¤‘ì•™ ì •ë ¬ì„ ìœ„í•´ flex ì‚¬ìš©
        }
    }
    
    // ê¸°ì—… ì •ë³´ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideCompanyInfoModal() {
        const modal = document.getElementById('company-info-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    }
    
    // ì§€ì—­ ì •ë³´ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
    hideRegionInfoModal() {
        const modal = document.getElementById('region-info-modal');
        if (modal) {
            modal.classList.add('hidden');
            modal.style.display = 'none';
        }
    }
    
    // ê¸°ì—… ì •ë³´ ë¡œë“œ (í¸ì§‘ìš©)
    loadCompanyInfoForEdit(stateId) {
        console.log('ê¸°ì—… ì •ë³´ ë¡œë“œ (í¸ì§‘ìš©):', stateId, 'ëª¨ë“œ:', this.currentMapMode);
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const companyData = this.currentMapMode === 'korea' 
            ? this.koreaCompanyData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanCompanyData[stateId]
            : this.companyData[stateId];
            
        if (companyData) {
            // í¼ í•„ë“œë“¤ì— ë°ì´í„° ì±„ìš°ê¸°
            document.getElementById('company-name-input').value = companyData.name || '';
            document.getElementById('company-industry-input').value = companyData.industry || '';
            document.getElementById('company-founded-input').value = companyData.founded || '';
            document.getElementById('company-employees-input').value = companyData.employees || '';
            document.getElementById('company-website-input').value = companyData.website || '';
            document.getElementById('company-description-input').value = companyData.description || '';
            
            // íŠ¹ì§• ë°°ì—´ì„ ë¬¸ìì—´ë¡œ ë³€í™˜
            const featuresText = companyData.features ? companyData.features.join('\n') : '';
            document.getElementById('company-features-input').value = featuresText;
            
            console.log('ê¸°ì—… ì •ë³´ ë¡œë“œ ì™„ë£Œ:', companyData);
        } else {
            // ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
            document.getElementById('company-name-input').value = '';
            document.getElementById('company-industry-input').value = '';
            document.getElementById('company-founded-input').value = '';
            document.getElementById('company-employees-input').value = '';
            document.getElementById('company-website-input').value = '';
            document.getElementById('company-description-input').value = '';
            document.getElementById('company-features-input').value = '';
            
            console.log('ê¸°ì—… ì •ë³´ ì—†ìŒ, ê¸°ë³¸ê°’ìœ¼ë¡œ ì´ˆê¸°í™”');
        }
    }
    
    // ê¸°ì—… ì •ë³´ ì €ì¥ (ëª¨ë“œë³„ ë°ì´í„° ì²˜ë¦¬)
    async saveCompanyInfo() {
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì£¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        // ê¶Œí•œ í™•ì¸: ê´€ë¦¬ìì´ê±°ë‚˜ í•´ë‹¹ ì§€ì—­ì˜ ì†Œìœ ìì¸ì§€ í™•ì¸
        if (!this.isAdminLoggedIn) {
            // ì¼ë°˜ ì‚¬ìš©ìì¸ ê²½ìš° ì†Œìœ ê¶Œ í™•ì¸
            const isOwner = await this.checkRegionOwnership(this.selectedStateId);
            if (!isOwner) {
                this.showNotification('ì´ ì§€ì—­ì˜ ì†Œìœ ìë§Œ ê¸°ì—… ì •ë³´ë¥¼ ìˆ˜ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € í•´ë‹¹ ì§€ì—­ì„ êµ¬ë§¤í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
        }
        
        // í¼ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
        const companyData = {
            name: document.getElementById('company-name-input').value,
            industry: document.getElementById('company-industry-input').value,
            founded: document.getElementById('company-founded-input').value,
            employees: document.getElementById('company-employees-input').value,
            website: document.getElementById('company-website-input').value,
            description: document.getElementById('company-description-input').value,
            features: document.getElementById('company-features-input').value.split('\n').filter(f => f.trim()),
            logo: this.currentMapMode === 'korea' 
                ? (this.koreaLogoData[this.selectedStateId]?.src || '')
                : (this.logoData[this.selectedStateId]?.src || '')
        };
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ì €ì¥ì†Œì— ì €ì¥
        if (this.currentMapMode === 'korea') {
            this.koreaCompanyData[this.selectedStateId] = companyData;
        } else if (this.currentMapMode === 'japan') {
            this.japanCompanyData[this.selectedStateId] = companyData;
        } else {
            this.companyData[this.selectedStateId] = companyData;
        }
        
        this.showNotification('ê¸°ì—… ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        console.log('ê¸°ì—… ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, companyData, 'ëª¨ë“œ:', this.currentMapMode);
    }
    
    
    // ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸
    updateAdminPanel(stateId, stateName) {
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸:', stateId, stateName);
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanLogoData[stateId]
            : this.logoData[stateId];
        const colorData = this.currentMapMode === 'korea' 
            ? this.koreaColorData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanColorData[stateId]
            : this.colorData[stateId];
        const companyData = this.currentMapMode === 'korea' 
            ? this.koreaCompanyData[stateId]
            : this.currentMapMode === 'japan'
            ? this.japanCompanyData[stateId]
            : this.companyData[stateId];
        
        // ì„ íƒëœ ì£¼ ì´ë¦„ í‘œì‹œ
        const selectedStateElement = document.getElementById('selected-state-name');
        if (selectedStateElement) {
            selectedStateElement.textContent = stateName;
        } else {
            console.warn('selected-state-name ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        
        // ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
        this.updateLogoPreview();
        
        // ìƒ‰ìƒ ì„¤ì • ì—…ë°ì´íŠ¸
        if (colorData) {
            const fillColorInput = document.getElementById('region-color');
            const borderColorInput = document.getElementById('border-color');
            const borderWidthInput = document.getElementById('border-width');
            
            if (fillColorInput) {
                fillColorInput.value = colorData.fillColor || '#4ecdc4';
            }
            if (borderColorInput) {
                borderColorInput.value = colorData.borderColor || '#ffffff';
            }
            if (borderWidthInput) {
                borderWidthInput.value = colorData.borderWidth || 1;
            }
        }
        
        // ê¸°ì—… ì •ë³´ ë¡œë“œ
        this.loadCompanyInfoForEdit(stateId);
        
        // ì§€ì—­ ì •ë³´ ë¡œë“œ
        this.loadRegionInfoForEdit(stateId);
        
        console.log('ê´€ë¦¬ì íŒ¨ë„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
    }
    
    // ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸
    updateLogoPreview() {
        const previewImg = document.getElementById('current-logo-img');
        const noLogoMsg = document.getElementById('no-logo');
        
        // ìš”ì†Œê°€ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
        if (!previewImg || !noLogoMsg) {
            console.warn('ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', { previewImg, noLogoMsg });
            return;
        }
        
        // í˜„ì¬ ì§€ë„ ëª¨ë“œì— ë”°ë¼ ì ì ˆí•œ ë°ì´í„° ì‚¬ìš©
        const logoData = this.currentMapMode === 'korea' 
            ? this.koreaLogoData[this.selectedStateId]
            : this.currentMapMode === 'japan'
            ? this.japanLogoData[this.selectedStateId]
            : this.logoData[this.selectedStateId];
        
        if (logoData && logoData.src) {
            previewImg.src = logoData.src;
            previewImg.style.display = 'block';
            noLogoMsg.style.display = 'none';
            console.log('ë¡œê³  ë¯¸ë¦¬ë³´ê¸° ì—…ë°ì´íŠ¸:', logoData.src);
        } else {
            previewImg.style.display = 'none';
            noLogoMsg.style.display = 'block';
            console.log('ë¡œê³  ë°ì´í„° ì—†ìŒ, ê¸°ë³¸ ë©”ì‹œì§€ í‘œì‹œ');
        }
    }
    
    getAdminValidationFieldConfig() {
        return [
            { id: 'region-population-input', label: 'ì¸êµ¬', min: 0, max: 10000000000, integer: true, unit: 'ëª…' },
            { id: 'region-area-input', label: 'ë©´ì ', min: 0, max: 50000000, integer: false, unit: 'kmÂ²' },
            { id: 'region-ad-price-input', label: 'ê´‘ê³  ê°€ê²©', min: 0, max: 1000000000, integer: false, unit: ' USD' },
            { id: 'region-auction-min-percent-input', label: 'ìµœì†Œ ì¸ìƒë¥ ', min: 0, max: 100, integer: false, unit: '%' },
            { id: 'region-auction-min-amount-input', label: 'ìµœì†Œ ì¸ìƒì•¡', min: 0, max: 10000000, integer: false, unit: ' USD' },
            { id: 'region-auction-protection-input', label: 'ë³´í˜¸ ì‹œê°„', min: 0, max: 168, integer: true, unit: 'ì‹œê°„' },
            { id: 'region-auction-rounding-input', label: 'ë°˜ì˜¬ë¦¼ ë‹¨ìœ„', min: 10, max: 1000000, integer: true, multipleOf: 10, unit: ' USD' },
            { id: 'region-auction-buy-now-input', label: 'ì¦‰ì‹œ êµ¬ë§¤ê°€', min: 0, max: 100000000, integer: false, unit: ' USD' },
            { id: 'region-auction-instant-transfer-input', label: 'ì¦‰ì‹œ ì´ì „ ë³´ë„ˆìŠ¤', min: 0, max: 100, integer: false, unit: '%' },
            { id: 'region-auction-defense-grace-input', label: 'ë””íœìŠ¤ ìœ ì˜ˆ', min: 0, max: 1440, integer: true, unit: 'ë¶„' }
        ];
    }

    setupAdminFormValidation() {
        if (this.adminValidationInitialized) return;
        this.adminValidationConfig = this.getAdminValidationFieldConfig();
        this.adminValidationConfig.forEach((config) => {
            const input = document.getElementById(config.id);
            if (!input) return;
            const handler = () => this.validateAdminNumericInput(input, config);
            input.addEventListener('input', handler);
            input.addEventListener('blur', handler);
        });
        this.adminValidationInitialized = true;
    }

    validateAdminNumericInput(input, config) {
        if (!input || !config) {
            return { valid: true, value: null };
        }
        const rawValue = (input.value ?? '').toString().trim();
        if (rawValue === '') {
            this.clearFieldError(input);
            return { valid: true, value: null };
        }
        const value = config.integer ? parseInt(rawValue, 10) : parseFloat(rawValue);
        if (Number.isNaN(value)) {
            const message = `${config.label}ì€ ìˆ«ìë§Œ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`;
            this.showFieldError(input, message);
            return { valid: false, message };
        }
        if (config.min !== undefined && value < config.min) {
            const message = `${config.label}ì€ ìµœì†Œ ${config.min}${config.unit || ''} ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.`;
            this.showFieldError(input, message);
            return { valid: false, message };
        }
        if (config.max !== undefined && value > config.max) {
            const message = `${config.label}ì€ ìµœëŒ€ ${config.max}${config.unit || ''} ì´í•˜ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
            this.showFieldError(input, message);
            return { valid: false, message };
        }
        if (config.multipleOf) {
            const remainder = value % config.multipleOf;
            if (Math.abs(remainder) > 1e-6 && Math.abs(remainder - config.multipleOf) > 1e-6) {
                const message = `${config.label}ì€ ${config.multipleOf}${config.unit || ''} ë‹¨ìœ„ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.`;
                this.showFieldError(input, message);
                return { valid: false, message };
            }
        }
        this.clearFieldError(input);
        return { valid: true, value };
    }

    showFieldError(input, message) {
        if (!input) return;
        input.classList.add('input-error');
        input.setAttribute('aria-invalid', 'true');
        const container = input.closest('.form-group') || input.parentElement;
        if (!container) return;
        let errorEl = container.querySelector('.form-error');
        if (!errorEl) {
            errorEl = document.createElement('p');
            errorEl.className = 'form-error';
            container.appendChild(errorEl);
        }
        errorEl.textContent = message;
    }

    clearFieldError(input) {
        if (!input) return;
        input.classList.remove('input-error');
        input.removeAttribute('aria-invalid');
        const container = input.closest('.form-group') || input.parentElement;
        const errorEl = container?.querySelector('.form-error');
        if (errorEl) {
            errorEl.textContent = '';
        }
    }
    
    // ì§€ì—­ ì •ë³´ í¸ì§‘ìš© ë¡œë“œ
    loadRegionInfoForEdit(stateId) {
        console.log('ì§€ì—­ ì •ë³´ ë¡œë“œ (í¸ì§‘ìš©):', stateId);
        
        const regionData = this.regionData.get(stateId);
        if (!regionData) {
            console.warn('ì§€ì—­ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', stateId);
            return;
        }
        
        // í¼ í•„ë“œì— ë°ì´í„° ì±„ìš°ê¸°
        const nameKoInput = document.getElementById('region-name-ko-input');
        const nameEnInput = document.getElementById('region-name-en-input');
        const countryInput = document.getElementById('region-country-input');
        const adminLevelInput = document.getElementById('region-admin-level-input');
        const populationInput = document.getElementById('region-population-input');
        const areaInput = document.getElementById('region-area-input');
        const adPriceInput = document.getElementById('region-ad-price-input');
        const adStatusInput = document.getElementById('region-ad-status-input');
        const seasonTagInput = document.getElementById('region-season-tag-input');
        const minPercentInput = document.getElementById('region-auction-min-percent-input');
        const minAmountInput = document.getElementById('region-auction-min-amount-input');
        const protectionInput = document.getElementById('region-auction-protection-input');
        const roundingInput = document.getElementById('region-auction-rounding-input');
        const buyNowInput = document.getElementById('region-auction-buy-now-input');
        const instantTransferInput = document.getElementById('region-auction-instant-transfer-input');
        const defenseGraceInput = document.getElementById('region-auction-defense-grace-input');

        let firstInvalidField = null;
        (this.adminValidationConfig || []).forEach((config) => {
            const targetInput = document.getElementById(config.id);
            if (!targetInput) return;
            const result = this.validateAdminNumericInput(targetInput, config);
            if (!result.valid && !firstInvalidField) {
                firstInvalidField = { input: targetInput, message: result.message };
            }
        });
        if (firstInvalidField) {
            if (firstInvalidField.message) {
                this.showNotification(firstInvalidField.message, 'error');
            } else {
                this.showNotification('ì…ë ¥ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
            }
            firstInvalidField.input?.focus();
            return;
        }
        
        if (nameKoInput) nameKoInput.value = regionData.name_ko || regionData.name || '';
        if (nameEnInput) nameEnInput.value = regionData.name_en || regionData.name || '';
        if (countryInput) countryInput.value = regionData.country || '';
        if (adminLevelInput) adminLevelInput.value = regionData.admin_level || '';
        if (populationInput) populationInput.value = regionData.population || 0;
        if (areaInput) areaInput.value = regionData.area || 0;
        if (adPriceInput) adPriceInput.value = regionData.ad_price || 0;
        if (adStatusInput) adStatusInput.value = regionData.ad_status || 'available';
        if (seasonTagInput) seasonTagInput.value = regionData.seasonTag || '';
        
        const config = regionData.auctionConfig || regionData.auction_settings || {};
        if (minPercentInput) {
            minPercentInput.value = typeof config.minIncrementPercent === 'number'
                ? (config.minIncrementPercent * 100).toFixed(2).replace(/\.?0+$/, '')
                : '';
        }
        if (minAmountInput) {
            minAmountInput.value = typeof config.minIncrementAmount === 'number'
                ? config.minIncrementAmount
                : '';
        }
        if (protectionInput) {
            protectionInput.value = typeof config.protectionHours === 'number' ? config.protectionHours : '';
        }
        if (roundingInput) {
            roundingInput.value = typeof config.roundingUnit === 'number' ? config.roundingUnit : '';
        }
        if (buyNowInput) {
            buyNowInput.value = typeof config.buyNowPrice === 'number' ? config.buyNowPrice : '';
        }
        if (instantTransferInput) {
            instantTransferInput.value = typeof config.instantTransferPercent === 'number'
                ? (config.instantTransferPercent * 100).toFixed(1).replace(/\.?0+$/, '')
                : '';
        }
        if (defenseGraceInput) {
            defenseGraceInput.value = typeof config.defenseGraceMinutes === 'number'
                ? config.defenseGraceMinutes
                : '';
        }
        
        console.log('ì§€ì—­ ì •ë³´ ë¡œë“œ ì™„ë£Œ:', regionData);
    }
    
    // ì§€ì—­ ì •ë³´ ì €ì¥
    async saveRegionInfo() {
        if (!this.selectedStateId) {
            this.showNotification('ì €ì¥í•  ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.', 'warning');
            return;
        }
        
        const regionData = this.regionData.get(this.selectedStateId);
        if (!regionData) {
            this.showNotification('ì§€ì—­ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
            return;
        }

        if (!this.adminValidationInitialized) {
            this.setupAdminFormValidation();
        }
        
        // í¼ì—ì„œ ë°ì´í„° ìˆ˜ì§‘
        const nameKoInput = document.getElementById('region-name-ko-input');
        const nameEnInput = document.getElementById('region-name-en-input');
        const countryInput = document.getElementById('region-country-input');
        const adminLevelInput = document.getElementById('region-admin-level-input');
        const populationInput = document.getElementById('region-population-input');
        const areaInput = document.getElementById('region-area-input');
        const adPriceInput = document.getElementById('region-ad-price-input');
        const adStatusInput = document.getElementById('region-ad-status-input');
        const seasonTagInput = document.getElementById('region-season-tag-input');
        const minPercentInput = document.getElementById('region-auction-min-percent-input');
        const minAmountInput = document.getElementById('region-auction-min-amount-input');
        const protectionInput = document.getElementById('region-auction-protection-input');
        const roundingInput = document.getElementById('region-auction-rounding-input');
        const buyNowInput = document.getElementById('region-auction-buy-now-input');
        const instantTransferInput = document.getElementById('region-auction-instant-transfer-input');
        const defenseGraceInput = document.getElementById('region-auction-defense-grace-input');
        
        // ì§€ì—­ ë°ì´í„° ì—…ë°ì´íŠ¸
        regionData.name_ko = nameKoInput?.value || regionData.name_ko || '';
        regionData.name_en = nameEnInput?.value || regionData.name_en || regionData.name || '';
        regionData.country = countryInput?.value || regionData.country || '';
        regionData.admin_level = adminLevelInput?.value || regionData.admin_level || '';
        regionData.population = parseInt(populationInput?.value) || regionData.population || 0;
        regionData.area = parseInt(areaInput?.value) || regionData.area || 0;
        
        const parsedAdPrice = parseFloat(adPriceInput?.value);
        if (!Number.isNaN(parsedAdPrice) && parsedAdPrice >= 0) {
            regionData.ad_price = parsedAdPrice;
        } else if (typeof regionData.ad_price !== 'number') {
            regionData.ad_price = this.uniformAdPrice;
        }
        
        regionData.ad_status = adStatusInput?.value || regionData.ad_status || 'available';
        
        const seasonTagValue = (seasonTagInput?.value || '').trim();
        if (seasonTagValue) {
            regionData.seasonTag = seasonTagValue;
        } else {
            delete regionData.seasonTag;
        }
        
        const existingConfig = regionData.auctionConfig || {};
        const auctionConfig = { ...existingConfig };
        
        const parsedMinPercent = parseFloat(minPercentInput?.value);
        if (!Number.isNaN(parsedMinPercent) && parsedMinPercent >= 0) {
            auctionConfig.minIncrementPercent = parsedMinPercent / 100;
        } else {
            delete auctionConfig.minIncrementPercent;
        }
        
        const parsedMinAmount = parseFloat(minAmountInput?.value);
        if (!Number.isNaN(parsedMinAmount) && parsedMinAmount >= 0) {
            auctionConfig.minIncrementAmount = parsedMinAmount;
        } else {
            delete auctionConfig.minIncrementAmount;
        }
        
        const parsedProtection = parseFloat(protectionInput?.value);
        if (!Number.isNaN(parsedProtection) && parsedProtection >= 0) {
            auctionConfig.protectionHours = parsedProtection;
        } else {
            delete auctionConfig.protectionHours;
        }
        
        const parsedRounding = parseFloat(roundingInput?.value);
        if (!Number.isNaN(parsedRounding) && parsedRounding > 0) {
            auctionConfig.roundingUnit = parsedRounding;
        } else {
            delete auctionConfig.roundingUnit;
        }
        
        const parsedBuyNow = parseFloat(buyNowInput?.value);
        if (!Number.isNaN(parsedBuyNow) && parsedBuyNow > 0) {
            auctionConfig.buyNowPrice = parsedBuyNow;
        } else {
            delete auctionConfig.buyNowPrice;
        }
        
        const parsedInstantTransfer = parseFloat(instantTransferInput?.value);
        if (!Number.isNaN(parsedInstantTransfer) && parsedInstantTransfer >= 0) {
            auctionConfig.instantTransferPercent = parsedInstantTransfer / 100;
        } else {
            delete auctionConfig.instantTransferPercent;
        }
        
        const parsedDefenseGrace = parseFloat(defenseGraceInput?.value);
        if (!Number.isNaN(parsedDefenseGrace) && parsedDefenseGrace >= 0) {
            auctionConfig.defenseGraceMinutes = parsedDefenseGrace;
        } else {
            delete auctionConfig.defenseGraceMinutes;
        }
        
        const configKeys = Object.keys(auctionConfig);
        if (configKeys.length > 0) {
            regionData.auctionConfig = auctionConfig;
        } else if (regionData.auctionConfig) {
            delete regionData.auctionConfig;
        }

        // regionData Map ì—…ë°ì´íŠ¸
        this.regionData.set(this.selectedStateId, regionData);
        
        // GeoJSON ì†ŒìŠ¤ ì—…ë°ì´íŠ¸ (ì§€ë„ì— ë°˜ì˜)
        if (this.map && this.map.getSource('world-regions')) {
            const source = this.map.getSource('world-regions');
            const geoJsonData = source._data;
            
            // í•´ë‹¹ featureì˜ properties ì—…ë°ì´íŠ¸
            const feature = geoJsonData.features.find(f => f.properties.id === this.selectedStateId);
            if (feature) {
                Object.assign(feature.properties, regionData);
                source.setData(geoJsonData);
            }
        }
        
        // í˜„ì¬ êµ­ê°€ë³„ GeoJSON ì†ŒìŠ¤ë„ ì—…ë°ì´íŠ¸
        const sourceId = this.getCurrentSourceId();
        if (this.map && this.map.getSource(sourceId)) {
            const source = this.map.getSource(sourceId);
            const geoJsonData = source._data;
            
            const feature = geoJsonData.features.find(f => f.properties.id === this.selectedStateId);
            if (feature) {
                Object.assign(feature.properties, regionData);
                source.setData(geoJsonData);
            }
        }
        
        // Firestoreì— ì €ì¥ (ë¹„ë™ê¸°)
        try {
            const saved = await this.saveRegionDataToFirestore(this.selectedStateId, regionData);
            if (saved) {
                this.showNotification('ì§€ì—­ ì •ë³´ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤! (Firestore ë™ê¸°í™” ì™„ë£Œ)', 'success');
                console.log('Firestoreì— ì§€ì—­ ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, regionData);
            } else {
                this.showNotification('ì§€ì—­ ì •ë³´ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (Firestore ë™ê¸°í™” ì‹¤íŒ¨)', 'warning');
                console.log('ë¡œì»¬ì—ë§Œ ì§€ì—­ ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, regionData);
            }
        } catch (error) {
            console.error('ì§€ì—­ ì •ë³´ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            this.showNotification('ì§€ì—­ ì •ë³´ê°€ ë¡œì»¬ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (Firestore ë™ê¸°í™” ì‹¤íŒ¨)', 'warning');
            console.log('ë¡œì»¬ì—ë§Œ ì§€ì—­ ì •ë³´ ì €ì¥ ì™„ë£Œ:', this.selectedStateId, regionData);
        }
        
        if (this.currentRegion && this.currentRegion.id === this.selectedStateId) {
            this.currentRegion = { ...this.currentRegion, ...regionData };
            this.updateAuctionPanel(this.currentRegion);
            this.updateCompanyModalAuctionSection(this.selectedStateId);
        }
        this.updateAuctionWidgets();
    }
    
    // ëª¨ë‹¬ì—ì„œ í¸ì§‘ ë²„íŠ¼ í´ë¦­ ì‹œ ê´€ë¦¬ì íŒ¨ë„ ì—´ê¸°
    openRegionEditFromModal() {
        if (!this.isAdminLoggedIn) {
            this.showNotification('ê´€ë¦¬ì ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'warning');
            return;
        }
        
        // ëª¨ë‹¬ ë‹«ê¸°
        this.hideCompanyInfoModal();
        this.hideRegionInfoModal();
        
        // ê´€ë¦¬ì íŒ¨ë„ í‘œì‹œ
        const adminPanel = document.getElementById('admin-panel');
        if (adminPanel) {
            adminPanel.classList.remove('hidden');
        }
        
        // ê´€ë¦¬ì ëª¨ë“œ í™œì„±í™”
        this.adminMode = true;
        this.updateAdminModeControls();
        
        // ì§€ì—­ ì •ë³´ ë¡œë“œ
        if (this.currentRegion && this.currentRegion.id) {
            this.selectedStateId = this.currentRegion.id;
            const regionName = this.getRegionDisplayName(this.currentRegion);
            this.updateAdminPanel(this.selectedStateId, regionName);
        }
    }
    
    // í˜„ì¬ ì†ŒìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
    getCurrentSourceId() {
        const sourceMap = {
            'usa': 'world-regions',
            'korea': 'korea-regions',
            'japan': 'japan-regions',
            'china': 'china-regions',
            'russia': 'russia-regions',
            'india': 'india-regions',
            'canada': 'canada-regions',
            'germany': 'germany-regions',
            'uk': 'uk-regions',
            'france': 'france-regions',
            'italy': 'italy-regions',
            'brazil': 'brazil-regions',
            'australia': 'australia-regions',
            'mexico': 'mexico-regions',
            'indonesia': 'indonesia-regions',
            'saudi-arabia': 'saudi-arabia-regions',
            'turkey': 'turkey-regions',
            'south-africa': 'south-africa-regions',
            'argentina': 'argentina-regions',
            'european-union': 'european-union-regions',
            'spain': 'spain-regions',
            'netherlands': 'netherlands-regions',
            'poland': 'poland-regions',
            'belgium': 'belgium-regions',
            'sweden': 'sweden-regions',
            'austria': 'austria-regions',
            'denmark': 'denmark-regions',
            'finland': 'finland-regions',
            'ireland': 'ireland-regions',
            'portugal': 'portugal-regions',
            'greece': 'greece-regions',
            'czech-republic': 'czech-republic-regions',
            'romania': 'romania-regions',
            'hungary': 'hungary-regions',
            'bulgaria': 'bulgaria-regions'
        };
        
        return sourceMap[this.currentMapMode] || 'world-regions';
    }
    
    // ============================================
    // ëœë”© í˜ì´ì§€ ë° ì‹œì¦Œ ì‹œìŠ¤í…œ ë©”ì„œë“œ
    // ============================================
    
    // ëœë”© í˜ì´ì§€ ì´ˆê¸°í™”
    initializeLandingPage() {
        const landingOverlay = document.getElementById('landing-overlay');
        const exploreBtn = document.getElementById('landing-explore-btn');
        
        if (!landingOverlay || !exploreBtn) return;
        
        // ëœë”© ì˜¤ë²„ë ˆì´ í•­ìƒ ìˆ¨ê¸°ê¸°
        landingOverlay.classList.add('hidden');
        this.landingOverlayVisible = false;
    }
    
    // ëœë”© í˜ì´ì§€ í†µê³„ ì—…ë°ì´íŠ¸
    async updateLandingStats() {
        if (!this.landingOverlayVisible) return;
        
        try {
            // ì‹œì¦Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
            const seasonData = await this.getCurrentSeasonData();
            
            const remainingPixels = seasonData.totalPixels - seasonData.soldPixels;
            const participants = seasonData.participants;
            
            // ë‚¨ì€ í”½ì…€ í‘œì‹œ
            const remainingEl = document.getElementById('landing-remaining-pixels');
            if (remainingEl) {
                remainingEl.textContent = remainingPixels.toLocaleString();
            }
            
            // ì°¸ì—¬ì ìˆ˜ í‘œì‹œ
            const participantsEl = document.getElementById('landing-participants');
            if (participantsEl) {
                participantsEl.textContent = participants.toLocaleString();
            }
            
            // ì‹œì¦Œ ì¢…ë£Œê¹Œì§€ ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            this.updateSeasonCountdown(seasonData);
            
            const endTimeEl = document.getElementById('landing-season-end');
            if (endTimeEl) {
                const countdown = this.formatSeasonCountdown(seasonData.endDate);
                endTimeEl.textContent = countdown;
            }
        } catch (error) {
            console.error('ëœë”© í†µê³„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // í˜„ì¬ ì‹œì¦Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
    async getCurrentSeasonData() {
        // Firestoreì—ì„œ ì‹œì¦Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        if (this.isFirebaseInitialized && this.firestore) {
            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const seasonRef = doc(this.firestore, 'seasons', this.currentSeason.id);
                const seasonDoc = await getDoc(seasonRef);
                
                if (seasonDoc.exists) {
                    const data = seasonDoc.data();
                    // Timestampë¥¼ Dateë¡œ ë³€í™˜
                    const seasonData = {
                        ...this.currentSeason,
                        ...data,
                        startDate: data.startDate?.toDate ? data.startDate.toDate() : (data.startDate || this.currentSeason.startDate),
                        endDate: data.endDate?.toDate ? data.endDate.toDate() : (data.endDate || this.currentSeason.endDate)
                    };
                    // ë©”ëª¨ë¦¬ì—ë„ ì—…ë°ì´íŠ¸
                    this.currentSeason = seasonData;
                    return seasonData;
                } else {
                    // Firestoreì— ì‹œì¦Œì´ ì—†ìœ¼ë©´ ìƒì„±
                    await this.createSeasonInFirestore(this.currentSeason);
                    // ìƒì„± í›„ í˜„ì¬ ì‹œì¦Œ ë°ì´í„° ë°˜í™˜
                    return this.currentSeason;
                }
            } catch (error) {
                console.error('ì‹œì¦Œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
            }
        }
        // Firestoreê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° ê¸°ë³¸ ì‹œì¦Œ ë°ì´í„° ë°˜í™˜
        return this.currentSeason;
        
        // ê¸°ë³¸ê°’ ë°˜í™˜
        return this.currentSeason;
    }
    
    // ì‹œì¦Œë³„ ì‹œì‘ê°€ ê³„ì‚° (ì‹œì¦Œ ë²ˆí˜¸ì— ë”°ë¼ ê°€ê²© ì¡°ì ˆ)
    calculateSeasonStartingPrice(seasonNumber, basePrice = 1000) {
        // ì²« ì‹œì¦Œì€ ê¸°ë³¸ ê°€ê²©ì˜ 50%ë¡œ ì‹œì‘
        // ì´í›„ ì‹œì¦Œì€ ì‹œì¦Œ ë²ˆí˜¸ì— ë”°ë¼ ì ì§„ì ìœ¼ë¡œ ì¦ê°€ (ìµœëŒ€ 100%)
        const seasonDiscount = Math.max(0.5, 1.0 - (seasonNumber - 1) * 0.1);
        return Math.max(Math.floor(basePrice * seasonDiscount), Math.floor(basePrice * 0.3));
    }
    
    // ì‹œì¦Œ ì‹œì‘ ì‹œ ëª¨ë“  êµ¬ì—­ ê°€ê²© ì´ˆê¸°í™”
    async resetAllRegionPricesForNewSeason(seasonNumber) {
        if (!this.regionData || this.regionData.size === 0) {
            console.warn('êµ¬ì—­ ë°ì´í„°ê°€ ì—†ì–´ ê°€ê²© ì´ˆê¸°í™”ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
            return;
        }
        
        const basePrice = this.uniformAdPrice || 1000;
        const startingPrice = this.calculateSeasonStartingPrice(seasonNumber, basePrice);
        
        console.log(`ì‹œì¦Œ ${seasonNumber} ì‹œì‘ê°€ ì„¤ì •: ${startingPrice} (ê¸°ë³¸ê°€: ${basePrice})`);
        
        // ëª¨ë“  êµ¬ì—­ì˜ ê°€ê²©ì„ ì‹œì‘ê°€ë¡œ ì„¤ì •
        for (const [regionId, region] of this.regionData.entries()) {
            const originalPrice = region.ad_price || basePrice;
            region.ad_price = startingPrice;
            
            // Firestoreì— ê°€ê²© ì—…ë°ì´íŠ¸ (ì˜µì…˜)
            if (this.isFirebaseInitialized && this.firestore) {
                try {
                    const { collection, query, where, getDocs, updateDoc, doc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                    const regionsRef = collection(this.firestore, 'regions');
                    const q = query(regionsRef, where('id', '==', regionId));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const regionDoc = querySnapshot.docs[0];
                        await updateDoc(doc(this.firestore, 'regions', regionDoc.id), {
                            ad_price: startingPrice,
                            original_price: originalPrice,
                            price_reset_at: new Date().toISOString(),
                            season_number: seasonNumber
                        });
                    }
                } catch (error) {
                    console.error(`êµ¬ì—­ ${regionId} ê°€ê²© ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:`, error);
                }
            }
        }
        
        // ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
        this.uniformAdPrice = startingPrice;
        this.updateMapSourcesWithRegionData();
        
        console.log(`ì‹œì¦Œ ${seasonNumber} ì‹œì‘ê°€ ì„¤ì • ì™„ë£Œ: ${this.regionData.size}ê°œ êµ¬ì—­`);
    }
    
    // Firestoreì— ì‹œì¦Œ ìƒì„±
    async createSeasonInFirestore(seasonData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ì‹œì¦Œ ìƒì„±: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!seasonData || !seasonData.id) {
            console.error('ì‹œì¦Œ ìƒì„±: ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œì¦Œ ë°ì´í„°ì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { doc, setDoc, Timestamp, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const seasonRef = doc(this.firestore, 'seasons', seasonData.id);
            const seasonDoc = await getDoc(seasonRef);
            
            // ì‹œì¦Œì´ ìƒˆë¡œ ìƒì„±ë˜ëŠ” ê²½ìš°ì—ë§Œ ê°€ê²© ì´ˆê¸°í™”
            const isNewSeason = !seasonDoc.exists();
            
            await setDoc(seasonRef, {
                id: seasonData.id,
                name: seasonData.name || `ì‹œì¦Œ ${seasonData.id}`,
                startDate: Timestamp.fromDate(seasonData.startDate || new Date()),
                endDate: Timestamp.fromDate(seasonData.endDate || new Date()),
                totalPixels: seasonData.totalPixels || 10000,
                soldPixels: seasonData.soldPixels || 0,
                participants: seasonData.participants || 0,
                status: seasonData.status || 'active',
                createdAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            }, { merge: true });
            
            console.log('ì‹œì¦Œ ë°ì´í„°ê°€ Firestoreì— ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤:', seasonData.id);
            
            // ìƒˆ ì‹œì¦Œì¸ ê²½ìš° ëª¨ë“  êµ¬ì—­ ê°€ê²© ì´ˆê¸°í™”
            if (isNewSeason) {
                // ì‹œì¦Œ ë²ˆí˜¸ ì¶”ì¶œ (ì˜ˆ: "2025-S1" -> 1)
                const seasonMatch = seasonData.id.match(/S(\d+)/);
                const seasonNumber = seasonMatch ? parseInt(seasonMatch[1], 10) : 1;
                await this.resetAllRegionPricesForNewSeason(seasonNumber);
            }
        } catch (error) {
            console.error('ì‹œì¦Œ ìƒì„± ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ì‹œì¦Œ ìƒì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // Firestoreì— ì‹œì¦Œ ì—…ë°ì´íŠ¸
    async updateSeasonInFirestore(seasonData) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ì‹œì¦Œ ì—…ë°ì´íŠ¸: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!seasonData || !seasonData.id) {
            console.error('ì‹œì¦Œ ì—…ë°ì´íŠ¸: ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œì¦Œ ë°ì´í„°ì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { doc, setDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const seasonRef = doc(this.firestore, 'seasons', seasonData.id);
            
            const updateData = {
                ...seasonData,
                updatedAt: Timestamp.now()
            };
            
            // Date ê°ì²´ë¥¼ Timestampë¡œ ë³€í™˜
            if (seasonData.startDate instanceof Date) {
                updateData.startDate = Timestamp.fromDate(seasonData.startDate);
            }
            if (seasonData.endDate instanceof Date) {
                updateData.endDate = Timestamp.fromDate(seasonData.endDate);
            }
            
            await setDoc(seasonRef, updateData, { merge: true });
            console.log('ì‹œì¦Œ ë°ì´í„°ê°€ Firestoreì— ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤:', seasonData.id);
        } catch (error) {
            console.error('ì‹œì¦Œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ì‹œì¦Œ ì—…ë°ì´íŠ¸ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // ì‹œì¦Œ ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
    initializeSeasonDashboard() {
        const dashboard = document.getElementById('season-dashboard');
        const closeBtn = document.getElementById('close-season-dashboard');
        const highlightsBtn = document.getElementById('dashboard-highlights-btn');
        const participateBtn = document.getElementById('dashboard-participate-btn');
        
        if (!dashboard) return;
        
        // ë‹«ê¸° ë²„íŠ¼
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                dashboard.classList.add('hidden');
            });
        }
        
        // ëŒ€í‘œ í”½ì…€ ë³´ê¸° ë²„íŠ¼
        if (highlightsBtn) {
            highlightsBtn.addEventListener('click', () => {
                this.showPixelHighlights();
            });
        }
        
        // ì°¸ì—¬í•˜ê¸° ë²„íŠ¼
        if (participateBtn) {
            participateBtn.addEventListener('click', () => {
                this.showParticipationGuide();
            });
        }
        
        // ì£¼ê¸°ì ìœ¼ë¡œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
        this.updateSeasonDashboard();
        setInterval(() => this.updateSeasonDashboard(), 60000); // 1ë¶„ë§ˆë‹¤
    }
    
    // ì‹œì¦Œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    async updateSeasonDashboard() {
        try {
            const seasonData = await this.getCurrentSeasonData();
            
            // ì‹œì¦Œ ë°°ì§€
            const badgeEl = document.getElementById('current-season-badge');
            if (badgeEl) {
                badgeEl.textContent = seasonData.name || seasonData.id;
            }
            
            // ì§„í–‰ë¥  ê³„ì‚°
            const progress = (seasonData.soldPixels / seasonData.totalPixels) * 100;
            const progressFill = document.getElementById('season-progress-fill');
            const progressText = document.getElementById('season-progress-text');
            
            if (progressFill) {
                progressFill.style.width = `${progress}%`;
            }
            if (progressText) {
                progressText.textContent = `${progress.toFixed(1)}%`;
            }
            
            // í†µê³„ ì—…ë°ì´íŠ¸
            const totalPixelsEl = document.getElementById('dashboard-total-pixels');
            const soldPixelsEl = document.getElementById('dashboard-sold-pixels');
            const participantsEl = document.getElementById('dashboard-participants');
            const revenueEl = document.getElementById('dashboard-revenue');
            
            if (totalPixelsEl) totalPixelsEl.textContent = seasonData.totalPixels.toLocaleString();
            if (soldPixelsEl) soldPixelsEl.textContent = seasonData.soldPixels.toLocaleString();
            if (participantsEl) participantsEl.textContent = seasonData.participants.toLocaleString();
            if (revenueEl) {
                const revenue = await this.calculateTotalRevenue();
                revenueEl.textContent = `$${revenue.toLocaleString()}`;
            }
            
            // ì™„íŒ ì²´í¬ ë° ìë™ ì•„ì¹´ì´ë¸Œ ì „í™˜
            if (seasonData.soldPixels >= seasonData.totalPixels && seasonData.status !== 'archived') {
                await this.archiveSeasonWhenSoldOut(seasonData.id);
            }
            
            // íƒ€ì„ë¼ì¸ ì—…ë°ì´íŠ¸
            await this.updateSeasonTimelineUI();
        } catch (error) {
            console.error('ì‹œì¦Œ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì‹œì¦Œ íƒ€ì„ë¼ì¸ UI ì—…ë°ì´íŠ¸
    async updateSeasonTimelineUI() {
        const timelineContainer = document.getElementById('season-timeline-container');
        if (!timelineContainer) return;
        
        try {
            // Firestoreì—ì„œ íƒ€ì„ë¼ì¸ ë°ì´í„° ë¡œë“œ
            let timelineEvents = [];
            if (this.isFirebaseInitialized && this.firestore) {
                const { collection, query, orderBy, limit, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const timelineRef = collection(this.firestore, 'seasons', this.currentSeason.id, 'timeline');
                const q = query(timelineRef, orderBy('timestamp', 'desc'), limit(100));
                const snapshot = await getDocs(q);
                
                timelineEvents = snapshot.docs.map(doc => {
                    const data = doc.data();
                    return {
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp?.toMillis ? data.timestamp.toMillis() : (data.timestamp || Date.now())
                    };
                });
            } else {
                // ë©”ëª¨ë¦¬ì—ì„œ íƒ€ì„ë¼ì¸ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                timelineEvents = this.seasonTimeline
                    .sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0))
                    .slice(0, 100);
            }
            
            // íƒ€ì„ë¼ì¸ í•„í„° ë° ê²€ìƒ‰ UI ìƒì„±
            if (!timelineContainer.querySelector('.timeline-controls')) {
                const controlsEl = document.createElement('div');
                controlsEl.className = 'timeline-controls';
                controlsEl.innerHTML = `
                    <div class="timeline-filters">
                        <select id="timeline-filter-type" class="timeline-filter">
                            <option value="all">ëª¨ë“  ì´ë²¤íŠ¸</option>
                            <option value="conquest">ì ë ¹</option>
                            <option value="purchase">êµ¬ë§¤</option>
                            <option value="auction">ì˜¥ì…˜</option>
                            <option value="pixel_created">í”½ì…€ ìƒì„±</option>
                            <option value="defense">ë°©ì–´</option>
                            <option value="mission_completed">ë¯¸ì…˜ ì™„ë£Œ</option>
                            <option value="badge_earned">ë±ƒì§€ íšë“</option>
                        </select>
                        <input type="text" id="timeline-search" class="timeline-search" placeholder="ê²€ìƒ‰...">
                        <button id="timeline-jump-to-top" class="timeline-jump-btn" title="ìµœì‹  ì´ë²¤íŠ¸ë¡œ ì´ë™">â¬†ï¸ ìµœì‹ </button>
                    </div>
                `;
                timelineContainer.appendChild(controlsEl);
                
                // í•„í„° ë° ê²€ìƒ‰ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                const filterSelect = controlsEl.querySelector('#timeline-filter-type');
                const searchInput = controlsEl.querySelector('#timeline-search');
                const jumpToTopBtn = controlsEl.querySelector('#timeline-jump-to-top');
                
                const applyFilters = () => {
                    this.renderTimelineEvents(timelineEvents, filterSelect.value, searchInput.value);
                };
                
                filterSelect.addEventListener('change', applyFilters);
                searchInput.addEventListener('input', applyFilters);
                
                // ìµœì‹  ì´ë²¤íŠ¸ë¡œ ì´ë™ ë²„íŠ¼
                if (jumpToTopBtn) {
                    jumpToTopBtn.addEventListener('click', () => {
                        const eventsList = timelineContainer.querySelector('.timeline-events-list');
                        if (eventsList) {
                            eventsList.scrollTo({ top: 0, behavior: 'smooth' });
                        }
                    });
                }
            }
            
            // íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ë Œë”ë§
            const filterType = document.getElementById('timeline-filter-type')?.value || 'all';
            const searchQuery = document.getElementById('timeline-search')?.value || '';
            this.renderTimelineEvents(timelineEvents, filterType, searchQuery);
        } catch (error) {
            console.error('íƒ€ì„ë¼ì¸ UI ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            timelineContainer.innerHTML = '<div class="timeline-error">íƒ€ì„ë¼ì¸ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }
    
    // íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ë Œë”ë§
    renderTimelineEvents(events, filterType = 'all', searchQuery = '') {
        const timelineContainer = document.getElementById('season-timeline-container');
        if (!timelineContainer) return;
        
        // í•„í„°ë§
        let filteredEvents = events;
        if (filterType !== 'all') {
            filteredEvents = filteredEvents.filter(event => event.type === filterType);
        }
        
        // ê²€ìƒ‰
        if (searchQuery.trim()) {
            const query = searchQuery.toLowerCase();
            filteredEvents = filteredEvents.filter(event => {
                const text = this.getTimelineEventText(event).toLowerCase();
                const regionName = (event.regionName || event.regionId || '').toLowerCase();
                const buyerEmail = (event.buyerEmail || '').toLowerCase();
                return text.includes(query) || regionName.includes(query) || buyerEmail.includes(query);
            });
        }
        
        // ì´ë²¤íŠ¸ ëª©ë¡ ì»¨í…Œì´ë„ˆ ì°¾ê¸° ë˜ëŠ” ìƒì„±
        let eventsList = timelineContainer.querySelector('.timeline-events-list');
        if (!eventsList) {
            eventsList = document.createElement('div');
            eventsList.className = 'timeline-events-list';
            timelineContainer.appendChild(eventsList);
        }
        
        if (filteredEvents.length === 0) {
            eventsList.innerHTML = '<div class="timeline-empty">ì¡°ê±´ì— ë§ëŠ” íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
            return;
        }
        
        // íƒ€ì„ë¼ì¸ UI ìƒì„± (ì‹œê°ì ìœ¼ë¡œ ê°œì„ ëœ ë²„ì „)
        eventsList.innerHTML = '';
        
        // íƒ€ì„ë¼ì¸ì„ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬
        const sortedEvents = [...filteredEvents].sort((a, b) => {
            const timeA = a.timestamp || 0;
            const timeB = b.timestamp || 0;
            return timeB - timeA; // ìµœì‹ ìˆœ
        });
        
        sortedEvents.forEach((event, index) => {
            const eventEl = document.createElement('div');
            eventEl.className = 'timeline-event';
            eventEl.dataset.eventId = event.id || index;
            eventEl.dataset.timestamp = event.timestamp;
            eventEl.dataset.eventType = event.type;
            
            // í´ë¦­ ì‹œ í•´ë‹¹ ì§€ì—­ìœ¼ë¡œ ì´ë™
            if (event.regionId) {
                eventEl.style.cursor = 'pointer';
                eventEl.addEventListener('click', () => {
                    this.zoomToRegion(event.regionId);
                });
            }
            
            const eventIcon = this.getTimelineEventIcon(event.type);
            const eventText = this.getTimelineEventText(event);
            const eventTime = this.formatRelativeTime(event.timestamp);
            const eventDate = new Date(event.timestamp).toLocaleString('ko-KR', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
            
            // ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ìƒ‰ìƒ í´ë˜ìŠ¤
            const typeClass = `timeline-event-${event.type}`;
            
            eventEl.innerHTML = `
                <div class="timeline-event-line"></div>
                <div class="timeline-event-icon ${typeClass}">${eventIcon}</div>
                <div class="timeline-event-content">
                    <div class="timeline-event-header">
                        <div class="timeline-event-text">${eventText}</div>
                        <div class="timeline-event-badge">${this.getTimelineEventTypeLabel(event.type)}</div>
                    </div>
                    <div class="timeline-event-footer">
                        <div class="timeline-event-time">${eventTime}</div>
                        <div class="timeline-event-date">${eventDate}</div>
                    </div>
                </div>
            `;
            
            eventsList.appendChild(eventEl);
        });
        
        // íƒ€ì„ë¼ì¸ ìŠ¤í¬ë¡¤ì„ ìµœìƒë‹¨ìœ¼ë¡œ ì´ë™
        if (eventsList.scrollTop !== 0) {
            eventsList.scrollTop = 0;
        }
    }
    
    // íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ íƒ€ì… ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
    getTimelineEventTypeLabel(eventType) {
        const labels = {
            'conquest': 'ì ë ¹',
            'purchase': 'êµ¬ë§¤',
            'auction': 'ì˜¥ì…˜',
            'pixel_created': 'í”½ì…€ ìƒì„±',
            'defense': 'ë°©ì–´',
            'mission_completed': 'ë¯¸ì…˜ ì™„ë£Œ',
            'badge_earned': 'ë±ƒì§€ íšë“'
        };
        return labels[eventType] || eventType;
    }
    
    // íŠ¹ì • ì§€ì—­ìœ¼ë¡œ ì¤Œ
    zoomToRegion(regionId) {
        if (!this.map || !regionId) return;
        
        const region = this.regionData.get(regionId);
        if (!region) return;
        
        // ì§€ì—­ì˜ ì¤‘ì‹¬ì  ì°¾ê¸°
        const source = this.map.getSource('world-regions');
        if (!source || !source._data) return;
        
        const feature = source._data.features.find(f => f.properties.id === regionId);
        if (!feature || !feature.geometry) return;
        
        let center = null;
        if (feature.geometry.type === 'Polygon') {
            const coords = feature.geometry.coordinates[0];
            const lons = coords.map(c => c[0]);
            const lats = coords.map(c => c[1]);
            center = [
                (Math.min(...lons) + Math.max(...lons)) / 2,
                (Math.min(...lats) + Math.max(...lats)) / 2
            ];
        } else if (feature.geometry.type === 'MultiPolygon') {
            const allCoords = feature.geometry.coordinates.flat();
            const lons = allCoords.flat().map(c => c[0]);
            const lats = allCoords.flat().map(c => c[1]);
            center = [
                (Math.min(...lons) + Math.max(...lons)) / 2,
                (Math.min(...lats) + Math.max(...lats)) / 2
            ];
        }
        
        if (center) {
            this.map.easeTo({
                center: center,
                zoom: Math.max(this.map.getZoom(), 6),
                duration: 1000
            });
            
            // ì§€ì—­ ì •ë³´ íŒ¨ë„ í‘œì‹œ
            setTimeout(() => {
                this.showInfoPanel(region);
            }, 500);
        }
    }
    
    // íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ ì•„ì´ì½˜ ê°€ì ¸ì˜¤ê¸°
    getTimelineEventIcon(eventType) {
        const icons = {
            'conquest': 'ğŸ¯',
            'purchase': 'ğŸ’°',
            'auction': 'ğŸ”¨',
            'pixel_created': 'ğŸ¨',
            'defense': 'ğŸ›¡ï¸',
            'mission_completed': 'âœ…',
            'badge_earned': 'ğŸ†'
        };
        return icons[eventType] || 'ğŸ“Œ';
    }
    
    // íƒ€ì„ë¼ì¸ ì´ë²¤íŠ¸ í…ìŠ¤íŠ¸ ìƒì„±
    getTimelineEventText(event) {
        switch (event.type) {
            case 'conquest':
                if (event.method === 'purchase') {
                    return `${event.regionName || event.regionId} êµ¬ë§¤ - ${this.formatCurrency(event.amount || 0)}`;
                } else if (event.method === 'auction') {
                    return `${event.regionName || event.regionId} ë‚™ì°° - ${this.formatCurrency(event.amount || 0)}`;
                }
                return `${event.regionName || event.regionId} ì ë ¹`;
            case 'pixel_created':
                return `í”½ì…€ ìƒì„±: ${event.regionName || event.regionId}`;
            case 'defense':
                return `ë°©ì–´ ì„±ê³µ: ${event.regionName || event.regionId}`;
            case 'mission_completed':
                return `ë¯¸ì…˜ ì™„ë£Œ: ${event.missionName || 'ë¯¸ì…˜'}`;
            case 'badge_earned':
                return `ë±ƒì§€ íšë“: ${event.badgeName || 'ë±ƒì§€'}`;
            default:
                return `${event.type || 'ì´ë²¤íŠ¸'}: ${event.regionName || event.regionId || ''}`;
        }
    }
    
    // ì‹œì¦Œ ì¢…ë£Œ ì‹œ ìµœì¢… ì†Œìœ ì ê¸°ë¡ ì €ì¥
    async recordFinalOwnersForSeason(seasonId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ìµœì¢… ì†Œìœ ì ê¸°ë¡: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { collection, query, getDocs, doc, setDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ëª¨ë“  êµ¬ì—­ì˜ ìµœì¢… ì†Œìœ ì ìˆ˜ì§‘
            const finalOwners = [];
            
            // êµ¬ë§¤ ê¸°ë¡ì—ì„œ ìµœì¢… ì†Œìœ ì ì°¾ê¸°
            const purchasesRef = collection(this.firestore, 'purchases');
            const purchasesQuery = query(purchasesRef);
            const purchasesSnapshot = await getDocs(purchasesQuery);
            
            const regionOwners = new Map();
            purchasesSnapshot.forEach(doc => {
                const data = doc.data();
                const regionId = data.regionId;
                if (regionId) {
                    // ê°€ì¥ ìµœê·¼ êµ¬ë§¤ ê¸°ë¡ì´ ìµœì¢… ì†Œìœ ì
                    const purchaseTime = data.purchaseDate?.toMillis ? data.purchaseDate.toMillis() : (data.purchaseDate || 0);
                    if (!regionOwners.has(regionId) || purchaseTime > regionOwners.get(regionId).timestamp) {
                        regionOwners.set(regionId, {
                            regionId: regionId,
                            regionName: data.regionName || regionId,
                            ownerEmail: data.buyerEmail || 'unknown',
                            amount: data.amount || 0,
                            timestamp: purchaseTime
                        });
                    }
                }
            });
            
            // ì˜¥ì…˜ ë°ì´í„°ì—ì„œ ìµœì¢… ì†Œìœ ì ì°¾ê¸°
            const auctionsRef = collection(this.firestore, 'auctions');
            const auctionsSnapshot = await getDocs(auctionsRef);
            auctionsSnapshot.forEach(doc => {
                const data = doc.data();
                const regionId = data.regionId;
                if (regionId && data.currentBidder) {
                    const bidTime = data.lastBidAt?.toMillis ? data.lastBidAt.toMillis() : (data.lastBidAt || 0);
                    if (!regionOwners.has(regionId) || bidTime > regionOwners.get(regionId).timestamp) {
                        regionOwners.set(regionId, {
                            regionId: regionId,
                            regionName: data.regionName || regionId,
                            ownerEmail: data.currentBidder.email || 'unknown',
                            amount: data.currentBid || 0,
                            timestamp: bidTime
                        });
                    }
                }
            });
            
            // ìµœì¢… ì†Œìœ ì ë°ì´í„°ë¥¼ ì‹œì¦Œ ë¬¸ì„œì— ì €ì¥
            const seasonRef = doc(this.firestore, 'seasons', seasonId);
            await setDoc(seasonRef, {
                finalOwners: Array.from(regionOwners.values()),
                finalOwnersRecordedAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            }, { merge: true });
            
            console.log(`ì‹œì¦Œ ${seasonId} ìµœì¢… ì†Œìœ ì ê¸°ë¡ ì™„ë£Œ: ${regionOwners.size}ê°œ êµ¬ì—­`);
        } catch (error) {
            console.error('ìµœì¢… ì†Œìœ ì ê¸°ë¡ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì™„íŒ ì‹œ ì‹œì¦Œ ìë™ ì•„ì¹´ì´ë¸Œ ì „í™˜
    async archiveSeasonWhenSoldOut(seasonId) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!seasonId) {
            console.error('ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ: ìœ íš¨í•˜ì§€ ì•Šì€ ì‹œì¦Œ IDì…ë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { doc, setDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const seasonRef = doc(this.firestore, 'seasons', seasonId);
            
            await setDoc(seasonRef, {
                status: 'archived',
                archivedAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            }, { merge: true });
            
            // ìµœì¢… ì†Œìœ ì ê¸°ë¡
            await this.recordFinalOwnersForSeason(seasonId);
            
            // ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
            if (this.currentSeason.id === seasonId) {
                this.currentSeason.status = 'archived';
            }
            
            console.log(`ì‹œì¦Œ ${seasonId}ê°€ ì™„íŒë˜ì–´ ìë™ìœ¼ë¡œ ì•„ì¹´ì´ë¸Œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            this.showNotification('ì‹œì¦Œì´ ì™„íŒë˜ì–´ ì•„ì¹´ì´ë¸Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            
            // ìƒˆ ì‹œì¦Œ ìë™ ìƒì„± (ì„ íƒì‚¬í•­)
            await this.createNextSeason().catch(err => {
                console.error('ë‹¤ìŒ ì‹œì¦Œ ìƒì„± ì‹¤íŒ¨:', err);
            });
        } catch (error) {
            console.error('ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // ë‹¤ìŒ ì‹œì¦Œ ìë™ ìƒì„±
    async createNextSeason() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ë‹¤ìŒ ì‹œì¦Œ ìƒì„±: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { collection, query, orderBy, limit, getDocs, doc, setDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ë§ˆì§€ë§‰ ì‹œì¦Œ ì°¾ê¸°
            const seasonsQuery = query(
                collection(this.firestore, 'seasons'),
                orderBy('createdAt', 'desc'),
                limit(1)
            );
            const snapshot = await getDocs(seasonsQuery);
            
            let nextSeasonNumber = 1;
            if (!snapshot.empty) {
                const lastSeason = snapshot.docs[0].data();
                const lastSeasonId = lastSeason.id || '';
                const match = lastSeasonId.match(/S(\d+)/);
                if (match) {
                    nextSeasonNumber = parseInt(match[1]) + 1;
                }
            }
            
            const currentYear = new Date().getFullYear();
            const nextSeasonId = `${currentYear}-S${nextSeasonNumber}`;
            const nextSeasonName = `ì‹œì¦Œ ${nextSeasonNumber}`;
            
            const startDate = new Date();
            startDate.setDate(startDate.getDate() + 1); // ë‚´ì¼ ì‹œì‘
            const endDate = new Date(startDate);
            endDate.setFullYear(endDate.getFullYear() + 1); // 1ë…„ í›„ ì¢…ë£Œ
            
            const nextSeasonRef = doc(this.firestore, 'seasons', nextSeasonId);
            await setDoc(nextSeasonRef, {
                id: nextSeasonId,
                name: nextSeasonName,
                startDate: Timestamp.fromDate(startDate),
                endDate: Timestamp.fromDate(endDate),
                totalPixels: 10000,
                soldPixels: 0,
                participants: 0,
                status: 'active',
                createdAt: Timestamp.now(),
                updatedAt: Timestamp.now()
            });
            
            // í˜„ì¬ ì‹œì¦Œ ì—…ë°ì´íŠ¸
            this.currentSeason = {
                id: nextSeasonId,
                name: nextSeasonName,
                startDate: startDate,
                endDate: endDate,
                totalPixels: 10000,
                soldPixels: 0,
                participants: 0,
                status: 'active'
            };
            
            console.log(`ìƒˆ ì‹œì¦Œ ${nextSeasonId}ê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            this.showNotification(`ìƒˆ ì‹œì¦Œ ${nextSeasonName}ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
        } catch (error) {
            console.error('ë‹¤ìŒ ì‹œì¦Œ ìƒì„± ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ë‹¤ìŒ ì‹œì¦Œ ìƒì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                this.showNotification('ìƒˆ ì‹œì¦Œ ìƒì„± ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.', 'error');
            }
        }
    }
    
    // ì´ ìˆ˜ìµ ê³„ì‚°
    async calculateTotalRevenue() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            // ê¸°ë³¸ê°’: ë¡œì»¬ ë°ì´í„°ì—ì„œ ê³„ì‚°
            let total = 0;
            this.advertisingData.forEach((ad, regionId) => {
                if (ad.price) {
                    total += ad.price;
                }
            });
            return total;
        }
        try {
            // Firestoreì—ì„œ ì´ ìˆ˜ìµ ê³„ì‚°
            const auctionsSnapshot = await this.firestore.collection('auctions')
                .where('status', '==', 'sold')
                .get();
                
            let total = 0;
            auctionsSnapshot.forEach(doc => {
                const data = doc.data();
                if (data.finalPrice) {
                    total += data.finalPrice;
                }
            });
            
            return total;
        } catch (error) {
            console.error('ìˆ˜ìµ ê³„ì‚° ì‹¤íŒ¨:', error);
            // ê¸°ë³¸ê°’: ë¡œì»¬ ë°ì´í„°ì—ì„œ ê³„ì‚°
            let total = 0;
            this.advertisingData.forEach((ad, regionId) => {
                if (ad.price) {
                    total += ad.price;
                }
            });
            return total;
        }
    }
    
    // ëŒ€í‘œ í”½ì…€ í•˜ì´ë¼ì´íŠ¸ í‘œì‹œ
    async showPixelHighlights() {
        const modal = document.getElementById('pixel-highlights-modal');
        const grid = document.getElementById('pixel-highlights-grid');
        
        if (!modal || !grid) return;
        
        modal.classList.remove('hidden');
        grid.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
        
        try {
            // Firestoreì—ì„œ ì¸ê¸° í”½ì…€ ê°€ì ¸ì˜¤ê¸°
            const highlights = await this.getPixelHighlights();
            
            grid.innerHTML = '';
            
            if (highlights.length === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ì•„ì§ ë“±ë¡ëœ í”½ì…€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            highlights.forEach(highlight => {
                const card = document.createElement('div');
                card.className = 'pixel-highlight-card';
                card.innerHTML = `
                    <div class="pixel-highlight-preview">
                        <canvas width="160" height="160"></canvas>
                    </div>
                    <div class="pixel-highlight-info">
                        <h4>${highlight.regionName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</h4>
                        <p>${highlight.owner || 'ìµëª…'}</p>
                        ${highlight.message ? `<p>${highlight.message}</p>` : ''}
                    </div>
                `;
                
                // í”½ì…€ ê·¸ë¦¬ê¸°
                const canvas = card.querySelector('canvas');
                if (canvas && highlight.pixelData) {
                    this.drawPixelOnCanvas(canvas, highlight.pixelData);
                }
                
                // í´ë¦­ ì´ë²¤íŠ¸: ìŠ¤í† ë¦¬ ì¹´ë“œ í‘œì‹œ
                card.addEventListener('click', () => {
                    this.showPixelStoryCard(highlight);
                });
                
                grid.appendChild(card);
            });
        } catch (error) {
            console.error('í•˜ì´ë¼ì´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            grid.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px;">ë¡œë“œ ì‹¤íŒ¨</p>';
        }
    }
    
    // ì¸ê¸° í”½ì…€ ê°€ì ¸ì˜¤ê¸°
    async getPixelHighlights(limit = 12) {
        if (this.isFirebaseInitialized && this.firestore) {
            try {
                const snapshot = await this.firestore.collection('pixelBundles')
                    .orderBy('createdAt', 'desc')
                    .limit(limit)
                    .get();
                
                const highlights = [];
                snapshot.forEach(doc => {
                    const data = doc.data();
                    highlights.push({
                        id: doc.id,
                        regionId: data.regionId,
                        regionName: data.regionName,
                        owner: data.ownerEmail || 'ìµëª…',
                        message: data.message,
                        pixelData: data.pixelMatrix || data.imageDataUrl,
                        link: data.link
                    });
                });
                
                return highlights;
            } catch (error) {
                console.error('í•˜ì´ë¼ì´íŠ¸ ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
            }
        }
        
        return [];
    }
    
    // í”½ì…€ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
    drawPixelOnCanvas(canvas, pixelData) {
        const ctx = canvas.getContext('2d');
        const size = 16; // 16x16 í”½ì…€
        
        if (Array.isArray(pixelData)) {
            // í”½ì…€ ë§¤íŠ¸ë¦­ìŠ¤
            const pixelSize = canvas.width / size;
            pixelData.forEach((row, y) => {
                if (Array.isArray(row)) {
                    row.forEach((color, x) => {
                        if (color && color !== 'transparent') {
                            ctx.fillStyle = color;
                            ctx.fillRect(x * pixelSize, y * pixelSize, pixelSize, pixelSize);
                        }
                    });
                }
            });
        } else if (typeof pixelData === 'string') {
            // ì´ë¯¸ì§€ URL
            const img = new Image();
            img.onload = () => {
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = pixelData;
        }
    }
    
    // í”½ì…€ ìŠ¤í† ë¦¬ ì¹´ë“œ í‘œì‹œ
    showPixelStoryCard(highlight) {
        // ê¸°ì¡´ ìŠ¤í† ë¦¬ ì¹´ë“œ ëª¨ë‹¬ í™œìš© ë˜ëŠ” ìƒˆ ëª¨ë‹¬ ìƒì„±
        // ì—¬ê¸°ì„œëŠ” ê°„ë‹¨íˆ ì•Œë¦¼ìœ¼ë¡œ í‘œì‹œ
        this.showNotification(
            `ì§€ì—­: ${highlight.regionName}\nì†Œìœ ì: ${highlight.owner}\n${highlight.message || ''}`,
            'info'
        );
    }
    
    // ì§€ë„ì—ì„œ í”½ì…€ ë§ˆì»¤ í´ë¦­ ì‹œ ìŠ¤í† ë¦¬ ì¹´ë“œ í‘œì‹œ
    async showPixelStoryCardFromMap(regionId, bundleId = 'default') {
        const region = this.regionData.get(regionId);
        if (!region) return;
        
        // í˜„ì¬ êµ¬ì—­ì„ ì„ íƒ
        this.currentRegion = region;
        
        // í”½ì…€ ìŠ¤í† ë¦¬ ëª¨ë‹¬ í‘œì‹œ
        await this.showPixelStoryModal(regionId, bundleId);
        
        // ì •ë³´ íŒ¨ë„ë„ í‘œì‹œ (ì„ íƒì‚¬í•­)
        this.showInfoPanel(region);
    }
    
    // í”½ì…€ ìŠ¤í† ë¦¬ ìƒì„¸ ëª¨ë‹¬ í‘œì‹œ
    async showPixelStoryModal(regionId, bundleId = 'default') {
        const modal = document.getElementById('pixel-story-modal');
        if (!modal) return;
        
        const region = this.regionData.get(regionId);
        if (!region) return;
        
        // ì§€ì—­ ì •ë³´ í‘œì‹œ
        const regionNameEl = document.getElementById('pixel-story-region-name');
        const regionCountryEl = document.getElementById('pixel-story-region-country');
        if (regionNameEl) {
            regionNameEl.textContent = this.getRegionDisplayName(region);
        }
        if (regionCountryEl) {
            regionCountryEl.textContent = region.country || '-';
        }
        
        // í”½ì…€ ë²ˆë“¤ ë¡œë“œ
        let bundle = this.getLatestPixelBundle(regionId);
        if (!bundle && this.isFirebaseInitialized && this.firestore) {
            try {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const bundleRef = doc(this.firestore, 'regions', regionId, 'pixelBundles', bundleId);
                const bundleDoc = await getDoc(bundleRef);
                
                if (bundleDoc.exists()) {
                    const bundleData = bundleDoc.data();
                    if (!this.pixelBundleCache.has(regionId)) {
                        this.pixelBundleCache.set(regionId, []);
                    }
                    const bundles = this.pixelBundleCache.get(regionId);
                    const existingIndex = bundles.findIndex(b => b.bundleId === bundleId);
                    if (existingIndex >= 0) {
                        bundles[existingIndex] = { ...bundleData, bundleId };
                    } else {
                        bundles.push({ ...bundleData, bundleId });
                    }
                    bundle = this.getLatestPixelBundle(regionId);
                }
            } catch (error) {
                console.error('í”½ì…€ ë²ˆë“¤ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }
        
        // í”½ì…€ ìº”ë²„ìŠ¤ í‘œì‹œ
        const canvas = document.getElementById('pixel-story-detail-canvas');
        if (canvas) {
            const ctx = canvas.getContext('2d');
            if (bundle) {
                if (bundle.artType === 'canvas' && Array.isArray(bundle.pixelMatrix)) {
                    this.renderMatrixToCanvas(bundle.pixelMatrix, ctx, canvas);
                } else if (bundle.artType === 'image' && bundle.imageData) {
                    const img = new Image();
                    img.onload = () => {
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    };
                    img.src = bundle.imageData;
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.fillStyle = '#05070f';
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                }
            } else {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#05070f';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        const messageEl = document.getElementById('pixel-story-detail-message');
        if (messageEl) {
            if (bundle && bundle.message) {
                messageEl.textContent = bundle.message;
            } else {
                messageEl.textContent = 'ì•„ì§ ë“±ë¡ëœ í”½ì…€ ìŠ¤í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.';
            }
        }
        
        // ë¸Œëœë“œ ì •ë³´ í‘œì‹œ
        await this.updatePixelStoryBrandInfoInModal(regionId, bundle);
        
        // ì†Œìœ ì ì •ë³´ í‘œì‹œ
        const ownerEl = document.getElementById('pixel-story-detail-owner');
        if (ownerEl) {
            if (bundle && bundle.ownerName) {
                ownerEl.textContent = `ì†Œìœ ì: ${bundle.ownerName}`;
            } else {
                ownerEl.textContent = '';
            }
        }
        
        // ë³´í˜¸ ì‹œê°„ í‘œì‹œ
        const protectionEl = document.getElementById('pixel-story-detail-protection');
        if (protectionEl) {
            if (bundle && bundle.protectionEndsAt) {
                protectionEl.classList.remove('hidden');
                protectionEl.textContent = this.formatProtectionCountdown(bundle.protectionEndsAt);
            } else {
                protectionEl.classList.add('hidden');
            }
        }
        
        // ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
        const editorBtn = document.getElementById('pixel-story-detail-editor-btn');
        const regionBtn = document.getElementById('pixel-story-detail-region-btn');
        
        if (editorBtn) {
            editorBtn.onclick = () => {
                this.openPixelEditor(regionId);
                modal.classList.add('hidden');
            };
        }
        
        if (regionBtn) {
            regionBtn.onclick = () => {
                this.showInfoPanel(region);
                modal.classList.add('hidden');
            };
        }
        
        modal.classList.remove('hidden');
    }
    
    // í”½ì…€ ìŠ¤í† ë¦¬ ëª¨ë‹¬ì—ì„œ ë¸Œëœë“œ ì •ë³´ ì—…ë°ì´íŠ¸
    async updatePixelStoryBrandInfoInModal(regionId, bundle) {
        const brandSection = document.getElementById('pixel-story-detail-brand');
        const brandNameEl = document.getElementById('pixel-story-detail-brand-name');
        const brandLogoEl = document.getElementById('pixel-story-detail-brand-logo');
        const brandDescEl = document.getElementById('pixel-story-detail-brand-description');
        const brandLinkEl = document.getElementById('pixel-story-detail-brand-link');
        
        if (!brandSection || !brandNameEl || !brandDescEl) return;
        
        try {
            const region = this.regionData.get(regionId);
            if (!region) {
                brandSection.classList.add('hidden');
                return;
            }
            
            const countryCode = region.country_code || region.countryCode;
            let companyData = null;
            
            if (countryCode === 'KR') {
                companyData = this.koreaCompanyData[regionId];
            } else if (countryCode === 'JP') {
                companyData = this.japanCompanyData[regionId];
            } else {
                companyData = this.companyData[regionId];
            }
            
            if (companyData && (companyData.name || companyData.description || companyData.website)) {
                brandSection.classList.remove('hidden');
                
                if (companyData.name) {
                    brandNameEl.textContent = companyData.name;
                } else {
                    brandNameEl.textContent = 'ë¸Œëœë“œ ì •ë³´';
                }
                
                if (companyData.logo && brandLogoEl) {
                    brandLogoEl.src = companyData.logo;
                    brandLogoEl.classList.remove('hidden');
                } else if (brandLogoEl) {
                    brandLogoEl.classList.add('hidden');
                }
                
                if (companyData.description) {
                    brandDescEl.textContent = companyData.description;
                } else {
                    brandDescEl.textContent = '';
                }
                
                if (companyData.website && brandLinkEl) {
                    brandLinkEl.href = companyData.website;
                    brandLinkEl.classList.remove('hidden');
                } else if (bundle?.messageLink && brandLinkEl) {
                    brandLinkEl.href = bundle.messageLink;
                    brandLinkEl.classList.remove('hidden');
                } else if (brandLinkEl) {
                    brandLinkEl.classList.add('hidden');
                }
            } else if (bundle?.messageLink && brandLinkEl) {
                brandSection.classList.remove('hidden');
                brandNameEl.textContent = 'ë” ì•Œì•„ë³´ê¸°';
                brandDescEl.textContent = bundle.message || '';
                brandLinkEl.href = bundle.messageLink;
                brandLinkEl.classList.remove('hidden');
                if (brandLogoEl) brandLogoEl.classList.add('hidden');
            } else {
                brandSection.classList.add('hidden');
            }
        } catch (error) {
            console.error('ë¸Œëœë“œ ì •ë³´ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
            brandSection.classList.add('hidden');
        }
    }
    
    // ì°¸ì—¬ ë°©ì‹ ì•ˆë‚´ í‘œì‹œ
    showParticipationGuide() {
        const modal = document.getElementById('participation-guide-modal');
        if (!modal) return;
        
        modal.classList.remove('hidden');
        
        // ì˜µì…˜ ì„ íƒ ë²„íŠ¼ ì´ë²¤íŠ¸
        const selectBtns = modal.querySelectorAll('.option-select-btn');
        selectBtns.forEach(btn => {
            btn.addEventListener('click', (e) => {
                const type = e.target.dataset.type;
                this.handleParticipationOption(type);
            });
        });
    }
    
    // ì°¸ì—¬ ì˜µì…˜ ì²˜ë¦¬
    handleParticipationOption(type) {
        const guideModal = document.getElementById('participation-guide-modal');
        if (guideModal) {
            guideModal.classList.add('hidden');
        }
        
        if (type === 'free') {
            // ë¬´ë£Œ í”½ì…€: í”½ì…€ ì—ë””í„° ì—´ê¸°
            this.showNotification('ë¬´ë£Œ í”½ì…€ ì—ë””í„°ë¥¼ ì—´ì—ˆìŠµë‹ˆë‹¤. ì§€ì—­ì„ ì„ íƒí•˜ì—¬ í”½ì…€ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”!', 'success');
            // í”½ì…€ ì—ë””í„°ëŠ” ì§€ì—­ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì—´ë¦¼
        } else if (type === 'premium') {
            // í”„ë¦¬ë¯¸ì—„ íŒ¨í‚¤ì§€: ê²°ì œ í˜ì´ì§€ë¡œ ì´ë™
            this.showNotification('í”„ë¦¬ë¯¸ì—„ íŒ¨í‚¤ì§€ êµ¬ë§¤ í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.', 'info');
            // ê²°ì œ í”Œë¡œìš° êµ¬í˜„ í•„ìš”
        }
    }
    
    // ì»¤ë®¤ë‹ˆí‹° ë¯¸ì…˜ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    async initializeCommunityMissions() {
        // Firestoreì—ì„œ ë¯¸ì…˜ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        if (this.isFirebaseInitialized && this.firestore) {
            try {
                const missions = await this.loadMissionsFromFirestore();
                if (missions && missions.length > 0) {
                    this.communityMissions = missions;
                } else {
                    // ê¸°ë³¸ ë¯¸ì…˜ ëª©ë¡ ì„¤ì •
                    this.communityMissions = this.getDefaultMissions();
                    // Firestoreì— ì €ì¥
                    await this.saveMissionsToFirestore(this.communityMissions);
                }
            } catch (error) {
                console.error('ë¯¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
                // ê¸°ë³¸ ë¯¸ì…˜ ëª©ë¡ ì‚¬ìš©
                this.communityMissions = this.getDefaultMissions();
            }
        } else {
            // ê¸°ë³¸ ë¯¸ì…˜ ëª©ë¡ ì„¤ì •
            this.communityMissions = this.getDefaultMissions();
        }
        
        // ì‚¬ìš©ì í¬ì¸íŠ¸ ë° ì™„ë£Œëœ ë¯¸ì…˜ ë¡œë“œ
        await this.loadUserPoints().catch(err => {
            console.warn('ì‚¬ìš©ì í¬ì¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
        });
        
        // ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ
        if (typeof this.loadUserBadges === 'function') {
            await this.loadUserBadges().catch(err => {
                console.warn('ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
            });
        } else {
            // loadUserBadges í•¨ìˆ˜ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì„¤ì •
            this.userBadges = [];
        }
    }
    
    // ê¸°ë³¸ ë¯¸ì…˜ ëª©ë¡
    getDefaultMissions() {
        return [
            {
                id: 'mission-1',
                title: 'ì²« í”½ì…€ ë§Œë“¤ê¸°',
                description: 'ì²« ë²ˆì§¸ í”½ì…€ ì•„íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”',
                reward: 100,
                type: 'create_pixel',
                completed: false
            },
            {
                id: 'mission-2',
                title: '3ê°œ ì§€ì—­ ë°©ë¬¸',
                description: '3ê°œì˜ ë‹¤ë¥¸ ì§€ì—­ì„ í´ë¦­í•´ë³´ì„¸ìš”',
                reward: 150,
                type: 'visit_regions',
                target: 3,
                progress: 0,
                completed: false
            },
            {
                id: 'mission-3',
                title: 'í”½ì…€ ê³µìœ í•˜ê¸°',
                description: 'ë§Œë“  í”½ì…€ì„ ì†Œì…œ ë¯¸ë””ì–´ì— ê³µìœ í•˜ì„¸ìš”',
                reward: 200,
                type: 'share_pixel',
                completed: false
            }
        ];
    }
    
    // Firestoreì—ì„œ ë¯¸ì…˜ ëª©ë¡ ë¡œë“œ
    async loadMissionsFromFirestore() {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ë¯¸ì…˜ ë¡œë“œ: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return null;
        }
        
        try {
            const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const missionsSnapshot = await getDocs(collection(this.firestore, 'missions'));
            const missions = [];
            
            missionsSnapshot.forEach(doc => {
                const data = doc.data();
                missions.push({ 
                    id: doc.id, 
                    ...data,
                    completed: data.completed || false
                });
            });
            
            // ì‚¬ìš©ìë³„ ì™„ë£Œ ìƒíƒœ ë¡œë“œ
            if (this.currentUser) {
                await this.loadUserMissionProgress(missions).catch(err => {
                    console.warn('ì‚¬ìš©ì ë¯¸ì…˜ ì§„í–‰ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', err);
                });
            }
            
            return missions.length > 0 ? missions : null;
        } catch (error) {
            console.error('ë¯¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ë¯¸ì…˜ ì½ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
            return null;
        }
    }
    
    // Firestoreì— ë¯¸ì…˜ ëª©ë¡ ì €ì¥
    async saveMissionsToFirestore(missions) {
        if (!this.isFirebaseInitialized || !this.firestore) {
            console.warn('ë¯¸ì…˜ ì €ì¥: Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!missions || missions.length === 0) {
            console.warn('ë¯¸ì…˜ ì €ì¥: ì €ì¥í•  ë¯¸ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        try {
            const { doc, setDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            for (const mission of missions) {
                if (!mission || !mission.id) {
                    console.warn('ë¯¸ì…˜ ì €ì¥: ìœ íš¨í•˜ì§€ ì•Šì€ ë¯¸ì…˜ ë°ì´í„°ë¥¼ ê±´ë„ˆëœë‹ˆë‹¤.');
                    continue;
                }
                
                const missionRef = doc(this.firestore, 'missions', mission.id);
                await setDoc(missionRef, {
                    ...mission,
                    createdAt: Timestamp.now(),
                    updatedAt: Timestamp.now()
                }, { merge: true });
            }
            
            console.log(`${missions.length}ê°œì˜ ë¯¸ì…˜ì´ Firestoreì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.`);
        } catch (error) {
            console.error('ë¯¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ë¯¸ì…˜ ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // ì‚¬ìš©ì ë¯¸ì…˜ ì§„í–‰ ìƒíƒœ ë¡œë“œ
    async loadUserMissionProgress(missions) {
        if (!this.currentUser || !this.isFirebaseInitialized || !this.firestore) {
            console.warn('ì‚¬ìš©ì ë¯¸ì…˜ ì§„í–‰ ìƒíƒœ ë¡œë“œ: í•„ìˆ˜ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
            return;
        }
        
        if (!missions || missions.length === 0) {
            return;
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const userRef = doc(this.firestore, 'users', this.currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists) {
                const userData = userDoc.data();
                const completedMissions = userData.completedMissions || [];
                
                // ë¯¸ì…˜ ì™„ë£Œ ìƒíƒœ ì ìš©
                missions.forEach(mission => {
                    if (completedMissions.includes(mission.id)) {
                        mission.completed = true;
                    }
                });
            }
        } catch (error) {
            console.error('ì‚¬ìš©ì ë¯¸ì…˜ ì§„í–‰ ìƒíƒœ ë¡œë“œ ì‹¤íŒ¨:', error);
            if (error.code === 'permission-denied') {
                console.warn('ì‚¬ìš©ì ë¯¸ì…˜ ì§„í–‰ ìƒíƒœ ì½ê¸° ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        }
    }
    
    // ì‚¬ìš©ì í¬ì¸íŠ¸ ë¡œë“œ
    async loadUserPoints() {
        if (!this.currentUser || !this.isFirebaseInitialized || !this.firestore) {
            return;
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const userRef = doc(this.firestore, 'users', this.currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists) {
                const data = userDoc.data();
                this.userPoints = data.points || 0;
            } else {
                // ì‚¬ìš©ì ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                this.userPoints = 0;
            }
        } catch (error) {
            console.error('í¬ì¸íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
            this.userPoints = 0;
        }
    }
    
    // ì‚¬ìš©ì ë±ƒì§€ ë¡œë“œ
    async loadUserBadges() {
        if (!this.currentUser || !this.isFirebaseInitialized || !this.firestore) {
            this.userBadges = [];
            return;
        }
        
        try {
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const userRef = doc(this.firestore, 'users', this.currentUser.uid);
            const userDoc = await getDoc(userRef);
            
            if (userDoc.exists) {
                const data = userDoc.data();
                this.userBadges = data.badges || [];
            } else {
                // ì‚¬ìš©ì ë¬¸ì„œê°€ ì—†ìœ¼ë©´ ì´ˆê¸°í™”
                this.userBadges = [];
            }
        } catch (error) {
            console.error('ë±ƒì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
            // ì—ëŸ¬ ë°œìƒ ì‹œ ê¸°ë³¸ê°’ ì‚¬ìš©
            this.userBadges = [];
        }
    }
    
    // ë±ƒì§€ ì§€ê¸‰
    async grantBadge(badgeId, badgeName, badgeIcon = 'ğŸ†') {
        if (!this.currentUser) return;
        
        if (this.userBadges.includes(badgeId)) {
            return; // ì´ë¯¸ ë±ƒì§€ë¥¼ ê°€ì§€ê³  ìˆìŒ
        }
        
        this.userBadges.push(badgeId);
        
        // Firestoreì— ë±ƒì§€ ì €ì¥
        if (this.isFirebaseInitialized && this.firestore) {
            try {
                const { doc, setDoc, serverTimestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const userBadgesRef = doc(this.firestore, 'users', this.currentUser.uid, 'badges', badgeId);
                await setDoc(userBadgesRef, {
                    badgeId,
                    badgeName,
                    badgeIcon,
                    earnedAt: serverTimestamp()
                }, { merge: true });
            } catch (error) {
                console.error('ë±ƒì§€ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }
        
        this.showNotification(`${badgeIcon} ${badgeName} ë±ƒì§€ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤!`, 'success');
    }
    
    // ì ë ¹ ë³´ìƒ í™•ì¸ ë° ì§€ê¸‰ (êµ¬ë§¤ ë° ë‚™ì°° ì‹œ ê³µí†µ ì‚¬ìš©)
    async checkAndGiveConquestRewards(regionId, regionName, userId, userEmail, amount) {
        if (!this.isFirebaseInitialized || !this.firestore || !userId) {
            return;
        }
        
        try {
            const { collection, query, where, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            
            // ì²« ì ë ¹ì í™•ì¸ (ì´ì „ êµ¬ë§¤ ê¸°ë¡ì´ ìˆëŠ”ì§€ í™•ì¸)
            const previousPurchasesQuery = query(
                collection(this.firestore, 'purchases'),
                where('regionId', '==', regionId)
            );
            const previousPurchases = await getDocs(previousPurchasesQuery);
            const isFirstConquest = previousPurchases.empty;
            
            // ì¸ê¸° êµ¬ì—­ í™•ì¸ (ì¸ê¸° ì§€í‘œ í™•ì¸)
            const popularity = this.regionPopularity.get(regionId);
            const isPopularRegion = popularity && (
                (popularity.bids >= 5) || 
                (popularity.views >= 20) ||
                (popularity.popularityScore >= 50)
            );
            
            // ì²« ì ë ¹ì ë³´ìƒ
            if (isFirstConquest) {
                const firstConquestReward = 100; // ì²« ì ë ¹ì ë³´ìƒ: 100 í¬ì¸íŠ¸
                await this.giveReward(
                    userId,
                    'first_conquest',
                    firstConquestReward,
                    {
                        regionId: regionId,
                        regionName: regionName,
                        amount: amount
                    }
                );
            }
            
            // ì¸ê¸° êµ¬ì—­ ì ë ¹ ë³´ìƒ
            if (isPopularRegion) {
                const popularRegionReward = 75; // ì¸ê¸° êµ¬ì—­ ì ë ¹ ë³´ìƒ: 75 í¬ì¸íŠ¸
                await this.giveReward(
                    userId,
                    'popular_region_conquest',
                    popularRegionReward,
                    {
                        regionId: regionId,
                        regionName: regionName,
                        amount: amount,
                        popularityScore: popularity?.popularityScore || 0
                    }
                );
            }
        } catch (error) {
            console.error('ì ë ¹ ë³´ìƒ í™•ì¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì—…ì  í™•ì¸ ë° ë±ƒì§€ ì§€ê¸‰
    async checkAchievements() {
        if (!this.currentUser) return;
        
        // í”½ì…€ ìƒì„± ì—…ì 
        const pixelCount = Array.from(this.pixelBundleCache.values()).flat().length;
        if (pixelCount >= 1 && !this.userBadges.includes('first-pixel')) {
            await this.grantBadge('first-pixel', 'ì²« í”½ì…€', 'ğŸ¨');
        }
        if (pixelCount >= 10 && !this.userBadges.includes('pixel-master')) {
            await this.grantBadge('pixel-master', 'í”½ì…€ ë§ˆìŠ¤í„°', 'ğŸ¯');
        }
        
        // ì…ì°° ì—…ì 
        const userBids = Array.from(this.auctionData.values()).filter(
            auction => auction.currentBidder?.uid === this.currentUser.uid
        ).length;
        if (userBids >= 1 && !this.userBadges.includes('first-bid')) {
            await this.grantBadge('first-bid', 'ì²« ì…ì°°', 'ğŸ’°');
        }
        if (userBids >= 5 && !this.userBadges.includes('bidder')) {
            await this.grantBadge('bidder', 'ì…ì°°ì', 'ğŸ’');
        }
        
        // í¬ì¸íŠ¸ ì—…ì 
        if (this.userPoints >= 1000 && !this.userBadges.includes('point-collector')) {
            await this.grantBadge('point-collector', 'í¬ì¸íŠ¸ ìˆ˜ì§‘ê°€', 'â­');
        }
    }
    
    // ë³´ìƒ ì§€ê¸‰ í•¨ìˆ˜
    async giveReward(userId, rewardType, amount, metadata = {}) {
        if (!userId || !amount || amount <= 0) {
            return;
        }
        
        if (this.isFirebaseInitialized && this.firestore) {
            try {
                const { doc, setDoc, Timestamp, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const userRef = doc(this.firestore, 'users', userId);
                
                // í¬ì¸íŠ¸ ì¦ê°€
                await setDoc(userRef, {
                    points: increment(amount),
                    updatedAt: Timestamp.now()
                }, { merge: true });
                
                // ë³´ìƒ ê¸°ë¡ ì €ì¥
                const rewardRef = doc(this.firestore, 'rewards', `${userId}_${Date.now()}_${rewardType}`);
                await setDoc(rewardRef, {
                    userId: userId,
                    rewardType: rewardType,
                    amount: amount,
                    metadata: metadata,
                    rewardedAt: Timestamp.now()
                }, { merge: true });
                
                // í˜„ì¬ ì‚¬ìš©ìì—ê²Œ ë³´ìƒì´ ì§€ê¸‰ëœ ê²½ìš° ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
                if (this.currentUser && this.currentUser.uid === userId) {
                    this.userPoints += amount;
                    this.updateUserPointsDisplay();
                    // ë³´ìƒ ì•Œë¦¼ í‘œì‹œ
                    const rewardMessages = {
                        'defense_success': `ë°©ì–´ ì„±ê³µ! ${amount} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`,
                        'defense_failure': `ë°©ì–´ ì‹¤íŒ¨ ë³´ìƒ! ${amount} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`,
                        'first_conquest': `ì²« ì ë ¹ ë³´ìƒ! ${amount} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`,
                        'popular_region_conquest': `ì¸ê¸° êµ¬ì—­ ì ë ¹ ë³´ìƒ! ${amount} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`
                    };
                    const message = rewardMessages[rewardType] || `${amount} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`;
                    this.showNotification(message, 'success');
                }
                
                console.log(`ë³´ìƒ ì§€ê¸‰: ${userId}ì—ê²Œ ${amount} í¬ì¸íŠ¸ (${rewardType})`);
            } catch (error) {
                console.error('ë³´ìƒ ì§€ê¸‰ ì‹¤íŒ¨:', error);
            }
        }
    }
    
    // ë¯¸ì…˜ ì™„ë£Œ ì²˜ë¦¬
    async completeMission(missionId) {
        const mission = this.communityMissions.find(m => m.id === missionId);
        if (!mission || mission.completed) {
            return;
        }
        
        mission.completed = true;
        this.userPoints += mission.reward;
        
        // Firestoreì— ì €ì¥
        if (this.currentUser && this.isFirebaseInitialized && this.firestore) {
            try {
                const { doc, setDoc, Timestamp, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const userRef = doc(this.firestore, 'users', this.currentUser.uid);
                
                const completedMissions = this.communityMissions
                    .filter(m => m.completed)
                    .map(m => m.id);
                
                await setDoc(userRef, {
                    points: this.userPoints,
                    completedMissions: completedMissions,
                    updatedAt: Timestamp.now()
                }, { merge: true });
                
                // ë¯¸ì…˜ ì™„ë£Œ ê¸°ë¡ ì €ì¥
                const missionCompletionRef = doc(this.firestore, 'missionCompletions', `${this.currentUser.uid}_${missionId}`);
                await setDoc(missionCompletionRef, {
                    userId: this.currentUser.uid,
                    missionId: missionId,
                    completedAt: Timestamp.now(),
                    reward: mission.reward
                }, { merge: true });
                
                this.showNotification(`ë¯¸ì…˜ ì™„ë£Œ! ${mission.reward} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // ì—…ì  í™•ì¸ ë° ë±ƒì§€ ì§€ê¸‰
                await this.checkAchievements();
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì €ì¥ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì‚¬ìš©ìì—ê²Œ ì•Œë¦¼ í‘œì‹œ
                if (error.code === 'permission-denied') {
                    this.showNotification('ë¯¸ì…˜ ì™„ë£Œ ì €ì¥ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ ìƒíƒœë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                } else {
                    this.showNotification('ë¯¸ì…˜ ì™„ë£Œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                }
                // ì—ëŸ¬ ë°œìƒ ì‹œ ë©”ëª¨ë¦¬ ìƒíƒœ ë¡¤ë°±
                mission.completed = false;
                this.userPoints -= mission.reward;
            }
        } else {
            // Firestoreê°€ ì—†ì–´ë„ ë¡œì»¬ì—ì„œ ì™„ë£Œ ì²˜ë¦¬
            this.showNotification(`ë¯¸ì…˜ ì™„ë£Œ! ${mission.reward} í¬ì¸íŠ¸ë¥¼ íšë“í–ˆìŠµë‹ˆë‹¤.`, 'success');
        }
    }
    
        // ì»¤ë®¤ë‹ˆí‹° ë¯¸ì…˜ ëª¨ë‹¬ í‘œì‹œ
        showCommunityMissions() {
            const modal = document.getElementById('community-missions-modal');
            if (!modal) return;
            
            modal.classList.remove('hidden');
            this.updateMissionsList();
            
            // ë‹«ê¸° ë²„íŠ¼
            const closeBtn = document.getElementById('close-community-missions');
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.classList.add('hidden');
                };
            }
        }
        
        // ì‚¬ìš©ì í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
        updateUserPointsDisplay() {
            const userPointsDisplay = document.getElementById('user-points-display');
            if (userPointsDisplay) {
                userPointsDisplay.textContent = this.userPoints.toLocaleString();
            }
        }
        
        // ë¯¸ì…˜ ëª©ë¡ ì—…ë°ì´íŠ¸
        updateMissionsList() {
            // ë±ƒì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
            this.updateBadgesList();
            const missionsList = document.getElementById('missions-list');
            
            if (!missionsList) return;
            
            // ì‚¬ìš©ì í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
            this.updateUserPointsDisplay();
            
            // ë¯¸ì…˜ ì¹´ë“œ ìƒì„±
            missionsList.innerHTML = '';
            
            this.communityMissions.forEach(mission => {
                const card = document.createElement('div');
                card.className = `mission-card ${mission.completed ? 'completed' : ''}`;
                
                const progress = mission.target ? 
                    Math.min((mission.progress || 0) / mission.target * 100, 100) : 
                    (mission.completed ? 100 : 0);
                
                card.innerHTML = `
                    <div class="mission-header">
                        <h4 class="mission-title">${mission.title}</h4>
                        <span class="mission-reward">+${mission.reward} í¬ì¸íŠ¸</span>
                    </div>
                    <p class="mission-description">${mission.description}</p>
                    ${mission.target ? `
                        <div class="mission-progress">
                            <div class="mission-progress-bar">
                                <div class="mission-progress-fill" style="width: ${progress}%"></div>
                            </div>
                            <div class="mission-progress-text">${mission.progress || 0} / ${mission.target}</div>
                        </div>
                    ` : ''}
                    <button class="mission-complete-btn" ${mission.completed ? 'disabled' : ''} data-mission-id="${mission.id}">
                        ${mission.completed ? 'ì™„ë£Œë¨ âœ“' : 'ì™„ë£Œí•˜ê¸°'}
                    </button>
                `;
                
                // ì™„ë£Œ ë²„íŠ¼ ì´ë²¤íŠ¸
                const completeBtn = card.querySelector('.mission-complete-btn');
                if (completeBtn && !mission.completed) {
                    completeBtn.addEventListener('click', () => {
                        this.completeMission(mission.id);
                        this.updateMissionsList();
                    });
                }
                
                missionsList.appendChild(card);
            });
        }
        
        // ë±ƒì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
        updateBadgesList() {
            const badgesList = document.getElementById('user-badges-list');
            if (!badgesList) return;
            
            if (!this.currentUser) {
                badgesList.innerHTML = '<span style="color: #94a3b8; font-size: 0.85rem;">ë¡œê·¸ì¸ í›„ ë±ƒì§€ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</span>';
                return;
            }
            
            if (this.userBadges.length === 0) {
                badgesList.innerHTML = '<span style="color: #94a3b8; font-size: 0.85rem;">ì•„ì§ íšë“í•œ ë±ƒì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                return;
            }
            
            badgesList.innerHTML = '';
            this.userBadges.forEach(badgeId => {
                const badge = this.getBadgeInfo(badgeId);
                if (badge) {
                    const badgeEl = document.createElement('div');
                    badgeEl.className = 'badge-item';
                    badgeEl.style.cssText = 'display: flex; align-items: center; gap: 6px; padding: 6px 12px; background: rgba(78, 205, 196, 0.2); border-radius: 20px; font-size: 0.85rem;';
                    badgeEl.innerHTML = `<span>${badge.icon}</span><span>${badge.name}</span>`;
                    badgesList.appendChild(badgeEl);
                }
            });
        }
        
        // ë±ƒì§€ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        getBadgeInfo(badgeId) {
            const badges = {
                'first-pixel': { name: 'ì²« í”½ì…€', icon: 'ğŸ¨' },
                'pixel-master': { name: 'í”½ì…€ ë§ˆìŠ¤í„°', icon: 'ğŸ¯' },
                'first-bid': { name: 'ì²« ì…ì°°', icon: 'ğŸ’°' },
                'bidder': { name: 'ì…ì°°ì', icon: 'ğŸ’' },
                'point-collector': { name: 'í¬ì¸íŠ¸ ìˆ˜ì§‘ê°€', icon: 'â­' }
            };
            return badges[badgeId] || null;
        }
        
        // í”Œë˜ì‹œ ì±Œë¦°ì§€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        async initializeFlashChallenge() {
            // Firestoreì—ì„œ ì˜¤ëŠ˜ì˜ ì±Œë¦°ì§€ ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ìƒì„±
            if (this.isFirebaseInitialized && this.firestore) {
                try {
                    const challenge = await this.getOrCreateDailyFlashChallenge();
                    if (challenge) {
                        this.currentFlashChallenge = challenge;
                        this.updateFlashChallenge();
                        setInterval(() => this.updateFlashChallenge(), 1000);
                        return;
                    }
                } catch (error) {
                    console.error('í”Œë˜ì‹œ ì±Œë¦°ì§€ ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                }
            }
            
            // Firestoreê°€ ì—†ê±°ë‚˜ ì‹¤íŒ¨í•œ ê²½ìš° ë¡œì»¬ ìƒì„±
            const today = new Date().toISOString().split('T')[0];
            this.currentFlashChallenge = {
                id: `challenge-${today}`,
                title: 'ì˜¤ëŠ˜ì˜ í˜‘ì—… ì±Œë¦°ì§€',
                description: 'íŠ¹ì • êµ­ê°€/ë„ì‹œ ì˜ì—­ì—ì„œ í˜‘ì—… ê·¸ë¦¼ì„ ì™„ì„±í•˜ì„¸ìš”!',
                targetRegion: 'korea',
                targetCount: 10,
                currentCount: 0,
                endTime: new Date(Date.now() + 24 * 60 * 60 * 1000), // 24ì‹œê°„ í›„
                participants: []
            };
            
            // ì±Œë¦°ì§€ íŒ¨ë„ ì—…ë°ì´íŠ¸
            this.updateFlashChallenge();
            
            // íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
            setInterval(() => this.updateFlashChallenge(), 1000);
        }
        
        // Firestoreì—ì„œ ì¼ì¼ ì±Œë¦°ì§€ ê°€ì ¸ì˜¤ê¸° ë˜ëŠ” ìƒì„±
        async getOrCreateDailyFlashChallenge() {
            if (!this.isFirebaseInitialized || !this.firestore) return null;
            
            try {
                const { doc, getDoc, setDoc, Timestamp } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const today = new Date().toISOString().split('T')[0];
                const challengeId = `challenge-${today}`;
                const challengeRef = doc(this.firestore, 'flashChallenges', challengeId);
                const challengeDoc = await getDoc(challengeRef);
                
                if (challengeDoc.exists) {
                    // ê¸°ì¡´ ì±Œë¦°ì§€ ê°€ì ¸ì˜¤ê¸°
                    const data = challengeDoc.data();
                    return {
                        id: data.id || challengeId,
                        title: data.title || 'ì˜¤ëŠ˜ì˜ í˜‘ì—… ì±Œë¦°ì§€',
                        description: data.description || 'íŠ¹ì • êµ­ê°€/ë„ì‹œ ì˜ì—­ì—ì„œ í˜‘ì—… ê·¸ë¦¼ì„ ì™„ì„±í•˜ì„¸ìš”!',
                        targetRegion: data.targetRegion || 'korea',
                        targetCount: data.targetCount || 10,
                        currentCount: data.currentCount || 0,
                        endTime: data.endTime?.toDate ? data.endTime.toDate() : (data.endTime ? new Date(data.endTime) : new Date()),
                        participants: data.participants || []
                    };
                } else {
                    // ìƒˆ ì±Œë¦°ì§€ ìƒì„±
                    const challengeData = this.generateDailyChallenge();
                    const endTime = new Date();
                    endTime.setHours(23, 59, 59, 999); // ì˜¤ëŠ˜ ìì •ê¹Œì§€
                    
                    await setDoc(challengeRef, {
                        id: challengeId,
                        title: challengeData.title,
                        description: challengeData.description,
                        targetRegion: challengeData.targetRegion,
                        targetCount: challengeData.targetCount,
                        currentCount: 0,
                        startTime: Timestamp.now(),
                        endTime: Timestamp.fromDate(endTime),
                        participants: [],
                        createdAt: Timestamp.now(),
                        updatedAt: Timestamp.now()
                    });
                    
                    return {
                        id: challengeId,
                        ...challengeData,
                        currentCount: 0,
                        endTime: endTime,
                        participants: []
                    };
                }
            } catch (error) {
                console.error('ì¼ì¼ ì±Œë¦°ì§€ ê°€ì ¸ì˜¤ê¸°/ìƒì„± ì‹¤íŒ¨:', error);
                return null;
            }
        }
        
        // ì¼ì¼ ì±Œë¦°ì§€ ìë™ ìƒì„± ë¡œì§
        generateDailyChallenge() {
            const challenges = [
                {
                    title: 'í•œêµ­ì˜ ë„ì‹œ í”½ì…€ ë§Œë“¤ê¸°',
                    description: 'í•œêµ­ì˜ ì£¼ìš” ë„ì‹œì—ì„œ í”½ì…€ ì•„íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!',
                    targetRegion: 'korea',
                    targetCount: 5
                },
                {
                    title: 'ë¯¸êµ­ì˜ ì£¼ í”½ì…€ ë§Œë“¤ê¸°',
                    description: 'ë¯¸êµ­ì˜ ì£¼ì—ì„œ í”½ì…€ ì•„íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!',
                    targetRegion: 'usa',
                    targetCount: 10
                },
                {
                    title: 'ì¼ë³¸ì˜ í˜„ í”½ì…€ ë§Œë“¤ê¸°',
                    description: 'ì¼ë³¸ì˜ í˜„ì—ì„œ í”½ì…€ ì•„íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!',
                    targetRegion: 'japan',
                    targetCount: 5
                },
                {
                    title: 'ìœ ëŸ½ êµ­ê°€ í”½ì…€ ë§Œë“¤ê¸°',
                    description: 'ìœ ëŸ½ êµ­ê°€ì—ì„œ í”½ì…€ ì•„íŠ¸ë¥¼ ë§Œë“¤ì–´ë³´ì„¸ìš”!',
                    targetRegion: 'european-union',
                    targetCount: 8
                }
            ];
            
            // ë‚ ì§œ ê¸°ë°˜ìœ¼ë¡œ ì±Œë¦°ì§€ ì„ íƒ (ì¼ê´€ì„± ìœ ì§€)
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 1000 / 60 / 60 / 24);
            return challenges[dayOfYear % challenges.length];
        }
        
        // í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ì ì—…ë°ì´íŠ¸
        async updateFlashChallengeParticipation() {
            if (!this.currentFlashChallenge || !this.currentUser || !this.isFirebaseInitialized || !this.firestore) {
                console.warn('í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ì ì—…ë°ì´íŠ¸: í•„ìˆ˜ ì¡°ê±´ì´ ì¶©ì¡±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const { doc, getDoc, setDoc, Timestamp, increment } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const challengeRef = doc(this.firestore, 'flashChallenges', this.currentFlashChallenge.id);
                const challengeDoc = await getDoc(challengeRef);
                
                if (challengeDoc.exists) {
                    const data = challengeDoc.data();
                    const participants = data.participants || [];
                    const userId = this.currentUser.uid;
                    
                    // ì´ë¯¸ ì°¸ì—¬í–ˆëŠ”ì§€ í™•ì¸
                    if (!participants.some(p => p.userId === userId)) {
                        participants.push({
                            userId: userId,
                            userName: this.currentUser.displayName || this.currentUser.email || 'ìµëª…',
                            joinedAt: Timestamp.now(),
                            points: 0
                        });
                        
                        await setDoc(challengeRef, {
                            participants: participants,
                            currentCount: increment(1),
                            updatedAt: Timestamp.now()
                        }, { merge: true });
                        
                        // ë©”ëª¨ë¦¬ ì—…ë°ì´íŠ¸
                        this.currentFlashChallenge.participants = participants;
                        this.currentFlashChallenge.currentCount = (this.currentFlashChallenge.currentCount || 0) + 1;
                    }
                } else {
                    console.warn('í”Œë˜ì‹œ ì±Œë¦°ì§€ ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤:', this.currentFlashChallenge.id);
                }
            } catch (error) {
                console.error('í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ì ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì‚¬ìš©ì ê²½í—˜ì„ í•´ì¹˜ì§€ ì•Šë„ë¡ ì¡°ìš©íˆ ì²˜ë¦¬
                if (error.code === 'permission-denied') {
                    console.warn('í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
        }
        
        // í”Œë˜ì‹œ ì±Œë¦°ì§€ ì—…ë°ì´íŠ¸
        updateFlashChallenge() {
            const panel = document.getElementById('flash-challenge-panel');
            if (!panel || !this.currentFlashChallenge) return;
            
            const titleEl = document.getElementById('challenge-title');
            const descEl = document.getElementById('challenge-description');
            const timeEl = document.getElementById('challenge-time-remaining');
            const leaderboardEl = document.getElementById('challenge-leaderboard-list');
            
            if (titleEl) titleEl.textContent = this.currentFlashChallenge.title;
            if (descEl) descEl.textContent = this.currentFlashChallenge.description;
            
            // ë‚¨ì€ ì‹œê°„ ê³„ì‚°
            if (timeEl) {
                const now = new Date();
                const diff = this.currentFlashChallenge.endTime - now;
                
                if (diff > 0) {
                    const hours = Math.floor(diff / (1000 * 60 * 60));
                    const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((diff % (1000 * 60)) / 1000);
                    timeEl.textContent = `${hours}ì‹œê°„ ${minutes}ë¶„ ${seconds}ì´ˆ`;
                } else {
                    timeEl.textContent = 'ì¢…ë£Œë¨';
                }
            }
            
            // ë¦¬ë”ë³´ë“œ ì—…ë°ì´íŠ¸
            if (leaderboardEl) {
                const participants = this.currentFlashChallenge.participants
                    .sort((a, b) => b.points - a.points)
                    .slice(0, 5);
                
                if (participants.length === 0) {
                    leaderboardEl.innerHTML = '<li>ì•„ì§ ì°¸ì—¬ìê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
                } else {
                    leaderboardEl.innerHTML = participants.map((p, idx) => 
                        `<li><span>${idx + 1}. ${p.name || 'ìµëª…'}</span><span>${p.points}ì </span></li>`
                    ).join('');
                }
            }
        }
        
        // í”Œë˜ì‹œ ì±Œë¦°ì§€ ì°¸ì—¬
        joinFlashChallenge() {
            if (!this.currentUser) {
                this.showNotification('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', 'error');
                return;
            }
            
            this.showNotification('í”Œë˜ì‹œ ì±Œë¦°ì§€ì— ì°¸ì—¬í–ˆìŠµë‹ˆë‹¤! ì§€ì—­ì„ ì„ íƒí•˜ì—¬ í”½ì…€ì„ ë§Œë“¤ì–´ë³´ì„¸ìš”.', 'success');
            // ì±Œë¦°ì§€ íŒ¨ë„ í‘œì‹œ
            const panel = document.getElementById('flash-challenge-panel');
            if (panel) {
                panel.classList.remove('hidden');
            }
        }
        
        // íˆ¬ëª…í™” ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
        initializeTransparencyDashboard() {
        const modal = document.getElementById('transparency-dashboard');
        const closeBtn = document.getElementById('close-transparency-dashboard');
        
        if (!modal) return;
        
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
        
        // ì£¼ê¸°ì ìœ¼ë¡œ íˆ¬ëª…í™” ë°ì´í„° ì—…ë°ì´íŠ¸
        this.updateTransparencyDashboard();
        setInterval(() => this.updateTransparencyDashboard(), 300000); // 5ë¶„ë§ˆë‹¤
    }
    
    // íˆ¬ëª…í™” ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
    async updateTransparencyDashboard() {
        try {
            const revenue = await this.calculateTotalRevenue();
            const expenses = this.transparencyData.totalExpenses;
            const serverCost = 100; // ì›” ì„œë²„ë¹„ (ì˜ˆì‹œ)
            const surplus = revenue - expenses - serverCost;
            
            this.transparencyData = {
                totalRevenue: revenue,
                totalExpenses: expenses,
                serverCost: serverCost,
                surplus: surplus,
                lastUpdated: new Date()
            };
            
            // UI ì—…ë°ì´íŠ¸
            const revenueEl = document.getElementById('transparency-total-revenue');
            const expensesEl = document.getElementById('transparency-total-expenses');
            const serverCostEl = document.getElementById('transparency-server-cost');
            const surplusEl = document.getElementById('transparency-surplus');
            
            if (revenueEl) revenueEl.textContent = `$${revenue.toLocaleString()}`;
            if (expensesEl) expensesEl.textContent = `$${expenses.toLocaleString()}`;
            if (serverCostEl) serverCostEl.textContent = `$${serverCost}/ì›”`;
            if (surplusEl) {
                surplusEl.textContent = `$${surplus.toLocaleString()}`;
                surplusEl.style.color = surplus >= 0 ? '#4ecdc4' : '#ff6b6b';
            }
            
            // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
            this.drawTransparencyChart();
        } catch (error) {
            console.error('íˆ¬ëª…í™” ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
        }
    }
    
    // íˆ¬ëª…í™” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    drawTransparencyChart() {
        const canvas = document.getElementById('transparency-chart-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = 300;
        
        // ë°°ê²½
        ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
        ctx.fillRect(0, 0, width, height);
        
        // ê°„ë‹¨í•œ ë§‰ëŒ€ ê·¸ë˜í”„
        const data = [
            { label: 'ìˆ˜ìµ', value: this.transparencyData.totalRevenue, color: '#4ecdc4' },
            { label: 'ì§€ì¶œ', value: this.transparencyData.totalExpenses, color: '#ff6b6b' },
            { label: 'ì„œë²„ë¹„', value: this.transparencyData.serverCost, color: '#feca57' }
        ];
        
        const maxValue = Math.max(...data.map(d => d.value), 1);
        const barWidth = width / data.length - 20;
        const barHeight = height - 60;
        
        data.forEach((item, index) => {
            const x = index * (width / data.length) + 10;
            const barH = (item.value / maxValue) * barHeight;
            const y = height - barH - 30;
            
            // ë§‰ëŒ€
            ctx.fillStyle = item.color;
            ctx.fillRect(x, y, barWidth, barH);
            
            // ë ˆì´ë¸”
            ctx.fillStyle = '#fff';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(item.label, x + barWidth / 2, height - 10);
            
            // ê°’
            ctx.fillText(`$${item.value.toLocaleString()}`, x + barWidth / 2, y - 5);
        });
    }
    
    // ì‹œì¦Œ ëŒ€ì‹œë³´ë“œ í‘œì‹œ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
    showSeasonDashboard() {
        const dashboard = document.getElementById('season-dashboard');
        if (dashboard) {
            dashboard.classList.remove('hidden');
            this.updateSeasonDashboard();
        }
    }
    
    // íˆ¬ëª…í™” ëŒ€ì‹œë³´ë“œ í‘œì‹œ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
    showTransparencyDashboard() {
        const modal = document.getElementById('transparency-dashboard');
        if (modal) {
            modal.classList.remove('hidden');
            this.updateTransparencyDashboard();
        }
    }
    
    // ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
    initializeSeasonArchive() {
        const modal = document.getElementById('season-archive-modal');
        const closeBtn = document.getElementById('close-season-archive');
        const seasonSelect = document.getElementById('archive-season-select');
        
        if (!modal) return;
        
        // ë‹«ê¸° ë²„íŠ¼
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                modal.classList.add('hidden');
            });
        }
        
        // ì‹œì¦Œ ì„ íƒ ì´ë²¤íŠ¸
        if (seasonSelect) {
            seasonSelect.addEventListener('change', (e) => {
                const seasonId = e.target.value;
                if (seasonId) {
                    this.loadSeasonArchive(seasonId);
                }
            });
        }
        
        // ì•„ì¹´ì´ë¸Œ ì‹œì¦Œ ëª©ë¡ ë¡œë“œ
        this.loadArchiveSeasons();
    }
    
    // ì•„ì¹´ì´ë¸Œ ì‹œì¦Œ ëª©ë¡ ë¡œë“œ
    async loadArchiveSeasons() {
        const seasonSelect = document.getElementById('archive-season-select');
        if (!seasonSelect) return;
        
        try {
            if (this.isFirebaseInitialized && this.firestore) {
                const { collection, query, where, orderBy, getDocs } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const seasonsQuery = query(
                    collection(this.firestore, 'seasons'),
                    where('status', '==', 'archived'),
                    orderBy('endDate', 'desc')
                );
                const seasonsSnapshot = await getDocs(seasonsQuery);
                
                seasonsSnapshot.forEach(doc => {
                    const data = doc.data();
                    const option = document.createElement('option');
                    option.value = doc.id;
                    const endDate = data.endDate?.toDate ? data.endDate.toDate() : (data.endDate ? new Date(data.endDate) : new Date());
                    option.textContent = `${data.name || doc.id} (${endDate.toLocaleDateString()})`;
                    seasonSelect.appendChild(option);
                });
            } else {
                // ê¸°ë³¸ê°’: í˜„ì¬ ì‹œì¦Œ ì´ì „ ì‹œì¦Œë“¤ (ì˜ˆì‹œ)
                const pastSeasons = [
                    { id: '2024-S1', name: '2024 ì‹œì¦Œ 1' },
                    { id: '2024-S2', name: '2024 ì‹œì¦Œ 2' }
                ];
                
                pastSeasons.forEach(season => {
                    const option = document.createElement('option');
                    option.value = season.id;
                    option.textContent = season.name;
                    seasonSelect.appendChild(option);
                });
            }
        } catch (error) {
            console.error('ì•„ì¹´ì´ë¸Œ ì‹œì¦Œ ë¡œë“œ ì‹¤íŒ¨:', error);
        }
    }
    
    // ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ë¡œë“œ
    async loadSeasonArchive(seasonId) {
        const gallery = document.getElementById('archive-gallery');
        if (!gallery) return;
        
        gallery.innerHTML = '<div class="archive-loading">ì•„ì¹´ì´ë¸Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        
        try {
            if (!this.isFirebaseInitialized || !this.firestore) {
                gallery.innerHTML = '<div class="archive-error">Firestoreê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
            const seasonRef = doc(this.firestore, 'seasons', seasonId);
            const seasonDoc = await getDoc(seasonRef);
            
            if (!seasonDoc.exists()) {
                gallery.innerHTML = '<div class="archive-empty">ì‹œì¦Œ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            const seasonData = seasonDoc.data();
            const finalOwners = seasonData.finalOwners || [];
            
            // ìµœì¢… ì†Œìœ ì ë§µ ìƒì„± (ë¹ ë¥¸ ê²€ìƒ‰ìš©)
            const finalOwnersMap = new Map();
            finalOwners.forEach(owner => {
                finalOwnersMap.set(owner.regionId, owner);
            });
            
            // ì•„ì¹´ì´ë¸Œ ê°¤ëŸ¬ë¦¬ ìƒì„±
            gallery.innerHTML = '';
            
            if (finalOwners.length === 0) {
                gallery.innerHTML = '<div class="archive-empty">ìµœì¢… ì†Œìœ ì ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            // ìµœì¢… ì†Œìœ ì ê°•ì¡° í‘œì‹œ í—¤ë”
            const headerEl = document.createElement('div');
            headerEl.className = 'archive-header';
            headerEl.innerHTML = `
                <h3>ì‹œì¦Œ ${seasonId} ìµœì¢… ì†Œìœ ì</h3>
                <p class="archive-description">ì‹œì¦Œ ì¢…ë£Œ ì‹œì ì˜ ìµœì¢… ì†Œìœ ìë§Œ ì˜êµ¬ ê¸°ë¡ë©ë‹ˆë‹¤.</p>
            `;
            gallery.appendChild(headerEl);
            
            // ìµœì¢… ì†Œìœ ì ê·¸ë¦¬ë“œ ìƒì„±
            const gridEl = document.createElement('div');
            gridEl.className = 'archive-owners-grid';
            
            finalOwners.forEach((owner, index) => {
                const ownerCard = document.createElement('div');
                ownerCard.className = 'archive-owner-card final-owner-highlight';
                ownerCard.innerHTML = `
                    <div class="owner-card-header">
                        <span class="final-owner-badge">ğŸ† ìµœì¢… ì†Œìœ ì</span>
                    </div>
                    <div class="owner-card-content">
                        <h4 class="owner-region-name">${owner.regionName || owner.regionId}</h4>
                        <p class="owner-email">${owner.ownerEmail || 'Unknown'}</p>
                        <p class="owner-amount">${this.formatCurrency(owner.amount || 0)}</p>
                    </div>
                    <div class="owner-card-footer">
                        <button class="view-region-btn" data-region-id="${owner.regionId}">ì§€ì—­ ë³´ê¸°</button>
                    </div>
                `;
                
                // ì§€ì—­ ë³´ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸
                const viewBtn = ownerCard.querySelector('.view-region-btn');
                if (viewBtn) {
                    viewBtn.addEventListener('click', () => {
                        this.zoomToRegion(owner.regionId);
                        const modal = document.getElementById('season-archive-modal');
                        if (modal) modal.classList.add('hidden');
                    });
                }
                
                gridEl.appendChild(ownerCard);
            });
            
            gallery.appendChild(gridEl);
        } catch (error) {
            console.error('ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:', error);
            gallery.innerHTML = '<div class="archive-error">ì•„ì¹´ì´ë¸Œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
        }
    }
    
    async loadSeasonArchive_OLD(seasonId) {
        const gallery = document.getElementById('archive-gallery');
        if (!gallery) return;
        
        gallery.innerHTML = '<div class="loading">ë¡œë”© ì¤‘...</div>';
        
        try {
            let pixels = [];
            let finalOwners = new Set(); // ìµœì¢… ì†Œìœ ì ì§‘í•©
            
            // ì‹œì¦Œì˜ ìµœì¢… ì†Œìœ ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
            if (this.isFirebaseInitialized && this.firestore) {
                const { doc, getDoc } = await import('https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js');
                const seasonRef = doc(this.firestore, 'seasons', seasonId);
                const seasonDoc = await getDoc(seasonRef);
                
                if (seasonDoc.exists()) {
                    const seasonData = seasonDoc.data();
                    if (seasonData.finalOwners && Array.isArray(seasonData.finalOwners)) {
                        seasonData.finalOwners.forEach(owner => {
                            if (owner.regionId) {
                                finalOwners.add(owner.regionId);
                            }
                        });
                    }
                }
                
                const snapshot = await this.firestore.collection('pixelBundles')
                    .where('seasonId', '==', seasonId)
                    .get();
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const isFinalOwner = finalOwners.has(data.regionId);
                    pixels.push({
                        id: doc.id,
                        regionId: data.regionId,
                        regionName: data.regionName,
                        owner: data.ownerEmail || 'ìµëª…',
                        pixelData: data.pixelMatrix || data.imageDataUrl,
                        message: data.message,
                        createdAt: data.createdAt,
                        isFinalOwner: isFinalOwner // ìµœì¢… ì†Œìœ ì ì—¬ë¶€
                    });
                });
            }
            
            gallery.innerHTML = '';
            
            if (pixels.length === 0) {
                gallery.innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">ì´ ì‹œì¦Œì—ëŠ” ë“±ë¡ëœ í”½ì…€ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            pixels.forEach(pixel => {
                const item = document.createElement('div');
                item.className = `archive-pixel-item ${pixel.isFinalOwner ? 'final-owner' : ''}`;
                
                // ìµœì¢… ì†Œìœ ì ë°°ì§€ ì¶”ê°€
                const finalOwnerBadge = pixel.isFinalOwner 
                    ? '<span class="final-owner-badge">ğŸ† ìµœì¢… ì†Œìœ ì</span>' 
                    : '';
                
                item.innerHTML = `
                    <div class="archive-pixel-preview">
                        <canvas width="160" height="160"></canvas>
                        ${finalOwnerBadge}
                    </div>
                    <div class="archive-pixel-info">
                        <h4>${pixel.regionName || 'ì•Œ ìˆ˜ ì—†ìŒ'}</h4>
                        <p class="${pixel.isFinalOwner ? 'final-owner-text' : ''}">${pixel.owner}</p>
                    </div>
                `;
                
                // í”½ì…€ ê·¸ë¦¬ê¸°
                const canvas = item.querySelector('canvas');
                if (canvas && pixel.pixelData) {
                    this.drawPixelOnCanvas(canvas, pixel.pixelData);
                }
                
                // í´ë¦­ ì´ë²¤íŠ¸: ìƒì„¸ ì •ë³´ í‘œì‹œ
                item.addEventListener('click', () => {
                    this.showPixelStoryCard(pixel);
                });
                
                gallery.appendChild(item);
            });
        } catch (error) {
            console.error('ì•„ì¹´ì´ë¸Œ ë¡œë“œ ì‹¤íŒ¨:', error);
            gallery.innerHTML = '<p style="text-align: center; color: #ff6b6b; padding: 40px;">ë¡œë“œ ì‹¤íŒ¨</p>';
        }
    }
    
    // ì‹œì¦Œ ì•„ì¹´ì´ë¸Œ í‘œì‹œ (ì™¸ë¶€ì—ì„œ í˜¸ì¶œ ê°€ëŠ¥)
    showSeasonArchive() {
        const modal = document.getElementById('season-archive-modal');
        if (modal) {
            modal.classList.remove('hidden');
            this.loadArchiveSeasons();
        }
    }
    
    // í”½ì…€ ìŠ¤í† ë¦¬ ëª¨ë‹¬ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì„¤ì •
    setupPixelStoryModalEvents() {
        const closeBtn = document.getElementById('close-pixel-story-modal');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                const modal = document.getElementById('pixel-story-modal');
                if (modal) modal.classList.add('hidden');
            });
        }
    }
    
    // êµ¬ì—­ë³„ ë¯¸ë‹ˆë§µ í‘œì‹œ
    showRegionMinimap() {
        const minimap = document.getElementById('region-minimap');
        if (!minimap) return;
        
        minimap.classList.remove('hidden');
        this.renderMinimap();
    }
    
    // ë¯¸ë‹ˆë§µ ë Œë”ë§
    renderMinimap() {
        const canvas = document.getElementById('minimap-canvas');
        if (!canvas) return;
        
        const ctx = canvas.getContext('2d');
        const container = document.getElementById('minimap-canvas-container');
        if (container) {
            canvas.width = container.clientWidth || 400;
            canvas.height = container.clientHeight || 300;
        } else {
            canvas.width = 400;
            canvas.height = 300;
        }
        
        // ë°°ê²½
        ctx.fillStyle = '#1a1a2e';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // í”½ì…€ì´ ìˆëŠ” êµ¬ì—­ê³¼ ì—†ëŠ” êµ¬ì—­ì„ ìƒ‰ìƒìœ¼ë¡œ êµ¬ë¶„
        const pixelCount = this.regionData.size;
        const pixelRegions = new Set();
        
        this.regionData.forEach((region, regionId) => {
            const bundle = this.getLatestPixelBundle(regionId);
            if (bundle) {
                pixelRegions.add(regionId);
            }
        });
        
        // ê°„ë‹¨í•œ ê·¸ë¦¬ë“œ í˜•íƒœë¡œ í‘œì‹œ
        const cols = Math.ceil(Math.sqrt(pixelCount));
        const rows = Math.ceil(pixelCount / cols);
        const cellWidth = canvas.width / cols;
        const cellHeight = canvas.height / rows;
        
        let index = 0;
        this.regionData.forEach((region, regionId) => {
            const col = index % cols;
            const row = Math.floor(index / cols);
            const x = col * cellWidth;
            const y = row * cellHeight;
            
            // í”½ì…€ì´ ìˆìœ¼ë©´ ë¹¨ê°„ìƒ‰, ì—†ìœ¼ë©´ ì²­ë¡ìƒ‰
            ctx.fillStyle = pixelRegions.has(regionId) ? '#ff6b6b' : '#4ecdc4';
            ctx.fillRect(x, y, cellWidth - 1, cellHeight - 1);
            
            index++;
        });
        
        // ì œëª© í‘œì‹œ
        ctx.fillStyle = '#ffffff';
        ctx.font = '14px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('êµ¬ì—­ë³„ í”½ì…€ ë¶„í¬', canvas.width / 2, 20);
    }
    
    // ë¯¸ë‹ˆë§µ ë‹«ê¸°
    hideRegionMinimap() {
        const minimap = document.getElementById('region-minimap');
        if (minimap) {
            minimap.classList.add('hidden');
        }
    }
    
    // ë¯¸ë‹ˆë§µ ì´ˆê¸°í™”
    initializeMinimap() {
        const closeBtn = document.getElementById('close-minimap');
        if (closeBtn) {
            closeBtn.addEventListener('click', () => {
                this.hideRegionMinimap();
            });
        }
        
        // í”½ì…€ ë ˆì´ì–´ í† ê¸€ ë²„íŠ¼ì— ë¯¸ë‹ˆë§µ í‘œì‹œ ì˜µì…˜ ì¶”ê°€
        const pixelLayerToggle = document.getElementById('pixel-layer-toggle');
        if (pixelLayerToggle) {
            // ìš°í´ë¦­ìœ¼ë¡œ ë¯¸ë‹ˆë§µ í‘œì‹œ
            pixelLayerToggle.addEventListener('contextmenu', (e) => {
                e.preventDefault();
                this.showRegionMinimap();
            });
        }
    }
    
    
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì§€ë„ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    new BillionaireMap();
});

